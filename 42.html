
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(cb) {
        var elements = document.querySelectorAll("." + cb.id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("id-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleSeverity(cb) {
        cb.parentElement.classList.toggle("unchecked", !cb.checked);
        var elements = document.querySelectorAll(".sev_" + cb.id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("severity-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleTool(cb) {
        cb.parentElement.classList.toggle("unchecked", !cb.checked);

        var elements;
        if (cb.id == "clang-tidy")
            elements = document.querySelectorAll("[class^=clang-tidy-]");
        else
            elements = document.querySelectorAll(".issue:not([class^=clang-tidy-])");

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("tool-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleAll() {
        var elements = document.querySelectorAll(".idToggle");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var changed = elements[i].checked != elements[0].checked;
          if (changed) {
            elements[i].checked = elements[0].checked;
            toggleDisplay(elements[i]);
          }
        }
      }

      function filterFile(filter) {
        var elements = document.querySelectorAll(".fileEntry");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = elements[i].querySelector("tr").querySelector("td").textContent.toLowerCase().includes(filter.toLowerCase());
          elements[i].classList.toggle("text-filtered", !visible);
        }
      }

      function filterText(text) {
        filter = text.toLowerCase();
        var elements = document.querySelectorAll(".issue");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = false;
          var fields = elements[i].querySelectorAll("td");
          for (var n = 0, num = fields.length; n < num; n++) {
            if (fields[n].textContent.toLowerCase().includes(filter)) {
              visible = true;
              break;
            }
          }
          elements[i].classList.toggle("text-filtered", !visible);
        }

        updateFileRows();
      }

      function updateFileRows(element) {
        var elements = document.querySelectorAll(".fileEntry");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = elements[i].querySelector(".issue:not(.id-filtered):not(.severity-filtered):not(.tool-filtered):not(.text-filtered)");
          elements[i].classList.toggle("file-filtered", !visible);
        }
      }

      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="wrapper">
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: xen/tools/firmware/rombios/rombios.c</h1>

    </div>

    <div id="menu">
     <p><a href="index.html">Defects:</a> rombios.c</p>
<a href="42.html#line-2028"> preprocessorErrorDirective 2028</a>
    </div>
    <div id="content">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">    1</span>
<span class="normal">    2</span>
<span class="normal">    3</span>
<span class="normal">    4</span>
<span class="normal">    5</span>
<span class="normal">    6</span>
<span class="normal">    7</span>
<span class="normal">    8</span>
<span class="normal">    9</span>
<span class="normal">   10</span>
<span class="normal">   11</span>
<span class="normal">   12</span>
<span class="normal">   13</span>
<span class="normal">   14</span>
<span class="normal">   15</span>
<span class="normal">   16</span>
<span class="normal">   17</span>
<span class="normal">   18</span>
<span class="normal">   19</span>
<span class="normal">   20</span>
<span class="normal">   21</span>
<span class="normal">   22</span>
<span class="normal">   23</span>
<span class="normal">   24</span>
<span class="normal">   25</span>
<span class="normal">   26</span>
<span class="normal">   27</span>
<span class="normal">   28</span>
<span class="normal">   29</span>
<span class="normal">   30</span>
<span class="normal">   31</span>
<span class="normal">   32</span>
<span class="normal">   33</span>
<span class="normal">   34</span>
<span class="normal">   35</span>
<span class="normal">   36</span>
<span class="normal">   37</span>
<span class="normal">   38</span>
<span class="normal">   39</span>
<span class="normal">   40</span>
<span class="normal">   41</span>
<span class="normal">   42</span>
<span class="normal">   43</span>
<span class="normal">   44</span>
<span class="normal">   45</span>
<span class="normal">   46</span>
<span class="normal">   47</span>
<span class="normal">   48</span>
<span class="normal">   49</span>
<span class="normal">   50</span>
<span class="normal">   51</span>
<span class="normal">   52</span>
<span class="normal">   53</span>
<span class="normal">   54</span>
<span class="normal">   55</span>
<span class="normal">   56</span>
<span class="normal">   57</span>
<span class="normal">   58</span>
<span class="normal">   59</span>
<span class="normal">   60</span>
<span class="normal">   61</span>
<span class="normal">   62</span>
<span class="normal">   63</span>
<span class="normal">   64</span>
<span class="normal">   65</span>
<span class="normal">   66</span>
<span class="normal">   67</span>
<span class="normal">   68</span>
<span class="normal">   69</span>
<span class="normal">   70</span>
<span class="normal">   71</span>
<span class="normal">   72</span>
<span class="normal">   73</span>
<span class="normal">   74</span>
<span class="normal">   75</span>
<span class="normal">   76</span>
<span class="normal">   77</span>
<span class="normal">   78</span>
<span class="normal">   79</span>
<span class="normal">   80</span>
<span class="normal">   81</span>
<span class="normal">   82</span>
<span class="normal">   83</span>
<span class="normal">   84</span>
<span class="normal">   85</span>
<span class="normal">   86</span>
<span class="normal">   87</span>
<span class="normal">   88</span>
<span class="normal">   89</span>
<span class="normal">   90</span>
<span class="normal">   91</span>
<span class="normal">   92</span>
<span class="normal">   93</span>
<span class="normal">   94</span>
<span class="normal">   95</span>
<span class="normal">   96</span>
<span class="normal">   97</span>
<span class="normal">   98</span>
<span class="normal">   99</span>
<span class="normal">  100</span>
<span class="normal">  101</span>
<span class="normal">  102</span>
<span class="normal">  103</span>
<span class="normal">  104</span>
<span class="normal">  105</span>
<span class="normal">  106</span>
<span class="normal">  107</span>
<span class="normal">  108</span>
<span class="normal">  109</span>
<span class="normal">  110</span>
<span class="normal">  111</span>
<span class="normal">  112</span>
<span class="normal">  113</span>
<span class="normal">  114</span>
<span class="normal">  115</span>
<span class="normal">  116</span>
<span class="normal">  117</span>
<span class="normal">  118</span>
<span class="normal">  119</span>
<span class="normal">  120</span>
<span class="normal">  121</span>
<span class="normal">  122</span>
<span class="normal">  123</span>
<span class="normal">  124</span>
<span class="normal">  125</span>
<span class="normal">  126</span>
<span class="normal">  127</span>
<span class="normal">  128</span>
<span class="normal">  129</span>
<span class="normal">  130</span>
<span class="normal">  131</span>
<span class="normal">  132</span>
<span class="normal">  133</span>
<span class="normal">  134</span>
<span class="normal">  135</span>
<span class="normal">  136</span>
<span class="normal">  137</span>
<span class="normal">  138</span>
<span class="normal">  139</span>
<span class="normal">  140</span>
<span class="normal">  141</span>
<span class="normal">  142</span>
<span class="normal">  143</span>
<span class="normal">  144</span>
<span class="normal">  145</span>
<span class="normal">  146</span>
<span class="normal">  147</span>
<span class="normal">  148</span>
<span class="normal">  149</span>
<span class="normal">  150</span>
<span class="normal">  151</span>
<span class="normal">  152</span>
<span class="normal">  153</span>
<span class="normal">  154</span>
<span class="normal">  155</span>
<span class="normal">  156</span>
<span class="normal">  157</span>
<span class="normal">  158</span>
<span class="normal">  159</span>
<span class="normal">  160</span>
<span class="normal">  161</span>
<span class="normal">  162</span>
<span class="normal">  163</span>
<span class="normal">  164</span>
<span class="normal">  165</span>
<span class="normal">  166</span>
<span class="normal">  167</span>
<span class="normal">  168</span>
<span class="normal">  169</span>
<span class="normal">  170</span>
<span class="normal">  171</span>
<span class="normal">  172</span>
<span class="normal">  173</span>
<span class="normal">  174</span>
<span class="normal">  175</span>
<span class="normal">  176</span>
<span class="normal">  177</span>
<span class="normal">  178</span>
<span class="normal">  179</span>
<span class="normal">  180</span>
<span class="normal">  181</span>
<span class="normal">  182</span>
<span class="normal">  183</span>
<span class="normal">  184</span>
<span class="normal">  185</span>
<span class="normal">  186</span>
<span class="normal">  187</span>
<span class="normal">  188</span>
<span class="normal">  189</span>
<span class="normal">  190</span>
<span class="normal">  191</span>
<span class="normal">  192</span>
<span class="normal">  193</span>
<span class="normal">  194</span>
<span class="normal">  195</span>
<span class="normal">  196</span>
<span class="normal">  197</span>
<span class="normal">  198</span>
<span class="normal">  199</span>
<span class="normal">  200</span>
<span class="normal">  201</span>
<span class="normal">  202</span>
<span class="normal">  203</span>
<span class="normal">  204</span>
<span class="normal">  205</span>
<span class="normal">  206</span>
<span class="normal">  207</span>
<span class="normal">  208</span>
<span class="normal">  209</span>
<span class="normal">  210</span>
<span class="normal">  211</span>
<span class="normal">  212</span>
<span class="normal">  213</span>
<span class="normal">  214</span>
<span class="normal">  215</span>
<span class="normal">  216</span>
<span class="normal">  217</span>
<span class="normal">  218</span>
<span class="normal">  219</span>
<span class="normal">  220</span>
<span class="normal">  221</span>
<span class="normal">  222</span>
<span class="normal">  223</span>
<span class="normal">  224</span>
<span class="normal">  225</span>
<span class="normal">  226</span>
<span class="normal">  227</span>
<span class="normal">  228</span>
<span class="normal">  229</span>
<span class="normal">  230</span>
<span class="normal">  231</span>
<span class="normal">  232</span>
<span class="normal">  233</span>
<span class="normal">  234</span>
<span class="normal">  235</span>
<span class="normal">  236</span>
<span class="normal">  237</span>
<span class="normal">  238</span>
<span class="normal">  239</span>
<span class="normal">  240</span>
<span class="normal">  241</span>
<span class="normal">  242</span>
<span class="normal">  243</span>
<span class="normal">  244</span>
<span class="normal">  245</span>
<span class="normal">  246</span>
<span class="normal">  247</span>
<span class="normal">  248</span>
<span class="normal">  249</span>
<span class="normal">  250</span>
<span class="normal">  251</span>
<span class="normal">  252</span>
<span class="normal">  253</span>
<span class="normal">  254</span>
<span class="normal">  255</span>
<span class="normal">  256</span>
<span class="normal">  257</span>
<span class="normal">  258</span>
<span class="normal">  259</span>
<span class="normal">  260</span>
<span class="normal">  261</span>
<span class="normal">  262</span>
<span class="normal">  263</span>
<span class="normal">  264</span>
<span class="normal">  265</span>
<span class="normal">  266</span>
<span class="normal">  267</span>
<span class="normal">  268</span>
<span class="normal">  269</span>
<span class="normal">  270</span>
<span class="normal">  271</span>
<span class="normal">  272</span>
<span class="normal">  273</span>
<span class="normal">  274</span>
<span class="normal">  275</span>
<span class="normal">  276</span>
<span class="normal">  277</span>
<span class="normal">  278</span>
<span class="normal">  279</span>
<span class="normal">  280</span>
<span class="normal">  281</span>
<span class="normal">  282</span>
<span class="normal">  283</span>
<span class="normal">  284</span>
<span class="normal">  285</span>
<span class="normal">  286</span>
<span class="normal">  287</span>
<span class="normal">  288</span>
<span class="normal">  289</span>
<span class="normal">  290</span>
<span class="normal">  291</span>
<span class="normal">  292</span>
<span class="normal">  293</span>
<span class="normal">  294</span>
<span class="normal">  295</span>
<span class="normal">  296</span>
<span class="normal">  297</span>
<span class="normal">  298</span>
<span class="normal">  299</span>
<span class="normal">  300</span>
<span class="normal">  301</span>
<span class="normal">  302</span>
<span class="normal">  303</span>
<span class="normal">  304</span>
<span class="normal">  305</span>
<span class="normal">  306</span>
<span class="normal">  307</span>
<span class="normal">  308</span>
<span class="normal">  309</span>
<span class="normal">  310</span>
<span class="normal">  311</span>
<span class="normal">  312</span>
<span class="normal">  313</span>
<span class="normal">  314</span>
<span class="normal">  315</span>
<span class="normal">  316</span>
<span class="normal">  317</span>
<span class="normal">  318</span>
<span class="normal">  319</span>
<span class="normal">  320</span>
<span class="normal">  321</span>
<span class="normal">  322</span>
<span class="normal">  323</span>
<span class="normal">  324</span>
<span class="normal">  325</span>
<span class="normal">  326</span>
<span class="normal">  327</span>
<span class="normal">  328</span>
<span class="normal">  329</span>
<span class="normal">  330</span>
<span class="normal">  331</span>
<span class="normal">  332</span>
<span class="normal">  333</span>
<span class="normal">  334</span>
<span class="normal">  335</span>
<span class="normal">  336</span>
<span class="normal">  337</span>
<span class="normal">  338</span>
<span class="normal">  339</span>
<span class="normal">  340</span>
<span class="normal">  341</span>
<span class="normal">  342</span>
<span class="normal">  343</span>
<span class="normal">  344</span>
<span class="normal">  345</span>
<span class="normal">  346</span>
<span class="normal">  347</span>
<span class="normal">  348</span>
<span class="normal">  349</span>
<span class="normal">  350</span>
<span class="normal">  351</span>
<span class="normal">  352</span>
<span class="normal">  353</span>
<span class="normal">  354</span>
<span class="normal">  355</span>
<span class="normal">  356</span>
<span class="normal">  357</span>
<span class="normal">  358</span>
<span class="normal">  359</span>
<span class="normal">  360</span>
<span class="normal">  361</span>
<span class="normal">  362</span>
<span class="normal">  363</span>
<span class="normal">  364</span>
<span class="normal">  365</span>
<span class="normal">  366</span>
<span class="normal">  367</span>
<span class="normal">  368</span>
<span class="normal">  369</span>
<span class="normal">  370</span>
<span class="normal">  371</span>
<span class="normal">  372</span>
<span class="normal">  373</span>
<span class="normal">  374</span>
<span class="normal">  375</span>
<span class="normal">  376</span>
<span class="normal">  377</span>
<span class="normal">  378</span>
<span class="normal">  379</span>
<span class="normal">  380</span>
<span class="normal">  381</span>
<span class="normal">  382</span>
<span class="normal">  383</span>
<span class="normal">  384</span>
<span class="normal">  385</span>
<span class="normal">  386</span>
<span class="normal">  387</span>
<span class="normal">  388</span>
<span class="normal">  389</span>
<span class="normal">  390</span>
<span class="normal">  391</span>
<span class="normal">  392</span>
<span class="normal">  393</span>
<span class="normal">  394</span>
<span class="normal">  395</span>
<span class="normal">  396</span>
<span class="normal">  397</span>
<span class="normal">  398</span>
<span class="normal">  399</span>
<span class="normal">  400</span>
<span class="normal">  401</span>
<span class="normal">  402</span>
<span class="normal">  403</span>
<span class="normal">  404</span>
<span class="normal">  405</span>
<span class="normal">  406</span>
<span class="normal">  407</span>
<span class="normal">  408</span>
<span class="normal">  409</span>
<span class="normal">  410</span>
<span class="normal">  411</span>
<span class="normal">  412</span>
<span class="normal">  413</span>
<span class="normal">  414</span>
<span class="normal">  415</span>
<span class="normal">  416</span>
<span class="normal">  417</span>
<span class="normal">  418</span>
<span class="normal">  419</span>
<span class="normal">  420</span>
<span class="normal">  421</span>
<span class="normal">  422</span>
<span class="normal">  423</span>
<span class="normal">  424</span>
<span class="normal">  425</span>
<span class="normal">  426</span>
<span class="normal">  427</span>
<span class="normal">  428</span>
<span class="normal">  429</span>
<span class="normal">  430</span>
<span class="normal">  431</span>
<span class="normal">  432</span>
<span class="normal">  433</span>
<span class="normal">  434</span>
<span class="normal">  435</span>
<span class="normal">  436</span>
<span class="normal">  437</span>
<span class="normal">  438</span>
<span class="normal">  439</span>
<span class="normal">  440</span>
<span class="normal">  441</span>
<span class="normal">  442</span>
<span class="normal">  443</span>
<span class="normal">  444</span>
<span class="normal">  445</span>
<span class="normal">  446</span>
<span class="normal">  447</span>
<span class="normal">  448</span>
<span class="normal">  449</span>
<span class="normal">  450</span>
<span class="normal">  451</span>
<span class="normal">  452</span>
<span class="normal">  453</span>
<span class="normal">  454</span>
<span class="normal">  455</span>
<span class="normal">  456</span>
<span class="normal">  457</span>
<span class="normal">  458</span>
<span class="normal">  459</span>
<span class="normal">  460</span>
<span class="normal">  461</span>
<span class="normal">  462</span>
<span class="normal">  463</span>
<span class="normal">  464</span>
<span class="normal">  465</span>
<span class="normal">  466</span>
<span class="normal">  467</span>
<span class="normal">  468</span>
<span class="normal">  469</span>
<span class="normal">  470</span>
<span class="normal">  471</span>
<span class="normal">  472</span>
<span class="normal">  473</span>
<span class="normal">  474</span>
<span class="normal">  475</span>
<span class="normal">  476</span>
<span class="normal">  477</span>
<span class="normal">  478</span>
<span class="normal">  479</span>
<span class="normal">  480</span>
<span class="normal">  481</span>
<span class="normal">  482</span>
<span class="normal">  483</span>
<span class="normal">  484</span>
<span class="normal">  485</span>
<span class="normal">  486</span>
<span class="normal">  487</span>
<span class="normal">  488</span>
<span class="normal">  489</span>
<span class="normal">  490</span>
<span class="normal">  491</span>
<span class="normal">  492</span>
<span class="normal">  493</span>
<span class="normal">  494</span>
<span class="normal">  495</span>
<span class="normal">  496</span>
<span class="normal">  497</span>
<span class="normal">  498</span>
<span class="normal">  499</span>
<span class="normal">  500</span>
<span class="normal">  501</span>
<span class="normal">  502</span>
<span class="normal">  503</span>
<span class="normal">  504</span>
<span class="normal">  505</span>
<span class="normal">  506</span>
<span class="normal">  507</span>
<span class="normal">  508</span>
<span class="normal">  509</span>
<span class="normal">  510</span>
<span class="normal">  511</span>
<span class="normal">  512</span>
<span class="normal">  513</span>
<span class="normal">  514</span>
<span class="normal">  515</span>
<span class="normal">  516</span>
<span class="normal">  517</span>
<span class="normal">  518</span>
<span class="normal">  519</span>
<span class="normal">  520</span>
<span class="normal">  521</span>
<span class="normal">  522</span>
<span class="normal">  523</span>
<span class="normal">  524</span>
<span class="normal">  525</span>
<span class="normal">  526</span>
<span class="normal">  527</span>
<span class="normal">  528</span>
<span class="normal">  529</span>
<span class="normal">  530</span>
<span class="normal">  531</span>
<span class="normal">  532</span>
<span class="normal">  533</span>
<span class="normal">  534</span>
<span class="normal">  535</span>
<span class="normal">  536</span>
<span class="normal">  537</span>
<span class="normal">  538</span>
<span class="normal">  539</span>
<span class="normal">  540</span>
<span class="normal">  541</span>
<span class="normal">  542</span>
<span class="normal">  543</span>
<span class="normal">  544</span>
<span class="normal">  545</span>
<span class="normal">  546</span>
<span class="normal">  547</span>
<span class="normal">  548</span>
<span class="normal">  549</span>
<span class="normal">  550</span>
<span class="normal">  551</span>
<span class="normal">  552</span>
<span class="normal">  553</span>
<span class="normal">  554</span>
<span class="normal">  555</span>
<span class="normal">  556</span>
<span class="normal">  557</span>
<span class="normal">  558</span>
<span class="normal">  559</span>
<span class="normal">  560</span>
<span class="normal">  561</span>
<span class="normal">  562</span>
<span class="normal">  563</span>
<span class="normal">  564</span>
<span class="normal">  565</span>
<span class="normal">  566</span>
<span class="normal">  567</span>
<span class="normal">  568</span>
<span class="normal">  569</span>
<span class="normal">  570</span>
<span class="normal">  571</span>
<span class="normal">  572</span>
<span class="normal">  573</span>
<span class="normal">  574</span>
<span class="normal">  575</span>
<span class="normal">  576</span>
<span class="normal">  577</span>
<span class="normal">  578</span>
<span class="normal">  579</span>
<span class="normal">  580</span>
<span class="normal">  581</span>
<span class="normal">  582</span>
<span class="normal">  583</span>
<span class="normal">  584</span>
<span class="normal">  585</span>
<span class="normal">  586</span>
<span class="normal">  587</span>
<span class="normal">  588</span>
<span class="normal">  589</span>
<span class="normal">  590</span>
<span class="normal">  591</span>
<span class="normal">  592</span>
<span class="normal">  593</span>
<span class="normal">  594</span>
<span class="normal">  595</span>
<span class="normal">  596</span>
<span class="normal">  597</span>
<span class="normal">  598</span>
<span class="normal">  599</span>
<span class="normal">  600</span>
<span class="normal">  601</span>
<span class="normal">  602</span>
<span class="normal">  603</span>
<span class="normal">  604</span>
<span class="normal">  605</span>
<span class="normal">  606</span>
<span class="normal">  607</span>
<span class="normal">  608</span>
<span class="normal">  609</span>
<span class="normal">  610</span>
<span class="normal">  611</span>
<span class="normal">  612</span>
<span class="normal">  613</span>
<span class="normal">  614</span>
<span class="normal">  615</span>
<span class="normal">  616</span>
<span class="normal">  617</span>
<span class="normal">  618</span>
<span class="normal">  619</span>
<span class="normal">  620</span>
<span class="normal">  621</span>
<span class="normal">  622</span>
<span class="normal">  623</span>
<span class="normal">  624</span>
<span class="normal">  625</span>
<span class="normal">  626</span>
<span class="normal">  627</span>
<span class="normal">  628</span>
<span class="normal">  629</span>
<span class="normal">  630</span>
<span class="normal">  631</span>
<span class="normal">  632</span>
<span class="normal">  633</span>
<span class="normal">  634</span>
<span class="normal">  635</span>
<span class="normal">  636</span>
<span class="normal">  637</span>
<span class="normal">  638</span>
<span class="normal">  639</span>
<span class="normal">  640</span>
<span class="normal">  641</span>
<span class="normal">  642</span>
<span class="normal">  643</span>
<span class="normal">  644</span>
<span class="normal">  645</span>
<span class="normal">  646</span>
<span class="normal">  647</span>
<span class="normal">  648</span>
<span class="normal">  649</span>
<span class="normal">  650</span>
<span class="normal">  651</span>
<span class="normal">  652</span>
<span class="normal">  653</span>
<span class="normal">  654</span>
<span class="normal">  655</span>
<span class="normal">  656</span>
<span class="normal">  657</span>
<span class="normal">  658</span>
<span class="normal">  659</span>
<span class="normal">  660</span>
<span class="normal">  661</span>
<span class="normal">  662</span>
<span class="normal">  663</span>
<span class="normal">  664</span>
<span class="normal">  665</span>
<span class="normal">  666</span>
<span class="normal">  667</span>
<span class="normal">  668</span>
<span class="normal">  669</span>
<span class="normal">  670</span>
<span class="normal">  671</span>
<span class="normal">  672</span>
<span class="normal">  673</span>
<span class="normal">  674</span>
<span class="normal">  675</span>
<span class="normal">  676</span>
<span class="normal">  677</span>
<span class="normal">  678</span>
<span class="normal">  679</span>
<span class="normal">  680</span>
<span class="normal">  681</span>
<span class="normal">  682</span>
<span class="normal">  683</span>
<span class="normal">  684</span>
<span class="normal">  685</span>
<span class="normal">  686</span>
<span class="normal">  687</span>
<span class="normal">  688</span>
<span class="normal">  689</span>
<span class="normal">  690</span>
<span class="normal">  691</span>
<span class="normal">  692</span>
<span class="normal">  693</span>
<span class="normal">  694</span>
<span class="normal">  695</span>
<span class="normal">  696</span>
<span class="normal">  697</span>
<span class="normal">  698</span>
<span class="normal">  699</span>
<span class="normal">  700</span>
<span class="normal">  701</span>
<span class="normal">  702</span>
<span class="normal">  703</span>
<span class="normal">  704</span>
<span class="normal">  705</span>
<span class="normal">  706</span>
<span class="normal">  707</span>
<span class="normal">  708</span>
<span class="normal">  709</span>
<span class="normal">  710</span>
<span class="normal">  711</span>
<span class="normal">  712</span>
<span class="normal">  713</span>
<span class="normal">  714</span>
<span class="normal">  715</span>
<span class="normal">  716</span>
<span class="normal">  717</span>
<span class="normal">  718</span>
<span class="normal">  719</span>
<span class="normal">  720</span>
<span class="normal">  721</span>
<span class="normal">  722</span>
<span class="normal">  723</span>
<span class="normal">  724</span>
<span class="normal">  725</span>
<span class="normal">  726</span>
<span class="normal">  727</span>
<span class="normal">  728</span>
<span class="normal">  729</span>
<span class="normal">  730</span>
<span class="normal">  731</span>
<span class="normal">  732</span>
<span class="normal">  733</span>
<span class="normal">  734</span>
<span class="normal">  735</span>
<span class="normal">  736</span>
<span class="normal">  737</span>
<span class="normal">  738</span>
<span class="normal">  739</span>
<span class="normal">  740</span>
<span class="normal">  741</span>
<span class="normal">  742</span>
<span class="normal">  743</span>
<span class="normal">  744</span>
<span class="normal">  745</span>
<span class="normal">  746</span>
<span class="normal">  747</span>
<span class="normal">  748</span>
<span class="normal">  749</span>
<span class="normal">  750</span>
<span class="normal">  751</span>
<span class="normal">  752</span>
<span class="normal">  753</span>
<span class="normal">  754</span>
<span class="normal">  755</span>
<span class="normal">  756</span>
<span class="normal">  757</span>
<span class="normal">  758</span>
<span class="normal">  759</span>
<span class="normal">  760</span>
<span class="normal">  761</span>
<span class="normal">  762</span>
<span class="normal">  763</span>
<span class="normal">  764</span>
<span class="normal">  765</span>
<span class="normal">  766</span>
<span class="normal">  767</span>
<span class="normal">  768</span>
<span class="normal">  769</span>
<span class="normal">  770</span>
<span class="normal">  771</span>
<span class="normal">  772</span>
<span class="normal">  773</span>
<span class="normal">  774</span>
<span class="normal">  775</span>
<span class="normal">  776</span>
<span class="normal">  777</span>
<span class="normal">  778</span>
<span class="normal">  779</span>
<span class="normal">  780</span>
<span class="normal">  781</span>
<span class="normal">  782</span>
<span class="normal">  783</span>
<span class="normal">  784</span>
<span class="normal">  785</span>
<span class="normal">  786</span>
<span class="normal">  787</span>
<span class="normal">  788</span>
<span class="normal">  789</span>
<span class="normal">  790</span>
<span class="normal">  791</span>
<span class="normal">  792</span>
<span class="normal">  793</span>
<span class="normal">  794</span>
<span class="normal">  795</span>
<span class="normal">  796</span>
<span class="normal">  797</span>
<span class="normal">  798</span>
<span class="normal">  799</span>
<span class="normal">  800</span>
<span class="normal">  801</span>
<span class="normal">  802</span>
<span class="normal">  803</span>
<span class="normal">  804</span>
<span class="normal">  805</span>
<span class="normal">  806</span>
<span class="normal">  807</span>
<span class="normal">  808</span>
<span class="normal">  809</span>
<span class="normal">  810</span>
<span class="normal">  811</span>
<span class="normal">  812</span>
<span class="normal">  813</span>
<span class="normal">  814</span>
<span class="normal">  815</span>
<span class="normal">  816</span>
<span class="normal">  817</span>
<span class="normal">  818</span>
<span class="normal">  819</span>
<span class="normal">  820</span>
<span class="normal">  821</span>
<span class="normal">  822</span>
<span class="normal">  823</span>
<span class="normal">  824</span>
<span class="normal">  825</span>
<span class="normal">  826</span>
<span class="normal">  827</span>
<span class="normal">  828</span>
<span class="normal">  829</span>
<span class="normal">  830</span>
<span class="normal">  831</span>
<span class="normal">  832</span>
<span class="normal">  833</span>
<span class="normal">  834</span>
<span class="normal">  835</span>
<span class="normal">  836</span>
<span class="normal">  837</span>
<span class="normal">  838</span>
<span class="normal">  839</span>
<span class="normal">  840</span>
<span class="normal">  841</span>
<span class="normal">  842</span>
<span class="normal">  843</span>
<span class="normal">  844</span>
<span class="normal">  845</span>
<span class="normal">  846</span>
<span class="normal">  847</span>
<span class="normal">  848</span>
<span class="normal">  849</span>
<span class="normal">  850</span>
<span class="normal">  851</span>
<span class="normal">  852</span>
<span class="normal">  853</span>
<span class="normal">  854</span>
<span class="normal">  855</span>
<span class="normal">  856</span>
<span class="normal">  857</span>
<span class="normal">  858</span>
<span class="normal">  859</span>
<span class="normal">  860</span>
<span class="normal">  861</span>
<span class="normal">  862</span>
<span class="normal">  863</span>
<span class="normal">  864</span>
<span class="normal">  865</span>
<span class="normal">  866</span>
<span class="normal">  867</span>
<span class="normal">  868</span>
<span class="normal">  869</span>
<span class="normal">  870</span>
<span class="normal">  871</span>
<span class="normal">  872</span>
<span class="normal">  873</span>
<span class="normal">  874</span>
<span class="normal">  875</span>
<span class="normal">  876</span>
<span class="normal">  877</span>
<span class="normal">  878</span>
<span class="normal">  879</span>
<span class="normal">  880</span>
<span class="normal">  881</span>
<span class="normal">  882</span>
<span class="normal">  883</span>
<span class="normal">  884</span>
<span class="normal">  885</span>
<span class="normal">  886</span>
<span class="normal">  887</span>
<span class="normal">  888</span>
<span class="normal">  889</span>
<span class="normal">  890</span>
<span class="normal">  891</span>
<span class="normal">  892</span>
<span class="normal">  893</span>
<span class="normal">  894</span>
<span class="normal">  895</span>
<span class="normal">  896</span>
<span class="normal">  897</span>
<span class="normal">  898</span>
<span class="normal">  899</span>
<span class="normal">  900</span>
<span class="normal">  901</span>
<span class="normal">  902</span>
<span class="normal">  903</span>
<span class="normal">  904</span>
<span class="normal">  905</span>
<span class="normal">  906</span>
<span class="normal">  907</span>
<span class="normal">  908</span>
<span class="normal">  909</span>
<span class="normal">  910</span>
<span class="normal">  911</span>
<span class="normal">  912</span>
<span class="normal">  913</span>
<span class="normal">  914</span>
<span class="normal">  915</span>
<span class="normal">  916</span>
<span class="normal">  917</span>
<span class="normal">  918</span>
<span class="normal">  919</span>
<span class="normal">  920</span>
<span class="normal">  921</span>
<span class="normal">  922</span>
<span class="normal">  923</span>
<span class="normal">  924</span>
<span class="normal">  925</span>
<span class="normal">  926</span>
<span class="normal">  927</span>
<span class="normal">  928</span>
<span class="normal">  929</span>
<span class="normal">  930</span>
<span class="normal">  931</span>
<span class="normal">  932</span>
<span class="normal">  933</span>
<span class="normal">  934</span>
<span class="normal">  935</span>
<span class="normal">  936</span>
<span class="normal">  937</span>
<span class="normal">  938</span>
<span class="normal">  939</span>
<span class="normal">  940</span>
<span class="normal">  941</span>
<span class="normal">  942</span>
<span class="normal">  943</span>
<span class="normal">  944</span>
<span class="normal">  945</span>
<span class="normal">  946</span>
<span class="normal">  947</span>
<span class="normal">  948</span>
<span class="normal">  949</span>
<span class="normal">  950</span>
<span class="normal">  951</span>
<span class="normal">  952</span>
<span class="normal">  953</span>
<span class="normal">  954</span>
<span class="normal">  955</span>
<span class="normal">  956</span>
<span class="normal">  957</span>
<span class="normal">  958</span>
<span class="normal">  959</span>
<span class="normal">  960</span>
<span class="normal">  961</span>
<span class="normal">  962</span>
<span class="normal">  963</span>
<span class="normal">  964</span>
<span class="normal">  965</span>
<span class="normal">  966</span>
<span class="normal">  967</span>
<span class="normal">  968</span>
<span class="normal">  969</span>
<span class="normal">  970</span>
<span class="normal">  971</span>
<span class="normal">  972</span>
<span class="normal">  973</span>
<span class="normal">  974</span>
<span class="normal">  975</span>
<span class="normal">  976</span>
<span class="normal">  977</span>
<span class="normal">  978</span>
<span class="normal">  979</span>
<span class="normal">  980</span>
<span class="normal">  981</span>
<span class="normal">  982</span>
<span class="normal">  983</span>
<span class="normal">  984</span>
<span class="normal">  985</span>
<span class="normal">  986</span>
<span class="normal">  987</span>
<span class="normal">  988</span>
<span class="normal">  989</span>
<span class="normal">  990</span>
<span class="normal">  991</span>
<span class="normal">  992</span>
<span class="normal">  993</span>
<span class="normal">  994</span>
<span class="normal">  995</span>
<span class="normal">  996</span>
<span class="normal">  997</span>
<span class="normal">  998</span>
<span class="normal">  999</span>
<span class="normal"> 1000</span>
<span class="normal"> 1001</span>
<span class="normal"> 1002</span>
<span class="normal"> 1003</span>
<span class="normal"> 1004</span>
<span class="normal"> 1005</span>
<span class="normal"> 1006</span>
<span class="normal"> 1007</span>
<span class="normal"> 1008</span>
<span class="normal"> 1009</span>
<span class="normal"> 1010</span>
<span class="normal"> 1011</span>
<span class="normal"> 1012</span>
<span class="normal"> 1013</span>
<span class="normal"> 1014</span>
<span class="normal"> 1015</span>
<span class="normal"> 1016</span>
<span class="normal"> 1017</span>
<span class="normal"> 1018</span>
<span class="normal"> 1019</span>
<span class="normal"> 1020</span>
<span class="normal"> 1021</span>
<span class="normal"> 1022</span>
<span class="normal"> 1023</span>
<span class="normal"> 1024</span>
<span class="normal"> 1025</span>
<span class="normal"> 1026</span>
<span class="normal"> 1027</span>
<span class="normal"> 1028</span>
<span class="normal"> 1029</span>
<span class="normal"> 1030</span>
<span class="normal"> 1031</span>
<span class="normal"> 1032</span>
<span class="normal"> 1033</span>
<span class="normal"> 1034</span>
<span class="normal"> 1035</span>
<span class="normal"> 1036</span>
<span class="normal"> 1037</span>
<span class="normal"> 1038</span>
<span class="normal"> 1039</span>
<span class="normal"> 1040</span>
<span class="normal"> 1041</span>
<span class="normal"> 1042</span>
<span class="normal"> 1043</span>
<span class="normal"> 1044</span>
<span class="normal"> 1045</span>
<span class="normal"> 1046</span>
<span class="normal"> 1047</span>
<span class="normal"> 1048</span>
<span class="normal"> 1049</span>
<span class="normal"> 1050</span>
<span class="normal"> 1051</span>
<span class="normal"> 1052</span>
<span class="normal"> 1053</span>
<span class="normal"> 1054</span>
<span class="normal"> 1055</span>
<span class="normal"> 1056</span>
<span class="normal"> 1057</span>
<span class="normal"> 1058</span>
<span class="normal"> 1059</span>
<span class="normal"> 1060</span>
<span class="normal"> 1061</span>
<span class="normal"> 1062</span>
<span class="normal"> 1063</span>
<span class="normal"> 1064</span>
<span class="normal"> 1065</span>
<span class="normal"> 1066</span>
<span class="normal"> 1067</span>
<span class="normal"> 1068</span>
<span class="normal"> 1069</span>
<span class="normal"> 1070</span>
<span class="normal"> 1071</span>
<span class="normal"> 1072</span>
<span class="normal"> 1073</span>
<span class="normal"> 1074</span>
<span class="normal"> 1075</span>
<span class="normal"> 1076</span>
<span class="normal"> 1077</span>
<span class="normal"> 1078</span>
<span class="normal"> 1079</span>
<span class="normal"> 1080</span>
<span class="normal"> 1081</span>
<span class="normal"> 1082</span>
<span class="normal"> 1083</span>
<span class="normal"> 1084</span>
<span class="normal"> 1085</span>
<span class="normal"> 1086</span>
<span class="normal"> 1087</span>
<span class="normal"> 1088</span>
<span class="normal"> 1089</span>
<span class="normal"> 1090</span>
<span class="normal"> 1091</span>
<span class="normal"> 1092</span>
<span class="normal"> 1093</span>
<span class="normal"> 1094</span>
<span class="normal"> 1095</span>
<span class="normal"> 1096</span>
<span class="normal"> 1097</span>
<span class="normal"> 1098</span>
<span class="normal"> 1099</span>
<span class="normal"> 1100</span>
<span class="normal"> 1101</span>
<span class="normal"> 1102</span>
<span class="normal"> 1103</span>
<span class="normal"> 1104</span>
<span class="normal"> 1105</span>
<span class="normal"> 1106</span>
<span class="normal"> 1107</span>
<span class="normal"> 1108</span>
<span class="normal"> 1109</span>
<span class="normal"> 1110</span>
<span class="normal"> 1111</span>
<span class="normal"> 1112</span>
<span class="normal"> 1113</span>
<span class="normal"> 1114</span>
<span class="normal"> 1115</span>
<span class="normal"> 1116</span>
<span class="normal"> 1117</span>
<span class="normal"> 1118</span>
<span class="normal"> 1119</span>
<span class="normal"> 1120</span>
<span class="normal"> 1121</span>
<span class="normal"> 1122</span>
<span class="normal"> 1123</span>
<span class="normal"> 1124</span>
<span class="normal"> 1125</span>
<span class="normal"> 1126</span>
<span class="normal"> 1127</span>
<span class="normal"> 1128</span>
<span class="normal"> 1129</span>
<span class="normal"> 1130</span>
<span class="normal"> 1131</span>
<span class="normal"> 1132</span>
<span class="normal"> 1133</span>
<span class="normal"> 1134</span>
<span class="normal"> 1135</span>
<span class="normal"> 1136</span>
<span class="normal"> 1137</span>
<span class="normal"> 1138</span>
<span class="normal"> 1139</span>
<span class="normal"> 1140</span>
<span class="normal"> 1141</span>
<span class="normal"> 1142</span>
<span class="normal"> 1143</span>
<span class="normal"> 1144</span>
<span class="normal"> 1145</span>
<span class="normal"> 1146</span>
<span class="normal"> 1147</span>
<span class="normal"> 1148</span>
<span class="normal"> 1149</span>
<span class="normal"> 1150</span>
<span class="normal"> 1151</span>
<span class="normal"> 1152</span>
<span class="normal"> 1153</span>
<span class="normal"> 1154</span>
<span class="normal"> 1155</span>
<span class="normal"> 1156</span>
<span class="normal"> 1157</span>
<span class="normal"> 1158</span>
<span class="normal"> 1159</span>
<span class="normal"> 1160</span>
<span class="normal"> 1161</span>
<span class="normal"> 1162</span>
<span class="normal"> 1163</span>
<span class="normal"> 1164</span>
<span class="normal"> 1165</span>
<span class="normal"> 1166</span>
<span class="normal"> 1167</span>
<span class="normal"> 1168</span>
<span class="normal"> 1169</span>
<span class="normal"> 1170</span>
<span class="normal"> 1171</span>
<span class="normal"> 1172</span>
<span class="normal"> 1173</span>
<span class="normal"> 1174</span>
<span class="normal"> 1175</span>
<span class="normal"> 1176</span>
<span class="normal"> 1177</span>
<span class="normal"> 1178</span>
<span class="normal"> 1179</span>
<span class="normal"> 1180</span>
<span class="normal"> 1181</span>
<span class="normal"> 1182</span>
<span class="normal"> 1183</span>
<span class="normal"> 1184</span>
<span class="normal"> 1185</span>
<span class="normal"> 1186</span>
<span class="normal"> 1187</span>
<span class="normal"> 1188</span>
<span class="normal"> 1189</span>
<span class="normal"> 1190</span>
<span class="normal"> 1191</span>
<span class="normal"> 1192</span>
<span class="normal"> 1193</span>
<span class="normal"> 1194</span>
<span class="normal"> 1195</span>
<span class="normal"> 1196</span>
<span class="normal"> 1197</span>
<span class="normal"> 1198</span>
<span class="normal"> 1199</span>
<span class="normal"> 1200</span>
<span class="normal"> 1201</span>
<span class="normal"> 1202</span>
<span class="normal"> 1203</span>
<span class="normal"> 1204</span>
<span class="normal"> 1205</span>
<span class="normal"> 1206</span>
<span class="normal"> 1207</span>
<span class="normal"> 1208</span>
<span class="normal"> 1209</span>
<span class="normal"> 1210</span>
<span class="normal"> 1211</span>
<span class="normal"> 1212</span>
<span class="normal"> 1213</span>
<span class="normal"> 1214</span>
<span class="normal"> 1215</span>
<span class="normal"> 1216</span>
<span class="normal"> 1217</span>
<span class="normal"> 1218</span>
<span class="normal"> 1219</span>
<span class="normal"> 1220</span>
<span class="normal"> 1221</span>
<span class="normal"> 1222</span>
<span class="normal"> 1223</span>
<span class="normal"> 1224</span>
<span class="normal"> 1225</span>
<span class="normal"> 1226</span>
<span class="normal"> 1227</span>
<span class="normal"> 1228</span>
<span class="normal"> 1229</span>
<span class="normal"> 1230</span>
<span class="normal"> 1231</span>
<span class="normal"> 1232</span>
<span class="normal"> 1233</span>
<span class="normal"> 1234</span>
<span class="normal"> 1235</span>
<span class="normal"> 1236</span>
<span class="normal"> 1237</span>
<span class="normal"> 1238</span>
<span class="normal"> 1239</span>
<span class="normal"> 1240</span>
<span class="normal"> 1241</span>
<span class="normal"> 1242</span>
<span class="normal"> 1243</span>
<span class="normal"> 1244</span>
<span class="normal"> 1245</span>
<span class="normal"> 1246</span>
<span class="normal"> 1247</span>
<span class="normal"> 1248</span>
<span class="normal"> 1249</span>
<span class="normal"> 1250</span>
<span class="normal"> 1251</span>
<span class="normal"> 1252</span>
<span class="normal"> 1253</span>
<span class="normal"> 1254</span>
<span class="normal"> 1255</span>
<span class="normal"> 1256</span>
<span class="normal"> 1257</span>
<span class="normal"> 1258</span>
<span class="normal"> 1259</span>
<span class="normal"> 1260</span>
<span class="normal"> 1261</span>
<span class="normal"> 1262</span>
<span class="normal"> 1263</span>
<span class="normal"> 1264</span>
<span class="normal"> 1265</span>
<span class="normal"> 1266</span>
<span class="normal"> 1267</span>
<span class="normal"> 1268</span>
<span class="normal"> 1269</span>
<span class="normal"> 1270</span>
<span class="normal"> 1271</span>
<span class="normal"> 1272</span>
<span class="normal"> 1273</span>
<span class="normal"> 1274</span>
<span class="normal"> 1275</span>
<span class="normal"> 1276</span>
<span class="normal"> 1277</span>
<span class="normal"> 1278</span>
<span class="normal"> 1279</span>
<span class="normal"> 1280</span>
<span class="normal"> 1281</span>
<span class="normal"> 1282</span>
<span class="normal"> 1283</span>
<span class="normal"> 1284</span>
<span class="normal"> 1285</span>
<span class="normal"> 1286</span>
<span class="normal"> 1287</span>
<span class="normal"> 1288</span>
<span class="normal"> 1289</span>
<span class="normal"> 1290</span>
<span class="normal"> 1291</span>
<span class="normal"> 1292</span>
<span class="normal"> 1293</span>
<span class="normal"> 1294</span>
<span class="normal"> 1295</span>
<span class="normal"> 1296</span>
<span class="normal"> 1297</span>
<span class="normal"> 1298</span>
<span class="normal"> 1299</span>
<span class="normal"> 1300</span>
<span class="normal"> 1301</span>
<span class="normal"> 1302</span>
<span class="normal"> 1303</span>
<span class="normal"> 1304</span>
<span class="normal"> 1305</span>
<span class="normal"> 1306</span>
<span class="normal"> 1307</span>
<span class="normal"> 1308</span>
<span class="normal"> 1309</span>
<span class="normal"> 1310</span>
<span class="normal"> 1311</span>
<span class="normal"> 1312</span>
<span class="normal"> 1313</span>
<span class="normal"> 1314</span>
<span class="normal"> 1315</span>
<span class="normal"> 1316</span>
<span class="normal"> 1317</span>
<span class="normal"> 1318</span>
<span class="normal"> 1319</span>
<span class="normal"> 1320</span>
<span class="normal"> 1321</span>
<span class="normal"> 1322</span>
<span class="normal"> 1323</span>
<span class="normal"> 1324</span>
<span class="normal"> 1325</span>
<span class="normal"> 1326</span>
<span class="normal"> 1327</span>
<span class="normal"> 1328</span>
<span class="normal"> 1329</span>
<span class="normal"> 1330</span>
<span class="normal"> 1331</span>
<span class="normal"> 1332</span>
<span class="normal"> 1333</span>
<span class="normal"> 1334</span>
<span class="normal"> 1335</span>
<span class="normal"> 1336</span>
<span class="normal"> 1337</span>
<span class="normal"> 1338</span>
<span class="normal"> 1339</span>
<span class="normal"> 1340</span>
<span class="normal"> 1341</span>
<span class="normal"> 1342</span>
<span class="normal"> 1343</span>
<span class="normal"> 1344</span>
<span class="normal"> 1345</span>
<span class="normal"> 1346</span>
<span class="normal"> 1347</span>
<span class="normal"> 1348</span>
<span class="normal"> 1349</span>
<span class="normal"> 1350</span>
<span class="normal"> 1351</span>
<span class="normal"> 1352</span>
<span class="normal"> 1353</span>
<span class="normal"> 1354</span>
<span class="normal"> 1355</span>
<span class="normal"> 1356</span>
<span class="normal"> 1357</span>
<span class="normal"> 1358</span>
<span class="normal"> 1359</span>
<span class="normal"> 1360</span>
<span class="normal"> 1361</span>
<span class="normal"> 1362</span>
<span class="normal"> 1363</span>
<span class="normal"> 1364</span>
<span class="normal"> 1365</span>
<span class="normal"> 1366</span>
<span class="normal"> 1367</span>
<span class="normal"> 1368</span>
<span class="normal"> 1369</span>
<span class="normal"> 1370</span>
<span class="normal"> 1371</span>
<span class="normal"> 1372</span>
<span class="normal"> 1373</span>
<span class="normal"> 1374</span>
<span class="normal"> 1375</span>
<span class="normal"> 1376</span>
<span class="normal"> 1377</span>
<span class="normal"> 1378</span>
<span class="normal"> 1379</span>
<span class="normal"> 1380</span>
<span class="normal"> 1381</span>
<span class="normal"> 1382</span>
<span class="normal"> 1383</span>
<span class="normal"> 1384</span>
<span class="normal"> 1385</span>
<span class="normal"> 1386</span>
<span class="normal"> 1387</span>
<span class="normal"> 1388</span>
<span class="normal"> 1389</span>
<span class="normal"> 1390</span>
<span class="normal"> 1391</span>
<span class="normal"> 1392</span>
<span class="normal"> 1393</span>
<span class="normal"> 1394</span>
<span class="normal"> 1395</span>
<span class="normal"> 1396</span>
<span class="normal"> 1397</span>
<span class="normal"> 1398</span>
<span class="normal"> 1399</span>
<span class="normal"> 1400</span>
<span class="normal"> 1401</span>
<span class="normal"> 1402</span>
<span class="normal"> 1403</span>
<span class="normal"> 1404</span>
<span class="normal"> 1405</span>
<span class="normal"> 1406</span>
<span class="normal"> 1407</span>
<span class="normal"> 1408</span>
<span class="normal"> 1409</span>
<span class="normal"> 1410</span>
<span class="normal"> 1411</span>
<span class="normal"> 1412</span>
<span class="normal"> 1413</span>
<span class="normal"> 1414</span>
<span class="normal"> 1415</span>
<span class="normal"> 1416</span>
<span class="normal"> 1417</span>
<span class="normal"> 1418</span>
<span class="normal"> 1419</span>
<span class="normal"> 1420</span>
<span class="normal"> 1421</span>
<span class="normal"> 1422</span>
<span class="normal"> 1423</span>
<span class="normal"> 1424</span>
<span class="normal"> 1425</span>
<span class="normal"> 1426</span>
<span class="normal"> 1427</span>
<span class="normal"> 1428</span>
<span class="normal"> 1429</span>
<span class="normal"> 1430</span>
<span class="normal"> 1431</span>
<span class="normal"> 1432</span>
<span class="normal"> 1433</span>
<span class="normal"> 1434</span>
<span class="normal"> 1435</span>
<span class="normal"> 1436</span>
<span class="normal"> 1437</span>
<span class="normal"> 1438</span>
<span class="normal"> 1439</span>
<span class="normal"> 1440</span>
<span class="normal"> 1441</span>
<span class="normal"> 1442</span>
<span class="normal"> 1443</span>
<span class="normal"> 1444</span>
<span class="normal"> 1445</span>
<span class="normal"> 1446</span>
<span class="normal"> 1447</span>
<span class="normal"> 1448</span>
<span class="normal"> 1449</span>
<span class="normal"> 1450</span>
<span class="normal"> 1451</span>
<span class="normal"> 1452</span>
<span class="normal"> 1453</span>
<span class="normal"> 1454</span>
<span class="normal"> 1455</span>
<span class="normal"> 1456</span>
<span class="normal"> 1457</span>
<span class="normal"> 1458</span>
<span class="normal"> 1459</span>
<span class="normal"> 1460</span>
<span class="normal"> 1461</span>
<span class="normal"> 1462</span>
<span class="normal"> 1463</span>
<span class="normal"> 1464</span>
<span class="normal"> 1465</span>
<span class="normal"> 1466</span>
<span class="normal"> 1467</span>
<span class="normal"> 1468</span>
<span class="normal"> 1469</span>
<span class="normal"> 1470</span>
<span class="normal"> 1471</span>
<span class="normal"> 1472</span>
<span class="normal"> 1473</span>
<span class="normal"> 1474</span>
<span class="normal"> 1475</span>
<span class="normal"> 1476</span>
<span class="normal"> 1477</span>
<span class="normal"> 1478</span>
<span class="normal"> 1479</span>
<span class="normal"> 1480</span>
<span class="normal"> 1481</span>
<span class="normal"> 1482</span>
<span class="normal"> 1483</span>
<span class="normal"> 1484</span>
<span class="normal"> 1485</span>
<span class="normal"> 1486</span>
<span class="normal"> 1487</span>
<span class="normal"> 1488</span>
<span class="normal"> 1489</span>
<span class="normal"> 1490</span>
<span class="normal"> 1491</span>
<span class="normal"> 1492</span>
<span class="normal"> 1493</span>
<span class="normal"> 1494</span>
<span class="normal"> 1495</span>
<span class="normal"> 1496</span>
<span class="normal"> 1497</span>
<span class="normal"> 1498</span>
<span class="normal"> 1499</span>
<span class="normal"> 1500</span>
<span class="normal"> 1501</span>
<span class="normal"> 1502</span>
<span class="normal"> 1503</span>
<span class="normal"> 1504</span>
<span class="normal"> 1505</span>
<span class="normal"> 1506</span>
<span class="normal"> 1507</span>
<span class="normal"> 1508</span>
<span class="normal"> 1509</span>
<span class="normal"> 1510</span>
<span class="normal"> 1511</span>
<span class="normal"> 1512</span>
<span class="normal"> 1513</span>
<span class="normal"> 1514</span>
<span class="normal"> 1515</span>
<span class="normal"> 1516</span>
<span class="normal"> 1517</span>
<span class="normal"> 1518</span>
<span class="normal"> 1519</span>
<span class="normal"> 1520</span>
<span class="normal"> 1521</span>
<span class="normal"> 1522</span>
<span class="normal"> 1523</span>
<span class="normal"> 1524</span>
<span class="normal"> 1525</span>
<span class="normal"> 1526</span>
<span class="normal"> 1527</span>
<span class="normal"> 1528</span>
<span class="normal"> 1529</span>
<span class="normal"> 1530</span>
<span class="normal"> 1531</span>
<span class="normal"> 1532</span>
<span class="normal"> 1533</span>
<span class="normal"> 1534</span>
<span class="normal"> 1535</span>
<span class="normal"> 1536</span>
<span class="normal"> 1537</span>
<span class="normal"> 1538</span>
<span class="normal"> 1539</span>
<span class="normal"> 1540</span>
<span class="normal"> 1541</span>
<span class="normal"> 1542</span>
<span class="normal"> 1543</span>
<span class="normal"> 1544</span>
<span class="normal"> 1545</span>
<span class="normal"> 1546</span>
<span class="normal"> 1547</span>
<span class="normal"> 1548</span>
<span class="normal"> 1549</span>
<span class="normal"> 1550</span>
<span class="normal"> 1551</span>
<span class="normal"> 1552</span>
<span class="normal"> 1553</span>
<span class="normal"> 1554</span>
<span class="normal"> 1555</span>
<span class="normal"> 1556</span>
<span class="normal"> 1557</span>
<span class="normal"> 1558</span>
<span class="normal"> 1559</span>
<span class="normal"> 1560</span>
<span class="normal"> 1561</span>
<span class="normal"> 1562</span>
<span class="normal"> 1563</span>
<span class="normal"> 1564</span>
<span class="normal"> 1565</span>
<span class="normal"> 1566</span>
<span class="normal"> 1567</span>
<span class="normal"> 1568</span>
<span class="normal"> 1569</span>
<span class="normal"> 1570</span>
<span class="normal"> 1571</span>
<span class="normal"> 1572</span>
<span class="normal"> 1573</span>
<span class="normal"> 1574</span>
<span class="normal"> 1575</span>
<span class="normal"> 1576</span>
<span class="normal"> 1577</span>
<span class="normal"> 1578</span>
<span class="normal"> 1579</span>
<span class="normal"> 1580</span>
<span class="normal"> 1581</span>
<span class="normal"> 1582</span>
<span class="normal"> 1583</span>
<span class="normal"> 1584</span>
<span class="normal"> 1585</span>
<span class="normal"> 1586</span>
<span class="normal"> 1587</span>
<span class="normal"> 1588</span>
<span class="normal"> 1589</span>
<span class="normal"> 1590</span>
<span class="normal"> 1591</span>
<span class="normal"> 1592</span>
<span class="normal"> 1593</span>
<span class="normal"> 1594</span>
<span class="normal"> 1595</span>
<span class="normal"> 1596</span>
<span class="normal"> 1597</span>
<span class="normal"> 1598</span>
<span class="normal"> 1599</span>
<span class="normal"> 1600</span>
<span class="normal"> 1601</span>
<span class="normal"> 1602</span>
<span class="normal"> 1603</span>
<span class="normal"> 1604</span>
<span class="normal"> 1605</span>
<span class="normal"> 1606</span>
<span class="normal"> 1607</span>
<span class="normal"> 1608</span>
<span class="normal"> 1609</span>
<span class="normal"> 1610</span>
<span class="normal"> 1611</span>
<span class="normal"> 1612</span>
<span class="normal"> 1613</span>
<span class="normal"> 1614</span>
<span class="normal"> 1615</span>
<span class="normal"> 1616</span>
<span class="normal"> 1617</span>
<span class="normal"> 1618</span>
<span class="normal"> 1619</span>
<span class="normal"> 1620</span>
<span class="normal"> 1621</span>
<span class="normal"> 1622</span>
<span class="normal"> 1623</span>
<span class="normal"> 1624</span>
<span class="normal"> 1625</span>
<span class="normal"> 1626</span>
<span class="normal"> 1627</span>
<span class="normal"> 1628</span>
<span class="normal"> 1629</span>
<span class="normal"> 1630</span>
<span class="normal"> 1631</span>
<span class="normal"> 1632</span>
<span class="normal"> 1633</span>
<span class="normal"> 1634</span>
<span class="normal"> 1635</span>
<span class="normal"> 1636</span>
<span class="normal"> 1637</span>
<span class="normal"> 1638</span>
<span class="normal"> 1639</span>
<span class="normal"> 1640</span>
<span class="normal"> 1641</span>
<span class="normal"> 1642</span>
<span class="normal"> 1643</span>
<span class="normal"> 1644</span>
<span class="normal"> 1645</span>
<span class="normal"> 1646</span>
<span class="normal"> 1647</span>
<span class="normal"> 1648</span>
<span class="normal"> 1649</span>
<span class="normal"> 1650</span>
<span class="normal"> 1651</span>
<span class="normal"> 1652</span>
<span class="normal"> 1653</span>
<span class="normal"> 1654</span>
<span class="normal"> 1655</span>
<span class="normal"> 1656</span>
<span class="normal"> 1657</span>
<span class="normal"> 1658</span>
<span class="normal"> 1659</span>
<span class="normal"> 1660</span>
<span class="normal"> 1661</span>
<span class="normal"> 1662</span>
<span class="normal"> 1663</span>
<span class="normal"> 1664</span>
<span class="normal"> 1665</span>
<span class="normal"> 1666</span>
<span class="normal"> 1667</span>
<span class="normal"> 1668</span>
<span class="normal"> 1669</span>
<span class="normal"> 1670</span>
<span class="normal"> 1671</span>
<span class="normal"> 1672</span>
<span class="normal"> 1673</span>
<span class="normal"> 1674</span>
<span class="normal"> 1675</span>
<span class="normal"> 1676</span>
<span class="normal"> 1677</span>
<span class="normal"> 1678</span>
<span class="normal"> 1679</span>
<span class="normal"> 1680</span>
<span class="normal"> 1681</span>
<span class="normal"> 1682</span>
<span class="normal"> 1683</span>
<span class="normal"> 1684</span>
<span class="normal"> 1685</span>
<span class="normal"> 1686</span>
<span class="normal"> 1687</span>
<span class="normal"> 1688</span>
<span class="normal"> 1689</span>
<span class="normal"> 1690</span>
<span class="normal"> 1691</span>
<span class="normal"> 1692</span>
<span class="normal"> 1693</span>
<span class="normal"> 1694</span>
<span class="normal"> 1695</span>
<span class="normal"> 1696</span>
<span class="normal"> 1697</span>
<span class="normal"> 1698</span>
<span class="normal"> 1699</span>
<span class="normal"> 1700</span>
<span class="normal"> 1701</span>
<span class="normal"> 1702</span>
<span class="normal"> 1703</span>
<span class="normal"> 1704</span>
<span class="normal"> 1705</span>
<span class="normal"> 1706</span>
<span class="normal"> 1707</span>
<span class="normal"> 1708</span>
<span class="normal"> 1709</span>
<span class="normal"> 1710</span>
<span class="normal"> 1711</span>
<span class="normal"> 1712</span>
<span class="normal"> 1713</span>
<span class="normal"> 1714</span>
<span class="normal"> 1715</span>
<span class="normal"> 1716</span>
<span class="normal"> 1717</span>
<span class="normal"> 1718</span>
<span class="normal"> 1719</span>
<span class="normal"> 1720</span>
<span class="normal"> 1721</span>
<span class="normal"> 1722</span>
<span class="normal"> 1723</span>
<span class="normal"> 1724</span>
<span class="normal"> 1725</span>
<span class="normal"> 1726</span>
<span class="normal"> 1727</span>
<span class="normal"> 1728</span>
<span class="normal"> 1729</span>
<span class="normal"> 1730</span>
<span class="normal"> 1731</span>
<span class="normal"> 1732</span>
<span class="normal"> 1733</span>
<span class="normal"> 1734</span>
<span class="normal"> 1735</span>
<span class="normal"> 1736</span>
<span class="normal"> 1737</span>
<span class="normal"> 1738</span>
<span class="normal"> 1739</span>
<span class="normal"> 1740</span>
<span class="normal"> 1741</span>
<span class="normal"> 1742</span>
<span class="normal"> 1743</span>
<span class="normal"> 1744</span>
<span class="normal"> 1745</span>
<span class="normal"> 1746</span>
<span class="normal"> 1747</span>
<span class="normal"> 1748</span>
<span class="normal"> 1749</span>
<span class="normal"> 1750</span>
<span class="normal"> 1751</span>
<span class="normal"> 1752</span>
<span class="normal"> 1753</span>
<span class="normal"> 1754</span>
<span class="normal"> 1755</span>
<span class="normal"> 1756</span>
<span class="normal"> 1757</span>
<span class="normal"> 1758</span>
<span class="normal"> 1759</span>
<span class="normal"> 1760</span>
<span class="normal"> 1761</span>
<span class="normal"> 1762</span>
<span class="normal"> 1763</span>
<span class="normal"> 1764</span>
<span class="normal"> 1765</span>
<span class="normal"> 1766</span>
<span class="normal"> 1767</span>
<span class="normal"> 1768</span>
<span class="normal"> 1769</span>
<span class="normal"> 1770</span>
<span class="normal"> 1771</span>
<span class="normal"> 1772</span>
<span class="normal"> 1773</span>
<span class="normal"> 1774</span>
<span class="normal"> 1775</span>
<span class="normal"> 1776</span>
<span class="normal"> 1777</span>
<span class="normal"> 1778</span>
<span class="normal"> 1779</span>
<span class="normal"> 1780</span>
<span class="normal"> 1781</span>
<span class="normal"> 1782</span>
<span class="normal"> 1783</span>
<span class="normal"> 1784</span>
<span class="normal"> 1785</span>
<span class="normal"> 1786</span>
<span class="normal"> 1787</span>
<span class="normal"> 1788</span>
<span class="normal"> 1789</span>
<span class="normal"> 1790</span>
<span class="normal"> 1791</span>
<span class="normal"> 1792</span>
<span class="normal"> 1793</span>
<span class="normal"> 1794</span>
<span class="normal"> 1795</span>
<span class="normal"> 1796</span>
<span class="normal"> 1797</span>
<span class="normal"> 1798</span>
<span class="normal"> 1799</span>
<span class="normal"> 1800</span>
<span class="normal"> 1801</span>
<span class="normal"> 1802</span>
<span class="normal"> 1803</span>
<span class="normal"> 1804</span>
<span class="normal"> 1805</span>
<span class="normal"> 1806</span>
<span class="normal"> 1807</span>
<span class="normal"> 1808</span>
<span class="normal"> 1809</span>
<span class="normal"> 1810</span>
<span class="normal"> 1811</span>
<span class="normal"> 1812</span>
<span class="normal"> 1813</span>
<span class="normal"> 1814</span>
<span class="normal"> 1815</span>
<span class="normal"> 1816</span>
<span class="normal"> 1817</span>
<span class="normal"> 1818</span>
<span class="normal"> 1819</span>
<span class="normal"> 1820</span>
<span class="normal"> 1821</span>
<span class="normal"> 1822</span>
<span class="normal"> 1823</span>
<span class="normal"> 1824</span>
<span class="normal"> 1825</span>
<span class="normal"> 1826</span>
<span class="normal"> 1827</span>
<span class="normal"> 1828</span>
<span class="normal"> 1829</span>
<span class="normal"> 1830</span>
<span class="normal"> 1831</span>
<span class="normal"> 1832</span>
<span class="normal"> 1833</span>
<span class="normal"> 1834</span>
<span class="normal"> 1835</span>
<span class="normal"> 1836</span>
<span class="normal"> 1837</span>
<span class="normal"> 1838</span>
<span class="normal"> 1839</span>
<span class="normal"> 1840</span>
<span class="normal"> 1841</span>
<span class="normal"> 1842</span>
<span class="normal"> 1843</span>
<span class="normal"> 1844</span>
<span class="normal"> 1845</span>
<span class="normal"> 1846</span>
<span class="normal"> 1847</span>
<span class="normal"> 1848</span>
<span class="normal"> 1849</span>
<span class="normal"> 1850</span>
<span class="normal"> 1851</span>
<span class="normal"> 1852</span>
<span class="normal"> 1853</span>
<span class="normal"> 1854</span>
<span class="normal"> 1855</span>
<span class="normal"> 1856</span>
<span class="normal"> 1857</span>
<span class="normal"> 1858</span>
<span class="normal"> 1859</span>
<span class="normal"> 1860</span>
<span class="normal"> 1861</span>
<span class="normal"> 1862</span>
<span class="normal"> 1863</span>
<span class="normal"> 1864</span>
<span class="normal"> 1865</span>
<span class="normal"> 1866</span>
<span class="normal"> 1867</span>
<span class="normal"> 1868</span>
<span class="normal"> 1869</span>
<span class="normal"> 1870</span>
<span class="normal"> 1871</span>
<span class="normal"> 1872</span>
<span class="normal"> 1873</span>
<span class="normal"> 1874</span>
<span class="normal"> 1875</span>
<span class="normal"> 1876</span>
<span class="normal"> 1877</span>
<span class="normal"> 1878</span>
<span class="normal"> 1879</span>
<span class="normal"> 1880</span>
<span class="normal"> 1881</span>
<span class="normal"> 1882</span>
<span class="normal"> 1883</span>
<span class="normal"> 1884</span>
<span class="normal"> 1885</span>
<span class="normal"> 1886</span>
<span class="normal"> 1887</span>
<span class="normal"> 1888</span>
<span class="normal"> 1889</span>
<span class="normal"> 1890</span>
<span class="normal"> 1891</span>
<span class="normal"> 1892</span>
<span class="normal"> 1893</span>
<span class="normal"> 1894</span>
<span class="normal"> 1895</span>
<span class="normal"> 1896</span>
<span class="normal"> 1897</span>
<span class="normal"> 1898</span>
<span class="normal"> 1899</span>
<span class="normal"> 1900</span>
<span class="normal"> 1901</span>
<span class="normal"> 1902</span>
<span class="normal"> 1903</span>
<span class="normal"> 1904</span>
<span class="normal"> 1905</span>
<span class="normal"> 1906</span>
<span class="normal"> 1907</span>
<span class="normal"> 1908</span>
<span class="normal"> 1909</span>
<span class="normal"> 1910</span>
<span class="normal"> 1911</span>
<span class="normal"> 1912</span>
<span class="normal"> 1913</span>
<span class="normal"> 1914</span>
<span class="normal"> 1915</span>
<span class="normal"> 1916</span>
<span class="normal"> 1917</span>
<span class="normal"> 1918</span>
<span class="normal"> 1919</span>
<span class="normal"> 1920</span>
<span class="normal"> 1921</span>
<span class="normal"> 1922</span>
<span class="normal"> 1923</span>
<span class="normal"> 1924</span>
<span class="normal"> 1925</span>
<span class="normal"> 1926</span>
<span class="normal"> 1927</span>
<span class="normal"> 1928</span>
<span class="normal"> 1929</span>
<span class="normal"> 1930</span>
<span class="normal"> 1931</span>
<span class="normal"> 1932</span>
<span class="normal"> 1933</span>
<span class="normal"> 1934</span>
<span class="normal"> 1935</span>
<span class="normal"> 1936</span>
<span class="normal"> 1937</span>
<span class="normal"> 1938</span>
<span class="normal"> 1939</span>
<span class="normal"> 1940</span>
<span class="normal"> 1941</span>
<span class="normal"> 1942</span>
<span class="normal"> 1943</span>
<span class="normal"> 1944</span>
<span class="normal"> 1945</span>
<span class="normal"> 1946</span>
<span class="normal"> 1947</span>
<span class="normal"> 1948</span>
<span class="normal"> 1949</span>
<span class="normal"> 1950</span>
<span class="normal"> 1951</span>
<span class="normal"> 1952</span>
<span class="normal"> 1953</span>
<span class="normal"> 1954</span>
<span class="normal"> 1955</span>
<span class="normal"> 1956</span>
<span class="normal"> 1957</span>
<span class="normal"> 1958</span>
<span class="normal"> 1959</span>
<span class="normal"> 1960</span>
<span class="normal"> 1961</span>
<span class="normal"> 1962</span>
<span class="normal"> 1963</span>
<span class="normal"> 1964</span>
<span class="normal"> 1965</span>
<span class="normal"> 1966</span>
<span class="normal"> 1967</span>
<span class="normal"> 1968</span>
<span class="normal"> 1969</span>
<span class="normal"> 1970</span>
<span class="normal"> 1971</span>
<span class="normal"> 1972</span>
<span class="normal"> 1973</span>
<span class="normal"> 1974</span>
<span class="normal"> 1975</span>
<span class="normal"> 1976</span>
<span class="normal"> 1977</span>
<span class="normal"> 1978</span>
<span class="normal"> 1979</span>
<span class="normal"> 1980</span>
<span class="normal"> 1981</span>
<span class="normal"> 1982</span>
<span class="normal"> 1983</span>
<span class="normal"> 1984</span>
<span class="normal"> 1985</span>
<span class="normal"> 1986</span>
<span class="normal"> 1987</span>
<span class="normal"> 1988</span>
<span class="normal"> 1989</span>
<span class="normal"> 1990</span>
<span class="normal"> 1991</span>
<span class="normal"> 1992</span>
<span class="normal"> 1993</span>
<span class="normal"> 1994</span>
<span class="normal"> 1995</span>
<span class="normal"> 1996</span>
<span class="normal"> 1997</span>
<span class="normal"> 1998</span>
<span class="normal"> 1999</span>
<span class="normal"> 2000</span>
<span class="normal"> 2001</span>
<span class="normal"> 2002</span>
<span class="normal"> 2003</span>
<span class="normal"> 2004</span>
<span class="normal"> 2005</span>
<span class="normal"> 2006</span>
<span class="normal"> 2007</span>
<span class="normal"> 2008</span>
<span class="normal"> 2009</span>
<span class="normal"> 2010</span>
<span class="normal"> 2011</span>
<span class="normal"> 2012</span>
<span class="normal"> 2013</span>
<span class="normal"> 2014</span>
<span class="normal"> 2015</span>
<span class="normal"> 2016</span>
<span class="normal"> 2017</span>
<span class="normal"> 2018</span>
<span class="normal"> 2019</span>
<span class="normal"> 2020</span>
<span class="normal"> 2021</span>
<span class="normal"> 2022</span>
<span class="normal"> 2023</span>
<span class="normal"> 2024</span>
<span class="normal"> 2025</span>
<span class="normal"> 2026</span>
<span class="normal"> 2027</span>
<span class="normal"> 2028</span>
<span class="normal"> 2029</span>
<span class="normal"> 2030</span>
<span class="normal"> 2031</span>
<span class="normal"> 2032</span>
<span class="normal"> 2033</span>
<span class="normal"> 2034</span>
<span class="normal"> 2035</span>
<span class="normal"> 2036</span>
<span class="normal"> 2037</span>
<span class="normal"> 2038</span>
<span class="normal"> 2039</span>
<span class="normal"> 2040</span>
<span class="normal"> 2041</span>
<span class="normal"> 2042</span>
<span class="normal"> 2043</span>
<span class="normal"> 2044</span>
<span class="normal"> 2045</span>
<span class="normal"> 2046</span>
<span class="normal"> 2047</span>
<span class="normal"> 2048</span>
<span class="normal"> 2049</span>
<span class="normal"> 2050</span>
<span class="normal"> 2051</span>
<span class="normal"> 2052</span>
<span class="normal"> 2053</span>
<span class="normal"> 2054</span>
<span class="normal"> 2055</span>
<span class="normal"> 2056</span>
<span class="normal"> 2057</span>
<span class="normal"> 2058</span>
<span class="normal"> 2059</span>
<span class="normal"> 2060</span>
<span class="normal"> 2061</span>
<span class="normal"> 2062</span>
<span class="normal"> 2063</span>
<span class="normal"> 2064</span>
<span class="normal"> 2065</span>
<span class="normal"> 2066</span>
<span class="normal"> 2067</span>
<span class="normal"> 2068</span>
<span class="normal"> 2069</span>
<span class="normal"> 2070</span>
<span class="normal"> 2071</span>
<span class="normal"> 2072</span>
<span class="normal"> 2073</span>
<span class="normal"> 2074</span>
<span class="normal"> 2075</span>
<span class="normal"> 2076</span>
<span class="normal"> 2077</span>
<span class="normal"> 2078</span>
<span class="normal"> 2079</span>
<span class="normal"> 2080</span>
<span class="normal"> 2081</span>
<span class="normal"> 2082</span>
<span class="normal"> 2083</span>
<span class="normal"> 2084</span>
<span class="normal"> 2085</span>
<span class="normal"> 2086</span>
<span class="normal"> 2087</span>
<span class="normal"> 2088</span>
<span class="normal"> 2089</span>
<span class="normal"> 2090</span>
<span class="normal"> 2091</span>
<span class="normal"> 2092</span>
<span class="normal"> 2093</span>
<span class="normal"> 2094</span>
<span class="normal"> 2095</span>
<span class="normal"> 2096</span>
<span class="normal"> 2097</span>
<span class="normal"> 2098</span>
<span class="normal"> 2099</span>
<span class="normal"> 2100</span>
<span class="normal"> 2101</span>
<span class="normal"> 2102</span>
<span class="normal"> 2103</span>
<span class="normal"> 2104</span>
<span class="normal"> 2105</span>
<span class="normal"> 2106</span>
<span class="normal"> 2107</span>
<span class="normal"> 2108</span>
<span class="normal"> 2109</span>
<span class="normal"> 2110</span>
<span class="normal"> 2111</span>
<span class="normal"> 2112</span>
<span class="normal"> 2113</span>
<span class="normal"> 2114</span>
<span class="normal"> 2115</span>
<span class="normal"> 2116</span>
<span class="normal"> 2117</span>
<span class="normal"> 2118</span>
<span class="normal"> 2119</span>
<span class="normal"> 2120</span>
<span class="normal"> 2121</span>
<span class="normal"> 2122</span>
<span class="normal"> 2123</span>
<span class="normal"> 2124</span>
<span class="normal"> 2125</span>
<span class="normal"> 2126</span>
<span class="normal"> 2127</span>
<span class="normal"> 2128</span>
<span class="normal"> 2129</span>
<span class="normal"> 2130</span>
<span class="normal"> 2131</span>
<span class="normal"> 2132</span>
<span class="normal"> 2133</span>
<span class="normal"> 2134</span>
<span class="normal"> 2135</span>
<span class="normal"> 2136</span>
<span class="normal"> 2137</span>
<span class="normal"> 2138</span>
<span class="normal"> 2139</span>
<span class="normal"> 2140</span>
<span class="normal"> 2141</span>
<span class="normal"> 2142</span>
<span class="normal"> 2143</span>
<span class="normal"> 2144</span>
<span class="normal"> 2145</span>
<span class="normal"> 2146</span>
<span class="normal"> 2147</span>
<span class="normal"> 2148</span>
<span class="normal"> 2149</span>
<span class="normal"> 2150</span>
<span class="normal"> 2151</span>
<span class="normal"> 2152</span>
<span class="normal"> 2153</span>
<span class="normal"> 2154</span>
<span class="normal"> 2155</span>
<span class="normal"> 2156</span>
<span class="normal"> 2157</span>
<span class="normal"> 2158</span>
<span class="normal"> 2159</span>
<span class="normal"> 2160</span>
<span class="normal"> 2161</span>
<span class="normal"> 2162</span>
<span class="normal"> 2163</span>
<span class="normal"> 2164</span>
<span class="normal"> 2165</span>
<span class="normal"> 2166</span>
<span class="normal"> 2167</span>
<span class="normal"> 2168</span>
<span class="normal"> 2169</span>
<span class="normal"> 2170</span>
<span class="normal"> 2171</span>
<span class="normal"> 2172</span>
<span class="normal"> 2173</span>
<span class="normal"> 2174</span>
<span class="normal"> 2175</span>
<span class="normal"> 2176</span>
<span class="normal"> 2177</span>
<span class="normal"> 2178</span>
<span class="normal"> 2179</span>
<span class="normal"> 2180</span>
<span class="normal"> 2181</span>
<span class="normal"> 2182</span>
<span class="normal"> 2183</span>
<span class="normal"> 2184</span>
<span class="normal"> 2185</span>
<span class="normal"> 2186</span>
<span class="normal"> 2187</span>
<span class="normal"> 2188</span>
<span class="normal"> 2189</span>
<span class="normal"> 2190</span>
<span class="normal"> 2191</span>
<span class="normal"> 2192</span>
<span class="normal"> 2193</span>
<span class="normal"> 2194</span>
<span class="normal"> 2195</span>
<span class="normal"> 2196</span>
<span class="normal"> 2197</span>
<span class="normal"> 2198</span>
<span class="normal"> 2199</span>
<span class="normal"> 2200</span>
<span class="normal"> 2201</span>
<span class="normal"> 2202</span>
<span class="normal"> 2203</span>
<span class="normal"> 2204</span>
<span class="normal"> 2205</span>
<span class="normal"> 2206</span>
<span class="normal"> 2207</span>
<span class="normal"> 2208</span>
<span class="normal"> 2209</span>
<span class="normal"> 2210</span>
<span class="normal"> 2211</span>
<span class="normal"> 2212</span>
<span class="normal"> 2213</span>
<span class="normal"> 2214</span>
<span class="normal"> 2215</span>
<span class="normal"> 2216</span>
<span class="normal"> 2217</span>
<span class="normal"> 2218</span>
<span class="normal"> 2219</span>
<span class="normal"> 2220</span>
<span class="normal"> 2221</span>
<span class="normal"> 2222</span>
<span class="normal"> 2223</span>
<span class="normal"> 2224</span>
<span class="normal"> 2225</span>
<span class="normal"> 2226</span>
<span class="normal"> 2227</span>
<span class="normal"> 2228</span>
<span class="normal"> 2229</span>
<span class="normal"> 2230</span>
<span class="normal"> 2231</span>
<span class="normal"> 2232</span>
<span class="normal"> 2233</span>
<span class="normal"> 2234</span>
<span class="normal"> 2235</span>
<span class="normal"> 2236</span>
<span class="normal"> 2237</span>
<span class="normal"> 2238</span>
<span class="normal"> 2239</span>
<span class="normal"> 2240</span>
<span class="normal"> 2241</span>
<span class="normal"> 2242</span>
<span class="normal"> 2243</span>
<span class="normal"> 2244</span>
<span class="normal"> 2245</span>
<span class="normal"> 2246</span>
<span class="normal"> 2247</span>
<span class="normal"> 2248</span>
<span class="normal"> 2249</span>
<span class="normal"> 2250</span>
<span class="normal"> 2251</span>
<span class="normal"> 2252</span>
<span class="normal"> 2253</span>
<span class="normal"> 2254</span>
<span class="normal"> 2255</span>
<span class="normal"> 2256</span>
<span class="normal"> 2257</span>
<span class="normal"> 2258</span>
<span class="normal"> 2259</span>
<span class="normal"> 2260</span>
<span class="normal"> 2261</span>
<span class="normal"> 2262</span>
<span class="normal"> 2263</span>
<span class="normal"> 2264</span>
<span class="normal"> 2265</span>
<span class="normal"> 2266</span>
<span class="normal"> 2267</span>
<span class="normal"> 2268</span>
<span class="normal"> 2269</span>
<span class="normal"> 2270</span>
<span class="normal"> 2271</span>
<span class="normal"> 2272</span>
<span class="normal"> 2273</span>
<span class="normal"> 2274</span>
<span class="normal"> 2275</span>
<span class="normal"> 2276</span>
<span class="normal"> 2277</span>
<span class="normal"> 2278</span>
<span class="normal"> 2279</span>
<span class="normal"> 2280</span>
<span class="normal"> 2281</span>
<span class="normal"> 2282</span>
<span class="normal"> 2283</span>
<span class="normal"> 2284</span>
<span class="normal"> 2285</span>
<span class="normal"> 2286</span>
<span class="normal"> 2287</span>
<span class="normal"> 2288</span>
<span class="normal"> 2289</span>
<span class="normal"> 2290</span>
<span class="normal"> 2291</span>
<span class="normal"> 2292</span>
<span class="normal"> 2293</span>
<span class="normal"> 2294</span>
<span class="normal"> 2295</span>
<span class="normal"> 2296</span>
<span class="normal"> 2297</span>
<span class="normal"> 2298</span>
<span class="normal"> 2299</span>
<span class="normal"> 2300</span>
<span class="normal"> 2301</span>
<span class="normal"> 2302</span>
<span class="normal"> 2303</span>
<span class="normal"> 2304</span>
<span class="normal"> 2305</span>
<span class="normal"> 2306</span>
<span class="normal"> 2307</span>
<span class="normal"> 2308</span>
<span class="normal"> 2309</span>
<span class="normal"> 2310</span>
<span class="normal"> 2311</span>
<span class="normal"> 2312</span>
<span class="normal"> 2313</span>
<span class="normal"> 2314</span>
<span class="normal"> 2315</span>
<span class="normal"> 2316</span>
<span class="normal"> 2317</span>
<span class="normal"> 2318</span>
<span class="normal"> 2319</span>
<span class="normal"> 2320</span>
<span class="normal"> 2321</span>
<span class="normal"> 2322</span>
<span class="normal"> 2323</span>
<span class="normal"> 2324</span>
<span class="normal"> 2325</span>
<span class="normal"> 2326</span>
<span class="normal"> 2327</span>
<span class="normal"> 2328</span>
<span class="normal"> 2329</span>
<span class="normal"> 2330</span>
<span class="normal"> 2331</span>
<span class="normal"> 2332</span>
<span class="normal"> 2333</span>
<span class="normal"> 2334</span>
<span class="normal"> 2335</span>
<span class="normal"> 2336</span>
<span class="normal"> 2337</span>
<span class="normal"> 2338</span>
<span class="normal"> 2339</span>
<span class="normal"> 2340</span>
<span class="normal"> 2341</span>
<span class="normal"> 2342</span>
<span class="normal"> 2343</span>
<span class="normal"> 2344</span>
<span class="normal"> 2345</span>
<span class="normal"> 2346</span>
<span class="normal"> 2347</span>
<span class="normal"> 2348</span>
<span class="normal"> 2349</span>
<span class="normal"> 2350</span>
<span class="normal"> 2351</span>
<span class="normal"> 2352</span>
<span class="normal"> 2353</span>
<span class="normal"> 2354</span>
<span class="normal"> 2355</span>
<span class="normal"> 2356</span>
<span class="normal"> 2357</span>
<span class="normal"> 2358</span>
<span class="normal"> 2359</span>
<span class="normal"> 2360</span>
<span class="normal"> 2361</span>
<span class="normal"> 2362</span>
<span class="normal"> 2363</span>
<span class="normal"> 2364</span>
<span class="normal"> 2365</span>
<span class="normal"> 2366</span>
<span class="normal"> 2367</span>
<span class="normal"> 2368</span>
<span class="normal"> 2369</span>
<span class="normal"> 2370</span>
<span class="normal"> 2371</span>
<span class="normal"> 2372</span>
<span class="normal"> 2373</span>
<span class="normal"> 2374</span>
<span class="normal"> 2375</span>
<span class="normal"> 2376</span>
<span class="normal"> 2377</span>
<span class="normal"> 2378</span>
<span class="normal"> 2379</span>
<span class="normal"> 2380</span>
<span class="normal"> 2381</span>
<span class="normal"> 2382</span>
<span class="normal"> 2383</span>
<span class="normal"> 2384</span>
<span class="normal"> 2385</span>
<span class="normal"> 2386</span>
<span class="normal"> 2387</span>
<span class="normal"> 2388</span>
<span class="normal"> 2389</span>
<span class="normal"> 2390</span>
<span class="normal"> 2391</span>
<span class="normal"> 2392</span>
<span class="normal"> 2393</span>
<span class="normal"> 2394</span>
<span class="normal"> 2395</span>
<span class="normal"> 2396</span>
<span class="normal"> 2397</span>
<span class="normal"> 2398</span>
<span class="normal"> 2399</span>
<span class="normal"> 2400</span>
<span class="normal"> 2401</span>
<span class="normal"> 2402</span>
<span class="normal"> 2403</span>
<span class="normal"> 2404</span>
<span class="normal"> 2405</span>
<span class="normal"> 2406</span>
<span class="normal"> 2407</span>
<span class="normal"> 2408</span>
<span class="normal"> 2409</span>
<span class="normal"> 2410</span>
<span class="normal"> 2411</span>
<span class="normal"> 2412</span>
<span class="normal"> 2413</span>
<span class="normal"> 2414</span>
<span class="normal"> 2415</span>
<span class="normal"> 2416</span>
<span class="normal"> 2417</span>
<span class="normal"> 2418</span>
<span class="normal"> 2419</span>
<span class="normal"> 2420</span>
<span class="normal"> 2421</span>
<span class="normal"> 2422</span>
<span class="normal"> 2423</span>
<span class="normal"> 2424</span>
<span class="normal"> 2425</span>
<span class="normal"> 2426</span>
<span class="normal"> 2427</span>
<span class="normal"> 2428</span>
<span class="normal"> 2429</span>
<span class="normal"> 2430</span>
<span class="normal"> 2431</span>
<span class="normal"> 2432</span>
<span class="normal"> 2433</span>
<span class="normal"> 2434</span>
<span class="normal"> 2435</span>
<span class="normal"> 2436</span>
<span class="normal"> 2437</span>
<span class="normal"> 2438</span>
<span class="normal"> 2439</span>
<span class="normal"> 2440</span>
<span class="normal"> 2441</span>
<span class="normal"> 2442</span>
<span class="normal"> 2443</span>
<span class="normal"> 2444</span>
<span class="normal"> 2445</span>
<span class="normal"> 2446</span>
<span class="normal"> 2447</span>
<span class="normal"> 2448</span>
<span class="normal"> 2449</span>
<span class="normal"> 2450</span>
<span class="normal"> 2451</span>
<span class="normal"> 2452</span>
<span class="normal"> 2453</span>
<span class="normal"> 2454</span>
<span class="normal"> 2455</span>
<span class="normal"> 2456</span>
<span class="normal"> 2457</span>
<span class="normal"> 2458</span>
<span class="normal"> 2459</span>
<span class="normal"> 2460</span>
<span class="normal"> 2461</span>
<span class="normal"> 2462</span>
<span class="normal"> 2463</span>
<span class="normal"> 2464</span>
<span class="normal"> 2465</span>
<span class="normal"> 2466</span>
<span class="normal"> 2467</span>
<span class="normal"> 2468</span>
<span class="normal"> 2469</span>
<span class="normal"> 2470</span>
<span class="normal"> 2471</span>
<span class="normal"> 2472</span>
<span class="normal"> 2473</span>
<span class="normal"> 2474</span>
<span class="normal"> 2475</span>
<span class="normal"> 2476</span>
<span class="normal"> 2477</span>
<span class="normal"> 2478</span>
<span class="normal"> 2479</span>
<span class="normal"> 2480</span>
<span class="normal"> 2481</span>
<span class="normal"> 2482</span>
<span class="normal"> 2483</span>
<span class="normal"> 2484</span>
<span class="normal"> 2485</span>
<span class="normal"> 2486</span>
<span class="normal"> 2487</span>
<span class="normal"> 2488</span>
<span class="normal"> 2489</span>
<span class="normal"> 2490</span>
<span class="normal"> 2491</span>
<span class="normal"> 2492</span>
<span class="normal"> 2493</span>
<span class="normal"> 2494</span>
<span class="normal"> 2495</span>
<span class="normal"> 2496</span>
<span class="normal"> 2497</span>
<span class="normal"> 2498</span>
<span class="normal"> 2499</span>
<span class="normal"> 2500</span>
<span class="normal"> 2501</span>
<span class="normal"> 2502</span>
<span class="normal"> 2503</span>
<span class="normal"> 2504</span>
<span class="normal"> 2505</span>
<span class="normal"> 2506</span>
<span class="normal"> 2507</span>
<span class="normal"> 2508</span>
<span class="normal"> 2509</span>
<span class="normal"> 2510</span>
<span class="normal"> 2511</span>
<span class="normal"> 2512</span>
<span class="normal"> 2513</span>
<span class="normal"> 2514</span>
<span class="normal"> 2515</span>
<span class="normal"> 2516</span>
<span class="normal"> 2517</span>
<span class="normal"> 2518</span>
<span class="normal"> 2519</span>
<span class="normal"> 2520</span>
<span class="normal"> 2521</span>
<span class="normal"> 2522</span>
<span class="normal"> 2523</span>
<span class="normal"> 2524</span>
<span class="normal"> 2525</span>
<span class="normal"> 2526</span>
<span class="normal"> 2527</span>
<span class="normal"> 2528</span>
<span class="normal"> 2529</span>
<span class="normal"> 2530</span>
<span class="normal"> 2531</span>
<span class="normal"> 2532</span>
<span class="normal"> 2533</span>
<span class="normal"> 2534</span>
<span class="normal"> 2535</span>
<span class="normal"> 2536</span>
<span class="normal"> 2537</span>
<span class="normal"> 2538</span>
<span class="normal"> 2539</span>
<span class="normal"> 2540</span>
<span class="normal"> 2541</span>
<span class="normal"> 2542</span>
<span class="normal"> 2543</span>
<span class="normal"> 2544</span>
<span class="normal"> 2545</span>
<span class="normal"> 2546</span>
<span class="normal"> 2547</span>
<span class="normal"> 2548</span>
<span class="normal"> 2549</span>
<span class="normal"> 2550</span>
<span class="normal"> 2551</span>
<span class="normal"> 2552</span>
<span class="normal"> 2553</span>
<span class="normal"> 2554</span>
<span class="normal"> 2555</span>
<span class="normal"> 2556</span>
<span class="normal"> 2557</span>
<span class="normal"> 2558</span>
<span class="normal"> 2559</span>
<span class="normal"> 2560</span>
<span class="normal"> 2561</span>
<span class="normal"> 2562</span>
<span class="normal"> 2563</span>
<span class="normal"> 2564</span>
<span class="normal"> 2565</span>
<span class="normal"> 2566</span>
<span class="normal"> 2567</span>
<span class="normal"> 2568</span>
<span class="normal"> 2569</span>
<span class="normal"> 2570</span>
<span class="normal"> 2571</span>
<span class="normal"> 2572</span>
<span class="normal"> 2573</span>
<span class="normal"> 2574</span>
<span class="normal"> 2575</span>
<span class="normal"> 2576</span>
<span class="normal"> 2577</span>
<span class="normal"> 2578</span>
<span class="normal"> 2579</span>
<span class="normal"> 2580</span>
<span class="normal"> 2581</span>
<span class="normal"> 2582</span>
<span class="normal"> 2583</span>
<span class="normal"> 2584</span>
<span class="normal"> 2585</span>
<span class="normal"> 2586</span>
<span class="normal"> 2587</span>
<span class="normal"> 2588</span>
<span class="normal"> 2589</span>
<span class="normal"> 2590</span>
<span class="normal"> 2591</span>
<span class="normal"> 2592</span>
<span class="normal"> 2593</span>
<span class="normal"> 2594</span>
<span class="normal"> 2595</span>
<span class="normal"> 2596</span>
<span class="normal"> 2597</span>
<span class="normal"> 2598</span>
<span class="normal"> 2599</span>
<span class="normal"> 2600</span>
<span class="normal"> 2601</span>
<span class="normal"> 2602</span>
<span class="normal"> 2603</span>
<span class="normal"> 2604</span>
<span class="normal"> 2605</span>
<span class="normal"> 2606</span>
<span class="normal"> 2607</span>
<span class="normal"> 2608</span>
<span class="normal"> 2609</span>
<span class="normal"> 2610</span>
<span class="normal"> 2611</span>
<span class="normal"> 2612</span>
<span class="normal"> 2613</span>
<span class="normal"> 2614</span>
<span class="normal"> 2615</span>
<span class="normal"> 2616</span>
<span class="normal"> 2617</span>
<span class="normal"> 2618</span>
<span class="normal"> 2619</span>
<span class="normal"> 2620</span>
<span class="normal"> 2621</span>
<span class="normal"> 2622</span>
<span class="normal"> 2623</span>
<span class="normal"> 2624</span>
<span class="normal"> 2625</span>
<span class="normal"> 2626</span>
<span class="normal"> 2627</span>
<span class="normal"> 2628</span>
<span class="normal"> 2629</span>
<span class="normal"> 2630</span>
<span class="normal"> 2631</span>
<span class="normal"> 2632</span>
<span class="normal"> 2633</span>
<span class="normal"> 2634</span>
<span class="normal"> 2635</span>
<span class="normal"> 2636</span>
<span class="normal"> 2637</span>
<span class="normal"> 2638</span>
<span class="normal"> 2639</span>
<span class="normal"> 2640</span>
<span class="normal"> 2641</span>
<span class="normal"> 2642</span>
<span class="normal"> 2643</span>
<span class="normal"> 2644</span>
<span class="normal"> 2645</span>
<span class="normal"> 2646</span>
<span class="normal"> 2647</span>
<span class="normal"> 2648</span>
<span class="normal"> 2649</span>
<span class="normal"> 2650</span>
<span class="normal"> 2651</span>
<span class="normal"> 2652</span>
<span class="normal"> 2653</span>
<span class="normal"> 2654</span>
<span class="normal"> 2655</span>
<span class="normal"> 2656</span>
<span class="normal"> 2657</span>
<span class="normal"> 2658</span>
<span class="normal"> 2659</span>
<span class="normal"> 2660</span>
<span class="normal"> 2661</span>
<span class="normal"> 2662</span>
<span class="normal"> 2663</span>
<span class="normal"> 2664</span>
<span class="normal"> 2665</span>
<span class="normal"> 2666</span>
<span class="normal"> 2667</span>
<span class="normal"> 2668</span>
<span class="normal"> 2669</span>
<span class="normal"> 2670</span>
<span class="normal"> 2671</span>
<span class="normal"> 2672</span>
<span class="normal"> 2673</span>
<span class="normal"> 2674</span>
<span class="normal"> 2675</span>
<span class="normal"> 2676</span>
<span class="normal"> 2677</span>
<span class="normal"> 2678</span>
<span class="normal"> 2679</span>
<span class="normal"> 2680</span>
<span class="normal"> 2681</span>
<span class="normal"> 2682</span>
<span class="normal"> 2683</span>
<span class="normal"> 2684</span>
<span class="normal"> 2685</span>
<span class="normal"> 2686</span>
<span class="normal"> 2687</span>
<span class="normal"> 2688</span>
<span class="normal"> 2689</span>
<span class="normal"> 2690</span>
<span class="normal"> 2691</span>
<span class="normal"> 2692</span>
<span class="normal"> 2693</span>
<span class="normal"> 2694</span>
<span class="normal"> 2695</span>
<span class="normal"> 2696</span>
<span class="normal"> 2697</span>
<span class="normal"> 2698</span>
<span class="normal"> 2699</span>
<span class="normal"> 2700</span>
<span class="normal"> 2701</span>
<span class="normal"> 2702</span>
<span class="normal"> 2703</span>
<span class="normal"> 2704</span>
<span class="normal"> 2705</span>
<span class="normal"> 2706</span>
<span class="normal"> 2707</span>
<span class="normal"> 2708</span>
<span class="normal"> 2709</span>
<span class="normal"> 2710</span>
<span class="normal"> 2711</span>
<span class="normal"> 2712</span>
<span class="normal"> 2713</span>
<span class="normal"> 2714</span>
<span class="normal"> 2715</span>
<span class="normal"> 2716</span>
<span class="normal"> 2717</span>
<span class="normal"> 2718</span>
<span class="normal"> 2719</span>
<span class="normal"> 2720</span>
<span class="normal"> 2721</span>
<span class="normal"> 2722</span>
<span class="normal"> 2723</span>
<span class="normal"> 2724</span>
<span class="normal"> 2725</span>
<span class="normal"> 2726</span>
<span class="normal"> 2727</span>
<span class="normal"> 2728</span>
<span class="normal"> 2729</span>
<span class="normal"> 2730</span>
<span class="normal"> 2731</span>
<span class="normal"> 2732</span>
<span class="normal"> 2733</span>
<span class="normal"> 2734</span>
<span class="normal"> 2735</span>
<span class="normal"> 2736</span>
<span class="normal"> 2737</span>
<span class="normal"> 2738</span>
<span class="normal"> 2739</span>
<span class="normal"> 2740</span>
<span class="normal"> 2741</span>
<span class="normal"> 2742</span>
<span class="normal"> 2743</span>
<span class="normal"> 2744</span>
<span class="normal"> 2745</span>
<span class="normal"> 2746</span>
<span class="normal"> 2747</span>
<span class="normal"> 2748</span>
<span class="normal"> 2749</span>
<span class="normal"> 2750</span>
<span class="normal"> 2751</span>
<span class="normal"> 2752</span>
<span class="normal"> 2753</span>
<span class="normal"> 2754</span>
<span class="normal"> 2755</span>
<span class="normal"> 2756</span>
<span class="normal"> 2757</span>
<span class="normal"> 2758</span>
<span class="normal"> 2759</span>
<span class="normal"> 2760</span>
<span class="normal"> 2761</span>
<span class="normal"> 2762</span>
<span class="normal"> 2763</span>
<span class="normal"> 2764</span>
<span class="normal"> 2765</span>
<span class="normal"> 2766</span>
<span class="normal"> 2767</span>
<span class="normal"> 2768</span>
<span class="normal"> 2769</span>
<span class="normal"> 2770</span>
<span class="normal"> 2771</span>
<span class="normal"> 2772</span>
<span class="normal"> 2773</span>
<span class="normal"> 2774</span>
<span class="normal"> 2775</span>
<span class="normal"> 2776</span>
<span class="normal"> 2777</span>
<span class="normal"> 2778</span>
<span class="normal"> 2779</span>
<span class="normal"> 2780</span>
<span class="normal"> 2781</span>
<span class="normal"> 2782</span>
<span class="normal"> 2783</span>
<span class="normal"> 2784</span>
<span class="normal"> 2785</span>
<span class="normal"> 2786</span>
<span class="normal"> 2787</span>
<span class="normal"> 2788</span>
<span class="normal"> 2789</span>
<span class="normal"> 2790</span>
<span class="normal"> 2791</span>
<span class="normal"> 2792</span>
<span class="normal"> 2793</span>
<span class="normal"> 2794</span>
<span class="normal"> 2795</span>
<span class="normal"> 2796</span>
<span class="normal"> 2797</span>
<span class="normal"> 2798</span>
<span class="normal"> 2799</span>
<span class="normal"> 2800</span>
<span class="normal"> 2801</span>
<span class="normal"> 2802</span>
<span class="normal"> 2803</span>
<span class="normal"> 2804</span>
<span class="normal"> 2805</span>
<span class="normal"> 2806</span>
<span class="normal"> 2807</span>
<span class="normal"> 2808</span>
<span class="normal"> 2809</span>
<span class="normal"> 2810</span>
<span class="normal"> 2811</span>
<span class="normal"> 2812</span>
<span class="normal"> 2813</span>
<span class="normal"> 2814</span>
<span class="normal"> 2815</span>
<span class="normal"> 2816</span>
<span class="normal"> 2817</span>
<span class="normal"> 2818</span>
<span class="normal"> 2819</span>
<span class="normal"> 2820</span>
<span class="normal"> 2821</span>
<span class="normal"> 2822</span>
<span class="normal"> 2823</span>
<span class="normal"> 2824</span>
<span class="normal"> 2825</span>
<span class="normal"> 2826</span>
<span class="normal"> 2827</span>
<span class="normal"> 2828</span>
<span class="normal"> 2829</span>
<span class="normal"> 2830</span>
<span class="normal"> 2831</span>
<span class="normal"> 2832</span>
<span class="normal"> 2833</span>
<span class="normal"> 2834</span>
<span class="normal"> 2835</span>
<span class="normal"> 2836</span>
<span class="normal"> 2837</span>
<span class="normal"> 2838</span>
<span class="normal"> 2839</span>
<span class="normal"> 2840</span>
<span class="normal"> 2841</span>
<span class="normal"> 2842</span>
<span class="normal"> 2843</span>
<span class="normal"> 2844</span>
<span class="normal"> 2845</span>
<span class="normal"> 2846</span>
<span class="normal"> 2847</span>
<span class="normal"> 2848</span>
<span class="normal"> 2849</span>
<span class="normal"> 2850</span>
<span class="normal"> 2851</span>
<span class="normal"> 2852</span>
<span class="normal"> 2853</span>
<span class="normal"> 2854</span>
<span class="normal"> 2855</span>
<span class="normal"> 2856</span>
<span class="normal"> 2857</span>
<span class="normal"> 2858</span>
<span class="normal"> 2859</span>
<span class="normal"> 2860</span>
<span class="normal"> 2861</span>
<span class="normal"> 2862</span>
<span class="normal"> 2863</span>
<span class="normal"> 2864</span>
<span class="normal"> 2865</span>
<span class="normal"> 2866</span>
<span class="normal"> 2867</span>
<span class="normal"> 2868</span>
<span class="normal"> 2869</span>
<span class="normal"> 2870</span>
<span class="normal"> 2871</span>
<span class="normal"> 2872</span>
<span class="normal"> 2873</span>
<span class="normal"> 2874</span>
<span class="normal"> 2875</span>
<span class="normal"> 2876</span>
<span class="normal"> 2877</span>
<span class="normal"> 2878</span>
<span class="normal"> 2879</span>
<span class="normal"> 2880</span>
<span class="normal"> 2881</span>
<span class="normal"> 2882</span>
<span class="normal"> 2883</span>
<span class="normal"> 2884</span>
<span class="normal"> 2885</span>
<span class="normal"> 2886</span>
<span class="normal"> 2887</span>
<span class="normal"> 2888</span>
<span class="normal"> 2889</span>
<span class="normal"> 2890</span>
<span class="normal"> 2891</span>
<span class="normal"> 2892</span>
<span class="normal"> 2893</span>
<span class="normal"> 2894</span>
<span class="normal"> 2895</span>
<span class="normal"> 2896</span>
<span class="normal"> 2897</span>
<span class="normal"> 2898</span>
<span class="normal"> 2899</span>
<span class="normal"> 2900</span>
<span class="normal"> 2901</span>
<span class="normal"> 2902</span>
<span class="normal"> 2903</span>
<span class="normal"> 2904</span>
<span class="normal"> 2905</span>
<span class="normal"> 2906</span>
<span class="normal"> 2907</span>
<span class="normal"> 2908</span>
<span class="normal"> 2909</span>
<span class="normal"> 2910</span>
<span class="normal"> 2911</span>
<span class="normal"> 2912</span>
<span class="normal"> 2913</span>
<span class="normal"> 2914</span>
<span class="normal"> 2915</span>
<span class="normal"> 2916</span>
<span class="normal"> 2917</span>
<span class="normal"> 2918</span>
<span class="normal"> 2919</span>
<span class="normal"> 2920</span>
<span class="normal"> 2921</span>
<span class="normal"> 2922</span>
<span class="normal"> 2923</span>
<span class="normal"> 2924</span>
<span class="normal"> 2925</span>
<span class="normal"> 2926</span>
<span class="normal"> 2927</span>
<span class="normal"> 2928</span>
<span class="normal"> 2929</span>
<span class="normal"> 2930</span>
<span class="normal"> 2931</span>
<span class="normal"> 2932</span>
<span class="normal"> 2933</span>
<span class="normal"> 2934</span>
<span class="normal"> 2935</span>
<span class="normal"> 2936</span>
<span class="normal"> 2937</span>
<span class="normal"> 2938</span>
<span class="normal"> 2939</span>
<span class="normal"> 2940</span>
<span class="normal"> 2941</span>
<span class="normal"> 2942</span>
<span class="normal"> 2943</span>
<span class="normal"> 2944</span>
<span class="normal"> 2945</span>
<span class="normal"> 2946</span>
<span class="normal"> 2947</span>
<span class="normal"> 2948</span>
<span class="normal"> 2949</span>
<span class="normal"> 2950</span>
<span class="normal"> 2951</span>
<span class="normal"> 2952</span>
<span class="normal"> 2953</span>
<span class="normal"> 2954</span>
<span class="normal"> 2955</span>
<span class="normal"> 2956</span>
<span class="normal"> 2957</span>
<span class="normal"> 2958</span>
<span class="normal"> 2959</span>
<span class="normal"> 2960</span>
<span class="normal"> 2961</span>
<span class="normal"> 2962</span>
<span class="normal"> 2963</span>
<span class="normal"> 2964</span>
<span class="normal"> 2965</span>
<span class="normal"> 2966</span>
<span class="normal"> 2967</span>
<span class="normal"> 2968</span>
<span class="normal"> 2969</span>
<span class="normal"> 2970</span>
<span class="normal"> 2971</span>
<span class="normal"> 2972</span>
<span class="normal"> 2973</span>
<span class="normal"> 2974</span>
<span class="normal"> 2975</span>
<span class="normal"> 2976</span>
<span class="normal"> 2977</span>
<span class="normal"> 2978</span>
<span class="normal"> 2979</span>
<span class="normal"> 2980</span>
<span class="normal"> 2981</span>
<span class="normal"> 2982</span>
<span class="normal"> 2983</span>
<span class="normal"> 2984</span>
<span class="normal"> 2985</span>
<span class="normal"> 2986</span>
<span class="normal"> 2987</span>
<span class="normal"> 2988</span>
<span class="normal"> 2989</span>
<span class="normal"> 2990</span>
<span class="normal"> 2991</span>
<span class="normal"> 2992</span>
<span class="normal"> 2993</span>
<span class="normal"> 2994</span>
<span class="normal"> 2995</span>
<span class="normal"> 2996</span>
<span class="normal"> 2997</span>
<span class="normal"> 2998</span>
<span class="normal"> 2999</span>
<span class="normal"> 3000</span>
<span class="normal"> 3001</span>
<span class="normal"> 3002</span>
<span class="normal"> 3003</span>
<span class="normal"> 3004</span>
<span class="normal"> 3005</span>
<span class="normal"> 3006</span>
<span class="normal"> 3007</span>
<span class="normal"> 3008</span>
<span class="normal"> 3009</span>
<span class="normal"> 3010</span>
<span class="normal"> 3011</span>
<span class="normal"> 3012</span>
<span class="normal"> 3013</span>
<span class="normal"> 3014</span>
<span class="normal"> 3015</span>
<span class="normal"> 3016</span>
<span class="normal"> 3017</span>
<span class="normal"> 3018</span>
<span class="normal"> 3019</span>
<span class="normal"> 3020</span>
<span class="normal"> 3021</span>
<span class="normal"> 3022</span>
<span class="normal"> 3023</span>
<span class="normal"> 3024</span>
<span class="normal"> 3025</span>
<span class="normal"> 3026</span>
<span class="normal"> 3027</span>
<span class="normal"> 3028</span>
<span class="normal"> 3029</span>
<span class="normal"> 3030</span>
<span class="normal"> 3031</span>
<span class="normal"> 3032</span>
<span class="normal"> 3033</span>
<span class="normal"> 3034</span>
<span class="normal"> 3035</span>
<span class="normal"> 3036</span>
<span class="normal"> 3037</span>
<span class="normal"> 3038</span>
<span class="normal"> 3039</span>
<span class="normal"> 3040</span>
<span class="normal"> 3041</span>
<span class="normal"> 3042</span>
<span class="normal"> 3043</span>
<span class="normal"> 3044</span>
<span class="normal"> 3045</span>
<span class="normal"> 3046</span>
<span class="normal"> 3047</span>
<span class="normal"> 3048</span>
<span class="normal"> 3049</span>
<span class="normal"> 3050</span>
<span class="normal"> 3051</span>
<span class="normal"> 3052</span>
<span class="normal"> 3053</span>
<span class="normal"> 3054</span>
<span class="normal"> 3055</span>
<span class="normal"> 3056</span>
<span class="normal"> 3057</span>
<span class="normal"> 3058</span>
<span class="normal"> 3059</span>
<span class="normal"> 3060</span>
<span class="normal"> 3061</span>
<span class="normal"> 3062</span>
<span class="normal"> 3063</span>
<span class="normal"> 3064</span>
<span class="normal"> 3065</span>
<span class="normal"> 3066</span>
<span class="normal"> 3067</span>
<span class="normal"> 3068</span>
<span class="normal"> 3069</span>
<span class="normal"> 3070</span>
<span class="normal"> 3071</span>
<span class="normal"> 3072</span>
<span class="normal"> 3073</span>
<span class="normal"> 3074</span>
<span class="normal"> 3075</span>
<span class="normal"> 3076</span>
<span class="normal"> 3077</span>
<span class="normal"> 3078</span>
<span class="normal"> 3079</span>
<span class="normal"> 3080</span>
<span class="normal"> 3081</span>
<span class="normal"> 3082</span>
<span class="normal"> 3083</span>
<span class="normal"> 3084</span>
<span class="normal"> 3085</span>
<span class="normal"> 3086</span>
<span class="normal"> 3087</span>
<span class="normal"> 3088</span>
<span class="normal"> 3089</span>
<span class="normal"> 3090</span>
<span class="normal"> 3091</span>
<span class="normal"> 3092</span>
<span class="normal"> 3093</span>
<span class="normal"> 3094</span>
<span class="normal"> 3095</span>
<span class="normal"> 3096</span>
<span class="normal"> 3097</span>
<span class="normal"> 3098</span>
<span class="normal"> 3099</span>
<span class="normal"> 3100</span>
<span class="normal"> 3101</span>
<span class="normal"> 3102</span>
<span class="normal"> 3103</span>
<span class="normal"> 3104</span>
<span class="normal"> 3105</span>
<span class="normal"> 3106</span>
<span class="normal"> 3107</span>
<span class="normal"> 3108</span>
<span class="normal"> 3109</span>
<span class="normal"> 3110</span>
<span class="normal"> 3111</span>
<span class="normal"> 3112</span>
<span class="normal"> 3113</span>
<span class="normal"> 3114</span>
<span class="normal"> 3115</span>
<span class="normal"> 3116</span>
<span class="normal"> 3117</span>
<span class="normal"> 3118</span>
<span class="normal"> 3119</span>
<span class="normal"> 3120</span>
<span class="normal"> 3121</span>
<span class="normal"> 3122</span>
<span class="normal"> 3123</span>
<span class="normal"> 3124</span>
<span class="normal"> 3125</span>
<span class="normal"> 3126</span>
<span class="normal"> 3127</span>
<span class="normal"> 3128</span>
<span class="normal"> 3129</span>
<span class="normal"> 3130</span>
<span class="normal"> 3131</span>
<span class="normal"> 3132</span>
<span class="normal"> 3133</span>
<span class="normal"> 3134</span>
<span class="normal"> 3135</span>
<span class="normal"> 3136</span>
<span class="normal"> 3137</span>
<span class="normal"> 3138</span>
<span class="normal"> 3139</span>
<span class="normal"> 3140</span>
<span class="normal"> 3141</span>
<span class="normal"> 3142</span>
<span class="normal"> 3143</span>
<span class="normal"> 3144</span>
<span class="normal"> 3145</span>
<span class="normal"> 3146</span>
<span class="normal"> 3147</span>
<span class="normal"> 3148</span>
<span class="normal"> 3149</span>
<span class="normal"> 3150</span>
<span class="normal"> 3151</span>
<span class="normal"> 3152</span>
<span class="normal"> 3153</span>
<span class="normal"> 3154</span>
<span class="normal"> 3155</span>
<span class="normal"> 3156</span>
<span class="normal"> 3157</span>
<span class="normal"> 3158</span>
<span class="normal"> 3159</span>
<span class="normal"> 3160</span>
<span class="normal"> 3161</span>
<span class="normal"> 3162</span>
<span class="normal"> 3163</span>
<span class="normal"> 3164</span>
<span class="normal"> 3165</span>
<span class="normal"> 3166</span>
<span class="normal"> 3167</span>
<span class="normal"> 3168</span>
<span class="normal"> 3169</span>
<span class="normal"> 3170</span>
<span class="normal"> 3171</span>
<span class="normal"> 3172</span>
<span class="normal"> 3173</span>
<span class="normal"> 3174</span>
<span class="normal"> 3175</span>
<span class="normal"> 3176</span>
<span class="normal"> 3177</span>
<span class="normal"> 3178</span>
<span class="normal"> 3179</span>
<span class="normal"> 3180</span>
<span class="normal"> 3181</span>
<span class="normal"> 3182</span>
<span class="normal"> 3183</span>
<span class="normal"> 3184</span>
<span class="normal"> 3185</span>
<span class="normal"> 3186</span>
<span class="normal"> 3187</span>
<span class="normal"> 3188</span>
<span class="normal"> 3189</span>
<span class="normal"> 3190</span>
<span class="normal"> 3191</span>
<span class="normal"> 3192</span>
<span class="normal"> 3193</span>
<span class="normal"> 3194</span>
<span class="normal"> 3195</span>
<span class="normal"> 3196</span>
<span class="normal"> 3197</span>
<span class="normal"> 3198</span>
<span class="normal"> 3199</span>
<span class="normal"> 3200</span>
<span class="normal"> 3201</span>
<span class="normal"> 3202</span>
<span class="normal"> 3203</span>
<span class="normal"> 3204</span>
<span class="normal"> 3205</span>
<span class="normal"> 3206</span>
<span class="normal"> 3207</span>
<span class="normal"> 3208</span>
<span class="normal"> 3209</span>
<span class="normal"> 3210</span>
<span class="normal"> 3211</span>
<span class="normal"> 3212</span>
<span class="normal"> 3213</span>
<span class="normal"> 3214</span>
<span class="normal"> 3215</span>
<span class="normal"> 3216</span>
<span class="normal"> 3217</span>
<span class="normal"> 3218</span>
<span class="normal"> 3219</span>
<span class="normal"> 3220</span>
<span class="normal"> 3221</span>
<span class="normal"> 3222</span>
<span class="normal"> 3223</span>
<span class="normal"> 3224</span>
<span class="normal"> 3225</span>
<span class="normal"> 3226</span>
<span class="normal"> 3227</span>
<span class="normal"> 3228</span>
<span class="normal"> 3229</span>
<span class="normal"> 3230</span>
<span class="normal"> 3231</span>
<span class="normal"> 3232</span>
<span class="normal"> 3233</span>
<span class="normal"> 3234</span>
<span class="normal"> 3235</span>
<span class="normal"> 3236</span>
<span class="normal"> 3237</span>
<span class="normal"> 3238</span>
<span class="normal"> 3239</span>
<span class="normal"> 3240</span>
<span class="normal"> 3241</span>
<span class="normal"> 3242</span>
<span class="normal"> 3243</span>
<span class="normal"> 3244</span>
<span class="normal"> 3245</span>
<span class="normal"> 3246</span>
<span class="normal"> 3247</span>
<span class="normal"> 3248</span>
<span class="normal"> 3249</span>
<span class="normal"> 3250</span>
<span class="normal"> 3251</span>
<span class="normal"> 3252</span>
<span class="normal"> 3253</span>
<span class="normal"> 3254</span>
<span class="normal"> 3255</span>
<span class="normal"> 3256</span>
<span class="normal"> 3257</span>
<span class="normal"> 3258</span>
<span class="normal"> 3259</span>
<span class="normal"> 3260</span>
<span class="normal"> 3261</span>
<span class="normal"> 3262</span>
<span class="normal"> 3263</span>
<span class="normal"> 3264</span>
<span class="normal"> 3265</span>
<span class="normal"> 3266</span>
<span class="normal"> 3267</span>
<span class="normal"> 3268</span>
<span class="normal"> 3269</span>
<span class="normal"> 3270</span>
<span class="normal"> 3271</span>
<span class="normal"> 3272</span>
<span class="normal"> 3273</span>
<span class="normal"> 3274</span>
<span class="normal"> 3275</span>
<span class="normal"> 3276</span>
<span class="normal"> 3277</span>
<span class="normal"> 3278</span>
<span class="normal"> 3279</span>
<span class="normal"> 3280</span>
<span class="normal"> 3281</span>
<span class="normal"> 3282</span>
<span class="normal"> 3283</span>
<span class="normal"> 3284</span>
<span class="normal"> 3285</span>
<span class="normal"> 3286</span>
<span class="normal"> 3287</span>
<span class="normal"> 3288</span>
<span class="normal"> 3289</span>
<span class="normal"> 3290</span>
<span class="normal"> 3291</span>
<span class="normal"> 3292</span>
<span class="normal"> 3293</span>
<span class="normal"> 3294</span>
<span class="normal"> 3295</span>
<span class="normal"> 3296</span>
<span class="normal"> 3297</span>
<span class="normal"> 3298</span>
<span class="normal"> 3299</span>
<span class="normal"> 3300</span>
<span class="normal"> 3301</span>
<span class="normal"> 3302</span>
<span class="normal"> 3303</span>
<span class="normal"> 3304</span>
<span class="normal"> 3305</span>
<span class="normal"> 3306</span>
<span class="normal"> 3307</span>
<span class="normal"> 3308</span>
<span class="normal"> 3309</span>
<span class="normal"> 3310</span>
<span class="normal"> 3311</span>
<span class="normal"> 3312</span>
<span class="normal"> 3313</span>
<span class="normal"> 3314</span>
<span class="normal"> 3315</span>
<span class="normal"> 3316</span>
<span class="normal"> 3317</span>
<span class="normal"> 3318</span>
<span class="normal"> 3319</span>
<span class="normal"> 3320</span>
<span class="normal"> 3321</span>
<span class="normal"> 3322</span>
<span class="normal"> 3323</span>
<span class="normal"> 3324</span>
<span class="normal"> 3325</span>
<span class="normal"> 3326</span>
<span class="normal"> 3327</span>
<span class="normal"> 3328</span>
<span class="normal"> 3329</span>
<span class="normal"> 3330</span>
<span class="normal"> 3331</span>
<span class="normal"> 3332</span>
<span class="normal"> 3333</span>
<span class="normal"> 3334</span>
<span class="normal"> 3335</span>
<span class="normal"> 3336</span>
<span class="normal"> 3337</span>
<span class="normal"> 3338</span>
<span class="normal"> 3339</span>
<span class="normal"> 3340</span>
<span class="normal"> 3341</span>
<span class="normal"> 3342</span>
<span class="normal"> 3343</span>
<span class="normal"> 3344</span>
<span class="normal"> 3345</span>
<span class="normal"> 3346</span>
<span class="normal"> 3347</span>
<span class="normal"> 3348</span>
<span class="normal"> 3349</span>
<span class="normal"> 3350</span>
<span class="normal"> 3351</span>
<span class="normal"> 3352</span>
<span class="normal"> 3353</span>
<span class="normal"> 3354</span>
<span class="normal"> 3355</span>
<span class="normal"> 3356</span>
<span class="normal"> 3357</span>
<span class="normal"> 3358</span>
<span class="normal"> 3359</span>
<span class="normal"> 3360</span>
<span class="normal"> 3361</span>
<span class="normal"> 3362</span>
<span class="normal"> 3363</span>
<span class="normal"> 3364</span>
<span class="normal"> 3365</span>
<span class="normal"> 3366</span>
<span class="normal"> 3367</span>
<span class="normal"> 3368</span>
<span class="normal"> 3369</span>
<span class="normal"> 3370</span>
<span class="normal"> 3371</span>
<span class="normal"> 3372</span>
<span class="normal"> 3373</span>
<span class="normal"> 3374</span>
<span class="normal"> 3375</span>
<span class="normal"> 3376</span>
<span class="normal"> 3377</span>
<span class="normal"> 3378</span>
<span class="normal"> 3379</span>
<span class="normal"> 3380</span>
<span class="normal"> 3381</span>
<span class="normal"> 3382</span>
<span class="normal"> 3383</span>
<span class="normal"> 3384</span>
<span class="normal"> 3385</span>
<span class="normal"> 3386</span>
<span class="normal"> 3387</span>
<span class="normal"> 3388</span>
<span class="normal"> 3389</span>
<span class="normal"> 3390</span>
<span class="normal"> 3391</span>
<span class="normal"> 3392</span>
<span class="normal"> 3393</span>
<span class="normal"> 3394</span>
<span class="normal"> 3395</span>
<span class="normal"> 3396</span>
<span class="normal"> 3397</span>
<span class="normal"> 3398</span>
<span class="normal"> 3399</span>
<span class="normal"> 3400</span>
<span class="normal"> 3401</span>
<span class="normal"> 3402</span>
<span class="normal"> 3403</span>
<span class="normal"> 3404</span>
<span class="normal"> 3405</span>
<span class="normal"> 3406</span>
<span class="normal"> 3407</span>
<span class="normal"> 3408</span>
<span class="normal"> 3409</span>
<span class="normal"> 3410</span>
<span class="normal"> 3411</span>
<span class="normal"> 3412</span>
<span class="normal"> 3413</span>
<span class="normal"> 3414</span>
<span class="normal"> 3415</span>
<span class="normal"> 3416</span>
<span class="normal"> 3417</span>
<span class="normal"> 3418</span>
<span class="normal"> 3419</span>
<span class="normal"> 3420</span>
<span class="normal"> 3421</span>
<span class="normal"> 3422</span>
<span class="normal"> 3423</span>
<span class="normal"> 3424</span>
<span class="normal"> 3425</span>
<span class="normal"> 3426</span>
<span class="normal"> 3427</span>
<span class="normal"> 3428</span>
<span class="normal"> 3429</span>
<span class="normal"> 3430</span>
<span class="normal"> 3431</span>
<span class="normal"> 3432</span>
<span class="normal"> 3433</span>
<span class="normal"> 3434</span>
<span class="normal"> 3435</span>
<span class="normal"> 3436</span>
<span class="normal"> 3437</span>
<span class="normal"> 3438</span>
<span class="normal"> 3439</span>
<span class="normal"> 3440</span>
<span class="normal"> 3441</span>
<span class="normal"> 3442</span>
<span class="normal"> 3443</span>
<span class="normal"> 3444</span>
<span class="normal"> 3445</span>
<span class="normal"> 3446</span>
<span class="normal"> 3447</span>
<span class="normal"> 3448</span>
<span class="normal"> 3449</span>
<span class="normal"> 3450</span>
<span class="normal"> 3451</span>
<span class="normal"> 3452</span>
<span class="normal"> 3453</span>
<span class="normal"> 3454</span>
<span class="normal"> 3455</span>
<span class="normal"> 3456</span>
<span class="normal"> 3457</span>
<span class="normal"> 3458</span>
<span class="normal"> 3459</span>
<span class="normal"> 3460</span>
<span class="normal"> 3461</span>
<span class="normal"> 3462</span>
<span class="normal"> 3463</span>
<span class="normal"> 3464</span>
<span class="normal"> 3465</span>
<span class="normal"> 3466</span>
<span class="normal"> 3467</span>
<span class="normal"> 3468</span>
<span class="normal"> 3469</span>
<span class="normal"> 3470</span>
<span class="normal"> 3471</span>
<span class="normal"> 3472</span>
<span class="normal"> 3473</span>
<span class="normal"> 3474</span>
<span class="normal"> 3475</span>
<span class="normal"> 3476</span>
<span class="normal"> 3477</span>
<span class="normal"> 3478</span>
<span class="normal"> 3479</span>
<span class="normal"> 3480</span>
<span class="normal"> 3481</span>
<span class="normal"> 3482</span>
<span class="normal"> 3483</span>
<span class="normal"> 3484</span>
<span class="normal"> 3485</span>
<span class="normal"> 3486</span>
<span class="normal"> 3487</span>
<span class="normal"> 3488</span>
<span class="normal"> 3489</span>
<span class="normal"> 3490</span>
<span class="normal"> 3491</span>
<span class="normal"> 3492</span>
<span class="normal"> 3493</span>
<span class="normal"> 3494</span>
<span class="normal"> 3495</span>
<span class="normal"> 3496</span>
<span class="normal"> 3497</span>
<span class="normal"> 3498</span>
<span class="normal"> 3499</span>
<span class="normal"> 3500</span>
<span class="normal"> 3501</span>
<span class="normal"> 3502</span>
<span class="normal"> 3503</span>
<span class="normal"> 3504</span>
<span class="normal"> 3505</span>
<span class="normal"> 3506</span>
<span class="normal"> 3507</span>
<span class="normal"> 3508</span>
<span class="normal"> 3509</span>
<span class="normal"> 3510</span>
<span class="normal"> 3511</span>
<span class="normal"> 3512</span>
<span class="normal"> 3513</span>
<span class="normal"> 3514</span>
<span class="normal"> 3515</span>
<span class="normal"> 3516</span>
<span class="normal"> 3517</span>
<span class="normal"> 3518</span>
<span class="normal"> 3519</span>
<span class="normal"> 3520</span>
<span class="normal"> 3521</span>
<span class="normal"> 3522</span>
<span class="normal"> 3523</span>
<span class="normal"> 3524</span>
<span class="normal"> 3525</span>
<span class="normal"> 3526</span>
<span class="normal"> 3527</span>
<span class="normal"> 3528</span>
<span class="normal"> 3529</span>
<span class="normal"> 3530</span>
<span class="normal"> 3531</span>
<span class="normal"> 3532</span>
<span class="normal"> 3533</span>
<span class="normal"> 3534</span>
<span class="normal"> 3535</span>
<span class="normal"> 3536</span>
<span class="normal"> 3537</span>
<span class="normal"> 3538</span>
<span class="normal"> 3539</span>
<span class="normal"> 3540</span>
<span class="normal"> 3541</span>
<span class="normal"> 3542</span>
<span class="normal"> 3543</span>
<span class="normal"> 3544</span>
<span class="normal"> 3545</span>
<span class="normal"> 3546</span>
<span class="normal"> 3547</span>
<span class="normal"> 3548</span>
<span class="normal"> 3549</span>
<span class="normal"> 3550</span>
<span class="normal"> 3551</span>
<span class="normal"> 3552</span>
<span class="normal"> 3553</span>
<span class="normal"> 3554</span>
<span class="normal"> 3555</span>
<span class="normal"> 3556</span>
<span class="normal"> 3557</span>
<span class="normal"> 3558</span>
<span class="normal"> 3559</span>
<span class="normal"> 3560</span>
<span class="normal"> 3561</span>
<span class="normal"> 3562</span>
<span class="normal"> 3563</span>
<span class="normal"> 3564</span>
<span class="normal"> 3565</span>
<span class="normal"> 3566</span>
<span class="normal"> 3567</span>
<span class="normal"> 3568</span>
<span class="normal"> 3569</span>
<span class="normal"> 3570</span>
<span class="normal"> 3571</span>
<span class="normal"> 3572</span>
<span class="normal"> 3573</span>
<span class="normal"> 3574</span>
<span class="normal"> 3575</span>
<span class="normal"> 3576</span>
<span class="normal"> 3577</span>
<span class="normal"> 3578</span>
<span class="normal"> 3579</span>
<span class="normal"> 3580</span>
<span class="normal"> 3581</span>
<span class="normal"> 3582</span>
<span class="normal"> 3583</span>
<span class="normal"> 3584</span>
<span class="normal"> 3585</span>
<span class="normal"> 3586</span>
<span class="normal"> 3587</span>
<span class="normal"> 3588</span>
<span class="normal"> 3589</span>
<span class="normal"> 3590</span>
<span class="normal"> 3591</span>
<span class="normal"> 3592</span>
<span class="normal"> 3593</span>
<span class="normal"> 3594</span>
<span class="normal"> 3595</span>
<span class="normal"> 3596</span>
<span class="normal"> 3597</span>
<span class="normal"> 3598</span>
<span class="normal"> 3599</span>
<span class="normal"> 3600</span>
<span class="normal"> 3601</span>
<span class="normal"> 3602</span>
<span class="normal"> 3603</span>
<span class="normal"> 3604</span>
<span class="normal"> 3605</span>
<span class="normal"> 3606</span>
<span class="normal"> 3607</span>
<span class="normal"> 3608</span>
<span class="normal"> 3609</span>
<span class="normal"> 3610</span>
<span class="normal"> 3611</span>
<span class="normal"> 3612</span>
<span class="normal"> 3613</span>
<span class="normal"> 3614</span>
<span class="normal"> 3615</span>
<span class="normal"> 3616</span>
<span class="normal"> 3617</span>
<span class="normal"> 3618</span>
<span class="normal"> 3619</span>
<span class="normal"> 3620</span>
<span class="normal"> 3621</span>
<span class="normal"> 3622</span>
<span class="normal"> 3623</span>
<span class="normal"> 3624</span>
<span class="normal"> 3625</span>
<span class="normal"> 3626</span>
<span class="normal"> 3627</span>
<span class="normal"> 3628</span>
<span class="normal"> 3629</span>
<span class="normal"> 3630</span>
<span class="normal"> 3631</span>
<span class="normal"> 3632</span>
<span class="normal"> 3633</span>
<span class="normal"> 3634</span>
<span class="normal"> 3635</span>
<span class="normal"> 3636</span>
<span class="normal"> 3637</span>
<span class="normal"> 3638</span>
<span class="normal"> 3639</span>
<span class="normal"> 3640</span>
<span class="normal"> 3641</span>
<span class="normal"> 3642</span>
<span class="normal"> 3643</span>
<span class="normal"> 3644</span>
<span class="normal"> 3645</span>
<span class="normal"> 3646</span>
<span class="normal"> 3647</span>
<span class="normal"> 3648</span>
<span class="normal"> 3649</span>
<span class="normal"> 3650</span>
<span class="normal"> 3651</span>
<span class="normal"> 3652</span>
<span class="normal"> 3653</span>
<span class="normal"> 3654</span>
<span class="normal"> 3655</span>
<span class="normal"> 3656</span>
<span class="normal"> 3657</span>
<span class="normal"> 3658</span>
<span class="normal"> 3659</span>
<span class="normal"> 3660</span>
<span class="normal"> 3661</span>
<span class="normal"> 3662</span>
<span class="normal"> 3663</span>
<span class="normal"> 3664</span>
<span class="normal"> 3665</span>
<span class="normal"> 3666</span>
<span class="normal"> 3667</span>
<span class="normal"> 3668</span>
<span class="normal"> 3669</span>
<span class="normal"> 3670</span>
<span class="normal"> 3671</span>
<span class="normal"> 3672</span>
<span class="normal"> 3673</span>
<span class="normal"> 3674</span>
<span class="normal"> 3675</span>
<span class="normal"> 3676</span>
<span class="normal"> 3677</span>
<span class="normal"> 3678</span>
<span class="normal"> 3679</span>
<span class="normal"> 3680</span>
<span class="normal"> 3681</span>
<span class="normal"> 3682</span>
<span class="normal"> 3683</span>
<span class="normal"> 3684</span>
<span class="normal"> 3685</span>
<span class="normal"> 3686</span>
<span class="normal"> 3687</span>
<span class="normal"> 3688</span>
<span class="normal"> 3689</span>
<span class="normal"> 3690</span>
<span class="normal"> 3691</span>
<span class="normal"> 3692</span>
<span class="normal"> 3693</span>
<span class="normal"> 3694</span>
<span class="normal"> 3695</span>
<span class="normal"> 3696</span>
<span class="normal"> 3697</span>
<span class="normal"> 3698</span>
<span class="normal"> 3699</span>
<span class="normal"> 3700</span>
<span class="normal"> 3701</span>
<span class="normal"> 3702</span>
<span class="normal"> 3703</span>
<span class="normal"> 3704</span>
<span class="normal"> 3705</span>
<span class="normal"> 3706</span>
<span class="normal"> 3707</span>
<span class="normal"> 3708</span>
<span class="normal"> 3709</span>
<span class="normal"> 3710</span>
<span class="normal"> 3711</span>
<span class="normal"> 3712</span>
<span class="normal"> 3713</span>
<span class="normal"> 3714</span>
<span class="normal"> 3715</span>
<span class="normal"> 3716</span>
<span class="normal"> 3717</span>
<span class="normal"> 3718</span>
<span class="normal"> 3719</span>
<span class="normal"> 3720</span>
<span class="normal"> 3721</span>
<span class="normal"> 3722</span>
<span class="normal"> 3723</span>
<span class="normal"> 3724</span>
<span class="normal"> 3725</span>
<span class="normal"> 3726</span>
<span class="normal"> 3727</span>
<span class="normal"> 3728</span>
<span class="normal"> 3729</span>
<span class="normal"> 3730</span>
<span class="normal"> 3731</span>
<span class="normal"> 3732</span>
<span class="normal"> 3733</span>
<span class="normal"> 3734</span>
<span class="normal"> 3735</span>
<span class="normal"> 3736</span>
<span class="normal"> 3737</span>
<span class="normal"> 3738</span>
<span class="normal"> 3739</span>
<span class="normal"> 3740</span>
<span class="normal"> 3741</span>
<span class="normal"> 3742</span>
<span class="normal"> 3743</span>
<span class="normal"> 3744</span>
<span class="normal"> 3745</span>
<span class="normal"> 3746</span>
<span class="normal"> 3747</span>
<span class="normal"> 3748</span>
<span class="normal"> 3749</span>
<span class="normal"> 3750</span>
<span class="normal"> 3751</span>
<span class="normal"> 3752</span>
<span class="normal"> 3753</span>
<span class="normal"> 3754</span>
<span class="normal"> 3755</span>
<span class="normal"> 3756</span>
<span class="normal"> 3757</span>
<span class="normal"> 3758</span>
<span class="normal"> 3759</span>
<span class="normal"> 3760</span>
<span class="normal"> 3761</span>
<span class="normal"> 3762</span>
<span class="normal"> 3763</span>
<span class="normal"> 3764</span>
<span class="normal"> 3765</span>
<span class="normal"> 3766</span>
<span class="normal"> 3767</span>
<span class="normal"> 3768</span>
<span class="normal"> 3769</span>
<span class="normal"> 3770</span>
<span class="normal"> 3771</span>
<span class="normal"> 3772</span>
<span class="normal"> 3773</span>
<span class="normal"> 3774</span>
<span class="normal"> 3775</span>
<span class="normal"> 3776</span>
<span class="normal"> 3777</span>
<span class="normal"> 3778</span>
<span class="normal"> 3779</span>
<span class="normal"> 3780</span>
<span class="normal"> 3781</span>
<span class="normal"> 3782</span>
<span class="normal"> 3783</span>
<span class="normal"> 3784</span>
<span class="normal"> 3785</span>
<span class="normal"> 3786</span>
<span class="normal"> 3787</span>
<span class="normal"> 3788</span>
<span class="normal"> 3789</span>
<span class="normal"> 3790</span>
<span class="normal"> 3791</span>
<span class="normal"> 3792</span>
<span class="normal"> 3793</span>
<span class="normal"> 3794</span>
<span class="normal"> 3795</span>
<span class="normal"> 3796</span>
<span class="normal"> 3797</span>
<span class="normal"> 3798</span>
<span class="normal"> 3799</span>
<span class="normal"> 3800</span>
<span class="normal"> 3801</span>
<span class="normal"> 3802</span>
<span class="normal"> 3803</span>
<span class="normal"> 3804</span>
<span class="normal"> 3805</span>
<span class="normal"> 3806</span>
<span class="normal"> 3807</span>
<span class="normal"> 3808</span>
<span class="normal"> 3809</span>
<span class="normal"> 3810</span>
<span class="normal"> 3811</span>
<span class="normal"> 3812</span>
<span class="normal"> 3813</span>
<span class="normal"> 3814</span>
<span class="normal"> 3815</span>
<span class="normal"> 3816</span>
<span class="normal"> 3817</span>
<span class="normal"> 3818</span>
<span class="normal"> 3819</span>
<span class="normal"> 3820</span>
<span class="normal"> 3821</span>
<span class="normal"> 3822</span>
<span class="normal"> 3823</span>
<span class="normal"> 3824</span>
<span class="normal"> 3825</span>
<span class="normal"> 3826</span>
<span class="normal"> 3827</span>
<span class="normal"> 3828</span>
<span class="normal"> 3829</span>
<span class="normal"> 3830</span>
<span class="normal"> 3831</span>
<span class="normal"> 3832</span>
<span class="normal"> 3833</span>
<span class="normal"> 3834</span>
<span class="normal"> 3835</span>
<span class="normal"> 3836</span>
<span class="normal"> 3837</span>
<span class="normal"> 3838</span>
<span class="normal"> 3839</span>
<span class="normal"> 3840</span>
<span class="normal"> 3841</span>
<span class="normal"> 3842</span>
<span class="normal"> 3843</span>
<span class="normal"> 3844</span>
<span class="normal"> 3845</span>
<span class="normal"> 3846</span>
<span class="normal"> 3847</span>
<span class="normal"> 3848</span>
<span class="normal"> 3849</span>
<span class="normal"> 3850</span>
<span class="normal"> 3851</span>
<span class="normal"> 3852</span>
<span class="normal"> 3853</span>
<span class="normal"> 3854</span>
<span class="normal"> 3855</span>
<span class="normal"> 3856</span>
<span class="normal"> 3857</span>
<span class="normal"> 3858</span>
<span class="normal"> 3859</span>
<span class="normal"> 3860</span>
<span class="normal"> 3861</span>
<span class="normal"> 3862</span>
<span class="normal"> 3863</span>
<span class="normal"> 3864</span>
<span class="normal"> 3865</span>
<span class="normal"> 3866</span>
<span class="normal"> 3867</span>
<span class="normal"> 3868</span>
<span class="normal"> 3869</span>
<span class="normal"> 3870</span>
<span class="normal"> 3871</span>
<span class="normal"> 3872</span>
<span class="normal"> 3873</span>
<span class="normal"> 3874</span>
<span class="normal"> 3875</span>
<span class="normal"> 3876</span>
<span class="normal"> 3877</span>
<span class="normal"> 3878</span>
<span class="normal"> 3879</span>
<span class="normal"> 3880</span>
<span class="normal"> 3881</span>
<span class="normal"> 3882</span>
<span class="normal"> 3883</span>
<span class="normal"> 3884</span>
<span class="normal"> 3885</span>
<span class="normal"> 3886</span>
<span class="normal"> 3887</span>
<span class="normal"> 3888</span>
<span class="normal"> 3889</span>
<span class="normal"> 3890</span>
<span class="normal"> 3891</span>
<span class="normal"> 3892</span>
<span class="normal"> 3893</span>
<span class="normal"> 3894</span>
<span class="normal"> 3895</span>
<span class="normal"> 3896</span>
<span class="normal"> 3897</span>
<span class="normal"> 3898</span>
<span class="normal"> 3899</span>
<span class="normal"> 3900</span>
<span class="normal"> 3901</span>
<span class="normal"> 3902</span>
<span class="normal"> 3903</span>
<span class="normal"> 3904</span>
<span class="normal"> 3905</span>
<span class="normal"> 3906</span>
<span class="normal"> 3907</span>
<span class="normal"> 3908</span>
<span class="normal"> 3909</span>
<span class="normal"> 3910</span>
<span class="normal"> 3911</span>
<span class="normal"> 3912</span>
<span class="normal"> 3913</span>
<span class="normal"> 3914</span>
<span class="normal"> 3915</span>
<span class="normal"> 3916</span>
<span class="normal"> 3917</span>
<span class="normal"> 3918</span>
<span class="normal"> 3919</span>
<span class="normal"> 3920</span>
<span class="normal"> 3921</span>
<span class="normal"> 3922</span>
<span class="normal"> 3923</span>
<span class="normal"> 3924</span>
<span class="normal"> 3925</span>
<span class="normal"> 3926</span>
<span class="normal"> 3927</span>
<span class="normal"> 3928</span>
<span class="normal"> 3929</span>
<span class="normal"> 3930</span>
<span class="normal"> 3931</span>
<span class="normal"> 3932</span>
<span class="normal"> 3933</span>
<span class="normal"> 3934</span>
<span class="normal"> 3935</span>
<span class="normal"> 3936</span>
<span class="normal"> 3937</span>
<span class="normal"> 3938</span>
<span class="normal"> 3939</span>
<span class="normal"> 3940</span>
<span class="normal"> 3941</span>
<span class="normal"> 3942</span>
<span class="normal"> 3943</span>
<span class="normal"> 3944</span>
<span class="normal"> 3945</span>
<span class="normal"> 3946</span>
<span class="normal"> 3947</span>
<span class="normal"> 3948</span>
<span class="normal"> 3949</span>
<span class="normal"> 3950</span>
<span class="normal"> 3951</span>
<span class="normal"> 3952</span>
<span class="normal"> 3953</span>
<span class="normal"> 3954</span>
<span class="normal"> 3955</span>
<span class="normal"> 3956</span>
<span class="normal"> 3957</span>
<span class="normal"> 3958</span>
<span class="normal"> 3959</span>
<span class="normal"> 3960</span>
<span class="normal"> 3961</span>
<span class="normal"> 3962</span>
<span class="normal"> 3963</span>
<span class="normal"> 3964</span>
<span class="normal"> 3965</span>
<span class="normal"> 3966</span>
<span class="normal"> 3967</span>
<span class="normal"> 3968</span>
<span class="normal"> 3969</span>
<span class="normal"> 3970</span>
<span class="normal"> 3971</span>
<span class="normal"> 3972</span>
<span class="normal"> 3973</span>
<span class="normal"> 3974</span>
<span class="normal"> 3975</span>
<span class="normal"> 3976</span>
<span class="normal"> 3977</span>
<span class="normal"> 3978</span>
<span class="normal"> 3979</span>
<span class="normal"> 3980</span>
<span class="normal"> 3981</span>
<span class="normal"> 3982</span>
<span class="normal"> 3983</span>
<span class="normal"> 3984</span>
<span class="normal"> 3985</span>
<span class="normal"> 3986</span>
<span class="normal"> 3987</span>
<span class="normal"> 3988</span>
<span class="normal"> 3989</span>
<span class="normal"> 3990</span>
<span class="normal"> 3991</span>
<span class="normal"> 3992</span>
<span class="normal"> 3993</span>
<span class="normal"> 3994</span>
<span class="normal"> 3995</span>
<span class="normal"> 3996</span>
<span class="normal"> 3997</span>
<span class="normal"> 3998</span>
<span class="normal"> 3999</span>
<span class="normal"> 4000</span>
<span class="normal"> 4001</span>
<span class="normal"> 4002</span>
<span class="normal"> 4003</span>
<span class="normal"> 4004</span>
<span class="normal"> 4005</span>
<span class="normal"> 4006</span>
<span class="normal"> 4007</span>
<span class="normal"> 4008</span>
<span class="normal"> 4009</span>
<span class="normal"> 4010</span>
<span class="normal"> 4011</span>
<span class="normal"> 4012</span>
<span class="normal"> 4013</span>
<span class="normal"> 4014</span>
<span class="normal"> 4015</span>
<span class="normal"> 4016</span>
<span class="normal"> 4017</span>
<span class="normal"> 4018</span>
<span class="normal"> 4019</span>
<span class="normal"> 4020</span>
<span class="normal"> 4021</span>
<span class="normal"> 4022</span>
<span class="normal"> 4023</span>
<span class="normal"> 4024</span>
<span class="normal"> 4025</span>
<span class="normal"> 4026</span>
<span class="normal"> 4027</span>
<span class="normal"> 4028</span>
<span class="normal"> 4029</span>
<span class="normal"> 4030</span>
<span class="normal"> 4031</span>
<span class="normal"> 4032</span>
<span class="normal"> 4033</span>
<span class="normal"> 4034</span>
<span class="normal"> 4035</span>
<span class="normal"> 4036</span>
<span class="normal"> 4037</span>
<span class="normal"> 4038</span>
<span class="normal"> 4039</span>
<span class="normal"> 4040</span>
<span class="normal"> 4041</span>
<span class="normal"> 4042</span>
<span class="normal"> 4043</span>
<span class="normal"> 4044</span>
<span class="normal"> 4045</span>
<span class="normal"> 4046</span>
<span class="normal"> 4047</span>
<span class="normal"> 4048</span>
<span class="normal"> 4049</span>
<span class="normal"> 4050</span>
<span class="normal"> 4051</span>
<span class="normal"> 4052</span>
<span class="normal"> 4053</span>
<span class="normal"> 4054</span>
<span class="normal"> 4055</span>
<span class="normal"> 4056</span>
<span class="normal"> 4057</span>
<span class="normal"> 4058</span>
<span class="normal"> 4059</span>
<span class="normal"> 4060</span>
<span class="normal"> 4061</span>
<span class="normal"> 4062</span>
<span class="normal"> 4063</span>
<span class="normal"> 4064</span>
<span class="normal"> 4065</span>
<span class="normal"> 4066</span>
<span class="normal"> 4067</span>
<span class="normal"> 4068</span>
<span class="normal"> 4069</span>
<span class="normal"> 4070</span>
<span class="normal"> 4071</span>
<span class="normal"> 4072</span>
<span class="normal"> 4073</span>
<span class="normal"> 4074</span>
<span class="normal"> 4075</span>
<span class="normal"> 4076</span>
<span class="normal"> 4077</span>
<span class="normal"> 4078</span>
<span class="normal"> 4079</span>
<span class="normal"> 4080</span>
<span class="normal"> 4081</span>
<span class="normal"> 4082</span>
<span class="normal"> 4083</span>
<span class="normal"> 4084</span>
<span class="normal"> 4085</span>
<span class="normal"> 4086</span>
<span class="normal"> 4087</span>
<span class="normal"> 4088</span>
<span class="normal"> 4089</span>
<span class="normal"> 4090</span>
<span class="normal"> 4091</span>
<span class="normal"> 4092</span>
<span class="normal"> 4093</span>
<span class="normal"> 4094</span>
<span class="normal"> 4095</span>
<span class="normal"> 4096</span>
<span class="normal"> 4097</span>
<span class="normal"> 4098</span>
<span class="normal"> 4099</span>
<span class="normal"> 4100</span>
<span class="normal"> 4101</span>
<span class="normal"> 4102</span>
<span class="normal"> 4103</span>
<span class="normal"> 4104</span>
<span class="normal"> 4105</span>
<span class="normal"> 4106</span>
<span class="normal"> 4107</span>
<span class="normal"> 4108</span>
<span class="normal"> 4109</span>
<span class="normal"> 4110</span>
<span class="normal"> 4111</span>
<span class="normal"> 4112</span>
<span class="normal"> 4113</span>
<span class="normal"> 4114</span>
<span class="normal"> 4115</span>
<span class="normal"> 4116</span>
<span class="normal"> 4117</span>
<span class="normal"> 4118</span>
<span class="normal"> 4119</span>
<span class="normal"> 4120</span>
<span class="normal"> 4121</span>
<span class="normal"> 4122</span>
<span class="normal"> 4123</span>
<span class="normal"> 4124</span>
<span class="normal"> 4125</span>
<span class="normal"> 4126</span>
<span class="normal"> 4127</span>
<span class="normal"> 4128</span>
<span class="normal"> 4129</span>
<span class="normal"> 4130</span>
<span class="normal"> 4131</span>
<span class="normal"> 4132</span>
<span class="normal"> 4133</span>
<span class="normal"> 4134</span>
<span class="normal"> 4135</span>
<span class="normal"> 4136</span>
<span class="normal"> 4137</span>
<span class="normal"> 4138</span>
<span class="normal"> 4139</span>
<span class="normal"> 4140</span>
<span class="normal"> 4141</span>
<span class="normal"> 4142</span>
<span class="normal"> 4143</span>
<span class="normal"> 4144</span>
<span class="normal"> 4145</span>
<span class="normal"> 4146</span>
<span class="normal"> 4147</span>
<span class="normal"> 4148</span>
<span class="normal"> 4149</span>
<span class="normal"> 4150</span>
<span class="normal"> 4151</span>
<span class="normal"> 4152</span>
<span class="normal"> 4153</span>
<span class="normal"> 4154</span>
<span class="normal"> 4155</span>
<span class="normal"> 4156</span>
<span class="normal"> 4157</span>
<span class="normal"> 4158</span>
<span class="normal"> 4159</span>
<span class="normal"> 4160</span>
<span class="normal"> 4161</span>
<span class="normal"> 4162</span>
<span class="normal"> 4163</span>
<span class="normal"> 4164</span>
<span class="normal"> 4165</span>
<span class="normal"> 4166</span>
<span class="normal"> 4167</span>
<span class="normal"> 4168</span>
<span class="normal"> 4169</span>
<span class="normal"> 4170</span>
<span class="normal"> 4171</span>
<span class="normal"> 4172</span>
<span class="normal"> 4173</span>
<span class="normal"> 4174</span>
<span class="normal"> 4175</span>
<span class="normal"> 4176</span>
<span class="normal"> 4177</span>
<span class="normal"> 4178</span>
<span class="normal"> 4179</span>
<span class="normal"> 4180</span>
<span class="normal"> 4181</span>
<span class="normal"> 4182</span>
<span class="normal"> 4183</span>
<span class="normal"> 4184</span>
<span class="normal"> 4185</span>
<span class="normal"> 4186</span>
<span class="normal"> 4187</span>
<span class="normal"> 4188</span>
<span class="normal"> 4189</span>
<span class="normal"> 4190</span>
<span class="normal"> 4191</span>
<span class="normal"> 4192</span>
<span class="normal"> 4193</span>
<span class="normal"> 4194</span>
<span class="normal"> 4195</span>
<span class="normal"> 4196</span>
<span class="normal"> 4197</span>
<span class="normal"> 4198</span>
<span class="normal"> 4199</span>
<span class="normal"> 4200</span>
<span class="normal"> 4201</span>
<span class="normal"> 4202</span>
<span class="normal"> 4203</span>
<span class="normal"> 4204</span>
<span class="normal"> 4205</span>
<span class="normal"> 4206</span>
<span class="normal"> 4207</span>
<span class="normal"> 4208</span>
<span class="normal"> 4209</span>
<span class="normal"> 4210</span>
<span class="normal"> 4211</span>
<span class="normal"> 4212</span>
<span class="normal"> 4213</span>
<span class="normal"> 4214</span>
<span class="normal"> 4215</span>
<span class="normal"> 4216</span>
<span class="normal"> 4217</span>
<span class="normal"> 4218</span>
<span class="normal"> 4219</span>
<span class="normal"> 4220</span>
<span class="normal"> 4221</span>
<span class="normal"> 4222</span>
<span class="normal"> 4223</span>
<span class="normal"> 4224</span>
<span class="normal"> 4225</span>
<span class="normal"> 4226</span>
<span class="normal"> 4227</span>
<span class="normal"> 4228</span>
<span class="normal"> 4229</span>
<span class="normal"> 4230</span>
<span class="normal"> 4231</span>
<span class="normal"> 4232</span>
<span class="normal"> 4233</span>
<span class="normal"> 4234</span>
<span class="normal"> 4235</span>
<span class="normal"> 4236</span>
<span class="normal"> 4237</span>
<span class="normal"> 4238</span>
<span class="normal"> 4239</span>
<span class="normal"> 4240</span>
<span class="normal"> 4241</span>
<span class="normal"> 4242</span>
<span class="normal"> 4243</span>
<span class="normal"> 4244</span>
<span class="normal"> 4245</span>
<span class="normal"> 4246</span>
<span class="normal"> 4247</span>
<span class="normal"> 4248</span>
<span class="normal"> 4249</span>
<span class="normal"> 4250</span>
<span class="normal"> 4251</span>
<span class="normal"> 4252</span>
<span class="normal"> 4253</span>
<span class="normal"> 4254</span>
<span class="normal"> 4255</span>
<span class="normal"> 4256</span>
<span class="normal"> 4257</span>
<span class="normal"> 4258</span>
<span class="normal"> 4259</span>
<span class="normal"> 4260</span>
<span class="normal"> 4261</span>
<span class="normal"> 4262</span>
<span class="normal"> 4263</span>
<span class="normal"> 4264</span>
<span class="normal"> 4265</span>
<span class="normal"> 4266</span>
<span class="normal"> 4267</span>
<span class="normal"> 4268</span>
<span class="normal"> 4269</span>
<span class="normal"> 4270</span>
<span class="normal"> 4271</span>
<span class="normal"> 4272</span>
<span class="normal"> 4273</span>
<span class="normal"> 4274</span>
<span class="normal"> 4275</span>
<span class="normal"> 4276</span>
<span class="normal"> 4277</span>
<span class="normal"> 4278</span>
<span class="normal"> 4279</span>
<span class="normal"> 4280</span>
<span class="normal"> 4281</span>
<span class="normal"> 4282</span>
<span class="normal"> 4283</span>
<span class="normal"> 4284</span>
<span class="normal"> 4285</span>
<span class="normal"> 4286</span>
<span class="normal"> 4287</span>
<span class="normal"> 4288</span>
<span class="normal"> 4289</span>
<span class="normal"> 4290</span>
<span class="normal"> 4291</span>
<span class="normal"> 4292</span>
<span class="normal"> 4293</span>
<span class="normal"> 4294</span>
<span class="normal"> 4295</span>
<span class="normal"> 4296</span>
<span class="normal"> 4297</span>
<span class="normal"> 4298</span>
<span class="normal"> 4299</span>
<span class="normal"> 4300</span>
<span class="normal"> 4301</span>
<span class="normal"> 4302</span>
<span class="normal"> 4303</span>
<span class="normal"> 4304</span>
<span class="normal"> 4305</span>
<span class="normal"> 4306</span>
<span class="normal"> 4307</span>
<span class="normal"> 4308</span>
<span class="normal"> 4309</span>
<span class="normal"> 4310</span>
<span class="normal"> 4311</span>
<span class="normal"> 4312</span>
<span class="normal"> 4313</span>
<span class="normal"> 4314</span>
<span class="normal"> 4315</span>
<span class="normal"> 4316</span>
<span class="normal"> 4317</span>
<span class="normal"> 4318</span>
<span class="normal"> 4319</span>
<span class="normal"> 4320</span>
<span class="normal"> 4321</span>
<span class="normal"> 4322</span>
<span class="normal"> 4323</span>
<span class="normal"> 4324</span>
<span class="normal"> 4325</span>
<span class="normal"> 4326</span>
<span class="normal"> 4327</span>
<span class="normal"> 4328</span>
<span class="normal"> 4329</span>
<span class="normal"> 4330</span>
<span class="normal"> 4331</span>
<span class="normal"> 4332</span>
<span class="normal"> 4333</span>
<span class="normal"> 4334</span>
<span class="normal"> 4335</span>
<span class="normal"> 4336</span>
<span class="normal"> 4337</span>
<span class="normal"> 4338</span>
<span class="normal"> 4339</span>
<span class="normal"> 4340</span>
<span class="normal"> 4341</span>
<span class="normal"> 4342</span>
<span class="normal"> 4343</span>
<span class="normal"> 4344</span>
<span class="normal"> 4345</span>
<span class="normal"> 4346</span>
<span class="normal"> 4347</span>
<span class="normal"> 4348</span>
<span class="normal"> 4349</span>
<span class="normal"> 4350</span>
<span class="normal"> 4351</span>
<span class="normal"> 4352</span>
<span class="normal"> 4353</span>
<span class="normal"> 4354</span>
<span class="normal"> 4355</span>
<span class="normal"> 4356</span>
<span class="normal"> 4357</span>
<span class="normal"> 4358</span>
<span class="normal"> 4359</span>
<span class="normal"> 4360</span>
<span class="normal"> 4361</span>
<span class="normal"> 4362</span>
<span class="normal"> 4363</span>
<span class="normal"> 4364</span>
<span class="normal"> 4365</span>
<span class="normal"> 4366</span>
<span class="normal"> 4367</span>
<span class="normal"> 4368</span>
<span class="normal"> 4369</span>
<span class="normal"> 4370</span>
<span class="normal"> 4371</span>
<span class="normal"> 4372</span>
<span class="normal"> 4373</span>
<span class="normal"> 4374</span>
<span class="normal"> 4375</span>
<span class="normal"> 4376</span>
<span class="normal"> 4377</span>
<span class="normal"> 4378</span>
<span class="normal"> 4379</span>
<span class="normal"> 4380</span>
<span class="normal"> 4381</span>
<span class="normal"> 4382</span>
<span class="normal"> 4383</span>
<span class="normal"> 4384</span>
<span class="normal"> 4385</span>
<span class="normal"> 4386</span>
<span class="normal"> 4387</span>
<span class="normal"> 4388</span>
<span class="normal"> 4389</span>
<span class="normal"> 4390</span>
<span class="normal"> 4391</span>
<span class="normal"> 4392</span>
<span class="normal"> 4393</span>
<span class="normal"> 4394</span>
<span class="normal"> 4395</span>
<span class="normal"> 4396</span>
<span class="normal"> 4397</span>
<span class="normal"> 4398</span>
<span class="normal"> 4399</span>
<span class="normal"> 4400</span>
<span class="normal"> 4401</span>
<span class="normal"> 4402</span>
<span class="normal"> 4403</span>
<span class="normal"> 4404</span>
<span class="normal"> 4405</span>
<span class="normal"> 4406</span>
<span class="normal"> 4407</span>
<span class="normal"> 4408</span>
<span class="normal"> 4409</span>
<span class="normal"> 4410</span>
<span class="normal"> 4411</span>
<span class="normal"> 4412</span>
<span class="normal"> 4413</span>
<span class="normal"> 4414</span>
<span class="normal"> 4415</span>
<span class="normal"> 4416</span>
<span class="normal"> 4417</span>
<span class="normal"> 4418</span>
<span class="normal"> 4419</span>
<span class="normal"> 4420</span>
<span class="normal"> 4421</span>
<span class="normal"> 4422</span>
<span class="normal"> 4423</span>
<span class="normal"> 4424</span>
<span class="normal"> 4425</span>
<span class="normal"> 4426</span>
<span class="normal"> 4427</span>
<span class="normal"> 4428</span>
<span class="normal"> 4429</span>
<span class="normal"> 4430</span>
<span class="normal"> 4431</span>
<span class="normal"> 4432</span>
<span class="normal"> 4433</span>
<span class="normal"> 4434</span>
<span class="normal"> 4435</span>
<span class="normal"> 4436</span>
<span class="normal"> 4437</span>
<span class="normal"> 4438</span>
<span class="normal"> 4439</span>
<span class="normal"> 4440</span>
<span class="normal"> 4441</span>
<span class="normal"> 4442</span>
<span class="normal"> 4443</span>
<span class="normal"> 4444</span>
<span class="normal"> 4445</span>
<span class="normal"> 4446</span>
<span class="normal"> 4447</span>
<span class="normal"> 4448</span>
<span class="normal"> 4449</span>
<span class="normal"> 4450</span>
<span class="normal"> 4451</span>
<span class="normal"> 4452</span>
<span class="normal"> 4453</span>
<span class="normal"> 4454</span>
<span class="normal"> 4455</span>
<span class="normal"> 4456</span>
<span class="normal"> 4457</span>
<span class="normal"> 4458</span>
<span class="normal"> 4459</span>
<span class="normal"> 4460</span>
<span class="normal"> 4461</span>
<span class="normal"> 4462</span>
<span class="normal"> 4463</span>
<span class="normal"> 4464</span>
<span class="normal"> 4465</span>
<span class="normal"> 4466</span>
<span class="normal"> 4467</span>
<span class="normal"> 4468</span>
<span class="normal"> 4469</span>
<span class="normal"> 4470</span>
<span class="normal"> 4471</span>
<span class="normal"> 4472</span>
<span class="normal"> 4473</span>
<span class="normal"> 4474</span>
<span class="normal"> 4475</span>
<span class="normal"> 4476</span>
<span class="normal"> 4477</span>
<span class="normal"> 4478</span>
<span class="normal"> 4479</span>
<span class="normal"> 4480</span>
<span class="normal"> 4481</span>
<span class="normal"> 4482</span>
<span class="normal"> 4483</span>
<span class="normal"> 4484</span>
<span class="normal"> 4485</span>
<span class="normal"> 4486</span>
<span class="normal"> 4487</span>
<span class="normal"> 4488</span>
<span class="normal"> 4489</span>
<span class="normal"> 4490</span>
<span class="normal"> 4491</span>
<span class="normal"> 4492</span>
<span class="normal"> 4493</span>
<span class="normal"> 4494</span>
<span class="normal"> 4495</span>
<span class="normal"> 4496</span>
<span class="normal"> 4497</span>
<span class="normal"> 4498</span>
<span class="normal"> 4499</span>
<span class="normal"> 4500</span>
<span class="normal"> 4501</span>
<span class="normal"> 4502</span>
<span class="normal"> 4503</span>
<span class="normal"> 4504</span>
<span class="normal"> 4505</span>
<span class="normal"> 4506</span>
<span class="normal"> 4507</span>
<span class="normal"> 4508</span>
<span class="normal"> 4509</span>
<span class="normal"> 4510</span>
<span class="normal"> 4511</span>
<span class="normal"> 4512</span>
<span class="normal"> 4513</span>
<span class="normal"> 4514</span>
<span class="normal"> 4515</span>
<span class="normal"> 4516</span>
<span class="normal"> 4517</span>
<span class="normal"> 4518</span>
<span class="normal"> 4519</span>
<span class="normal"> 4520</span>
<span class="normal"> 4521</span>
<span class="normal"> 4522</span>
<span class="normal"> 4523</span>
<span class="normal"> 4524</span>
<span class="normal"> 4525</span>
<span class="normal"> 4526</span>
<span class="normal"> 4527</span>
<span class="normal"> 4528</span>
<span class="normal"> 4529</span>
<span class="normal"> 4530</span>
<span class="normal"> 4531</span>
<span class="normal"> 4532</span>
<span class="normal"> 4533</span>
<span class="normal"> 4534</span>
<span class="normal"> 4535</span>
<span class="normal"> 4536</span>
<span class="normal"> 4537</span>
<span class="normal"> 4538</span>
<span class="normal"> 4539</span>
<span class="normal"> 4540</span>
<span class="normal"> 4541</span>
<span class="normal"> 4542</span>
<span class="normal"> 4543</span>
<span class="normal"> 4544</span>
<span class="normal"> 4545</span>
<span class="normal"> 4546</span>
<span class="normal"> 4547</span>
<span class="normal"> 4548</span>
<span class="normal"> 4549</span>
<span class="normal"> 4550</span>
<span class="normal"> 4551</span>
<span class="normal"> 4552</span>
<span class="normal"> 4553</span>
<span class="normal"> 4554</span>
<span class="normal"> 4555</span>
<span class="normal"> 4556</span>
<span class="normal"> 4557</span>
<span class="normal"> 4558</span>
<span class="normal"> 4559</span>
<span class="normal"> 4560</span>
<span class="normal"> 4561</span>
<span class="normal"> 4562</span>
<span class="normal"> 4563</span>
<span class="normal"> 4564</span>
<span class="normal"> 4565</span>
<span class="normal"> 4566</span>
<span class="normal"> 4567</span>
<span class="normal"> 4568</span>
<span class="normal"> 4569</span>
<span class="normal"> 4570</span>
<span class="normal"> 4571</span>
<span class="normal"> 4572</span>
<span class="normal"> 4573</span>
<span class="normal"> 4574</span>
<span class="normal"> 4575</span>
<span class="normal"> 4576</span>
<span class="normal"> 4577</span>
<span class="normal"> 4578</span>
<span class="normal"> 4579</span>
<span class="normal"> 4580</span>
<span class="normal"> 4581</span>
<span class="normal"> 4582</span>
<span class="normal"> 4583</span>
<span class="normal"> 4584</span>
<span class="normal"> 4585</span>
<span class="normal"> 4586</span>
<span class="normal"> 4587</span>
<span class="normal"> 4588</span>
<span class="normal"> 4589</span>
<span class="normal"> 4590</span>
<span class="normal"> 4591</span>
<span class="normal"> 4592</span>
<span class="normal"> 4593</span>
<span class="normal"> 4594</span>
<span class="normal"> 4595</span>
<span class="normal"> 4596</span>
<span class="normal"> 4597</span>
<span class="normal"> 4598</span>
<span class="normal"> 4599</span>
<span class="normal"> 4600</span>
<span class="normal"> 4601</span>
<span class="normal"> 4602</span>
<span class="normal"> 4603</span>
<span class="normal"> 4604</span>
<span class="normal"> 4605</span>
<span class="normal"> 4606</span>
<span class="normal"> 4607</span>
<span class="normal"> 4608</span>
<span class="normal"> 4609</span>
<span class="normal"> 4610</span>
<span class="normal"> 4611</span>
<span class="normal"> 4612</span>
<span class="normal"> 4613</span>
<span class="normal"> 4614</span>
<span class="normal"> 4615</span>
<span class="normal"> 4616</span>
<span class="normal"> 4617</span>
<span class="normal"> 4618</span>
<span class="normal"> 4619</span>
<span class="normal"> 4620</span>
<span class="normal"> 4621</span>
<span class="normal"> 4622</span>
<span class="normal"> 4623</span>
<span class="normal"> 4624</span>
<span class="normal"> 4625</span>
<span class="normal"> 4626</span>
<span class="normal"> 4627</span>
<span class="normal"> 4628</span>
<span class="normal"> 4629</span>
<span class="normal"> 4630</span>
<span class="normal"> 4631</span>
<span class="normal"> 4632</span>
<span class="normal"> 4633</span>
<span class="normal"> 4634</span>
<span class="normal"> 4635</span>
<span class="normal"> 4636</span>
<span class="normal"> 4637</span>
<span class="normal"> 4638</span>
<span class="normal"> 4639</span>
<span class="normal"> 4640</span>
<span class="normal"> 4641</span>
<span class="normal"> 4642</span>
<span class="normal"> 4643</span>
<span class="normal"> 4644</span>
<span class="normal"> 4645</span>
<span class="normal"> 4646</span>
<span class="normal"> 4647</span>
<span class="normal"> 4648</span>
<span class="normal"> 4649</span>
<span class="normal"> 4650</span>
<span class="normal"> 4651</span>
<span class="normal"> 4652</span>
<span class="normal"> 4653</span>
<span class="normal"> 4654</span>
<span class="normal"> 4655</span>
<span class="normal"> 4656</span>
<span class="normal"> 4657</span>
<span class="normal"> 4658</span>
<span class="normal"> 4659</span>
<span class="normal"> 4660</span>
<span class="normal"> 4661</span>
<span class="normal"> 4662</span>
<span class="normal"> 4663</span>
<span class="normal"> 4664</span>
<span class="normal"> 4665</span>
<span class="normal"> 4666</span>
<span class="normal"> 4667</span>
<span class="normal"> 4668</span>
<span class="normal"> 4669</span>
<span class="normal"> 4670</span>
<span class="normal"> 4671</span>
<span class="normal"> 4672</span>
<span class="normal"> 4673</span>
<span class="normal"> 4674</span>
<span class="normal"> 4675</span>
<span class="normal"> 4676</span>
<span class="normal"> 4677</span>
<span class="normal"> 4678</span>
<span class="normal"> 4679</span>
<span class="normal"> 4680</span>
<span class="normal"> 4681</span>
<span class="normal"> 4682</span>
<span class="normal"> 4683</span>
<span class="normal"> 4684</span>
<span class="normal"> 4685</span>
<span class="normal"> 4686</span>
<span class="normal"> 4687</span>
<span class="normal"> 4688</span>
<span class="normal"> 4689</span>
<span class="normal"> 4690</span>
<span class="normal"> 4691</span>
<span class="normal"> 4692</span>
<span class="normal"> 4693</span>
<span class="normal"> 4694</span>
<span class="normal"> 4695</span>
<span class="normal"> 4696</span>
<span class="normal"> 4697</span>
<span class="normal"> 4698</span>
<span class="normal"> 4699</span>
<span class="normal"> 4700</span>
<span class="normal"> 4701</span>
<span class="normal"> 4702</span>
<span class="normal"> 4703</span>
<span class="normal"> 4704</span>
<span class="normal"> 4705</span>
<span class="normal"> 4706</span>
<span class="normal"> 4707</span>
<span class="normal"> 4708</span>
<span class="normal"> 4709</span>
<span class="normal"> 4710</span>
<span class="normal"> 4711</span>
<span class="normal"> 4712</span>
<span class="normal"> 4713</span>
<span class="normal"> 4714</span>
<span class="normal"> 4715</span>
<span class="normal"> 4716</span>
<span class="normal"> 4717</span>
<span class="normal"> 4718</span>
<span class="normal"> 4719</span>
<span class="normal"> 4720</span>
<span class="normal"> 4721</span>
<span class="normal"> 4722</span>
<span class="normal"> 4723</span>
<span class="normal"> 4724</span>
<span class="normal"> 4725</span>
<span class="normal"> 4726</span>
<span class="normal"> 4727</span>
<span class="normal"> 4728</span>
<span class="normal"> 4729</span>
<span class="normal"> 4730</span>
<span class="normal"> 4731</span>
<span class="normal"> 4732</span>
<span class="normal"> 4733</span>
<span class="normal"> 4734</span>
<span class="normal"> 4735</span>
<span class="normal"> 4736</span>
<span class="normal"> 4737</span>
<span class="normal"> 4738</span>
<span class="normal"> 4739</span>
<span class="normal"> 4740</span>
<span class="normal"> 4741</span>
<span class="normal"> 4742</span>
<span class="normal"> 4743</span>
<span class="normal"> 4744</span>
<span class="normal"> 4745</span>
<span class="normal"> 4746</span>
<span class="normal"> 4747</span>
<span class="normal"> 4748</span>
<span class="normal"> 4749</span>
<span class="normal"> 4750</span>
<span class="normal"> 4751</span>
<span class="normal"> 4752</span>
<span class="normal"> 4753</span>
<span class="normal"> 4754</span>
<span class="normal"> 4755</span>
<span class="normal"> 4756</span>
<span class="normal"> 4757</span>
<span class="normal"> 4758</span>
<span class="normal"> 4759</span>
<span class="normal"> 4760</span>
<span class="normal"> 4761</span>
<span class="normal"> 4762</span>
<span class="normal"> 4763</span>
<span class="normal"> 4764</span>
<span class="normal"> 4765</span>
<span class="normal"> 4766</span>
<span class="normal"> 4767</span>
<span class="normal"> 4768</span>
<span class="normal"> 4769</span>
<span class="normal"> 4770</span>
<span class="normal"> 4771</span>
<span class="normal"> 4772</span>
<span class="normal"> 4773</span>
<span class="normal"> 4774</span>
<span class="normal"> 4775</span>
<span class="normal"> 4776</span>
<span class="normal"> 4777</span>
<span class="normal"> 4778</span>
<span class="normal"> 4779</span>
<span class="normal"> 4780</span>
<span class="normal"> 4781</span>
<span class="normal"> 4782</span>
<span class="normal"> 4783</span>
<span class="normal"> 4784</span>
<span class="normal"> 4785</span>
<span class="normal"> 4786</span>
<span class="normal"> 4787</span>
<span class="normal"> 4788</span>
<span class="normal"> 4789</span>
<span class="normal"> 4790</span>
<span class="normal"> 4791</span>
<span class="normal"> 4792</span>
<span class="normal"> 4793</span>
<span class="normal"> 4794</span>
<span class="normal"> 4795</span>
<span class="normal"> 4796</span>
<span class="normal"> 4797</span>
<span class="normal"> 4798</span>
<span class="normal"> 4799</span>
<span class="normal"> 4800</span>
<span class="normal"> 4801</span>
<span class="normal"> 4802</span>
<span class="normal"> 4803</span>
<span class="normal"> 4804</span>
<span class="normal"> 4805</span>
<span class="normal"> 4806</span>
<span class="normal"> 4807</span>
<span class="normal"> 4808</span>
<span class="normal"> 4809</span>
<span class="normal"> 4810</span>
<span class="normal"> 4811</span>
<span class="normal"> 4812</span>
<span class="normal"> 4813</span>
<span class="normal"> 4814</span>
<span class="normal"> 4815</span>
<span class="normal"> 4816</span>
<span class="normal"> 4817</span>
<span class="normal"> 4818</span>
<span class="normal"> 4819</span>
<span class="normal"> 4820</span>
<span class="normal"> 4821</span>
<span class="normal"> 4822</span>
<span class="normal"> 4823</span>
<span class="normal"> 4824</span>
<span class="normal"> 4825</span>
<span class="normal"> 4826</span>
<span class="normal"> 4827</span>
<span class="normal"> 4828</span>
<span class="normal"> 4829</span>
<span class="normal"> 4830</span>
<span class="normal"> 4831</span>
<span class="normal"> 4832</span>
<span class="normal"> 4833</span>
<span class="normal"> 4834</span>
<span class="normal"> 4835</span>
<span class="normal"> 4836</span>
<span class="normal"> 4837</span>
<span class="normal"> 4838</span>
<span class="normal"> 4839</span>
<span class="normal"> 4840</span>
<span class="normal"> 4841</span>
<span class="normal"> 4842</span>
<span class="normal"> 4843</span>
<span class="normal"> 4844</span>
<span class="normal"> 4845</span>
<span class="normal"> 4846</span>
<span class="normal"> 4847</span>
<span class="normal"> 4848</span>
<span class="normal"> 4849</span>
<span class="normal"> 4850</span>
<span class="normal"> 4851</span>
<span class="normal"> 4852</span>
<span class="normal"> 4853</span>
<span class="normal"> 4854</span>
<span class="normal"> 4855</span>
<span class="normal"> 4856</span>
<span class="normal"> 4857</span>
<span class="normal"> 4858</span>
<span class="normal"> 4859</span>
<span class="normal"> 4860</span>
<span class="normal"> 4861</span>
<span class="normal"> 4862</span>
<span class="normal"> 4863</span>
<span class="normal"> 4864</span>
<span class="normal"> 4865</span>
<span class="normal"> 4866</span>
<span class="normal"> 4867</span>
<span class="normal"> 4868</span>
<span class="normal"> 4869</span>
<span class="normal"> 4870</span>
<span class="normal"> 4871</span>
<span class="normal"> 4872</span>
<span class="normal"> 4873</span>
<span class="normal"> 4874</span>
<span class="normal"> 4875</span>
<span class="normal"> 4876</span>
<span class="normal"> 4877</span>
<span class="normal"> 4878</span>
<span class="normal"> 4879</span>
<span class="normal"> 4880</span>
<span class="normal"> 4881</span>
<span class="normal"> 4882</span>
<span class="normal"> 4883</span>
<span class="normal"> 4884</span>
<span class="normal"> 4885</span>
<span class="normal"> 4886</span>
<span class="normal"> 4887</span>
<span class="normal"> 4888</span>
<span class="normal"> 4889</span>
<span class="normal"> 4890</span>
<span class="normal"> 4891</span>
<span class="normal"> 4892</span>
<span class="normal"> 4893</span>
<span class="normal"> 4894</span>
<span class="normal"> 4895</span>
<span class="normal"> 4896</span>
<span class="normal"> 4897</span>
<span class="normal"> 4898</span>
<span class="normal"> 4899</span>
<span class="normal"> 4900</span>
<span class="normal"> 4901</span>
<span class="normal"> 4902</span>
<span class="normal"> 4903</span>
<span class="normal"> 4904</span>
<span class="normal"> 4905</span>
<span class="normal"> 4906</span>
<span class="normal"> 4907</span>
<span class="normal"> 4908</span>
<span class="normal"> 4909</span>
<span class="normal"> 4910</span>
<span class="normal"> 4911</span>
<span class="normal"> 4912</span>
<span class="normal"> 4913</span>
<span class="normal"> 4914</span>
<span class="normal"> 4915</span>
<span class="normal"> 4916</span>
<span class="normal"> 4917</span>
<span class="normal"> 4918</span>
<span class="normal"> 4919</span>
<span class="normal"> 4920</span>
<span class="normal"> 4921</span>
<span class="normal"> 4922</span>
<span class="normal"> 4923</span>
<span class="normal"> 4924</span>
<span class="normal"> 4925</span>
<span class="normal"> 4926</span>
<span class="normal"> 4927</span>
<span class="normal"> 4928</span>
<span class="normal"> 4929</span>
<span class="normal"> 4930</span>
<span class="normal"> 4931</span>
<span class="normal"> 4932</span>
<span class="normal"> 4933</span>
<span class="normal"> 4934</span>
<span class="normal"> 4935</span>
<span class="normal"> 4936</span>
<span class="normal"> 4937</span>
<span class="normal"> 4938</span>
<span class="normal"> 4939</span>
<span class="normal"> 4940</span>
<span class="normal"> 4941</span>
<span class="normal"> 4942</span>
<span class="normal"> 4943</span>
<span class="normal"> 4944</span>
<span class="normal"> 4945</span>
<span class="normal"> 4946</span>
<span class="normal"> 4947</span>
<span class="normal"> 4948</span>
<span class="normal"> 4949</span>
<span class="normal"> 4950</span>
<span class="normal"> 4951</span>
<span class="normal"> 4952</span>
<span class="normal"> 4953</span>
<span class="normal"> 4954</span>
<span class="normal"> 4955</span>
<span class="normal"> 4956</span>
<span class="normal"> 4957</span>
<span class="normal"> 4958</span>
<span class="normal"> 4959</span>
<span class="normal"> 4960</span>
<span class="normal"> 4961</span>
<span class="normal"> 4962</span>
<span class="normal"> 4963</span>
<span class="normal"> 4964</span>
<span class="normal"> 4965</span>
<span class="normal"> 4966</span>
<span class="normal"> 4967</span>
<span class="normal"> 4968</span>
<span class="normal"> 4969</span>
<span class="normal"> 4970</span>
<span class="normal"> 4971</span>
<span class="normal"> 4972</span>
<span class="normal"> 4973</span>
<span class="normal"> 4974</span>
<span class="normal"> 4975</span>
<span class="normal"> 4976</span>
<span class="normal"> 4977</span>
<span class="normal"> 4978</span>
<span class="normal"> 4979</span>
<span class="normal"> 4980</span>
<span class="normal"> 4981</span>
<span class="normal"> 4982</span>
<span class="normal"> 4983</span>
<span class="normal"> 4984</span>
<span class="normal"> 4985</span>
<span class="normal"> 4986</span>
<span class="normal"> 4987</span>
<span class="normal"> 4988</span>
<span class="normal"> 4989</span>
<span class="normal"> 4990</span>
<span class="normal"> 4991</span>
<span class="normal"> 4992</span>
<span class="normal"> 4993</span>
<span class="normal"> 4994</span>
<span class="normal"> 4995</span>
<span class="normal"> 4996</span>
<span class="normal"> 4997</span>
<span class="normal"> 4998</span>
<span class="normal"> 4999</span>
<span class="normal"> 5000</span>
<span class="normal"> 5001</span>
<span class="normal"> 5002</span>
<span class="normal"> 5003</span>
<span class="normal"> 5004</span>
<span class="normal"> 5005</span>
<span class="normal"> 5006</span>
<span class="normal"> 5007</span>
<span class="normal"> 5008</span>
<span class="normal"> 5009</span>
<span class="normal"> 5010</span>
<span class="normal"> 5011</span>
<span class="normal"> 5012</span>
<span class="normal"> 5013</span>
<span class="normal"> 5014</span>
<span class="normal"> 5015</span>
<span class="normal"> 5016</span>
<span class="normal"> 5017</span>
<span class="normal"> 5018</span>
<span class="normal"> 5019</span>
<span class="normal"> 5020</span>
<span class="normal"> 5021</span>
<span class="normal"> 5022</span>
<span class="normal"> 5023</span>
<span class="normal"> 5024</span>
<span class="normal"> 5025</span>
<span class="normal"> 5026</span>
<span class="normal"> 5027</span>
<span class="normal"> 5028</span>
<span class="normal"> 5029</span>
<span class="normal"> 5030</span>
<span class="normal"> 5031</span>
<span class="normal"> 5032</span>
<span class="normal"> 5033</span>
<span class="normal"> 5034</span>
<span class="normal"> 5035</span>
<span class="normal"> 5036</span>
<span class="normal"> 5037</span>
<span class="normal"> 5038</span>
<span class="normal"> 5039</span>
<span class="normal"> 5040</span>
<span class="normal"> 5041</span>
<span class="normal"> 5042</span>
<span class="normal"> 5043</span>
<span class="normal"> 5044</span>
<span class="normal"> 5045</span>
<span class="normal"> 5046</span>
<span class="normal"> 5047</span>
<span class="normal"> 5048</span>
<span class="normal"> 5049</span>
<span class="normal"> 5050</span>
<span class="normal"> 5051</span>
<span class="normal"> 5052</span>
<span class="normal"> 5053</span>
<span class="normal"> 5054</span>
<span class="normal"> 5055</span>
<span class="normal"> 5056</span>
<span class="normal"> 5057</span>
<span class="normal"> 5058</span>
<span class="normal"> 5059</span>
<span class="normal"> 5060</span>
<span class="normal"> 5061</span>
<span class="normal"> 5062</span>
<span class="normal"> 5063</span>
<span class="normal"> 5064</span>
<span class="normal"> 5065</span>
<span class="normal"> 5066</span>
<span class="normal"> 5067</span>
<span class="normal"> 5068</span>
<span class="normal"> 5069</span>
<span class="normal"> 5070</span>
<span class="normal"> 5071</span>
<span class="normal"> 5072</span>
<span class="normal"> 5073</span>
<span class="normal"> 5074</span>
<span class="normal"> 5075</span>
<span class="normal"> 5076</span>
<span class="normal"> 5077</span>
<span class="normal"> 5078</span>
<span class="normal"> 5079</span>
<span class="normal"> 5080</span>
<span class="normal"> 5081</span>
<span class="normal"> 5082</span>
<span class="normal"> 5083</span>
<span class="normal"> 5084</span>
<span class="normal"> 5085</span>
<span class="normal"> 5086</span>
<span class="normal"> 5087</span>
<span class="normal"> 5088</span>
<span class="normal"> 5089</span>
<span class="normal"> 5090</span>
<span class="normal"> 5091</span>
<span class="normal"> 5092</span>
<span class="normal"> 5093</span>
<span class="normal"> 5094</span>
<span class="normal"> 5095</span>
<span class="normal"> 5096</span>
<span class="normal"> 5097</span>
<span class="normal"> 5098</span>
<span class="normal"> 5099</span>
<span class="normal"> 5100</span>
<span class="normal"> 5101</span>
<span class="normal"> 5102</span>
<span class="normal"> 5103</span>
<span class="normal"> 5104</span>
<span class="normal"> 5105</span>
<span class="normal"> 5106</span>
<span class="normal"> 5107</span>
<span class="normal"> 5108</span>
<span class="normal"> 5109</span>
<span class="normal"> 5110</span>
<span class="normal"> 5111</span>
<span class="normal"> 5112</span>
<span class="normal"> 5113</span>
<span class="normal"> 5114</span>
<span class="normal"> 5115</span>
<span class="normal"> 5116</span>
<span class="normal"> 5117</span>
<span class="normal"> 5118</span>
<span class="normal"> 5119</span>
<span class="normal"> 5120</span>
<span class="normal"> 5121</span>
<span class="normal"> 5122</span>
<span class="normal"> 5123</span>
<span class="normal"> 5124</span>
<span class="normal"> 5125</span>
<span class="normal"> 5126</span>
<span class="normal"> 5127</span>
<span class="normal"> 5128</span>
<span class="normal"> 5129</span>
<span class="normal"> 5130</span>
<span class="normal"> 5131</span>
<span class="normal"> 5132</span>
<span class="normal"> 5133</span>
<span class="normal"> 5134</span>
<span class="normal"> 5135</span>
<span class="normal"> 5136</span>
<span class="normal"> 5137</span>
<span class="normal"> 5138</span>
<span class="normal"> 5139</span>
<span class="normal"> 5140</span>
<span class="normal"> 5141</span>
<span class="normal"> 5142</span>
<span class="normal"> 5143</span>
<span class="normal"> 5144</span>
<span class="normal"> 5145</span>
<span class="normal"> 5146</span>
<span class="normal"> 5147</span>
<span class="normal"> 5148</span>
<span class="normal"> 5149</span>
<span class="normal"> 5150</span>
<span class="normal"> 5151</span>
<span class="normal"> 5152</span>
<span class="normal"> 5153</span>
<span class="normal"> 5154</span>
<span class="normal"> 5155</span>
<span class="normal"> 5156</span>
<span class="normal"> 5157</span>
<span class="normal"> 5158</span>
<span class="normal"> 5159</span>
<span class="normal"> 5160</span>
<span class="normal"> 5161</span>
<span class="normal"> 5162</span>
<span class="normal"> 5163</span>
<span class="normal"> 5164</span>
<span class="normal"> 5165</span>
<span class="normal"> 5166</span>
<span class="normal"> 5167</span>
<span class="normal"> 5168</span>
<span class="normal"> 5169</span>
<span class="normal"> 5170</span>
<span class="normal"> 5171</span>
<span class="normal"> 5172</span>
<span class="normal"> 5173</span>
<span class="normal"> 5174</span>
<span class="normal"> 5175</span>
<span class="normal"> 5176</span>
<span class="normal"> 5177</span>
<span class="normal"> 5178</span>
<span class="normal"> 5179</span>
<span class="normal"> 5180</span>
<span class="normal"> 5181</span>
<span class="normal"> 5182</span>
<span class="normal"> 5183</span>
<span class="normal"> 5184</span>
<span class="normal"> 5185</span>
<span class="normal"> 5186</span>
<span class="normal"> 5187</span>
<span class="normal"> 5188</span>
<span class="normal"> 5189</span>
<span class="normal"> 5190</span>
<span class="normal"> 5191</span>
<span class="normal"> 5192</span>
<span class="normal"> 5193</span>
<span class="normal"> 5194</span>
<span class="normal"> 5195</span>
<span class="normal"> 5196</span>
<span class="normal"> 5197</span>
<span class="normal"> 5198</span>
<span class="normal"> 5199</span>
<span class="normal"> 5200</span>
<span class="normal"> 5201</span>
<span class="normal"> 5202</span>
<span class="normal"> 5203</span>
<span class="normal"> 5204</span>
<span class="normal"> 5205</span>
<span class="normal"> 5206</span>
<span class="normal"> 5207</span>
<span class="normal"> 5208</span>
<span class="normal"> 5209</span>
<span class="normal"> 5210</span>
<span class="normal"> 5211</span>
<span class="normal"> 5212</span>
<span class="normal"> 5213</span>
<span class="normal"> 5214</span>
<span class="normal"> 5215</span>
<span class="normal"> 5216</span>
<span class="normal"> 5217</span>
<span class="normal"> 5218</span>
<span class="normal"> 5219</span>
<span class="normal"> 5220</span>
<span class="normal"> 5221</span>
<span class="normal"> 5222</span>
<span class="normal"> 5223</span>
<span class="normal"> 5224</span>
<span class="normal"> 5225</span>
<span class="normal"> 5226</span>
<span class="normal"> 5227</span>
<span class="normal"> 5228</span>
<span class="normal"> 5229</span>
<span class="normal"> 5230</span>
<span class="normal"> 5231</span>
<span class="normal"> 5232</span>
<span class="normal"> 5233</span>
<span class="normal"> 5234</span>
<span class="normal"> 5235</span>
<span class="normal"> 5236</span>
<span class="normal"> 5237</span>
<span class="normal"> 5238</span>
<span class="normal"> 5239</span>
<span class="normal"> 5240</span>
<span class="normal"> 5241</span>
<span class="normal"> 5242</span>
<span class="normal"> 5243</span>
<span class="normal"> 5244</span>
<span class="normal"> 5245</span>
<span class="normal"> 5246</span>
<span class="normal"> 5247</span>
<span class="normal"> 5248</span>
<span class="normal"> 5249</span>
<span class="normal"> 5250</span>
<span class="normal"> 5251</span>
<span class="normal"> 5252</span>
<span class="normal"> 5253</span>
<span class="normal"> 5254</span>
<span class="normal"> 5255</span>
<span class="normal"> 5256</span>
<span class="normal"> 5257</span>
<span class="normal"> 5258</span>
<span class="normal"> 5259</span>
<span class="normal"> 5260</span>
<span class="normal"> 5261</span>
<span class="normal"> 5262</span>
<span class="normal"> 5263</span>
<span class="normal"> 5264</span>
<span class="normal"> 5265</span>
<span class="normal"> 5266</span>
<span class="normal"> 5267</span>
<span class="normal"> 5268</span>
<span class="normal"> 5269</span>
<span class="normal"> 5270</span>
<span class="normal"> 5271</span>
<span class="normal"> 5272</span>
<span class="normal"> 5273</span>
<span class="normal"> 5274</span>
<span class="normal"> 5275</span>
<span class="normal"> 5276</span>
<span class="normal"> 5277</span>
<span class="normal"> 5278</span>
<span class="normal"> 5279</span>
<span class="normal"> 5280</span>
<span class="normal"> 5281</span>
<span class="normal"> 5282</span>
<span class="normal"> 5283</span>
<span class="normal"> 5284</span>
<span class="normal"> 5285</span>
<span class="normal"> 5286</span>
<span class="normal"> 5287</span>
<span class="normal"> 5288</span>
<span class="normal"> 5289</span>
<span class="normal"> 5290</span>
<span class="normal"> 5291</span>
<span class="normal"> 5292</span>
<span class="normal"> 5293</span>
<span class="normal"> 5294</span>
<span class="normal"> 5295</span>
<span class="normal"> 5296</span>
<span class="normal"> 5297</span>
<span class="normal"> 5298</span>
<span class="normal"> 5299</span>
<span class="normal"> 5300</span>
<span class="normal"> 5301</span>
<span class="normal"> 5302</span>
<span class="normal"> 5303</span>
<span class="normal"> 5304</span>
<span class="normal"> 5305</span>
<span class="normal"> 5306</span>
<span class="normal"> 5307</span>
<span class="normal"> 5308</span>
<span class="normal"> 5309</span>
<span class="normal"> 5310</span>
<span class="normal"> 5311</span>
<span class="normal"> 5312</span>
<span class="normal"> 5313</span>
<span class="normal"> 5314</span>
<span class="normal"> 5315</span>
<span class="normal"> 5316</span>
<span class="normal"> 5317</span>
<span class="normal"> 5318</span>
<span class="normal"> 5319</span>
<span class="normal"> 5320</span>
<span class="normal"> 5321</span>
<span class="normal"> 5322</span>
<span class="normal"> 5323</span>
<span class="normal"> 5324</span>
<span class="normal"> 5325</span>
<span class="normal"> 5326</span>
<span class="normal"> 5327</span>
<span class="normal"> 5328</span>
<span class="normal"> 5329</span>
<span class="normal"> 5330</span>
<span class="normal"> 5331</span>
<span class="normal"> 5332</span>
<span class="normal"> 5333</span>
<span class="normal"> 5334</span>
<span class="normal"> 5335</span>
<span class="normal"> 5336</span>
<span class="normal"> 5337</span>
<span class="normal"> 5338</span>
<span class="normal"> 5339</span>
<span class="normal"> 5340</span>
<span class="normal"> 5341</span>
<span class="normal"> 5342</span>
<span class="normal"> 5343</span>
<span class="normal"> 5344</span>
<span class="normal"> 5345</span>
<span class="normal"> 5346</span>
<span class="normal"> 5347</span>
<span class="normal"> 5348</span>
<span class="normal"> 5349</span>
<span class="normal"> 5350</span>
<span class="normal"> 5351</span>
<span class="normal"> 5352</span>
<span class="normal"> 5353</span>
<span class="normal"> 5354</span>
<span class="normal"> 5355</span>
<span class="normal"> 5356</span>
<span class="normal"> 5357</span>
<span class="normal"> 5358</span>
<span class="normal"> 5359</span>
<span class="normal"> 5360</span>
<span class="normal"> 5361</span>
<span class="normal"> 5362</span>
<span class="normal"> 5363</span>
<span class="normal"> 5364</span>
<span class="normal"> 5365</span>
<span class="normal"> 5366</span>
<span class="normal"> 5367</span>
<span class="normal"> 5368</span>
<span class="normal"> 5369</span>
<span class="normal"> 5370</span>
<span class="normal"> 5371</span>
<span class="normal"> 5372</span>
<span class="normal"> 5373</span>
<span class="normal"> 5374</span>
<span class="normal"> 5375</span>
<span class="normal"> 5376</span>
<span class="normal"> 5377</span>
<span class="normal"> 5378</span>
<span class="normal"> 5379</span>
<span class="normal"> 5380</span>
<span class="normal"> 5381</span>
<span class="normal"> 5382</span>
<span class="normal"> 5383</span>
<span class="normal"> 5384</span>
<span class="normal"> 5385</span>
<span class="normal"> 5386</span>
<span class="normal"> 5387</span>
<span class="normal"> 5388</span>
<span class="normal"> 5389</span>
<span class="normal"> 5390</span>
<span class="normal"> 5391</span>
<span class="normal"> 5392</span>
<span class="normal"> 5393</span>
<span class="normal"> 5394</span>
<span class="normal"> 5395</span>
<span class="normal"> 5396</span>
<span class="normal"> 5397</span>
<span class="normal"> 5398</span>
<span class="normal"> 5399</span>
<span class="normal"> 5400</span>
<span class="normal"> 5401</span>
<span class="normal"> 5402</span>
<span class="normal"> 5403</span>
<span class="normal"> 5404</span>
<span class="normal"> 5405</span>
<span class="normal"> 5406</span>
<span class="normal"> 5407</span>
<span class="normal"> 5408</span>
<span class="normal"> 5409</span>
<span class="normal"> 5410</span>
<span class="normal"> 5411</span>
<span class="normal"> 5412</span>
<span class="normal"> 5413</span>
<span class="normal"> 5414</span>
<span class="normal"> 5415</span>
<span class="normal"> 5416</span>
<span class="normal"> 5417</span>
<span class="normal"> 5418</span>
<span class="normal"> 5419</span>
<span class="normal"> 5420</span>
<span class="normal"> 5421</span>
<span class="normal"> 5422</span>
<span class="normal"> 5423</span>
<span class="normal"> 5424</span>
<span class="normal"> 5425</span>
<span class="normal"> 5426</span>
<span class="normal"> 5427</span>
<span class="normal"> 5428</span>
<span class="normal"> 5429</span>
<span class="normal"> 5430</span>
<span class="normal"> 5431</span>
<span class="normal"> 5432</span>
<span class="normal"> 5433</span>
<span class="normal"> 5434</span>
<span class="normal"> 5435</span>
<span class="normal"> 5436</span>
<span class="normal"> 5437</span>
<span class="normal"> 5438</span>
<span class="normal"> 5439</span>
<span class="normal"> 5440</span>
<span class="normal"> 5441</span>
<span class="normal"> 5442</span>
<span class="normal"> 5443</span>
<span class="normal"> 5444</span>
<span class="normal"> 5445</span>
<span class="normal"> 5446</span>
<span class="normal"> 5447</span>
<span class="normal"> 5448</span>
<span class="normal"> 5449</span>
<span class="normal"> 5450</span>
<span class="normal"> 5451</span>
<span class="normal"> 5452</span>
<span class="normal"> 5453</span>
<span class="normal"> 5454</span>
<span class="normal"> 5455</span>
<span class="normal"> 5456</span>
<span class="normal"> 5457</span>
<span class="normal"> 5458</span>
<span class="normal"> 5459</span>
<span class="normal"> 5460</span>
<span class="normal"> 5461</span>
<span class="normal"> 5462</span>
<span class="normal"> 5463</span>
<span class="normal"> 5464</span>
<span class="normal"> 5465</span>
<span class="normal"> 5466</span>
<span class="normal"> 5467</span>
<span class="normal"> 5468</span>
<span class="normal"> 5469</span>
<span class="normal"> 5470</span>
<span class="normal"> 5471</span>
<span class="normal"> 5472</span>
<span class="normal"> 5473</span>
<span class="normal"> 5474</span>
<span class="normal"> 5475</span>
<span class="normal"> 5476</span>
<span class="normal"> 5477</span>
<span class="normal"> 5478</span>
<span class="normal"> 5479</span>
<span class="normal"> 5480</span>
<span class="normal"> 5481</span>
<span class="normal"> 5482</span>
<span class="normal"> 5483</span>
<span class="normal"> 5484</span>
<span class="normal"> 5485</span>
<span class="normal"> 5486</span>
<span class="normal"> 5487</span>
<span class="normal"> 5488</span>
<span class="normal"> 5489</span>
<span class="normal"> 5490</span>
<span class="normal"> 5491</span>
<span class="normal"> 5492</span>
<span class="normal"> 5493</span>
<span class="normal"> 5494</span>
<span class="normal"> 5495</span>
<span class="normal"> 5496</span>
<span class="normal"> 5497</span>
<span class="normal"> 5498</span>
<span class="normal"> 5499</span>
<span class="normal"> 5500</span>
<span class="normal"> 5501</span>
<span class="normal"> 5502</span>
<span class="normal"> 5503</span>
<span class="normal"> 5504</span>
<span class="normal"> 5505</span>
<span class="normal"> 5506</span>
<span class="normal"> 5507</span>
<span class="normal"> 5508</span>
<span class="normal"> 5509</span>
<span class="normal"> 5510</span>
<span class="normal"> 5511</span>
<span class="normal"> 5512</span>
<span class="normal"> 5513</span>
<span class="normal"> 5514</span>
<span class="normal"> 5515</span>
<span class="normal"> 5516</span>
<span class="normal"> 5517</span>
<span class="normal"> 5518</span>
<span class="normal"> 5519</span>
<span class="normal"> 5520</span>
<span class="normal"> 5521</span>
<span class="normal"> 5522</span>
<span class="normal"> 5523</span>
<span class="normal"> 5524</span>
<span class="normal"> 5525</span>
<span class="normal"> 5526</span>
<span class="normal"> 5527</span>
<span class="normal"> 5528</span>
<span class="normal"> 5529</span>
<span class="normal"> 5530</span>
<span class="normal"> 5531</span>
<span class="normal"> 5532</span>
<span class="normal"> 5533</span>
<span class="normal"> 5534</span>
<span class="normal"> 5535</span>
<span class="normal"> 5536</span>
<span class="normal"> 5537</span>
<span class="normal"> 5538</span>
<span class="normal"> 5539</span>
<span class="normal"> 5540</span>
<span class="normal"> 5541</span>
<span class="normal"> 5542</span>
<span class="normal"> 5543</span>
<span class="normal"> 5544</span>
<span class="normal"> 5545</span>
<span class="normal"> 5546</span>
<span class="normal"> 5547</span>
<span class="normal"> 5548</span>
<span class="normal"> 5549</span>
<span class="normal"> 5550</span>
<span class="normal"> 5551</span>
<span class="normal"> 5552</span>
<span class="normal"> 5553</span>
<span class="normal"> 5554</span>
<span class="normal"> 5555</span>
<span class="normal"> 5556</span>
<span class="normal"> 5557</span>
<span class="normal"> 5558</span>
<span class="normal"> 5559</span>
<span class="normal"> 5560</span>
<span class="normal"> 5561</span>
<span class="normal"> 5562</span>
<span class="normal"> 5563</span>
<span class="normal"> 5564</span>
<span class="normal"> 5565</span>
<span class="normal"> 5566</span>
<span class="normal"> 5567</span>
<span class="normal"> 5568</span>
<span class="normal"> 5569</span>
<span class="normal"> 5570</span>
<span class="normal"> 5571</span>
<span class="normal"> 5572</span>
<span class="normal"> 5573</span>
<span class="normal"> 5574</span>
<span class="normal"> 5575</span>
<span class="normal"> 5576</span>
<span class="normal"> 5577</span>
<span class="normal"> 5578</span>
<span class="normal"> 5579</span>
<span class="normal"> 5580</span>
<span class="normal"> 5581</span>
<span class="normal"> 5582</span>
<span class="normal"> 5583</span>
<span class="normal"> 5584</span>
<span class="normal"> 5585</span>
<span class="normal"> 5586</span>
<span class="normal"> 5587</span>
<span class="normal"> 5588</span>
<span class="normal"> 5589</span>
<span class="normal"> 5590</span>
<span class="normal"> 5591</span>
<span class="normal"> 5592</span>
<span class="normal"> 5593</span>
<span class="normal"> 5594</span>
<span class="normal"> 5595</span>
<span class="normal"> 5596</span>
<span class="normal"> 5597</span>
<span class="normal"> 5598</span>
<span class="normal"> 5599</span>
<span class="normal"> 5600</span>
<span class="normal"> 5601</span>
<span class="normal"> 5602</span>
<span class="normal"> 5603</span>
<span class="normal"> 5604</span>
<span class="normal"> 5605</span>
<span class="normal"> 5606</span>
<span class="normal"> 5607</span>
<span class="normal"> 5608</span>
<span class="normal"> 5609</span>
<span class="normal"> 5610</span>
<span class="normal"> 5611</span>
<span class="normal"> 5612</span>
<span class="normal"> 5613</span>
<span class="normal"> 5614</span>
<span class="normal"> 5615</span>
<span class="normal"> 5616</span>
<span class="normal"> 5617</span>
<span class="normal"> 5618</span>
<span class="normal"> 5619</span>
<span class="normal"> 5620</span>
<span class="normal"> 5621</span>
<span class="normal"> 5622</span>
<span class="normal"> 5623</span>
<span class="normal"> 5624</span>
<span class="normal"> 5625</span>
<span class="normal"> 5626</span>
<span class="normal"> 5627</span>
<span class="normal"> 5628</span>
<span class="normal"> 5629</span>
<span class="normal"> 5630</span>
<span class="normal"> 5631</span>
<span class="normal"> 5632</span>
<span class="normal"> 5633</span>
<span class="normal"> 5634</span>
<span class="normal"> 5635</span>
<span class="normal"> 5636</span>
<span class="normal"> 5637</span>
<span class="normal"> 5638</span>
<span class="normal"> 5639</span>
<span class="normal"> 5640</span>
<span class="normal"> 5641</span>
<span class="normal"> 5642</span>
<span class="normal"> 5643</span>
<span class="normal"> 5644</span>
<span class="normal"> 5645</span>
<span class="normal"> 5646</span>
<span class="normal"> 5647</span>
<span class="normal"> 5648</span>
<span class="normal"> 5649</span>
<span class="normal"> 5650</span>
<span class="normal"> 5651</span>
<span class="normal"> 5652</span>
<span class="normal"> 5653</span>
<span class="normal"> 5654</span>
<span class="normal"> 5655</span>
<span class="normal"> 5656</span>
<span class="normal"> 5657</span>
<span class="normal"> 5658</span>
<span class="normal"> 5659</span>
<span class="normal"> 5660</span>
<span class="normal"> 5661</span>
<span class="normal"> 5662</span>
<span class="normal"> 5663</span>
<span class="normal"> 5664</span>
<span class="normal"> 5665</span>
<span class="normal"> 5666</span>
<span class="normal"> 5667</span>
<span class="normal"> 5668</span>
<span class="normal"> 5669</span>
<span class="normal"> 5670</span>
<span class="normal"> 5671</span>
<span class="normal"> 5672</span>
<span class="normal"> 5673</span>
<span class="normal"> 5674</span>
<span class="normal"> 5675</span>
<span class="normal"> 5676</span>
<span class="normal"> 5677</span>
<span class="normal"> 5678</span>
<span class="normal"> 5679</span>
<span class="normal"> 5680</span>
<span class="normal"> 5681</span>
<span class="normal"> 5682</span>
<span class="normal"> 5683</span>
<span class="normal"> 5684</span>
<span class="normal"> 5685</span>
<span class="normal"> 5686</span>
<span class="normal"> 5687</span>
<span class="normal"> 5688</span>
<span class="normal"> 5689</span>
<span class="normal"> 5690</span>
<span class="normal"> 5691</span>
<span class="normal"> 5692</span>
<span class="normal"> 5693</span>
<span class="normal"> 5694</span>
<span class="normal"> 5695</span>
<span class="normal"> 5696</span>
<span class="normal"> 5697</span>
<span class="normal"> 5698</span>
<span class="normal"> 5699</span>
<span class="normal"> 5700</span>
<span class="normal"> 5701</span>
<span class="normal"> 5702</span>
<span class="normal"> 5703</span>
<span class="normal"> 5704</span>
<span class="normal"> 5705</span>
<span class="normal"> 5706</span>
<span class="normal"> 5707</span>
<span class="normal"> 5708</span>
<span class="normal"> 5709</span>
<span class="normal"> 5710</span>
<span class="normal"> 5711</span>
<span class="normal"> 5712</span>
<span class="normal"> 5713</span>
<span class="normal"> 5714</span>
<span class="normal"> 5715</span>
<span class="normal"> 5716</span>
<span class="normal"> 5717</span>
<span class="normal"> 5718</span>
<span class="normal"> 5719</span>
<span class="normal"> 5720</span>
<span class="normal"> 5721</span>
<span class="normal"> 5722</span>
<span class="normal"> 5723</span>
<span class="normal"> 5724</span>
<span class="normal"> 5725</span>
<span class="normal"> 5726</span>
<span class="normal"> 5727</span>
<span class="normal"> 5728</span>
<span class="normal"> 5729</span>
<span class="normal"> 5730</span>
<span class="normal"> 5731</span>
<span class="normal"> 5732</span>
<span class="normal"> 5733</span>
<span class="normal"> 5734</span>
<span class="normal"> 5735</span>
<span class="normal"> 5736</span>
<span class="normal"> 5737</span>
<span class="normal"> 5738</span>
<span class="normal"> 5739</span>
<span class="normal"> 5740</span>
<span class="normal"> 5741</span>
<span class="normal"> 5742</span>
<span class="normal"> 5743</span>
<span class="normal"> 5744</span>
<span class="normal"> 5745</span>
<span class="normal"> 5746</span>
<span class="normal"> 5747</span>
<span class="normal"> 5748</span>
<span class="normal"> 5749</span>
<span class="normal"> 5750</span>
<span class="normal"> 5751</span>
<span class="normal"> 5752</span>
<span class="normal"> 5753</span>
<span class="normal"> 5754</span>
<span class="normal"> 5755</span>
<span class="normal"> 5756</span>
<span class="normal"> 5757</span>
<span class="normal"> 5758</span>
<span class="normal"> 5759</span>
<span class="normal"> 5760</span>
<span class="normal"> 5761</span>
<span class="normal"> 5762</span>
<span class="normal"> 5763</span>
<span class="normal"> 5764</span>
<span class="normal"> 5765</span>
<span class="normal"> 5766</span>
<span class="normal"> 5767</span>
<span class="normal"> 5768</span>
<span class="normal"> 5769</span>
<span class="normal"> 5770</span>
<span class="normal"> 5771</span>
<span class="normal"> 5772</span>
<span class="normal"> 5773</span>
<span class="normal"> 5774</span>
<span class="normal"> 5775</span>
<span class="normal"> 5776</span>
<span class="normal"> 5777</span>
<span class="normal"> 5778</span>
<span class="normal"> 5779</span>
<span class="normal"> 5780</span>
<span class="normal"> 5781</span>
<span class="normal"> 5782</span>
<span class="normal"> 5783</span>
<span class="normal"> 5784</span>
<span class="normal"> 5785</span>
<span class="normal"> 5786</span>
<span class="normal"> 5787</span>
<span class="normal"> 5788</span>
<span class="normal"> 5789</span>
<span class="normal"> 5790</span>
<span class="normal"> 5791</span>
<span class="normal"> 5792</span>
<span class="normal"> 5793</span>
<span class="normal"> 5794</span>
<span class="normal"> 5795</span>
<span class="normal"> 5796</span>
<span class="normal"> 5797</span>
<span class="normal"> 5798</span>
<span class="normal"> 5799</span>
<span class="normal"> 5800</span>
<span class="normal"> 5801</span>
<span class="normal"> 5802</span>
<span class="normal"> 5803</span>
<span class="normal"> 5804</span>
<span class="normal"> 5805</span>
<span class="normal"> 5806</span>
<span class="normal"> 5807</span>
<span class="normal"> 5808</span>
<span class="normal"> 5809</span>
<span class="normal"> 5810</span>
<span class="normal"> 5811</span>
<span class="normal"> 5812</span>
<span class="normal"> 5813</span>
<span class="normal"> 5814</span>
<span class="normal"> 5815</span>
<span class="normal"> 5816</span>
<span class="normal"> 5817</span>
<span class="normal"> 5818</span>
<span class="normal"> 5819</span>
<span class="normal"> 5820</span>
<span class="normal"> 5821</span>
<span class="normal"> 5822</span>
<span class="normal"> 5823</span>
<span class="normal"> 5824</span>
<span class="normal"> 5825</span>
<span class="normal"> 5826</span>
<span class="normal"> 5827</span>
<span class="normal"> 5828</span>
<span class="normal"> 5829</span>
<span class="normal"> 5830</span>
<span class="normal"> 5831</span>
<span class="normal"> 5832</span>
<span class="normal"> 5833</span>
<span class="normal"> 5834</span>
<span class="normal"> 5835</span>
<span class="normal"> 5836</span>
<span class="normal"> 5837</span>
<span class="normal"> 5838</span>
<span class="normal"> 5839</span>
<span class="normal"> 5840</span>
<span class="normal"> 5841</span>
<span class="normal"> 5842</span>
<span class="normal"> 5843</span>
<span class="normal"> 5844</span>
<span class="normal"> 5845</span>
<span class="normal"> 5846</span>
<span class="normal"> 5847</span>
<span class="normal"> 5848</span>
<span class="normal"> 5849</span>
<span class="normal"> 5850</span>
<span class="normal"> 5851</span>
<span class="normal"> 5852</span>
<span class="normal"> 5853</span>
<span class="normal"> 5854</span>
<span class="normal"> 5855</span>
<span class="normal"> 5856</span>
<span class="normal"> 5857</span>
<span class="normal"> 5858</span>
<span class="normal"> 5859</span>
<span class="normal"> 5860</span>
<span class="normal"> 5861</span>
<span class="normal"> 5862</span>
<span class="normal"> 5863</span>
<span class="normal"> 5864</span>
<span class="normal"> 5865</span>
<span class="normal"> 5866</span>
<span class="normal"> 5867</span>
<span class="normal"> 5868</span>
<span class="normal"> 5869</span>
<span class="normal"> 5870</span>
<span class="normal"> 5871</span>
<span class="normal"> 5872</span>
<span class="normal"> 5873</span>
<span class="normal"> 5874</span>
<span class="normal"> 5875</span>
<span class="normal"> 5876</span>
<span class="normal"> 5877</span>
<span class="normal"> 5878</span>
<span class="normal"> 5879</span>
<span class="normal"> 5880</span>
<span class="normal"> 5881</span>
<span class="normal"> 5882</span>
<span class="normal"> 5883</span>
<span class="normal"> 5884</span>
<span class="normal"> 5885</span>
<span class="normal"> 5886</span>
<span class="normal"> 5887</span>
<span class="normal"> 5888</span>
<span class="normal"> 5889</span>
<span class="normal"> 5890</span>
<span class="normal"> 5891</span>
<span class="normal"> 5892</span>
<span class="normal"> 5893</span>
<span class="normal"> 5894</span>
<span class="normal"> 5895</span>
<span class="normal"> 5896</span>
<span class="normal"> 5897</span>
<span class="normal"> 5898</span>
<span class="normal"> 5899</span>
<span class="normal"> 5900</span>
<span class="normal"> 5901</span>
<span class="normal"> 5902</span>
<span class="normal"> 5903</span>
<span class="normal"> 5904</span>
<span class="normal"> 5905</span>
<span class="normal"> 5906</span>
<span class="normal"> 5907</span>
<span class="normal"> 5908</span>
<span class="normal"> 5909</span>
<span class="normal"> 5910</span>
<span class="normal"> 5911</span>
<span class="normal"> 5912</span>
<span class="normal"> 5913</span>
<span class="normal"> 5914</span>
<span class="normal"> 5915</span>
<span class="normal"> 5916</span>
<span class="normal"> 5917</span>
<span class="normal"> 5918</span>
<span class="normal"> 5919</span>
<span class="normal"> 5920</span>
<span class="normal"> 5921</span>
<span class="normal"> 5922</span>
<span class="normal"> 5923</span>
<span class="normal"> 5924</span>
<span class="normal"> 5925</span>
<span class="normal"> 5926</span>
<span class="normal"> 5927</span>
<span class="normal"> 5928</span>
<span class="normal"> 5929</span>
<span class="normal"> 5930</span>
<span class="normal"> 5931</span>
<span class="normal"> 5932</span>
<span class="normal"> 5933</span>
<span class="normal"> 5934</span>
<span class="normal"> 5935</span>
<span class="normal"> 5936</span>
<span class="normal"> 5937</span>
<span class="normal"> 5938</span>
<span class="normal"> 5939</span>
<span class="normal"> 5940</span>
<span class="normal"> 5941</span>
<span class="normal"> 5942</span>
<span class="normal"> 5943</span>
<span class="normal"> 5944</span>
<span class="normal"> 5945</span>
<span class="normal"> 5946</span>
<span class="normal"> 5947</span>
<span class="normal"> 5948</span>
<span class="normal"> 5949</span>
<span class="normal"> 5950</span>
<span class="normal"> 5951</span>
<span class="normal"> 5952</span>
<span class="normal"> 5953</span>
<span class="normal"> 5954</span>
<span class="normal"> 5955</span>
<span class="normal"> 5956</span>
<span class="normal"> 5957</span>
<span class="normal"> 5958</span>
<span class="normal"> 5959</span>
<span class="normal"> 5960</span>
<span class="normal"> 5961</span>
<span class="normal"> 5962</span>
<span class="normal"> 5963</span>
<span class="normal"> 5964</span>
<span class="normal"> 5965</span>
<span class="normal"> 5966</span>
<span class="normal"> 5967</span>
<span class="normal"> 5968</span>
<span class="normal"> 5969</span>
<span class="normal"> 5970</span>
<span class="normal"> 5971</span>
<span class="normal"> 5972</span>
<span class="normal"> 5973</span>
<span class="normal"> 5974</span>
<span class="normal"> 5975</span>
<span class="normal"> 5976</span>
<span class="normal"> 5977</span>
<span class="normal"> 5978</span>
<span class="normal"> 5979</span>
<span class="normal"> 5980</span>
<span class="normal"> 5981</span>
<span class="normal"> 5982</span>
<span class="normal"> 5983</span>
<span class="normal"> 5984</span>
<span class="normal"> 5985</span>
<span class="normal"> 5986</span>
<span class="normal"> 5987</span>
<span class="normal"> 5988</span>
<span class="normal"> 5989</span>
<span class="normal"> 5990</span>
<span class="normal"> 5991</span>
<span class="normal"> 5992</span>
<span class="normal"> 5993</span>
<span class="normal"> 5994</span>
<span class="normal"> 5995</span>
<span class="normal"> 5996</span>
<span class="normal"> 5997</span>
<span class="normal"> 5998</span>
<span class="normal"> 5999</span>
<span class="normal"> 6000</span>
<span class="normal"> 6001</span>
<span class="normal"> 6002</span>
<span class="normal"> 6003</span>
<span class="normal"> 6004</span>
<span class="normal"> 6005</span>
<span class="normal"> 6006</span>
<span class="normal"> 6007</span>
<span class="normal"> 6008</span>
<span class="normal"> 6009</span>
<span class="normal"> 6010</span>
<span class="normal"> 6011</span>
<span class="normal"> 6012</span>
<span class="normal"> 6013</span>
<span class="normal"> 6014</span>
<span class="normal"> 6015</span>
<span class="normal"> 6016</span>
<span class="normal"> 6017</span>
<span class="normal"> 6018</span>
<span class="normal"> 6019</span>
<span class="normal"> 6020</span>
<span class="normal"> 6021</span>
<span class="normal"> 6022</span>
<span class="normal"> 6023</span>
<span class="normal"> 6024</span>
<span class="normal"> 6025</span>
<span class="normal"> 6026</span>
<span class="normal"> 6027</span>
<span class="normal"> 6028</span>
<span class="normal"> 6029</span>
<span class="normal"> 6030</span>
<span class="normal"> 6031</span>
<span class="normal"> 6032</span>
<span class="normal"> 6033</span>
<span class="normal"> 6034</span>
<span class="normal"> 6035</span>
<span class="normal"> 6036</span>
<span class="normal"> 6037</span>
<span class="normal"> 6038</span>
<span class="normal"> 6039</span>
<span class="normal"> 6040</span>
<span class="normal"> 6041</span>
<span class="normal"> 6042</span>
<span class="normal"> 6043</span>
<span class="normal"> 6044</span>
<span class="normal"> 6045</span>
<span class="normal"> 6046</span>
<span class="normal"> 6047</span>
<span class="normal"> 6048</span>
<span class="normal"> 6049</span>
<span class="normal"> 6050</span>
<span class="normal"> 6051</span>
<span class="normal"> 6052</span>
<span class="normal"> 6053</span>
<span class="normal"> 6054</span>
<span class="normal"> 6055</span>
<span class="normal"> 6056</span>
<span class="normal"> 6057</span>
<span class="normal"> 6058</span>
<span class="normal"> 6059</span>
<span class="normal"> 6060</span>
<span class="normal"> 6061</span>
<span class="normal"> 6062</span>
<span class="normal"> 6063</span>
<span class="normal"> 6064</span>
<span class="normal"> 6065</span>
<span class="normal"> 6066</span>
<span class="normal"> 6067</span>
<span class="normal"> 6068</span>
<span class="normal"> 6069</span>
<span class="normal"> 6070</span>
<span class="normal"> 6071</span>
<span class="normal"> 6072</span>
<span class="normal"> 6073</span>
<span class="normal"> 6074</span>
<span class="normal"> 6075</span>
<span class="normal"> 6076</span>
<span class="normal"> 6077</span>
<span class="normal"> 6078</span>
<span class="normal"> 6079</span>
<span class="normal"> 6080</span>
<span class="normal"> 6081</span>
<span class="normal"> 6082</span>
<span class="normal"> 6083</span>
<span class="normal"> 6084</span>
<span class="normal"> 6085</span>
<span class="normal"> 6086</span>
<span class="normal"> 6087</span>
<span class="normal"> 6088</span>
<span class="normal"> 6089</span>
<span class="normal"> 6090</span>
<span class="normal"> 6091</span>
<span class="normal"> 6092</span>
<span class="normal"> 6093</span>
<span class="normal"> 6094</span>
<span class="normal"> 6095</span>
<span class="normal"> 6096</span>
<span class="normal"> 6097</span>
<span class="normal"> 6098</span>
<span class="normal"> 6099</span>
<span class="normal"> 6100</span>
<span class="normal"> 6101</span>
<span class="normal"> 6102</span>
<span class="normal"> 6103</span>
<span class="normal"> 6104</span>
<span class="normal"> 6105</span>
<span class="normal"> 6106</span>
<span class="normal"> 6107</span>
<span class="normal"> 6108</span>
<span class="normal"> 6109</span>
<span class="normal"> 6110</span>
<span class="normal"> 6111</span>
<span class="normal"> 6112</span>
<span class="normal"> 6113</span>
<span class="normal"> 6114</span>
<span class="normal"> 6115</span>
<span class="normal"> 6116</span>
<span class="normal"> 6117</span>
<span class="normal"> 6118</span>
<span class="normal"> 6119</span>
<span class="normal"> 6120</span>
<span class="normal"> 6121</span>
<span class="normal"> 6122</span>
<span class="normal"> 6123</span>
<span class="normal"> 6124</span>
<span class="normal"> 6125</span>
<span class="normal"> 6126</span>
<span class="normal"> 6127</span>
<span class="normal"> 6128</span>
<span class="normal"> 6129</span>
<span class="normal"> 6130</span>
<span class="normal"> 6131</span>
<span class="normal"> 6132</span>
<span class="normal"> 6133</span>
<span class="normal"> 6134</span>
<span class="normal"> 6135</span>
<span class="normal"> 6136</span>
<span class="normal"> 6137</span>
<span class="normal"> 6138</span>
<span class="normal"> 6139</span>
<span class="normal"> 6140</span>
<span class="normal"> 6141</span>
<span class="normal"> 6142</span>
<span class="normal"> 6143</span>
<span class="normal"> 6144</span>
<span class="normal"> 6145</span>
<span class="normal"> 6146</span>
<span class="normal"> 6147</span>
<span class="normal"> 6148</span>
<span class="normal"> 6149</span>
<span class="normal"> 6150</span>
<span class="normal"> 6151</span>
<span class="normal"> 6152</span>
<span class="normal"> 6153</span>
<span class="normal"> 6154</span>
<span class="normal"> 6155</span>
<span class="normal"> 6156</span>
<span class="normal"> 6157</span>
<span class="normal"> 6158</span>
<span class="normal"> 6159</span>
<span class="normal"> 6160</span>
<span class="normal"> 6161</span>
<span class="normal"> 6162</span>
<span class="normal"> 6163</span>
<span class="normal"> 6164</span>
<span class="normal"> 6165</span>
<span class="normal"> 6166</span>
<span class="normal"> 6167</span>
<span class="normal"> 6168</span>
<span class="normal"> 6169</span>
<span class="normal"> 6170</span>
<span class="normal"> 6171</span>
<span class="normal"> 6172</span>
<span class="normal"> 6173</span>
<span class="normal"> 6174</span>
<span class="normal"> 6175</span>
<span class="normal"> 6176</span>
<span class="normal"> 6177</span>
<span class="normal"> 6178</span>
<span class="normal"> 6179</span>
<span class="normal"> 6180</span>
<span class="normal"> 6181</span>
<span class="normal"> 6182</span>
<span class="normal"> 6183</span>
<span class="normal"> 6184</span>
<span class="normal"> 6185</span>
<span class="normal"> 6186</span>
<span class="normal"> 6187</span>
<span class="normal"> 6188</span>
<span class="normal"> 6189</span>
<span class="normal"> 6190</span>
<span class="normal"> 6191</span>
<span class="normal"> 6192</span>
<span class="normal"> 6193</span>
<span class="normal"> 6194</span>
<span class="normal"> 6195</span>
<span class="normal"> 6196</span>
<span class="normal"> 6197</span>
<span class="normal"> 6198</span>
<span class="normal"> 6199</span>
<span class="normal"> 6200</span>
<span class="normal"> 6201</span>
<span class="normal"> 6202</span>
<span class="normal"> 6203</span>
<span class="normal"> 6204</span>
<span class="normal"> 6205</span>
<span class="normal"> 6206</span>
<span class="normal"> 6207</span>
<span class="normal"> 6208</span>
<span class="normal"> 6209</span>
<span class="normal"> 6210</span>
<span class="normal"> 6211</span>
<span class="normal"> 6212</span>
<span class="normal"> 6213</span>
<span class="normal"> 6214</span>
<span class="normal"> 6215</span>
<span class="normal"> 6216</span>
<span class="normal"> 6217</span>
<span class="normal"> 6218</span>
<span class="normal"> 6219</span>
<span class="normal"> 6220</span>
<span class="normal"> 6221</span>
<span class="normal"> 6222</span>
<span class="normal"> 6223</span>
<span class="normal"> 6224</span>
<span class="normal"> 6225</span>
<span class="normal"> 6226</span>
<span class="normal"> 6227</span>
<span class="normal"> 6228</span>
<span class="normal"> 6229</span>
<span class="normal"> 6230</span>
<span class="normal"> 6231</span>
<span class="normal"> 6232</span>
<span class="normal"> 6233</span>
<span class="normal"> 6234</span>
<span class="normal"> 6235</span>
<span class="normal"> 6236</span>
<span class="normal"> 6237</span>
<span class="normal"> 6238</span>
<span class="normal"> 6239</span>
<span class="normal"> 6240</span>
<span class="normal"> 6241</span>
<span class="normal"> 6242</span>
<span class="normal"> 6243</span>
<span class="normal"> 6244</span>
<span class="normal"> 6245</span>
<span class="normal"> 6246</span>
<span class="normal"> 6247</span>
<span class="normal"> 6248</span>
<span class="normal"> 6249</span>
<span class="normal"> 6250</span>
<span class="normal"> 6251</span>
<span class="normal"> 6252</span>
<span class="normal"> 6253</span>
<span class="normal"> 6254</span>
<span class="normal"> 6255</span>
<span class="normal"> 6256</span>
<span class="normal"> 6257</span>
<span class="normal"> 6258</span>
<span class="normal"> 6259</span>
<span class="normal"> 6260</span>
<span class="normal"> 6261</span>
<span class="normal"> 6262</span>
<span class="normal"> 6263</span>
<span class="normal"> 6264</span>
<span class="normal"> 6265</span>
<span class="normal"> 6266</span>
<span class="normal"> 6267</span>
<span class="normal"> 6268</span>
<span class="normal"> 6269</span>
<span class="normal"> 6270</span>
<span class="normal"> 6271</span>
<span class="normal"> 6272</span>
<span class="normal"> 6273</span>
<span class="normal"> 6274</span>
<span class="normal"> 6275</span>
<span class="normal"> 6276</span>
<span class="normal"> 6277</span>
<span class="normal"> 6278</span>
<span class="normal"> 6279</span>
<span class="normal"> 6280</span>
<span class="normal"> 6281</span>
<span class="normal"> 6282</span>
<span class="normal"> 6283</span>
<span class="normal"> 6284</span>
<span class="normal"> 6285</span>
<span class="normal"> 6286</span>
<span class="normal"> 6287</span>
<span class="normal"> 6288</span>
<span class="normal"> 6289</span>
<span class="normal"> 6290</span>
<span class="normal"> 6291</span>
<span class="normal"> 6292</span>
<span class="normal"> 6293</span>
<span class="normal"> 6294</span>
<span class="normal"> 6295</span>
<span class="normal"> 6296</span>
<span class="normal"> 6297</span>
<span class="normal"> 6298</span>
<span class="normal"> 6299</span>
<span class="normal"> 6300</span>
<span class="normal"> 6301</span>
<span class="normal"> 6302</span>
<span class="normal"> 6303</span>
<span class="normal"> 6304</span>
<span class="normal"> 6305</span>
<span class="normal"> 6306</span>
<span class="normal"> 6307</span>
<span class="normal"> 6308</span>
<span class="normal"> 6309</span>
<span class="normal"> 6310</span>
<span class="normal"> 6311</span>
<span class="normal"> 6312</span>
<span class="normal"> 6313</span>
<span class="normal"> 6314</span>
<span class="normal"> 6315</span>
<span class="normal"> 6316</span>
<span class="normal"> 6317</span>
<span class="normal"> 6318</span>
<span class="normal"> 6319</span>
<span class="normal"> 6320</span>
<span class="normal"> 6321</span>
<span class="normal"> 6322</span>
<span class="normal"> 6323</span>
<span class="normal"> 6324</span>
<span class="normal"> 6325</span>
<span class="normal"> 6326</span>
<span class="normal"> 6327</span>
<span class="normal"> 6328</span>
<span class="normal"> 6329</span>
<span class="normal"> 6330</span>
<span class="normal"> 6331</span>
<span class="normal"> 6332</span>
<span class="normal"> 6333</span>
<span class="normal"> 6334</span>
<span class="normal"> 6335</span>
<span class="normal"> 6336</span>
<span class="normal"> 6337</span>
<span class="normal"> 6338</span>
<span class="normal"> 6339</span>
<span class="normal"> 6340</span>
<span class="normal"> 6341</span>
<span class="normal"> 6342</span>
<span class="normal"> 6343</span>
<span class="normal"> 6344</span>
<span class="normal"> 6345</span>
<span class="normal"> 6346</span>
<span class="normal"> 6347</span>
<span class="normal"> 6348</span>
<span class="normal"> 6349</span>
<span class="normal"> 6350</span>
<span class="normal"> 6351</span>
<span class="normal"> 6352</span>
<span class="normal"> 6353</span>
<span class="normal"> 6354</span>
<span class="normal"> 6355</span>
<span class="normal"> 6356</span>
<span class="normal"> 6357</span>
<span class="normal"> 6358</span>
<span class="normal"> 6359</span>
<span class="normal"> 6360</span>
<span class="normal"> 6361</span>
<span class="normal"> 6362</span>
<span class="normal"> 6363</span>
<span class="normal"> 6364</span>
<span class="normal"> 6365</span>
<span class="normal"> 6366</span>
<span class="normal"> 6367</span>
<span class="normal"> 6368</span>
<span class="normal"> 6369</span>
<span class="normal"> 6370</span>
<span class="normal"> 6371</span>
<span class="normal"> 6372</span>
<span class="normal"> 6373</span>
<span class="normal"> 6374</span>
<span class="normal"> 6375</span>
<span class="normal"> 6376</span>
<span class="normal"> 6377</span>
<span class="normal"> 6378</span>
<span class="normal"> 6379</span>
<span class="normal"> 6380</span>
<span class="normal"> 6381</span>
<span class="normal"> 6382</span>
<span class="normal"> 6383</span>
<span class="normal"> 6384</span>
<span class="normal"> 6385</span>
<span class="normal"> 6386</span>
<span class="normal"> 6387</span>
<span class="normal"> 6388</span>
<span class="normal"> 6389</span>
<span class="normal"> 6390</span>
<span class="normal"> 6391</span>
<span class="normal"> 6392</span>
<span class="normal"> 6393</span>
<span class="normal"> 6394</span>
<span class="normal"> 6395</span>
<span class="normal"> 6396</span>
<span class="normal"> 6397</span>
<span class="normal"> 6398</span>
<span class="normal"> 6399</span>
<span class="normal"> 6400</span>
<span class="normal"> 6401</span>
<span class="normal"> 6402</span>
<span class="normal"> 6403</span>
<span class="normal"> 6404</span>
<span class="normal"> 6405</span>
<span class="normal"> 6406</span>
<span class="normal"> 6407</span>
<span class="normal"> 6408</span>
<span class="normal"> 6409</span>
<span class="normal"> 6410</span>
<span class="normal"> 6411</span>
<span class="normal"> 6412</span>
<span class="normal"> 6413</span>
<span class="normal"> 6414</span>
<span class="normal"> 6415</span>
<span class="normal"> 6416</span>
<span class="normal"> 6417</span>
<span class="normal"> 6418</span>
<span class="normal"> 6419</span>
<span class="normal"> 6420</span>
<span class="normal"> 6421</span>
<span class="normal"> 6422</span>
<span class="normal"> 6423</span>
<span class="normal"> 6424</span>
<span class="normal"> 6425</span>
<span class="normal"> 6426</span>
<span class="normal"> 6427</span>
<span class="normal"> 6428</span>
<span class="normal"> 6429</span>
<span class="normal"> 6430</span>
<span class="normal"> 6431</span>
<span class="normal"> 6432</span>
<span class="normal"> 6433</span>
<span class="normal"> 6434</span>
<span class="normal"> 6435</span>
<span class="normal"> 6436</span>
<span class="normal"> 6437</span>
<span class="normal"> 6438</span>
<span class="normal"> 6439</span>
<span class="normal"> 6440</span>
<span class="normal"> 6441</span>
<span class="normal"> 6442</span>
<span class="normal"> 6443</span>
<span class="normal"> 6444</span>
<span class="normal"> 6445</span>
<span class="normal"> 6446</span>
<span class="normal"> 6447</span>
<span class="normal"> 6448</span>
<span class="normal"> 6449</span>
<span class="normal"> 6450</span>
<span class="normal"> 6451</span>
<span class="normal"> 6452</span>
<span class="normal"> 6453</span>
<span class="normal"> 6454</span>
<span class="normal"> 6455</span>
<span class="normal"> 6456</span>
<span class="normal"> 6457</span>
<span class="normal"> 6458</span>
<span class="normal"> 6459</span>
<span class="normal"> 6460</span>
<span class="normal"> 6461</span>
<span class="normal"> 6462</span>
<span class="normal"> 6463</span>
<span class="normal"> 6464</span>
<span class="normal"> 6465</span>
<span class="normal"> 6466</span>
<span class="normal"> 6467</span>
<span class="normal"> 6468</span>
<span class="normal"> 6469</span>
<span class="normal"> 6470</span>
<span class="normal"> 6471</span>
<span class="normal"> 6472</span>
<span class="normal"> 6473</span>
<span class="normal"> 6474</span>
<span class="normal"> 6475</span>
<span class="normal"> 6476</span>
<span class="normal"> 6477</span>
<span class="normal"> 6478</span>
<span class="normal"> 6479</span>
<span class="normal"> 6480</span>
<span class="normal"> 6481</span>
<span class="normal"> 6482</span>
<span class="normal"> 6483</span>
<span class="normal"> 6484</span>
<span class="normal"> 6485</span>
<span class="normal"> 6486</span>
<span class="normal"> 6487</span>
<span class="normal"> 6488</span>
<span class="normal"> 6489</span>
<span class="normal"> 6490</span>
<span class="normal"> 6491</span>
<span class="normal"> 6492</span>
<span class="normal"> 6493</span>
<span class="normal"> 6494</span>
<span class="normal"> 6495</span>
<span class="normal"> 6496</span>
<span class="normal"> 6497</span>
<span class="normal"> 6498</span>
<span class="normal"> 6499</span>
<span class="normal"> 6500</span>
<span class="normal"> 6501</span>
<span class="normal"> 6502</span>
<span class="normal"> 6503</span>
<span class="normal"> 6504</span>
<span class="normal"> 6505</span>
<span class="normal"> 6506</span>
<span class="normal"> 6507</span>
<span class="normal"> 6508</span>
<span class="normal"> 6509</span>
<span class="normal"> 6510</span>
<span class="normal"> 6511</span>
<span class="normal"> 6512</span>
<span class="normal"> 6513</span>
<span class="normal"> 6514</span>
<span class="normal"> 6515</span>
<span class="normal"> 6516</span>
<span class="normal"> 6517</span>
<span class="normal"> 6518</span>
<span class="normal"> 6519</span>
<span class="normal"> 6520</span>
<span class="normal"> 6521</span>
<span class="normal"> 6522</span>
<span class="normal"> 6523</span>
<span class="normal"> 6524</span>
<span class="normal"> 6525</span>
<span class="normal"> 6526</span>
<span class="normal"> 6527</span>
<span class="normal"> 6528</span>
<span class="normal"> 6529</span>
<span class="normal"> 6530</span>
<span class="normal"> 6531</span>
<span class="normal"> 6532</span>
<span class="normal"> 6533</span>
<span class="normal"> 6534</span>
<span class="normal"> 6535</span>
<span class="normal"> 6536</span>
<span class="normal"> 6537</span>
<span class="normal"> 6538</span>
<span class="normal"> 6539</span>
<span class="normal"> 6540</span>
<span class="normal"> 6541</span>
<span class="normal"> 6542</span>
<span class="normal"> 6543</span>
<span class="normal"> 6544</span>
<span class="normal"> 6545</span>
<span class="normal"> 6546</span>
<span class="normal"> 6547</span>
<span class="normal"> 6548</span>
<span class="normal"> 6549</span>
<span class="normal"> 6550</span>
<span class="normal"> 6551</span>
<span class="normal"> 6552</span>
<span class="normal"> 6553</span>
<span class="normal"> 6554</span>
<span class="normal"> 6555</span>
<span class="normal"> 6556</span>
<span class="normal"> 6557</span>
<span class="normal"> 6558</span>
<span class="normal"> 6559</span>
<span class="normal"> 6560</span>
<span class="normal"> 6561</span>
<span class="normal"> 6562</span>
<span class="normal"> 6563</span>
<span class="normal"> 6564</span>
<span class="normal"> 6565</span>
<span class="normal"> 6566</span>
<span class="normal"> 6567</span>
<span class="normal"> 6568</span>
<span class="normal"> 6569</span>
<span class="normal"> 6570</span>
<span class="normal"> 6571</span>
<span class="normal"> 6572</span>
<span class="normal"> 6573</span>
<span class="normal"> 6574</span>
<span class="normal"> 6575</span>
<span class="normal"> 6576</span>
<span class="normal"> 6577</span>
<span class="normal"> 6578</span>
<span class="normal"> 6579</span>
<span class="normal"> 6580</span>
<span class="normal"> 6581</span>
<span class="normal"> 6582</span>
<span class="normal"> 6583</span>
<span class="normal"> 6584</span>
<span class="normal"> 6585</span>
<span class="normal"> 6586</span>
<span class="normal"> 6587</span>
<span class="normal"> 6588</span>
<span class="normal"> 6589</span>
<span class="normal"> 6590</span>
<span class="normal"> 6591</span>
<span class="normal"> 6592</span>
<span class="normal"> 6593</span>
<span class="normal"> 6594</span>
<span class="normal"> 6595</span>
<span class="normal"> 6596</span>
<span class="normal"> 6597</span>
<span class="normal"> 6598</span>
<span class="normal"> 6599</span>
<span class="normal"> 6600</span>
<span class="normal"> 6601</span>
<span class="normal"> 6602</span>
<span class="normal"> 6603</span>
<span class="normal"> 6604</span>
<span class="normal"> 6605</span>
<span class="normal"> 6606</span>
<span class="normal"> 6607</span>
<span class="normal"> 6608</span>
<span class="normal"> 6609</span>
<span class="normal"> 6610</span>
<span class="normal"> 6611</span>
<span class="normal"> 6612</span>
<span class="normal"> 6613</span>
<span class="normal"> 6614</span>
<span class="normal"> 6615</span>
<span class="normal"> 6616</span>
<span class="normal"> 6617</span>
<span class="normal"> 6618</span>
<span class="normal"> 6619</span>
<span class="normal"> 6620</span>
<span class="normal"> 6621</span>
<span class="normal"> 6622</span>
<span class="normal"> 6623</span>
<span class="normal"> 6624</span>
<span class="normal"> 6625</span>
<span class="normal"> 6626</span>
<span class="normal"> 6627</span>
<span class="normal"> 6628</span>
<span class="normal"> 6629</span>
<span class="normal"> 6630</span>
<span class="normal"> 6631</span>
<span class="normal"> 6632</span>
<span class="normal"> 6633</span>
<span class="normal"> 6634</span>
<span class="normal"> 6635</span>
<span class="normal"> 6636</span>
<span class="normal"> 6637</span>
<span class="normal"> 6638</span>
<span class="normal"> 6639</span>
<span class="normal"> 6640</span>
<span class="normal"> 6641</span>
<span class="normal"> 6642</span>
<span class="normal"> 6643</span>
<span class="normal"> 6644</span>
<span class="normal"> 6645</span>
<span class="normal"> 6646</span>
<span class="normal"> 6647</span>
<span class="normal"> 6648</span>
<span class="normal"> 6649</span>
<span class="normal"> 6650</span>
<span class="normal"> 6651</span>
<span class="normal"> 6652</span>
<span class="normal"> 6653</span>
<span class="normal"> 6654</span>
<span class="normal"> 6655</span>
<span class="normal"> 6656</span>
<span class="normal"> 6657</span>
<span class="normal"> 6658</span>
<span class="normal"> 6659</span>
<span class="normal"> 6660</span>
<span class="normal"> 6661</span>
<span class="normal"> 6662</span>
<span class="normal"> 6663</span>
<span class="normal"> 6664</span>
<span class="normal"> 6665</span>
<span class="normal"> 6666</span>
<span class="normal"> 6667</span>
<span class="normal"> 6668</span>
<span class="normal"> 6669</span>
<span class="normal"> 6670</span>
<span class="normal"> 6671</span>
<span class="normal"> 6672</span>
<span class="normal"> 6673</span>
<span class="normal"> 6674</span>
<span class="normal"> 6675</span>
<span class="normal"> 6676</span>
<span class="normal"> 6677</span>
<span class="normal"> 6678</span>
<span class="normal"> 6679</span>
<span class="normal"> 6680</span>
<span class="normal"> 6681</span>
<span class="normal"> 6682</span>
<span class="normal"> 6683</span>
<span class="normal"> 6684</span>
<span class="normal"> 6685</span>
<span class="normal"> 6686</span>
<span class="normal"> 6687</span>
<span class="normal"> 6688</span>
<span class="normal"> 6689</span>
<span class="normal"> 6690</span>
<span class="normal"> 6691</span>
<span class="normal"> 6692</span>
<span class="normal"> 6693</span>
<span class="normal"> 6694</span>
<span class="normal"> 6695</span>
<span class="normal"> 6696</span>
<span class="normal"> 6697</span>
<span class="normal"> 6698</span>
<span class="normal"> 6699</span>
<span class="normal"> 6700</span>
<span class="normal"> 6701</span>
<span class="normal"> 6702</span>
<span class="normal"> 6703</span>
<span class="normal"> 6704</span>
<span class="normal"> 6705</span>
<span class="normal"> 6706</span>
<span class="normal"> 6707</span>
<span class="normal"> 6708</span>
<span class="normal"> 6709</span>
<span class="normal"> 6710</span>
<span class="normal"> 6711</span>
<span class="normal"> 6712</span>
<span class="normal"> 6713</span>
<span class="normal"> 6714</span>
<span class="normal"> 6715</span>
<span class="normal"> 6716</span>
<span class="normal"> 6717</span>
<span class="normal"> 6718</span>
<span class="normal"> 6719</span>
<span class="normal"> 6720</span>
<span class="normal"> 6721</span>
<span class="normal"> 6722</span>
<span class="normal"> 6723</span>
<span class="normal"> 6724</span>
<span class="normal"> 6725</span>
<span class="normal"> 6726</span>
<span class="normal"> 6727</span>
<span class="normal"> 6728</span>
<span class="normal"> 6729</span>
<span class="normal"> 6730</span>
<span class="normal"> 6731</span>
<span class="normal"> 6732</span>
<span class="normal"> 6733</span>
<span class="normal"> 6734</span>
<span class="normal"> 6735</span>
<span class="normal"> 6736</span>
<span class="normal"> 6737</span>
<span class="normal"> 6738</span>
<span class="normal"> 6739</span>
<span class="normal"> 6740</span>
<span class="normal"> 6741</span>
<span class="normal"> 6742</span>
<span class="normal"> 6743</span>
<span class="normal"> 6744</span>
<span class="normal"> 6745</span>
<span class="normal"> 6746</span>
<span class="normal"> 6747</span>
<span class="normal"> 6748</span>
<span class="normal"> 6749</span>
<span class="normal"> 6750</span>
<span class="normal"> 6751</span>
<span class="normal"> 6752</span>
<span class="normal"> 6753</span>
<span class="normal"> 6754</span>
<span class="normal"> 6755</span>
<span class="normal"> 6756</span>
<span class="normal"> 6757</span>
<span class="normal"> 6758</span>
<span class="normal"> 6759</span>
<span class="normal"> 6760</span>
<span class="normal"> 6761</span>
<span class="normal"> 6762</span>
<span class="normal"> 6763</span>
<span class="normal"> 6764</span>
<span class="normal"> 6765</span>
<span class="normal"> 6766</span>
<span class="normal"> 6767</span>
<span class="normal"> 6768</span>
<span class="normal"> 6769</span>
<span class="normal"> 6770</span>
<span class="normal"> 6771</span>
<span class="normal"> 6772</span>
<span class="normal"> 6773</span>
<span class="normal"> 6774</span>
<span class="normal"> 6775</span>
<span class="normal"> 6776</span>
<span class="normal"> 6777</span>
<span class="normal"> 6778</span>
<span class="normal"> 6779</span>
<span class="normal"> 6780</span>
<span class="normal"> 6781</span>
<span class="normal"> 6782</span>
<span class="normal"> 6783</span>
<span class="normal"> 6784</span>
<span class="normal"> 6785</span>
<span class="normal"> 6786</span>
<span class="normal"> 6787</span>
<span class="normal"> 6788</span>
<span class="normal"> 6789</span>
<span class="normal"> 6790</span>
<span class="normal"> 6791</span>
<span class="normal"> 6792</span>
<span class="normal"> 6793</span>
<span class="normal"> 6794</span>
<span class="normal"> 6795</span>
<span class="normal"> 6796</span>
<span class="normal"> 6797</span>
<span class="normal"> 6798</span>
<span class="normal"> 6799</span>
<span class="normal"> 6800</span>
<span class="normal"> 6801</span>
<span class="normal"> 6802</span>
<span class="normal"> 6803</span>
<span class="normal"> 6804</span>
<span class="normal"> 6805</span>
<span class="normal"> 6806</span>
<span class="normal"> 6807</span>
<span class="normal"> 6808</span>
<span class="normal"> 6809</span>
<span class="normal"> 6810</span>
<span class="normal"> 6811</span>
<span class="normal"> 6812</span>
<span class="normal"> 6813</span>
<span class="normal"> 6814</span>
<span class="normal"> 6815</span>
<span class="normal"> 6816</span>
<span class="normal"> 6817</span>
<span class="normal"> 6818</span>
<span class="normal"> 6819</span>
<span class="normal"> 6820</span>
<span class="normal"> 6821</span>
<span class="normal"> 6822</span>
<span class="normal"> 6823</span>
<span class="normal"> 6824</span>
<span class="normal"> 6825</span>
<span class="normal"> 6826</span>
<span class="normal"> 6827</span>
<span class="normal"> 6828</span>
<span class="normal"> 6829</span>
<span class="normal"> 6830</span>
<span class="normal"> 6831</span>
<span class="normal"> 6832</span>
<span class="normal"> 6833</span>
<span class="normal"> 6834</span>
<span class="normal"> 6835</span>
<span class="normal"> 6836</span>
<span class="normal"> 6837</span>
<span class="normal"> 6838</span>
<span class="normal"> 6839</span>
<span class="normal"> 6840</span>
<span class="normal"> 6841</span>
<span class="normal"> 6842</span>
<span class="normal"> 6843</span>
<span class="normal"> 6844</span>
<span class="normal"> 6845</span>
<span class="normal"> 6846</span>
<span class="normal"> 6847</span>
<span class="normal"> 6848</span>
<span class="normal"> 6849</span>
<span class="normal"> 6850</span>
<span class="normal"> 6851</span>
<span class="normal"> 6852</span>
<span class="normal"> 6853</span>
<span class="normal"> 6854</span>
<span class="normal"> 6855</span>
<span class="normal"> 6856</span>
<span class="normal"> 6857</span>
<span class="normal"> 6858</span>
<span class="normal"> 6859</span>
<span class="normal"> 6860</span>
<span class="normal"> 6861</span>
<span class="normal"> 6862</span>
<span class="normal"> 6863</span>
<span class="normal"> 6864</span>
<span class="normal"> 6865</span>
<span class="normal"> 6866</span>
<span class="normal"> 6867</span>
<span class="normal"> 6868</span>
<span class="normal"> 6869</span>
<span class="normal"> 6870</span>
<span class="normal"> 6871</span>
<span class="normal"> 6872</span>
<span class="normal"> 6873</span>
<span class="normal"> 6874</span>
<span class="normal"> 6875</span>
<span class="normal"> 6876</span>
<span class="normal"> 6877</span>
<span class="normal"> 6878</span>
<span class="normal"> 6879</span>
<span class="normal"> 6880</span>
<span class="normal"> 6881</span>
<span class="normal"> 6882</span>
<span class="normal"> 6883</span>
<span class="normal"> 6884</span>
<span class="normal"> 6885</span>
<span class="normal"> 6886</span>
<span class="normal"> 6887</span>
<span class="normal"> 6888</span>
<span class="normal"> 6889</span>
<span class="normal"> 6890</span>
<span class="normal"> 6891</span>
<span class="normal"> 6892</span>
<span class="normal"> 6893</span>
<span class="normal"> 6894</span>
<span class="normal"> 6895</span>
<span class="normal"> 6896</span>
<span class="normal"> 6897</span>
<span class="normal"> 6898</span>
<span class="normal"> 6899</span>
<span class="normal"> 6900</span>
<span class="normal"> 6901</span>
<span class="normal"> 6902</span>
<span class="normal"> 6903</span>
<span class="normal"> 6904</span>
<span class="normal"> 6905</span>
<span class="normal"> 6906</span>
<span class="normal"> 6907</span>
<span class="normal"> 6908</span>
<span class="normal"> 6909</span>
<span class="normal"> 6910</span>
<span class="normal"> 6911</span>
<span class="normal"> 6912</span>
<span class="normal"> 6913</span>
<span class="normal"> 6914</span>
<span class="normal"> 6915</span>
<span class="normal"> 6916</span>
<span class="normal"> 6917</span>
<span class="normal"> 6918</span>
<span class="normal"> 6919</span>
<span class="normal"> 6920</span>
<span class="normal"> 6921</span>
<span class="normal"> 6922</span>
<span class="normal"> 6923</span>
<span class="normal"> 6924</span>
<span class="normal"> 6925</span>
<span class="normal"> 6926</span>
<span class="normal"> 6927</span>
<span class="normal"> 6928</span>
<span class="normal"> 6929</span>
<span class="normal"> 6930</span>
<span class="normal"> 6931</span>
<span class="normal"> 6932</span>
<span class="normal"> 6933</span>
<span class="normal"> 6934</span>
<span class="normal"> 6935</span>
<span class="normal"> 6936</span>
<span class="normal"> 6937</span>
<span class="normal"> 6938</span>
<span class="normal"> 6939</span>
<span class="normal"> 6940</span>
<span class="normal"> 6941</span>
<span class="normal"> 6942</span>
<span class="normal"> 6943</span>
<span class="normal"> 6944</span>
<span class="normal"> 6945</span>
<span class="normal"> 6946</span>
<span class="normal"> 6947</span>
<span class="normal"> 6948</span>
<span class="normal"> 6949</span>
<span class="normal"> 6950</span>
<span class="normal"> 6951</span>
<span class="normal"> 6952</span>
<span class="normal"> 6953</span>
<span class="normal"> 6954</span>
<span class="normal"> 6955</span>
<span class="normal"> 6956</span>
<span class="normal"> 6957</span>
<span class="normal"> 6958</span>
<span class="normal"> 6959</span>
<span class="normal"> 6960</span>
<span class="normal"> 6961</span>
<span class="normal"> 6962</span>
<span class="normal"> 6963</span>
<span class="normal"> 6964</span>
<span class="normal"> 6965</span>
<span class="normal"> 6966</span>
<span class="normal"> 6967</span>
<span class="normal"> 6968</span>
<span class="normal"> 6969</span>
<span class="normal"> 6970</span>
<span class="normal"> 6971</span>
<span class="normal"> 6972</span>
<span class="normal"> 6973</span>
<span class="normal"> 6974</span>
<span class="normal"> 6975</span>
<span class="normal"> 6976</span>
<span class="normal"> 6977</span>
<span class="normal"> 6978</span>
<span class="normal"> 6979</span>
<span class="normal"> 6980</span>
<span class="normal"> 6981</span>
<span class="normal"> 6982</span>
<span class="normal"> 6983</span>
<span class="normal"> 6984</span>
<span class="normal"> 6985</span>
<span class="normal"> 6986</span>
<span class="normal"> 6987</span>
<span class="normal"> 6988</span>
<span class="normal"> 6989</span>
<span class="normal"> 6990</span>
<span class="normal"> 6991</span>
<span class="normal"> 6992</span>
<span class="normal"> 6993</span>
<span class="normal"> 6994</span>
<span class="normal"> 6995</span>
<span class="normal"> 6996</span>
<span class="normal"> 6997</span>
<span class="normal"> 6998</span>
<span class="normal"> 6999</span>
<span class="normal"> 7000</span>
<span class="normal"> 7001</span>
<span class="normal"> 7002</span>
<span class="normal"> 7003</span>
<span class="normal"> 7004</span>
<span class="normal"> 7005</span>
<span class="normal"> 7006</span>
<span class="normal"> 7007</span>
<span class="normal"> 7008</span>
<span class="normal"> 7009</span>
<span class="normal"> 7010</span>
<span class="normal"> 7011</span>
<span class="normal"> 7012</span>
<span class="normal"> 7013</span>
<span class="normal"> 7014</span>
<span class="normal"> 7015</span>
<span class="normal"> 7016</span>
<span class="normal"> 7017</span>
<span class="normal"> 7018</span>
<span class="normal"> 7019</span>
<span class="normal"> 7020</span>
<span class="normal"> 7021</span>
<span class="normal"> 7022</span>
<span class="normal"> 7023</span>
<span class="normal"> 7024</span>
<span class="normal"> 7025</span>
<span class="normal"> 7026</span>
<span class="normal"> 7027</span>
<span class="normal"> 7028</span>
<span class="normal"> 7029</span>
<span class="normal"> 7030</span>
<span class="normal"> 7031</span>
<span class="normal"> 7032</span>
<span class="normal"> 7033</span>
<span class="normal"> 7034</span>
<span class="normal"> 7035</span>
<span class="normal"> 7036</span>
<span class="normal"> 7037</span>
<span class="normal"> 7038</span>
<span class="normal"> 7039</span>
<span class="normal"> 7040</span>
<span class="normal"> 7041</span>
<span class="normal"> 7042</span>
<span class="normal"> 7043</span>
<span class="normal"> 7044</span>
<span class="normal"> 7045</span>
<span class="normal"> 7046</span>
<span class="normal"> 7047</span>
<span class="normal"> 7048</span>
<span class="normal"> 7049</span>
<span class="normal"> 7050</span>
<span class="normal"> 7051</span>
<span class="normal"> 7052</span>
<span class="normal"> 7053</span>
<span class="normal"> 7054</span>
<span class="normal"> 7055</span>
<span class="normal"> 7056</span>
<span class="normal"> 7057</span>
<span class="normal"> 7058</span>
<span class="normal"> 7059</span>
<span class="normal"> 7060</span>
<span class="normal"> 7061</span>
<span class="normal"> 7062</span>
<span class="normal"> 7063</span>
<span class="normal"> 7064</span>
<span class="normal"> 7065</span>
<span class="normal"> 7066</span>
<span class="normal"> 7067</span>
<span class="normal"> 7068</span>
<span class="normal"> 7069</span>
<span class="normal"> 7070</span>
<span class="normal"> 7071</span>
<span class="normal"> 7072</span>
<span class="normal"> 7073</span>
<span class="normal"> 7074</span>
<span class="normal"> 7075</span>
<span class="normal"> 7076</span>
<span class="normal"> 7077</span>
<span class="normal"> 7078</span>
<span class="normal"> 7079</span>
<span class="normal"> 7080</span>
<span class="normal"> 7081</span>
<span class="normal"> 7082</span>
<span class="normal"> 7083</span>
<span class="normal"> 7084</span>
<span class="normal"> 7085</span>
<span class="normal"> 7086</span>
<span class="normal"> 7087</span>
<span class="normal"> 7088</span>
<span class="normal"> 7089</span>
<span class="normal"> 7090</span>
<span class="normal"> 7091</span>
<span class="normal"> 7092</span>
<span class="normal"> 7093</span>
<span class="normal"> 7094</span>
<span class="normal"> 7095</span>
<span class="normal"> 7096</span>
<span class="normal"> 7097</span>
<span class="normal"> 7098</span>
<span class="normal"> 7099</span>
<span class="normal"> 7100</span>
<span class="normal"> 7101</span>
<span class="normal"> 7102</span>
<span class="normal"> 7103</span>
<span class="normal"> 7104</span>
<span class="normal"> 7105</span>
<span class="normal"> 7106</span>
<span class="normal"> 7107</span>
<span class="normal"> 7108</span>
<span class="normal"> 7109</span>
<span class="normal"> 7110</span>
<span class="normal"> 7111</span>
<span class="normal"> 7112</span>
<span class="normal"> 7113</span>
<span class="normal"> 7114</span>
<span class="normal"> 7115</span>
<span class="normal"> 7116</span>
<span class="normal"> 7117</span>
<span class="normal"> 7118</span>
<span class="normal"> 7119</span>
<span class="normal"> 7120</span>
<span class="normal"> 7121</span>
<span class="normal"> 7122</span>
<span class="normal"> 7123</span>
<span class="normal"> 7124</span>
<span class="normal"> 7125</span>
<span class="normal"> 7126</span>
<span class="normal"> 7127</span>
<span class="normal"> 7128</span>
<span class="normal"> 7129</span>
<span class="normal"> 7130</span>
<span class="normal"> 7131</span>
<span class="normal"> 7132</span>
<span class="normal"> 7133</span>
<span class="normal"> 7134</span>
<span class="normal"> 7135</span>
<span class="normal"> 7136</span>
<span class="normal"> 7137</span>
<span class="normal"> 7138</span>
<span class="normal"> 7139</span>
<span class="normal"> 7140</span>
<span class="normal"> 7141</span>
<span class="normal"> 7142</span>
<span class="normal"> 7143</span>
<span class="normal"> 7144</span>
<span class="normal"> 7145</span>
<span class="normal"> 7146</span>
<span class="normal"> 7147</span>
<span class="normal"> 7148</span>
<span class="normal"> 7149</span>
<span class="normal"> 7150</span>
<span class="normal"> 7151</span>
<span class="normal"> 7152</span>
<span class="normal"> 7153</span>
<span class="normal"> 7154</span>
<span class="normal"> 7155</span>
<span class="normal"> 7156</span>
<span class="normal"> 7157</span>
<span class="normal"> 7158</span>
<span class="normal"> 7159</span>
<span class="normal"> 7160</span>
<span class="normal"> 7161</span>
<span class="normal"> 7162</span>
<span class="normal"> 7163</span>
<span class="normal"> 7164</span>
<span class="normal"> 7165</span>
<span class="normal"> 7166</span>
<span class="normal"> 7167</span>
<span class="normal"> 7168</span>
<span class="normal"> 7169</span>
<span class="normal"> 7170</span>
<span class="normal"> 7171</span>
<span class="normal"> 7172</span>
<span class="normal"> 7173</span>
<span class="normal"> 7174</span>
<span class="normal"> 7175</span>
<span class="normal"> 7176</span>
<span class="normal"> 7177</span>
<span class="normal"> 7178</span>
<span class="normal"> 7179</span>
<span class="normal"> 7180</span>
<span class="normal"> 7181</span>
<span class="normal"> 7182</span>
<span class="normal"> 7183</span>
<span class="normal"> 7184</span>
<span class="normal"> 7185</span>
<span class="normal"> 7186</span>
<span class="normal"> 7187</span>
<span class="normal"> 7188</span>
<span class="normal"> 7189</span>
<span class="normal"> 7190</span>
<span class="normal"> 7191</span>
<span class="normal"> 7192</span>
<span class="normal"> 7193</span>
<span class="normal"> 7194</span>
<span class="normal"> 7195</span>
<span class="normal"> 7196</span>
<span class="normal"> 7197</span>
<span class="normal"> 7198</span>
<span class="normal"> 7199</span>
<span class="normal"> 7200</span>
<span class="normal"> 7201</span>
<span class="normal"> 7202</span>
<span class="normal"> 7203</span>
<span class="normal"> 7204</span>
<span class="normal"> 7205</span>
<span class="normal"> 7206</span>
<span class="normal"> 7207</span>
<span class="normal"> 7208</span>
<span class="normal"> 7209</span>
<span class="normal"> 7210</span>
<span class="normal"> 7211</span>
<span class="normal"> 7212</span>
<span class="normal"> 7213</span>
<span class="normal"> 7214</span>
<span class="normal"> 7215</span>
<span class="normal"> 7216</span>
<span class="normal"> 7217</span>
<span class="normal"> 7218</span>
<span class="normal"> 7219</span>
<span class="normal"> 7220</span>
<span class="normal"> 7221</span>
<span class="normal"> 7222</span>
<span class="normal"> 7223</span>
<span class="normal"> 7224</span>
<span class="normal"> 7225</span>
<span class="normal"> 7226</span>
<span class="normal"> 7227</span>
<span class="normal"> 7228</span>
<span class="normal"> 7229</span>
<span class="normal"> 7230</span>
<span class="normal"> 7231</span>
<span class="normal"> 7232</span>
<span class="normal"> 7233</span>
<span class="normal"> 7234</span>
<span class="normal"> 7235</span>
<span class="normal"> 7236</span>
<span class="normal"> 7237</span>
<span class="normal"> 7238</span>
<span class="normal"> 7239</span>
<span class="normal"> 7240</span>
<span class="normal"> 7241</span>
<span class="normal"> 7242</span>
<span class="normal"> 7243</span>
<span class="normal"> 7244</span>
<span class="normal"> 7245</span>
<span class="normal"> 7246</span>
<span class="normal"> 7247</span>
<span class="normal"> 7248</span>
<span class="normal"> 7249</span>
<span class="normal"> 7250</span>
<span class="normal"> 7251</span>
<span class="normal"> 7252</span>
<span class="normal"> 7253</span>
<span class="normal"> 7254</span>
<span class="normal"> 7255</span>
<span class="normal"> 7256</span>
<span class="normal"> 7257</span>
<span class="normal"> 7258</span>
<span class="normal"> 7259</span>
<span class="normal"> 7260</span>
<span class="normal"> 7261</span>
<span class="normal"> 7262</span>
<span class="normal"> 7263</span>
<span class="normal"> 7264</span>
<span class="normal"> 7265</span>
<span class="normal"> 7266</span>
<span class="normal"> 7267</span>
<span class="normal"> 7268</span>
<span class="normal"> 7269</span>
<span class="normal"> 7270</span>
<span class="normal"> 7271</span>
<span class="normal"> 7272</span>
<span class="normal"> 7273</span>
<span class="normal"> 7274</span>
<span class="normal"> 7275</span>
<span class="normal"> 7276</span>
<span class="normal"> 7277</span>
<span class="normal"> 7278</span>
<span class="normal"> 7279</span>
<span class="normal"> 7280</span>
<span class="normal"> 7281</span>
<span class="normal"> 7282</span>
<span class="normal"> 7283</span>
<span class="normal"> 7284</span>
<span class="normal"> 7285</span>
<span class="normal"> 7286</span>
<span class="normal"> 7287</span>
<span class="normal"> 7288</span>
<span class="normal"> 7289</span>
<span class="normal"> 7290</span>
<span class="normal"> 7291</span>
<span class="normal"> 7292</span>
<span class="normal"> 7293</span>
<span class="normal"> 7294</span>
<span class="normal"> 7295</span>
<span class="normal"> 7296</span>
<span class="normal"> 7297</span>
<span class="normal"> 7298</span>
<span class="normal"> 7299</span>
<span class="normal"> 7300</span>
<span class="normal"> 7301</span>
<span class="normal"> 7302</span>
<span class="normal"> 7303</span>
<span class="normal"> 7304</span>
<span class="normal"> 7305</span>
<span class="normal"> 7306</span>
<span class="normal"> 7307</span>
<span class="normal"> 7308</span>
<span class="normal"> 7309</span>
<span class="normal"> 7310</span>
<span class="normal"> 7311</span>
<span class="normal"> 7312</span>
<span class="normal"> 7313</span>
<span class="normal"> 7314</span>
<span class="normal"> 7315</span>
<span class="normal"> 7316</span>
<span class="normal"> 7317</span>
<span class="normal"> 7318</span>
<span class="normal"> 7319</span>
<span class="normal"> 7320</span>
<span class="normal"> 7321</span>
<span class="normal"> 7322</span>
<span class="normal"> 7323</span>
<span class="normal"> 7324</span>
<span class="normal"> 7325</span>
<span class="normal"> 7326</span>
<span class="normal"> 7327</span>
<span class="normal"> 7328</span>
<span class="normal"> 7329</span>
<span class="normal"> 7330</span>
<span class="normal"> 7331</span>
<span class="normal"> 7332</span>
<span class="normal"> 7333</span>
<span class="normal"> 7334</span>
<span class="normal"> 7335</span>
<span class="normal"> 7336</span>
<span class="normal"> 7337</span>
<span class="normal"> 7338</span>
<span class="normal"> 7339</span>
<span class="normal"> 7340</span>
<span class="normal"> 7341</span>
<span class="normal"> 7342</span>
<span class="normal"> 7343</span>
<span class="normal"> 7344</span>
<span class="normal"> 7345</span>
<span class="normal"> 7346</span>
<span class="normal"> 7347</span>
<span class="normal"> 7348</span>
<span class="normal"> 7349</span>
<span class="normal"> 7350</span>
<span class="normal"> 7351</span>
<span class="normal"> 7352</span>
<span class="normal"> 7353</span>
<span class="normal"> 7354</span>
<span class="normal"> 7355</span>
<span class="normal"> 7356</span>
<span class="normal"> 7357</span>
<span class="normal"> 7358</span>
<span class="normal"> 7359</span>
<span class="normal"> 7360</span>
<span class="normal"> 7361</span>
<span class="normal"> 7362</span>
<span class="normal"> 7363</span>
<span class="normal"> 7364</span>
<span class="normal"> 7365</span>
<span class="normal"> 7366</span>
<span class="normal"> 7367</span>
<span class="normal"> 7368</span>
<span class="normal"> 7369</span>
<span class="normal"> 7370</span>
<span class="normal"> 7371</span>
<span class="normal"> 7372</span>
<span class="normal"> 7373</span>
<span class="normal"> 7374</span>
<span class="normal"> 7375</span>
<span class="normal"> 7376</span>
<span class="normal"> 7377</span>
<span class="normal"> 7378</span>
<span class="normal"> 7379</span>
<span class="normal"> 7380</span>
<span class="normal"> 7381</span>
<span class="normal"> 7382</span>
<span class="normal"> 7383</span>
<span class="normal"> 7384</span>
<span class="normal"> 7385</span>
<span class="normal"> 7386</span>
<span class="normal"> 7387</span>
<span class="normal"> 7388</span>
<span class="normal"> 7389</span>
<span class="normal"> 7390</span>
<span class="normal"> 7391</span>
<span class="normal"> 7392</span>
<span class="normal"> 7393</span>
<span class="normal"> 7394</span>
<span class="normal"> 7395</span>
<span class="normal"> 7396</span>
<span class="normal"> 7397</span>
<span class="normal"> 7398</span>
<span class="normal"> 7399</span>
<span class="normal"> 7400</span>
<span class="normal"> 7401</span>
<span class="normal"> 7402</span>
<span class="normal"> 7403</span>
<span class="normal"> 7404</span>
<span class="normal"> 7405</span>
<span class="normal"> 7406</span>
<span class="normal"> 7407</span>
<span class="normal"> 7408</span>
<span class="normal"> 7409</span>
<span class="normal"> 7410</span>
<span class="normal"> 7411</span>
<span class="normal"> 7412</span>
<span class="normal"> 7413</span>
<span class="normal"> 7414</span>
<span class="normal"> 7415</span>
<span class="normal"> 7416</span>
<span class="normal"> 7417</span>
<span class="normal"> 7418</span>
<span class="normal"> 7419</span>
<span class="normal"> 7420</span>
<span class="normal"> 7421</span>
<span class="normal"> 7422</span>
<span class="normal"> 7423</span>
<span class="normal"> 7424</span>
<span class="normal"> 7425</span>
<span class="normal"> 7426</span>
<span class="normal"> 7427</span>
<span class="normal"> 7428</span>
<span class="normal"> 7429</span>
<span class="normal"> 7430</span>
<span class="normal"> 7431</span>
<span class="normal"> 7432</span>
<span class="normal"> 7433</span>
<span class="normal"> 7434</span>
<span class="normal"> 7435</span>
<span class="normal"> 7436</span>
<span class="normal"> 7437</span>
<span class="normal"> 7438</span>
<span class="normal"> 7439</span>
<span class="normal"> 7440</span>
<span class="normal"> 7441</span>
<span class="normal"> 7442</span>
<span class="normal"> 7443</span>
<span class="normal"> 7444</span>
<span class="normal"> 7445</span>
<span class="normal"> 7446</span>
<span class="normal"> 7447</span>
<span class="normal"> 7448</span>
<span class="normal"> 7449</span>
<span class="normal"> 7450</span>
<span class="normal"> 7451</span>
<span class="normal"> 7452</span>
<span class="normal"> 7453</span>
<span class="normal"> 7454</span>
<span class="normal"> 7455</span>
<span class="normal"> 7456</span>
<span class="normal"> 7457</span>
<span class="normal"> 7458</span>
<span class="normal"> 7459</span>
<span class="normal"> 7460</span>
<span class="normal"> 7461</span>
<span class="normal"> 7462</span>
<span class="normal"> 7463</span>
<span class="normal"> 7464</span>
<span class="normal"> 7465</span>
<span class="normal"> 7466</span>
<span class="normal"> 7467</span>
<span class="normal"> 7468</span>
<span class="normal"> 7469</span>
<span class="normal"> 7470</span>
<span class="normal"> 7471</span>
<span class="normal"> 7472</span>
<span class="normal"> 7473</span>
<span class="normal"> 7474</span>
<span class="normal"> 7475</span>
<span class="normal"> 7476</span>
<span class="normal"> 7477</span>
<span class="normal"> 7478</span>
<span class="normal"> 7479</span>
<span class="normal"> 7480</span>
<span class="normal"> 7481</span>
<span class="normal"> 7482</span>
<span class="normal"> 7483</span>
<span class="normal"> 7484</span>
<span class="normal"> 7485</span>
<span class="normal"> 7486</span>
<span class="normal"> 7487</span>
<span class="normal"> 7488</span>
<span class="normal"> 7489</span>
<span class="normal"> 7490</span>
<span class="normal"> 7491</span>
<span class="normal"> 7492</span>
<span class="normal"> 7493</span>
<span class="normal"> 7494</span>
<span class="normal"> 7495</span>
<span class="normal"> 7496</span>
<span class="normal"> 7497</span>
<span class="normal"> 7498</span>
<span class="normal"> 7499</span>
<span class="normal"> 7500</span>
<span class="normal"> 7501</span>
<span class="normal"> 7502</span>
<span class="normal"> 7503</span>
<span class="normal"> 7504</span>
<span class="normal"> 7505</span>
<span class="normal"> 7506</span>
<span class="normal"> 7507</span>
<span class="normal"> 7508</span>
<span class="normal"> 7509</span>
<span class="normal"> 7510</span>
<span class="normal"> 7511</span>
<span class="normal"> 7512</span>
<span class="normal"> 7513</span>
<span class="normal"> 7514</span>
<span class="normal"> 7515</span>
<span class="normal"> 7516</span>
<span class="normal"> 7517</span>
<span class="normal"> 7518</span>
<span class="normal"> 7519</span>
<span class="normal"> 7520</span>
<span class="normal"> 7521</span>
<span class="normal"> 7522</span>
<span class="normal"> 7523</span>
<span class="normal"> 7524</span>
<span class="normal"> 7525</span>
<span class="normal"> 7526</span>
<span class="normal"> 7527</span>
<span class="normal"> 7528</span>
<span class="normal"> 7529</span>
<span class="normal"> 7530</span>
<span class="normal"> 7531</span>
<span class="normal"> 7532</span>
<span class="normal"> 7533</span>
<span class="normal"> 7534</span>
<span class="normal"> 7535</span>
<span class="normal"> 7536</span>
<span class="normal"> 7537</span>
<span class="normal"> 7538</span>
<span class="normal"> 7539</span>
<span class="normal"> 7540</span>
<span class="normal"> 7541</span>
<span class="normal"> 7542</span>
<span class="normal"> 7543</span>
<span class="normal"> 7544</span>
<span class="normal"> 7545</span>
<span class="normal"> 7546</span>
<span class="normal"> 7547</span>
<span class="normal"> 7548</span>
<span class="normal"> 7549</span>
<span class="normal"> 7550</span>
<span class="normal"> 7551</span>
<span class="normal"> 7552</span>
<span class="normal"> 7553</span>
<span class="normal"> 7554</span>
<span class="normal"> 7555</span>
<span class="normal"> 7556</span>
<span class="normal"> 7557</span>
<span class="normal"> 7558</span>
<span class="normal"> 7559</span>
<span class="normal"> 7560</span>
<span class="normal"> 7561</span>
<span class="normal"> 7562</span>
<span class="normal"> 7563</span>
<span class="normal"> 7564</span>
<span class="normal"> 7565</span>
<span class="normal"> 7566</span>
<span class="normal"> 7567</span>
<span class="normal"> 7568</span>
<span class="normal"> 7569</span>
<span class="normal"> 7570</span>
<span class="normal"> 7571</span>
<span class="normal"> 7572</span>
<span class="normal"> 7573</span>
<span class="normal"> 7574</span>
<span class="normal"> 7575</span>
<span class="normal"> 7576</span>
<span class="normal"> 7577</span>
<span class="normal"> 7578</span>
<span class="normal"> 7579</span>
<span class="normal"> 7580</span>
<span class="normal"> 7581</span>
<span class="normal"> 7582</span>
<span class="normal"> 7583</span>
<span class="normal"> 7584</span>
<span class="normal"> 7585</span>
<span class="normal"> 7586</span>
<span class="normal"> 7587</span>
<span class="normal"> 7588</span>
<span class="normal"> 7589</span>
<span class="normal"> 7590</span>
<span class="normal"> 7591</span>
<span class="normal"> 7592</span>
<span class="normal"> 7593</span>
<span class="normal"> 7594</span>
<span class="normal"> 7595</span>
<span class="normal"> 7596</span>
<span class="normal"> 7597</span>
<span class="normal"> 7598</span>
<span class="normal"> 7599</span>
<span class="normal"> 7600</span>
<span class="normal"> 7601</span>
<span class="normal"> 7602</span>
<span class="normal"> 7603</span>
<span class="normal"> 7604</span>
<span class="normal"> 7605</span>
<span class="normal"> 7606</span>
<span class="normal"> 7607</span>
<span class="normal"> 7608</span>
<span class="normal"> 7609</span>
<span class="normal"> 7610</span>
<span class="normal"> 7611</span>
<span class="normal"> 7612</span>
<span class="normal"> 7613</span>
<span class="normal"> 7614</span>
<span class="normal"> 7615</span>
<span class="normal"> 7616</span>
<span class="normal"> 7617</span>
<span class="normal"> 7618</span>
<span class="normal"> 7619</span>
<span class="normal"> 7620</span>
<span class="normal"> 7621</span>
<span class="normal"> 7622</span>
<span class="normal"> 7623</span>
<span class="normal"> 7624</span>
<span class="normal"> 7625</span>
<span class="normal"> 7626</span>
<span class="normal"> 7627</span>
<span class="normal"> 7628</span>
<span class="normal"> 7629</span>
<span class="normal"> 7630</span>
<span class="normal"> 7631</span>
<span class="normal"> 7632</span>
<span class="normal"> 7633</span>
<span class="normal"> 7634</span>
<span class="normal"> 7635</span>
<span class="normal"> 7636</span>
<span class="normal"> 7637</span>
<span class="normal"> 7638</span>
<span class="normal"> 7639</span>
<span class="normal"> 7640</span>
<span class="normal"> 7641</span>
<span class="normal"> 7642</span>
<span class="normal"> 7643</span>
<span class="normal"> 7644</span>
<span class="normal"> 7645</span>
<span class="normal"> 7646</span>
<span class="normal"> 7647</span>
<span class="normal"> 7648</span>
<span class="normal"> 7649</span>
<span class="normal"> 7650</span>
<span class="normal"> 7651</span>
<span class="normal"> 7652</span>
<span class="normal"> 7653</span>
<span class="normal"> 7654</span>
<span class="normal"> 7655</span>
<span class="normal"> 7656</span>
<span class="normal"> 7657</span>
<span class="normal"> 7658</span>
<span class="normal"> 7659</span>
<span class="normal"> 7660</span>
<span class="normal"> 7661</span>
<span class="normal"> 7662</span>
<span class="normal"> 7663</span>
<span class="normal"> 7664</span>
<span class="normal"> 7665</span>
<span class="normal"> 7666</span>
<span class="normal"> 7667</span>
<span class="normal"> 7668</span>
<span class="normal"> 7669</span>
<span class="normal"> 7670</span>
<span class="normal"> 7671</span>
<span class="normal"> 7672</span>
<span class="normal"> 7673</span>
<span class="normal"> 7674</span>
<span class="normal"> 7675</span>
<span class="normal"> 7676</span>
<span class="normal"> 7677</span>
<span class="normal"> 7678</span>
<span class="normal"> 7679</span>
<span class="normal"> 7680</span>
<span class="normal"> 7681</span>
<span class="normal"> 7682</span>
<span class="normal"> 7683</span>
<span class="normal"> 7684</span>
<span class="normal"> 7685</span>
<span class="normal"> 7686</span>
<span class="normal"> 7687</span>
<span class="normal"> 7688</span>
<span class="normal"> 7689</span>
<span class="normal"> 7690</span>
<span class="normal"> 7691</span>
<span class="normal"> 7692</span>
<span class="normal"> 7693</span>
<span class="normal"> 7694</span>
<span class="normal"> 7695</span>
<span class="normal"> 7696</span>
<span class="normal"> 7697</span>
<span class="normal"> 7698</span>
<span class="normal"> 7699</span>
<span class="normal"> 7700</span>
<span class="normal"> 7701</span>
<span class="normal"> 7702</span>
<span class="normal"> 7703</span>
<span class="normal"> 7704</span>
<span class="normal"> 7705</span>
<span class="normal"> 7706</span>
<span class="normal"> 7707</span>
<span class="normal"> 7708</span>
<span class="normal"> 7709</span>
<span class="normal"> 7710</span>
<span class="normal"> 7711</span>
<span class="normal"> 7712</span>
<span class="normal"> 7713</span>
<span class="normal"> 7714</span>
<span class="normal"> 7715</span>
<span class="normal"> 7716</span>
<span class="normal"> 7717</span>
<span class="normal"> 7718</span>
<span class="normal"> 7719</span>
<span class="normal"> 7720</span>
<span class="normal"> 7721</span>
<span class="normal"> 7722</span>
<span class="normal"> 7723</span>
<span class="normal"> 7724</span>
<span class="normal"> 7725</span>
<span class="normal"> 7726</span>
<span class="normal"> 7727</span>
<span class="normal"> 7728</span>
<span class="normal"> 7729</span>
<span class="normal"> 7730</span>
<span class="normal"> 7731</span>
<span class="normal"> 7732</span>
<span class="normal"> 7733</span>
<span class="normal"> 7734</span>
<span class="normal"> 7735</span>
<span class="normal"> 7736</span>
<span class="normal"> 7737</span>
<span class="normal"> 7738</span>
<span class="normal"> 7739</span>
<span class="normal"> 7740</span>
<span class="normal"> 7741</span>
<span class="normal"> 7742</span>
<span class="normal"> 7743</span>
<span class="normal"> 7744</span>
<span class="normal"> 7745</span>
<span class="normal"> 7746</span>
<span class="normal"> 7747</span>
<span class="normal"> 7748</span>
<span class="normal"> 7749</span>
<span class="normal"> 7750</span>
<span class="normal"> 7751</span>
<span class="normal"> 7752</span>
<span class="normal"> 7753</span>
<span class="normal"> 7754</span>
<span class="normal"> 7755</span>
<span class="normal"> 7756</span>
<span class="normal"> 7757</span>
<span class="normal"> 7758</span>
<span class="normal"> 7759</span>
<span class="normal"> 7760</span>
<span class="normal"> 7761</span>
<span class="normal"> 7762</span>
<span class="normal"> 7763</span>
<span class="normal"> 7764</span>
<span class="normal"> 7765</span>
<span class="normal"> 7766</span>
<span class="normal"> 7767</span>
<span class="normal"> 7768</span>
<span class="normal"> 7769</span>
<span class="normal"> 7770</span>
<span class="normal"> 7771</span>
<span class="normal"> 7772</span>
<span class="normal"> 7773</span>
<span class="normal"> 7774</span>
<span class="normal"> 7775</span>
<span class="normal"> 7776</span>
<span class="normal"> 7777</span>
<span class="normal"> 7778</span>
<span class="normal"> 7779</span>
<span class="normal"> 7780</span>
<span class="normal"> 7781</span>
<span class="normal"> 7782</span>
<span class="normal"> 7783</span>
<span class="normal"> 7784</span>
<span class="normal"> 7785</span>
<span class="normal"> 7786</span>
<span class="normal"> 7787</span>
<span class="normal"> 7788</span>
<span class="normal"> 7789</span>
<span class="normal"> 7790</span>
<span class="normal"> 7791</span>
<span class="normal"> 7792</span>
<span class="normal"> 7793</span>
<span class="normal"> 7794</span>
<span class="normal"> 7795</span>
<span class="normal"> 7796</span>
<span class="normal"> 7797</span>
<span class="normal"> 7798</span>
<span class="normal"> 7799</span>
<span class="normal"> 7800</span>
<span class="normal"> 7801</span>
<span class="normal"> 7802</span>
<span class="normal"> 7803</span>
<span class="normal"> 7804</span>
<span class="normal"> 7805</span>
<span class="normal"> 7806</span>
<span class="normal"> 7807</span>
<span class="normal"> 7808</span>
<span class="normal"> 7809</span>
<span class="normal"> 7810</span>
<span class="normal"> 7811</span>
<span class="normal"> 7812</span>
<span class="normal"> 7813</span>
<span class="normal"> 7814</span>
<span class="normal"> 7815</span>
<span class="normal"> 7816</span>
<span class="normal"> 7817</span>
<span class="normal"> 7818</span>
<span class="normal"> 7819</span>
<span class="normal"> 7820</span>
<span class="normal"> 7821</span>
<span class="normal"> 7822</span>
<span class="normal"> 7823</span>
<span class="normal"> 7824</span>
<span class="normal"> 7825</span>
<span class="normal"> 7826</span>
<span class="normal"> 7827</span>
<span class="normal"> 7828</span>
<span class="normal"> 7829</span>
<span class="normal"> 7830</span>
<span class="normal"> 7831</span>
<span class="normal"> 7832</span>
<span class="normal"> 7833</span>
<span class="normal"> 7834</span>
<span class="normal"> 7835</span>
<span class="normal"> 7836</span>
<span class="normal"> 7837</span>
<span class="normal"> 7838</span>
<span class="normal"> 7839</span>
<span class="normal"> 7840</span>
<span class="normal"> 7841</span>
<span class="normal"> 7842</span>
<span class="normal"> 7843</span>
<span class="normal"> 7844</span>
<span class="normal"> 7845</span>
<span class="normal"> 7846</span>
<span class="normal"> 7847</span>
<span class="normal"> 7848</span>
<span class="normal"> 7849</span>
<span class="normal"> 7850</span>
<span class="normal"> 7851</span>
<span class="normal"> 7852</span>
<span class="normal"> 7853</span>
<span class="normal"> 7854</span>
<span class="normal"> 7855</span>
<span class="normal"> 7856</span>
<span class="normal"> 7857</span>
<span class="normal"> 7858</span>
<span class="normal"> 7859</span>
<span class="normal"> 7860</span>
<span class="normal"> 7861</span>
<span class="normal"> 7862</span>
<span class="normal"> 7863</span>
<span class="normal"> 7864</span>
<span class="normal"> 7865</span>
<span class="normal"> 7866</span>
<span class="normal"> 7867</span>
<span class="normal"> 7868</span>
<span class="normal"> 7869</span>
<span class="normal"> 7870</span>
<span class="normal"> 7871</span>
<span class="normal"> 7872</span>
<span class="normal"> 7873</span>
<span class="normal"> 7874</span>
<span class="normal"> 7875</span>
<span class="normal"> 7876</span>
<span class="normal"> 7877</span>
<span class="normal"> 7878</span>
<span class="normal"> 7879</span>
<span class="normal"> 7880</span>
<span class="normal"> 7881</span>
<span class="normal"> 7882</span>
<span class="normal"> 7883</span>
<span class="normal"> 7884</span>
<span class="normal"> 7885</span>
<span class="normal"> 7886</span>
<span class="normal"> 7887</span>
<span class="normal"> 7888</span>
<span class="normal"> 7889</span>
<span class="normal"> 7890</span>
<span class="normal"> 7891</span>
<span class="normal"> 7892</span>
<span class="normal"> 7893</span>
<span class="normal"> 7894</span>
<span class="normal"> 7895</span>
<span class="normal"> 7896</span>
<span class="normal"> 7897</span>
<span class="normal"> 7898</span>
<span class="normal"> 7899</span>
<span class="normal"> 7900</span>
<span class="normal"> 7901</span>
<span class="normal"> 7902</span>
<span class="normal"> 7903</span>
<span class="normal"> 7904</span>
<span class="normal"> 7905</span>
<span class="normal"> 7906</span>
<span class="normal"> 7907</span>
<span class="normal"> 7908</span>
<span class="normal"> 7909</span>
<span class="normal"> 7910</span>
<span class="normal"> 7911</span>
<span class="normal"> 7912</span>
<span class="normal"> 7913</span>
<span class="normal"> 7914</span>
<span class="normal"> 7915</span>
<span class="normal"> 7916</span>
<span class="normal"> 7917</span>
<span class="normal"> 7918</span>
<span class="normal"> 7919</span>
<span class="normal"> 7920</span>
<span class="normal"> 7921</span>
<span class="normal"> 7922</span>
<span class="normal"> 7923</span>
<span class="normal"> 7924</span>
<span class="normal"> 7925</span>
<span class="normal"> 7926</span>
<span class="normal"> 7927</span>
<span class="normal"> 7928</span>
<span class="normal"> 7929</span>
<span class="normal"> 7930</span>
<span class="normal"> 7931</span>
<span class="normal"> 7932</span>
<span class="normal"> 7933</span>
<span class="normal"> 7934</span>
<span class="normal"> 7935</span>
<span class="normal"> 7936</span>
<span class="normal"> 7937</span>
<span class="normal"> 7938</span>
<span class="normal"> 7939</span>
<span class="normal"> 7940</span>
<span class="normal"> 7941</span>
<span class="normal"> 7942</span>
<span class="normal"> 7943</span>
<span class="normal"> 7944</span>
<span class="normal"> 7945</span>
<span class="normal"> 7946</span>
<span class="normal"> 7947</span>
<span class="normal"> 7948</span>
<span class="normal"> 7949</span>
<span class="normal"> 7950</span>
<span class="normal"> 7951</span>
<span class="normal"> 7952</span>
<span class="normal"> 7953</span>
<span class="normal"> 7954</span>
<span class="normal"> 7955</span>
<span class="normal"> 7956</span>
<span class="normal"> 7957</span>
<span class="normal"> 7958</span>
<span class="normal"> 7959</span>
<span class="normal"> 7960</span>
<span class="normal"> 7961</span>
<span class="normal"> 7962</span>
<span class="normal"> 7963</span>
<span class="normal"> 7964</span>
<span class="normal"> 7965</span>
<span class="normal"> 7966</span>
<span class="normal"> 7967</span>
<span class="normal"> 7968</span>
<span class="normal"> 7969</span>
<span class="normal"> 7970</span>
<span class="normal"> 7971</span>
<span class="normal"> 7972</span>
<span class="normal"> 7973</span>
<span class="normal"> 7974</span>
<span class="normal"> 7975</span>
<span class="normal"> 7976</span>
<span class="normal"> 7977</span>
<span class="normal"> 7978</span>
<span class="normal"> 7979</span>
<span class="normal"> 7980</span>
<span class="normal"> 7981</span>
<span class="normal"> 7982</span>
<span class="normal"> 7983</span>
<span class="normal"> 7984</span>
<span class="normal"> 7985</span>
<span class="normal"> 7986</span>
<span class="normal"> 7987</span>
<span class="normal"> 7988</span>
<span class="normal"> 7989</span>
<span class="normal"> 7990</span>
<span class="normal"> 7991</span>
<span class="normal"> 7992</span>
<span class="normal"> 7993</span>
<span class="normal"> 7994</span>
<span class="normal"> 7995</span>
<span class="normal"> 7996</span>
<span class="normal"> 7997</span>
<span class="normal"> 7998</span>
<span class="normal"> 7999</span>
<span class="normal"> 8000</span>
<span class="normal"> 8001</span>
<span class="normal"> 8002</span>
<span class="normal"> 8003</span>
<span class="normal"> 8004</span>
<span class="normal"> 8005</span>
<span class="normal"> 8006</span>
<span class="normal"> 8007</span>
<span class="normal"> 8008</span>
<span class="normal"> 8009</span>
<span class="normal"> 8010</span>
<span class="normal"> 8011</span>
<span class="normal"> 8012</span>
<span class="normal"> 8013</span>
<span class="normal"> 8014</span>
<span class="normal"> 8015</span>
<span class="normal"> 8016</span>
<span class="normal"> 8017</span>
<span class="normal"> 8018</span>
<span class="normal"> 8019</span>
<span class="normal"> 8020</span>
<span class="normal"> 8021</span>
<span class="normal"> 8022</span>
<span class="normal"> 8023</span>
<span class="normal"> 8024</span>
<span class="normal"> 8025</span>
<span class="normal"> 8026</span>
<span class="normal"> 8027</span>
<span class="normal"> 8028</span>
<span class="normal"> 8029</span>
<span class="normal"> 8030</span>
<span class="normal"> 8031</span>
<span class="normal"> 8032</span>
<span class="normal"> 8033</span>
<span class="normal"> 8034</span>
<span class="normal"> 8035</span>
<span class="normal"> 8036</span>
<span class="normal"> 8037</span>
<span class="normal"> 8038</span>
<span class="normal"> 8039</span>
<span class="normal"> 8040</span>
<span class="normal"> 8041</span>
<span class="normal"> 8042</span>
<span class="normal"> 8043</span>
<span class="normal"> 8044</span>
<span class="normal"> 8045</span>
<span class="normal"> 8046</span>
<span class="normal"> 8047</span>
<span class="normal"> 8048</span>
<span class="normal"> 8049</span>
<span class="normal"> 8050</span>
<span class="normal"> 8051</span>
<span class="normal"> 8052</span>
<span class="normal"> 8053</span>
<span class="normal"> 8054</span>
<span class="normal"> 8055</span>
<span class="normal"> 8056</span>
<span class="normal"> 8057</span>
<span class="normal"> 8058</span>
<span class="normal"> 8059</span>
<span class="normal"> 8060</span>
<span class="normal"> 8061</span>
<span class="normal"> 8062</span>
<span class="normal"> 8063</span>
<span class="normal"> 8064</span>
<span class="normal"> 8065</span>
<span class="normal"> 8066</span>
<span class="normal"> 8067</span>
<span class="normal"> 8068</span>
<span class="normal"> 8069</span>
<span class="normal"> 8070</span>
<span class="normal"> 8071</span>
<span class="normal"> 8072</span>
<span class="normal"> 8073</span>
<span class="normal"> 8074</span>
<span class="normal"> 8075</span>
<span class="normal"> 8076</span>
<span class="normal"> 8077</span>
<span class="normal"> 8078</span>
<span class="normal"> 8079</span>
<span class="normal"> 8080</span>
<span class="normal"> 8081</span>
<span class="normal"> 8082</span>
<span class="normal"> 8083</span>
<span class="normal"> 8084</span>
<span class="normal"> 8085</span>
<span class="normal"> 8086</span>
<span class="normal"> 8087</span>
<span class="normal"> 8088</span>
<span class="normal"> 8089</span>
<span class="normal"> 8090</span>
<span class="normal"> 8091</span>
<span class="normal"> 8092</span>
<span class="normal"> 8093</span>
<span class="normal"> 8094</span>
<span class="normal"> 8095</span>
<span class="normal"> 8096</span>
<span class="normal"> 8097</span>
<span class="normal"> 8098</span>
<span class="normal"> 8099</span>
<span class="normal"> 8100</span>
<span class="normal"> 8101</span>
<span class="normal"> 8102</span>
<span class="normal"> 8103</span>
<span class="normal"> 8104</span>
<span class="normal"> 8105</span>
<span class="normal"> 8106</span>
<span class="normal"> 8107</span>
<span class="normal"> 8108</span>
<span class="normal"> 8109</span>
<span class="normal"> 8110</span>
<span class="normal"> 8111</span>
<span class="normal"> 8112</span>
<span class="normal"> 8113</span>
<span class="normal"> 8114</span>
<span class="normal"> 8115</span>
<span class="normal"> 8116</span>
<span class="normal"> 8117</span>
<span class="normal"> 8118</span>
<span class="normal"> 8119</span>
<span class="normal"> 8120</span>
<span class="normal"> 8121</span>
<span class="normal"> 8122</span>
<span class="normal"> 8123</span>
<span class="normal"> 8124</span>
<span class="normal"> 8125</span>
<span class="normal"> 8126</span>
<span class="normal"> 8127</span>
<span class="normal"> 8128</span>
<span class="normal"> 8129</span>
<span class="normal"> 8130</span>
<span class="normal"> 8131</span>
<span class="normal"> 8132</span>
<span class="normal"> 8133</span>
<span class="normal"> 8134</span>
<span class="normal"> 8135</span>
<span class="normal"> 8136</span>
<span class="normal"> 8137</span>
<span class="normal"> 8138</span>
<span class="normal"> 8139</span>
<span class="normal"> 8140</span>
<span class="normal"> 8141</span>
<span class="normal"> 8142</span>
<span class="normal"> 8143</span>
<span class="normal"> 8144</span>
<span class="normal"> 8145</span>
<span class="normal"> 8146</span>
<span class="normal"> 8147</span>
<span class="normal"> 8148</span>
<span class="normal"> 8149</span>
<span class="normal"> 8150</span>
<span class="normal"> 8151</span>
<span class="normal"> 8152</span>
<span class="normal"> 8153</span>
<span class="normal"> 8154</span>
<span class="normal"> 8155</span>
<span class="normal"> 8156</span>
<span class="normal"> 8157</span>
<span class="normal"> 8158</span>
<span class="normal"> 8159</span>
<span class="normal"> 8160</span>
<span class="normal"> 8161</span>
<span class="normal"> 8162</span>
<span class="normal"> 8163</span>
<span class="normal"> 8164</span>
<span class="normal"> 8165</span>
<span class="normal"> 8166</span>
<span class="normal"> 8167</span>
<span class="normal"> 8168</span>
<span class="normal"> 8169</span>
<span class="normal"> 8170</span>
<span class="normal"> 8171</span>
<span class="normal"> 8172</span>
<span class="normal"> 8173</span>
<span class="normal"> 8174</span>
<span class="normal"> 8175</span>
<span class="normal"> 8176</span>
<span class="normal"> 8177</span>
<span class="normal"> 8178</span>
<span class="normal"> 8179</span>
<span class="normal"> 8180</span>
<span class="normal"> 8181</span>
<span class="normal"> 8182</span>
<span class="normal"> 8183</span>
<span class="normal"> 8184</span>
<span class="normal"> 8185</span>
<span class="normal"> 8186</span>
<span class="normal"> 8187</span>
<span class="normal"> 8188</span>
<span class="normal"> 8189</span>
<span class="normal"> 8190</span>
<span class="normal"> 8191</span>
<span class="normal"> 8192</span>
<span class="normal"> 8193</span>
<span class="normal"> 8194</span>
<span class="normal"> 8195</span>
<span class="normal"> 8196</span>
<span class="normal"> 8197</span>
<span class="normal"> 8198</span>
<span class="normal"> 8199</span>
<span class="normal"> 8200</span>
<span class="normal"> 8201</span>
<span class="normal"> 8202</span>
<span class="normal"> 8203</span>
<span class="normal"> 8204</span>
<span class="normal"> 8205</span>
<span class="normal"> 8206</span>
<span class="normal"> 8207</span>
<span class="normal"> 8208</span>
<span class="normal"> 8209</span>
<span class="normal"> 8210</span>
<span class="normal"> 8211</span>
<span class="normal"> 8212</span>
<span class="normal"> 8213</span>
<span class="normal"> 8214</span>
<span class="normal"> 8215</span>
<span class="normal"> 8216</span>
<span class="normal"> 8217</span>
<span class="normal"> 8218</span>
<span class="normal"> 8219</span>
<span class="normal"> 8220</span>
<span class="normal"> 8221</span>
<span class="normal"> 8222</span>
<span class="normal"> 8223</span>
<span class="normal"> 8224</span>
<span class="normal"> 8225</span>
<span class="normal"> 8226</span>
<span class="normal"> 8227</span>
<span class="normal"> 8228</span>
<span class="normal"> 8229</span>
<span class="normal"> 8230</span>
<span class="normal"> 8231</span>
<span class="normal"> 8232</span>
<span class="normal"> 8233</span>
<span class="normal"> 8234</span>
<span class="normal"> 8235</span>
<span class="normal"> 8236</span>
<span class="normal"> 8237</span>
<span class="normal"> 8238</span>
<span class="normal"> 8239</span>
<span class="normal"> 8240</span>
<span class="normal"> 8241</span>
<span class="normal"> 8242</span>
<span class="normal"> 8243</span>
<span class="normal"> 8244</span>
<span class="normal"> 8245</span>
<span class="normal"> 8246</span>
<span class="normal"> 8247</span>
<span class="normal"> 8248</span>
<span class="normal"> 8249</span>
<span class="normal"> 8250</span>
<span class="normal"> 8251</span>
<span class="normal"> 8252</span>
<span class="normal"> 8253</span>
<span class="normal"> 8254</span>
<span class="normal"> 8255</span>
<span class="normal"> 8256</span>
<span class="normal"> 8257</span>
<span class="normal"> 8258</span>
<span class="normal"> 8259</span>
<span class="normal"> 8260</span>
<span class="normal"> 8261</span>
<span class="normal"> 8262</span>
<span class="normal"> 8263</span>
<span class="normal"> 8264</span>
<span class="normal"> 8265</span>
<span class="normal"> 8266</span>
<span class="normal"> 8267</span>
<span class="normal"> 8268</span>
<span class="normal"> 8269</span>
<span class="normal"> 8270</span>
<span class="normal"> 8271</span>
<span class="normal"> 8272</span>
<span class="normal"> 8273</span>
<span class="normal"> 8274</span>
<span class="normal"> 8275</span>
<span class="normal"> 8276</span>
<span class="normal"> 8277</span>
<span class="normal"> 8278</span>
<span class="normal"> 8279</span>
<span class="normal"> 8280</span>
<span class="normal"> 8281</span>
<span class="normal"> 8282</span>
<span class="normal"> 8283</span>
<span class="normal"> 8284</span>
<span class="normal"> 8285</span>
<span class="normal"> 8286</span>
<span class="normal"> 8287</span>
<span class="normal"> 8288</span>
<span class="normal"> 8289</span>
<span class="normal"> 8290</span>
<span class="normal"> 8291</span>
<span class="normal"> 8292</span>
<span class="normal"> 8293</span>
<span class="normal"> 8294</span>
<span class="normal"> 8295</span>
<span class="normal"> 8296</span>
<span class="normal"> 8297</span>
<span class="normal"> 8298</span>
<span class="normal"> 8299</span>
<span class="normal"> 8300</span>
<span class="normal"> 8301</span>
<span class="normal"> 8302</span>
<span class="normal"> 8303</span>
<span class="normal"> 8304</span>
<span class="normal"> 8305</span>
<span class="normal"> 8306</span>
<span class="normal"> 8307</span>
<span class="normal"> 8308</span>
<span class="normal"> 8309</span>
<span class="normal"> 8310</span>
<span class="normal"> 8311</span>
<span class="normal"> 8312</span>
<span class="normal"> 8313</span>
<span class="normal"> 8314</span>
<span class="normal"> 8315</span>
<span class="normal"> 8316</span>
<span class="normal"> 8317</span>
<span class="normal"> 8318</span>
<span class="normal"> 8319</span>
<span class="normal"> 8320</span>
<span class="normal"> 8321</span>
<span class="normal"> 8322</span>
<span class="normal"> 8323</span>
<span class="normal"> 8324</span>
<span class="normal"> 8325</span>
<span class="normal"> 8326</span>
<span class="normal"> 8327</span>
<span class="normal"> 8328</span>
<span class="normal"> 8329</span>
<span class="normal"> 8330</span>
<span class="normal"> 8331</span>
<span class="normal"> 8332</span>
<span class="normal"> 8333</span>
<span class="normal"> 8334</span>
<span class="normal"> 8335</span>
<span class="normal"> 8336</span>
<span class="normal"> 8337</span>
<span class="normal"> 8338</span>
<span class="normal"> 8339</span>
<span class="normal"> 8340</span>
<span class="normal"> 8341</span>
<span class="normal"> 8342</span>
<span class="normal"> 8343</span>
<span class="normal"> 8344</span>
<span class="normal"> 8345</span>
<span class="normal"> 8346</span>
<span class="normal"> 8347</span>
<span class="normal"> 8348</span>
<span class="normal"> 8349</span>
<span class="normal"> 8350</span>
<span class="normal"> 8351</span>
<span class="normal"> 8352</span>
<span class="normal"> 8353</span>
<span class="normal"> 8354</span>
<span class="normal"> 8355</span>
<span class="normal"> 8356</span>
<span class="normal"> 8357</span>
<span class="normal"> 8358</span>
<span class="normal"> 8359</span>
<span class="normal"> 8360</span>
<span class="normal"> 8361</span>
<span class="normal"> 8362</span>
<span class="normal"> 8363</span>
<span class="normal"> 8364</span>
<span class="normal"> 8365</span>
<span class="normal"> 8366</span>
<span class="normal"> 8367</span>
<span class="normal"> 8368</span>
<span class="normal"> 8369</span>
<span class="normal"> 8370</span>
<span class="normal"> 8371</span>
<span class="normal"> 8372</span>
<span class="normal"> 8373</span>
<span class="normal"> 8374</span>
<span class="normal"> 8375</span>
<span class="normal"> 8376</span>
<span class="normal"> 8377</span>
<span class="normal"> 8378</span>
<span class="normal"> 8379</span>
<span class="normal"> 8380</span>
<span class="normal"> 8381</span>
<span class="normal"> 8382</span>
<span class="normal"> 8383</span>
<span class="normal"> 8384</span>
<span class="normal"> 8385</span>
<span class="normal"> 8386</span>
<span class="normal"> 8387</span>
<span class="normal"> 8388</span>
<span class="normal"> 8389</span>
<span class="normal"> 8390</span>
<span class="normal"> 8391</span>
<span class="normal"> 8392</span>
<span class="normal"> 8393</span>
<span class="normal"> 8394</span>
<span class="normal"> 8395</span>
<span class="normal"> 8396</span>
<span class="normal"> 8397</span>
<span class="normal"> 8398</span>
<span class="normal"> 8399</span>
<span class="normal"> 8400</span>
<span class="normal"> 8401</span>
<span class="normal"> 8402</span>
<span class="normal"> 8403</span>
<span class="normal"> 8404</span>
<span class="normal"> 8405</span>
<span class="normal"> 8406</span>
<span class="normal"> 8407</span>
<span class="normal"> 8408</span>
<span class="normal"> 8409</span>
<span class="normal"> 8410</span>
<span class="normal"> 8411</span>
<span class="normal"> 8412</span>
<span class="normal"> 8413</span>
<span class="normal"> 8414</span>
<span class="normal"> 8415</span>
<span class="normal"> 8416</span>
<span class="normal"> 8417</span>
<span class="normal"> 8418</span>
<span class="normal"> 8419</span>
<span class="normal"> 8420</span>
<span class="normal"> 8421</span>
<span class="normal"> 8422</span>
<span class="normal"> 8423</span>
<span class="normal"> 8424</span>
<span class="normal"> 8425</span>
<span class="normal"> 8426</span>
<span class="normal"> 8427</span>
<span class="normal"> 8428</span>
<span class="normal"> 8429</span>
<span class="normal"> 8430</span>
<span class="normal"> 8431</span>
<span class="normal"> 8432</span>
<span class="normal"> 8433</span>
<span class="normal"> 8434</span>
<span class="normal"> 8435</span>
<span class="normal"> 8436</span>
<span class="normal"> 8437</span>
<span class="normal"> 8438</span>
<span class="normal"> 8439</span>
<span class="normal"> 8440</span>
<span class="normal"> 8441</span>
<span class="normal"> 8442</span>
<span class="normal"> 8443</span>
<span class="normal"> 8444</span>
<span class="normal"> 8445</span>
<span class="normal"> 8446</span>
<span class="normal"> 8447</span>
<span class="normal"> 8448</span>
<span class="normal"> 8449</span>
<span class="normal"> 8450</span>
<span class="normal"> 8451</span>
<span class="normal"> 8452</span>
<span class="normal"> 8453</span>
<span class="normal"> 8454</span>
<span class="normal"> 8455</span>
<span class="normal"> 8456</span>
<span class="normal"> 8457</span>
<span class="normal"> 8458</span>
<span class="normal"> 8459</span>
<span class="normal"> 8460</span>
<span class="normal"> 8461</span>
<span class="normal"> 8462</span>
<span class="normal"> 8463</span>
<span class="normal"> 8464</span>
<span class="normal"> 8465</span>
<span class="normal"> 8466</span>
<span class="normal"> 8467</span>
<span class="normal"> 8468</span>
<span class="normal"> 8469</span>
<span class="normal"> 8470</span>
<span class="normal"> 8471</span>
<span class="normal"> 8472</span>
<span class="normal"> 8473</span>
<span class="normal"> 8474</span>
<span class="normal"> 8475</span>
<span class="normal"> 8476</span>
<span class="normal"> 8477</span>
<span class="normal"> 8478</span>
<span class="normal"> 8479</span>
<span class="normal"> 8480</span>
<span class="normal"> 8481</span>
<span class="normal"> 8482</span>
<span class="normal"> 8483</span>
<span class="normal"> 8484</span>
<span class="normal"> 8485</span>
<span class="normal"> 8486</span>
<span class="normal"> 8487</span>
<span class="normal"> 8488</span>
<span class="normal"> 8489</span>
<span class="normal"> 8490</span>
<span class="normal"> 8491</span>
<span class="normal"> 8492</span>
<span class="normal"> 8493</span>
<span class="normal"> 8494</span>
<span class="normal"> 8495</span>
<span class="normal"> 8496</span>
<span class="normal"> 8497</span>
<span class="normal"> 8498</span>
<span class="normal"> 8499</span>
<span class="normal"> 8500</span>
<span class="normal"> 8501</span>
<span class="normal"> 8502</span>
<span class="normal"> 8503</span>
<span class="normal"> 8504</span>
<span class="normal"> 8505</span>
<span class="normal"> 8506</span>
<span class="normal"> 8507</span>
<span class="normal"> 8508</span>
<span class="normal"> 8509</span>
<span class="normal"> 8510</span>
<span class="normal"> 8511</span>
<span class="normal"> 8512</span>
<span class="normal"> 8513</span>
<span class="normal"> 8514</span>
<span class="normal"> 8515</span>
<span class="normal"> 8516</span>
<span class="normal"> 8517</span>
<span class="normal"> 8518</span>
<span class="normal"> 8519</span>
<span class="normal"> 8520</span>
<span class="normal"> 8521</span>
<span class="normal"> 8522</span>
<span class="normal"> 8523</span>
<span class="normal"> 8524</span>
<span class="normal"> 8525</span>
<span class="normal"> 8526</span>
<span class="normal"> 8527</span>
<span class="normal"> 8528</span>
<span class="normal"> 8529</span>
<span class="normal"> 8530</span>
<span class="normal"> 8531</span>
<span class="normal"> 8532</span>
<span class="normal"> 8533</span>
<span class="normal"> 8534</span>
<span class="normal"> 8535</span>
<span class="normal"> 8536</span>
<span class="normal"> 8537</span>
<span class="normal"> 8538</span>
<span class="normal"> 8539</span>
<span class="normal"> 8540</span>
<span class="normal"> 8541</span>
<span class="normal"> 8542</span>
<span class="normal"> 8543</span>
<span class="normal"> 8544</span>
<span class="normal"> 8545</span>
<span class="normal"> 8546</span>
<span class="normal"> 8547</span>
<span class="normal"> 8548</span>
<span class="normal"> 8549</span>
<span class="normal"> 8550</span>
<span class="normal"> 8551</span>
<span class="normal"> 8552</span>
<span class="normal"> 8553</span>
<span class="normal"> 8554</span>
<span class="normal"> 8555</span>
<span class="normal"> 8556</span>
<span class="normal"> 8557</span>
<span class="normal"> 8558</span>
<span class="normal"> 8559</span>
<span class="normal"> 8560</span>
<span class="normal"> 8561</span>
<span class="normal"> 8562</span>
<span class="normal"> 8563</span>
<span class="normal"> 8564</span>
<span class="normal"> 8565</span>
<span class="normal"> 8566</span>
<span class="normal"> 8567</span>
<span class="normal"> 8568</span>
<span class="normal"> 8569</span>
<span class="normal"> 8570</span>
<span class="normal"> 8571</span>
<span class="normal"> 8572</span>
<span class="normal"> 8573</span>
<span class="normal"> 8574</span>
<span class="normal"> 8575</span>
<span class="normal"> 8576</span>
<span class="normal"> 8577</span>
<span class="normal"> 8578</span>
<span class="normal"> 8579</span>
<span class="normal"> 8580</span>
<span class="normal"> 8581</span>
<span class="normal"> 8582</span>
<span class="normal"> 8583</span>
<span class="normal"> 8584</span>
<span class="normal"> 8585</span>
<span class="normal"> 8586</span>
<span class="normal"> 8587</span>
<span class="normal"> 8588</span>
<span class="normal"> 8589</span>
<span class="normal"> 8590</span>
<span class="normal"> 8591</span>
<span class="normal"> 8592</span>
<span class="normal"> 8593</span>
<span class="normal"> 8594</span>
<span class="normal"> 8595</span>
<span class="normal"> 8596</span>
<span class="normal"> 8597</span>
<span class="normal"> 8598</span>
<span class="normal"> 8599</span>
<span class="normal"> 8600</span>
<span class="normal"> 8601</span>
<span class="normal"> 8602</span>
<span class="normal"> 8603</span>
<span class="normal"> 8604</span>
<span class="normal"> 8605</span>
<span class="normal"> 8606</span>
<span class="normal"> 8607</span>
<span class="normal"> 8608</span>
<span class="normal"> 8609</span>
<span class="normal"> 8610</span>
<span class="normal"> 8611</span>
<span class="normal"> 8612</span>
<span class="normal"> 8613</span>
<span class="normal"> 8614</span>
<span class="normal"> 8615</span>
<span class="normal"> 8616</span>
<span class="normal"> 8617</span>
<span class="normal"> 8618</span>
<span class="normal"> 8619</span>
<span class="normal"> 8620</span>
<span class="normal"> 8621</span>
<span class="normal"> 8622</span>
<span class="normal"> 8623</span>
<span class="normal"> 8624</span>
<span class="normal"> 8625</span>
<span class="normal"> 8626</span>
<span class="normal"> 8627</span>
<span class="normal"> 8628</span>
<span class="normal"> 8629</span>
<span class="normal"> 8630</span>
<span class="normal"> 8631</span>
<span class="normal"> 8632</span>
<span class="normal"> 8633</span>
<span class="normal"> 8634</span>
<span class="normal"> 8635</span>
<span class="normal"> 8636</span>
<span class="normal"> 8637</span>
<span class="normal"> 8638</span>
<span class="normal"> 8639</span>
<span class="normal"> 8640</span>
<span class="normal"> 8641</span>
<span class="normal"> 8642</span>
<span class="normal"> 8643</span>
<span class="normal"> 8644</span>
<span class="normal"> 8645</span>
<span class="normal"> 8646</span>
<span class="normal"> 8647</span>
<span class="normal"> 8648</span>
<span class="normal"> 8649</span>
<span class="normal"> 8650</span>
<span class="normal"> 8651</span>
<span class="normal"> 8652</span>
<span class="normal"> 8653</span>
<span class="normal"> 8654</span>
<span class="normal"> 8655</span>
<span class="normal"> 8656</span>
<span class="normal"> 8657</span>
<span class="normal"> 8658</span>
<span class="normal"> 8659</span>
<span class="normal"> 8660</span>
<span class="normal"> 8661</span>
<span class="normal"> 8662</span>
<span class="normal"> 8663</span>
<span class="normal"> 8664</span>
<span class="normal"> 8665</span>
<span class="normal"> 8666</span>
<span class="normal"> 8667</span>
<span class="normal"> 8668</span>
<span class="normal"> 8669</span>
<span class="normal"> 8670</span>
<span class="normal"> 8671</span>
<span class="normal"> 8672</span>
<span class="normal"> 8673</span>
<span class="normal"> 8674</span>
<span class="normal"> 8675</span>
<span class="normal"> 8676</span>
<span class="normal"> 8677</span>
<span class="normal"> 8678</span>
<span class="normal"> 8679</span>
<span class="normal"> 8680</span>
<span class="normal"> 8681</span>
<span class="normal"> 8682</span>
<span class="normal"> 8683</span>
<span class="normal"> 8684</span>
<span class="normal"> 8685</span>
<span class="normal"> 8686</span>
<span class="normal"> 8687</span>
<span class="normal"> 8688</span>
<span class="normal"> 8689</span>
<span class="normal"> 8690</span>
<span class="normal"> 8691</span>
<span class="normal"> 8692</span>
<span class="normal"> 8693</span>
<span class="normal"> 8694</span>
<span class="normal"> 8695</span>
<span class="normal"> 8696</span>
<span class="normal"> 8697</span>
<span class="normal"> 8698</span>
<span class="normal"> 8699</span>
<span class="normal"> 8700</span>
<span class="normal"> 8701</span>
<span class="normal"> 8702</span>
<span class="normal"> 8703</span>
<span class="normal"> 8704</span>
<span class="normal"> 8705</span>
<span class="normal"> 8706</span>
<span class="normal"> 8707</span>
<span class="normal"> 8708</span>
<span class="normal"> 8709</span>
<span class="normal"> 8710</span>
<span class="normal"> 8711</span>
<span class="normal"> 8712</span>
<span class="normal"> 8713</span>
<span class="normal"> 8714</span>
<span class="normal"> 8715</span>
<span class="normal"> 8716</span>
<span class="normal"> 8717</span>
<span class="normal"> 8718</span>
<span class="normal"> 8719</span>
<span class="normal"> 8720</span>
<span class="normal"> 8721</span>
<span class="normal"> 8722</span>
<span class="normal"> 8723</span>
<span class="normal"> 8724</span>
<span class="normal"> 8725</span>
<span class="normal"> 8726</span>
<span class="normal"> 8727</span>
<span class="normal"> 8728</span>
<span class="normal"> 8729</span>
<span class="normal"> 8730</span>
<span class="normal"> 8731</span>
<span class="normal"> 8732</span>
<span class="normal"> 8733</span>
<span class="normal"> 8734</span>
<span class="normal"> 8735</span>
<span class="normal"> 8736</span>
<span class="normal"> 8737</span>
<span class="normal"> 8738</span>
<span class="normal"> 8739</span>
<span class="normal"> 8740</span>
<span class="normal"> 8741</span>
<span class="normal"> 8742</span>
<span class="normal"> 8743</span>
<span class="normal"> 8744</span>
<span class="normal"> 8745</span>
<span class="normal"> 8746</span>
<span class="normal"> 8747</span>
<span class="normal"> 8748</span>
<span class="normal"> 8749</span>
<span class="normal"> 8750</span>
<span class="normal"> 8751</span>
<span class="normal"> 8752</span>
<span class="normal"> 8753</span>
<span class="normal"> 8754</span>
<span class="normal"> 8755</span>
<span class="normal"> 8756</span>
<span class="normal"> 8757</span>
<span class="normal"> 8758</span>
<span class="normal"> 8759</span>
<span class="normal"> 8760</span>
<span class="normal"> 8761</span>
<span class="normal"> 8762</span>
<span class="normal"> 8763</span>
<span class="normal"> 8764</span>
<span class="normal"> 8765</span>
<span class="normal"> 8766</span>
<span class="normal"> 8767</span>
<span class="normal"> 8768</span>
<span class="normal"> 8769</span>
<span class="normal"> 8770</span>
<span class="normal"> 8771</span>
<span class="normal"> 8772</span>
<span class="normal"> 8773</span>
<span class="normal"> 8774</span>
<span class="normal"> 8775</span>
<span class="normal"> 8776</span>
<span class="normal"> 8777</span>
<span class="normal"> 8778</span>
<span class="normal"> 8779</span>
<span class="normal"> 8780</span>
<span class="normal"> 8781</span>
<span class="normal"> 8782</span>
<span class="normal"> 8783</span>
<span class="normal"> 8784</span>
<span class="normal"> 8785</span>
<span class="normal"> 8786</span>
<span class="normal"> 8787</span>
<span class="normal"> 8788</span>
<span class="normal"> 8789</span>
<span class="normal"> 8790</span>
<span class="normal"> 8791</span>
<span class="normal"> 8792</span>
<span class="normal"> 8793</span>
<span class="normal"> 8794</span>
<span class="normal"> 8795</span>
<span class="normal"> 8796</span>
<span class="normal"> 8797</span>
<span class="normal"> 8798</span>
<span class="normal"> 8799</span>
<span class="normal"> 8800</span>
<span class="normal"> 8801</span>
<span class="normal"> 8802</span>
<span class="normal"> 8803</span>
<span class="normal"> 8804</span>
<span class="normal"> 8805</span>
<span class="normal"> 8806</span>
<span class="normal"> 8807</span>
<span class="normal"> 8808</span>
<span class="normal"> 8809</span>
<span class="normal"> 8810</span>
<span class="normal"> 8811</span>
<span class="normal"> 8812</span>
<span class="normal"> 8813</span>
<span class="normal"> 8814</span>
<span class="normal"> 8815</span>
<span class="normal"> 8816</span>
<span class="normal"> 8817</span>
<span class="normal"> 8818</span>
<span class="normal"> 8819</span>
<span class="normal"> 8820</span>
<span class="normal"> 8821</span>
<span class="normal"> 8822</span>
<span class="normal"> 8823</span>
<span class="normal"> 8824</span>
<span class="normal"> 8825</span>
<span class="normal"> 8826</span>
<span class="normal"> 8827</span>
<span class="normal"> 8828</span>
<span class="normal"> 8829</span>
<span class="normal"> 8830</span>
<span class="normal"> 8831</span>
<span class="normal"> 8832</span>
<span class="normal"> 8833</span>
<span class="normal"> 8834</span>
<span class="normal"> 8835</span>
<span class="normal"> 8836</span>
<span class="normal"> 8837</span>
<span class="normal"> 8838</span>
<span class="normal"> 8839</span>
<span class="normal"> 8840</span>
<span class="normal"> 8841</span>
<span class="normal"> 8842</span>
<span class="normal"> 8843</span>
<span class="normal"> 8844</span>
<span class="normal"> 8845</span>
<span class="normal"> 8846</span>
<span class="normal"> 8847</span>
<span class="normal"> 8848</span>
<span class="normal"> 8849</span>
<span class="normal"> 8850</span>
<span class="normal"> 8851</span>
<span class="normal"> 8852</span>
<span class="normal"> 8853</span>
<span class="normal"> 8854</span>
<span class="normal"> 8855</span>
<span class="normal"> 8856</span>
<span class="normal"> 8857</span>
<span class="normal"> 8858</span>
<span class="normal"> 8859</span>
<span class="normal"> 8860</span>
<span class="normal"> 8861</span>
<span class="normal"> 8862</span>
<span class="normal"> 8863</span>
<span class="normal"> 8864</span>
<span class="normal"> 8865</span>
<span class="normal"> 8866</span>
<span class="normal"> 8867</span>
<span class="normal"> 8868</span>
<span class="normal"> 8869</span>
<span class="normal"> 8870</span>
<span class="normal"> 8871</span>
<span class="normal"> 8872</span>
<span class="normal"> 8873</span>
<span class="normal"> 8874</span>
<span class="normal"> 8875</span>
<span class="normal"> 8876</span>
<span class="normal"> 8877</span>
<span class="normal"> 8878</span>
<span class="normal"> 8879</span>
<span class="normal"> 8880</span>
<span class="normal"> 8881</span>
<span class="normal"> 8882</span>
<span class="normal"> 8883</span>
<span class="normal"> 8884</span>
<span class="normal"> 8885</span>
<span class="normal"> 8886</span>
<span class="normal"> 8887</span>
<span class="normal"> 8888</span>
<span class="normal"> 8889</span>
<span class="normal"> 8890</span>
<span class="normal"> 8891</span>
<span class="normal"> 8892</span>
<span class="normal"> 8893</span>
<span class="normal"> 8894</span>
<span class="normal"> 8895</span>
<span class="normal"> 8896</span>
<span class="normal"> 8897</span>
<span class="normal"> 8898</span>
<span class="normal"> 8899</span>
<span class="normal"> 8900</span>
<span class="normal"> 8901</span>
<span class="normal"> 8902</span>
<span class="normal"> 8903</span>
<span class="normal"> 8904</span>
<span class="normal"> 8905</span>
<span class="normal"> 8906</span>
<span class="normal"> 8907</span>
<span class="normal"> 8908</span>
<span class="normal"> 8909</span>
<span class="normal"> 8910</span>
<span class="normal"> 8911</span>
<span class="normal"> 8912</span>
<span class="normal"> 8913</span>
<span class="normal"> 8914</span>
<span class="normal"> 8915</span>
<span class="normal"> 8916</span>
<span class="normal"> 8917</span>
<span class="normal"> 8918</span>
<span class="normal"> 8919</span>
<span class="normal"> 8920</span>
<span class="normal"> 8921</span>
<span class="normal"> 8922</span>
<span class="normal"> 8923</span>
<span class="normal"> 8924</span>
<span class="normal"> 8925</span>
<span class="normal"> 8926</span>
<span class="normal"> 8927</span>
<span class="normal"> 8928</span>
<span class="normal"> 8929</span>
<span class="normal"> 8930</span>
<span class="normal"> 8931</span>
<span class="normal"> 8932</span>
<span class="normal"> 8933</span>
<span class="normal"> 8934</span>
<span class="normal"> 8935</span>
<span class="normal"> 8936</span>
<span class="normal"> 8937</span>
<span class="normal"> 8938</span>
<span class="normal"> 8939</span>
<span class="normal"> 8940</span>
<span class="normal"> 8941</span>
<span class="normal"> 8942</span>
<span class="normal"> 8943</span>
<span class="normal"> 8944</span>
<span class="normal"> 8945</span>
<span class="normal"> 8946</span>
<span class="normal"> 8947</span>
<span class="normal"> 8948</span>
<span class="normal"> 8949</span>
<span class="normal"> 8950</span>
<span class="normal"> 8951</span>
<span class="normal"> 8952</span>
<span class="normal"> 8953</span>
<span class="normal"> 8954</span>
<span class="normal"> 8955</span>
<span class="normal"> 8956</span>
<span class="normal"> 8957</span>
<span class="normal"> 8958</span>
<span class="normal"> 8959</span>
<span class="normal"> 8960</span>
<span class="normal"> 8961</span>
<span class="normal"> 8962</span>
<span class="normal"> 8963</span>
<span class="normal"> 8964</span>
<span class="normal"> 8965</span>
<span class="normal"> 8966</span>
<span class="normal"> 8967</span>
<span class="normal"> 8968</span>
<span class="normal"> 8969</span>
<span class="normal"> 8970</span>
<span class="normal"> 8971</span>
<span class="normal"> 8972</span>
<span class="normal"> 8973</span>
<span class="normal"> 8974</span>
<span class="normal"> 8975</span>
<span class="normal"> 8976</span>
<span class="normal"> 8977</span>
<span class="normal"> 8978</span>
<span class="normal"> 8979</span>
<span class="normal"> 8980</span>
<span class="normal"> 8981</span>
<span class="normal"> 8982</span>
<span class="normal"> 8983</span>
<span class="normal"> 8984</span>
<span class="normal"> 8985</span>
<span class="normal"> 8986</span>
<span class="normal"> 8987</span>
<span class="normal"> 8988</span>
<span class="normal"> 8989</span>
<span class="normal"> 8990</span>
<span class="normal"> 8991</span>
<span class="normal"> 8992</span>
<span class="normal"> 8993</span>
<span class="normal"> 8994</span>
<span class="normal"> 8995</span>
<span class="normal"> 8996</span>
<span class="normal"> 8997</span>
<span class="normal"> 8998</span>
<span class="normal"> 8999</span>
<span class="normal"> 9000</span>
<span class="normal"> 9001</span>
<span class="normal"> 9002</span>
<span class="normal"> 9003</span>
<span class="normal"> 9004</span>
<span class="normal"> 9005</span>
<span class="normal"> 9006</span>
<span class="normal"> 9007</span>
<span class="normal"> 9008</span>
<span class="normal"> 9009</span>
<span class="normal"> 9010</span>
<span class="normal"> 9011</span>
<span class="normal"> 9012</span>
<span class="normal"> 9013</span>
<span class="normal"> 9014</span>
<span class="normal"> 9015</span>
<span class="normal"> 9016</span>
<span class="normal"> 9017</span>
<span class="normal"> 9018</span>
<span class="normal"> 9019</span>
<span class="normal"> 9020</span>
<span class="normal"> 9021</span>
<span class="normal"> 9022</span>
<span class="normal"> 9023</span>
<span class="normal"> 9024</span>
<span class="normal"> 9025</span>
<span class="normal"> 9026</span>
<span class="normal"> 9027</span>
<span class="normal"> 9028</span>
<span class="normal"> 9029</span>
<span class="normal"> 9030</span>
<span class="normal"> 9031</span>
<span class="normal"> 9032</span>
<span class="normal"> 9033</span>
<span class="normal"> 9034</span>
<span class="normal"> 9035</span>
<span class="normal"> 9036</span>
<span class="normal"> 9037</span>
<span class="normal"> 9038</span>
<span class="normal"> 9039</span>
<span class="normal"> 9040</span>
<span class="normal"> 9041</span>
<span class="normal"> 9042</span>
<span class="normal"> 9043</span>
<span class="normal"> 9044</span>
<span class="normal"> 9045</span>
<span class="normal"> 9046</span>
<span class="normal"> 9047</span>
<span class="normal"> 9048</span>
<span class="normal"> 9049</span>
<span class="normal"> 9050</span>
<span class="normal"> 9051</span>
<span class="normal"> 9052</span>
<span class="normal"> 9053</span>
<span class="normal"> 9054</span>
<span class="normal"> 9055</span>
<span class="normal"> 9056</span>
<span class="normal"> 9057</span>
<span class="normal"> 9058</span>
<span class="normal"> 9059</span>
<span class="normal"> 9060</span>
<span class="normal"> 9061</span>
<span class="normal"> 9062</span>
<span class="normal"> 9063</span>
<span class="normal"> 9064</span>
<span class="normal"> 9065</span>
<span class="normal"> 9066</span>
<span class="normal"> 9067</span>
<span class="normal"> 9068</span>
<span class="normal"> 9069</span>
<span class="normal"> 9070</span>
<span class="normal"> 9071</span>
<span class="normal"> 9072</span>
<span class="normal"> 9073</span>
<span class="normal"> 9074</span>
<span class="normal"> 9075</span>
<span class="normal"> 9076</span>
<span class="normal"> 9077</span>
<span class="normal"> 9078</span>
<span class="normal"> 9079</span>
<span class="normal"> 9080</span>
<span class="normal"> 9081</span>
<span class="normal"> 9082</span>
<span class="normal"> 9083</span>
<span class="normal"> 9084</span>
<span class="normal"> 9085</span>
<span class="normal"> 9086</span>
<span class="normal"> 9087</span>
<span class="normal"> 9088</span>
<span class="normal"> 9089</span>
<span class="normal"> 9090</span>
<span class="normal"> 9091</span>
<span class="normal"> 9092</span>
<span class="normal"> 9093</span>
<span class="normal"> 9094</span>
<span class="normal"> 9095</span>
<span class="normal"> 9096</span>
<span class="normal"> 9097</span>
<span class="normal"> 9098</span>
<span class="normal"> 9099</span>
<span class="normal"> 9100</span>
<span class="normal"> 9101</span>
<span class="normal"> 9102</span>
<span class="normal"> 9103</span>
<span class="normal"> 9104</span>
<span class="normal"> 9105</span>
<span class="normal"> 9106</span>
<span class="normal"> 9107</span>
<span class="normal"> 9108</span>
<span class="normal"> 9109</span>
<span class="normal"> 9110</span>
<span class="normal"> 9111</span>
<span class="normal"> 9112</span>
<span class="normal"> 9113</span>
<span class="normal"> 9114</span>
<span class="normal"> 9115</span>
<span class="normal"> 9116</span>
<span class="normal"> 9117</span>
<span class="normal"> 9118</span>
<span class="normal"> 9119</span>
<span class="normal"> 9120</span>
<span class="normal"> 9121</span>
<span class="normal"> 9122</span>
<span class="normal"> 9123</span>
<span class="normal"> 9124</span>
<span class="normal"> 9125</span>
<span class="normal"> 9126</span>
<span class="normal"> 9127</span>
<span class="normal"> 9128</span>
<span class="normal"> 9129</span>
<span class="normal"> 9130</span>
<span class="normal"> 9131</span>
<span class="normal"> 9132</span>
<span class="normal"> 9133</span>
<span class="normal"> 9134</span>
<span class="normal"> 9135</span>
<span class="normal"> 9136</span>
<span class="normal"> 9137</span>
<span class="normal"> 9138</span>
<span class="normal"> 9139</span>
<span class="normal"> 9140</span>
<span class="normal"> 9141</span>
<span class="normal"> 9142</span>
<span class="normal"> 9143</span>
<span class="normal"> 9144</span>
<span class="normal"> 9145</span>
<span class="normal"> 9146</span>
<span class="normal"> 9147</span>
<span class="normal"> 9148</span>
<span class="normal"> 9149</span>
<span class="normal"> 9150</span>
<span class="normal"> 9151</span>
<span class="normal"> 9152</span>
<span class="normal"> 9153</span>
<span class="normal"> 9154</span>
<span class="normal"> 9155</span>
<span class="normal"> 9156</span>
<span class="normal"> 9157</span>
<span class="normal"> 9158</span>
<span class="normal"> 9159</span>
<span class="normal"> 9160</span>
<span class="normal"> 9161</span>
<span class="normal"> 9162</span>
<span class="normal"> 9163</span>
<span class="normal"> 9164</span>
<span class="normal"> 9165</span>
<span class="normal"> 9166</span>
<span class="normal"> 9167</span>
<span class="normal"> 9168</span>
<span class="normal"> 9169</span>
<span class="normal"> 9170</span>
<span class="normal"> 9171</span>
<span class="normal"> 9172</span>
<span class="normal"> 9173</span>
<span class="normal"> 9174</span>
<span class="normal"> 9175</span>
<span class="normal"> 9176</span>
<span class="normal"> 9177</span>
<span class="normal"> 9178</span>
<span class="normal"> 9179</span>
<span class="normal"> 9180</span>
<span class="normal"> 9181</span>
<span class="normal"> 9182</span>
<span class="normal"> 9183</span>
<span class="normal"> 9184</span>
<span class="normal"> 9185</span>
<span class="normal"> 9186</span>
<span class="normal"> 9187</span>
<span class="normal"> 9188</span>
<span class="normal"> 9189</span>
<span class="normal"> 9190</span>
<span class="normal"> 9191</span>
<span class="normal"> 9192</span>
<span class="normal"> 9193</span>
<span class="normal"> 9194</span>
<span class="normal"> 9195</span>
<span class="normal"> 9196</span>
<span class="normal"> 9197</span>
<span class="normal"> 9198</span>
<span class="normal"> 9199</span>
<span class="normal"> 9200</span>
<span class="normal"> 9201</span>
<span class="normal"> 9202</span>
<span class="normal"> 9203</span>
<span class="normal"> 9204</span>
<span class="normal"> 9205</span>
<span class="normal"> 9206</span>
<span class="normal"> 9207</span>
<span class="normal"> 9208</span>
<span class="normal"> 9209</span>
<span class="normal"> 9210</span>
<span class="normal"> 9211</span>
<span class="normal"> 9212</span>
<span class="normal"> 9213</span>
<span class="normal"> 9214</span>
<span class="normal"> 9215</span>
<span class="normal"> 9216</span>
<span class="normal"> 9217</span>
<span class="normal"> 9218</span>
<span class="normal"> 9219</span>
<span class="normal"> 9220</span>
<span class="normal"> 9221</span>
<span class="normal"> 9222</span>
<span class="normal"> 9223</span>
<span class="normal"> 9224</span>
<span class="normal"> 9225</span>
<span class="normal"> 9226</span>
<span class="normal"> 9227</span>
<span class="normal"> 9228</span>
<span class="normal"> 9229</span>
<span class="normal"> 9230</span>
<span class="normal"> 9231</span>
<span class="normal"> 9232</span>
<span class="normal"> 9233</span>
<span class="normal"> 9234</span>
<span class="normal"> 9235</span>
<span class="normal"> 9236</span>
<span class="normal"> 9237</span>
<span class="normal"> 9238</span>
<span class="normal"> 9239</span>
<span class="normal"> 9240</span>
<span class="normal"> 9241</span>
<span class="normal"> 9242</span>
<span class="normal"> 9243</span>
<span class="normal"> 9244</span>
<span class="normal"> 9245</span>
<span class="normal"> 9246</span>
<span class="normal"> 9247</span>
<span class="normal"> 9248</span>
<span class="normal"> 9249</span>
<span class="normal"> 9250</span>
<span class="normal"> 9251</span>
<span class="normal"> 9252</span>
<span class="normal"> 9253</span>
<span class="normal"> 9254</span>
<span class="normal"> 9255</span>
<span class="normal"> 9256</span>
<span class="normal"> 9257</span>
<span class="normal"> 9258</span>
<span class="normal"> 9259</span>
<span class="normal"> 9260</span>
<span class="normal"> 9261</span>
<span class="normal"> 9262</span>
<span class="normal"> 9263</span>
<span class="normal"> 9264</span>
<span class="normal"> 9265</span>
<span class="normal"> 9266</span>
<span class="normal"> 9267</span>
<span class="normal"> 9268</span>
<span class="normal"> 9269</span>
<span class="normal"> 9270</span>
<span class="normal"> 9271</span>
<span class="normal"> 9272</span>
<span class="normal"> 9273</span>
<span class="normal"> 9274</span>
<span class="normal"> 9275</span>
<span class="normal"> 9276</span>
<span class="normal"> 9277</span>
<span class="normal"> 9278</span>
<span class="normal"> 9279</span>
<span class="normal"> 9280</span>
<span class="normal"> 9281</span>
<span class="normal"> 9282</span>
<span class="normal"> 9283</span>
<span class="normal"> 9284</span>
<span class="normal"> 9285</span>
<span class="normal"> 9286</span>
<span class="normal"> 9287</span>
<span class="normal"> 9288</span>
<span class="normal"> 9289</span>
<span class="normal"> 9290</span>
<span class="normal"> 9291</span>
<span class="normal"> 9292</span>
<span class="normal"> 9293</span>
<span class="normal"> 9294</span>
<span class="normal"> 9295</span>
<span class="normal"> 9296</span>
<span class="normal"> 9297</span>
<span class="normal"> 9298</span>
<span class="normal"> 9299</span>
<span class="normal"> 9300</span>
<span class="normal"> 9301</span>
<span class="normal"> 9302</span>
<span class="normal"> 9303</span>
<span class="normal"> 9304</span>
<span class="normal"> 9305</span>
<span class="normal"> 9306</span>
<span class="normal"> 9307</span>
<span class="normal"> 9308</span>
<span class="normal"> 9309</span>
<span class="normal"> 9310</span>
<span class="normal"> 9311</span>
<span class="normal"> 9312</span>
<span class="normal"> 9313</span>
<span class="normal"> 9314</span>
<span class="normal"> 9315</span>
<span class="normal"> 9316</span>
<span class="normal"> 9317</span>
<span class="normal"> 9318</span>
<span class="normal"> 9319</span>
<span class="normal"> 9320</span>
<span class="normal"> 9321</span>
<span class="normal"> 9322</span>
<span class="normal"> 9323</span>
<span class="normal"> 9324</span>
<span class="normal"> 9325</span>
<span class="normal"> 9326</span>
<span class="normal"> 9327</span>
<span class="normal"> 9328</span>
<span class="normal"> 9329</span>
<span class="normal"> 9330</span>
<span class="normal"> 9331</span>
<span class="normal"> 9332</span>
<span class="normal"> 9333</span>
<span class="normal"> 9334</span>
<span class="normal"> 9335</span>
<span class="normal"> 9336</span>
<span class="normal"> 9337</span>
<span class="normal"> 9338</span>
<span class="normal"> 9339</span>
<span class="normal"> 9340</span>
<span class="normal"> 9341</span>
<span class="normal"> 9342</span>
<span class="normal"> 9343</span>
<span class="normal"> 9344</span>
<span class="normal"> 9345</span>
<span class="normal"> 9346</span>
<span class="normal"> 9347</span>
<span class="normal"> 9348</span>
<span class="normal"> 9349</span>
<span class="normal"> 9350</span>
<span class="normal"> 9351</span>
<span class="normal"> 9352</span>
<span class="normal"> 9353</span>
<span class="normal"> 9354</span>
<span class="normal"> 9355</span>
<span class="normal"> 9356</span>
<span class="normal"> 9357</span>
<span class="normal"> 9358</span>
<span class="normal"> 9359</span>
<span class="normal"> 9360</span>
<span class="normal"> 9361</span>
<span class="normal"> 9362</span>
<span class="normal"> 9363</span>
<span class="normal"> 9364</span>
<span class="normal"> 9365</span>
<span class="normal"> 9366</span>
<span class="normal"> 9367</span>
<span class="normal"> 9368</span>
<span class="normal"> 9369</span>
<span class="normal"> 9370</span>
<span class="normal"> 9371</span>
<span class="normal"> 9372</span>
<span class="normal"> 9373</span>
<span class="normal"> 9374</span>
<span class="normal"> 9375</span>
<span class="normal"> 9376</span>
<span class="normal"> 9377</span>
<span class="normal"> 9378</span>
<span class="normal"> 9379</span>
<span class="normal"> 9380</span>
<span class="normal"> 9381</span>
<span class="normal"> 9382</span>
<span class="normal"> 9383</span>
<span class="normal"> 9384</span>
<span class="normal"> 9385</span>
<span class="normal"> 9386</span>
<span class="normal"> 9387</span>
<span class="normal"> 9388</span>
<span class="normal"> 9389</span>
<span class="normal"> 9390</span>
<span class="normal"> 9391</span>
<span class="normal"> 9392</span>
<span class="normal"> 9393</span>
<span class="normal"> 9394</span>
<span class="normal"> 9395</span>
<span class="normal"> 9396</span>
<span class="normal"> 9397</span>
<span class="normal"> 9398</span>
<span class="normal"> 9399</span>
<span class="normal"> 9400</span>
<span class="normal"> 9401</span>
<span class="normal"> 9402</span>
<span class="normal"> 9403</span>
<span class="normal"> 9404</span>
<span class="normal"> 9405</span>
<span class="normal"> 9406</span>
<span class="normal"> 9407</span>
<span class="normal"> 9408</span>
<span class="normal"> 9409</span>
<span class="normal"> 9410</span>
<span class="normal"> 9411</span>
<span class="normal"> 9412</span>
<span class="normal"> 9413</span>
<span class="normal"> 9414</span>
<span class="normal"> 9415</span>
<span class="normal"> 9416</span>
<span class="normal"> 9417</span>
<span class="normal"> 9418</span>
<span class="normal"> 9419</span>
<span class="normal"> 9420</span>
<span class="normal"> 9421</span>
<span class="normal"> 9422</span>
<span class="normal"> 9423</span>
<span class="normal"> 9424</span>
<span class="normal"> 9425</span>
<span class="normal"> 9426</span>
<span class="normal"> 9427</span>
<span class="normal"> 9428</span>
<span class="normal"> 9429</span>
<span class="normal"> 9430</span>
<span class="normal"> 9431</span>
<span class="normal"> 9432</span>
<span class="normal"> 9433</span>
<span class="normal"> 9434</span>
<span class="normal"> 9435</span>
<span class="normal"> 9436</span>
<span class="normal"> 9437</span>
<span class="normal"> 9438</span>
<span class="normal"> 9439</span>
<span class="normal"> 9440</span>
<span class="normal"> 9441</span>
<span class="normal"> 9442</span>
<span class="normal"> 9443</span>
<span class="normal"> 9444</span>
<span class="normal"> 9445</span>
<span class="normal"> 9446</span>
<span class="normal"> 9447</span>
<span class="normal"> 9448</span>
<span class="normal"> 9449</span>
<span class="normal"> 9450</span>
<span class="normal"> 9451</span>
<span class="normal"> 9452</span>
<span class="normal"> 9453</span>
<span class="normal"> 9454</span>
<span class="normal"> 9455</span>
<span class="normal"> 9456</span>
<span class="normal"> 9457</span>
<span class="normal"> 9458</span>
<span class="normal"> 9459</span>
<span class="normal"> 9460</span>
<span class="normal"> 9461</span>
<span class="normal"> 9462</span>
<span class="normal"> 9463</span>
<span class="normal"> 9464</span>
<span class="normal"> 9465</span>
<span class="normal"> 9466</span>
<span class="normal"> 9467</span>
<span class="normal"> 9468</span>
<span class="normal"> 9469</span>
<span class="normal"> 9470</span>
<span class="normal"> 9471</span>
<span class="normal"> 9472</span>
<span class="normal"> 9473</span>
<span class="normal"> 9474</span>
<span class="normal"> 9475</span>
<span class="normal"> 9476</span>
<span class="normal"> 9477</span>
<span class="normal"> 9478</span>
<span class="normal"> 9479</span>
<span class="normal"> 9480</span>
<span class="normal"> 9481</span>
<span class="normal"> 9482</span>
<span class="normal"> 9483</span>
<span class="normal"> 9484</span>
<span class="normal"> 9485</span>
<span class="normal"> 9486</span>
<span class="normal"> 9487</span>
<span class="normal"> 9488</span>
<span class="normal"> 9489</span>
<span class="normal"> 9490</span>
<span class="normal"> 9491</span>
<span class="normal"> 9492</span>
<span class="normal"> 9493</span>
<span class="normal"> 9494</span>
<span class="normal"> 9495</span>
<span class="normal"> 9496</span>
<span class="normal"> 9497</span>
<span class="normal"> 9498</span>
<span class="normal"> 9499</span>
<span class="normal"> 9500</span>
<span class="normal"> 9501</span>
<span class="normal"> 9502</span>
<span class="normal"> 9503</span>
<span class="normal"> 9504</span>
<span class="normal"> 9505</span>
<span class="normal"> 9506</span>
<span class="normal"> 9507</span>
<span class="normal"> 9508</span>
<span class="normal"> 9509</span>
<span class="normal"> 9510</span>
<span class="normal"> 9511</span>
<span class="normal"> 9512</span>
<span class="normal"> 9513</span>
<span class="normal"> 9514</span>
<span class="normal"> 9515</span>
<span class="normal"> 9516</span>
<span class="normal"> 9517</span>
<span class="normal"> 9518</span>
<span class="normal"> 9519</span>
<span class="normal"> 9520</span>
<span class="normal"> 9521</span>
<span class="normal"> 9522</span>
<span class="normal"> 9523</span>
<span class="normal"> 9524</span>
<span class="normal"> 9525</span>
<span class="normal"> 9526</span>
<span class="normal"> 9527</span>
<span class="normal"> 9528</span>
<span class="normal"> 9529</span>
<span class="normal"> 9530</span>
<span class="normal"> 9531</span>
<span class="normal"> 9532</span>
<span class="normal"> 9533</span>
<span class="normal"> 9534</span>
<span class="normal"> 9535</span>
<span class="normal"> 9536</span>
<span class="normal"> 9537</span>
<span class="normal"> 9538</span>
<span class="normal"> 9539</span>
<span class="normal"> 9540</span>
<span class="normal"> 9541</span>
<span class="normal"> 9542</span>
<span class="normal"> 9543</span>
<span class="normal"> 9544</span>
<span class="normal"> 9545</span>
<span class="normal"> 9546</span>
<span class="normal"> 9547</span>
<span class="normal"> 9548</span>
<span class="normal"> 9549</span>
<span class="normal"> 9550</span>
<span class="normal"> 9551</span>
<span class="normal"> 9552</span>
<span class="normal"> 9553</span>
<span class="normal"> 9554</span>
<span class="normal"> 9555</span>
<span class="normal"> 9556</span>
<span class="normal"> 9557</span>
<span class="normal"> 9558</span>
<span class="normal"> 9559</span>
<span class="normal"> 9560</span>
<span class="normal"> 9561</span>
<span class="normal"> 9562</span>
<span class="normal"> 9563</span>
<span class="normal"> 9564</span>
<span class="normal"> 9565</span>
<span class="normal"> 9566</span>
<span class="normal"> 9567</span>
<span class="normal"> 9568</span>
<span class="normal"> 9569</span>
<span class="normal"> 9570</span>
<span class="normal"> 9571</span>
<span class="normal"> 9572</span>
<span class="normal"> 9573</span>
<span class="normal"> 9574</span>
<span class="normal"> 9575</span>
<span class="normal"> 9576</span>
<span class="normal"> 9577</span>
<span class="normal"> 9578</span>
<span class="normal"> 9579</span>
<span class="normal"> 9580</span>
<span class="normal"> 9581</span>
<span class="normal"> 9582</span>
<span class="normal"> 9583</span>
<span class="normal"> 9584</span>
<span class="normal"> 9585</span>
<span class="normal"> 9586</span>
<span class="normal"> 9587</span>
<span class="normal"> 9588</span>
<span class="normal"> 9589</span>
<span class="normal"> 9590</span>
<span class="normal"> 9591</span>
<span class="normal"> 9592</span>
<span class="normal"> 9593</span>
<span class="normal"> 9594</span>
<span class="normal"> 9595</span>
<span class="normal"> 9596</span>
<span class="normal"> 9597</span>
<span class="normal"> 9598</span>
<span class="normal"> 9599</span>
<span class="normal"> 9600</span>
<span class="normal"> 9601</span>
<span class="normal"> 9602</span>
<span class="normal"> 9603</span>
<span class="normal"> 9604</span>
<span class="normal"> 9605</span>
<span class="normal"> 9606</span>
<span class="normal"> 9607</span>
<span class="normal"> 9608</span>
<span class="normal"> 9609</span>
<span class="normal"> 9610</span>
<span class="normal"> 9611</span>
<span class="normal"> 9612</span>
<span class="normal"> 9613</span>
<span class="normal"> 9614</span>
<span class="normal"> 9615</span>
<span class="normal"> 9616</span>
<span class="normal"> 9617</span>
<span class="normal"> 9618</span>
<span class="normal"> 9619</span>
<span class="normal"> 9620</span>
<span class="normal"> 9621</span>
<span class="normal"> 9622</span>
<span class="normal"> 9623</span>
<span class="normal"> 9624</span>
<span class="normal"> 9625</span>
<span class="normal"> 9626</span>
<span class="normal"> 9627</span>
<span class="normal"> 9628</span>
<span class="normal"> 9629</span>
<span class="normal"> 9630</span>
<span class="normal"> 9631</span>
<span class="normal"> 9632</span>
<span class="normal"> 9633</span>
<span class="normal"> 9634</span>
<span class="normal"> 9635</span>
<span class="normal"> 9636</span>
<span class="normal"> 9637</span>
<span class="normal"> 9638</span>
<span class="normal"> 9639</span>
<span class="normal"> 9640</span>
<span class="normal"> 9641</span>
<span class="normal"> 9642</span>
<span class="normal"> 9643</span>
<span class="normal"> 9644</span>
<span class="normal"> 9645</span>
<span class="normal"> 9646</span>
<span class="normal"> 9647</span>
<span class="normal"> 9648</span>
<span class="normal"> 9649</span>
<span class="normal"> 9650</span>
<span class="normal"> 9651</span>
<span class="normal"> 9652</span>
<span class="normal"> 9653</span>
<span class="normal"> 9654</span>
<span class="normal"> 9655</span>
<span class="normal"> 9656</span>
<span class="normal"> 9657</span>
<span class="normal"> 9658</span>
<span class="normal"> 9659</span>
<span class="normal"> 9660</span>
<span class="normal"> 9661</span>
<span class="normal"> 9662</span>
<span class="normal"> 9663</span>
<span class="normal"> 9664</span>
<span class="normal"> 9665</span>
<span class="normal"> 9666</span>
<span class="normal"> 9667</span>
<span class="normal"> 9668</span>
<span class="normal"> 9669</span>
<span class="normal"> 9670</span>
<span class="normal"> 9671</span>
<span class="normal"> 9672</span>
<span class="normal"> 9673</span>
<span class="normal"> 9674</span>
<span class="normal"> 9675</span>
<span class="normal"> 9676</span>
<span class="normal"> 9677</span>
<span class="normal"> 9678</span>
<span class="normal"> 9679</span>
<span class="normal"> 9680</span>
<span class="normal"> 9681</span>
<span class="normal"> 9682</span>
<span class="normal"> 9683</span>
<span class="normal"> 9684</span>
<span class="normal"> 9685</span>
<span class="normal"> 9686</span>
<span class="normal"> 9687</span>
<span class="normal"> 9688</span>
<span class="normal"> 9689</span>
<span class="normal"> 9690</span>
<span class="normal"> 9691</span>
<span class="normal"> 9692</span>
<span class="normal"> 9693</span>
<span class="normal"> 9694</span>
<span class="normal"> 9695</span>
<span class="normal"> 9696</span>
<span class="normal"> 9697</span>
<span class="normal"> 9698</span>
<span class="normal"> 9699</span>
<span class="normal"> 9700</span>
<span class="normal"> 9701</span>
<span class="normal"> 9702</span>
<span class="normal"> 9703</span>
<span class="normal"> 9704</span>
<span class="normal"> 9705</span>
<span class="normal"> 9706</span>
<span class="normal"> 9707</span>
<span class="normal"> 9708</span>
<span class="normal"> 9709</span>
<span class="normal"> 9710</span>
<span class="normal"> 9711</span>
<span class="normal"> 9712</span>
<span class="normal"> 9713</span>
<span class="normal"> 9714</span>
<span class="normal"> 9715</span>
<span class="normal"> 9716</span>
<span class="normal"> 9717</span>
<span class="normal"> 9718</span>
<span class="normal"> 9719</span>
<span class="normal"> 9720</span>
<span class="normal"> 9721</span>
<span class="normal"> 9722</span>
<span class="normal"> 9723</span>
<span class="normal"> 9724</span>
<span class="normal"> 9725</span>
<span class="normal"> 9726</span>
<span class="normal"> 9727</span>
<span class="normal"> 9728</span>
<span class="normal"> 9729</span>
<span class="normal"> 9730</span>
<span class="normal"> 9731</span>
<span class="normal"> 9732</span>
<span class="normal"> 9733</span>
<span class="normal"> 9734</span>
<span class="normal"> 9735</span>
<span class="normal"> 9736</span>
<span class="normal"> 9737</span>
<span class="normal"> 9738</span>
<span class="normal"> 9739</span>
<span class="normal"> 9740</span>
<span class="normal"> 9741</span>
<span class="normal"> 9742</span>
<span class="normal"> 9743</span>
<span class="normal"> 9744</span>
<span class="normal"> 9745</span>
<span class="normal"> 9746</span>
<span class="normal"> 9747</span>
<span class="normal"> 9748</span>
<span class="normal"> 9749</span>
<span class="normal"> 9750</span>
<span class="normal"> 9751</span>
<span class="normal"> 9752</span>
<span class="normal"> 9753</span>
<span class="normal"> 9754</span>
<span class="normal"> 9755</span>
<span class="normal"> 9756</span>
<span class="normal"> 9757</span>
<span class="normal"> 9758</span>
<span class="normal"> 9759</span>
<span class="normal"> 9760</span>
<span class="normal"> 9761</span>
<span class="normal"> 9762</span>
<span class="normal"> 9763</span>
<span class="normal"> 9764</span>
<span class="normal"> 9765</span>
<span class="normal"> 9766</span>
<span class="normal"> 9767</span>
<span class="normal"> 9768</span>
<span class="normal"> 9769</span>
<span class="normal"> 9770</span>
<span class="normal"> 9771</span>
<span class="normal"> 9772</span>
<span class="normal"> 9773</span>
<span class="normal"> 9774</span>
<span class="normal"> 9775</span>
<span class="normal"> 9776</span>
<span class="normal"> 9777</span>
<span class="normal"> 9778</span>
<span class="normal"> 9779</span>
<span class="normal"> 9780</span>
<span class="normal"> 9781</span>
<span class="normal"> 9782</span>
<span class="normal"> 9783</span>
<span class="normal"> 9784</span>
<span class="normal"> 9785</span>
<span class="normal"> 9786</span>
<span class="normal"> 9787</span>
<span class="normal"> 9788</span>
<span class="normal"> 9789</span>
<span class="normal"> 9790</span>
<span class="normal"> 9791</span>
<span class="normal"> 9792</span>
<span class="normal"> 9793</span>
<span class="normal"> 9794</span>
<span class="normal"> 9795</span>
<span class="normal"> 9796</span>
<span class="normal"> 9797</span>
<span class="normal"> 9798</span>
<span class="normal"> 9799</span>
<span class="normal"> 9800</span>
<span class="normal"> 9801</span>
<span class="normal"> 9802</span>
<span class="normal"> 9803</span>
<span class="normal"> 9804</span>
<span class="normal"> 9805</span>
<span class="normal"> 9806</span>
<span class="normal"> 9807</span>
<span class="normal"> 9808</span>
<span class="normal"> 9809</span>
<span class="normal"> 9810</span>
<span class="normal"> 9811</span>
<span class="normal"> 9812</span>
<span class="normal"> 9813</span>
<span class="normal"> 9814</span>
<span class="normal"> 9815</span>
<span class="normal"> 9816</span>
<span class="normal"> 9817</span>
<span class="normal"> 9818</span>
<span class="normal"> 9819</span>
<span class="normal"> 9820</span>
<span class="normal"> 9821</span>
<span class="normal"> 9822</span>
<span class="normal"> 9823</span>
<span class="normal"> 9824</span>
<span class="normal"> 9825</span>
<span class="normal"> 9826</span>
<span class="normal"> 9827</span>
<span class="normal"> 9828</span>
<span class="normal"> 9829</span>
<span class="normal"> 9830</span>
<span class="normal"> 9831</span>
<span class="normal"> 9832</span>
<span class="normal"> 9833</span>
<span class="normal"> 9834</span>
<span class="normal"> 9835</span>
<span class="normal"> 9836</span>
<span class="normal"> 9837</span>
<span class="normal"> 9838</span>
<span class="normal"> 9839</span>
<span class="normal"> 9840</span>
<span class="normal"> 9841</span>
<span class="normal"> 9842</span>
<span class="normal"> 9843</span>
<span class="normal"> 9844</span>
<span class="normal"> 9845</span>
<span class="normal"> 9846</span>
<span class="normal"> 9847</span>
<span class="normal"> 9848</span>
<span class="normal"> 9849</span>
<span class="normal"> 9850</span>
<span class="normal"> 9851</span>
<span class="normal"> 9852</span>
<span class="normal"> 9853</span>
<span class="normal"> 9854</span>
<span class="normal"> 9855</span>
<span class="normal"> 9856</span>
<span class="normal"> 9857</span>
<span class="normal"> 9858</span>
<span class="normal"> 9859</span>
<span class="normal"> 9860</span>
<span class="normal"> 9861</span>
<span class="normal"> 9862</span>
<span class="normal"> 9863</span>
<span class="normal"> 9864</span>
<span class="normal"> 9865</span>
<span class="normal"> 9866</span>
<span class="normal"> 9867</span>
<span class="normal"> 9868</span>
<span class="normal"> 9869</span>
<span class="normal"> 9870</span>
<span class="normal"> 9871</span>
<span class="normal"> 9872</span>
<span class="normal"> 9873</span>
<span class="normal"> 9874</span>
<span class="normal"> 9875</span>
<span class="normal"> 9876</span>
<span class="normal"> 9877</span>
<span class="normal"> 9878</span>
<span class="normal"> 9879</span>
<span class="normal"> 9880</span>
<span class="normal"> 9881</span>
<span class="normal"> 9882</span>
<span class="normal"> 9883</span>
<span class="normal"> 9884</span>
<span class="normal"> 9885</span>
<span class="normal"> 9886</span>
<span class="normal"> 9887</span>
<span class="normal"> 9888</span>
<span class="normal"> 9889</span>
<span class="normal"> 9890</span>
<span class="normal"> 9891</span>
<span class="normal"> 9892</span>
<span class="normal"> 9893</span>
<span class="normal"> 9894</span>
<span class="normal"> 9895</span>
<span class="normal"> 9896</span>
<span class="normal"> 9897</span>
<span class="normal"> 9898</span>
<span class="normal"> 9899</span>
<span class="normal"> 9900</span>
<span class="normal"> 9901</span>
<span class="normal"> 9902</span>
<span class="normal"> 9903</span>
<span class="normal"> 9904</span>
<span class="normal"> 9905</span>
<span class="normal"> 9906</span>
<span class="normal"> 9907</span>
<span class="normal"> 9908</span>
<span class="normal"> 9909</span>
<span class="normal"> 9910</span>
<span class="normal"> 9911</span>
<span class="normal"> 9912</span>
<span class="normal"> 9913</span>
<span class="normal"> 9914</span>
<span class="normal"> 9915</span>
<span class="normal"> 9916</span>
<span class="normal"> 9917</span>
<span class="normal"> 9918</span>
<span class="normal"> 9919</span>
<span class="normal"> 9920</span>
<span class="normal"> 9921</span>
<span class="normal"> 9922</span>
<span class="normal"> 9923</span>
<span class="normal"> 9924</span>
<span class="normal"> 9925</span>
<span class="normal"> 9926</span>
<span class="normal"> 9927</span>
<span class="normal"> 9928</span>
<span class="normal"> 9929</span>
<span class="normal"> 9930</span>
<span class="normal"> 9931</span>
<span class="normal"> 9932</span>
<span class="normal"> 9933</span>
<span class="normal"> 9934</span>
<span class="normal"> 9935</span>
<span class="normal"> 9936</span>
<span class="normal"> 9937</span>
<span class="normal"> 9938</span>
<span class="normal"> 9939</span>
<span class="normal"> 9940</span>
<span class="normal"> 9941</span>
<span class="normal"> 9942</span>
<span class="normal"> 9943</span>
<span class="normal"> 9944</span>
<span class="normal"> 9945</span>
<span class="normal"> 9946</span>
<span class="normal"> 9947</span>
<span class="normal"> 9948</span>
<span class="normal"> 9949</span>
<span class="normal"> 9950</span>
<span class="normal"> 9951</span>
<span class="normal"> 9952</span>
<span class="normal"> 9953</span>
<span class="normal"> 9954</span>
<span class="normal"> 9955</span>
<span class="normal"> 9956</span>
<span class="normal"> 9957</span>
<span class="normal"> 9958</span>
<span class="normal"> 9959</span>
<span class="normal"> 9960</span>
<span class="normal"> 9961</span>
<span class="normal"> 9962</span>
<span class="normal"> 9963</span>
<span class="normal"> 9964</span>
<span class="normal"> 9965</span>
<span class="normal"> 9966</span>
<span class="normal"> 9967</span>
<span class="normal"> 9968</span>
<span class="normal"> 9969</span>
<span class="normal"> 9970</span>
<span class="normal"> 9971</span>
<span class="normal"> 9972</span>
<span class="normal"> 9973</span>
<span class="normal"> 9974</span>
<span class="normal"> 9975</span>
<span class="normal"> 9976</span>
<span class="normal"> 9977</span>
<span class="normal"> 9978</span>
<span class="normal"> 9979</span>
<span class="normal"> 9980</span>
<span class="normal"> 9981</span>
<span class="normal"> 9982</span>
<span class="normal"> 9983</span>
<span class="normal"> 9984</span>
<span class="normal"> 9985</span>
<span class="normal"> 9986</span>
<span class="normal"> 9987</span>
<span class="normal"> 9988</span>
<span class="normal"> 9989</span>
<span class="normal"> 9990</span>
<span class="normal"> 9991</span>
<span class="normal"> 9992</span>
<span class="normal"> 9993</span>
<span class="normal"> 9994</span>
<span class="normal"> 9995</span>
<span class="normal"> 9996</span>
<span class="normal"> 9997</span>
<span class="normal"> 9998</span>
<span class="normal"> 9999</span>
<span class="normal">10000</span>
<span class="normal">10001</span>
<span class="normal">10002</span>
<span class="normal">10003</span>
<span class="normal">10004</span>
<span class="normal">10005</span>
<span class="normal">10006</span>
<span class="normal">10007</span>
<span class="normal">10008</span>
<span class="normal">10009</span>
<span class="normal">10010</span>
<span class="normal">10011</span>
<span class="normal">10012</span>
<span class="normal">10013</span>
<span class="normal">10014</span>
<span class="normal">10015</span>
<span class="normal">10016</span>
<span class="normal">10017</span>
<span class="normal">10018</span>
<span class="normal">10019</span>
<span class="normal">10020</span>
<span class="normal">10021</span>
<span class="normal">10022</span>
<span class="normal">10023</span>
<span class="normal">10024</span>
<span class="normal">10025</span>
<span class="normal">10026</span>
<span class="normal">10027</span>
<span class="normal">10028</span>
<span class="normal">10029</span>
<span class="normal">10030</span>
<span class="normal">10031</span>
<span class="normal">10032</span>
<span class="normal">10033</span>
<span class="normal">10034</span>
<span class="normal">10035</span>
<span class="normal">10036</span>
<span class="normal">10037</span>
<span class="normal">10038</span>
<span class="normal">10039</span>
<span class="normal">10040</span>
<span class="normal">10041</span>
<span class="normal">10042</span>
<span class="normal">10043</span>
<span class="normal">10044</span>
<span class="normal">10045</span>
<span class="normal">10046</span>
<span class="normal">10047</span>
<span class="normal">10048</span>
<span class="normal">10049</span>
<span class="normal">10050</span>
<span class="normal">10051</span>
<span class="normal">10052</span>
<span class="normal">10053</span>
<span class="normal">10054</span>
<span class="normal">10055</span>
<span class="normal">10056</span>
<span class="normal">10057</span>
<span class="normal">10058</span>
<span class="normal">10059</span>
<span class="normal">10060</span>
<span class="normal">10061</span>
<span class="normal">10062</span>
<span class="normal">10063</span>
<span class="normal">10064</span>
<span class="normal">10065</span>
<span class="normal">10066</span>
<span class="normal">10067</span>
<span class="normal">10068</span>
<span class="normal">10069</span>
<span class="normal">10070</span>
<span class="normal">10071</span>
<span class="normal">10072</span>
<span class="normal">10073</span>
<span class="normal">10074</span>
<span class="normal">10075</span>
<span class="normal">10076</span>
<span class="normal">10077</span>
<span class="normal">10078</span>
<span class="normal">10079</span>
<span class="normal">10080</span>
<span class="normal">10081</span>
<span class="normal">10082</span>
<span class="normal">10083</span>
<span class="normal">10084</span>
<span class="normal">10085</span>
<span class="normal">10086</span>
<span class="normal">10087</span>
<span class="normal">10088</span>
<span class="normal">10089</span>
<span class="normal">10090</span>
<span class="normal">10091</span>
<span class="normal">10092</span>
<span class="normal">10093</span>
<span class="normal">10094</span>
<span class="normal">10095</span>
<span class="normal">10096</span>
<span class="normal">10097</span>
<span class="normal">10098</span>
<span class="normal">10099</span>
<span class="normal">10100</span>
<span class="normal">10101</span>
<span class="normal">10102</span>
<span class="normal">10103</span>
<span class="normal">10104</span>
<span class="normal">10105</span>
<span class="normal">10106</span>
<span class="normal">10107</span>
<span class="normal">10108</span>
<span class="normal">10109</span>
<span class="normal">10110</span>
<span class="normal">10111</span>
<span class="normal">10112</span>
<span class="normal">10113</span>
<span class="normal">10114</span>
<span class="normal">10115</span>
<span class="normal">10116</span>
<span class="normal">10117</span>
<span class="normal">10118</span>
<span class="normal">10119</span>
<span class="normal">10120</span>
<span class="normal">10121</span>
<span class="normal">10122</span>
<span class="normal">10123</span>
<span class="normal">10124</span>
<span class="normal">10125</span>
<span class="normal">10126</span>
<span class="normal">10127</span>
<span class="normal">10128</span>
<span class="normal">10129</span>
<span class="normal">10130</span>
<span class="normal">10131</span>
<span class="normal">10132</span>
<span class="normal">10133</span>
<span class="normal">10134</span>
<span class="normal">10135</span>
<span class="normal">10136</span>
<span class="normal">10137</span>
<span class="normal">10138</span>
<span class="normal">10139</span>
<span class="normal">10140</span>
<span class="normal">10141</span>
<span class="normal">10142</span>
<span class="normal">10143</span>
<span class="normal">10144</span>
<span class="normal">10145</span>
<span class="normal">10146</span>
<span class="normal">10147</span>
<span class="normal">10148</span>
<span class="normal">10149</span>
<span class="normal">10150</span>
<span class="normal">10151</span>
<span class="normal">10152</span>
<span class="normal">10153</span>
<span class="normal">10154</span>
<span class="normal">10155</span>
<span class="normal">10156</span>
<span class="normal">10157</span>
<span class="normal">10158</span>
<span class="normal">10159</span>
<span class="normal">10160</span>
<span class="normal">10161</span>
<span class="normal">10162</span>
<span class="normal">10163</span>
<span class="normal">10164</span>
<span class="normal">10165</span>
<span class="normal">10166</span>
<span class="normal">10167</span>
<span class="normal">10168</span>
<span class="normal">10169</span>
<span class="normal">10170</span>
<span class="normal">10171</span>
<span class="normal">10172</span>
<span class="normal">10173</span>
<span class="normal">10174</span>
<span class="normal">10175</span>
<span class="normal">10176</span>
<span class="normal">10177</span>
<span class="normal">10178</span>
<span class="normal">10179</span>
<span class="normal">10180</span>
<span class="normal">10181</span>
<span class="normal">10182</span>
<span class="normal">10183</span>
<span class="normal">10184</span>
<span class="normal">10185</span>
<span class="normal">10186</span>
<span class="normal">10187</span>
<span class="normal">10188</span>
<span class="normal">10189</span>
<span class="normal">10190</span>
<span class="normal">10191</span>
<span class="normal">10192</span>
<span class="normal">10193</span>
<span class="normal">10194</span>
<span class="normal">10195</span>
<span class="normal">10196</span>
<span class="normal">10197</span>
<span class="normal">10198</span>
<span class="normal">10199</span>
<span class="normal">10200</span>
<span class="normal">10201</span>
<span class="normal">10202</span>
<span class="normal">10203</span>
<span class="normal">10204</span>
<span class="normal">10205</span>
<span class="normal">10206</span>
<span class="normal">10207</span>
<span class="normal">10208</span>
<span class="normal">10209</span>
<span class="normal">10210</span>
<span class="normal">10211</span>
<span class="normal">10212</span>
<span class="normal">10213</span>
<span class="normal">10214</span>
<span class="normal">10215</span>
<span class="normal">10216</span>
<span class="normal">10217</span>
<span class="normal">10218</span>
<span class="normal">10219</span>
<span class="normal">10220</span>
<span class="normal">10221</span>
<span class="normal">10222</span>
<span class="normal">10223</span>
<span class="normal">10224</span>
<span class="normal">10225</span>
<span class="normal">10226</span>
<span class="normal">10227</span>
<span class="normal">10228</span>
<span class="normal">10229</span>
<span class="normal">10230</span>
<span class="normal">10231</span>
<span class="normal">10232</span>
<span class="normal">10233</span>
<span class="normal">10234</span>
<span class="normal">10235</span>
<span class="normal">10236</span>
<span class="normal">10237</span>
<span class="normal">10238</span>
<span class="normal">10239</span>
<span class="normal">10240</span>
<span class="normal">10241</span>
<span class="normal">10242</span>
<span class="normal">10243</span>
<span class="normal">10244</span>
<span class="normal">10245</span>
<span class="normal">10246</span>
<span class="normal">10247</span>
<span class="normal">10248</span>
<span class="normal">10249</span>
<span class="normal">10250</span>
<span class="normal">10251</span>
<span class="normal">10252</span>
<span class="normal">10253</span>
<span class="normal">10254</span>
<span class="normal">10255</span>
<span class="normal">10256</span>
<span class="normal">10257</span>
<span class="normal">10258</span>
<span class="normal">10259</span>
<span class="normal">10260</span>
<span class="normal">10261</span>
<span class="normal">10262</span>
<span class="normal">10263</span>
<span class="normal">10264</span>
<span class="normal">10265</span>
<span class="normal">10266</span>
<span class="normal">10267</span>
<span class="normal">10268</span>
<span class="normal">10269</span>
<span class="normal">10270</span>
<span class="normal">10271</span>
<span class="normal">10272</span>
<span class="normal">10273</span>
<span class="normal">10274</span>
<span class="normal">10275</span>
<span class="normal">10276</span>
<span class="normal">10277</span>
<span class="normal">10278</span>
<span class="normal">10279</span>
<span class="normal">10280</span>
<span class="normal">10281</span>
<span class="normal">10282</span>
<span class="normal">10283</span>
<span class="normal">10284</span>
<span class="normal">10285</span>
<span class="normal">10286</span>
<span class="normal">10287</span>
<span class="normal">10288</span>
<span class="normal">10289</span>
<span class="normal">10290</span>
<span class="normal">10291</span>
<span class="normal">10292</span>
<span class="normal">10293</span>
<span class="normal">10294</span>
<span class="normal">10295</span>
<span class="normal">10296</span>
<span class="normal">10297</span>
<span class="normal">10298</span>
<span class="normal">10299</span>
<span class="normal">10300</span>
<span class="normal">10301</span>
<span class="normal">10302</span>
<span class="normal">10303</span>
<span class="normal">10304</span>
<span class="normal">10305</span>
<span class="normal">10306</span>
<span class="normal">10307</span>
<span class="normal">10308</span>
<span class="normal">10309</span>
<span class="normal">10310</span>
<span class="normal">10311</span>
<span class="normal">10312</span>
<span class="normal">10313</span>
<span class="normal">10314</span>
<span class="normal">10315</span>
<span class="normal">10316</span>
<span class="normal">10317</span>
<span class="normal">10318</span>
<span class="normal">10319</span>
<span class="normal">10320</span>
<span class="normal">10321</span>
<span class="normal">10322</span>
<span class="normal">10323</span>
<span class="normal">10324</span>
<span class="normal">10325</span>
<span class="normal">10326</span>
<span class="normal">10327</span>
<span class="normal">10328</span>
<span class="normal">10329</span>
<span class="normal">10330</span>
<span class="normal">10331</span>
<span class="normal">10332</span>
<span class="normal">10333</span>
<span class="normal">10334</span>
<span class="normal">10335</span>
<span class="normal">10336</span>
<span class="normal">10337</span>
<span class="normal">10338</span>
<span class="normal">10339</span>
<span class="normal">10340</span>
<span class="normal">10341</span>
<span class="normal">10342</span>
<span class="normal">10343</span>
<span class="normal">10344</span>
<span class="normal">10345</span>
<span class="normal">10346</span>
<span class="normal">10347</span>
<span class="normal">10348</span>
<span class="normal">10349</span>
<span class="normal">10350</span>
<span class="normal">10351</span>
<span class="normal">10352</span>
<span class="normal">10353</span>
<span class="normal">10354</span>
<span class="normal">10355</span>
<span class="normal">10356</span>
<span class="normal">10357</span>
<span class="normal">10358</span>
<span class="normal">10359</span>
<span class="normal">10360</span>
<span class="normal">10361</span>
<span class="normal">10362</span>
<span class="normal">10363</span>
<span class="normal">10364</span>
<span class="normal">10365</span>
<span class="normal">10366</span>
<span class="normal">10367</span>
<span class="normal">10368</span>
<span class="normal">10369</span>
<span class="normal">10370</span>
<span class="normal">10371</span>
<span class="normal">10372</span>
<span class="normal">10373</span>
<span class="normal">10374</span>
<span class="normal">10375</span>
<span class="normal">10376</span>
<span class="normal">10377</span>
<span class="normal">10378</span>
<span class="normal">10379</span>
<span class="normal">10380</span>
<span class="normal">10381</span>
<span class="normal">10382</span>
<span class="normal">10383</span>
<span class="normal">10384</span>
<span class="normal">10385</span>
<span class="normal">10386</span>
<span class="normal">10387</span>
<span class="normal">10388</span>
<span class="normal">10389</span>
<span class="normal">10390</span>
<span class="normal">10391</span>
<span class="normal">10392</span>
<span class="normal">10393</span>
<span class="normal">10394</span>
<span class="normal">10395</span>
<span class="normal">10396</span>
<span class="normal">10397</span>
<span class="normal">10398</span>
<span class="normal">10399</span>
<span class="normal">10400</span>
<span class="normal">10401</span>
<span class="normal">10402</span>
<span class="normal">10403</span>
<span class="normal">10404</span>
<span class="normal">10405</span>
<span class="normal">10406</span>
<span class="normal">10407</span>
<span class="normal">10408</span>
<span class="normal">10409</span>
<span class="normal">10410</span>
<span class="normal">10411</span>
<span class="normal">10412</span>
<span class="normal">10413</span>
<span class="normal">10414</span>
<span class="normal">10415</span>
<span class="normal">10416</span>
<span class="normal">10417</span>
<span class="normal">10418</span>
<span class="normal">10419</span>
<span class="normal">10420</span>
<span class="normal">10421</span>
<span class="normal">10422</span>
<span class="normal">10423</span>
<span class="normal">10424</span>
<span class="normal">10425</span>
<span class="normal">10426</span>
<span class="normal">10427</span>
<span class="normal">10428</span>
<span class="normal">10429</span>
<span class="normal">10430</span>
<span class="normal">10431</span>
<span class="normal">10432</span>
<span class="normal">10433</span>
<span class="normal">10434</span>
<span class="normal">10435</span>
<span class="normal">10436</span>
<span class="normal">10437</span>
<span class="normal">10438</span>
<span class="normal">10439</span>
<span class="normal">10440</span>
<span class="normal">10441</span>
<span class="normal">10442</span>
<span class="normal">10443</span>
<span class="normal">10444</span>
<span class="normal">10445</span>
<span class="normal">10446</span>
<span class="normal">10447</span>
<span class="normal">10448</span>
<span class="normal">10449</span>
<span class="normal">10450</span>
<span class="normal">10451</span>
<span class="normal">10452</span>
<span class="normal">10453</span>
<span class="normal">10454</span>
<span class="normal">10455</span>
<span class="normal">10456</span>
<span class="normal">10457</span>
<span class="normal">10458</span>
<span class="normal">10459</span>
<span class="normal">10460</span>
<span class="normal">10461</span>
<span class="normal">10462</span>
<span class="normal">10463</span>
<span class="normal">10464</span>
<span class="normal">10465</span>
<span class="normal">10466</span>
<span class="normal">10467</span>
<span class="normal">10468</span>
<span class="normal">10469</span>
<span class="normal">10470</span>
<span class="normal">10471</span>
<span class="normal">10472</span>
<span class="normal">10473</span>
<span class="normal">10474</span>
<span class="normal">10475</span>
<span class="normal">10476</span>
<span class="normal">10477</span>
<span class="normal">10478</span>
<span class="normal">10479</span>
<span class="normal">10480</span>
<span class="normal">10481</span>
<span class="normal">10482</span>
<span class="normal">10483</span>
<span class="normal">10484</span>
<span class="normal">10485</span>
<span class="normal">10486</span>
<span class="normal">10487</span>
<span class="normal">10488</span>
<span class="normal">10489</span>
<span class="normal">10490</span>
<span class="normal">10491</span>
<span class="normal">10492</span>
<span class="normal">10493</span>
<span class="normal">10494</span>
<span class="normal">10495</span>
<span class="normal">10496</span>
<span class="normal">10497</span>
<span class="normal">10498</span>
<span class="normal">10499</span>
<span class="normal">10500</span>
<span class="normal">10501</span>
<span class="normal">10502</span>
<span class="normal">10503</span>
<span class="normal">10504</span>
<span class="normal">10505</span>
<span class="normal">10506</span>
<span class="normal">10507</span>
<span class="normal">10508</span>
<span class="normal">10509</span>
<span class="normal">10510</span>
<span class="normal">10511</span>
<span class="normal">10512</span>
<span class="normal">10513</span>
<span class="normal">10514</span>
<span class="normal">10515</span>
<span class="normal">10516</span>
<span class="normal">10517</span>
<span class="normal">10518</span>
<span class="normal">10519</span>
<span class="normal">10520</span>
<span class="normal">10521</span>
<span class="normal">10522</span>
<span class="normal">10523</span>
<span class="normal">10524</span>
<span class="normal">10525</span>
<span class="normal">10526</span>
<span class="normal">10527</span>
<span class="normal">10528</span>
<span class="normal">10529</span>
<span class="normal">10530</span>
<span class="normal">10531</span>
<span class="normal">10532</span>
<span class="normal">10533</span>
<span class="normal">10534</span>
<span class="normal">10535</span>
<span class="normal">10536</span>
<span class="normal">10537</span>
<span class="normal">10538</span>
<span class="normal">10539</span>
<span class="normal">10540</span>
<span class="normal">10541</span>
<span class="normal">10542</span>
<span class="normal">10543</span>
<span class="normal">10544</span>
<span class="normal">10545</span>
<span class="normal">10546</span>
<span class="normal">10547</span>
<span class="normal">10548</span>
<span class="normal">10549</span>
<span class="normal">10550</span>
<span class="normal">10551</span>
<span class="normal">10552</span>
<span class="normal">10553</span>
<span class="normal">10554</span>
<span class="normal">10555</span>
<span class="normal">10556</span>
<span class="normal">10557</span>
<span class="normal">10558</span>
<span class="normal">10559</span>
<span class="normal">10560</span>
<span class="normal">10561</span>
<span class="normal">10562</span>
<span class="normal">10563</span>
<span class="normal">10564</span>
<span class="normal">10565</span>
<span class="normal">10566</span>
<span class="normal">10567</span>
<span class="normal">10568</span>
<span class="normal">10569</span>
<span class="normal">10570</span>
<span class="normal">10571</span>
<span class="normal">10572</span>
<span class="normal">10573</span>
<span class="normal">10574</span>
<span class="normal">10575</span>
<span class="normal">10576</span>
<span class="normal">10577</span>
<span class="normal">10578</span>
<span class="normal">10579</span>
<span class="normal">10580</span>
<span class="normal">10581</span>
<span class="normal">10582</span>
<span class="normal">10583</span>
<span class="normal">10584</span>
<span class="normal">10585</span>
<span class="normal">10586</span>
<span class="normal">10587</span>
<span class="normal">10588</span>
<span class="normal">10589</span>
<span class="normal">10590</span>
<span class="normal">10591</span>
<span class="normal">10592</span>
<span class="normal">10593</span>
<span class="normal">10594</span>
<span class="normal">10595</span>
<span class="normal">10596</span>
<span class="normal">10597</span>
<span class="normal">10598</span>
<span class="normal">10599</span>
<span class="normal">10600</span>
<span class="normal">10601</span>
<span class="normal">10602</span>
<span class="normal">10603</span>
<span class="normal">10604</span>
<span class="normal">10605</span>
<span class="normal">10606</span>
<span class="normal">10607</span>
<span class="normal">10608</span>
<span class="normal">10609</span>
<span class="normal">10610</span>
<span class="normal">10611</span>
<span class="normal">10612</span>
<span class="normal">10613</span>
<span class="normal">10614</span>
<span class="normal">10615</span>
<span class="normal">10616</span>
<span class="normal">10617</span>
<span class="normal">10618</span>
<span class="normal">10619</span>
<span class="normal">10620</span>
<span class="normal">10621</span>
<span class="normal">10622</span>
<span class="normal">10623</span>
<span class="normal">10624</span>
<span class="normal">10625</span>
<span class="normal">10626</span>
<span class="normal">10627</span>
<span class="normal">10628</span>
<span class="normal">10629</span>
<span class="normal">10630</span>
<span class="normal">10631</span>
<span class="normal">10632</span>
<span class="normal">10633</span>
<span class="normal">10634</span>
<span class="normal">10635</span>
<span class="normal">10636</span>
<span class="normal">10637</span>
<span class="normal">10638</span>
<span class="normal">10639</span>
<span class="normal">10640</span>
<span class="normal">10641</span>
<span class="normal">10642</span>
<span class="normal">10643</span>
<span class="normal">10644</span>
<span class="normal">10645</span>
<span class="normal">10646</span>
<span class="normal">10647</span>
<span class="normal">10648</span>
<span class="normal">10649</span>
<span class="normal">10650</span>
<span class="normal">10651</span>
<span class="normal">10652</span>
<span class="normal">10653</span>
<span class="normal">10654</span>
<span class="normal">10655</span>
<span class="normal">10656</span>
<span class="normal">10657</span>
<span class="normal">10658</span>
<span class="normal">10659</span>
<span class="normal">10660</span>
<span class="normal">10661</span>
<span class="normal">10662</span>
<span class="normal">10663</span>
<span class="normal">10664</span>
<span class="normal">10665</span>
<span class="normal">10666</span>
<span class="normal">10667</span>
<span class="normal">10668</span>
<span class="normal">10669</span>
<span class="normal">10670</span>
<span class="normal">10671</span>
<span class="normal">10672</span>
<span class="normal">10673</span>
<span class="normal">10674</span>
<span class="normal">10675</span>
<span class="normal">10676</span>
<span class="normal">10677</span>
<span class="normal">10678</span>
<span class="normal">10679</span>
<span class="normal">10680</span>
<span class="normal">10681</span>
<span class="normal">10682</span>
<span class="normal">10683</span>
<span class="normal">10684</span>
<span class="normal">10685</span>
<span class="normal">10686</span>
<span class="normal">10687</span>
<span class="normal">10688</span>
<span class="normal">10689</span>
<span class="normal">10690</span>
<span class="normal">10691</span>
<span class="normal">10692</span>
<span class="normal">10693</span>
<span class="normal">10694</span>
<span class="normal">10695</span>
<span class="normal">10696</span>
<span class="normal">10697</span>
<span class="normal">10698</span>
<span class="normal">10699</span>
<span class="normal">10700</span>
<span class="normal">10701</span>
<span class="normal">10702</span>
<span class="normal">10703</span>
<span class="normal">10704</span>
<span class="normal">10705</span>
<span class="normal">10706</span>
<span class="normal">10707</span>
<span class="normal">10708</span>
<span class="normal">10709</span>
<span class="normal">10710</span>
<span class="normal">10711</span>
<span class="normal">10712</span>
<span class="normal">10713</span>
<span class="normal">10714</span>
<span class="normal">10715</span>
<span class="normal">10716</span>
<span class="normal">10717</span>
<span class="normal">10718</span>
<span class="normal">10719</span>
<span class="normal">10720</span>
<span class="normal">10721</span>
<span class="normal">10722</span>
<span class="normal">10723</span>
<span class="normal">10724</span>
<span class="normal">10725</span>
<span class="normal">10726</span>
<span class="normal">10727</span>
<span class="normal">10728</span>
<span class="normal">10729</span>
<span class="normal">10730</span>
<span class="normal">10731</span>
<span class="normal">10732</span>
<span class="normal">10733</span>
<span class="normal">10734</span>
<span class="normal">10735</span>
<span class="normal">10736</span>
<span class="normal">10737</span>
<span class="normal">10738</span>
<span class="normal">10739</span>
<span class="normal">10740</span>
<span class="normal">10741</span>
<span class="normal">10742</span>
<span class="normal">10743</span>
<span class="normal">10744</span>
<span class="normal">10745</span>
<span class="normal">10746</span>
<span class="normal">10747</span>
<span class="normal">10748</span>
<span class="normal">10749</span>
<span class="normal">10750</span>
<span class="normal">10751</span>
<span class="normal">10752</span>
<span class="normal">10753</span>
<span class="normal">10754</span>
<span class="normal">10755</span>
<span class="normal">10756</span>
<span class="normal">10757</span>
<span class="normal">10758</span>
<span class="normal">10759</span>
<span class="normal">10760</span>
<span class="normal">10761</span>
<span class="normal">10762</span>
<span class="normal">10763</span>
<span class="normal">10764</span>
<span class="normal">10765</span>
<span class="normal">10766</span>
<span class="normal">10767</span>
<span class="normal">10768</span>
<span class="normal">10769</span>
<span class="normal">10770</span>
<span class="normal">10771</span>
<span class="normal">10772</span>
<span class="normal">10773</span>
<span class="normal">10774</span>
<span class="normal">10775</span>
<span class="normal">10776</span>
<span class="normal">10777</span>
<span class="normal">10778</span>
<span class="normal">10779</span>
<span class="normal">10780</span>
<span class="normal">10781</span>
<span class="normal">10782</span>
<span class="normal">10783</span>
<span class="normal">10784</span>
<span class="normal">10785</span>
<span class="normal">10786</span>
<span class="normal">10787</span>
<span class="normal">10788</span>
<span class="normal">10789</span>
<span class="normal">10790</span>
<span class="normal">10791</span>
<span class="normal">10792</span>
<span class="normal">10793</span>
<span class="normal">10794</span>
<span class="normal">10795</span>
<span class="normal">10796</span>
<span class="normal">10797</span>
<span class="normal">10798</span>
<span class="normal">10799</span>
<span class="normal">10800</span>
<span class="normal">10801</span>
<span class="normal">10802</span>
<span class="normal">10803</span>
<span class="normal">10804</span>
<span class="normal">10805</span>
<span class="normal">10806</span>
<span class="normal">10807</span>
<span class="normal">10808</span>
<span class="normal">10809</span>
<span class="normal">10810</span>
<span class="normal">10811</span>
<span class="normal">10812</span>
<span class="normal">10813</span>
<span class="normal">10814</span>
<span class="normal">10815</span>
<span class="normal">10816</span>
<span class="normal">10817</span>
<span class="normal">10818</span>
<span class="normal">10819</span>
<span class="normal">10820</span>
<span class="normal">10821</span>
<span class="normal">10822</span>
<span class="normal">10823</span>
<span class="normal">10824</span>
<span class="normal">10825</span>
<span class="normal">10826</span>
<span class="normal">10827</span>
<span class="normal">10828</span>
<span class="normal">10829</span>
<span class="normal">10830</span>
<span class="normal">10831</span>
<span class="normal">10832</span>
<span class="normal">10833</span>
<span class="normal">10834</span>
<span class="normal">10835</span>
<span class="normal">10836</span>
<span class="normal">10837</span>
<span class="normal">10838</span>
<span class="normal">10839</span>
<span class="normal">10840</span>
<span class="normal">10841</span>
<span class="normal">10842</span>
<span class="normal">10843</span>
<span class="normal">10844</span>
<span class="normal">10845</span>
<span class="normal">10846</span>
<span class="normal">10847</span>
<span class="normal">10848</span>
<span class="normal">10849</span>
<span class="normal">10850</span>
<span class="normal">10851</span>
<span class="normal">10852</span>
<span class="normal">10853</span>
<span class="normal">10854</span>
<span class="normal">10855</span>
<span class="normal">10856</span>
<span class="normal">10857</span>
<span class="normal">10858</span>
<span class="normal">10859</span>
<span class="normal">10860</span>
<span class="normal">10861</span>
<span class="normal">10862</span>
<span class="normal">10863</span>
<span class="normal">10864</span>
<span class="normal">10865</span>
<span class="normal">10866</span>
<span class="normal">10867</span>
<span class="normal">10868</span>
<span class="normal">10869</span>
<span class="normal">10870</span>
<span class="normal">10871</span>
<span class="normal">10872</span>
<span class="normal">10873</span>
<span class="normal">10874</span>
<span class="normal">10875</span>
<span class="normal">10876</span>
<span class="normal">10877</span>
<span class="normal">10878</span>
<span class="normal">10879</span>
<span class="normal">10880</span>
<span class="normal">10881</span>
<span class="normal">10882</span>
<span class="normal">10883</span>
<span class="normal">10884</span>
<span class="normal">10885</span>
<span class="normal">10886</span>
<span class="normal">10887</span>
<span class="normal">10888</span>
<span class="normal">10889</span>
<span class="normal">10890</span>
<span class="normal">10891</span>
<span class="normal">10892</span>
<span class="normal">10893</span>
<span class="normal">10894</span>
<span class="normal">10895</span>
<span class="normal">10896</span>
<span class="normal">10897</span>
<span class="normal">10898</span>
<span class="normal">10899</span>
<span class="normal">10900</span>
<span class="normal">10901</span>
<span class="normal">10902</span>
<span class="normal">10903</span>
<span class="normal">10904</span>
<span class="normal">10905</span>
<span class="normal">10906</span>
<span class="normal">10907</span>
<span class="normal">10908</span>
<span class="normal">10909</span>
<span class="normal">10910</span>
<span class="normal">10911</span>
<span class="normal">10912</span>
<span class="normal">10913</span>
<span class="normal">10914</span>
<span class="normal">10915</span>
<span class="normal">10916</span>
<span class="normal">10917</span>
<span class="normal">10918</span>
<span class="normal">10919</span>
<span class="normal">10920</span>
<span class="normal">10921</span>
<span class="normal">10922</span>
<span class="normal">10923</span>
<span class="normal">10924</span>
<span class="normal">10925</span>
<span class="normal">10926</span>
<span class="normal">10927</span>
<span class="normal">10928</span>
<span class="normal">10929</span>
<span class="normal">10930</span>
<span class="normal">10931</span>
<span class="normal">10932</span>
<span class="normal">10933</span>
<span class="normal">10934</span>
<span class="normal">10935</span>
<span class="normal">10936</span>
<span class="normal">10937</span>
<span class="normal">10938</span>
<span class="normal">10939</span>
<span class="normal">10940</span>
<span class="normal">10941</span>
<span class="normal">10942</span>
<span class="normal">10943</span>
<span class="normal">10944</span>
<span class="normal">10945</span>
<span class="normal">10946</span>
<span class="normal">10947</span>
<span class="normal">10948</span>
<span class="normal">10949</span>
<span class="normal">10950</span>
<span class="normal">10951</span>
<span class="normal">10952</span>
<span class="normal">10953</span>
<span class="normal">10954</span>
<span class="normal">10955</span>
<span class="normal">10956</span>
<span class="normal">10957</span>
<span class="normal">10958</span>
<span class="normal">10959</span>
<span class="normal">10960</span>
<span class="normal">10961</span>
<span class="normal">10962</span>
<span class="normal">10963</span>
<span class="normal">10964</span>
<span class="normal">10965</span>
<span class="normal">10966</span>
<span class="normal">10967</span>
<span class="normal">10968</span>
<span class="normal">10969</span>
<span class="normal">10970</span>
<span class="normal">10971</span>
<span class="normal">10972</span>
<span class="normal">10973</span>
<span class="normal">10974</span>
<span class="normal">10975</span>
<span class="normal">10976</span>
<span class="normal">10977</span>
<span class="normal">10978</span>
<span class="normal">10979</span>
<span class="normal">10980</span>
<span class="normal">10981</span>
<span class="normal">10982</span>
<span class="normal">10983</span>
<span class="normal">10984</span>
<span class="normal">10985</span>
<span class="normal">10986</span>
<span class="normal">10987</span>
<span class="normal">10988</span>
<span class="normal">10989</span>
<span class="normal">10990</span>
<span class="normal">10991</span>
<span class="normal">10992</span>
<span class="normal">10993</span>
<span class="normal">10994</span>
<span class="normal">10995</span>
<span class="normal">10996</span>
<span class="normal">10997</span>
<span class="normal">10998</span>
<span class="normal">10999</span>
<span class="normal">11000</span>
<span class="normal">11001</span>
<span class="normal">11002</span>
<span class="normal">11003</span>
<span class="normal">11004</span>
<span class="normal">11005</span>
<span class="normal">11006</span>
<span class="normal">11007</span>
<span class="normal">11008</span>
<span class="normal">11009</span>
<span class="normal">11010</span>
<span class="normal">11011</span>
<span class="normal">11012</span>
<span class="normal">11013</span>
<span class="normal">11014</span>
<span class="normal">11015</span>
<span class="normal">11016</span>
<span class="normal">11017</span>
<span class="normal">11018</span>
<span class="normal">11019</span>
<span class="normal">11020</span>
<span class="normal">11021</span>
<span class="normal">11022</span>
<span class="normal">11023</span>
<span class="normal">11024</span>
<span class="normal">11025</span>
<span class="normal">11026</span>
<span class="normal">11027</span>
<span class="normal">11028</span>
<span class="normal">11029</span>
<span class="normal">11030</span>
<span class="normal">11031</span>
<span class="normal">11032</span>
<span class="normal">11033</span>
<span class="normal">11034</span>
<span class="normal">11035</span>
<span class="normal">11036</span>
<span class="normal">11037</span>
<span class="normal">11038</span>
<span class="normal">11039</span>
<span class="normal">11040</span>
<span class="normal">11041</span>
<span class="normal">11042</span>
<span class="normal">11043</span>
<span class="normal">11044</span>
<span class="normal">11045</span>
<span class="normal">11046</span>
<span class="normal">11047</span>
<span class="normal">11048</span>
<span class="normal">11049</span>
<span class="normal">11050</span>
<span class="normal">11051</span>
<span class="normal">11052</span>
<span class="normal">11053</span>
<span class="normal">11054</span>
<span class="normal">11055</span>
<span class="normal">11056</span>
<span class="normal">11057</span>
<span class="normal">11058</span>
<span class="normal">11059</span>
<span class="normal">11060</span>
<span class="normal">11061</span>
<span class="normal">11062</span>
<span class="normal">11063</span>
<span class="normal">11064</span>
<span class="normal">11065</span>
<span class="normal">11066</span>
<span class="normal">11067</span>
<span class="normal">11068</span>
<span class="normal">11069</span>
<span class="normal">11070</span>
<span class="normal">11071</span>
<span class="normal">11072</span>
<span class="normal">11073</span>
<span class="normal">11074</span>
<span class="normal">11075</span>
<span class="normal">11076</span>
<span class="normal">11077</span>
<span class="normal">11078</span>
<span class="normal">11079</span>
<span class="normal">11080</span>
<span class="normal">11081</span>
<span class="normal">11082</span>
<span class="normal">11083</span>
<span class="normal">11084</span>
<span class="normal">11085</span>
<span class="normal">11086</span>
<span class="normal">11087</span>
<span class="normal">11088</span>
<span class="normal">11089</span>
<span class="normal">11090</span>
<span class="normal">11091</span>
<span class="normal">11092</span>
<span class="normal">11093</span>
<span class="normal">11094</span>
<span class="normal">11095</span>
<span class="normal">11096</span>
<span class="normal">11097</span>
<span class="normal">11098</span>
<span class="normal">11099</span>
<span class="normal">11100</span>
<span class="normal">11101</span>
<span class="normal">11102</span>
<span class="normal">11103</span>
<span class="normal">11104</span>
<span class="normal">11105</span>
<span class="normal">11106</span>
<span class="normal">11107</span>
<span class="normal">11108</span>
<span class="normal">11109</span>
<span class="normal">11110</span>
<span class="normal">11111</span>
<span class="normal">11112</span>
<span class="normal">11113</span>
<span class="normal">11114</span>
<span class="normal">11115</span>
<span class="normal">11116</span>
<span class="normal">11117</span>
<span class="normal">11118</span>
<span class="normal">11119</span>
<span class="normal">11120</span>
<span class="normal">11121</span>
<span class="normal">11122</span>
<span class="normal">11123</span>
<span class="normal">11124</span>
<span class="normal">11125</span>
<span class="normal">11126</span>
<span class="normal">11127</span>
<span class="normal">11128</span>
<span class="normal">11129</span>
<span class="normal">11130</span>
<span class="normal">11131</span>
<span class="normal">11132</span>
<span class="normal">11133</span>
<span class="normal">11134</span>
<span class="normal">11135</span>
<span class="normal">11136</span>
<span class="normal">11137</span>
<span class="normal">11138</span>
<span class="normal">11139</span>
<span class="normal">11140</span>
<span class="normal">11141</span>
<span class="normal">11142</span>
<span class="normal">11143</span>
<span class="normal">11144</span>
<span class="normal">11145</span>
<span class="normal">11146</span>
<span class="normal">11147</span>
<span class="normal">11148</span>
<span class="normal">11149</span>
<span class="normal">11150</span>
<span class="normal">11151</span>
<span class="normal">11152</span>
<span class="normal">11153</span>
<span class="normal">11154</span>
<span class="normal">11155</span>
<span class="normal">11156</span>
<span class="normal">11157</span>
<span class="normal">11158</span>
<span class="normal">11159</span>
<span class="normal">11160</span>
<span class="normal">11161</span>
<span class="normal">11162</span>
<span class="normal">11163</span>
<span class="normal">11164</span>
<span class="normal">11165</span>
<span class="normal">11166</span>
<span class="normal">11167</span>
<span class="normal">11168</span>
<span class="normal">11169</span>
<span class="normal">11170</span>
<span class="normal">11171</span>
<span class="normal">11172</span>
<span class="normal">11173</span>
<span class="normal">11174</span>
<span class="normal">11175</span>
<span class="normal">11176</span>
<span class="normal">11177</span>
<span class="normal">11178</span>
<span class="normal">11179</span>
<span class="normal">11180</span>
<span class="normal">11181</span>
<span class="normal">11182</span>
<span class="normal">11183</span>
<span class="normal">11184</span>
<span class="normal">11185</span>
<span class="normal">11186</span>
<span class="normal">11187</span>
<span class="normal">11188</span>
<span class="normal">11189</span>
<span class="normal">11190</span>
<span class="normal">11191</span>
<span class="normal">11192</span>
<span class="normal">11193</span>
<span class="normal">11194</span>
<span class="normal">11195</span>
<span class="normal">11196</span>
<span class="normal">11197</span>
<span class="normal">11198</span>
<span class="normal">11199</span>
<span class="normal">11200</span>
<span class="normal">11201</span>
<span class="normal">11202</span>
<span class="normal">11203</span>
<span class="normal">11204</span>
<span class="normal">11205</span>
<span class="normal">11206</span>
<span class="normal">11207</span>
<span class="normal">11208</span>
<span class="normal">11209</span>
<span class="normal">11210</span>
<span class="normal">11211</span>
<span class="normal">11212</span>
<span class="normal">11213</span>
<span class="normal">11214</span>
<span class="normal">11215</span>
<span class="normal">11216</span>
<span class="normal">11217</span>
<span class="normal">11218</span>
<span class="normal">11219</span>
<span class="normal">11220</span>
<span class="normal">11221</span>
<span class="normal">11222</span>
<span class="normal">11223</span>
<span class="normal">11224</span>
<span class="normal">11225</span>
<span class="normal">11226</span>
<span class="normal">11227</span>
<span class="normal">11228</span>
<span class="normal">11229</span>
<span class="normal">11230</span>
<span class="normal">11231</span>
<span class="normal">11232</span>
<span class="normal">11233</span>
<span class="normal">11234</span>
<span class="normal">11235</span>
<span class="normal">11236</span>
<span class="normal">11237</span>
<span class="normal">11238</span>
<span class="normal">11239</span>
<span class="normal">11240</span>
<span class="normal">11241</span>
<span class="normal">11242</span>
<span class="normal">11243</span>
<span class="normal">11244</span>
<span class="normal">11245</span>
<span class="normal">11246</span>
<span class="normal">11247</span>
<span class="normal">11248</span>
<span class="normal">11249</span>
<span class="normal">11250</span>
<span class="normal">11251</span>
<span class="normal">11252</span>
<span class="normal">11253</span>
<span class="normal">11254</span>
<span class="normal">11255</span>
<span class="normal">11256</span>
<span class="normal">11257</span>
<span class="normal">11258</span>
<span class="normal">11259</span>
<span class="normal">11260</span>
<span class="normal">11261</span>
<span class="normal">11262</span>
<span class="normal">11263</span>
<span class="normal">11264</span>
<span class="normal">11265</span>
<span class="normal">11266</span>
<span class="normal">11267</span>
<span class="normal">11268</span>
<span class="normal">11269</span>
<span class="normal">11270</span>
<span class="normal">11271</span>
<span class="normal">11272</span>
<span class="normal">11273</span>
<span class="normal">11274</span>
<span class="normal">11275</span>
<span class="normal">11276</span>
<span class="normal">11277</span>
<span class="normal">11278</span>
<span class="normal">11279</span>
<span class="normal">11280</span>
<span class="normal">11281</span>
<span class="normal">11282</span>
<span class="normal">11283</span>
<span class="normal">11284</span>
<span class="normal">11285</span>
<span class="normal">11286</span>
<span class="normal">11287</span>
<span class="normal">11288</span>
<span class="normal">11289</span>
<span class="normal">11290</span>
<span class="normal">11291</span>
<span class="normal">11292</span>
<span class="normal">11293</span>
<span class="normal">11294</span>
<span class="normal">11295</span>
<span class="normal">11296</span>
<span class="normal">11297</span>
<span class="normal">11298</span>
<span class="normal">11299</span>
<span class="normal">11300</span>
<span class="normal">11301</span>
<span class="normal">11302</span>
<span class="normal">11303</span>
<span class="normal">11304</span>
<span class="normal">11305</span>
<span class="normal">11306</span>
<span class="normal">11307</span>
<span class="normal">11308</span>
<span class="normal">11309</span>
<span class="normal">11310</span>
<span class="normal">11311</span>
<span class="normal">11312</span>
<span class="normal">11313</span>
<span class="normal">11314</span>
<span class="normal">11315</span>
<span class="normal">11316</span>
<span class="normal">11317</span>
<span class="normal">11318</span>
<span class="normal">11319</span>
<span class="normal">11320</span>
<span class="normal">11321</span>
<span class="normal">11322</span>
<span class="normal">11323</span>
<span class="normal">11324</span>
<span class="normal">11325</span>
<span class="normal">11326</span>
<span class="normal">11327</span>
<span class="normal">11328</span>
<span class="normal">11329</span>
<span class="normal">11330</span>
<span class="normal">11331</span>
<span class="normal">11332</span>
<span class="normal">11333</span>
<span class="normal">11334</span>
<span class="normal">11335</span>
<span class="normal">11336</span>
<span class="normal">11337</span>
<span class="normal">11338</span>
<span class="normal">11339</span>
<span class="normal">11340</span>
<span class="normal">11341</span>
<span class="normal">11342</span>
<span class="normal">11343</span>
<span class="normal">11344</span>
<span class="normal">11345</span>
<span class="normal">11346</span>
<span class="normal">11347</span>
<span class="normal">11348</span>
<span class="normal">11349</span>
<span class="normal">11350</span>
<span class="normal">11351</span>
<span class="normal">11352</span>
<span class="normal">11353</span>
<span class="normal">11354</span>
<span class="normal">11355</span>
<span class="normal">11356</span>
<span class="normal">11357</span>
<span class="normal">11358</span>
<span class="normal">11359</span>
<span class="normal">11360</span>
<span class="normal">11361</span>
<span class="normal">11362</span>
<span class="normal">11363</span>
<span class="normal">11364</span>
<span class="normal">11365</span>
<span class="normal">11366</span>
<span class="normal">11367</span>
<span class="normal">11368</span>
<span class="normal">11369</span>
<span class="normal">11370</span>
<span class="normal">11371</span>
<span class="normal">11372</span>
<span class="normal">11373</span>
<span class="normal">11374</span>
<span class="normal">11375</span>
<span class="normal">11376</span>
<span class="normal">11377</span>
<span class="normal">11378</span>
<span class="normal">11379</span>
<span class="normal">11380</span>
<span class="normal">11381</span>
<span class="normal">11382</span>
<span class="normal">11383</span>
<span class="normal">11384</span>
<span class="normal">11385</span>
<span class="normal">11386</span>
<span class="normal">11387</span>
<span class="normal">11388</span>
<span class="normal">11389</span>
<span class="normal">11390</span>
<span class="normal">11391</span>
<span class="normal">11392</span>
<span class="normal">11393</span>
<span class="normal">11394</span>
<span class="normal">11395</span>
<span class="normal">11396</span>
<span class="normal">11397</span>
<span class="normal">11398</span>
<span class="normal">11399</span>
<span class="normal">11400</span>
<span class="normal">11401</span>
<span class="normal">11402</span>
<span class="normal">11403</span>
<span class="normal">11404</span>
<span class="normal">11405</span>
<span class="normal">11406</span>
<span class="normal">11407</span>
<span class="normal">11408</span>
<span class="normal">11409</span>
<span class="normal">11410</span>
<span class="normal">11411</span>
<span class="normal">11412</span>
<span class="normal">11413</span>
<span class="normal">11414</span>
<span class="normal">11415</span>
<span class="normal">11416</span>
<span class="normal">11417</span>
<span class="normal">11418</span>
<span class="normal">11419</span>
<span class="normal">11420</span>
<span class="normal">11421</span>
<span class="normal">11422</span>
<span class="normal">11423</span>
<span class="normal">11424</span>
<span class="normal">11425</span>
<span class="normal">11426</span>
<span class="normal">11427</span>
<span class="normal">11428</span>
<span class="normal">11429</span>
<span class="normal">11430</span>
<span class="normal">11431</span>
<span class="normal">11432</span>
<span class="normal">11433</span>
<span class="normal">11434</span>
<span class="normal">11435</span>
<span class="normal">11436</span>
<span class="normal">11437</span>
<span class="normal">11438</span>
<span class="normal">11439</span>
<span class="normal">11440</span>
<span class="normal">11441</span>
<span class="normal">11442</span>
<span class="normal">11443</span>
<span class="normal">11444</span>
<span class="normal">11445</span>
<span class="normal">11446</span>
<span class="normal">11447</span>
<span class="normal">11448</span>
<span class="normal">11449</span>
<span class="normal">11450</span>
<span class="normal">11451</span>
<span class="normal">11452</span>
<span class="normal">11453</span>
<span class="normal">11454</span>
<span class="normal">11455</span>
<span class="normal">11456</span>
<span class="normal">11457</span>
<span class="normal">11458</span>
<span class="normal">11459</span>
<span class="normal">11460</span>
<span class="normal">11461</span>
<span class="normal">11462</span>
<span class="normal">11463</span>
<span class="normal">11464</span>
<span class="normal">11465</span>
<span class="normal">11466</span>
<span class="normal">11467</span>
<span class="normal">11468</span>
<span class="normal">11469</span>
<span class="normal">11470</span>
<span class="normal">11471</span>
<span class="normal">11472</span>
<span class="normal">11473</span>
<span class="normal">11474</span>
<span class="normal">11475</span>
<span class="normal">11476</span>
<span class="normal">11477</span>
<span class="normal">11478</span>
<span class="normal">11479</span>
<span class="normal">11480</span>
<span class="normal">11481</span>
<span class="normal">11482</span>
<span class="normal">11483</span>
<span class="normal">11484</span>
<span class="normal">11485</span>
<span class="normal">11486</span>
<span class="normal">11487</span>
<span class="normal">11488</span>
<span class="normal">11489</span>
<span class="normal">11490</span>
<span class="normal">11491</span>
<span class="normal">11492</span>
<span class="normal">11493</span>
<span class="normal">11494</span>
<span class="normal">11495</span>
<span class="normal">11496</span>
<span class="normal">11497</span>
<span class="normal">11498</span>
<span class="normal">11499</span>
<span class="normal">11500</span>
<span class="normal">11501</span>
<span class="normal">11502</span>
<span class="normal">11503</span>
<span class="normal">11504</span>
<span class="normal">11505</span>
<span class="normal">11506</span>
<span class="normal">11507</span>
<span class="normal">11508</span>
<span class="normal">11509</span>
<span class="normal">11510</span>
<span class="normal">11511</span>
<span class="normal">11512</span>
<span class="normal">11513</span>
<span class="normal">11514</span>
<span class="normal">11515</span>
<span class="normal">11516</span>
<span class="normal">11517</span>
<span class="normal">11518</span>
<span class="normal">11519</span>
<span class="normal">11520</span>
<span class="normal">11521</span>
<span class="normal">11522</span>
<span class="normal">11523</span>
<span class="normal">11524</span>
<span class="normal">11525</span>
<span class="normal">11526</span>
<span class="normal">11527</span>
<span class="normal">11528</span>
<span class="normal">11529</span>
<span class="normal">11530</span>
<span class="normal">11531</span>
<span class="normal">11532</span>
<span class="normal">11533</span>
<span class="normal">11534</span>
<span class="normal">11535</span>
<span class="normal">11536</span>
<span class="normal">11537</span>
<span class="normal">11538</span>
<span class="normal">11539</span>
<span class="normal">11540</span>
<span class="normal">11541</span>
<span class="normal">11542</span>
<span class="normal">11543</span>
<span class="normal">11544</span>
<span class="normal">11545</span>
<span class="normal">11546</span>
<span class="normal">11547</span>
<span class="normal">11548</span>
<span class="normal">11549</span>
<span class="normal">11550</span>
<span class="normal">11551</span>
<span class="normal">11552</span>
<span class="normal">11553</span>
<span class="normal">11554</span>
<span class="normal">11555</span>
<span class="normal">11556</span>
<span class="normal">11557</span>
<span class="normal">11558</span>
<span class="normal">11559</span>
<span class="normal">11560</span>
<span class="normal">11561</span>
<span class="normal">11562</span>
<span class="normal">11563</span>
<span class="normal">11564</span>
<span class="normal">11565</span>
<span class="normal">11566</span>
<span class="normal">11567</span>
<span class="normal">11568</span>
<span class="normal">11569</span>
<span class="normal">11570</span>
<span class="normal">11571</span>
<span class="normal">11572</span>
<span class="normal">11573</span>
<span class="normal">11574</span>
<span class="normal">11575</span>
<span class="normal">11576</span>
<span class="normal">11577</span>
<span class="normal">11578</span>
<span class="normal">11579</span>
<span class="normal">11580</span>
<span class="normal">11581</span>
<span class="normal">11582</span>
<span class="normal">11583</span>
<span class="normal">11584</span>
<span class="normal">11585</span>
<span class="normal">11586</span>
<span class="normal">11587</span>
<span class="normal">11588</span>
<span class="normal">11589</span>
<span class="normal">11590</span>
<span class="normal">11591</span>
<span class="normal">11592</span>
<span class="normal">11593</span>
<span class="normal">11594</span>
<span class="normal">11595</span>
<span class="normal">11596</span>
<span class="normal">11597</span>
<span class="normal">11598</span>
<span class="normal">11599</span>
<span class="normal">11600</span>
<span class="normal">11601</span>
<span class="normal">11602</span>
<span class="normal">11603</span>
<span class="normal">11604</span>
<span class="normal">11605</span>
<span class="normal">11606</span>
<span class="normal">11607</span>
<span class="normal">11608</span>
<span class="normal">11609</span>
<span class="normal">11610</span>
<span class="normal">11611</span>
<span class="normal">11612</span>
<span class="normal">11613</span>
<span class="normal">11614</span>
<span class="normal">11615</span>
<span class="normal">11616</span>
<span class="normal">11617</span>
<span class="normal">11618</span>
<span class="normal">11619</span>
<span class="normal">11620</span>
<span class="normal">11621</span>
<span class="normal">11622</span>
<span class="normal">11623</span>
<span class="normal">11624</span>
<span class="normal">11625</span>
<span class="normal">11626</span>
<span class="normal">11627</span>
<span class="normal">11628</span>
<span class="normal">11629</span>
<span class="normal">11630</span>
<span class="normal">11631</span>
<span class="normal">11632</span>
<span class="normal">11633</span>
<span class="normal">11634</span>
<span class="normal">11635</span>
<span class="normal">11636</span>
<span class="normal">11637</span>
<span class="normal">11638</span>
<span class="normal">11639</span>
<span class="normal">11640</span>
<span class="normal">11641</span>
<span class="normal">11642</span>
<span class="normal">11643</span>
<span class="normal">11644</span>
<span class="normal">11645</span>
<span class="normal">11646</span>
<span class="normal">11647</span>
<span class="normal">11648</span>
<span class="normal">11649</span>
<span class="normal">11650</span>
<span class="normal">11651</span>
<span class="normal">11652</span>
<span class="normal">11653</span>
<span class="normal">11654</span>
<span class="normal">11655</span>
<span class="normal">11656</span>
<span class="normal">11657</span>
<span class="normal">11658</span>
<span class="normal">11659</span>
<span class="normal">11660</span>
<span class="normal">11661</span>
<span class="normal">11662</span>
<span class="normal">11663</span>
<span class="normal">11664</span>
<span class="normal">11665</span>
<span class="normal">11666</span>
<span class="normal">11667</span>
<span class="normal">11668</span>
<span class="normal">11669</span>
<span class="normal">11670</span>
<span class="normal">11671</span>
<span class="normal">11672</span>
<span class="normal">11673</span>
<span class="normal">11674</span>
<span class="normal">11675</span>
<span class="normal">11676</span>
<span class="normal">11677</span>
<span class="normal">11678</span>
<span class="normal">11679</span>
<span class="normal">11680</span>
<span class="normal">11681</span>
<span class="normal">11682</span>
<span class="normal">11683</span>
<span class="normal">11684</span>
<span class="normal">11685</span>
<span class="normal">11686</span>
<span class="normal">11687</span>
<span class="normal">11688</span>
<span class="normal">11689</span>
<span class="normal">11690</span>
<span class="normal">11691</span>
<span class="normal">11692</span>
<span class="normal">11693</span>
<span class="normal">11694</span>
<span class="normal">11695</span>
<span class="normal">11696</span>
<span class="normal">11697</span>
<span class="normal">11698</span>
<span class="normal">11699</span>
<span class="normal">11700</span>
<span class="normal">11701</span>
<span class="normal">11702</span>
<span class="normal">11703</span>
<span class="normal">11704</span>
<span class="normal">11705</span>
<span class="normal">11706</span>
<span class="normal">11707</span>
<span class="normal">11708</span>
<span class="normal">11709</span>
<span class="normal">11710</span>
<span class="normal">11711</span>
<span class="normal">11712</span>
<span class="normal">11713</span>
<span class="normal">11714</span>
<span class="normal">11715</span>
<span class="normal">11716</span>
<span class="normal">11717</span>
<span class="normal">11718</span>
<span class="normal">11719</span>
<span class="normal">11720</span>
<span class="normal">11721</span>
<span class="normal">11722</span>
<span class="normal">11723</span>
<span class="normal">11724</span>
<span class="normal">11725</span>
<span class="normal">11726</span>
<span class="normal">11727</span>
<span class="normal">11728</span>
<span class="normal">11729</span>
<span class="normal">11730</span>
<span class="normal">11731</span>
<span class="normal">11732</span>
<span class="normal">11733</span>
<span class="normal">11734</span>
<span class="normal">11735</span>
<span class="normal">11736</span>
<span class="normal">11737</span>
<span class="normal">11738</span>
<span class="normal">11739</span>
<span class="normal">11740</span>
<span class="normal">11741</span>
<span class="normal">11742</span>
<span class="normal">11743</span>
<span class="normal">11744</span>
<span class="normal">11745</span>
<span class="normal">11746</span>
<span class="normal">11747</span>
<span class="normal">11748</span>
<span class="normal">11749</span>
<span class="normal">11750</span>
<span class="normal">11751</span>
<span class="normal">11752</span>
<span class="normal">11753</span>
<span class="normal">11754</span>
<span class="normal">11755</span>
<span class="normal">11756</span>
<span class="normal">11757</span>
<span class="normal">11758</span>
<span class="normal">11759</span>
<span class="normal">11760</span>
<span class="normal">11761</span>
<span class="normal">11762</span>
<span class="normal">11763</span>
<span class="normal">11764</span>
<span class="normal">11765</span>
<span class="normal">11766</span>
<span class="normal">11767</span>
<span class="normal">11768</span>
<span class="normal">11769</span>
<span class="normal">11770</span>
<span class="normal">11771</span>
<span class="normal">11772</span>
<span class="normal">11773</span>
<span class="normal">11774</span>
<span class="normal">11775</span>
<span class="normal">11776</span>
<span class="normal">11777</span>
<span class="normal">11778</span>
<span class="normal">11779</span>
<span class="normal">11780</span>
<span class="normal">11781</span>
<span class="normal">11782</span>
<span class="normal">11783</span>
<span class="normal">11784</span>
<span class="normal">11785</span>
<span class="normal">11786</span>
<span class="normal">11787</span>
<span class="normal">11788</span>
<span class="normal">11789</span>
<span class="normal">11790</span>
<span class="normal">11791</span>
<span class="normal">11792</span>
<span class="normal">11793</span>
<span class="normal">11794</span>
<span class="normal">11795</span>
<span class="normal">11796</span>
<span class="normal">11797</span>
<span class="normal">11798</span>
<span class="normal">11799</span>
<span class="normal">11800</span>
<span class="normal">11801</span>
<span class="normal">11802</span>
<span class="normal">11803</span>
<span class="normal">11804</span>
<span class="normal">11805</span>
<span class="normal">11806</span>
<span class="normal">11807</span>
<span class="normal">11808</span>
<span class="normal">11809</span>
<span class="normal">11810</span>
<span class="normal">11811</span>
<span class="normal">11812</span>
<span class="normal">11813</span>
<span class="normal">11814</span>
<span class="normal">11815</span>
<span class="normal">11816</span>
<span class="normal">11817</span>
<span class="normal">11818</span>
<span class="normal">11819</span>
<span class="normal">11820</span>
<span class="normal">11821</span>
<span class="normal">11822</span>
<span class="normal">11823</span>
<span class="normal">11824</span>
<span class="normal">11825</span>
<span class="normal">11826</span>
<span class="normal">11827</span>
<span class="normal">11828</span>
<span class="normal">11829</span>
<span class="normal">11830</span>
<span class="normal">11831</span>
<span class="normal">11832</span>
<span class="normal">11833</span>
<span class="normal">11834</span>
<span class="normal">11835</span>
<span class="normal">11836</span>
<span class="normal">11837</span>
<span class="normal">11838</span>
<span class="normal">11839</span>
<span class="normal">11840</span>
<span class="normal">11841</span>
<span class="normal">11842</span>
<span class="normal">11843</span>
<span class="normal">11844</span>
<span class="normal">11845</span>
<span class="normal">11846</span>
<span class="normal">11847</span>
<span class="normal">11848</span>
<span class="normal">11849</span>
<span class="normal">11850</span>
<span class="normal">11851</span>
<span class="normal">11852</span>
<span class="normal">11853</span>
<span class="normal">11854</span>
<span class="normal">11855</span>
<span class="normal">11856</span>
<span class="normal">11857</span>
<span class="normal">11858</span>
<span class="normal">11859</span>
<span class="normal">11860</span></pre></div></td><td class="code"><div><pre><span></span><a id="line-1" name="line-1"></a><span class="c1">/////////////////////////////////////////////////////////////////////////</span>
<a id="line-2" name="line-2"></a><span class="c1">// $Id: rombios.c,v 1.221 2008/12/07 17:32:29 sshwarts Exp $</span>
<a id="line-3" name="line-3"></a><span class="c1">////////////////////////////#/////////////////////////////////////////////</span>
<a id="line-4" name="line-4"></a><span class="c1">//</span>
<a id="line-5" name="line-5"></a><span class="c1">//  Copyright (C) 2002  MandrakeSoft S.A.</span>
<a id="line-6" name="line-6"></a><span class="c1">//</span>
<a id="line-7" name="line-7"></a><span class="c1">//    MandrakeSoft S.A.</span>
<a id="line-8" name="line-8"></a><span class="c1">//    43, rue d&#39;Aboukir</span>
<a id="line-9" name="line-9"></a><span class="c1">//    75002 Paris - France</span>
<a id="line-10" name="line-10"></a><span class="c1">//    http://www.linux-mandrake.com/</span>
<a id="line-11" name="line-11"></a><span class="c1">//    http://www.mandrakesoft.com/</span>
<a id="line-12" name="line-12"></a><span class="c1">//</span>
<a id="line-13" name="line-13"></a><span class="c1">//  This library is free software; you can redistribute it and/or</span>
<a id="line-14" name="line-14"></a><span class="c1">//  modify it under the terms of the GNU Lesser General Public</span>
<a id="line-15" name="line-15"></a><span class="c1">//  License as published by the Free Software Foundation; either</span>
<a id="line-16" name="line-16"></a><span class="c1">//  version 2 of the License, or (at your option) any later version.</span>
<a id="line-17" name="line-17"></a><span class="c1">//</span>
<a id="line-18" name="line-18"></a><span class="c1">//  This library is distributed in the hope that it will be useful,</span>
<a id="line-19" name="line-19"></a><span class="c1">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a id="line-20" name="line-20"></a><span class="c1">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a id="line-21" name="line-21"></a><span class="c1">//  Lesser General Public License for more details.</span>
<a id="line-22" name="line-22"></a><span class="c1">//</span>
<a id="line-23" name="line-23"></a><span class="c1">//  You should have received a copy of the GNU Lesser General Public</span>
<a id="line-24" name="line-24"></a><span class="c1">//  License along with this library; If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a id="line-25" name="line-25"></a>
<a id="line-26" name="line-26"></a><span class="c1">// ROM BIOS for use with Bochs/Plex86/QEMU emulation environment</span>
<a id="line-27" name="line-27"></a>
<a id="line-28" name="line-28"></a><span class="cp">#define uint8_t unsigned char</span>
<a id="line-29" name="line-29"></a><span class="cp">#define uint16_t unsigned short</span>
<a id="line-30" name="line-30"></a><span class="cp">#define uint32_t unsigned long</span>
<a id="line-31" name="line-31"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<a id="line-32" name="line-32"></a>
<a id="line-33" name="line-33"></a><span class="cp">#define HVMASSIST</span>
<a id="line-34" name="line-34"></a><span class="cp">#undef HVMTEST</span>
<a id="line-35" name="line-35"></a>
<a id="line-36" name="line-36"></a><span class="c1">// Xen full virtualization does not handle unaligned IO with page crossing.</span>
<a id="line-37" name="line-37"></a><span class="c1">// Disable 32-bit PIO as a workaround.</span>
<a id="line-38" name="line-38"></a><span class="cp">#undef NO_PIO32</span>
<a id="line-39" name="line-39"></a>
<a id="line-40" name="line-40"></a>
<a id="line-41" name="line-41"></a><span class="c1">// ROM BIOS compatability entry points:</span>
<a id="line-42" name="line-42"></a><span class="c1">// ===================================</span>
<a id="line-43" name="line-43"></a><span class="c1">// $e05b ; POST Entry Point</span>
<a id="line-44" name="line-44"></a><span class="c1">// $e2c3 ; NMI Handler Entry Point</span>
<a id="line-45" name="line-45"></a><span class="c1">// $e3fe ; INT 13h Fixed Disk Services Entry Point</span>
<a id="line-46" name="line-46"></a><span class="c1">// $e401 ; Fixed Disk Parameter Table</span>
<a id="line-47" name="line-47"></a><span class="c1">// $e6f2 ; INT 19h Boot Load Service Entry Point</span>
<a id="line-48" name="line-48"></a><span class="c1">// $e6f5 ; Configuration Data Table</span>
<a id="line-49" name="line-49"></a><span class="c1">// $e729 ; Baud Rate Generator Table</span>
<a id="line-50" name="line-50"></a><span class="c1">// $e739 ; INT 14h Serial Communications Service Entry Point</span>
<a id="line-51" name="line-51"></a><span class="c1">// $e82e ; INT 16h Keyboard Service Entry Point</span>
<a id="line-52" name="line-52"></a><span class="c1">// $e987 ; INT 09h Keyboard Service Entry Point</span>
<a id="line-53" name="line-53"></a><span class="c1">// $ec59 ; INT 13h Diskette Service Entry Point</span>
<a id="line-54" name="line-54"></a><span class="c1">// $ef57 ; INT 0Eh Diskette Hardware ISR Entry Point</span>
<a id="line-55" name="line-55"></a><span class="c1">// $efc7 ; Diskette Controller Parameter Table</span>
<a id="line-56" name="line-56"></a><span class="c1">// $efd2 ; INT 17h Printer Service Entry Point</span>
<a id="line-57" name="line-57"></a><span class="c1">// $f045 ; INT 10 Functions 0-Fh Entry Point</span>
<a id="line-58" name="line-58"></a><span class="c1">// $f065 ; INT 10h Video Support Service Entry Point</span>
<a id="line-59" name="line-59"></a><span class="c1">// $f0a4 ; MDA/CGA Video Parameter Table (INT 1Dh)</span>
<a id="line-60" name="line-60"></a><span class="c1">// $f841 ; INT 12h Memory Size Service Entry Point</span>
<a id="line-61" name="line-61"></a><span class="c1">// $f84d ; INT 11h Equipment List Service Entry Point</span>
<a id="line-62" name="line-62"></a><span class="c1">// $f859 ; INT 15h System Services Entry Point</span>
<a id="line-63" name="line-63"></a><span class="c1">// $fa6e ; Character Font for 320x200 &amp; 640x200 Graphics (lower 128 characters)</span>
<a id="line-64" name="line-64"></a><span class="c1">// $fe6e ; INT 1Ah Time-of-day Service Entry Point</span>
<a id="line-65" name="line-65"></a><span class="c1">// $fea5 ; INT 08h System Timer ISR Entry Point</span>
<a id="line-66" name="line-66"></a><span class="c1">// $fef3 ; Initial Interrupt Vector Offsets Loaded by POST</span>
<a id="line-67" name="line-67"></a><span class="c1">// $ff53 ; IRET Instruction for Dummy Interrupt Handler</span>
<a id="line-68" name="line-68"></a><span class="c1">// $ff54 ; INT 05h Print Screen Service Entry Point</span>
<a id="line-69" name="line-69"></a><span class="c1">// $fff0 ; Power-up Entry Point</span>
<a id="line-70" name="line-70"></a><span class="c1">// $fff5 ; ASCII Date ROM was built - 8 characters in MM/DD/YY</span>
<a id="line-71" name="line-71"></a><span class="c1">// $fffe ; System Model ID</span>
<a id="line-72" name="line-72"></a>
<a id="line-73" name="line-73"></a><span class="c1">// NOTES for ATA/ATAPI driver (cbbochs@free.fr)</span>
<a id="line-74" name="line-74"></a><span class="c1">//   Features</span>
<a id="line-75" name="line-75"></a><span class="c1">//     - supports up to 4 ATA interfaces</span>
<a id="line-76" name="line-76"></a><span class="c1">//     - device/geometry detection</span>
<a id="line-77" name="line-77"></a><span class="c1">//     - 16bits/32bits device access</span>
<a id="line-78" name="line-78"></a><span class="c1">//     - pchs/lba access</span>
<a id="line-79" name="line-79"></a><span class="c1">//     - datain/dataout/packet command support</span>
<a id="line-80" name="line-80"></a><span class="c1">//</span>
<a id="line-81" name="line-81"></a><span class="c1">// NOTES for El-Torito Boot (cbbochs@free.fr)</span>
<a id="line-82" name="line-82"></a><span class="c1">//   - CD-ROM booting is only available if ATA/ATAPI Driver is available</span>
<a id="line-83" name="line-83"></a><span class="c1">//   - Current code is only able to boot mono-session cds</span>
<a id="line-84" name="line-84"></a><span class="c1">//   - Current code can not boot and emulate a hard-disk</span>
<a id="line-85" name="line-85"></a><span class="c1">//     the bios will panic otherwise</span>
<a id="line-86" name="line-86"></a><span class="c1">//   - Current code also use memory in EBDA segement.</span>
<a id="line-87" name="line-87"></a><span class="c1">//   - I used cmos byte 0x3D to store extended information on boot-device</span>
<a id="line-88" name="line-88"></a><span class="c1">//   - Code has to be modified modified to handle multiple cdrom drives</span>
<a id="line-89" name="line-89"></a><span class="c1">//   - Here are the cdrom boot failure codes:</span>
<a id="line-90" name="line-90"></a><span class="c1">//       1 : no atapi device found</span>
<a id="line-91" name="line-91"></a><span class="c1">//       2 : no atapi cdrom found</span>
<a id="line-92" name="line-92"></a><span class="c1">//       3 : can not read cd - BRVD</span>
<a id="line-93" name="line-93"></a><span class="c1">//       4 : cd is not eltorito (BRVD)</span>
<a id="line-94" name="line-94"></a><span class="c1">//       5 : cd is not eltorito (ISO TAG)</span>
<a id="line-95" name="line-95"></a><span class="c1">//       6 : cd is not eltorito (ELTORITO TAG)</span>
<a id="line-96" name="line-96"></a><span class="c1">//       7 : can not read cd - boot catalog</span>
<a id="line-97" name="line-97"></a><span class="c1">//       8 : boot catalog : bad header</span>
<a id="line-98" name="line-98"></a><span class="c1">//       9 : boot catalog : bad platform</span>
<a id="line-99" name="line-99"></a><span class="c1">//      10 : boot catalog : bad signature</span>
<a id="line-100" name="line-100"></a><span class="c1">//      11 : boot catalog : bootable flag not set</span>
<a id="line-101" name="line-101"></a><span class="c1">//      12 : can not read cd - boot image</span>
<a id="line-102" name="line-102"></a><span class="c1">//</span>
<a id="line-103" name="line-103"></a><span class="c1">//   ATA driver</span>
<a id="line-104" name="line-104"></a><span class="c1">//   - EBDA segment.</span>
<a id="line-105" name="line-105"></a><span class="c1">//     I used memory starting at 0x121 in the segment</span>
<a id="line-106" name="line-106"></a><span class="c1">//   - the translation policy is defined in cmos regs 0x39 &amp; 0x3a</span>
<a id="line-107" name="line-107"></a><span class="c1">//</span>
<a id="line-108" name="line-108"></a><span class="c1">// TODO :</span>
<a id="line-109" name="line-109"></a><span class="c1">//</span>
<a id="line-110" name="line-110"></a><span class="c1">//   int74</span>
<a id="line-111" name="line-111"></a><span class="c1">//     - needs to be reworked.  Uses direct [bp] offsets. (?)</span>
<a id="line-112" name="line-112"></a><span class="c1">//</span>
<a id="line-113" name="line-113"></a><span class="c1">//   int13:</span>
<a id="line-114" name="line-114"></a><span class="c1">//     - f04 (verify sectors) isn&#39;t complete  (?)</span>
<a id="line-115" name="line-115"></a><span class="c1">//     - f02/03/04 should set current cyl,etc in BDA  (?)</span>
<a id="line-116" name="line-116"></a><span class="c1">//     - rewrite int13_relocated &amp; clean up int13 entry code</span>
<a id="line-117" name="line-117"></a><span class="c1">//</span>
<a id="line-118" name="line-118"></a><span class="c1">//   NOTES:</span>
<a id="line-119" name="line-119"></a><span class="c1">//   - NMI access (bit7 of addr written to 70h)</span>
<a id="line-120" name="line-120"></a><span class="c1">//</span>
<a id="line-121" name="line-121"></a><span class="c1">//   ATA driver</span>
<a id="line-122" name="line-122"></a><span class="c1">//   - should handle the &quot;don&#39;t detect&quot; bit (cmos regs 0x3b &amp; 0x3c)</span>
<a id="line-123" name="line-123"></a><span class="c1">//   - could send the multiple-sector read/write commands</span>
<a id="line-124" name="line-124"></a><span class="c1">//</span>
<a id="line-125" name="line-125"></a><span class="c1">//   El-Torito</span>
<a id="line-126" name="line-126"></a><span class="c1">//   - Emulate a Hard-disk (currently only diskette can be emulated) see &quot;FIXME ElTorito Harddisk&quot;</span>
<a id="line-127" name="line-127"></a><span class="c1">//   - Implement remaining int13_cdemu functions (as defined by El-Torito specs)</span>
<a id="line-128" name="line-128"></a><span class="c1">//   - cdrom drive is hardcoded to ide 0 device 1 in several places. see &quot;FIXME ElTorito Hardcoded&quot;</span>
<a id="line-129" name="line-129"></a><span class="c1">//   - int13 Fix DL when emulating a cd. In that case DL is decremented before calling real int13.</span>
<a id="line-130" name="line-130"></a><span class="c1">//     This is ok. But DL should be reincremented afterwards.</span>
<a id="line-131" name="line-131"></a><span class="c1">//   - Fix all &quot;FIXME ElTorito Various&quot;</span>
<a id="line-132" name="line-132"></a><span class="c1">//   - should be able to boot any cdrom instead of the first one</span>
<a id="line-133" name="line-133"></a><span class="c1">//</span>
<a id="line-134" name="line-134"></a><span class="c1">//   BCC Bug: find a generic way to handle the bug of #asm after an &quot;if&quot;  (fixed in 0.16.7)</span>
<a id="line-135" name="line-135"></a>
<a id="line-136" name="line-136"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rombios.h&quot;</span>
<a id="line-137" name="line-137"></a>
<a id="line-138" name="line-138"></a><span class="cp">#define DEBUG_ATA          0</span>
<a id="line-139" name="line-139"></a><span class="cp">#define DEBUG_INT13_HD     0</span>
<a id="line-140" name="line-140"></a><span class="cp">#define DEBUG_INT13_CD     0</span>
<a id="line-141" name="line-141"></a><span class="cp">#define DEBUG_INT13_ET     0</span>
<a id="line-142" name="line-142"></a><span class="cp">#define DEBUG_INT13_FL     0</span>
<a id="line-143" name="line-143"></a><span class="cp">#define DEBUG_INT15        0</span>
<a id="line-144" name="line-144"></a><span class="cp">#define DEBUG_INT16        0</span>
<a id="line-145" name="line-145"></a><span class="cp">#define DEBUG_INT1A        0</span>
<a id="line-146" name="line-146"></a><span class="cp">#define DEBUG_INT74        0</span>
<a id="line-147" name="line-147"></a><span class="cp">#define DEBUG_APM          0</span>
<a id="line-148" name="line-148"></a>
<a id="line-149" name="line-149"></a><span class="cp">#define BX_CPU           3</span>
<a id="line-150" name="line-150"></a><span class="cp">#define BX_USE_PS2_MOUSE 1</span>
<a id="line-151" name="line-151"></a><span class="cp">#define BX_CALL_INT15_4F 1</span>
<a id="line-152" name="line-152"></a><span class="cp">#define BX_USE_EBDA      1</span>
<a id="line-153" name="line-153"></a><span class="cp">#define BX_SUPPORT_FLOPPY 1</span>
<a id="line-154" name="line-154"></a><span class="cp">#define BX_FLOPPY_ON_CNT 37   </span><span class="cm">/* 2 seconds */</span>
<a id="line-155" name="line-155"></a><span class="cp">#define BX_PCIBIOS       1</span>
<a id="line-156" name="line-156"></a><span class="cp">#define BX_APM           1</span>
<a id="line-157" name="line-157"></a>
<a id="line-158" name="line-158"></a><span class="cp">#define BX_USE_ATADRV    1</span>
<a id="line-159" name="line-159"></a><span class="cp">#define BX_ELTORITO_BOOT 1</span>
<a id="line-160" name="line-160"></a>
<a id="line-161" name="line-161"></a><span class="cp">#define BX_TCGBIOS       0   </span><span class="cm">/* main switch for TCG BIOS ext. */</span>
<a id="line-162" name="line-162"></a>
<a id="line-163" name="line-163"></a><span class="cp">#define BX_PMM           1   </span><span class="cm">/* POST Memory Manager */</span>
<a id="line-164" name="line-164"></a>
<a id="line-165" name="line-165"></a><span class="cp">#define BX_MAX_ATA_INTERFACES   4</span>
<a id="line-166" name="line-166"></a><span class="cp">#define BX_MAX_ATA_DEVICES      (BX_MAX_ATA_INTERFACES*2)</span>
<a id="line-167" name="line-167"></a>
<a id="line-168" name="line-168"></a><span class="cp">#define BX_VIRTUAL_PORTS 1 </span><span class="cm">/* normal output to Bochs ports */</span>
<a id="line-169" name="line-169"></a><span class="cp">#define BX_DEBUG_SERIAL  0 </span><span class="cm">/* output to COM1 */</span>
<a id="line-170" name="line-170"></a>
<a id="line-171" name="line-171"></a><span class="w">   </span><span class="cm">/* model byte 0xFC = AT */</span>
<a id="line-172" name="line-172"></a><span class="cp">#define SYS_MODEL_ID     0xFC</span>
<a id="line-173" name="line-173"></a><span class="cp">#define SYS_SUBMODEL_ID  0x00</span>
<a id="line-174" name="line-174"></a><span class="cp">#define BIOS_REVISION    1</span>
<a id="line-175" name="line-175"></a><span class="cp">#define BIOS_CONFIG_TABLE 0xe6f5</span>
<a id="line-176" name="line-176"></a>
<a id="line-177" name="line-177"></a><span class="cp">#ifndef BIOS_BUILD_DATE</span>
<a id="line-178" name="line-178"></a><span class="cp">#  define BIOS_BUILD_DATE &quot;06/23/99&quot;</span>
<a id="line-179" name="line-179"></a><span class="cp">#endif</span>
<a id="line-180" name="line-180"></a>
<a id="line-181" name="line-181"></a><span class="cp">#define E820_SEG (Bit16u)(E820_PHYSICAL_ADDRESS &gt;&gt; 4)</span>
<a id="line-182" name="line-182"></a>
<a id="line-183" name="line-183"></a><span class="w">  </span><span class="c1">// 1K of base memory used for Extended Bios Data Area (EBDA)</span>
<a id="line-184" name="line-184"></a><span class="w">  </span><span class="c1">// EBDA is used for PS/2 mouse support, and IDE BIOS, etc.</span>
<a id="line-185" name="line-185"></a><span class="cp">#define EBDA_SEG           0x9FC0</span>
<a id="line-186" name="line-186"></a><span class="cp">#define EBDA_SIZE          1              </span><span class="c1">// In KiB</span>
<a id="line-187" name="line-187"></a><span class="cp">#define BASE_MEM_IN_K   (640 - EBDA_SIZE)</span>
<a id="line-188" name="line-188"></a>
<a id="line-189" name="line-189"></a><span class="cm">/* 256 bytes at 0x9ff00 -- 0x9ffff is used for the IPL boot table. */</span>
<a id="line-190" name="line-190"></a><span class="cp">#define IPL_TABLE_OFFSET     0x0300  </span><span class="cm">/* offset from EBDA */</span>
<a id="line-191" name="line-191"></a><span class="cp">#define IPL_TABLE_ENTRIES    8</span>
<a id="line-192" name="line-192"></a><span class="cp">#define IPL_COUNT_OFFSET     0x0380  </span><span class="cm">/* u16: number of valid table entries */</span>
<a id="line-193" name="line-193"></a><span class="cp">#define IPL_SEQUENCE_OFFSET  0x0382  </span><span class="cm">/* u16: next boot device */</span>
<a id="line-194" name="line-194"></a><span class="cp">#define IPL_BOOTFIRST_OFFSET 0x0384  </span><span class="cm">/* u16: user selected device */</span>
<a id="line-195" name="line-195"></a><span class="cp">#define IPL_SIZE             0xff</span>
<a id="line-196" name="line-196"></a><span class="cp">#define IPL_TYPE_FLOPPY      0x01</span>
<a id="line-197" name="line-197"></a><span class="cp">#define IPL_TYPE_HARDDISK    0x02</span>
<a id="line-198" name="line-198"></a><span class="cp">#define IPL_TYPE_CDROM       0x03</span>
<a id="line-199" name="line-199"></a><span class="cp">#define IPL_TYPE_BEV         0x80</span>
<a id="line-200" name="line-200"></a>
<a id="line-201" name="line-201"></a>
<a id="line-202" name="line-202"></a><span class="w">  </span><span class="c1">// Sanity Checks</span>
<a id="line-203" name="line-203"></a><span class="cp">#if BX_USE_ATADRV &amp;&amp; BX_CPU&lt;3</span>
<a id="line-204" name="line-204"></a><span class="cp">#    error The ATA/ATAPI Driver can only to be used with a 386+ cpu</span>
<a id="line-205" name="line-205"></a><span class="cp">#endif</span>
<a id="line-206" name="line-206"></a><span class="cp">#if BX_USE_ATADRV &amp;&amp; !BX_USE_EBDA</span>
<a id="line-207" name="line-207"></a><span class="cp">#    error ATA/ATAPI Driver can only be used if EBDA is available</span>
<a id="line-208" name="line-208"></a><span class="cp">#endif</span>
<a id="line-209" name="line-209"></a><span class="cp">#if BX_ELTORITO_BOOT &amp;&amp; !BX_USE_ATADRV</span>
<a id="line-210" name="line-210"></a><span class="cp">#    error El-Torito Boot can only be use if ATA/ATAPI Driver is available</span>
<a id="line-211" name="line-211"></a><span class="cp">#endif</span>
<a id="line-212" name="line-212"></a><span class="cp">#if BX_PCIBIOS &amp;&amp; BX_CPU&lt;3</span>
<a id="line-213" name="line-213"></a><span class="cp">#    error PCI BIOS can only be used with 386+ cpu</span>
<a id="line-214" name="line-214"></a><span class="cp">#endif</span>
<a id="line-215" name="line-215"></a><span class="cp">#if BX_APM &amp;&amp; BX_CPU&lt;3</span>
<a id="line-216" name="line-216"></a><span class="cp">#    error APM BIOS can only be used with 386+ cpu</span>
<a id="line-217" name="line-217"></a><span class="cp">#endif</span>
<a id="line-218" name="line-218"></a>
<a id="line-219" name="line-219"></a><span class="c1">// define this if you want to make PCIBIOS working on a specific bridge only</span>
<a id="line-220" name="line-220"></a><span class="c1">// undef enables PCIBIOS when at least one PCI device is found</span>
<a id="line-221" name="line-221"></a><span class="c1">// i440FX is emulated by Bochs and QEMU</span>
<a id="line-222" name="line-222"></a><span class="cp">#define PCI_FIXED_HOST_BRIDGE 0x12378086 ;; i440FX PCI bridge</span>
<a id="line-223" name="line-223"></a>
<a id="line-224" name="line-224"></a><span class="c1">// #20  is dec 20</span>
<a id="line-225" name="line-225"></a><span class="c1">// #$20 is hex 20 = 32</span>
<a id="line-226" name="line-226"></a><span class="c1">// #0x20 is hex 20 = 32</span>
<a id="line-227" name="line-227"></a><span class="c1">// LDA  #$20</span>
<a id="line-228" name="line-228"></a><span class="c1">// JSR  $E820</span>
<a id="line-229" name="line-229"></a><span class="c1">// LDD  .i,S</span>
<a id="line-230" name="line-230"></a><span class="c1">// JSR  $C682</span>
<a id="line-231" name="line-231"></a><span class="c1">// mov al, #$20</span>
<a id="line-232" name="line-232"></a>
<a id="line-233" name="line-233"></a><span class="c1">// all hex literals should be prefixed with &#39;0x&#39;</span>
<a id="line-234" name="line-234"></a><span class="c1">//   grep &quot;#[0-9a-fA-F][0-9a-fA-F]&quot; rombios.c</span>
<a id="line-235" name="line-235"></a><span class="c1">// no mov SEG-REG, #value, must mov register into seg-reg</span>
<a id="line-236" name="line-236"></a><span class="c1">//   grep -i &quot;mov[ ]*.s&quot; rombios.c</span>
<a id="line-237" name="line-237"></a>
<a id="line-238" name="line-238"></a><span class="c1">// This is for compiling with gcc2 and gcc3</span>
<a id="line-239" name="line-239"></a><span class="cp">#define ASM_START #asm</span>
<a id="line-240" name="line-240"></a><span class="cp">#define ASM_END #endasm</span>
<a id="line-241" name="line-241"></a>
<a id="line-242" name="line-242"></a><span class="n">ASM_START</span>
<a id="line-243" name="line-243"></a><span class="p">.</span><span class="n">rom</span>
<a id="line-244" name="line-244"></a>
<a id="line-245" name="line-245"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0x0000</span>
<a id="line-246" name="line-246"></a>
<a id="line-247" name="line-247"></a><span class="cp">#if BX_CPU &gt;= 3</span>
<a id="line-248" name="line-248"></a><span class="n">use16</span><span class="w"> </span><span class="mi">386</span>
<a id="line-249" name="line-249"></a><span class="cp">#else</span>
<a id="line-250" name="line-250"></a><span class="n">use16</span><span class="w"> </span><span class="mi">286</span>
<a id="line-251" name="line-251"></a><span class="cp">#endif</span>
<a id="line-252" name="line-252"></a>
<a id="line-253" name="line-253"></a><span class="n">MACRO</span><span class="w"> </span><span class="n">HALT</span>
<a id="line-254" name="line-254"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">HALT</span><span class="w"> </span><span class="n">macro</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">HALT</span><span class="w"> </span><span class="n">call</span><span class="p">.</span>
<a id="line-255" name="line-255"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">PANIC_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">causing</span><span class="w"> </span><span class="n">Bochs</span><span class="o">/</span><span class="n">Plex</span>
<a id="line-256" name="line-256"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">print</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">BX_PANIC</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="w">  </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">normally</span><span class="w"> </span><span class="n">halt</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">simulation</span>
<a id="line-257" name="line-257"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="s">&quot;BIOS panic at rombios.c, line 4091&quot;</span><span class="p">.</span>
<a id="line-258" name="line-258"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">choose</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">panics</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">fatal</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">continue</span><span class="p">.</span>
<a id="line-259" name="line-259"></a><span class="cp">#if BX_VIRTUAL_PORTS</span>
<a id="line-260" name="line-260"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="n">PANIC_PORT</span>
<a id="line-261" name="line-261"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="err">#</span><span class="o">?</span><span class="mi">1</span>
<a id="line-262" name="line-262"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="n">ax</span>
<a id="line-263" name="line-263"></a><span class="cp">#else</span>
<a id="line-264" name="line-264"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x80</span>
<a id="line-265" name="line-265"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="err">#</span><span class="o">?</span><span class="mi">1</span>
<a id="line-266" name="line-266"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-267" name="line-267"></a><span class="cp">#endif</span>
<a id="line-268" name="line-268"></a><span class="n">MEND</span>
<a id="line-269" name="line-269"></a>
<a id="line-270" name="line-270"></a><span class="n">MACRO</span><span class="w"> </span><span class="n">JMP_AP</span>
<a id="line-271" name="line-271"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0xea</span>
<a id="line-272" name="line-272"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="o">?</span><span class="mi">2</span>
<a id="line-273" name="line-273"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="o">?</span><span class="mi">1</span>
<a id="line-274" name="line-274"></a><span class="n">MEND</span>
<a id="line-275" name="line-275"></a>
<a id="line-276" name="line-276"></a><span class="n">MACRO</span><span class="w"> </span><span class="n">SET_INT_VECTOR</span>
<a id="line-277" name="line-277"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="mi">3</span>
<a id="line-278" name="line-278"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="o">?</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-279" name="line-279"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="mi">2</span>
<a id="line-280" name="line-280"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="o">?</span><span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-281" name="line-281"></a><span class="n">MEND</span>
<a id="line-282" name="line-282"></a>
<a id="line-283" name="line-283"></a><span class="n">ASM_END</span>
<a id="line-284" name="line-284"></a>
<a id="line-285" name="line-285"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w">  </span><span class="n">Bit8u</span><span class="p">;</span>
<a id="line-286" name="line-286"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">Bit16u</span><span class="p">;</span>
<a id="line-287" name="line-287"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">bx_bool</span><span class="p">;</span>
<a id="line-288" name="line-288"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w">  </span><span class="n">Bit32u</span><span class="p">;</span>
<a id="line-289" name="line-289"></a>
<a id="line-290" name="line-290"></a>
<a id="line-291" name="line-291"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">memsetb</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
<a id="line-292" name="line-292"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">memcpyb</span><span class="p">(</span><span class="n">dseg</span><span class="p">,</span><span class="n">doffset</span><span class="p">,</span><span class="n">sseg</span><span class="p">,</span><span class="n">soffset</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
<a id="line-293" name="line-293"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">memcpyd</span><span class="p">(</span><span class="n">dseg</span><span class="p">,</span><span class="n">doffset</span><span class="p">,</span><span class="n">sseg</span><span class="p">,</span><span class="n">soffset</span><span class="p">,</span><span class="n">count</span><span class="p">);</span>
<a id="line-294" name="line-294"></a>
<a id="line-295" name="line-295"></a><span class="w">  </span><span class="c1">// memset of count bytes</span>
<a id="line-296" name="line-296"></a><span class="w">    </span><span class="kt">void</span>
<a id="line-297" name="line-297"></a><span class="w">  </span><span class="nf">memsetb</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
<a id="line-298" name="line-298"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-299" name="line-299"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-300" name="line-300"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<a id="line-301" name="line-301"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-302" name="line-302"></a><span class="w">  </span><span class="p">{</span>
<a id="line-303" name="line-303"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-304" name="line-304"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-305" name="line-305"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-306" name="line-306"></a>
<a id="line-307" name="line-307"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-308" name="line-308"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-309" name="line-309"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-310" name="line-310"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">di</span>
<a id="line-311" name="line-311"></a>
<a id="line-312" name="line-312"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">count</span>
<a id="line-313" name="line-313"></a><span class="w">      </span><span class="n">test</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-314" name="line-314"></a><span class="w">      </span><span class="n">je</span><span class="w">   </span><span class="n">memsetb_end</span>
<a id="line-315" name="line-315"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-316" name="line-316"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-317" name="line-317"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-318" name="line-318"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-319" name="line-319"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">value</span>
<a id="line-320" name="line-320"></a><span class="w">      </span><span class="n">cld</span>
<a id="line-321" name="line-321"></a><span class="w">      </span><span class="n">rep</span>
<a id="line-322" name="line-322"></a><span class="w">       </span><span class="n">stosb</span>
<a id="line-323" name="line-323"></a>
<a id="line-324" name="line-324"></a><span class="w">  </span><span class="nl">memsetb_end</span><span class="p">:</span>
<a id="line-325" name="line-325"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">di</span>
<a id="line-326" name="line-326"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-327" name="line-327"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">cx</span>
<a id="line-328" name="line-328"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-329" name="line-329"></a>
<a id="line-330" name="line-330"></a><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">bp</span>
<a id="line-331" name="line-331"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-332" name="line-332"></a><span class="w">  </span><span class="p">}</span>
<a id="line-333" name="line-333"></a>
<a id="line-334" name="line-334"></a><span class="w">  </span><span class="c1">// memcpy of count bytes</span>
<a id="line-335" name="line-335"></a><span class="w">    </span><span class="kt">void</span>
<a id="line-336" name="line-336"></a><span class="w">  </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">dseg</span><span class="p">,</span><span class="n">doffset</span><span class="p">,</span><span class="n">sseg</span><span class="p">,</span><span class="n">soffset</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
<a id="line-337" name="line-337"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">dseg</span><span class="p">;</span>
<a id="line-338" name="line-338"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">doffset</span><span class="p">;</span>
<a id="line-339" name="line-339"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">sseg</span><span class="p">;</span>
<a id="line-340" name="line-340"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">soffset</span><span class="p">;</span>
<a id="line-341" name="line-341"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-342" name="line-342"></a><span class="w">  </span><span class="p">{</span>
<a id="line-343" name="line-343"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-344" name="line-344"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-345" name="line-345"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-346" name="line-346"></a>
<a id="line-347" name="line-347"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-348" name="line-348"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-349" name="line-349"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-350" name="line-350"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">di</span>
<a id="line-351" name="line-351"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-352" name="line-352"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">si</span>
<a id="line-353" name="line-353"></a>
<a id="line-354" name="line-354"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">count</span>
<a id="line-355" name="line-355"></a><span class="w">      </span><span class="n">test</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-356" name="line-356"></a><span class="w">      </span><span class="n">je</span><span class="w">   </span><span class="n">memcpyb_end</span>
<a id="line-357" name="line-357"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">dsegment</span>
<a id="line-358" name="line-358"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-359" name="line-359"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">doffset</span>
<a id="line-360" name="line-360"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-361" name="line-361"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ssegment</span>
<a id="line-362" name="line-362"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-363" name="line-363"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">soffset</span>
<a id="line-364" name="line-364"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-365" name="line-365"></a><span class="w">      </span><span class="n">cld</span>
<a id="line-366" name="line-366"></a><span class="w">      </span><span class="n">rep</span>
<a id="line-367" name="line-367"></a><span class="w">       </span><span class="n">movsb</span>
<a id="line-368" name="line-368"></a>
<a id="line-369" name="line-369"></a><span class="w">  </span><span class="nl">memcpyb_end</span><span class="p">:</span>
<a id="line-370" name="line-370"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">si</span>
<a id="line-371" name="line-371"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-372" name="line-372"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">di</span>
<a id="line-373" name="line-373"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-374" name="line-374"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">cx</span>
<a id="line-375" name="line-375"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-376" name="line-376"></a>
<a id="line-377" name="line-377"></a><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">bp</span>
<a id="line-378" name="line-378"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-379" name="line-379"></a><span class="w">  </span><span class="p">}</span>
<a id="line-380" name="line-380"></a>
<a id="line-381" name="line-381"></a><span class="w">  </span><span class="c1">// memcpy of count dword</span>
<a id="line-382" name="line-382"></a><span class="w">    </span><span class="kt">void</span>
<a id="line-383" name="line-383"></a><span class="w">  </span><span class="n">memcpyd</span><span class="p">(</span><span class="n">dseg</span><span class="p">,</span><span class="n">doffset</span><span class="p">,</span><span class="n">sseg</span><span class="p">,</span><span class="n">soffset</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
<a id="line-384" name="line-384"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">dseg</span><span class="p">;</span>
<a id="line-385" name="line-385"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">doffset</span><span class="p">;</span>
<a id="line-386" name="line-386"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">sseg</span><span class="p">;</span>
<a id="line-387" name="line-387"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">soffset</span><span class="p">;</span>
<a id="line-388" name="line-388"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-389" name="line-389"></a><span class="w">  </span><span class="p">{</span>
<a id="line-390" name="line-390"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-391" name="line-391"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-392" name="line-392"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-393" name="line-393"></a>
<a id="line-394" name="line-394"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-395" name="line-395"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-396" name="line-396"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-397" name="line-397"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">di</span>
<a id="line-398" name="line-398"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-399" name="line-399"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">si</span>
<a id="line-400" name="line-400"></a>
<a id="line-401" name="line-401"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">count</span>
<a id="line-402" name="line-402"></a><span class="w">      </span><span class="n">test</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-403" name="line-403"></a><span class="w">      </span><span class="n">je</span><span class="w">   </span><span class="n">memcpyd_end</span>
<a id="line-404" name="line-404"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">dsegment</span>
<a id="line-405" name="line-405"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-406" name="line-406"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">doffset</span>
<a id="line-407" name="line-407"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-408" name="line-408"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ssegment</span>
<a id="line-409" name="line-409"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-410" name="line-410"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">soffset</span>
<a id="line-411" name="line-411"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-412" name="line-412"></a><span class="w">      </span><span class="n">cld</span>
<a id="line-413" name="line-413"></a><span class="w">      </span><span class="n">rep</span>
<a id="line-414" name="line-414"></a><span class="w">       </span><span class="n">movsd</span>
<a id="line-415" name="line-415"></a>
<a id="line-416" name="line-416"></a><span class="w">  </span><span class="nl">memcpyd_end</span><span class="p">:</span>
<a id="line-417" name="line-417"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">si</span>
<a id="line-418" name="line-418"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-419" name="line-419"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">di</span>
<a id="line-420" name="line-420"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-421" name="line-421"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">cx</span>
<a id="line-422" name="line-422"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-423" name="line-423"></a>
<a id="line-424" name="line-424"></a><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">bp</span>
<a id="line-425" name="line-425"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-426" name="line-426"></a><span class="w">  </span><span class="p">}</span>
<a id="line-427" name="line-427"></a>
<a id="line-428" name="line-428"></a><span class="w">  </span><span class="c1">// read_dword and write_dword functions</span>
<a id="line-429" name="line-429"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">Bit32u</span><span class="w">         </span><span class="n">read_dword</span><span class="p">();</span>
<a id="line-430" name="line-430"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">write_dword</span><span class="p">();</span>
<a id="line-431" name="line-431"></a>
<a id="line-432" name="line-432"></a><span class="w">    </span><span class="n">Bit32u</span>
<a id="line-433" name="line-433"></a><span class="w">  </span><span class="nf">read_dword</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-434" name="line-434"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-435" name="line-435"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-436" name="line-436"></a><span class="w">  </span><span class="p">{</span>
<a id="line-437" name="line-437"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-438" name="line-438"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-439" name="line-439"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-440" name="line-440"></a>
<a id="line-441" name="line-441"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-442" name="line-442"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-443" name="line-443"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-444" name="line-444"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-445" name="line-445"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-446" name="line-446"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-447" name="line-447"></a><span class="w">      </span><span class="n">add</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-448" name="line-448"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-449" name="line-449"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="line-450" name="line-450"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="line-451" name="line-451"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-452" name="line-452"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-453" name="line-453"></a>
<a id="line-454" name="line-454"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-455" name="line-455"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-456" name="line-456"></a><span class="w">  </span><span class="p">}</span>
<a id="line-457" name="line-457"></a>
<a id="line-458" name="line-458"></a><span class="w">    </span><span class="kt">void</span>
<a id="line-459" name="line-459"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<a id="line-460" name="line-460"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-461" name="line-461"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-462" name="line-462"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="line-463" name="line-463"></a><span class="w">  </span><span class="p">{</span>
<a id="line-464" name="line-464"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-465" name="line-465"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-466" name="line-466"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-467" name="line-467"></a>
<a id="line-468" name="line-468"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-469" name="line-469"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-470" name="line-470"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-471" name="line-471"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-472" name="line-472"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-473" name="line-473"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-474" name="line-474"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-475" name="line-475"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-476" name="line-476"></a><span class="w">      </span><span class="n">add</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-477" name="line-477"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-478" name="line-478"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-479" name="line-479"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-480" name="line-480"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-481" name="line-481"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-482" name="line-482"></a>
<a id="line-483" name="line-483"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-484" name="line-484"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-485" name="line-485"></a><span class="w">  </span><span class="p">}</span>
<a id="line-486" name="line-486"></a>
<a id="line-487" name="line-487"></a><span class="w">  </span><span class="c1">// Bit32u (unsigned long) and long helper functions</span>
<a id="line-488" name="line-488"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-489" name="line-489"></a>
<a id="line-490" name="line-490"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">function</span>
<a id="line-491" name="line-491"></a><span class="w">  </span><span class="nl">landl</span><span class="p">:</span>
<a id="line-492" name="line-492"></a><span class="w">  </span><span class="nl">landul</span><span class="p">:</span>
<a id="line-493" name="line-493"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-494" name="line-494"></a><span class="w">      </span><span class="n">and</span><span class="w"> </span><span class="n">ax</span><span class="p">,[</span><span class="n">di</span><span class="p">]</span>
<a id="line-495" name="line-495"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-496" name="line-496"></a><span class="w">      </span><span class="n">and</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="mi">2</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-497" name="line-497"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-498" name="line-498"></a>
<a id="line-499" name="line-499"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">function</span>
<a id="line-500" name="line-500"></a><span class="w">  </span><span class="nl">laddl</span><span class="p">:</span>
<a id="line-501" name="line-501"></a><span class="w">  </span><span class="nl">laddul</span><span class="p">:</span>
<a id="line-502" name="line-502"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-503" name="line-503"></a><span class="w">      </span><span class="n">add</span><span class="w"> </span><span class="n">ax</span><span class="p">,[</span><span class="n">di</span><span class="p">]</span>
<a id="line-504" name="line-504"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-505" name="line-505"></a><span class="w">      </span><span class="n">adc</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="mi">2</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-506" name="line-506"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-507" name="line-507"></a>
<a id="line-508" name="line-508"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="n">function</span>
<a id="line-509" name="line-509"></a><span class="w">  </span><span class="nl">lcmpl</span><span class="p">:</span>
<a id="line-510" name="line-510"></a><span class="w">  </span><span class="nl">lcmpul</span><span class="p">:</span>
<a id="line-511" name="line-511"></a><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-512" name="line-512"></a><span class="w">    </span><span class="n">shl</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-513" name="line-513"></a><span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-514" name="line-514"></a><span class="w">    </span><span class="n">shr</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-515" name="line-515"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-516" name="line-516"></a><span class="w">      </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-517" name="line-517"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-518" name="line-518"></a>
<a id="line-519" name="line-519"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="n">function</span>
<a id="line-520" name="line-520"></a><span class="w">  </span><span class="nl">lsubl</span><span class="p">:</span>
<a id="line-521" name="line-521"></a><span class="w">  </span><span class="nl">lsubul</span><span class="p">:</span>
<a id="line-522" name="line-522"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-523" name="line-523"></a><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">ax</span><span class="p">,[</span><span class="n">di</span><span class="p">]</span>
<a id="line-524" name="line-524"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-525" name="line-525"></a><span class="w">    </span><span class="n">sbb</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="mi">2</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-526" name="line-526"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-527" name="line-527"></a>
<a id="line-528" name="line-528"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">mul</span><span class="w"> </span><span class="n">function</span>
<a id="line-529" name="line-529"></a><span class="w">  </span><span class="nl">lmull</span><span class="p">:</span>
<a id="line-530" name="line-530"></a><span class="w">  </span><span class="nl">lmulul</span><span class="p">:</span>
<a id="line-531" name="line-531"></a><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-532" name="line-532"></a><span class="w">    </span><span class="n">shl</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-533" name="line-533"></a><span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-534" name="line-534"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-535" name="line-535"></a><span class="w">    </span><span class="n">mul</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-536" name="line-536"></a><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-537" name="line-537"></a><span class="w">    </span><span class="n">shr</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-538" name="line-538"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-539" name="line-539"></a>
<a id="line-540" name="line-540"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">dec</span><span class="w"> </span><span class="n">function</span>
<a id="line-541" name="line-541"></a><span class="w">  </span><span class="nl">ldecl</span><span class="p">:</span>
<a id="line-542" name="line-542"></a><span class="w">  </span><span class="nl">ldecul</span><span class="p">:</span>
<a id="line-543" name="line-543"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-544" name="line-544"></a><span class="w">    </span><span class="n">dec</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-545" name="line-545"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-546" name="line-546"></a>
<a id="line-547" name="line-547"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">function</span>
<a id="line-548" name="line-548"></a><span class="w">  </span><span class="nl">lorl</span><span class="p">:</span>
<a id="line-549" name="line-549"></a><span class="w">  </span><span class="nl">lorul</span><span class="p">:</span>
<a id="line-550" name="line-550"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-551" name="line-551"></a><span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">ax</span><span class="p">,[</span><span class="n">di</span><span class="p">]</span>
<a id="line-552" name="line-552"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-553" name="line-553"></a><span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="mi">2</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-554" name="line-554"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-555" name="line-555"></a>
<a id="line-556" name="line-556"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">inc</span><span class="w"> </span><span class="n">function</span>
<a id="line-557" name="line-557"></a><span class="w">  </span><span class="nl">lincl</span><span class="p">:</span>
<a id="line-558" name="line-558"></a><span class="w">  </span><span class="nl">lincul</span><span class="p">:</span>
<a id="line-559" name="line-559"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-560" name="line-560"></a><span class="w">    </span><span class="n">inc</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-561" name="line-561"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-562" name="line-562"></a>
<a id="line-563" name="line-563"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">tst</span><span class="w"> </span><span class="n">function</span>
<a id="line-564" name="line-564"></a><span class="w">  </span><span class="nl">ltstl</span><span class="p">:</span>
<a id="line-565" name="line-565"></a><span class="w">  </span><span class="nl">ltstul</span><span class="p">:</span>
<a id="line-566" name="line-566"></a><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-567" name="line-567"></a><span class="w">    </span><span class="n">shl</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-568" name="line-568"></a><span class="w">    </span><span class="n">or</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-569" name="line-569"></a><span class="w">    </span><span class="n">shr</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-570" name="line-570"></a><span class="w">    </span><span class="n">test</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-571" name="line-571"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-572" name="line-572"></a>
<a id="line-573" name="line-573"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">sr</span><span class="w"> </span><span class="n">function</span>
<a id="line-574" name="line-574"></a><span class="w">  </span><span class="nl">lsrul</span><span class="p">:</span>
<a id="line-575" name="line-575"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="n">di</span>
<a id="line-576" name="line-576"></a><span class="w">    </span><span class="n">jcxz</span><span class="w"> </span><span class="n">lsr_exit</span>
<a id="line-577" name="line-577"></a><span class="w">    </span><span class="n">and</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-578" name="line-578"></a><span class="w">    </span><span class="n">shl</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-579" name="line-579"></a><span class="w">    </span><span class="n">or</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-580" name="line-580"></a><span class="w">  </span><span class="nl">lsr_loop</span><span class="p">:</span>
<a id="line-581" name="line-581"></a><span class="w">    </span><span class="n">shr</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-582" name="line-582"></a><span class="w">    </span><span class="n">loop</span><span class="w"> </span><span class="n">lsr_loop</span>
<a id="line-583" name="line-583"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-584" name="line-584"></a><span class="w">    </span><span class="n">shr</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-585" name="line-585"></a><span class="w">  </span><span class="nl">lsr_exit</span><span class="p">:</span>
<a id="line-586" name="line-586"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-587" name="line-587"></a>
<a id="line-588" name="line-588"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">sl</span><span class="w"> </span><span class="n">function</span>
<a id="line-589" name="line-589"></a><span class="w">  </span><span class="nl">lsll</span><span class="p">:</span>
<a id="line-590" name="line-590"></a><span class="w">  </span><span class="nl">lslul</span><span class="p">:</span>
<a id="line-591" name="line-591"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="n">di</span>
<a id="line-592" name="line-592"></a><span class="w">    </span><span class="n">jcxz</span><span class="w"> </span><span class="n">lsl_exit</span>
<a id="line-593" name="line-593"></a><span class="w">    </span><span class="n">and</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-594" name="line-594"></a><span class="w">    </span><span class="n">shl</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-595" name="line-595"></a><span class="w">    </span><span class="n">or</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-596" name="line-596"></a><span class="w">  </span><span class="nl">lsl_loop</span><span class="p">:</span>
<a id="line-597" name="line-597"></a><span class="w">    </span><span class="n">shl</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-598" name="line-598"></a><span class="w">    </span><span class="n">loop</span><span class="w"> </span><span class="n">lsl_loop</span>
<a id="line-599" name="line-599"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-600" name="line-600"></a><span class="w">    </span><span class="n">shr</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-601" name="line-601"></a><span class="w">  </span><span class="nl">lsl_exit</span><span class="p">:</span>
<a id="line-602" name="line-602"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-603" name="line-603"></a>
<a id="line-604" name="line-604"></a><span class="w">  </span><span class="nl">idiv_</span><span class="p">:</span>
<a id="line-605" name="line-605"></a><span class="w">    </span><span class="n">cwd</span>
<a id="line-606" name="line-606"></a><span class="w">    </span><span class="n">idiv</span><span class="w"> </span><span class="n">bx</span>
<a id="line-607" name="line-607"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-608" name="line-608"></a>
<a id="line-609" name="line-609"></a><span class="w">  </span><span class="nl">idiv_u</span><span class="p">:</span>
<a id="line-610" name="line-610"></a><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span>
<a id="line-611" name="line-611"></a><span class="w">    </span><span class="n">div</span><span class="w"> </span><span class="n">bx</span>
<a id="line-612" name="line-612"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-613" name="line-613"></a>
<a id="line-614" name="line-614"></a><span class="w">  </span><span class="nl">ldivul</span><span class="p">:</span>
<a id="line-615" name="line-615"></a><span class="w">    </span><span class="n">and</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000FFFF</span>
<a id="line-616" name="line-616"></a><span class="w">    </span><span class="n">shl</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-617" name="line-617"></a><span class="w">    </span><span class="n">or</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-618" name="line-618"></a><span class="w">    </span><span class="n">xor</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-619" name="line-619"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-620" name="line-620"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w">  </span><span class="mi">2</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-621" name="line-621"></a><span class="w">    </span><span class="n">shl</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-622" name="line-622"></a><span class="w">    </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-623" name="line-623"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
<a id="line-624" name="line-624"></a><span class="w">    </span><span class="n">div</span><span class="w">  </span><span class="n">ebx</span>
<a id="line-625" name="line-625"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-626" name="line-626"></a><span class="w">    </span><span class="n">shr</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-627" name="line-627"></a><span class="w">    </span><span class="n">ret</span>
<a id="line-628" name="line-628"></a>
<a id="line-629" name="line-629"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-630" name="line-630"></a>
<a id="line-631" name="line-631"></a><span class="c1">// for access to RAM area which is used by interrupt vectors</span>
<a id="line-632" name="line-632"></a><span class="c1">// and BIOS Data Area</span>
<a id="line-633" name="line-633"></a>
<a id="line-634" name="line-634"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-635" name="line-635"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">filler1</span><span class="p">[</span><span class="mh">0x400</span><span class="p">];</span>
<a id="line-636" name="line-636"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">filler2</span><span class="p">[</span><span class="mh">0x6c</span><span class="p">];</span>
<a id="line-637" name="line-637"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ticks_low</span><span class="p">;</span>
<a id="line-638" name="line-638"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ticks_high</span><span class="p">;</span>
<a id="line-639" name="line-639"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">midnight_flag</span><span class="p">;</span>
<a id="line-640" name="line-640"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">bios_data_t</span><span class="p">;</span>
<a id="line-641" name="line-641"></a>
<a id="line-642" name="line-642"></a><span class="cp">#define BiosData ((bios_data_t  *) 0)</span>
<a id="line-643" name="line-643"></a>
<a id="line-644" name="line-644"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-645" name="line-645"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-646" name="line-646"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">heads</span><span class="p">;</span><span class="w">      </span><span class="c1">// # heads</span>
<a id="line-647" name="line-647"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cylinders</span><span class="p">;</span><span class="w">  </span><span class="c1">// # cylinders</span>
<a id="line-648" name="line-648"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">spt</span><span class="p">;</span><span class="w">        </span><span class="c1">// # sectors / track</span>
<a id="line-649" name="line-649"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">chs_t</span><span class="p">;</span>
<a id="line-650" name="line-650"></a>
<a id="line-651" name="line-651"></a><span class="w">  </span><span class="c1">// DPTE definition</span>
<a id="line-652" name="line-652"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-653" name="line-653"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">;</span>
<a id="line-654" name="line-654"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase2</span><span class="p">;</span>
<a id="line-655" name="line-655"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">prefix</span><span class="p">;</span>
<a id="line-656" name="line-656"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">unused</span><span class="p">;</span>
<a id="line-657" name="line-657"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">irq</span><span class="p">;</span>
<a id="line-658" name="line-658"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">blkcount</span><span class="p">;</span>
<a id="line-659" name="line-659"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">dma</span><span class="p">;</span>
<a id="line-660" name="line-660"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">pio</span><span class="p">;</span>
<a id="line-661" name="line-661"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>
<a id="line-662" name="line-662"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span>
<a id="line-663" name="line-663"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">revision</span><span class="p">;</span>
<a id="line-664" name="line-664"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">checksum</span><span class="p">;</span>
<a id="line-665" name="line-665"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">dpte_t</span><span class="p">;</span>
<a id="line-666" name="line-666"></a>
<a id="line-667" name="line-667"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-668" name="line-668"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">iface</span><span class="p">;</span><span class="w">        </span><span class="c1">// ISA or PCI</span>
<a id="line-669" name="line-669"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">;</span><span class="w">      </span><span class="c1">// IO Base 1</span>
<a id="line-670" name="line-670"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase2</span><span class="p">;</span><span class="w">      </span><span class="c1">// IO Base 2</span>
<a id="line-671" name="line-671"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">irq</span><span class="p">;</span><span class="w">          </span><span class="c1">// IRQ</span>
<a id="line-672" name="line-672"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">ata_channel_t</span><span class="p">;</span>
<a id="line-673" name="line-673"></a>
<a id="line-674" name="line-674"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-675" name="line-675"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">type</span><span class="p">;</span><span class="w">         </span><span class="c1">// Detected type of ata (ata/atapi/none/unknown)</span>
<a id="line-676" name="line-676"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">device</span><span class="p">;</span><span class="w">       </span><span class="c1">// Detected type of attached devices (hd/cd/none)</span>
<a id="line-677" name="line-677"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">removable</span><span class="p">;</span><span class="w">    </span><span class="c1">// Removable device flag</span>
<a id="line-678" name="line-678"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">lock</span><span class="p">;</span><span class="w">         </span><span class="c1">// Locks for removable devices</span>
<a id="line-679" name="line-679"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">mode</span><span class="p">;</span><span class="w">         </span><span class="c1">// transfer mode : PIO 16/32 bits - IRQ - ISADMA - PCIDMA</span>
<a id="line-680" name="line-680"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span><span class="w">      </span><span class="c1">// block size</span>
<a id="line-681" name="line-681"></a>
<a id="line-682" name="line-682"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">translation</span><span class="p">;</span><span class="w">  </span><span class="c1">// type of translation</span>
<a id="line-683" name="line-683"></a><span class="w">    </span><span class="n">chs_t</span><span class="w">  </span><span class="n">lchs</span><span class="p">;</span><span class="w">         </span><span class="c1">// Logical CHS</span>
<a id="line-684" name="line-684"></a><span class="w">    </span><span class="n">chs_t</span><span class="w">  </span><span class="n">pchs</span><span class="p">;</span><span class="w">         </span><span class="c1">// Physical CHS</span>
<a id="line-685" name="line-685"></a>
<a id="line-686" name="line-686"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">sectors_low</span><span class="p">;</span><span class="w">  </span><span class="c1">// Total sectors count</span>
<a id="line-687" name="line-687"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">sectors_high</span><span class="p">;</span>
<a id="line-688" name="line-688"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">ata_device_t</span><span class="p">;</span>
<a id="line-689" name="line-689"></a>
<a id="line-690" name="line-690"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-691" name="line-691"></a><span class="w">    </span><span class="c1">// ATA channels info</span>
<a id="line-692" name="line-692"></a><span class="w">    </span><span class="n">ata_channel_t</span><span class="w"> </span><span class="n">channels</span><span class="p">[</span><span class="n">BX_MAX_ATA_INTERFACES</span><span class="p">];</span>
<a id="line-693" name="line-693"></a>
<a id="line-694" name="line-694"></a><span class="w">    </span><span class="c1">// ATA devices info</span>
<a id="line-695" name="line-695"></a><span class="w">    </span><span class="n">ata_device_t</span><span class="w">  </span><span class="n">devices</span><span class="p">[</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">];</span>
<a id="line-696" name="line-696"></a><span class="w">    </span><span class="c1">//</span>
<a id="line-697" name="line-697"></a><span class="w">    </span><span class="c1">// map between (bios hd id - 0x80) and ata channels</span>
<a id="line-698" name="line-698"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">hdcount</span><span class="p">,</span><span class="w"> </span><span class="n">hdidmap</span><span class="p">[</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">];</span>
<a id="line-699" name="line-699"></a>
<a id="line-700" name="line-700"></a><span class="w">    </span><span class="c1">// map between (bios cd id - 0xE0) and ata channels</span>
<a id="line-701" name="line-701"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">cdcount</span><span class="p">,</span><span class="w"> </span><span class="n">cdidmap</span><span class="p">[</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">];</span>
<a id="line-702" name="line-702"></a>
<a id="line-703" name="line-703"></a><span class="w">    </span><span class="c1">// Buffer for DPTE table</span>
<a id="line-704" name="line-704"></a><span class="w">    </span><span class="n">dpte_t</span><span class="w"> </span><span class="n">dpte</span><span class="p">;</span>
<a id="line-705" name="line-705"></a>
<a id="line-706" name="line-706"></a><span class="w">    </span><span class="c1">// Count of transferred sectors and bytes</span>
<a id="line-707" name="line-707"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">trsfsectors</span><span class="p">;</span>
<a id="line-708" name="line-708"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">trsfbytes</span><span class="p">;</span>
<a id="line-709" name="line-709"></a>
<a id="line-710" name="line-710"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">ata_t</span><span class="p">;</span>
<a id="line-711" name="line-711"></a>
<a id="line-712" name="line-712"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-713" name="line-713"></a><span class="w">  </span><span class="c1">// ElTorito Device Emulation data</span>
<a id="line-714" name="line-714"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-715" name="line-715"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">active</span><span class="p">;</span>
<a id="line-716" name="line-716"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">media</span><span class="p">;</span>
<a id="line-717" name="line-717"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">emulated_drive</span><span class="p">;</span>
<a id="line-718" name="line-718"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">controller_index</span><span class="p">;</span>
<a id="line-719" name="line-719"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">device_spec</span><span class="p">;</span>
<a id="line-720" name="line-720"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">ilba</span><span class="p">;</span>
<a id="line-721" name="line-721"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">buffer_segment</span><span class="p">;</span>
<a id="line-722" name="line-722"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">load_segment</span><span class="p">;</span>
<a id="line-723" name="line-723"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">sector_count</span><span class="p">;</span>
<a id="line-724" name="line-724"></a>
<a id="line-725" name="line-725"></a><span class="w">    </span><span class="c1">// Virtual device</span>
<a id="line-726" name="line-726"></a><span class="w">    </span><span class="n">chs_t</span><span class="w">  </span><span class="n">vdevice</span><span class="p">;</span>
<a id="line-727" name="line-727"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">cdemu_t</span><span class="p">;</span>
<a id="line-728" name="line-728"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-729" name="line-729"></a>
<a id="line-730" name="line-730"></a><span class="cp">#define X(idx, ret, fn, arg...) ret fn ();</span>
<a id="line-731" name="line-731"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;32bitprotos.h&quot;</span>
<a id="line-732" name="line-732"></a><span class="cp">#undef X</span>
<a id="line-733" name="line-733"></a>
<a id="line-734" name="line-734"></a><span class="w">  </span><span class="c1">// for access to EBDA area</span>
<a id="line-735" name="line-735"></a><span class="w">  </span><span class="c1">//     The EBDA structure should conform to</span>
<a id="line-736" name="line-736"></a><span class="w">  </span><span class="c1">//     http://www.frontiernet.net/~fys/rombios.htm document</span>
<a id="line-737" name="line-737"></a><span class="w">  </span><span class="c1">//     I made the ata and cdemu structs begin at 0x121 in the EBDA seg</span>
<a id="line-738" name="line-738"></a><span class="w">  </span><span class="c1">// EBDA must be at most 768 bytes; it lives at EBDA_SEG, and the boot</span>
<a id="line-739" name="line-739"></a><span class="w">  </span><span class="c1">// device tables are at EBDA_SEG:IPL_TABLE_OFFSET</span>
<a id="line-740" name="line-740"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-741" name="line-741"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">ebda_size</span><span class="p">;</span>
<a id="line-742" name="line-742"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">cmos_shutdown_status</span><span class="p">;</span>
<a id="line-743" name="line-743"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">filler1</span><span class="p">[</span><span class="mh">0x3B</span><span class="p">];</span>
<a id="line-744" name="line-744"></a>
<a id="line-745" name="line-745"></a><span class="w">    </span><span class="c1">// FDPT - Can be splitted in data members if needed</span>
<a id="line-746" name="line-746"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">fdpt0</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
<a id="line-747" name="line-747"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">fdpt1</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
<a id="line-748" name="line-748"></a>
<a id="line-749" name="line-749"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">filler2</span><span class="p">[</span><span class="mh">0xC4</span><span class="p">];</span>
<a id="line-750" name="line-750"></a>
<a id="line-751" name="line-751"></a><span class="w">    </span><span class="c1">// ATA Driver data</span>
<a id="line-752" name="line-752"></a><span class="w">    </span><span class="n">ata_t</span><span class="w">   </span><span class="n">ata</span><span class="p">;</span>
<a id="line-753" name="line-753"></a>
<a id="line-754" name="line-754"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-755" name="line-755"></a><span class="w">    </span><span class="c1">// El Torito Emulation data</span>
<a id="line-756" name="line-756"></a><span class="w">    </span><span class="n">cdemu_t</span><span class="w"> </span><span class="n">cdemu</span><span class="p">;</span>
<a id="line-757" name="line-757"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-758" name="line-758"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">ebda_data_t</span><span class="p">;</span>
<a id="line-759" name="line-759"></a>
<a id="line-760" name="line-760"></a><span class="w">  </span><span class="cp">#define EBDA_CMOS_SHUTDOWN_STATUS_OFFSET 1</span>
<a id="line-761" name="line-761"></a><span class="w">  </span><span class="cp">#define EbdaData ((ebda_data_t *) 0)</span>
<a id="line-762" name="line-762"></a>
<a id="line-763" name="line-763"></a><span class="w">  </span><span class="c1">// for access to the int13ext structure</span>
<a id="line-764" name="line-764"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-765" name="line-765"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">size</span><span class="p">;</span>
<a id="line-766" name="line-766"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">reserved</span><span class="p">;</span>
<a id="line-767" name="line-767"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-768" name="line-768"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-769" name="line-769"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">segment</span><span class="p">;</span>
<a id="line-770" name="line-770"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba1</span><span class="p">;</span>
<a id="line-771" name="line-771"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba2</span><span class="p">;</span>
<a id="line-772" name="line-772"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">int13ext_t</span><span class="p">;</span>
<a id="line-773" name="line-773"></a>
<a id="line-774" name="line-774"></a><span class="w">  </span><span class="cp">#define Int13Ext ((int13ext_t *) 0)</span>
<a id="line-775" name="line-775"></a>
<a id="line-776" name="line-776"></a><span class="w">  </span><span class="c1">// Disk Physical Table definition</span>
<a id="line-777" name="line-777"></a><span class="w">  </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-778" name="line-778"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">size</span><span class="p">;</span>
<a id="line-779" name="line-779"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">infos</span><span class="p">;</span>
<a id="line-780" name="line-780"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">cylinders</span><span class="p">;</span>
<a id="line-781" name="line-781"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">heads</span><span class="p">;</span>
<a id="line-782" name="line-782"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">spt</span><span class="p">;</span>
<a id="line-783" name="line-783"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">sector_count1</span><span class="p">;</span>
<a id="line-784" name="line-784"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">sector_count2</span><span class="p">;</span>
<a id="line-785" name="line-785"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-786" name="line-786"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">dpte_offset</span><span class="p">;</span>
<a id="line-787" name="line-787"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">dpte_segment</span><span class="p">;</span>
<a id="line-788" name="line-788"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">key</span><span class="p">;</span>
<a id="line-789" name="line-789"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">dpi_length</span><span class="p">;</span>
<a id="line-790" name="line-790"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">reserved1</span><span class="p">;</span>
<a id="line-791" name="line-791"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">reserved2</span><span class="p">;</span>
<a id="line-792" name="line-792"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">host_bus</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a id="line-793" name="line-793"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">iface_type</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<a id="line-794" name="line-794"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">iface_path</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<a id="line-795" name="line-795"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">device_path</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<a id="line-796" name="line-796"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">reserved3</span><span class="p">;</span>
<a id="line-797" name="line-797"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">checksum</span><span class="p">;</span>
<a id="line-798" name="line-798"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">dpt_t</span><span class="p">;</span>
<a id="line-799" name="line-799"></a>
<a id="line-800" name="line-800"></a><span class="w">  </span><span class="cp">#define Int13DPT ((dpt_t *) 0)</span>
<a id="line-801" name="line-801"></a>
<a id="line-802" name="line-802"></a><span class="cp">#endif </span><span class="c1">// BX_USE_ATADRV</span>
<a id="line-803" name="line-803"></a>
<a id="line-804" name="line-804"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-805" name="line-805"></a><span class="w">  </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="line-806" name="line-806"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-807" name="line-807"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="line-808" name="line-808"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">;</span>
<a id="line-809" name="line-809"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="n">r16</span><span class="p">;</span>
<a id="line-810" name="line-810"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-811" name="line-811"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">filler</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a id="line-812" name="line-812"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">dh</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span><span class="p">;</span>
<a id="line-813" name="line-813"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="n">r8</span><span class="p">;</span>
<a id="line-814" name="line-814"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="line-815" name="line-815"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">pusha_regs_t</span><span class="p">;</span>
<a id="line-816" name="line-816"></a>
<a id="line-817" name="line-817"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-818" name="line-818"></a><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="line-819" name="line-819"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-820" name="line-820"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="n">ebp</span><span class="p">,</span><span class="w"> </span><span class="n">esp</span><span class="p">;</span>
<a id="line-821" name="line-821"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="p">;</span>
<a id="line-822" name="line-822"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">r32</span><span class="p">;</span>
<a id="line-823" name="line-823"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-824" name="line-824"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">filler1</span><span class="p">,</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">filler2</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">filler3</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">filler4</span><span class="p">;</span>
<a id="line-825" name="line-825"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">filler5</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">filler6</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">filler7</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">filler8</span><span class="p">;</span>
<a id="line-826" name="line-826"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">r16</span><span class="p">;</span>
<a id="line-827" name="line-827"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-828" name="line-828"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">filler</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<a id="line-829" name="line-829"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="p">;</span>
<a id="line-830" name="line-830"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">filler1</span><span class="p">;</span>
<a id="line-831" name="line-831"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">dh</span><span class="p">;</span>
<a id="line-832" name="line-832"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">filler2</span><span class="p">;</span>
<a id="line-833" name="line-833"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<a id="line-834" name="line-834"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">filler3</span><span class="p">;</span>
<a id="line-835" name="line-835"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span><span class="p">;</span>
<a id="line-836" name="line-836"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">filler4</span><span class="p">;</span>
<a id="line-837" name="line-837"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">r8</span><span class="p">;</span>
<a id="line-838" name="line-838"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="line-839" name="line-839"></a><span class="p">}</span><span class="w"> </span><span class="n">pushad_regs_t</span><span class="p">;</span>
<a id="line-840" name="line-840"></a>
<a id="line-841" name="line-841"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-842" name="line-842"></a><span class="w">  </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="line-843" name="line-843"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-844" name="line-844"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<a id="line-845" name="line-845"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="n">r16</span><span class="p">;</span>
<a id="line-846" name="line-846"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-847" name="line-847"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">flagsl</span><span class="p">;</span>
<a id="line-848" name="line-848"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">flagsh</span><span class="p">;</span>
<a id="line-849" name="line-849"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="n">r8</span><span class="p">;</span>
<a id="line-850" name="line-850"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="line-851" name="line-851"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">flags_t</span><span class="p">;</span>
<a id="line-852" name="line-852"></a>
<a id="line-853" name="line-853"></a><span class="cp">#define SetCF(x)   x.u.r8.flagsl |= 0x01</span>
<a id="line-854" name="line-854"></a><span class="cp">#define SetZF(x)   x.u.r8.flagsl |= 0x40</span>
<a id="line-855" name="line-855"></a><span class="cp">#define ClearCF(x) x.u.r8.flagsl &amp;= 0xfe</span>
<a id="line-856" name="line-856"></a><span class="cp">#define ClearZF(x) x.u.r8.flagsl &amp;= 0xbf</span>
<a id="line-857" name="line-857"></a><span class="cp">#define GetCF(x)   (x.u.r8.flagsl &amp; 0x01)</span>
<a id="line-858" name="line-858"></a>
<a id="line-859" name="line-859"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-860" name="line-860"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span>
<a id="line-861" name="line-861"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
<a id="line-862" name="line-862"></a><span class="w">  </span><span class="n">flags_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<a id="line-863" name="line-863"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">iret_addr_t</span><span class="p">;</span>
<a id="line-864" name="line-864"></a>
<a id="line-865" name="line-865"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-866" name="line-866"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<a id="line-867" name="line-867"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<a id="line-868" name="line-868"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">vector</span><span class="p">;</span>
<a id="line-869" name="line-869"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<a id="line-870" name="line-870"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span>
<a id="line-871" name="line-871"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">ipl_entry_t</span><span class="p">;</span>
<a id="line-872" name="line-872"></a>
<a id="line-873" name="line-873"></a>
<a id="line-874" name="line-874"></a>
<a id="line-875" name="line-875"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">inb</span><span class="p">();</span>
<a id="line-876" name="line-876"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">inb_cmos</span><span class="p">();</span>
<a id="line-877" name="line-877"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">outb</span><span class="p">();</span>
<a id="line-878" name="line-878"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">outb_cmos</span><span class="p">();</span>
<a id="line-879" name="line-879"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit16u</span><span class="w">         </span><span class="nf">inw</span><span class="p">();</span>
<a id="line-880" name="line-880"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">outw</span><span class="p">();</span>
<a id="line-881" name="line-881"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">init_rtc</span><span class="p">();</span>
<a id="line-882" name="line-882"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">rtc_updating</span><span class="p">();</span>
<a id="line-883" name="line-883"></a>
<a id="line-884" name="line-884"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">read_byte</span><span class="p">();</span>
<a id="line-885" name="line-885"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit16u</span><span class="w">         </span><span class="nf">read_word</span><span class="p">();</span>
<a id="line-886" name="line-886"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">write_byte</span><span class="p">();</span>
<a id="line-887" name="line-887"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">write_word</span><span class="p">();</span>
<a id="line-888" name="line-888"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">bios_printf</span><span class="p">();</span>
<a id="line-889" name="line-889"></a>
<a id="line-890" name="line-890"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">inhibit_mouse_int_and_events</span><span class="p">();</span>
<a id="line-891" name="line-891"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">enable_mouse_int_and_events</span><span class="p">();</span>
<a id="line-892" name="line-892"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">send_to_mouse_ctrl</span><span class="p">();</span>
<a id="line-893" name="line-893"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w">          </span><span class="nf">get_mouse_data</span><span class="p">();</span>
<a id="line-894" name="line-894"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">set_kbd_command_byte</span><span class="p">();</span>
<a id="line-895" name="line-895"></a>
<a id="line-896" name="line-896"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int09_function</span><span class="p">();</span>
<a id="line-897" name="line-897"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int13_harddisk</span><span class="p">();</span>
<a id="line-898" name="line-898"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int13_cdrom</span><span class="p">();</span>
<a id="line-899" name="line-899"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int13_cdemu</span><span class="p">();</span>
<a id="line-900" name="line-900"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int13_eltorito</span><span class="p">();</span>
<a id="line-901" name="line-901"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int13_diskette_function</span><span class="p">();</span>
<a id="line-902" name="line-902"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int14_function</span><span class="p">();</span>
<a id="line-903" name="line-903"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int15_function</span><span class="p">();</span>
<a id="line-904" name="line-904"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int16_function</span><span class="p">();</span>
<a id="line-905" name="line-905"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int17_function</span><span class="p">();</span>
<a id="line-906" name="line-906"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int18_function</span><span class="p">();</span>
<a id="line-907" name="line-907"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int1a_function</span><span class="p">();</span>
<a id="line-908" name="line-908"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int70_function</span><span class="p">();</span>
<a id="line-909" name="line-909"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">int74_function</span><span class="p">();</span>
<a id="line-910" name="line-910"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit16u</span><span class="w">         </span><span class="nf">get_CS</span><span class="p">();</span>
<a id="line-911" name="line-911"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit16u</span><span class="w">         </span><span class="nf">get_SS</span><span class="p">();</span>
<a id="line-912" name="line-912"></a><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="nf">enqueue_key</span><span class="p">();</span>
<a id="line-913" name="line-913"></a><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="nf">dequeue_key</span><span class="p">();</span>
<a id="line-914" name="line-914"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">get_hd_geometry</span><span class="p">();</span>
<a id="line-915" name="line-915"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">set_diskette_ret_status</span><span class="p">();</span>
<a id="line-916" name="line-916"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">set_diskette_current_cyl</span><span class="p">();</span>
<a id="line-917" name="line-917"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">determine_floppy_media</span><span class="p">();</span>
<a id="line-918" name="line-918"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">floppy_drive_exists</span><span class="p">();</span>
<a id="line-919" name="line-919"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">floppy_drive_recal</span><span class="p">();</span>
<a id="line-920" name="line-920"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">floppy_media_known</span><span class="p">();</span>
<a id="line-921" name="line-921"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">floppy_media_sense</span><span class="p">();</span>
<a id="line-922" name="line-922"></a><span class="k">static</span><span class="w"> </span><span class="n">bx_bool</span><span class="w">        </span><span class="nf">set_enable_a20</span><span class="p">();</span>
<a id="line-923" name="line-923"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">debugger_on</span><span class="p">();</span>
<a id="line-924" name="line-924"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">debugger_off</span><span class="p">();</span>
<a id="line-925" name="line-925"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">keyboard_init</span><span class="p">();</span>
<a id="line-926" name="line-926"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">keyboard_panic</span><span class="p">();</span>
<a id="line-927" name="line-927"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">shutdown_status_panic</span><span class="p">();</span>
<a id="line-928" name="line-928"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">nmi_handler_msg</span><span class="p">();</span>
<a id="line-929" name="line-929"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">delay_ticks</span><span class="p">();</span>
<a id="line-930" name="line-930"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">delay_ticks_and_check_for_keystroke</span><span class="p">();</span>
<a id="line-931" name="line-931"></a>
<a id="line-932" name="line-932"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">interactive_bootkey</span><span class="p">();</span>
<a id="line-933" name="line-933"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">print_bios_banner</span><span class="p">();</span>
<a id="line-934" name="line-934"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">print_boot_device</span><span class="p">();</span>
<a id="line-935" name="line-935"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">print_boot_failure</span><span class="p">();</span>
<a id="line-936" name="line-936"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w">           </span><span class="nf">print_cdromboot_failure</span><span class="p">();</span>
<a id="line-937" name="line-937"></a>
<a id="line-938" name="line-938"></a><span class="cp"># if BX_USE_ATADRV</span>
<a id="line-939" name="line-939"></a>
<a id="line-940" name="line-940"></a><span class="c1">// ATA / ATAPI driver</span>
<a id="line-941" name="line-941"></a><span class="kt">void</span><span class="w">   </span><span class="nf">ata_init</span><span class="p">();</span>
<a id="line-942" name="line-942"></a><span class="kt">void</span><span class="w">   </span><span class="nf">ata_detect</span><span class="p">();</span>
<a id="line-943" name="line-943"></a><span class="kt">void</span><span class="w">   </span><span class="nf">ata_reset</span><span class="p">();</span>
<a id="line-944" name="line-944"></a>
<a id="line-945" name="line-945"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">ata_cmd_non_data</span><span class="p">();</span>
<a id="line-946" name="line-946"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">ata_cmd_data_in</span><span class="p">();</span>
<a id="line-947" name="line-947"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">ata_cmd_data_out</span><span class="p">();</span>
<a id="line-948" name="line-948"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">ata_cmd_packet</span><span class="p">();</span>
<a id="line-949" name="line-949"></a>
<a id="line-950" name="line-950"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">atapi_get_sense</span><span class="p">();</span>
<a id="line-951" name="line-951"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">atapi_is_ready</span><span class="p">();</span>
<a id="line-952" name="line-952"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">atapi_is_cdrom</span><span class="p">();</span>
<a id="line-953" name="line-953"></a>
<a id="line-954" name="line-954"></a><span class="cp">#endif </span><span class="c1">// BX_USE_ATADRV</span>
<a id="line-955" name="line-955"></a>
<a id="line-956" name="line-956"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-957" name="line-957"></a>
<a id="line-958" name="line-958"></a><span class="kt">void</span><span class="w">   </span><span class="nf">cdemu_init</span><span class="p">();</span>
<a id="line-959" name="line-959"></a><span class="n">Bit8u</span><span class="w">  </span><span class="nf">cdemu_isactive</span><span class="p">();</span>
<a id="line-960" name="line-960"></a><span class="n">Bit8u</span><span class="w">  </span><span class="nf">cdemu_emulated_drive</span><span class="p">();</span>
<a id="line-961" name="line-961"></a>
<a id="line-962" name="line-962"></a><span class="n">Bit16u</span><span class="w"> </span><span class="nf">cdrom_boot</span><span class="p">();</span>
<a id="line-963" name="line-963"></a>
<a id="line-964" name="line-964"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-965" name="line-965"></a>
<a id="line-966" name="line-966"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">bios_cvs_version_string</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;$Revision: 1.221 $ $Date: 2008/12/07 17:32:29 $&quot;</span><span class="p">;</span>
<a id="line-967" name="line-967"></a>
<a id="line-968" name="line-968"></a><span class="cp">#define BIOS_COPYRIGHT_STRING &quot;(c) 2002 MandrakeSoft S.A. Written by Kevin Lawton &amp; the Bochs team.&quot;</span>
<a id="line-969" name="line-969"></a>
<a id="line-970" name="line-970"></a><span class="cp">#if DEBUG_ATA</span>
<a id="line-971" name="line-971"></a><span class="cp">#  define BX_DEBUG_ATA(a...) BX_DEBUG(a)</span>
<a id="line-972" name="line-972"></a><span class="cp">#else</span>
<a id="line-973" name="line-973"></a><span class="cp">#  define BX_DEBUG_ATA(a...)</span>
<a id="line-974" name="line-974"></a><span class="cp">#endif</span>
<a id="line-975" name="line-975"></a><span class="cp">#if DEBUG_INT13_HD</span>
<a id="line-976" name="line-976"></a><span class="cp">#  define BX_DEBUG_INT13_HD(a...) BX_DEBUG(a)</span>
<a id="line-977" name="line-977"></a><span class="cp">#else</span>
<a id="line-978" name="line-978"></a><span class="cp">#  define BX_DEBUG_INT13_HD(a...)</span>
<a id="line-979" name="line-979"></a><span class="cp">#endif</span>
<a id="line-980" name="line-980"></a><span class="cp">#if DEBUG_INT13_CD</span>
<a id="line-981" name="line-981"></a><span class="cp">#  define BX_DEBUG_INT13_CD(a...) BX_DEBUG(a)</span>
<a id="line-982" name="line-982"></a><span class="cp">#else</span>
<a id="line-983" name="line-983"></a><span class="cp">#  define BX_DEBUG_INT13_CD(a...)</span>
<a id="line-984" name="line-984"></a><span class="cp">#endif</span>
<a id="line-985" name="line-985"></a><span class="cp">#if DEBUG_INT13_ET</span>
<a id="line-986" name="line-986"></a><span class="cp">#  define BX_DEBUG_INT13_ET(a...) BX_DEBUG(a)</span>
<a id="line-987" name="line-987"></a><span class="cp">#else</span>
<a id="line-988" name="line-988"></a><span class="cp">#  define BX_DEBUG_INT13_ET(a...)</span>
<a id="line-989" name="line-989"></a><span class="cp">#endif</span>
<a id="line-990" name="line-990"></a><span class="cp">#if DEBUG_INT13_FL</span>
<a id="line-991" name="line-991"></a><span class="cp">#  define BX_DEBUG_INT13_FL(a...) BX_DEBUG(a)</span>
<a id="line-992" name="line-992"></a><span class="cp">#else</span>
<a id="line-993" name="line-993"></a><span class="cp">#  define BX_DEBUG_INT13_FL(a...)</span>
<a id="line-994" name="line-994"></a><span class="cp">#endif</span>
<a id="line-995" name="line-995"></a><span class="cp">#if DEBUG_INT15</span>
<a id="line-996" name="line-996"></a><span class="cp">#  define BX_DEBUG_INT15(a...) BX_DEBUG(a)</span>
<a id="line-997" name="line-997"></a><span class="cp">#else</span>
<a id="line-998" name="line-998"></a><span class="cp">#  define BX_DEBUG_INT15(a...)</span>
<a id="line-999" name="line-999"></a><span class="cp">#endif</span>
<a id="line-1000" name="line-1000"></a><span class="cp">#if DEBUG_INT16</span>
<a id="line-1001" name="line-1001"></a><span class="cp">#  define BX_DEBUG_INT16(a...) BX_DEBUG(a)</span>
<a id="line-1002" name="line-1002"></a><span class="cp">#else</span>
<a id="line-1003" name="line-1003"></a><span class="cp">#  define BX_DEBUG_INT16(a...)</span>
<a id="line-1004" name="line-1004"></a><span class="cp">#endif</span>
<a id="line-1005" name="line-1005"></a><span class="cp">#if DEBUG_INT1A</span>
<a id="line-1006" name="line-1006"></a><span class="cp">#  define BX_DEBUG_INT1A(a...) BX_DEBUG(a)</span>
<a id="line-1007" name="line-1007"></a><span class="cp">#else</span>
<a id="line-1008" name="line-1008"></a><span class="cp">#  define BX_DEBUG_INT1A(a...)</span>
<a id="line-1009" name="line-1009"></a><span class="cp">#endif</span>
<a id="line-1010" name="line-1010"></a><span class="cp">#if DEBUG_INT74</span>
<a id="line-1011" name="line-1011"></a><span class="cp">#  define BX_DEBUG_INT74(a...) BX_DEBUG(a)</span>
<a id="line-1012" name="line-1012"></a><span class="cp">#else</span>
<a id="line-1013" name="line-1013"></a><span class="cp">#  define BX_DEBUG_INT74(a...)</span>
<a id="line-1014" name="line-1014"></a><span class="cp">#endif</span>
<a id="line-1015" name="line-1015"></a>
<a id="line-1016" name="line-1016"></a><span class="cp">#define SET_AL(val8) AX = ((AX &amp; 0xff00) | (val8))</span>
<a id="line-1017" name="line-1017"></a><span class="cp">#define SET_BL(val8) BX = ((BX &amp; 0xff00) | (val8))</span>
<a id="line-1018" name="line-1018"></a><span class="cp">#define SET_CL(val8) CX = ((CX &amp; 0xff00) | (val8))</span>
<a id="line-1019" name="line-1019"></a><span class="cp">#define SET_DL(val8) DX = ((DX &amp; 0xff00) | (val8))</span>
<a id="line-1020" name="line-1020"></a><span class="cp">#define SET_AH(val8) AX = ((AX &amp; 0x00ff) | ((val8) &lt;&lt; 8))</span>
<a id="line-1021" name="line-1021"></a><span class="cp">#define SET_BH(val8) BX = ((BX &amp; 0x00ff) | ((val8) &lt;&lt; 8))</span>
<a id="line-1022" name="line-1022"></a><span class="cp">#define SET_CH(val8) CX = ((CX &amp; 0x00ff) | ((val8) &lt;&lt; 8))</span>
<a id="line-1023" name="line-1023"></a><span class="cp">#define SET_DH(val8) DX = ((DX &amp; 0x00ff) | ((val8) &lt;&lt; 8))</span>
<a id="line-1024" name="line-1024"></a>
<a id="line-1025" name="line-1025"></a><span class="cp">#define GET_AL() ( AX &amp; 0x00ff )</span>
<a id="line-1026" name="line-1026"></a><span class="cp">#define GET_BL() ( BX &amp; 0x00ff )</span>
<a id="line-1027" name="line-1027"></a><span class="cp">#define GET_CL() ( CX &amp; 0x00ff )</span>
<a id="line-1028" name="line-1028"></a><span class="cp">#define GET_DL() ( DX &amp; 0x00ff )</span>
<a id="line-1029" name="line-1029"></a><span class="cp">#define GET_AH() ( AX &gt;&gt; 8 )</span>
<a id="line-1030" name="line-1030"></a><span class="cp">#define GET_BH() ( BX &gt;&gt; 8 )</span>
<a id="line-1031" name="line-1031"></a><span class="cp">#define GET_CH() ( CX &gt;&gt; 8 )</span>
<a id="line-1032" name="line-1032"></a><span class="cp">#define GET_DH() ( DX &gt;&gt; 8 )</span>
<a id="line-1033" name="line-1033"></a>
<a id="line-1034" name="line-1034"></a><span class="cp">#define GET_ELDL() ( ELDX &amp; 0x00ff )</span>
<a id="line-1035" name="line-1035"></a><span class="cp">#define GET_ELDH() ( ELDX &gt;&gt; 8 )</span>
<a id="line-1036" name="line-1036"></a>
<a id="line-1037" name="line-1037"></a><span class="cp">#define SET_CF()     FLAGS |= 0x0001</span>
<a id="line-1038" name="line-1038"></a><span class="cp">#define CLEAR_CF()   FLAGS &amp;= 0xfffe</span>
<a id="line-1039" name="line-1039"></a><span class="cp">#define GET_CF()     (FLAGS &amp; 0x0001)</span>
<a id="line-1040" name="line-1040"></a>
<a id="line-1041" name="line-1041"></a><span class="cp">#define SET_ZF()     FLAGS |= 0x0040</span>
<a id="line-1042" name="line-1042"></a><span class="cp">#define CLEAR_ZF()   FLAGS &amp;= 0xffbf</span>
<a id="line-1043" name="line-1043"></a><span class="cp">#define GET_ZF()     (FLAGS &amp; 0x0040)</span>
<a id="line-1044" name="line-1044"></a>
<a id="line-1045" name="line-1045"></a><span class="cp">#define UNSUPPORTED_FUNCTION 0x86</span>
<a id="line-1046" name="line-1046"></a>
<a id="line-1047" name="line-1047"></a><span class="cp">#define none 0</span>
<a id="line-1048" name="line-1048"></a><span class="cp">#define MAX_SCAN_CODE 0x58</span>
<a id="line-1049" name="line-1049"></a>
<a id="line-1050" name="line-1050"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="line-1051" name="line-1051"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">normal</span><span class="p">;</span>
<a id="line-1052" name="line-1052"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span>
<a id="line-1053" name="line-1053"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">control</span><span class="p">;</span>
<a id="line-1054" name="line-1054"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">alt</span><span class="p">;</span>
<a id="line-1055" name="line-1055"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">lock_flags</span><span class="p">;</span>
<a id="line-1056" name="line-1056"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">MAX_SCAN_CODE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="line-1057" name="line-1057"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span>
<a id="line-1058" name="line-1058"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x011b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x011b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x011b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0100</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* escape */</span>
<a id="line-1059" name="line-1059"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0231</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0221</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7800</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 1! */</span>
<a id="line-1060" name="line-1060"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0332</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0340</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7900</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 2@ */</span>
<a id="line-1061" name="line-1061"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0433</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0423</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7a00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 3# */</span>
<a id="line-1062" name="line-1062"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0534</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0524</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 4$ */</span>
<a id="line-1063" name="line-1063"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0635</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0625</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 5% */</span>
<a id="line-1064" name="line-1064"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0736</span><span class="p">,</span><span class="w"> </span><span class="mh">0x075e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x071e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7d00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 6^ */</span>
<a id="line-1065" name="line-1065"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0837</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0826</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 7&amp; */</span>
<a id="line-1066" name="line-1066"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0938</span><span class="p">,</span><span class="w"> </span><span class="mh">0x092a</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7f00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 8* */</span>
<a id="line-1067" name="line-1067"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0a39</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0a28</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8000</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 9( */</span>
<a id="line-1068" name="line-1068"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0b30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0b29</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8100</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 0) */</span>
<a id="line-1069" name="line-1069"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0c2d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c5f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c1f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8200</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* -_ */</span>
<a id="line-1070" name="line-1070"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0d3d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0d2b</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8300</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* =+ */</span>
<a id="line-1071" name="line-1071"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0e08</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e08</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e7f</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* backspace */</span>
<a id="line-1072" name="line-1072"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0f09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f00</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* tab */</span>
<a id="line-1073" name="line-1073"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1071</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1051</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1011</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Q */</span>
<a id="line-1074" name="line-1074"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1177</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1157</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1117</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* W */</span>
<a id="line-1075" name="line-1075"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1265</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1245</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1205</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* E */</span>
<a id="line-1076" name="line-1076"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1372</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1352</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1312</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* R */</span>
<a id="line-1077" name="line-1077"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1474</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1454</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1414</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1400</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* T */</span>
<a id="line-1078" name="line-1078"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1579</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1559</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1519</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Y */</span>
<a id="line-1079" name="line-1079"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1675</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1655</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1615</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1600</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* U */</span>
<a id="line-1080" name="line-1080"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1769</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1749</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1709</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* I */</span>
<a id="line-1081" name="line-1081"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x186f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x184f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x180f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1800</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* O */</span>
<a id="line-1082" name="line-1082"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1970</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1950</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1910</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1900</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* P */</span>
<a id="line-1083" name="line-1083"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1a5b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a1b</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* [{ */</span>
<a id="line-1084" name="line-1084"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1b5d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1b7d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1b1d</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* ]} */</span>
<a id="line-1085" name="line-1085"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1c0d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c0d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c0a</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Enter */</span>
<a id="line-1086" name="line-1086"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* L Ctrl */</span>
<a id="line-1087" name="line-1087"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1e61</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e41</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* A */</span>
<a id="line-1088" name="line-1088"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1f73</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1f53</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1f13</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* S */</span>
<a id="line-1089" name="line-1089"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2064</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2044</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2004</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* D */</span>
<a id="line-1090" name="line-1090"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2166</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2146</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2106</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F */</span>
<a id="line-1091" name="line-1091"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2267</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2247</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2207</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* G */</span>
<a id="line-1092" name="line-1092"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2368</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2348</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2308</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* H */</span>
<a id="line-1093" name="line-1093"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x246a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x244a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x240a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2400</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* J */</span>
<a id="line-1094" name="line-1094"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x256b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x254b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x250b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* K */</span>
<a id="line-1095" name="line-1095"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x266c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x264c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x260c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2600</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* L */</span>
<a id="line-1096" name="line-1096"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x273b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x273a</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* ;: */</span>
<a id="line-1097" name="line-1097"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2827</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2822</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* &#39;&quot; */</span>
<a id="line-1098" name="line-1098"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2960</span><span class="p">,</span><span class="w"> </span><span class="mh">0x297e</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* `~ */</span>
<a id="line-1099" name="line-1099"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* L shift */</span>
<a id="line-1100" name="line-1100"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2b5c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2b7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2b1c</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* |\ */</span>
<a id="line-1101" name="line-1101"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2c7a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2c5a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2c1a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2c00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Z */</span>
<a id="line-1102" name="line-1102"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2d78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2d58</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2d18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2d00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* X */</span>
<a id="line-1103" name="line-1103"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2e63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2e43</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2e03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2e00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* C */</span>
<a id="line-1104" name="line-1104"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x2f76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f56</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* V */</span>
<a id="line-1105" name="line-1105"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3062</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3042</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3002</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* B */</span>
<a id="line-1106" name="line-1106"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x316e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x314e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x310e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* N */</span>
<a id="line-1107" name="line-1107"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x326d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x324d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x320d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* M */</span>
<a id="line-1108" name="line-1108"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x332c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x333c</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* ,&lt; */</span>
<a id="line-1109" name="line-1109"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x342e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x343e</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* .&gt; */</span>
<a id="line-1110" name="line-1110"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x352f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x353f</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* /? */</span>
<a id="line-1111" name="line-1111"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* R Shift */</span>
<a id="line-1112" name="line-1112"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x372a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x372a</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* * */</span>
<a id="line-1113" name="line-1113"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* L Alt */</span>
<a id="line-1114" name="line-1114"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3920</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3920</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3920</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3920</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* space */</span>
<a id="line-1115" name="line-1115"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* caps lock */</span>
<a id="line-1116" name="line-1116"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3b00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5400</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5e00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6800</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F1 */</span>
<a id="line-1117" name="line-1117"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3c00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6900</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F2 */</span>
<a id="line-1118" name="line-1118"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3d00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5600</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6a00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F3 */</span>
<a id="line-1119" name="line-1119"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3e00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6b00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F4 */</span>
<a id="line-1120" name="line-1120"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x3f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5800</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F5 */</span>
<a id="line-1121" name="line-1121"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5900</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6d00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F6 */</span>
<a id="line-1122" name="line-1122"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5a00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6400</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6e00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F7 */</span>
<a id="line-1123" name="line-1123"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5b00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6f00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F8 */</span>
<a id="line-1124" name="line-1124"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5c00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6600</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7000</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F9 */</span>
<a id="line-1125" name="line-1125"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4400</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5d00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7100</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F10 */</span>
<a id="line-1126" name="line-1126"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Num Lock */</span>
<a id="line-1127" name="line-1127"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Scroll Lock */</span>
<a id="line-1128" name="line-1128"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4737</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7700</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 7 Home */</span>
<a id="line-1129" name="line-1129"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4800</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4838</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 8 UP */</span>
<a id="line-1130" name="line-1130"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4900</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4939</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8400</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 9 PgUp */</span>
<a id="line-1131" name="line-1131"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4a2d</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4a2d</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* - */</span>
<a id="line-1132" name="line-1132"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4b00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4b34</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7300</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 4 Left */</span>
<a id="line-1133" name="line-1133"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4c00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c35</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 5 */</span>
<a id="line-1134" name="line-1134"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4d00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d36</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7400</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 6 Right */</span>
<a id="line-1135" name="line-1135"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4e2b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4e2b</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* + */</span>
<a id="line-1136" name="line-1136"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x4f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4f31</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7500</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 1 End */</span>
<a id="line-1137" name="line-1137"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x5000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5032</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 2 Down */</span>
<a id="line-1138" name="line-1138"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x5100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5133</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7600</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 3 PgDn */</span>
<a id="line-1139" name="line-1139"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x5200</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5230</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* 0 Ins */</span>
<a id="line-1140" name="line-1140"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x5300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x532e</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* Del */</span>
<a id="line-1141" name="line-1141"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span>
<a id="line-1142" name="line-1142"></a><span class="w">      </span><span class="p">{</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span>
<a id="line-1143" name="line-1143"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x565c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x567c</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w">   </span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* \| */</span>
<a id="line-1144" name="line-1144"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x8500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8900</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8b00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F11 */</span>
<a id="line-1145" name="line-1145"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="mh">0x8600</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8800</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8a00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8c00</span><span class="p">,</span><span class="w"> </span><span class="n">none</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="cm">/* F12 */</span>
<a id="line-1146" name="line-1146"></a><span class="w">      </span><span class="p">};</span>
<a id="line-1147" name="line-1147"></a>
<a id="line-1148" name="line-1148"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-1149" name="line-1149"></a><span class="nf">inb</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
<a id="line-1150" name="line-1150"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<a id="line-1151" name="line-1151"></a><span class="p">{</span>
<a id="line-1152" name="line-1152"></a><span class="n">ASM_START</span>
<a id="line-1153" name="line-1153"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1154" name="line-1154"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1155" name="line-1155"></a>
<a id="line-1156" name="line-1156"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1157" name="line-1157"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1158" name="line-1158"></a><span class="w">    </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1159" name="line-1159"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-1160" name="line-1160"></a>
<a id="line-1161" name="line-1161"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1162" name="line-1162"></a><span class="n">ASM_END</span>
<a id="line-1163" name="line-1163"></a><span class="p">}</span>
<a id="line-1164" name="line-1164"></a>
<a id="line-1165" name="line-1165"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-1166" name="line-1166"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-1167" name="line-1167"></a><span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
<a id="line-1168" name="line-1168"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<a id="line-1169" name="line-1169"></a><span class="p">{</span>
<a id="line-1170" name="line-1170"></a><span class="n">ASM_START</span>
<a id="line-1171" name="line-1171"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1172" name="line-1172"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1173" name="line-1173"></a>
<a id="line-1174" name="line-1174"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1175" name="line-1175"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1176" name="line-1176"></a><span class="w">    </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1177" name="line-1177"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-1178" name="line-1178"></a>
<a id="line-1179" name="line-1179"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1180" name="line-1180"></a><span class="n">ASM_END</span>
<a id="line-1181" name="line-1181"></a><span class="p">}</span>
<a id="line-1182" name="line-1182"></a><span class="cp">#endif</span>
<a id="line-1183" name="line-1183"></a>
<a id="line-1184" name="line-1184"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1185" name="line-1185"></a><span class="n">outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<a id="line-1186" name="line-1186"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<a id="line-1187" name="line-1187"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">val</span><span class="p">;</span>
<a id="line-1188" name="line-1188"></a><span class="p">{</span>
<a id="line-1189" name="line-1189"></a><span class="n">ASM_START</span>
<a id="line-1190" name="line-1190"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1191" name="line-1191"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1192" name="line-1192"></a>
<a id="line-1193" name="line-1193"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1194" name="line-1194"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1195" name="line-1195"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1196" name="line-1196"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1197" name="line-1197"></a><span class="w">    </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1198" name="line-1198"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-1199" name="line-1199"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-1200" name="line-1200"></a>
<a id="line-1201" name="line-1201"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1202" name="line-1202"></a><span class="n">ASM_END</span>
<a id="line-1203" name="line-1203"></a><span class="p">}</span>
<a id="line-1204" name="line-1204"></a>
<a id="line-1205" name="line-1205"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-1206" name="line-1206"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1207" name="line-1207"></a><span class="n">outw</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<a id="line-1208" name="line-1208"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<a id="line-1209" name="line-1209"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">val</span><span class="p">;</span>
<a id="line-1210" name="line-1210"></a><span class="p">{</span>
<a id="line-1211" name="line-1211"></a><span class="n">ASM_START</span>
<a id="line-1212" name="line-1212"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1213" name="line-1213"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1214" name="line-1214"></a>
<a id="line-1215" name="line-1215"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1216" name="line-1216"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-1217" name="line-1217"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1218" name="line-1218"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1219" name="line-1219"></a><span class="w">    </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1220" name="line-1220"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-1221" name="line-1221"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-1222" name="line-1222"></a>
<a id="line-1223" name="line-1223"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1224" name="line-1224"></a><span class="n">ASM_END</span>
<a id="line-1225" name="line-1225"></a><span class="p">}</span>
<a id="line-1226" name="line-1226"></a><span class="cp">#endif</span>
<a id="line-1227" name="line-1227"></a>
<a id="line-1228" name="line-1228"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1229" name="line-1229"></a><span class="n">outb_cmos</span><span class="p">(</span><span class="n">cmos_reg</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<a id="line-1230" name="line-1230"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">cmos_reg</span><span class="p">;</span>
<a id="line-1231" name="line-1231"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="line-1232" name="line-1232"></a><span class="p">{</span>
<a id="line-1233" name="line-1233"></a><span class="n">ASM_START</span>
<a id="line-1234" name="line-1234"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1235" name="line-1235"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1236" name="line-1236"></a>
<a id="line-1237" name="line-1237"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">cmos_reg</span>
<a id="line-1238" name="line-1238"></a><span class="w">    </span><span class="n">out</span><span class="w">  </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1239" name="line-1239"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">val</span>
<a id="line-1240" name="line-1240"></a><span class="w">    </span><span class="n">out</span><span class="w">  </span><span class="mh">0x71</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1241" name="line-1241"></a>
<a id="line-1242" name="line-1242"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1243" name="line-1243"></a><span class="n">ASM_END</span>
<a id="line-1244" name="line-1244"></a><span class="p">}</span>
<a id="line-1245" name="line-1245"></a>
<a id="line-1246" name="line-1246"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-1247" name="line-1247"></a><span class="n">inb_cmos</span><span class="p">(</span><span class="n">cmos_reg</span><span class="p">)</span>
<a id="line-1248" name="line-1248"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">cmos_reg</span><span class="p">;</span>
<a id="line-1249" name="line-1249"></a><span class="p">{</span>
<a id="line-1250" name="line-1250"></a><span class="n">ASM_START</span>
<a id="line-1251" name="line-1251"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1252" name="line-1252"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1253" name="line-1253"></a>
<a id="line-1254" name="line-1254"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">cmos_reg</span>
<a id="line-1255" name="line-1255"></a><span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1256" name="line-1256"></a><span class="w">    </span><span class="n">in</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span>
<a id="line-1257" name="line-1257"></a>
<a id="line-1258" name="line-1258"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1259" name="line-1259"></a><span class="n">ASM_END</span>
<a id="line-1260" name="line-1260"></a><span class="p">}</span>
<a id="line-1261" name="line-1261"></a>
<a id="line-1262" name="line-1262"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1263" name="line-1263"></a><span class="n">init_rtc</span><span class="p">()</span>
<a id="line-1264" name="line-1264"></a><span class="p">{</span>
<a id="line-1265" name="line-1265"></a><span class="w">  </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x26</span><span class="p">);</span>
<a id="line-1266" name="line-1266"></a><span class="w">  </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-1267" name="line-1267"></a><span class="w">  </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">);</span>
<a id="line-1268" name="line-1268"></a><span class="w">  </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">);</span>
<a id="line-1269" name="line-1269"></a><span class="p">}</span>
<a id="line-1270" name="line-1270"></a>
<a id="line-1271" name="line-1271"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-1272" name="line-1272"></a><span class="n">rtc_updating</span><span class="p">()</span>
<a id="line-1273" name="line-1273"></a><span class="p">{</span>
<a id="line-1274" name="line-1274"></a><span class="w">  </span><span class="c1">// This function checks to see if the update-in-progress bit</span>
<a id="line-1275" name="line-1275"></a><span class="w">  </span><span class="c1">// is set in CMOS Status Register A.  If not, it returns 0.</span>
<a id="line-1276" name="line-1276"></a><span class="w">  </span><span class="c1">// If it is set, it tries to wait until there is a transition</span>
<a id="line-1277" name="line-1277"></a><span class="w">  </span><span class="c1">// to 0, and will return 0 if such a transition occurs.  A 1</span>
<a id="line-1278" name="line-1278"></a><span class="w">  </span><span class="c1">// is returned only after timing out.  The maximum period</span>
<a id="line-1279" name="line-1279"></a><span class="w">  </span><span class="c1">// that this bit should be set is constrained to 244useconds.</span>
<a id="line-1280" name="line-1280"></a><span class="w">  </span><span class="c1">// The count I use below guarantees coverage or more than</span>
<a id="line-1281" name="line-1281"></a><span class="w">  </span><span class="c1">// this time, with any reasonable IPS setting.</span>
<a id="line-1282" name="line-1282"></a>
<a id="line-1283" name="line-1283"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-1284" name="line-1284"></a>
<a id="line-1285" name="line-1285"></a><span class="w">  </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25000</span><span class="p">;</span>
<a id="line-1286" name="line-1286"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1287" name="line-1287"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="line-1288" name="line-1288"></a><span class="w">      </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-1289" name="line-1289"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1290" name="line-1290"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// update-in-progress never transitioned to 0</span>
<a id="line-1291" name="line-1291"></a><span class="p">}</span>
<a id="line-1292" name="line-1292"></a>
<a id="line-1293" name="line-1293"></a>
<a id="line-1294" name="line-1294"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-1295" name="line-1295"></a><span class="n">read_byte</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-1296" name="line-1296"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-1297" name="line-1297"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-1298" name="line-1298"></a><span class="p">{</span>
<a id="line-1299" name="line-1299"></a><span class="n">ASM_START</span>
<a id="line-1300" name="line-1300"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1301" name="line-1301"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1302" name="line-1302"></a>
<a id="line-1303" name="line-1303"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-1304" name="line-1304"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-1305" name="line-1305"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-1306" name="line-1306"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1307" name="line-1307"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-1308" name="line-1308"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-1309" name="line-1309"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>
<a id="line-1310" name="line-1310"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-1311" name="line-1311"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-1312" name="line-1312"></a>
<a id="line-1313" name="line-1313"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1314" name="line-1314"></a><span class="n">ASM_END</span>
<a id="line-1315" name="line-1315"></a><span class="p">}</span>
<a id="line-1316" name="line-1316"></a>
<a id="line-1317" name="line-1317"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-1318" name="line-1318"></a><span class="n">read_word</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-1319" name="line-1319"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-1320" name="line-1320"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-1321" name="line-1321"></a><span class="p">{</span>
<a id="line-1322" name="line-1322"></a><span class="n">ASM_START</span>
<a id="line-1323" name="line-1323"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1324" name="line-1324"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1325" name="line-1325"></a>
<a id="line-1326" name="line-1326"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-1327" name="line-1327"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-1328" name="line-1328"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-1329" name="line-1329"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1330" name="line-1330"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-1331" name="line-1331"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-1332" name="line-1332"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="line-1333" name="line-1333"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-1334" name="line-1334"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-1335" name="line-1335"></a>
<a id="line-1336" name="line-1336"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1337" name="line-1337"></a><span class="n">ASM_END</span>
<a id="line-1338" name="line-1338"></a><span class="p">}</span>
<a id="line-1339" name="line-1339"></a>
<a id="line-1340" name="line-1340"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1341" name="line-1341"></a><span class="n">write_byte</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<a id="line-1342" name="line-1342"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-1343" name="line-1343"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-1344" name="line-1344"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="line-1345" name="line-1345"></a><span class="p">{</span>
<a id="line-1346" name="line-1346"></a><span class="n">ASM_START</span>
<a id="line-1347" name="line-1347"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1348" name="line-1348"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1349" name="line-1349"></a>
<a id="line-1350" name="line-1350"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1351" name="line-1351"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-1352" name="line-1352"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-1353" name="line-1353"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-1354" name="line-1354"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1355" name="line-1355"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-1356" name="line-1356"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">byte</span>
<a id="line-1357" name="line-1357"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">byte</span>
<a id="line-1358" name="line-1358"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-1359" name="line-1359"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-1360" name="line-1360"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-1361" name="line-1361"></a>
<a id="line-1362" name="line-1362"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1363" name="line-1363"></a><span class="n">ASM_END</span>
<a id="line-1364" name="line-1364"></a><span class="p">}</span>
<a id="line-1365" name="line-1365"></a>
<a id="line-1366" name="line-1366"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1367" name="line-1367"></a><span class="n">write_word</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<a id="line-1368" name="line-1368"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="line-1369" name="line-1369"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-1370" name="line-1370"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="line-1371" name="line-1371"></a><span class="p">{</span>
<a id="line-1372" name="line-1372"></a><span class="n">ASM_START</span>
<a id="line-1373" name="line-1373"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1374" name="line-1374"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1375" name="line-1375"></a>
<a id="line-1376" name="line-1376"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1377" name="line-1377"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-1378" name="line-1378"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-1379" name="line-1379"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-1380" name="line-1380"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-1381" name="line-1381"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-1382" name="line-1382"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-1383" name="line-1383"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">word</span>
<a id="line-1384" name="line-1384"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-1385" name="line-1385"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-1386" name="line-1386"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-1387" name="line-1387"></a>
<a id="line-1388" name="line-1388"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1389" name="line-1389"></a><span class="n">ASM_END</span>
<a id="line-1390" name="line-1390"></a><span class="p">}</span>
<a id="line-1391" name="line-1391"></a>
<a id="line-1392" name="line-1392"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-1393" name="line-1393"></a><span class="n">get_CS</span><span class="p">()</span>
<a id="line-1394" name="line-1394"></a><span class="p">{</span>
<a id="line-1395" name="line-1395"></a><span class="n">ASM_START</span>
<a id="line-1396" name="line-1396"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">cs</span>
<a id="line-1397" name="line-1397"></a><span class="n">ASM_END</span>
<a id="line-1398" name="line-1398"></a><span class="p">}</span>
<a id="line-1399" name="line-1399"></a>
<a id="line-1400" name="line-1400"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-1401" name="line-1401"></a><span class="n">get_SS</span><span class="p">()</span>
<a id="line-1402" name="line-1402"></a><span class="p">{</span>
<a id="line-1403" name="line-1403"></a><span class="n">ASM_START</span>
<a id="line-1404" name="line-1404"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span>
<a id="line-1405" name="line-1405"></a><span class="n">ASM_END</span>
<a id="line-1406" name="line-1406"></a><span class="p">}</span>
<a id="line-1407" name="line-1407"></a>
<a id="line-1408" name="line-1408"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-1409" name="line-1409"></a><span class="kt">void</span>
<a id="line-1410" name="line-1410"></a><span class="n">fixup_base_mem_in_k</span><span class="p">()</span>
<a id="line-1411" name="line-1411"></a><span class="p">{</span>
<a id="line-1412" name="line-1412"></a><span class="w">  </span><span class="cm">/* Report the proper base memory size at address 0x0413: otherwise</span>
<a id="line-1413" name="line-1413"></a><span class="cm">   * non-e820 code will clobber things if BASE_MEM_IN_K is bigger than</span>
<a id="line-1414" name="line-1414"></a><span class="cm">   * the first e820 entry.  Get the size by reading the second 64bit </span>
<a id="line-1415" name="line-1415"></a><span class="cm">   * field of the first e820 slot. */</span><span class="w"> </span>
<a id="line-1416" name="line-1416"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">base_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-1417" name="line-1417"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="n">base_mem</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<a id="line-1418" name="line-1418"></a><span class="p">}</span>
<a id="line-1419" name="line-1419"></a>
<a id="line-1420" name="line-1420"></a><span class="kt">void</span><span class="w"> </span><span class="n">enable_rom_write_access</span><span class="p">()</span>
<a id="line-1421" name="line-1421"></a><span class="p">{</span>
<a id="line-1422" name="line-1422"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">XEN_PF_IOBASE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1423" name="line-1423"></a><span class="p">}</span>
<a id="line-1424" name="line-1424"></a>
<a id="line-1425" name="line-1425"></a><span class="kt">void</span><span class="w"> </span><span class="n">disable_rom_write_access</span><span class="p">()</span>
<a id="line-1426" name="line-1426"></a><span class="p">{</span>
<a id="line-1427" name="line-1427"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">XEN_PF_IOBASE</span><span class="p">,</span><span class="w"> </span><span class="n">PFFLAG_ROM_LOCK</span><span class="p">);</span>
<a id="line-1428" name="line-1428"></a><span class="p">}</span>
<a id="line-1429" name="line-1429"></a><span class="w">    </span>
<a id="line-1430" name="line-1430"></a><span class="cp">#endif </span><span class="cm">/* HVMASSIST */</span>
<a id="line-1431" name="line-1431"></a>
<a id="line-1432" name="line-1432"></a><span class="cp">#if BX_DEBUG_SERIAL</span>
<a id="line-1433" name="line-1433"></a><span class="cm">/* serial debug port*/</span>
<a id="line-1434" name="line-1434"></a><span class="cp">#define BX_DEBUG_PORT 0x03f8</span>
<a id="line-1435" name="line-1435"></a>
<a id="line-1436" name="line-1436"></a><span class="cm">/* data */</span>
<a id="line-1437" name="line-1437"></a><span class="cp">#define UART_RBR 0x00</span>
<a id="line-1438" name="line-1438"></a><span class="cp">#define UART_THR 0x00</span>
<a id="line-1439" name="line-1439"></a>
<a id="line-1440" name="line-1440"></a><span class="cm">/* control */</span>
<a id="line-1441" name="line-1441"></a><span class="cp">#define UART_IER 0x01</span>
<a id="line-1442" name="line-1442"></a><span class="cp">#define UART_IIR 0x02</span>
<a id="line-1443" name="line-1443"></a><span class="cp">#define UART_FCR 0x02</span>
<a id="line-1444" name="line-1444"></a><span class="cp">#define UART_LCR 0x03</span>
<a id="line-1445" name="line-1445"></a><span class="cp">#define UART_MCR 0x04</span>
<a id="line-1446" name="line-1446"></a><span class="cp">#define UART_DLL 0x00</span>
<a id="line-1447" name="line-1447"></a><span class="cp">#define UART_DLM 0x01</span>
<a id="line-1448" name="line-1448"></a>
<a id="line-1449" name="line-1449"></a><span class="cm">/* status */</span>
<a id="line-1450" name="line-1450"></a><span class="cp">#define UART_LSR 0x05</span>
<a id="line-1451" name="line-1451"></a><span class="cp">#define UART_MSR 0x06</span>
<a id="line-1452" name="line-1452"></a><span class="cp">#define UART_SCR 0x07</span>
<a id="line-1453" name="line-1453"></a>
<a id="line-1454" name="line-1454"></a><span class="kt">int</span><span class="w"> </span><span class="n">uart_can_tx_byte</span><span class="p">(</span><span class="n">base_port</span><span class="p">)</span>
<a id="line-1455" name="line-1455"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base_port</span><span class="p">;</span>
<a id="line-1456" name="line-1456"></a><span class="p">{</span>
<a id="line-1457" name="line-1457"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">base_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">UART_LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<a id="line-1458" name="line-1458"></a><span class="p">}</span>
<a id="line-1459" name="line-1459"></a>
<a id="line-1460" name="line-1460"></a><span class="kt">void</span><span class="w"> </span><span class="n">uart_wait_to_tx_byte</span><span class="p">(</span><span class="n">base_port</span><span class="p">)</span>
<a id="line-1461" name="line-1461"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base_port</span><span class="p">;</span>
<a id="line-1462" name="line-1462"></a><span class="p">{</span>
<a id="line-1463" name="line-1463"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">uart_can_tx_byte</span><span class="p">(</span><span class="n">base_port</span><span class="p">));</span>
<a id="line-1464" name="line-1464"></a><span class="p">}</span>
<a id="line-1465" name="line-1465"></a>
<a id="line-1466" name="line-1466"></a><span class="kt">void</span><span class="w"> </span><span class="n">uart_wait_until_sent</span><span class="p">(</span><span class="n">base_port</span><span class="p">)</span>
<a id="line-1467" name="line-1467"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base_port</span><span class="p">;</span>
<a id="line-1468" name="line-1468"></a><span class="p">{</span>
<a id="line-1469" name="line-1469"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">UART_LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x40</span><span class="p">));</span>
<a id="line-1470" name="line-1470"></a><span class="p">}</span>
<a id="line-1471" name="line-1471"></a>
<a id="line-1472" name="line-1472"></a><span class="kt">void</span><span class="w"> </span><span class="n">uart_tx_byte</span><span class="p">(</span><span class="n">base_port</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<a id="line-1473" name="line-1473"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base_port</span><span class="p">;</span>
<a id="line-1474" name="line-1474"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="line-1475" name="line-1475"></a><span class="p">{</span>
<a id="line-1476" name="line-1476"></a><span class="w">    </span><span class="n">uart_wait_to_tx_byte</span><span class="p">(</span><span class="n">base_port</span><span class="p">);</span>
<a id="line-1477" name="line-1477"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">base_port</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">UART_THR</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<a id="line-1478" name="line-1478"></a><span class="w">    </span><span class="n">uart_wait_until_sent</span><span class="p">(</span><span class="n">base_port</span><span class="p">);</span>
<a id="line-1479" name="line-1479"></a><span class="p">}</span>
<a id="line-1480" name="line-1480"></a><span class="cp">#endif</span>
<a id="line-1481" name="line-1481"></a>
<a id="line-1482" name="line-1482"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1483" name="line-1483"></a><span class="n">wrch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="line-1484" name="line-1484"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">c</span><span class="p">;</span>
<a id="line-1485" name="line-1485"></a><span class="p">{</span>
<a id="line-1486" name="line-1486"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-1487" name="line-1487"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-1488" name="line-1488"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-1489" name="line-1489"></a>
<a id="line-1490" name="line-1490"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-1491" name="line-1491"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0e</span>
<a id="line-1492" name="line-1492"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-1493" name="line-1493"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="n">bx</span>
<a id="line-1494" name="line-1494"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-1495" name="line-1495"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-1496" name="line-1496"></a>
<a id="line-1497" name="line-1497"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-1498" name="line-1498"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-1499" name="line-1499"></a><span class="p">}</span>
<a id="line-1500" name="line-1500"></a>
<a id="line-1501" name="line-1501"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1502" name="line-1502"></a><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<a id="line-1503" name="line-1503"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1504" name="line-1504"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">c</span><span class="p">;</span>
<a id="line-1505" name="line-1505"></a><span class="p">{</span>
<a id="line-1506" name="line-1506"></a><span class="cp">#if BX_DEBUG_SERIAL</span>
<a id="line-1507" name="line-1507"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">uart_tx_byte</span><span class="p">(</span><span class="n">BX_DEBUG_PORT</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;\r&#39;</span><span class="p">);</span>
<a id="line-1508" name="line-1508"></a><span class="w">  </span><span class="n">uart_tx_byte</span><span class="p">(</span><span class="n">BX_DEBUG_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1509" name="line-1509"></a><span class="cp">#endif</span>
<a id="line-1510" name="line-1510"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-1511" name="line-1511"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0xE9</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1512" name="line-1512"></a><span class="cp">#endif</span>
<a id="line-1513" name="line-1513"></a><span class="cp">#if BX_VIRTUAL_PORTS</span>
<a id="line-1514" name="line-1514"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIOS_PRINTF_DEBUG</span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="n">DEBUG_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1515" name="line-1515"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIOS_PRINTF_INFO</span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="n">INFO_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1516" name="line-1516"></a><span class="cp">#endif</span>
<a id="line-1517" name="line-1517"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIOS_PRINTF_SCREEN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1518" name="line-1518"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">wrch</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">);</span>
<a id="line-1519" name="line-1519"></a><span class="w">    </span><span class="n">wrch</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a id="line-1520" name="line-1520"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1521" name="line-1521"></a><span class="p">}</span>
<a id="line-1522" name="line-1522"></a>
<a id="line-1523" name="line-1523"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1524" name="line-1524"></a><span class="n">put_int</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">)</span>
<a id="line-1525" name="line-1525"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1526" name="line-1526"></a><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<a id="line-1527" name="line-1527"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">neg</span><span class="p">;</span>
<a id="line-1528" name="line-1528"></a><span class="p">{</span>
<a id="line-1529" name="line-1529"></a><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="line-1530" name="line-1530"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="p">)</span>
<a id="line-1531" name="line-1531"></a><span class="w">    </span><span class="n">put_int</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">nval</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">);</span>
<a id="line-1532" name="line-1532"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-1533" name="line-1533"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<a id="line-1534" name="line-1534"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">neg</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
<a id="line-1535" name="line-1535"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1536" name="line-1536"></a><span class="w">  </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<a id="line-1537" name="line-1537"></a><span class="p">}</span>
<a id="line-1538" name="line-1538"></a>
<a id="line-1539" name="line-1539"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1540" name="line-1540"></a><span class="n">put_uint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">)</span>
<a id="line-1541" name="line-1541"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1542" name="line-1542"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="line-1543" name="line-1543"></a><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<a id="line-1544" name="line-1544"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">neg</span><span class="p">;</span>
<a id="line-1545" name="line-1545"></a><span class="p">{</span>
<a id="line-1546" name="line-1546"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="line-1547" name="line-1547"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="p">)</span>
<a id="line-1548" name="line-1548"></a><span class="w">    </span><span class="n">put_uint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">nval</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">);</span>
<a id="line-1549" name="line-1549"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-1550" name="line-1550"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<a id="line-1551" name="line-1551"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">neg</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
<a id="line-1552" name="line-1552"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1553" name="line-1553"></a><span class="w">  </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<a id="line-1554" name="line-1554"></a><span class="p">}</span>
<a id="line-1555" name="line-1555"></a>
<a id="line-1556" name="line-1556"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1557" name="line-1557"></a><span class="n">put_luint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">)</span>
<a id="line-1558" name="line-1558"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1559" name="line-1559"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="line-1560" name="line-1560"></a><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">width</span><span class="p">;</span>
<a id="line-1561" name="line-1561"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">neg</span><span class="p">;</span>
<a id="line-1562" name="line-1562"></a><span class="p">{</span>
<a id="line-1563" name="line-1563"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="line-1564" name="line-1564"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="p">)</span>
<a id="line-1565" name="line-1565"></a><span class="w">    </span><span class="n">put_luint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">nval</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">neg</span><span class="p">);</span>
<a id="line-1566" name="line-1566"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-1567" name="line-1567"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">width</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<a id="line-1568" name="line-1568"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">neg</span><span class="p">)</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
<a id="line-1569" name="line-1569"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1570" name="line-1570"></a><span class="w">  </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">nval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<a id="line-1571" name="line-1571"></a><span class="p">}</span>
<a id="line-1572" name="line-1572"></a>
<a id="line-1573" name="line-1573"></a><span class="kt">void</span><span class="w"> </span><span class="n">put_str</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-1574" name="line-1574"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1575" name="line-1575"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">segment</span><span class="p">;</span>
<a id="line-1576" name="line-1576"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-1577" name="line-1577"></a><span class="p">{</span>
<a id="line-1578" name="line-1578"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<a id="line-1579" name="line-1579"></a>
<a id="line-1580" name="line-1580"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1581" name="line-1581"></a><span class="w">    </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1582" name="line-1582"></a><span class="w">    </span><span class="n">offset</span><span class="o">++</span><span class="p">;</span>
<a id="line-1583" name="line-1583"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1584" name="line-1584"></a><span class="p">}</span>
<a id="line-1585" name="line-1585"></a>
<a id="line-1586" name="line-1586"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1587" name="line-1587"></a><span class="n">delay_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<a id="line-1588" name="line-1588"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ticks</span><span class="p">;</span>
<a id="line-1589" name="line-1589"></a><span class="p">{</span>
<a id="line-1590" name="line-1590"></a><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">ticks_to_wait</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<a id="line-1591" name="line-1591"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">prev_ticks</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<a id="line-1592" name="line-1592"></a>
<a id="line-1593" name="line-1593"></a><span class="w">   </span><span class="cm">/*</span>
<a id="line-1594" name="line-1594"></a><span class="cm">    * The 0:046c wraps around at &#39;midnight&#39; according to a 18.2Hz clock.</span>
<a id="line-1595" name="line-1595"></a><span class="cm">    * We also have to be careful about interrupt storms.</span>
<a id="line-1596" name="line-1596"></a><span class="cm">    */</span>
<a id="line-1597" name="line-1597"></a><span class="n">ASM_START</span>
<a id="line-1598" name="line-1598"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-1599" name="line-1599"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-1600" name="line-1600"></a><span class="n">ASM_END</span>
<a id="line-1601" name="line-1601"></a><span class="w">  </span><span class="n">ticks_to_wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ticks</span><span class="p">;</span>
<a id="line-1602" name="line-1602"></a><span class="w">  </span><span class="n">prev_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x46c</span><span class="p">);</span>
<a id="line-1603" name="line-1603"></a><span class="w">  </span><span class="k">do</span>
<a id="line-1604" name="line-1604"></a><span class="w">  </span><span class="p">{</span>
<a id="line-1605" name="line-1605"></a><span class="n">ASM_START</span>
<a id="line-1606" name="line-1606"></a><span class="w">    </span><span class="n">hlt</span>
<a id="line-1607" name="line-1607"></a><span class="n">ASM_END</span>
<a id="line-1608" name="line-1608"></a><span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x46c</span><span class="p">);</span>
<a id="line-1609" name="line-1609"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev_ticks</span><span class="p">)</span>
<a id="line-1610" name="line-1610"></a><span class="w">    </span><span class="p">{</span>
<a id="line-1611" name="line-1611"></a><span class="w">      </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_ticks</span><span class="p">;</span><span class="w">     </span><span class="cm">/* The temp var is required or bcc screws up. */</span>
<a id="line-1612" name="line-1612"></a><span class="w">      </span><span class="n">ticks_to_wait</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">delta</span><span class="p">;</span>
<a id="line-1613" name="line-1613"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1614" name="line-1614"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">prev_ticks</span><span class="p">)</span>
<a id="line-1615" name="line-1615"></a><span class="w">    </span><span class="p">{</span>
<a id="line-1616" name="line-1616"></a><span class="w">      </span><span class="n">ticks_to_wait</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">         </span><span class="cm">/* wrapped */</span>
<a id="line-1617" name="line-1617"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1618" name="line-1618"></a>
<a id="line-1619" name="line-1619"></a><span class="w">    </span><span class="n">prev_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<a id="line-1620" name="line-1620"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">ticks_to_wait</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1621" name="line-1621"></a><span class="n">ASM_START</span>
<a id="line-1622" name="line-1622"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-1623" name="line-1623"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-1624" name="line-1624"></a><span class="n">ASM_END</span>
<a id="line-1625" name="line-1625"></a><span class="p">}</span>
<a id="line-1626" name="line-1626"></a>
<a id="line-1627" name="line-1627"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-1628" name="line-1628"></a><span class="n">check_for_keystroke</span><span class="p">()</span>
<a id="line-1629" name="line-1629"></a><span class="p">{</span>
<a id="line-1630" name="line-1630"></a><span class="n">ASM_START</span>
<a id="line-1631" name="line-1631"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x100</span>
<a id="line-1632" name="line-1632"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x16</span>
<a id="line-1633" name="line-1633"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">no_key</span>
<a id="line-1634" name="line-1634"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-1635" name="line-1635"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">done</span>
<a id="line-1636" name="line-1636"></a><span class="nl">no_key</span><span class="p">:</span>
<a id="line-1637" name="line-1637"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1638" name="line-1638"></a><span class="nl">done</span><span class="p">:</span>
<a id="line-1639" name="line-1639"></a><span class="n">ASM_END</span>
<a id="line-1640" name="line-1640"></a><span class="p">}</span>
<a id="line-1641" name="line-1641"></a>
<a id="line-1642" name="line-1642"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-1643" name="line-1643"></a><span class="n">get_keystroke</span><span class="p">()</span>
<a id="line-1644" name="line-1644"></a><span class="p">{</span>
<a id="line-1645" name="line-1645"></a><span class="n">ASM_START</span>
<a id="line-1646" name="line-1646"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0</span>
<a id="line-1647" name="line-1647"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x16</span>
<a id="line-1648" name="line-1648"></a><span class="w">  </span><span class="n">xchg</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1649" name="line-1649"></a><span class="n">ASM_END</span>
<a id="line-1650" name="line-1650"></a><span class="p">}</span>
<a id="line-1651" name="line-1651"></a>
<a id="line-1652" name="line-1652"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1653" name="line-1653"></a><span class="n">delay_ticks_and_check_for_keystroke</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<a id="line-1654" name="line-1654"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-1655" name="line-1655"></a><span class="p">{</span>
<a id="line-1656" name="line-1656"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-1657" name="line-1657"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1658" name="line-1658"></a><span class="w">    </span><span class="n">delay_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">);</span>
<a id="line-1659" name="line-1659"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_for_keystroke</span><span class="p">())</span>
<a id="line-1660" name="line-1660"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-1661" name="line-1661"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1662" name="line-1662"></a><span class="p">}</span>
<a id="line-1663" name="line-1663"></a>
<a id="line-1664" name="line-1664"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1665" name="line-1665"></a><span class="c1">// bios_printf()</span>
<a id="line-1666" name="line-1666"></a><span class="c1">//   A compact variable argument printf function.</span>
<a id="line-1667" name="line-1667"></a><span class="c1">//</span>
<a id="line-1668" name="line-1668"></a><span class="c1">//   Supports %[format_width][length]format</span>
<a id="line-1669" name="line-1669"></a><span class="c1">//   where format can be x,X,u,d,s,S,c</span>
<a id="line-1670" name="line-1670"></a><span class="c1">//   and the optional length modifier is l (ell)</span>
<a id="line-1671" name="line-1671"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1672" name="line-1672"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1673" name="line-1673"></a><span class="n">bios_printf</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>
<a id="line-1674" name="line-1674"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<a id="line-1675" name="line-1675"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a id="line-1676" name="line-1676"></a><span class="p">{</span>
<a id="line-1677" name="line-1677"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">format_char</span><span class="p">;</span>
<a id="line-1678" name="line-1678"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w">  </span><span class="n">in_format</span><span class="p">;</span>
<a id="line-1679" name="line-1679"></a><span class="w">  </span><span class="kt">short</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-1680" name="line-1680"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="o">*</span><span class="n">arg_ptr</span><span class="p">;</span>
<a id="line-1681" name="line-1681"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">arg_seg</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">nibble</span><span class="p">,</span><span class="w"> </span><span class="n">hibyte</span><span class="p">,</span><span class="w"> </span><span class="n">shift_count</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="p">,</span><span class="w"> </span><span class="n">hexadd</span><span class="p">;</span>
<a id="line-1682" name="line-1682"></a>
<a id="line-1683" name="line-1683"></a><span class="w">  </span><span class="n">arg_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">;</span>
<a id="line-1684" name="line-1684"></a><span class="w">  </span><span class="n">arg_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-1685" name="line-1685"></a>
<a id="line-1686" name="line-1686"></a><span class="w">  </span><span class="n">in_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-1687" name="line-1687"></a><span class="w">  </span><span class="n">format_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-1688" name="line-1688"></a>
<a id="line-1689" name="line-1689"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">action</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIOS_PRINTF_DEBHALT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BIOS_PRINTF_DEBHALT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1690" name="line-1690"></a><span class="cp">#if BX_VIRTUAL_PORTS</span>
<a id="line-1691" name="line-1691"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">PANIC_PORT2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-1692" name="line-1692"></a><span class="cp">#endif</span>
<a id="line-1693" name="line-1693"></a><span class="w">    </span><span class="n">bios_printf</span><span class="w"> </span><span class="p">(</span><span class="n">BIOS_PRINTF_SCREEN</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FATAL: &quot;</span><span class="p">);</span>
<a id="line-1694" name="line-1694"></a><span class="w">  </span><span class="p">}</span>
<a id="line-1695" name="line-1695"></a>
<a id="line-1696" name="line-1696"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_CS</span><span class="p">(),</span><span class="w"> </span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1697" name="line-1697"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;%&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1698" name="line-1698"></a><span class="w">      </span><span class="n">in_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-1699" name="line-1699"></a><span class="w">      </span><span class="n">format_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-1700" name="line-1700"></a><span class="w">      </span><span class="p">}</span>
<a id="line-1701" name="line-1701"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_format</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1702" name="line-1702"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">&gt;=</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">&lt;=</span><span class="sc">&#39;9&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1703" name="line-1703"></a><span class="w">        </span><span class="n">format_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">format_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<a id="line-1704" name="line-1704"></a><span class="w">        </span><span class="p">}</span>
<a id="line-1705" name="line-1705"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-1706" name="line-1706"></a><span class="w">        </span><span class="n">arg_ptr</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">// increment to next arg</span>
<a id="line-1707" name="line-1707"></a><span class="w">        </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">arg_seg</span><span class="p">,</span><span class="w"> </span><span class="n">arg_ptr</span><span class="p">);</span>
<a id="line-1708" name="line-1708"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;x&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;X&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1709" name="line-1709"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">format_width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-1710" name="line-1710"></a><span class="w">            </span><span class="n">format_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-1711" name="line-1711"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;x&#39;</span><span class="p">)</span>
<a id="line-1712" name="line-1712"></a><span class="w">            </span><span class="n">hexadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="p">;</span>
<a id="line-1713" name="line-1713"></a><span class="w">          </span><span class="k">else</span>
<a id="line-1714" name="line-1714"></a><span class="w">            </span><span class="n">hexadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">;</span>
<a id="line-1715" name="line-1715"></a><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">format_width</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1716" name="line-1716"></a><span class="w">            </span><span class="n">nibble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000f</span><span class="p">;</span>
<a id="line-1717" name="line-1717"></a><span class="w">            </span><span class="n">send</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="o">&lt;=</span><span class="mi">9</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="o">+</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="mi">-10</span><span class="o">+</span><span class="n">hexadd</span><span class="p">));</span>
<a id="line-1718" name="line-1718"></a><span class="w">            </span><span class="p">}</span>
<a id="line-1719" name="line-1719"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1720" name="line-1720"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;u&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1721" name="line-1721"></a><span class="w">          </span><span class="n">put_uint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1722" name="line-1722"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1723" name="line-1723"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1724" name="line-1724"></a><span class="w">          </span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
<a id="line-1725" name="line-1725"></a><span class="w">          </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_CS</span><span class="p">(),</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"> </span><span class="cm">/* is it ld,lx,lu? */</span>
<a id="line-1726" name="line-1726"></a><span class="w">          </span><span class="n">arg_ptr</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="cm">/* increment to next arg */</span>
<a id="line-1727" name="line-1727"></a><span class="w">          </span><span class="n">hibyte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">arg_seg</span><span class="p">,</span><span class="w"> </span><span class="n">arg_ptr</span><span class="p">);</span>
<a id="line-1728" name="line-1728"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1729" name="line-1729"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hibyte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x8000</span><span class="p">)</span>
<a id="line-1730" name="line-1730"></a><span class="w">              </span><span class="n">put_luint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="o">-</span><span class="p">(((</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">hibyte</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">format_width</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-1731" name="line-1731"></a><span class="w">            </span><span class="k">else</span>
<a id="line-1732" name="line-1732"></a><span class="w">              </span><span class="n">put_luint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">hibyte</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1733" name="line-1733"></a><span class="w">           </span><span class="p">}</span>
<a id="line-1734" name="line-1734"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;u&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1735" name="line-1735"></a><span class="w">            </span><span class="n">put_luint</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">hibyte</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1736" name="line-1736"></a><span class="w">           </span><span class="p">}</span>
<a id="line-1737" name="line-1737"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;x&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;X&#39;</span><span class="p">)</span>
<a id="line-1738" name="line-1738"></a><span class="w">           </span><span class="p">{</span>
<a id="line-1739" name="line-1739"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">format_width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-1740" name="line-1740"></a><span class="w">              </span><span class="n">format_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-1741" name="line-1741"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;x&#39;</span><span class="p">)</span>
<a id="line-1742" name="line-1742"></a><span class="w">              </span><span class="n">hexadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="p">;</span>
<a id="line-1743" name="line-1743"></a><span class="w">            </span><span class="k">else</span>
<a id="line-1744" name="line-1744"></a><span class="w">              </span><span class="n">hexadd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">;</span>
<a id="line-1745" name="line-1745"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">format_width</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1746" name="line-1746"></a><span class="w">              </span><span class="n">nibble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">hibyte</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000f</span><span class="p">;</span>
<a id="line-1747" name="line-1747"></a><span class="w">              </span><span class="n">send</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="o">&lt;=</span><span class="mi">9</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="o">+</span><span class="sc">&#39;0&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">nibble</span><span class="mi">-10</span><span class="o">+</span><span class="n">hexadd</span><span class="p">));</span>
<a id="line-1748" name="line-1748"></a><span class="w">              </span><span class="p">}</span>
<a id="line-1749" name="line-1749"></a><span class="w">           </span><span class="p">}</span>
<a id="line-1750" name="line-1750"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1751" name="line-1751"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1752" name="line-1752"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x8000</span><span class="p">)</span>
<a id="line-1753" name="line-1753"></a><span class="w">            </span><span class="n">put_int</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-1754" name="line-1754"></a><span class="w">          </span><span class="k">else</span>
<a id="line-1755" name="line-1755"></a><span class="w">            </span><span class="n">put_int</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">format_width</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-1756" name="line-1756"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1757" name="line-1757"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1758" name="line-1758"></a><span class="w">          </span><span class="n">put_str</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">get_CS</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<a id="line-1759" name="line-1759"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1760" name="line-1760"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1761" name="line-1761"></a><span class="w">          </span><span class="n">hibyte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>
<a id="line-1762" name="line-1762"></a><span class="w">          </span><span class="n">arg_ptr</span><span class="o">++</span><span class="p">;</span>
<a id="line-1763" name="line-1763"></a><span class="w">          </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">arg_seg</span><span class="p">,</span><span class="w"> </span><span class="n">arg_ptr</span><span class="p">);</span>
<a id="line-1764" name="line-1764"></a><span class="w">          </span><span class="n">put_str</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">hibyte</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<a id="line-1765" name="line-1765"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1766" name="line-1766"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1767" name="line-1767"></a><span class="w">          </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<a id="line-1768" name="line-1768"></a><span class="w">          </span><span class="p">}</span>
<a id="line-1769" name="line-1769"></a><span class="w">        </span><span class="k">else</span>
<a id="line-1770" name="line-1770"></a><span class="w">          </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;bios_printf: unknown format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-1771" name="line-1771"></a><span class="w">          </span><span class="n">in_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-1772" name="line-1772"></a><span class="w">        </span><span class="p">}</span>
<a id="line-1773" name="line-1773"></a><span class="w">      </span><span class="p">}</span>
<a id="line-1774" name="line-1774"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-1775" name="line-1775"></a><span class="w">      </span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<a id="line-1776" name="line-1776"></a><span class="w">      </span><span class="p">}</span>
<a id="line-1777" name="line-1777"></a><span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
<a id="line-1778" name="line-1778"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1779" name="line-1779"></a>
<a id="line-1780" name="line-1780"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">BIOS_PRINTF_HALT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1781" name="line-1781"></a><span class="w">    </span><span class="c1">// freeze in a busy loop.</span>
<a id="line-1782" name="line-1782"></a><span class="n">ASM_START</span>
<a id="line-1783" name="line-1783"></a><span class="w">    </span><span class="n">cli</span>
<a id="line-1784" name="line-1784"></a><span class="w"> </span><span class="nl">halt2_loop</span><span class="p">:</span>
<a id="line-1785" name="line-1785"></a><span class="w">    </span><span class="n">hlt</span>
<a id="line-1786" name="line-1786"></a><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">halt2_loop</span>
<a id="line-1787" name="line-1787"></a><span class="n">ASM_END</span>
<a id="line-1788" name="line-1788"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1789" name="line-1789"></a><span class="p">}</span>
<a id="line-1790" name="line-1790"></a>
<a id="line-1791" name="line-1791"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1792" name="line-1792"></a><span class="c1">// keyboard_init</span>
<a id="line-1793" name="line-1793"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1794" name="line-1794"></a><span class="c1">// this file is based on LinuxBIOS implementation of keyboard.c</span>
<a id="line-1795" name="line-1795"></a><span class="c1">// could convert to #asm to gain space</span>
<a id="line-1796" name="line-1796"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1797" name="line-1797"></a><span class="n">keyboard_init</span><span class="p">()</span>
<a id="line-1798" name="line-1798"></a><span class="p">{</span>
<a id="line-1799" name="line-1799"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<a id="line-1800" name="line-1800"></a>
<a id="line-1801" name="line-1801"></a><span class="w">    </span><span class="cm">/* ------------------- Flush buffers ------------------------*/</span>
<a id="line-1802" name="line-1802"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1803" name="line-1803"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1804" name="line-1804"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-1805" name="line-1805"></a>
<a id="line-1806" name="line-1806"></a><span class="w">    </span><span class="cm">/* flush incoming keys */</span>
<a id="line-1807" name="line-1807"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<a id="line-1808" name="line-1808"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1809" name="line-1809"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-1810" name="line-1810"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-1811" name="line-1811"></a><span class="w">            </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-1812" name="line-1812"></a><span class="w">            </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-1813" name="line-1813"></a><span class="w">            </span><span class="p">}</span>
<a id="line-1814" name="line-1814"></a><span class="w">        </span><span class="p">}</span>
<a id="line-1815" name="line-1815"></a>
<a id="line-1816" name="line-1816"></a><span class="w">    </span><span class="c1">// Due to timer issues, and if the IPS setting is &gt; 15000000,</span>
<a id="line-1817" name="line-1817"></a><span class="w">    </span><span class="c1">// the incoming keys might not be flushed here. That will</span>
<a id="line-1818" name="line-1818"></a><span class="w">    </span><span class="c1">// cause a panic a few lines below.  See sourceforge bug report :</span>
<a id="line-1819" name="line-1819"></a><span class="w">    </span><span class="c1">// [ 642031 ] FATAL: Keyboard RESET error:993</span>
<a id="line-1820" name="line-1820"></a>
<a id="line-1821" name="line-1821"></a><span class="w">    </span><span class="cm">/* ------------------- controller side ----------------------*/</span>
<a id="line-1822" name="line-1822"></a><span class="w">    </span><span class="cm">/* send cmd = 0xAA, self test 8042 */</span>
<a id="line-1823" name="line-1823"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">);</span>
<a id="line-1824" name="line-1824"></a>
<a id="line-1825" name="line-1825"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1826" name="line-1826"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1827" name="line-1827"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-1828" name="line-1828"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mo">00</span><span class="p">);</span>
<a id="line-1829" name="line-1829"></a>
<a id="line-1830" name="line-1830"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1831" name="line-1831"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1832" name="line-1832"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-1833" name="line-1833"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mo">01</span><span class="p">);</span>
<a id="line-1834" name="line-1834"></a>
<a id="line-1835" name="line-1835"></a><span class="w">    </span><span class="cm">/* read self-test result, 0x55 should be returned from 0x60 */</span>
<a id="line-1836" name="line-1836"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x55</span><span class="p">)){</span>
<a id="line-1837" name="line-1837"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">991</span><span class="p">);</span>
<a id="line-1838" name="line-1838"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1839" name="line-1839"></a>
<a id="line-1840" name="line-1840"></a><span class="w">    </span><span class="cm">/* send cmd = 0xAB, keyboard interface test */</span>
<a id="line-1841" name="line-1841"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0xab</span><span class="p">);</span>
<a id="line-1842" name="line-1842"></a>
<a id="line-1843" name="line-1843"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1844" name="line-1844"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1845" name="line-1845"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-1846" name="line-1846"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a id="line-1847" name="line-1847"></a>
<a id="line-1848" name="line-1848"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1849" name="line-1849"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1850" name="line-1850"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">);</span>
<a id="line-1851" name="line-1851"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
<a id="line-1852" name="line-1852"></a>
<a id="line-1853" name="line-1853"></a><span class="w">    </span><span class="cm">/* read keyboard interface test result, */</span>
<a id="line-1854" name="line-1854"></a><span class="w">    </span><span class="cm">/* 0x00 should be returned form 0x60 */</span>
<a id="line-1855" name="line-1855"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1856" name="line-1856"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">992</span><span class="p">);</span>
<a id="line-1857" name="line-1857"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1858" name="line-1858"></a>
<a id="line-1859" name="line-1859"></a><span class="w">    </span><span class="cm">/* Enable Keyboard clock */</span>
<a id="line-1860" name="line-1860"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0xae</span><span class="p">);</span>
<a id="line-1861" name="line-1861"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">);</span>
<a id="line-1862" name="line-1862"></a>
<a id="line-1863" name="line-1863"></a><span class="w">    </span><span class="cm">/* ------------------- keyboard side ------------------------*/</span>
<a id="line-1864" name="line-1864"></a><span class="w">    </span><span class="cm">/* reset kerboard and self test  (keyboard side) */</span>
<a id="line-1865" name="line-1865"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-1866" name="line-1866"></a>
<a id="line-1867" name="line-1867"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1868" name="line-1868"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1869" name="line-1869"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span>
<a id="line-1870" name="line-1870"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<a id="line-1871" name="line-1871"></a>
<a id="line-1872" name="line-1872"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1873" name="line-1873"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1874" name="line-1874"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">);</span>
<a id="line-1875" name="line-1875"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
<a id="line-1876" name="line-1876"></a>
<a id="line-1877" name="line-1877"></a><span class="w">    </span><span class="cm">/* keyboard should return ACK */</span>
<a id="line-1878" name="line-1878"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1879" name="line-1879"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">993</span><span class="p">);</span>
<a id="line-1880" name="line-1880"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1881" name="line-1881"></a>
<a id="line-1882" name="line-1882"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1883" name="line-1883"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1884" name="line-1884"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">);</span>
<a id="line-1885" name="line-1885"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
<a id="line-1886" name="line-1886"></a>
<a id="line-1887" name="line-1887"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1888" name="line-1888"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">994</span><span class="p">);</span>
<a id="line-1889" name="line-1889"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1890" name="line-1890"></a>
<a id="line-1891" name="line-1891"></a><span class="w">    </span><span class="cm">/* Disable keyboard */</span>
<a id="line-1892" name="line-1892"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf5</span><span class="p">);</span>
<a id="line-1893" name="line-1893"></a>
<a id="line-1894" name="line-1894"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1895" name="line-1895"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1896" name="line-1896"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">);</span>
<a id="line-1897" name="line-1897"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
<a id="line-1898" name="line-1898"></a>
<a id="line-1899" name="line-1899"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1900" name="line-1900"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1901" name="line-1901"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x41</span><span class="p">);</span>
<a id="line-1902" name="line-1902"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">41</span><span class="p">);</span>
<a id="line-1903" name="line-1903"></a>
<a id="line-1904" name="line-1904"></a><span class="w">    </span><span class="cm">/* keyboard should return ACK */</span>
<a id="line-1905" name="line-1905"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1906" name="line-1906"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">995</span><span class="p">);</span>
<a id="line-1907" name="line-1907"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1908" name="line-1908"></a>
<a id="line-1909" name="line-1909"></a><span class="w">    </span><span class="cm">/* Write Keyboard Mode */</span>
<a id="line-1910" name="line-1910"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-1911" name="line-1911"></a>
<a id="line-1912" name="line-1912"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1913" name="line-1913"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1914" name="line-1914"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span><span class="p">);</span>
<a id="line-1915" name="line-1915"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<a id="line-1916" name="line-1916"></a>
<a id="line-1917" name="line-1917"></a><span class="w">    </span><span class="cm">/* send cmd: scan code convert, disable mouse, enable IRQ 1 */</span>
<a id="line-1918" name="line-1918"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x61</span><span class="p">);</span>
<a id="line-1919" name="line-1919"></a>
<a id="line-1920" name="line-1920"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1921" name="line-1921"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1922" name="line-1922"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-1923" name="line-1923"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
<a id="line-1924" name="line-1924"></a>
<a id="line-1925" name="line-1925"></a><span class="w">    </span><span class="cm">/* Enable keyboard */</span>
<a id="line-1926" name="line-1926"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf4</span><span class="p">);</span>
<a id="line-1927" name="line-1927"></a>
<a id="line-1928" name="line-1928"></a><span class="w">    </span><span class="cm">/* Wait until buffer is empty */</span>
<a id="line-1929" name="line-1929"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1930" name="line-1930"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">);</span>
<a id="line-1931" name="line-1931"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
<a id="line-1932" name="line-1932"></a>
<a id="line-1933" name="line-1933"></a><span class="w">    </span><span class="cm">/* Wait for data */</span>
<a id="line-1934" name="line-1934"></a><span class="w">    </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-1935" name="line-1935"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span><span class="p">);</span>
<a id="line-1936" name="line-1936"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">==</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
<a id="line-1937" name="line-1937"></a>
<a id="line-1938" name="line-1938"></a><span class="w">    </span><span class="cm">/* keyboard should return ACK */</span>
<a id="line-1939" name="line-1939"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-1940" name="line-1940"></a><span class="w">        </span><span class="n">keyboard_panic</span><span class="p">(</span><span class="mi">996</span><span class="p">);</span>
<a id="line-1941" name="line-1941"></a><span class="w">    </span><span class="p">}</span>
<a id="line-1942" name="line-1942"></a>
<a id="line-1943" name="line-1943"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x77</span><span class="p">);</span>
<a id="line-1944" name="line-1944"></a><span class="p">}</span>
<a id="line-1945" name="line-1945"></a>
<a id="line-1946" name="line-1946"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1947" name="line-1947"></a><span class="c1">// keyboard_panic</span>
<a id="line-1948" name="line-1948"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1949" name="line-1949"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1950" name="line-1950"></a><span class="n">keyboard_panic</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
<a id="line-1951" name="line-1951"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-1952" name="line-1952"></a><span class="p">{</span>
<a id="line-1953" name="line-1953"></a><span class="w">  </span><span class="c1">// If you&#39;re getting a 993 keyboard panic here,</span>
<a id="line-1954" name="line-1954"></a><span class="w">  </span><span class="c1">// please see the comment in keyboard_init</span>
<a id="line-1955" name="line-1955"></a>
<a id="line-1956" name="line-1956"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Keyboard error:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<a id="line-1957" name="line-1957"></a><span class="p">}</span>
<a id="line-1958" name="line-1958"></a>
<a id="line-1959" name="line-1959"></a><span class="cp">#define CMOS_SHUTDOWN_S3 0xFE</span>
<a id="line-1960" name="line-1960"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1961" name="line-1961"></a><span class="c1">// machine_reset</span>
<a id="line-1962" name="line-1962"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1963" name="line-1963"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-1964" name="line-1964"></a><span class="n">machine_reset</span><span class="p">()</span>
<a id="line-1965" name="line-1965"></a><span class="p">{</span>
<a id="line-1966" name="line-1966"></a><span class="n">ASM_START</span>
<a id="line-1967" name="line-1967"></a><span class="p">;</span><span class="n">we</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">whether</span><span class="w"> </span><span class="n">CMOS_SHUTDOWN_S3</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">not</span>
<a id="line-1968" name="line-1968"></a><span class="p">;</span><span class="k">if</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">s3</span><span class="w"> </span><span class="n">resume</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">Entry</span>
<a id="line-1969" name="line-1969"></a><span class="p">;</span><span class="n">below</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">s3</span><span class="w"> </span><span class="n">resume</span>
<a id="line-1970" name="line-1970"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span>
<a id="line-1971" name="line-1971"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-1972" name="line-1972"></a><span class="w">  </span><span class="n">in</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span>
<a id="line-1973" name="line-1973"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xFE</span>
<a id="line-1974" name="line-1974"></a><span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">post</span>
<a id="line-1975" name="line-1975"></a><span class="n">ASM_END</span>
<a id="line-1976" name="line-1976"></a><span class="w">  </span><span class="cm">/* Frob the keyboard reset line to reset the processor */</span>
<a id="line-1977" name="line-1977"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Map the flags register at data port (0x60) */</span>
<a id="line-1978" name="line-1978"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x14</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Set the flags to system|disable */</span>
<a id="line-1979" name="line-1979"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Pulse output 0 (system reset) low */</span>
<a id="line-1980" name="line-1980"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t reset the machine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-1981" name="line-1981"></a><span class="p">}</span>
<a id="line-1982" name="line-1982"></a>
<a id="line-1983" name="line-1983"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1984" name="line-1984"></a><span class="c1">// clobber_entry_point</span>
<a id="line-1985" name="line-1985"></a><span class="c1">//    Because PV drivers in HVM guests detach some of the emulated devices, </span>
<a id="line-1986" name="line-1986"></a><span class="c1">//    it is not safe to do a soft reboot by just dropping to real mode and</span>
<a id="line-1987" name="line-1987"></a><span class="c1">//    jumping at ffff:0000. -- the boot drives might have disappeared!</span>
<a id="line-1988" name="line-1988"></a><span class="c1">//    This rather foul function overwrites(!) the BIOS entry point </span>
<a id="line-1989" name="line-1989"></a><span class="c1">//    to point at machine-reset, which will cause the Xen tools to</span>
<a id="line-1990" name="line-1990"></a><span class="c1">//    rebuild the whole machine from scratch.</span>
<a id="line-1991" name="line-1991"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-1992" name="line-1992"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span>
<a id="line-1993" name="line-1993"></a><span class="n">clobber_entry_point</span><span class="p">()</span><span class="w"> </span>
<a id="line-1994" name="line-1994"></a><span class="p">{</span>
<a id="line-1995" name="line-1995"></a><span class="w">    </span><span class="cm">/* The instruction at the entry point is one byte (0xea) for the</span>
<a id="line-1996" name="line-1996"></a><span class="cm">     * jump opcode, then two bytes of address, then two of segment. </span>
<a id="line-1997" name="line-1997"></a><span class="cm">     * Overwrite the address bytes.*/</span>
<a id="line-1998" name="line-1998"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0001</span><span class="p">,</span><span class="w"> </span><span class="n">machine_reset</span><span class="p">);</span><span class="w"> </span>
<a id="line-1999" name="line-1999"></a><span class="p">}</span>
<a id="line-2000" name="line-2000"></a>
<a id="line-2001" name="line-2001"></a>
<a id="line-2002" name="line-2002"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2003" name="line-2003"></a><span class="c1">// shutdown_status_panic</span>
<a id="line-2004" name="line-2004"></a><span class="c1">//   called when the shutdown statsu is not implemented, displays the status</span>
<a id="line-2005" name="line-2005"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2006" name="line-2006"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2007" name="line-2007"></a><span class="n">shutdown_status_panic</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
<a id="line-2008" name="line-2008"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-2009" name="line-2009"></a><span class="p">{</span>
<a id="line-2010" name="line-2010"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Unimplemented shutdown status: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="n">Bit8u</span><span class="p">)</span><span class="n">status</span><span class="p">);</span>
<a id="line-2011" name="line-2011"></a><span class="p">}</span>
<a id="line-2012" name="line-2012"></a>
<a id="line-2013" name="line-2013"></a><span class="kt">void</span><span class="w"> </span><span class="n">s3_resume_panic</span><span class="p">()</span>
<a id="line-2014" name="line-2014"></a><span class="p">{</span>
<a id="line-2015" name="line-2015"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Returned from s3_resume.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2016" name="line-2016"></a><span class="p">}</span>
<a id="line-2017" name="line-2017"></a>
<a id="line-2018" name="line-2018"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2019" name="line-2019"></a><span class="c1">// print_bios_banner</span>
<a id="line-2020" name="line-2020"></a><span class="c1">//   displays a the bios version</span>
<a id="line-2021" name="line-2021"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2022" name="line-2022"></a><span class="kt">void</span>
<a id="line-2023" name="line-2023"></a><span class="n">print_bios_banner</span><span class="p">()</span>
<a id="line-2024" name="line-2024"></a><span class="p">{</span>
<a id="line-2025" name="line-2025"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="n">BX_APPNAME</span><span class="s">&quot; BIOS - build: %s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">Options: &quot;</span><span class="p">,</span>
<a id="line-2026" name="line-2026"></a><span class="w">    </span><span class="n">BIOS_BUILD_DATE</span><span class="p">,</span><span class="w"> </span><span class="n">bios_cvs_version_string</span><span class="p">);</span>
<a id="line-2027" name="line-2027"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span>
<a id="line-2028" name="line-2028"></a><span class="hll"><span class="cp">#if BX_APM</span><span class="error2">&lt;--- failed to expand 'printf', it is invalid to use a preprocessor directive as macro parameter</span>
</span><a id="line-2029" name="line-2029"></a><span class="w">  </span><span class="s">&quot;apmbios &quot;</span>
<a id="line-2030" name="line-2030"></a><span class="cp">#endif</span>
<a id="line-2031" name="line-2031"></a><span class="cp">#if BX_PCIBIOS</span>
<a id="line-2032" name="line-2032"></a><span class="w">  </span><span class="s">&quot;pcibios &quot;</span>
<a id="line-2033" name="line-2033"></a><span class="cp">#endif</span>
<a id="line-2034" name="line-2034"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-2035" name="line-2035"></a><span class="w">  </span><span class="s">&quot;eltorito &quot;</span>
<a id="line-2036" name="line-2036"></a><span class="cp">#endif</span>
<a id="line-2037" name="line-2037"></a><span class="cp">#if BX_ROMBIOS32</span>
<a id="line-2038" name="line-2038"></a><span class="w">  </span><span class="s">&quot;rombios32 &quot;</span>
<a id="line-2039" name="line-2039"></a><span class="cp">#endif</span>
<a id="line-2040" name="line-2040"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-2041" name="line-2041"></a><span class="w">  </span><span class="s">&quot;TCG-enabled &quot;</span>
<a id="line-2042" name="line-2042"></a><span class="cp">#endif</span>
<a id="line-2043" name="line-2043"></a><span class="cp">#if BX_PMM</span>
<a id="line-2044" name="line-2044"></a><span class="w">  </span><span class="s">&quot;PMM &quot;</span>
<a id="line-2045" name="line-2045"></a><span class="cp">#endif</span>
<a id="line-2046" name="line-2046"></a><span class="w">  </span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2047" name="line-2047"></a><span class="p">}</span>
<a id="line-2048" name="line-2048"></a>
<a id="line-2049" name="line-2049"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2050" name="line-2050"></a><span class="c1">// BIOS Boot Specification 1.0.1 compatibility</span>
<a id="line-2051" name="line-2051"></a><span class="c1">//</span>
<a id="line-2052" name="line-2052"></a><span class="c1">// Very basic support for the BIOS Boot Specification, which allows expansion</span>
<a id="line-2053" name="line-2053"></a><span class="c1">// ROMs to register themselves as boot devices, instead of just stealing the</span>
<a id="line-2054" name="line-2054"></a><span class="c1">// INT 19h boot vector.</span>
<a id="line-2055" name="line-2055"></a><span class="c1">//</span>
<a id="line-2056" name="line-2056"></a><span class="c1">// This is a hack: to do it properly requires a proper PnP BIOS and we aren&#39;t</span>
<a id="line-2057" name="line-2057"></a><span class="c1">// one; we just lie to the option ROMs to make them behave correctly.</span>
<a id="line-2058" name="line-2058"></a><span class="c1">// We also don&#39;t support letting option ROMs register as bootable disk</span>
<a id="line-2059" name="line-2059"></a><span class="c1">// drives (BCVs), only as bootable devices (BEVs).</span>
<a id="line-2060" name="line-2060"></a><span class="c1">//</span>
<a id="line-2061" name="line-2061"></a><span class="c1">// http://www.phoenix.com/en/Customer+Services/White+Papers-Specs/pc+industry+specifications.htm</span>
<a id="line-2062" name="line-2062"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2063" name="line-2063"></a>
<a id="line-2064" name="line-2064"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">drivetypes</span><span class="p">[][</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Floppy&quot;</span><span class="p">,</span><span class="s">&quot;Hard Disk&quot;</span><span class="p">,</span><span class="s">&quot;CD-Rom&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Network&quot;</span><span class="p">};</span>
<a id="line-2065" name="line-2065"></a>
<a id="line-2066" name="line-2066"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<a id="line-2067" name="line-2067"></a><span class="nf">init_boot_vectors</span><span class="p">()</span>
<a id="line-2068" name="line-2068"></a><span class="p">{</span>
<a id="line-2069" name="line-2069"></a><span class="w">  </span><span class="n">ipl_entry_t</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="line-2070" name="line-2070"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2071" name="line-2071"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-2072" name="line-2072"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2073" name="line-2073"></a>
<a id="line-2074" name="line-2074"></a><span class="w">  </span><span class="cm">/* Clear out the IPL table. */</span>
<a id="line-2075" name="line-2075"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_SIZE</span><span class="p">);</span>
<a id="line-2076" name="line-2076"></a>
<a id="line-2077" name="line-2077"></a><span class="w">  </span><span class="cm">/* User selected device not set */</span>
<a id="line-2078" name="line-2078"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_BOOTFIRST_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">);</span>
<a id="line-2079" name="line-2079"></a>
<a id="line-2080" name="line-2080"></a><span class="w">  </span><span class="cm">/* Floppy drive */</span>
<a id="line-2081" name="line-2081"></a><span class="w">  </span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IPL_TYPE_FLOPPY</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2082" name="line-2082"></a><span class="w">  </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<a id="line-2083" name="line-2083"></a><span class="w">  </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a id="line-2084" name="line-2084"></a>
<a id="line-2085" name="line-2085"></a><span class="w">  </span><span class="cm">/* First HDD */</span>
<a id="line-2086" name="line-2086"></a><span class="w">  </span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IPL_TYPE_HARDDISK</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2087" name="line-2087"></a><span class="w">  </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<a id="line-2088" name="line-2088"></a><span class="w">  </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a id="line-2089" name="line-2089"></a>
<a id="line-2090" name="line-2090"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-2091" name="line-2091"></a><span class="w">  </span><span class="cm">/* CDROM */</span>
<a id="line-2092" name="line-2092"></a><span class="w">  </span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IPL_TYPE_CDROM</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2093" name="line-2093"></a><span class="w">  </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<a id="line-2094" name="line-2094"></a><span class="w">  </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a id="line-2095" name="line-2095"></a><span class="cp">#endif</span>
<a id="line-2096" name="line-2096"></a>
<a id="line-2097" name="line-2097"></a><span class="w">  </span><span class="cm">/* Remember how many devices we have */</span>
<a id="line-2098" name="line-2098"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_COUNT_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="line-2099" name="line-2099"></a><span class="w">  </span><span class="cm">/* Not tried booting anything yet */</span>
<a id="line-2100" name="line-2100"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_SEQUENCE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">);</span>
<a id="line-2101" name="line-2101"></a><span class="p">}</span>
<a id="line-2102" name="line-2102"></a>
<a id="line-2103" name="line-2103"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span>
<a id="line-2104" name="line-2104"></a><span class="nf">get_boot_vector</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a id="line-2105" name="line-2105"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">ipl_entry_t</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="p">;</span>
<a id="line-2106" name="line-2106"></a><span class="p">{</span>
<a id="line-2107" name="line-2107"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-2108" name="line-2108"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-2109" name="line-2109"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2110" name="line-2110"></a><span class="w">  </span><span class="cm">/* Get the count of boot devices, and refuse to overrun the array */</span>
<a id="line-2111" name="line-2111"></a><span class="w">  </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_COUNT_OFFSET</span><span class="p">);</span>
<a id="line-2112" name="line-2112"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2113" name="line-2113"></a><span class="w">  </span><span class="cm">/* OK to read this device */</span>
<a id="line-2114" name="line-2114"></a><span class="w">  </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
<a id="line-2115" name="line-2115"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2116" name="line-2116"></a><span class="p">}</span>
<a id="line-2117" name="line-2117"></a>
<a id="line-2118" name="line-2118"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-2119" name="line-2119"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2120" name="line-2120"></a><span class="n">interactive_bootkey</span><span class="p">()</span>
<a id="line-2121" name="line-2121"></a><span class="p">{</span>
<a id="line-2122" name="line-2122"></a><span class="w">  </span><span class="n">ipl_entry_t</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="line-2123" name="line-2123"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-2124" name="line-2124"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">description</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
<a id="line-2125" name="line-2125"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">scan_code</span><span class="p">;</span>
<a id="line-2126" name="line-2126"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-2127" name="line-2127"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-2128" name="line-2128"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">valid_choice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2129" name="line-2129"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2130" name="line-2130"></a>
<a id="line-2131" name="line-2131"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Press F12 for boot menu.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2132" name="line-2132"></a>
<a id="line-2133" name="line-2133"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">check_for_keystroke</span><span class="p">())</span>
<a id="line-2134" name="line-2134"></a><span class="w">  </span><span class="p">{</span>
<a id="line-2135" name="line-2135"></a><span class="w">    </span><span class="n">scan_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_keystroke</span><span class="p">();</span>
<a id="line-2136" name="line-2136"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x86</span><span class="p">)</span><span class="w"> </span><span class="cm">/* F12 */</span>
<a id="line-2137" name="line-2137"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<a id="line-2138" name="line-2138"></a>
<a id="line-2139" name="line-2139"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">check_for_keystroke</span><span class="p">())</span>
<a id="line-2140" name="line-2140"></a><span class="w">      </span><span class="n">get_keystroke</span><span class="p">();</span>
<a id="line-2141" name="line-2141"></a>
<a id="line-2142" name="line-2142"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Select boot device:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2143" name="line-2143"></a>
<a id="line-2144" name="line-2144"></a><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_COUNT_OFFSET</span><span class="p">);</span>
<a id="line-2145" name="line-2145"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="line-2146" name="line-2146"></a><span class="w">    </span><span class="p">{</span>
<a id="line-2147" name="line-2147"></a><span class="w">      </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_TABLE_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<a id="line-2148" name="line-2148"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d. &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="line-2149" name="line-2149"></a><span class="w">      </span><span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
<a id="line-2150" name="line-2150"></a><span class="w">      </span><span class="p">{</span>
<a id="line-2151" name="line-2151"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_FLOPPY</span><span class="p">:</span>
<a id="line-2152" name="line-2152"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_HARDDISK</span><span class="p">:</span>
<a id="line-2153" name="line-2153"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_CDROM</span><span class="p">:</span>
<a id="line-2154" name="line-2154"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">drivetypes</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">]);</span>
<a id="line-2155" name="line-2155"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2156" name="line-2156"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_BEV</span><span class="p">:</span>
<a id="line-2157" name="line-2157"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">drivetypes</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<a id="line-2158" name="line-2158"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-2159" name="line-2159"></a><span class="w">          </span><span class="p">{</span>
<a id="line-2160" name="line-2160"></a><span class="w">            </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">),</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="line-2161" name="line-2161"></a><span class="w">            </span><span class="n">description</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2162" name="line-2162"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; [%S]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<a id="line-2163" name="line-2163"></a><span class="w">         </span><span class="p">}</span>
<a id="line-2164" name="line-2164"></a><span class="w">         </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2165" name="line-2165"></a><span class="w">         </span><span class="k">break</span><span class="p">;</span>
<a id="line-2166" name="line-2166"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2167" name="line-2167"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2168" name="line-2168"></a>
<a id="line-2169" name="line-2169"></a><span class="w">    </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a id="line-2170" name="line-2170"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">valid_choice</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2171" name="line-2171"></a><span class="w">      </span><span class="n">scan_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_keystroke</span><span class="p">();</span>
<a id="line-2172" name="line-2172"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">scan_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x58</span><span class="p">)</span><span class="w"> </span><span class="cm">/* ESC or F12 */</span>
<a id="line-2173" name="line-2173"></a><span class="w">      </span><span class="p">{</span>
<a id="line-2174" name="line-2174"></a><span class="w">        </span><span class="n">valid_choice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2175" name="line-2175"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2176" name="line-2176"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<a id="line-2177" name="line-2177"></a><span class="w">      </span><span class="p">{</span>
<a id="line-2178" name="line-2178"></a><span class="w">        </span><span class="n">valid_choice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2179" name="line-2179"></a><span class="w">        </span><span class="n">scan_code</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2180" name="line-2180"></a><span class="w">        </span><span class="cm">/* Set user selected device */</span>
<a id="line-2181" name="line-2181"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_BOOTFIRST_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">scan_code</span><span class="p">);</span>
<a id="line-2182" name="line-2182"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2183" name="line-2183"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2184" name="line-2184"></a>
<a id="line-2185" name="line-2185"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2186" name="line-2186"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<a id="line-2187" name="line-2187"></a><span class="w">  </span><span class="p">}</span>
<a id="line-2188" name="line-2188"></a><span class="p">}</span>
<a id="line-2189" name="line-2189"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-2190" name="line-2190"></a>
<a id="line-2191" name="line-2191"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2192" name="line-2192"></a><span class="c1">// print_boot_device</span>
<a id="line-2193" name="line-2193"></a><span class="c1">//   displays the boot device</span>
<a id="line-2194" name="line-2194"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2195" name="line-2195"></a>
<a id="line-2196" name="line-2196"></a><span class="kt">void</span>
<a id="line-2197" name="line-2197"></a><span class="n">print_boot_device</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span>
<a id="line-2198" name="line-2198"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span>
<a id="line-2199" name="line-2199"></a><span class="p">{</span>
<a id="line-2200" name="line-2200"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">description</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
<a id="line-2201" name="line-2201"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-2202" name="line-2202"></a><span class="w">  </span><span class="cm">/* NIC appears as type 0x80 */</span>
<a id="line-2203" name="line-2203"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IPL_TYPE_BEV</span><span class="p">)</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4</span><span class="p">;</span>
<a id="line-2204" name="line-2204"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x4</span><span class="p">)</span><span class="w"> </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Bad drive type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2205" name="line-2205"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Booting from %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">drivetypes</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<a id="line-2206" name="line-2206"></a><span class="w">  </span><span class="cm">/* print product string if BEV */</span>
<a id="line-2207" name="line-2207"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2208" name="line-2208"></a><span class="w">    </span><span class="cm">/* first 32 bytes are significant */</span>
<a id="line-2209" name="line-2209"></a><span class="w">    </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">desc</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">desc</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">),</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<a id="line-2210" name="line-2210"></a><span class="w">    </span><span class="cm">/* terminate string */</span>
<a id="line-2211" name="line-2211"></a><span class="w">    </span><span class="n">description</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2212" name="line-2212"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; [%S]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">);</span>
<a id="line-2213" name="line-2213"></a><span class="w">  </span><span class="p">}</span>
<a id="line-2214" name="line-2214"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2215" name="line-2215"></a><span class="p">}</span>
<a id="line-2216" name="line-2216"></a>
<a id="line-2217" name="line-2217"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2218" name="line-2218"></a><span class="c1">// print_boot_failure</span>
<a id="line-2219" name="line-2219"></a><span class="c1">//   displays the reason why boot failed</span>
<a id="line-2220" name="line-2220"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2221" name="line-2221"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2222" name="line-2222"></a><span class="n">print_boot_failure</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span>
<a id="line-2223" name="line-2223"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<a id="line-2224" name="line-2224"></a><span class="p">{</span>
<a id="line-2225" name="line-2225"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x3</span><span class="p">)</span><span class="w"> </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Bad drive type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2226" name="line-2226"></a>
<a id="line-2227" name="line-2227"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Boot from %s failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">drivetypes</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<a id="line-2228" name="line-2228"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2229" name="line-2229"></a><span class="w">    </span><span class="cm">/* Report the reason too */</span>
<a id="line-2230" name="line-2230"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reason</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<a id="line-2231" name="line-2231"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;: not a bootable disk&quot;</span><span class="p">);</span>
<a id="line-2232" name="line-2232"></a><span class="w">    </span><span class="k">else</span>
<a id="line-2233" name="line-2233"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;: could not read the boot disk&quot;</span><span class="p">);</span>
<a id="line-2234" name="line-2234"></a><span class="w">  </span><span class="p">}</span>
<a id="line-2235" name="line-2235"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2236" name="line-2236"></a><span class="p">}</span>
<a id="line-2237" name="line-2237"></a>
<a id="line-2238" name="line-2238"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2239" name="line-2239"></a><span class="c1">// print_cdromboot_failure</span>
<a id="line-2240" name="line-2240"></a><span class="c1">//   displays the reason why boot failed</span>
<a id="line-2241" name="line-2241"></a><span class="c1">//--------------------------------------------------------------------------</span>
<a id="line-2242" name="line-2242"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2243" name="line-2243"></a><span class="n">print_cdromboot_failure</span><span class="p">(</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="p">)</span>
<a id="line-2244" name="line-2244"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">code</span><span class="p">;</span>
<a id="line-2245" name="line-2245"></a><span class="p">{</span>
<a id="line-2246" name="line-2246"></a><span class="w">  </span><span class="n">bios_printf</span><span class="p">(</span><span class="n">BIOS_PRINTF_SCREEN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">BIOS_PRINTF_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CDROM boot failure code : %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">code</span><span class="p">);</span>
<a id="line-2247" name="line-2247"></a>
<a id="line-2248" name="line-2248"></a><span class="w">  </span><span class="k">return</span><span class="p">;</span>
<a id="line-2249" name="line-2249"></a><span class="p">}</span>
<a id="line-2250" name="line-2250"></a>
<a id="line-2251" name="line-2251"></a><span class="kt">void</span>
<a id="line-2252" name="line-2252"></a><span class="n">nmi_handler_msg</span><span class="p">()</span>
<a id="line-2253" name="line-2253"></a><span class="p">{</span>
<a id="line-2254" name="line-2254"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;NMI Handler called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2255" name="line-2255"></a><span class="p">}</span>
<a id="line-2256" name="line-2256"></a>
<a id="line-2257" name="line-2257"></a><span class="kt">void</span>
<a id="line-2258" name="line-2258"></a><span class="n">int18_panic_msg</span><span class="p">()</span>
<a id="line-2259" name="line-2259"></a><span class="p">{</span>
<a id="line-2260" name="line-2260"></a><span class="w">  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;INT18: BOOT FAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2261" name="line-2261"></a><span class="p">}</span>
<a id="line-2262" name="line-2262"></a>
<a id="line-2263" name="line-2263"></a><span class="kt">void</span>
<a id="line-2264" name="line-2264"></a><span class="n">log_bios_start</span><span class="p">()</span>
<a id="line-2265" name="line-2265"></a><span class="p">{</span>
<a id="line-2266" name="line-2266"></a><span class="cp">#if BX_DEBUG_SERIAL</span>
<a id="line-2267" name="line-2267"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">BX_DEBUG_PORT</span><span class="o">+</span><span class="n">UART_LCR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">);</span><span class="w"> </span><span class="cm">/* setup for serial logging: 8N1 */</span>
<a id="line-2268" name="line-2268"></a><span class="cp">#endif</span>
<a id="line-2269" name="line-2269"></a><span class="w">  </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bios_cvs_version_string</span><span class="p">);</span>
<a id="line-2270" name="line-2270"></a><span class="p">}</span>
<a id="line-2271" name="line-2271"></a>
<a id="line-2272" name="line-2272"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-2273" name="line-2273"></a><span class="n">set_enable_a20</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="line-2274" name="line-2274"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<a id="line-2275" name="line-2275"></a><span class="p">{</span>
<a id="line-2276" name="line-2276"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">oldval</span><span class="p">;</span>
<a id="line-2277" name="line-2277"></a>
<a id="line-2278" name="line-2278"></a><span class="w">  </span><span class="c1">// Use PS2 System Control port A to set A20 enable</span>
<a id="line-2279" name="line-2279"></a>
<a id="line-2280" name="line-2280"></a><span class="w">  </span><span class="c1">// get current setting first</span>
<a id="line-2281" name="line-2281"></a><span class="w">  </span><span class="n">oldval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x92</span><span class="p">);</span>
<a id="line-2282" name="line-2282"></a>
<a id="line-2283" name="line-2283"></a><span class="w">  </span><span class="c1">// change A20 status</span>
<a id="line-2284" name="line-2284"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="line-2285" name="line-2285"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x92</span><span class="p">,</span><span class="w"> </span><span class="n">oldval</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-2286" name="line-2286"></a><span class="w">  </span><span class="k">else</span>
<a id="line-2287" name="line-2287"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x92</span><span class="p">,</span><span class="w"> </span><span class="n">oldval</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xfd</span><span class="p">);</span>
<a id="line-2288" name="line-2288"></a>
<a id="line-2289" name="line-2289"></a><span class="w">  </span><span class="k">return</span><span class="p">((</span><span class="n">oldval</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-2290" name="line-2290"></a><span class="p">}</span>
<a id="line-2291" name="line-2291"></a>
<a id="line-2292" name="line-2292"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2293" name="line-2293"></a><span class="n">debugger_on</span><span class="p">()</span>
<a id="line-2294" name="line-2294"></a><span class="p">{</span>
<a id="line-2295" name="line-2295"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0xfedc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-2296" name="line-2296"></a><span class="p">}</span>
<a id="line-2297" name="line-2297"></a>
<a id="line-2298" name="line-2298"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-2299" name="line-2299"></a><span class="n">debugger_off</span><span class="p">()</span>
<a id="line-2300" name="line-2300"></a><span class="p">{</span>
<a id="line-2301" name="line-2301"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0xfedc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2302" name="line-2302"></a><span class="p">}</span>
<a id="line-2303" name="line-2303"></a>
<a id="line-2304" name="line-2304"></a><span class="kt">int</span>
<a id="line-2305" name="line-2305"></a><span class="n">s3_resume</span><span class="p">()</span>
<a id="line-2306" name="line-2306"></a><span class="p">{</span>
<a id="line-2307" name="line-2307"></a><span class="w">    </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">s3_wakeup_vector</span><span class="p">;</span>
<a id="line-2308" name="line-2308"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">s3_resume_flag</span><span class="p">;</span>
<a id="line-2309" name="line-2309"></a>
<a id="line-2310" name="line-2310"></a><span class="w">    </span><span class="n">s3_resume_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">);</span>
<a id="line-2311" name="line-2311"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-2312" name="line-2312"></a><span class="w">    </span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_s3_waking_vector</span><span class="p">();</span>
<a id="line-2313" name="line-2313"></a><span class="cp">#else</span>
<a id="line-2314" name="line-2314"></a><span class="w">    </span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb2</span><span class="p">);</span>
<a id="line-2315" name="line-2315"></a><span class="cp">#endif</span>
<a id="line-2316" name="line-2316"></a>
<a id="line-2317" name="line-2317"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;S3 resume called %x 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s3_resume_flag</span><span class="p">,</span><span class="w"> </span><span class="n">s3_wakeup_vector</span><span class="p">);</span>
<a id="line-2318" name="line-2318"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s3_resume_flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CMOS_SHUTDOWN_S3</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">s3_wakeup_vector</span><span class="p">)</span>
<a id="line-2319" name="line-2319"></a><span class="w">	    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2320" name="line-2320"></a>
<a id="line-2321" name="line-2321"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-2322" name="line-2322"></a>
<a id="line-2323" name="line-2323"></a><span class="w">    </span><span class="cm">/* setup wakeup vector */</span>
<a id="line-2324" name="line-2324"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb6</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xF</span><span class="p">));</span><span class="w"> </span><span class="cm">/* IP */</span>
<a id="line-2325" name="line-2325"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span><span class="w"> </span><span class="cm">/* CS */</span>
<a id="line-2326" name="line-2326"></a>
<a id="line-2327" name="line-2327"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;S3 resume jump to %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span>
<a id="line-2328" name="line-2328"></a><span class="w">		    </span><span class="p">(</span><span class="n">s3_wakeup_vector</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xF</span><span class="p">));</span>
<a id="line-2329" name="line-2329"></a><span class="n">ASM_START</span>
<a id="line-2330" name="line-2330"></a><span class="w">    </span><span class="n">jmpf</span><span class="w"> </span><span class="p">[</span><span class="mh">0x04b6</span><span class="p">]</span>
<a id="line-2331" name="line-2331"></a><span class="n">ASM_END</span>
<a id="line-2332" name="line-2332"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2333" name="line-2333"></a><span class="p">}</span>
<a id="line-2334" name="line-2334"></a>
<a id="line-2335" name="line-2335"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-2336" name="line-2336"></a>
<a id="line-2337" name="line-2337"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2338" name="line-2338"></a><span class="c1">// Start of ATA/ATAPI Driver</span>
<a id="line-2339" name="line-2339"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2340" name="line-2340"></a>
<a id="line-2341" name="line-2341"></a><span class="c1">// Global defines -- ATA register and register bits.</span>
<a id="line-2342" name="line-2342"></a><span class="c1">// command block &amp; control block regs</span>
<a id="line-2343" name="line-2343"></a><span class="cp">#define ATA_CB_DATA  0   </span><span class="c1">// data reg         in/out pio_base_addr1+0</span>
<a id="line-2344" name="line-2344"></a><span class="cp">#define ATA_CB_ERR   1   </span><span class="c1">// error            in     pio_base_addr1+1</span>
<a id="line-2345" name="line-2345"></a><span class="cp">#define ATA_CB_FR    1   </span><span class="c1">// feature reg         out pio_base_addr1+1</span>
<a id="line-2346" name="line-2346"></a><span class="cp">#define ATA_CB_SC    2   </span><span class="c1">// sector count     in/out pio_base_addr1+2</span>
<a id="line-2347" name="line-2347"></a><span class="cp">#define ATA_CB_SN    3   </span><span class="c1">// sector number    in/out pio_base_addr1+3</span>
<a id="line-2348" name="line-2348"></a><span class="cp">#define ATA_CB_CL    4   </span><span class="c1">// cylinder low     in/out pio_base_addr1+4</span>
<a id="line-2349" name="line-2349"></a><span class="cp">#define ATA_CB_CH    5   </span><span class="c1">// cylinder high    in/out pio_base_addr1+5</span>
<a id="line-2350" name="line-2350"></a><span class="cp">#define ATA_CB_DH    6   </span><span class="c1">// device head      in/out pio_base_addr1+6</span>
<a id="line-2351" name="line-2351"></a><span class="cp">#define ATA_CB_STAT  7   </span><span class="c1">// primary status   in     pio_base_addr1+7</span>
<a id="line-2352" name="line-2352"></a><span class="cp">#define ATA_CB_CMD   7   </span><span class="c1">// command             out pio_base_addr1+7</span>
<a id="line-2353" name="line-2353"></a><span class="cp">#define ATA_CB_ASTAT 6   </span><span class="c1">// alternate status in     pio_base_addr2+6</span>
<a id="line-2354" name="line-2354"></a><span class="cp">#define ATA_CB_DC    6   </span><span class="c1">// device control      out pio_base_addr2+6</span>
<a id="line-2355" name="line-2355"></a><span class="cp">#define ATA_CB_DA    7   </span><span class="c1">// device address   in     pio_base_addr2+7</span>
<a id="line-2356" name="line-2356"></a>
<a id="line-2357" name="line-2357"></a><span class="cp">#define ATA_CB_ER_ICRC 0x80    </span><span class="c1">// ATA Ultra DMA bad CRC</span>
<a id="line-2358" name="line-2358"></a><span class="cp">#define ATA_CB_ER_BBK  0x80    </span><span class="c1">// ATA bad block</span>
<a id="line-2359" name="line-2359"></a><span class="cp">#define ATA_CB_ER_UNC  0x40    </span><span class="c1">// ATA uncorrected error</span>
<a id="line-2360" name="line-2360"></a><span class="cp">#define ATA_CB_ER_MC   0x20    </span><span class="c1">// ATA media change</span>
<a id="line-2361" name="line-2361"></a><span class="cp">#define ATA_CB_ER_IDNF 0x10    </span><span class="c1">// ATA id not found</span>
<a id="line-2362" name="line-2362"></a><span class="cp">#define ATA_CB_ER_MCR  0x08    </span><span class="c1">// ATA media change request</span>
<a id="line-2363" name="line-2363"></a><span class="cp">#define ATA_CB_ER_ABRT 0x04    </span><span class="c1">// ATA command aborted</span>
<a id="line-2364" name="line-2364"></a><span class="cp">#define ATA_CB_ER_NTK0 0x02    </span><span class="c1">// ATA track 0 not found</span>
<a id="line-2365" name="line-2365"></a><span class="cp">#define ATA_CB_ER_NDAM 0x01    </span><span class="c1">// ATA address mark not found</span>
<a id="line-2366" name="line-2366"></a>
<a id="line-2367" name="line-2367"></a><span class="cp">#define ATA_CB_ER_P_SNSKEY 0xf0   </span><span class="c1">// ATAPI sense key (mask)</span>
<a id="line-2368" name="line-2368"></a><span class="cp">#define ATA_CB_ER_P_MCR    0x08   </span><span class="c1">// ATAPI Media Change Request</span>
<a id="line-2369" name="line-2369"></a><span class="cp">#define ATA_CB_ER_P_ABRT   0x04   </span><span class="c1">// ATAPI command abort</span>
<a id="line-2370" name="line-2370"></a><span class="cp">#define ATA_CB_ER_P_EOM    0x02   </span><span class="c1">// ATAPI End of Media</span>
<a id="line-2371" name="line-2371"></a><span class="cp">#define ATA_CB_ER_P_ILI    0x01   </span><span class="c1">// ATAPI Illegal Length Indication</span>
<a id="line-2372" name="line-2372"></a>
<a id="line-2373" name="line-2373"></a><span class="c1">// ATAPI Interrupt Reason bits in the Sector Count reg (CB_SC)</span>
<a id="line-2374" name="line-2374"></a><span class="cp">#define ATA_CB_SC_P_TAG    0xf8   </span><span class="c1">// ATAPI tag (mask)</span>
<a id="line-2375" name="line-2375"></a><span class="cp">#define ATA_CB_SC_P_REL    0x04   </span><span class="c1">// ATAPI release</span>
<a id="line-2376" name="line-2376"></a><span class="cp">#define ATA_CB_SC_P_IO     0x02   </span><span class="c1">// ATAPI I/O</span>
<a id="line-2377" name="line-2377"></a><span class="cp">#define ATA_CB_SC_P_CD     0x01   </span><span class="c1">// ATAPI C/D</span>
<a id="line-2378" name="line-2378"></a>
<a id="line-2379" name="line-2379"></a><span class="c1">// bits 7-4 of the device/head (CB_DH) reg</span>
<a id="line-2380" name="line-2380"></a><span class="cp">#define ATA_CB_DH_DEV0 0xa0    </span><span class="c1">// select device 0</span>
<a id="line-2381" name="line-2381"></a><span class="cp">#define ATA_CB_DH_DEV1 0xb0    </span><span class="c1">// select device 1</span>
<a id="line-2382" name="line-2382"></a><span class="cp">#define ATA_CB_DH_LBA 0x40    </span><span class="c1">// use LBA</span>
<a id="line-2383" name="line-2383"></a>
<a id="line-2384" name="line-2384"></a><span class="c1">// status reg (CB_STAT and CB_ASTAT) bits</span>
<a id="line-2385" name="line-2385"></a><span class="cp">#define ATA_CB_STAT_BSY  0x80  </span><span class="c1">// busy</span>
<a id="line-2386" name="line-2386"></a><span class="cp">#define ATA_CB_STAT_RDY  0x40  </span><span class="c1">// ready</span>
<a id="line-2387" name="line-2387"></a><span class="cp">#define ATA_CB_STAT_DF   0x20  </span><span class="c1">// device fault</span>
<a id="line-2388" name="line-2388"></a><span class="cp">#define ATA_CB_STAT_WFT  0x20  </span><span class="c1">// write fault (old name)</span>
<a id="line-2389" name="line-2389"></a><span class="cp">#define ATA_CB_STAT_SKC  0x10  </span><span class="c1">// seek complete</span>
<a id="line-2390" name="line-2390"></a><span class="cp">#define ATA_CB_STAT_SERV 0x10  </span><span class="c1">// service</span>
<a id="line-2391" name="line-2391"></a><span class="cp">#define ATA_CB_STAT_DRQ  0x08  </span><span class="c1">// data request</span>
<a id="line-2392" name="line-2392"></a><span class="cp">#define ATA_CB_STAT_CORR 0x04  </span><span class="c1">// corrected</span>
<a id="line-2393" name="line-2393"></a><span class="cp">#define ATA_CB_STAT_IDX  0x02  </span><span class="c1">// index</span>
<a id="line-2394" name="line-2394"></a><span class="cp">#define ATA_CB_STAT_ERR  0x01  </span><span class="c1">// error (ATA)</span>
<a id="line-2395" name="line-2395"></a><span class="cp">#define ATA_CB_STAT_CHK  0x01  </span><span class="c1">// check (ATAPI)</span>
<a id="line-2396" name="line-2396"></a>
<a id="line-2397" name="line-2397"></a><span class="c1">// device control reg (CB_DC) bits</span>
<a id="line-2398" name="line-2398"></a><span class="cp">#define ATA_CB_DC_HD15   0x08  </span><span class="c1">// bit should always be set to one</span>
<a id="line-2399" name="line-2399"></a><span class="cp">#define ATA_CB_DC_SRST   0x04  </span><span class="c1">// soft reset</span>
<a id="line-2400" name="line-2400"></a><span class="cp">#define ATA_CB_DC_NIEN   0x02  </span><span class="c1">// disable interrupts</span>
<a id="line-2401" name="line-2401"></a>
<a id="line-2402" name="line-2402"></a><span class="c1">// Most mandtory and optional ATA commands (from ATA-3),</span>
<a id="line-2403" name="line-2403"></a><span class="cp">#define ATA_CMD_CFA_ERASE_SECTORS            0xC0</span>
<a id="line-2404" name="line-2404"></a><span class="cp">#define ATA_CMD_CFA_REQUEST_EXT_ERR_CODE     0x03</span>
<a id="line-2405" name="line-2405"></a><span class="cp">#define ATA_CMD_CFA_TRANSLATE_SECTOR         0x87</span>
<a id="line-2406" name="line-2406"></a><span class="cp">#define ATA_CMD_CFA_WRITE_MULTIPLE_WO_ERASE  0xCD</span>
<a id="line-2407" name="line-2407"></a><span class="cp">#define ATA_CMD_CFA_WRITE_SECTORS_WO_ERASE   0x38</span>
<a id="line-2408" name="line-2408"></a><span class="cp">#define ATA_CMD_CHECK_POWER_MODE1            0xE5</span>
<a id="line-2409" name="line-2409"></a><span class="cp">#define ATA_CMD_CHECK_POWER_MODE2            0x98</span>
<a id="line-2410" name="line-2410"></a><span class="cp">#define ATA_CMD_DEVICE_RESET                 0x08</span>
<a id="line-2411" name="line-2411"></a><span class="cp">#define ATA_CMD_EXECUTE_DEVICE_DIAGNOSTIC    0x90</span>
<a id="line-2412" name="line-2412"></a><span class="cp">#define ATA_CMD_FLUSH_CACHE                  0xE7</span>
<a id="line-2413" name="line-2413"></a><span class="cp">#define ATA_CMD_FORMAT_TRACK                 0x50</span>
<a id="line-2414" name="line-2414"></a><span class="cp">#define ATA_CMD_IDENTIFY_DEVICE              0xEC</span>
<a id="line-2415" name="line-2415"></a><span class="cp">#define ATA_CMD_IDENTIFY_DEVICE_PACKET       0xA1</span>
<a id="line-2416" name="line-2416"></a><span class="cp">#define ATA_CMD_IDENTIFY_PACKET_DEVICE       0xA1</span>
<a id="line-2417" name="line-2417"></a><span class="cp">#define ATA_CMD_IDLE1                        0xE3</span>
<a id="line-2418" name="line-2418"></a><span class="cp">#define ATA_CMD_IDLE2                        0x97</span>
<a id="line-2419" name="line-2419"></a><span class="cp">#define ATA_CMD_IDLE_IMMEDIATE1              0xE1</span>
<a id="line-2420" name="line-2420"></a><span class="cp">#define ATA_CMD_IDLE_IMMEDIATE2              0x95</span>
<a id="line-2421" name="line-2421"></a><span class="cp">#define ATA_CMD_INITIALIZE_DRIVE_PARAMETERS  0x91</span>
<a id="line-2422" name="line-2422"></a><span class="cp">#define ATA_CMD_INITIALIZE_DEVICE_PARAMETERS 0x91</span>
<a id="line-2423" name="line-2423"></a><span class="cp">#define ATA_CMD_NOP                          0x00</span>
<a id="line-2424" name="line-2424"></a><span class="cp">#define ATA_CMD_PACKET                       0xA0</span>
<a id="line-2425" name="line-2425"></a><span class="cp">#define ATA_CMD_READ_BUFFER                  0xE4</span>
<a id="line-2426" name="line-2426"></a><span class="cp">#define ATA_CMD_READ_DMA                     0xC8</span>
<a id="line-2427" name="line-2427"></a><span class="cp">#define ATA_CMD_READ_DMA_QUEUED              0xC7</span>
<a id="line-2428" name="line-2428"></a><span class="cp">#define ATA_CMD_READ_MULTIPLE                0xC4</span>
<a id="line-2429" name="line-2429"></a><span class="cp">#define ATA_CMD_READ_SECTORS                 0x20</span>
<a id="line-2430" name="line-2430"></a><span class="cp">#define ATA_CMD_READ_VERIFY_SECTORS          0x40</span>
<a id="line-2431" name="line-2431"></a><span class="cp">#define ATA_CMD_RECALIBRATE                  0x10</span>
<a id="line-2432" name="line-2432"></a><span class="cp">#define ATA_CMD_REQUEST_SENSE                0x03</span>
<a id="line-2433" name="line-2433"></a><span class="cp">#define ATA_CMD_SEEK                         0x70</span>
<a id="line-2434" name="line-2434"></a><span class="cp">#define ATA_CMD_SET_FEATURES                 0xEF</span>
<a id="line-2435" name="line-2435"></a><span class="cp">#define ATA_CMD_SET_MULTIPLE_MODE            0xC6</span>
<a id="line-2436" name="line-2436"></a><span class="cp">#define ATA_CMD_SLEEP1                       0xE6</span>
<a id="line-2437" name="line-2437"></a><span class="cp">#define ATA_CMD_SLEEP2                       0x99</span>
<a id="line-2438" name="line-2438"></a><span class="cp">#define ATA_CMD_STANDBY1                     0xE2</span>
<a id="line-2439" name="line-2439"></a><span class="cp">#define ATA_CMD_STANDBY2                     0x96</span>
<a id="line-2440" name="line-2440"></a><span class="cp">#define ATA_CMD_STANDBY_IMMEDIATE1           0xE0</span>
<a id="line-2441" name="line-2441"></a><span class="cp">#define ATA_CMD_STANDBY_IMMEDIATE2           0x94</span>
<a id="line-2442" name="line-2442"></a><span class="cp">#define ATA_CMD_WRITE_BUFFER                 0xE8</span>
<a id="line-2443" name="line-2443"></a><span class="cp">#define ATA_CMD_WRITE_DMA                    0xCA</span>
<a id="line-2444" name="line-2444"></a><span class="cp">#define ATA_CMD_WRITE_DMA_QUEUED             0xCC</span>
<a id="line-2445" name="line-2445"></a><span class="cp">#define ATA_CMD_WRITE_MULTIPLE               0xC5</span>
<a id="line-2446" name="line-2446"></a><span class="cp">#define ATA_CMD_WRITE_SECTORS                0x30</span>
<a id="line-2447" name="line-2447"></a><span class="cp">#define ATA_CMD_WRITE_VERIFY                 0x3C</span>
<a id="line-2448" name="line-2448"></a>
<a id="line-2449" name="line-2449"></a><span class="cp">#define ATA_IFACE_NONE    0x00</span>
<a id="line-2450" name="line-2450"></a><span class="cp">#define ATA_IFACE_ISA     0x00</span>
<a id="line-2451" name="line-2451"></a><span class="cp">#define ATA_IFACE_PCI     0x01</span>
<a id="line-2452" name="line-2452"></a>
<a id="line-2453" name="line-2453"></a><span class="cp">#define ATA_TYPE_NONE     0x00</span>
<a id="line-2454" name="line-2454"></a><span class="cp">#define ATA_TYPE_UNKNOWN  0x01</span>
<a id="line-2455" name="line-2455"></a><span class="cp">#define ATA_TYPE_ATA      0x02</span>
<a id="line-2456" name="line-2456"></a><span class="cp">#define ATA_TYPE_ATAPI    0x03</span>
<a id="line-2457" name="line-2457"></a>
<a id="line-2458" name="line-2458"></a><span class="cp">#define ATA_DEVICE_NONE  0x00</span>
<a id="line-2459" name="line-2459"></a><span class="cp">#define ATA_DEVICE_HD    0xFF</span>
<a id="line-2460" name="line-2460"></a><span class="cp">#define ATA_DEVICE_CDROM 0x05</span>
<a id="line-2461" name="line-2461"></a>
<a id="line-2462" name="line-2462"></a><span class="cp">#define ATA_MODE_NONE    0x00</span>
<a id="line-2463" name="line-2463"></a><span class="cp">#define ATA_MODE_PIO16   0x00</span>
<a id="line-2464" name="line-2464"></a><span class="cp">#define ATA_MODE_PIO32   0x01</span>
<a id="line-2465" name="line-2465"></a><span class="cp">#define ATA_MODE_ISADMA  0x02</span>
<a id="line-2466" name="line-2466"></a><span class="cp">#define ATA_MODE_PCIDMA  0x03</span>
<a id="line-2467" name="line-2467"></a><span class="cp">#define ATA_MODE_USEIRQ  0x10</span>
<a id="line-2468" name="line-2468"></a>
<a id="line-2469" name="line-2469"></a><span class="cp">#define ATA_TRANSLATION_NONE  0</span>
<a id="line-2470" name="line-2470"></a><span class="cp">#define ATA_TRANSLATION_LBA   1</span>
<a id="line-2471" name="line-2471"></a><span class="cp">#define ATA_TRANSLATION_LARGE 2</span>
<a id="line-2472" name="line-2472"></a><span class="cp">#define ATA_TRANSLATION_RECHS 3</span>
<a id="line-2473" name="line-2473"></a>
<a id="line-2474" name="line-2474"></a><span class="cp">#define ATA_DATA_NO      0x00</span>
<a id="line-2475" name="line-2475"></a><span class="cp">#define ATA_DATA_IN      0x01</span>
<a id="line-2476" name="line-2476"></a><span class="cp">#define ATA_DATA_OUT     0x02</span>
<a id="line-2477" name="line-2477"></a>
<a id="line-2478" name="line-2478"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2479" name="line-2479"></a><span class="c1">// ATA/ATAPI driver : initialization</span>
<a id="line-2480" name="line-2480"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2481" name="line-2481"></a><span class="kt">void</span><span class="w"> </span><span class="n">ata_init</span><span class="p">(</span><span class="w"> </span><span class="p">)</span>
<a id="line-2482" name="line-2482"></a><span class="p">{</span>
<a id="line-2483" name="line-2483"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2484" name="line-2484"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<a id="line-2485" name="line-2485"></a>
<a id="line-2486" name="line-2486"></a><span class="w">  </span><span class="c1">// Channels info init.</span>
<a id="line-2487" name="line-2487"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">channel</span><span class="o">&lt;</span><span class="n">BX_MAX_ATA_INTERFACES</span><span class="p">;</span><span class="w"> </span><span class="n">channel</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2488" name="line-2488"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iface</span><span class="p">,</span><span class="n">ATA_IFACE_NONE</span><span class="p">);</span>
<a id="line-2489" name="line-2489"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">,</span><span class="mh">0x0</span><span class="p">);</span>
<a id="line-2490" name="line-2490"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">,</span><span class="mh">0x0</span><span class="p">);</span>
<a id="line-2491" name="line-2491"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2492" name="line-2492"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2493" name="line-2493"></a>
<a id="line-2494" name="line-2494"></a><span class="w">  </span><span class="c1">// Devices info init.</span>
<a id="line-2495" name="line-2495"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">&lt;</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2496" name="line-2496"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="n">ATA_TYPE_NONE</span><span class="p">);</span>
<a id="line-2497" name="line-2497"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_DEVICE_NONE</span><span class="p">);</span>
<a id="line-2498" name="line-2498"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">removable</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2499" name="line-2499"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lock</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2500" name="line-2500"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span><span class="n">ATA_MODE_NONE</span><span class="p">);</span>
<a id="line-2501" name="line-2501"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2502" name="line-2502"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">translation</span><span class="p">,</span><span class="n">ATA_TRANSLATION_NONE</span><span class="p">);</span>
<a id="line-2503" name="line-2503"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2504" name="line-2504"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2505" name="line-2505"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2506" name="line-2506"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2507" name="line-2507"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2508" name="line-2508"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2509" name="line-2509"></a>
<a id="line-2510" name="line-2510"></a><span class="w">    </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">,</span><span class="mf">0L</span><span class="p">);</span>
<a id="line-2511" name="line-2511"></a><span class="w">    </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">,</span><span class="mf">0L</span><span class="p">);</span>
<a id="line-2512" name="line-2512"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2513" name="line-2513"></a>
<a id="line-2514" name="line-2514"></a><span class="w">  </span><span class="c1">// hdidmap  and cdidmap init.</span>
<a id="line-2515" name="line-2515"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">&lt;</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2516" name="line-2516"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdidmap</span><span class="p">[</span><span class="n">device</span><span class="p">],</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">);</span>
<a id="line-2517" name="line-2517"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">cdidmap</span><span class="p">[</span><span class="n">device</span><span class="p">],</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">);</span>
<a id="line-2518" name="line-2518"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2519" name="line-2519"></a>
<a id="line-2520" name="line-2520"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdcount</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2521" name="line-2521"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">cdcount</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2522" name="line-2522"></a><span class="p">}</span>
<a id="line-2523" name="line-2523"></a>
<a id="line-2524" name="line-2524"></a><span class="cp">#define TIMEOUT 0</span>
<a id="line-2525" name="line-2525"></a><span class="cp">#define BSY 1</span>
<a id="line-2526" name="line-2526"></a><span class="cp">#define NOT_BSY 2</span>
<a id="line-2527" name="line-2527"></a><span class="cp">#define NOT_BSY_DRQ 3</span>
<a id="line-2528" name="line-2528"></a><span class="cp">#define NOT_BSY_NOT_DRQ 4</span>
<a id="line-2529" name="line-2529"></a><span class="cp">#define NOT_BSY_RDY 5</span>
<a id="line-2530" name="line-2530"></a>
<a id="line-2531" name="line-2531"></a><span class="cp">#define IDE_TIMEOUT 32000u </span><span class="c1">//32 seconds max for IDE ops</span>
<a id="line-2532" name="line-2532"></a>
<a id="line-2533" name="line-2533"></a><span class="n">Bit8u</span><span class="w"> </span><span class="n">await_ide</span><span class="p">();</span>
<a id="line-2534" name="line-2534"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w"> </span><span class="nf">await_ide</span><span class="p">(</span><span class="n">when_done</span><span class="p">,</span><span class="n">base</span><span class="p">,</span><span class="n">timeout</span><span class="p">)</span>
<a id="line-2535" name="line-2535"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">when_done</span><span class="p">;</span>
<a id="line-2536" name="line-2536"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<a id="line-2537" name="line-2537"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
<a id="line-2538" name="line-2538"></a><span class="p">{</span>
<a id="line-2539" name="line-2539"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">last</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-2540" name="line-2540"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-2541" name="line-2541"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="line-2542" name="line-2542"></a><span class="w">  </span><span class="k">for</span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2543" name="line-2543"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-2544" name="line-2544"></a><span class="w">    </span><span class="n">time</span><span class="o">++</span><span class="p">;</span>
<a id="line-2545" name="line-2545"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BSY</span><span class="p">)</span>
<a id="line-2546" name="line-2546"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">;</span>
<a id="line-2547" name="line-2547"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NOT_BSY</span><span class="p">)</span>
<a id="line-2548" name="line-2548"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">);</span>
<a id="line-2549" name="line-2549"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NOT_BSY_DRQ</span><span class="p">)</span>
<a id="line-2550" name="line-2550"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">);</span>
<a id="line-2551" name="line-2551"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NOT_BSY_NOT_DRQ</span><span class="p">)</span>
<a id="line-2552" name="line-2552"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">);</span>
<a id="line-2553" name="line-2553"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NOT_BSY_RDY</span><span class="p">)</span>
<a id="line-2554" name="line-2554"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="p">);</span>
<a id="line-2555" name="line-2555"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">when_done</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TIMEOUT</span><span class="p">)</span>
<a id="line-2556" name="line-2556"></a><span class="w">      </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2557" name="line-2557"></a>
<a id="line-2558" name="line-2558"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-2559" name="line-2559"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="c1">// mod 2048 each 16 ms</span>
<a id="line-2560" name="line-2560"></a><span class="w">    </span><span class="p">{</span>
<a id="line-2561" name="line-2561"></a><span class="w">      </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
<a id="line-2562" name="line-2562"></a><span class="w">      </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;await_ide: (TIMEOUT,BSY,!BSY,!BSY_DRQ,!BSY_!DRQ,!BSY_RDY) %d time= %ld timeout= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">when_done</span><span class="p">,</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
<a id="line-2563" name="line-2563"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2564" name="line-2564"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span>
<a id="line-2565" name="line-2565"></a><span class="w">    </span><span class="p">{</span>
<a id="line-2566" name="line-2566"></a><span class="w">      </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;await_ide: ERROR (TIMEOUT,BSY,!BSY,!BSY_DRQ,!BSY_!DRQ,!BSY_RDY) %d time= %ld timeout= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">when_done</span><span class="p">,</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
<a id="line-2567" name="line-2567"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-2568" name="line-2568"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2569" name="line-2569"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">timeout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-2570" name="line-2570"></a><span class="w">  </span><span class="p">}</span>
<a id="line-2571" name="line-2571"></a><span class="w">  </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;IDE time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2572" name="line-2572"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-2573" name="line-2573"></a><span class="p">}</span>
<a id="line-2574" name="line-2574"></a>
<a id="line-2575" name="line-2575"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2576" name="line-2576"></a><span class="c1">// ATA/ATAPI driver : device detection</span>
<a id="line-2577" name="line-2577"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2578" name="line-2578"></a>
<a id="line-2579" name="line-2579"></a><span class="kt">void</span><span class="w"> </span><span class="n">ata_detect</span><span class="p">(</span><span class="w"> </span><span class="p">)</span>
<a id="line-2580" name="line-2580"></a><span class="p">{</span>
<a id="line-2581" name="line-2581"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2582" name="line-2582"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">hdcount</span><span class="p">,</span><span class="w"> </span><span class="n">cdcount</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<a id="line-2583" name="line-2583"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x0200</span><span class="p">];</span>
<a id="line-2584" name="line-2584"></a>
<a id="line-2585" name="line-2585"></a><span class="cp">#if BX_MAX_ATA_INTERFACES &gt; 0</span>
<a id="line-2586" name="line-2586"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iface</span><span class="p">,</span><span class="n">ATA_IFACE_ISA</span><span class="p">);</span>
<a id="line-2587" name="line-2587"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iobase1</span><span class="p">,</span><span class="mh">0x1f0</span><span class="p">);</span>
<a id="line-2588" name="line-2588"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iobase2</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">);</span>
<a id="line-2589" name="line-2589"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span>
<a id="line-2590" name="line-2590"></a><span class="cp">#endif</span>
<a id="line-2591" name="line-2591"></a><span class="cp">#if BX_MAX_ATA_INTERFACES &gt; 1</span>
<a id="line-2592" name="line-2592"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iface</span><span class="p">,</span><span class="n">ATA_IFACE_ISA</span><span class="p">);</span>
<a id="line-2593" name="line-2593"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iobase1</span><span class="p">,</span><span class="mh">0x170</span><span class="p">);</span>
<a id="line-2594" name="line-2594"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iobase2</span><span class="p">,</span><span class="mh">0x370</span><span class="p">);</span>
<a id="line-2595" name="line-2595"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<a id="line-2596" name="line-2596"></a><span class="cp">#endif</span>
<a id="line-2597" name="line-2597"></a><span class="cp">#if BX_MAX_ATA_INTERFACES &gt; 2</span>
<a id="line-2598" name="line-2598"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iface</span><span class="p">,</span><span class="n">ATA_IFACE_ISA</span><span class="p">);</span>
<a id="line-2599" name="line-2599"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iobase1</span><span class="p">,</span><span class="mh">0x1e8</span><span class="p">);</span>
<a id="line-2600" name="line-2600"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">iobase2</span><span class="p">,</span><span class="mh">0x3e0</span><span class="p">);</span>
<a id="line-2601" name="line-2601"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-2602" name="line-2602"></a><span class="cp">#endif</span>
<a id="line-2603" name="line-2603"></a><span class="cp">#if BX_MAX_ATA_INTERFACES &gt; 3</span>
<a id="line-2604" name="line-2604"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iface</span><span class="p">,</span><span class="n">ATA_IFACE_ISA</span><span class="p">);</span>
<a id="line-2605" name="line-2605"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iobase1</span><span class="p">,</span><span class="mh">0x168</span><span class="p">);</span>
<a id="line-2606" name="line-2606"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">iobase2</span><span class="p">,</span><span class="mh">0x360</span><span class="p">);</span>
<a id="line-2607" name="line-2607"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span><span class="mi">11</span><span class="p">);</span>
<a id="line-2608" name="line-2608"></a><span class="cp">#endif</span>
<a id="line-2609" name="line-2609"></a><span class="cp">#if BX_MAX_ATA_INTERFACES &gt; 4</span>
<a id="line-2610" name="line-2610"></a><span class="cp">#error Please fill the ATA interface information</span>
<a id="line-2611" name="line-2611"></a><span class="cp">#endif</span>
<a id="line-2612" name="line-2612"></a>
<a id="line-2613" name="line-2613"></a><span class="w">  </span><span class="c1">// Device detection</span>
<a id="line-2614" name="line-2614"></a><span class="w">  </span><span class="n">hdcount</span><span class="o">=</span><span class="n">cdcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-2615" name="line-2615"></a>
<a id="line-2616" name="line-2616"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">&lt;</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2617" name="line-2617"></a><span class="w">    </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">;</span>
<a id="line-2618" name="line-2618"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span>
<a id="line-2619" name="line-2619"></a><span class="w">    </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">st</span><span class="p">;</span>
<a id="line-2620" name="line-2620"></a>
<a id="line-2621" name="line-2621"></a><span class="w">    </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2622" name="line-2622"></a><span class="w">    </span><span class="n">slave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2623" name="line-2623"></a>
<a id="line-2624" name="line-2624"></a><span class="w">    </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-2625" name="line-2625"></a><span class="w">    </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-2626" name="line-2626"></a>
<a id="line-2627" name="line-2627"></a><span class="w">    </span><span class="c1">// Disable interrupts</span>
<a id="line-2628" name="line-2628"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="p">);</span>
<a id="line-2629" name="line-2629"></a>
<a id="line-2630" name="line-2630"></a><span class="w">    </span><span class="c1">// Look for device</span>
<a id="line-2631" name="line-2631"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV0</span><span class="p">);</span>
<a id="line-2632" name="line-2632"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">);</span>
<a id="line-2633" name="line-2633"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">);</span>
<a id="line-2634" name="line-2634"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">);</span>
<a id="line-2635" name="line-2635"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">);</span>
<a id="line-2636" name="line-2636"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">);</span>
<a id="line-2637" name="line-2637"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">);</span>
<a id="line-2638" name="line-2638"></a>
<a id="line-2639" name="line-2639"></a><span class="w">    </span><span class="c1">// If we found something</span>
<a id="line-2640" name="line-2640"></a><span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">);</span>
<a id="line-2641" name="line-2641"></a><span class="w">    </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">);</span>
<a id="line-2642" name="line-2642"></a>
<a id="line-2643" name="line-2643"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x55</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2644" name="line-2644"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="n">ATA_TYPE_UNKNOWN</span><span class="p">);</span>
<a id="line-2645" name="line-2645"></a>
<a id="line-2646" name="line-2646"></a><span class="w">      </span><span class="c1">// reset the channel</span>
<a id="line-2647" name="line-2647"></a><span class="w">      </span><span class="n">ata_reset</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<a id="line-2648" name="line-2648"></a>
<a id="line-2649" name="line-2649"></a><span class="w">      </span><span class="c1">// check for ATA or ATAPI</span>
<a id="line-2650" name="line-2650"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV0</span><span class="p">);</span>
<a id="line-2651" name="line-2651"></a><span class="w">      </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">);</span>
<a id="line-2652" name="line-2652"></a><span class="w">      </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">);</span>
<a id="line-2653" name="line-2653"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sc</span><span class="o">==</span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sn</span><span class="o">==</span><span class="mh">0x01</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-2654" name="line-2654"></a><span class="w">        </span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_CL</span><span class="p">);</span>
<a id="line-2655" name="line-2655"></a><span class="w">        </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_CH</span><span class="p">);</span>
<a id="line-2656" name="line-2656"></a><span class="w">        </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-2657" name="line-2657"></a>
<a id="line-2658" name="line-2658"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">cl</span><span class="o">==</span><span class="mh">0x14</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="o">==</span><span class="mh">0xeb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-2659" name="line-2659"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="n">ATA_TYPE_ATAPI</span><span class="p">);</span>
<a id="line-2660" name="line-2660"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">cl</span><span class="o">==</span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="o">==</span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">st</span><span class="o">!=</span><span class="mh">0x00</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-2661" name="line-2661"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="n">ATA_TYPE_ATA</span><span class="p">);</span>
<a id="line-2662" name="line-2662"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">cl</span><span class="o">==</span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="o">==</span><span class="mh">0xff</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-2663" name="line-2663"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="n">ATA_TYPE_NONE</span><span class="p">);</span>
<a id="line-2664" name="line-2664"></a><span class="w">        </span><span class="p">}</span>
<a id="line-2665" name="line-2665"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2666" name="line-2666"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2667" name="line-2667"></a>
<a id="line-2668" name="line-2668"></a><span class="w">    </span><span class="n">type</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
<a id="line-2669" name="line-2669"></a>
<a id="line-2670" name="line-2670"></a><span class="w">    </span><span class="c1">// Now we send a IDENTIFY command to ATA device</span>
<a id="line-2671" name="line-2671"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_TYPE_ATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2672" name="line-2672"></a><span class="w">      </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">sectors_low</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_high</span><span class="p">;</span>
<a id="line-2673" name="line-2673"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-2674" name="line-2674"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">translation</span><span class="p">,</span><span class="w"> </span><span class="n">removable</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="line-2675" name="line-2675"></a>
<a id="line-2676" name="line-2676"></a><span class="w">      </span><span class="c1">// default mode to PIO16</span>
<a id="line-2677" name="line-2677"></a><span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-2678" name="line-2678"></a>
<a id="line-2679" name="line-2679"></a><span class="w">      </span><span class="c1">//Temporary values to do the transfer</span>
<a id="line-2680" name="line-2680"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_DEVICE_HD</span><span class="p">);</span>
<a id="line-2681" name="line-2681"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">);</span>
<a id="line-2682" name="line-2682"></a>
<a id="line-2683" name="line-2683"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ata_cmd_data_in</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_CMD_IDENTIFY_DEVICE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="line-2684" name="line-2684"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;ata-detect: Failed to detect ATA device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2685" name="line-2685"></a>
<a id="line-2686" name="line-2686"></a><span class="w">      </span><span class="n">removable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2687" name="line-2687"></a><span class="cp">#ifndef        NO_PIO32</span>
<a id="line-2688" name="line-2688"></a><span class="w">      </span><span class="n">mode</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_MODE_PIO32</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-2689" name="line-2689"></a><span class="cp">#endif</span>
<a id="line-2690" name="line-2690"></a><span class="w">      </span><span class="n">blksize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">10</span><span class="p">);</span>
<a id="line-2691" name="line-2691"></a>
<a id="line-2692" name="line-2692"></a><span class="w">      </span><span class="n">cylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 1</span>
<a id="line-2693" name="line-2693"></a><span class="w">      </span><span class="n">heads</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 3</span>
<a id="line-2694" name="line-2694"></a><span class="w">      </span><span class="n">spt</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 6</span>
<a id="line-2695" name="line-2695"></a>
<a id="line-2696" name="line-2696"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_word</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">83</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// word 83 - lba48 support</span>
<a id="line-2697" name="line-2697"></a><span class="w">        </span><span class="n">sectors_low</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 100 and word 101</span>
<a id="line-2698" name="line-2698"></a><span class="w">        </span><span class="n">sectors_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">102</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 102 and word 103</span>
<a id="line-2699" name="line-2699"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-2700" name="line-2700"></a><span class="w">        </span><span class="n">sectors_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="c1">// word 60 and word 61</span>
<a id="line-2701" name="line-2701"></a><span class="w">        </span><span class="n">sectors_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2702" name="line-2702"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2703" name="line-2703"></a>
<a id="line-2704" name="line-2704"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_DEVICE_HD</span><span class="p">);</span>
<a id="line-2705" name="line-2705"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">removable</span><span class="p">,</span><span class="w"> </span><span class="n">removable</span><span class="p">);</span>
<a id="line-2706" name="line-2706"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<a id="line-2707" name="line-2707"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">);</span>
<a id="line-2708" name="line-2708"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">);</span>
<a id="line-2709" name="line-2709"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-2710" name="line-2710"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">);</span>
<a id="line-2711" name="line-2711"></a><span class="w">      </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_low</span><span class="p">);</span>
<a id="line-2712" name="line-2712"></a><span class="w">      </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_high</span><span class="p">);</span>
<a id="line-2713" name="line-2713"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;ata%d-%d: PCHS=%u/%d/%d translation=&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">,</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">);</span>
<a id="line-2714" name="line-2714"></a>
<a id="line-2715" name="line-2715"></a><span class="w">      </span><span class="n">translation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x39</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">channel</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<a id="line-2716" name="line-2716"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">shift</span><span class="o">=</span><span class="n">device</span><span class="o">%</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">shift</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">shift</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="n">translation</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2717" name="line-2717"></a><span class="w">      </span><span class="n">translation</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x03</span><span class="p">;</span>
<a id="line-2718" name="line-2718"></a>
<a id="line-2719" name="line-2719"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">translation</span><span class="p">,</span><span class="w"> </span><span class="n">translation</span><span class="p">);</span>
<a id="line-2720" name="line-2720"></a>
<a id="line-2721" name="line-2721"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">translation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2722" name="line-2722"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_NONE</span><span class="p">:</span>
<a id="line-2723" name="line-2723"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;none&quot;</span><span class="p">);</span>
<a id="line-2724" name="line-2724"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2725" name="line-2725"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_LBA</span><span class="p">:</span>
<a id="line-2726" name="line-2726"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;lba&quot;</span><span class="p">);</span>
<a id="line-2727" name="line-2727"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2728" name="line-2728"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_LARGE</span><span class="p">:</span>
<a id="line-2729" name="line-2729"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;large&quot;</span><span class="p">);</span>
<a id="line-2730" name="line-2730"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2731" name="line-2731"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_RECHS</span><span class="p">:</span>
<a id="line-2732" name="line-2732"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;r-echs&quot;</span><span class="p">);</span>
<a id="line-2733" name="line-2733"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2734" name="line-2734"></a><span class="w">        </span><span class="p">}</span>
<a id="line-2735" name="line-2735"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">translation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2736" name="line-2736"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_NONE</span><span class="p">:</span>
<a id="line-2737" name="line-2737"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2738" name="line-2738"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_LBA</span><span class="p">:</span>
<a id="line-2739" name="line-2739"></a><span class="w">          </span><span class="n">spt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span>
<a id="line-2740" name="line-2740"></a><span class="w">          </span><span class="n">sectors_low</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span>
<a id="line-2741" name="line-2741"></a><span class="w">          </span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectors_low</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<a id="line-2742" name="line-2742"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<a id="line-2743" name="line-2743"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<a id="line-2744" name="line-2744"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<a id="line-2745" name="line-2745"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="n">heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<a id="line-2746" name="line-2746"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="n">heads</span><span class="o">=</span><span class="mi">16</span><span class="p">;</span>
<a id="line-2747" name="line-2747"></a><span class="w">          </span><span class="n">cylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectors_low</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">heads</span><span class="p">;</span>
<a id="line-2748" name="line-2748"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2749" name="line-2749"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_RECHS</span><span class="p">:</span>
<a id="line-2750" name="line-2750"></a><span class="w">          </span><span class="c1">// Take care not to overflow</span>
<a id="line-2751" name="line-2751"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="o">==</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2752" name="line-2752"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">cylinders</span><span class="o">&gt;</span><span class="mi">61439</span><span class="p">)</span><span class="w"> </span><span class="n">cylinders</span><span class="o">=</span><span class="mi">61439</span><span class="p">;</span>
<a id="line-2753" name="line-2753"></a><span class="w">            </span><span class="n">heads</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span>
<a id="line-2754" name="line-2754"></a><span class="w">            </span><span class="n">cylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)((</span><span class="n">Bit32u</span><span class="p">)(</span><span class="n">cylinders</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="o">/</span><span class="mi">15</span><span class="p">);</span>
<a id="line-2755" name="line-2755"></a><span class="w">            </span><span class="p">}</span>
<a id="line-2756" name="line-2756"></a><span class="w">          </span><span class="c1">// then go through the large bitshift process</span>
<a id="line-2757" name="line-2757"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TRANSLATION_LARGE</span><span class="p">:</span>
<a id="line-2758" name="line-2758"></a><span class="w">          </span><span class="k">while</span><span class="p">(</span><span class="n">cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2759" name="line-2759"></a><span class="w">            </span><span class="n">cylinders</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2760" name="line-2760"></a><span class="w">            </span><span class="n">heads</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2761" name="line-2761"></a>
<a id="line-2762" name="line-2762"></a><span class="w">            </span><span class="c1">// If we max out the head count</span>
<a id="line-2763" name="line-2763"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">127</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-2764" name="line-2764"></a><span class="w">          </span><span class="p">}</span>
<a id="line-2765" name="line-2765"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2766" name="line-2766"></a><span class="w">        </span><span class="p">}</span>
<a id="line-2767" name="line-2767"></a><span class="w">      </span><span class="c1">// clip to 1024 cylinders in lchs</span>
<a id="line-2768" name="line-2768"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="n">cylinders</span><span class="o">=</span><span class="mi">1024</span><span class="p">;</span>
<a id="line-2769" name="line-2769"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot; LCHS=%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">);</span>
<a id="line-2770" name="line-2770"></a>
<a id="line-2771" name="line-2771"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">);</span>
<a id="line-2772" name="line-2772"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-2773" name="line-2773"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">);</span>
<a id="line-2774" name="line-2774"></a>
<a id="line-2775" name="line-2775"></a><span class="w">      </span><span class="c1">// fill hdidmap</span>
<a id="line-2776" name="line-2776"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdidmap</span><span class="p">[</span><span class="n">hdcount</span><span class="p">],</span><span class="w"> </span><span class="n">device</span><span class="p">);</span>
<a id="line-2777" name="line-2777"></a><span class="w">      </span><span class="n">hdcount</span><span class="o">++</span><span class="p">;</span>
<a id="line-2778" name="line-2778"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2779" name="line-2779"></a>
<a id="line-2780" name="line-2780"></a><span class="w">    </span><span class="c1">// Now we send a IDENTIFY command to ATAPI device</span>
<a id="line-2781" name="line-2781"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_TYPE_ATAPI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2782" name="line-2782"></a>
<a id="line-2783" name="line-2783"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">removable</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="line-2784" name="line-2784"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-2785" name="line-2785"></a>
<a id="line-2786" name="line-2786"></a><span class="w">      </span><span class="c1">// default mode to PIO16</span>
<a id="line-2787" name="line-2787"></a><span class="w">      </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-2788" name="line-2788"></a>
<a id="line-2789" name="line-2789"></a><span class="w">      </span><span class="c1">//Temporary values to do the transfer</span>
<a id="line-2790" name="line-2790"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_DEVICE_CDROM</span><span class="p">);</span>
<a id="line-2791" name="line-2791"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">);</span>
<a id="line-2792" name="line-2792"></a>
<a id="line-2793" name="line-2793"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ata_cmd_data_in</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">ATA_CMD_IDENTIFY_DEVICE_PACKET</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-2794" name="line-2794"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;ata-detect: Failed to detect ATAPI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2795" name="line-2795"></a>
<a id="line-2796" name="line-2796"></a><span class="w">      </span><span class="n">type</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
<a id="line-2797" name="line-2797"></a><span class="w">      </span><span class="n">removable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2798" name="line-2798"></a><span class="cp">#ifndef        NO_PIO32</span>
<a id="line-2799" name="line-2799"></a><span class="w">      </span><span class="n">mode</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_MODE_PIO32</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-2800" name="line-2800"></a><span class="cp">#endif</span>
<a id="line-2801" name="line-2801"></a><span class="w">      </span><span class="n">blksize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span>
<a id="line-2802" name="line-2802"></a>
<a id="line-2803" name="line-2803"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<a id="line-2804" name="line-2804"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">removable</span><span class="p">,</span><span class="w"> </span><span class="n">removable</span><span class="p">);</span>
<a id="line-2805" name="line-2805"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<a id="line-2806" name="line-2806"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">);</span>
<a id="line-2807" name="line-2807"></a>
<a id="line-2808" name="line-2808"></a><span class="w">      </span><span class="c1">// fill cdidmap</span>
<a id="line-2809" name="line-2809"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">cdidmap</span><span class="p">[</span><span class="n">cdcount</span><span class="p">],</span><span class="w"> </span><span class="n">device</span><span class="p">);</span>
<a id="line-2810" name="line-2810"></a><span class="w">      </span><span class="n">cdcount</span><span class="o">++</span><span class="p">;</span>
<a id="line-2811" name="line-2811"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2812" name="line-2812"></a>
<a id="line-2813" name="line-2813"></a><span class="w">      </span><span class="p">{</span>
<a id="line-2814" name="line-2814"></a><span class="w">      </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">sizeinmb</span><span class="p">;</span>
<a id="line-2815" name="line-2815"></a><span class="w">      </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ataversion</span><span class="p">;</span>
<a id="line-2816" name="line-2816"></a><span class="w">      </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>
<a id="line-2817" name="line-2817"></a>
<a id="line-2818" name="line-2818"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2819" name="line-2819"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TYPE_ATA</span><span class="p">:</span>
<a id="line-2820" name="line-2820"></a><span class="w">          </span><span class="n">sizeinmb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span>
<a id="line-2821" name="line-2821"></a><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span>
<a id="line-2822" name="line-2822"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TYPE_ATAPI</span><span class="p">:</span>
<a id="line-2823" name="line-2823"></a><span class="w">          </span><span class="c1">// Read ATA/ATAPI version</span>
<a id="line-2824" name="line-2824"></a><span class="w">          </span><span class="n">ataversion</span><span class="o">=</span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">161</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="mi">160</span><span class="p">);</span>
<a id="line-2825" name="line-2825"></a><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span><span class="n">version</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="n">version</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2826" name="line-2826"></a><span class="w">            </span><span class="k">if</span><span class="p">((</span><span class="n">ataversion</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">version</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="line-2827" name="line-2827"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="line-2828" name="line-2828"></a><span class="w">            </span><span class="p">}</span>
<a id="line-2829" name="line-2829"></a>
<a id="line-2830" name="line-2830"></a><span class="w">          </span><span class="c1">// Read model name</span>
<a id="line-2831" name="line-2831"></a><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a id="line-2832" name="line-2832"></a><span class="w">            </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">54</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<a id="line-2833" name="line-2833"></a><span class="w">            </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">buffer</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">54</span><span class="p">));</span>
<a id="line-2834" name="line-2834"></a><span class="w">          </span><span class="p">}</span>
<a id="line-2835" name="line-2835"></a>
<a id="line-2836" name="line-2836"></a><span class="w">          </span><span class="c1">// Reformat</span>
<a id="line-2837" name="line-2837"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2838" name="line-2838"></a><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">39</span><span class="p">;</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
<a id="line-2839" name="line-2839"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="mh">0x20</span><span class="p">)</span>
<a id="line-2840" name="line-2840"></a><span class="w">              </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2841" name="line-2841"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-2842" name="line-2842"></a><span class="w">          </span><span class="p">}</span>
<a id="line-2843" name="line-2843"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">36</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2844" name="line-2844"></a><span class="w">            </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="mi">36</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2845" name="line-2845"></a><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">35</span><span class="p">;</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">32</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
<a id="line-2846" name="line-2846"></a><span class="w">              </span><span class="n">write_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mh">0x2E</span><span class="p">);</span>
<a id="line-2847" name="line-2847"></a><span class="w">            </span><span class="p">}</span>
<a id="line-2848" name="line-2848"></a><span class="w">          </span><span class="p">}</span>
<a id="line-2849" name="line-2849"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2850" name="line-2850"></a><span class="w">        </span><span class="p">}</span>
<a id="line-2851" name="line-2851"></a>
<a id="line-2852" name="line-2852"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2853" name="line-2853"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TYPE_ATA</span><span class="p">:</span>
<a id="line-2854" name="line-2854"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ata%d %s: &quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">slave</span><span class="o">?</span><span class="s">&quot; slave&quot;</span><span class="o">:</span><span class="s">&quot;master&quot;</span><span class="p">);</span>
<a id="line-2855" name="line-2855"></a><span class="w">          </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="n">i</span><span class="o">++</span><span class="p">))</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<a id="line-2856" name="line-2856"></a><span class="w">	  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sizeinmb</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">))</span>
<a id="line-2857" name="line-2857"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; ATA-%d Hard-Disk (%4u MBytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="n">sizeinmb</span><span class="p">);</span>
<a id="line-2858" name="line-2858"></a><span class="w">	  </span><span class="k">else</span>
<a id="line-2859" name="line-2859"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; ATA-%d Hard-Disk (%4u GBytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">sizeinmb</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">));</span>
<a id="line-2860" name="line-2860"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2861" name="line-2861"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TYPE_ATAPI</span><span class="p">:</span>
<a id="line-2862" name="line-2862"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ata%d %s: &quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">slave</span><span class="o">?</span><span class="s">&quot; slave&quot;</span><span class="o">:</span><span class="s">&quot;master&quot;</span><span class="p">);</span>
<a id="line-2863" name="line-2863"></a><span class="w">          </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">model</span><span class="o">+</span><span class="n">i</span><span class="o">++</span><span class="p">))</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<a id="line-2864" name="line-2864"></a><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">)</span><span class="o">==</span><span class="n">ATA_DEVICE_CDROM</span><span class="p">)</span>
<a id="line-2865" name="line-2865"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; ATAPI-%d CD-Rom/DVD-Rom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">version</span><span class="p">);</span>
<a id="line-2866" name="line-2866"></a><span class="w">          </span><span class="k">else</span>
<a id="line-2867" name="line-2867"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; ATAPI-%d Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">version</span><span class="p">);</span>
<a id="line-2868" name="line-2868"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2869" name="line-2869"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">ATA_TYPE_UNKNOWN</span><span class="p">:</span>
<a id="line-2870" name="line-2870"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ata%d %s: Unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">slave</span><span class="o">?</span><span class="s">&quot; slave&quot;</span><span class="o">:</span><span class="s">&quot;master&quot;</span><span class="p">);</span>
<a id="line-2871" name="line-2871"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-2872" name="line-2872"></a><span class="w">        </span><span class="p">}</span>
<a id="line-2873" name="line-2873"></a><span class="w">      </span><span class="p">}</span>
<a id="line-2874" name="line-2874"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2875" name="line-2875"></a>
<a id="line-2876" name="line-2876"></a><span class="w">  </span><span class="c1">// Store the devices counts</span>
<a id="line-2877" name="line-2877"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdcount</span><span class="p">,</span><span class="w"> </span><span class="n">hdcount</span><span class="p">);</span>
<a id="line-2878" name="line-2878"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">cdcount</span><span class="p">,</span><span class="w"> </span><span class="n">cdcount</span><span class="p">);</span>
<a id="line-2879" name="line-2879"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x75</span><span class="p">,</span><span class="w"> </span><span class="n">hdcount</span><span class="p">);</span>
<a id="line-2880" name="line-2880"></a>
<a id="line-2881" name="line-2881"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-2882" name="line-2882"></a>
<a id="line-2883" name="line-2883"></a><span class="w">  </span><span class="c1">// FIXME : should use bios=cmos|auto|disable bits</span>
<a id="line-2884" name="line-2884"></a><span class="w">  </span><span class="c1">// FIXME : should know about translation bits</span>
<a id="line-2885" name="line-2885"></a><span class="w">  </span><span class="c1">// FIXME : move hard_drive_post here</span>
<a id="line-2886" name="line-2886"></a>
<a id="line-2887" name="line-2887"></a><span class="p">}</span>
<a id="line-2888" name="line-2888"></a>
<a id="line-2889" name="line-2889"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2890" name="line-2890"></a><span class="c1">// ATA/ATAPI driver : software reset</span>
<a id="line-2891" name="line-2891"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2892" name="line-2892"></a><span class="c1">// ATA-3</span>
<a id="line-2893" name="line-2893"></a><span class="c1">// 8.2.1 Software reset - Device 0</span>
<a id="line-2894" name="line-2894"></a>
<a id="line-2895" name="line-2895"></a><span class="kt">void</span><span class="w">   </span><span class="n">ata_reset</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="line-2896" name="line-2896"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<a id="line-2897" name="line-2897"></a><span class="p">{</span>
<a id="line-2898" name="line-2898"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2899" name="line-2899"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">;</span>
<a id="line-2900" name="line-2900"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">sc</span><span class="p">;</span>
<a id="line-2901" name="line-2901"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">type</span><span class="p">;</span>
<a id="line-2902" name="line-2902"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<a id="line-2903" name="line-2903"></a>
<a id="line-2904" name="line-2904"></a><span class="w">  </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2905" name="line-2905"></a><span class="w">  </span><span class="n">slave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2906" name="line-2906"></a>
<a id="line-2907" name="line-2907"></a><span class="w">  </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-2908" name="line-2908"></a><span class="w">  </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-2909" name="line-2909"></a>
<a id="line-2910" name="line-2910"></a><span class="w">  </span><span class="c1">// Reset</span>
<a id="line-2911" name="line-2911"></a>
<a id="line-2912" name="line-2912"></a><span class="c1">// 8.2.1 (a) -- set SRST in DC</span>
<a id="line-2913" name="line-2913"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_SRST</span><span class="p">);</span>
<a id="line-2914" name="line-2914"></a>
<a id="line-2915" name="line-2915"></a><span class="c1">// 8.2.1 (b) -- wait</span>
<a id="line-2916" name="line-2916"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2917" name="line-2917"></a>
<a id="line-2918" name="line-2918"></a><span class="c1">// 8.2.1 (f) -- clear SRST</span>
<a id="line-2919" name="line-2919"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="p">);</span>
<a id="line-2920" name="line-2920"></a>
<a id="line-2921" name="line-2921"></a><span class="w">  </span><span class="n">type</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
<a id="line-2922" name="line-2922"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_TYPE_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2923" name="line-2923"></a>
<a id="line-2924" name="line-2924"></a><span class="c1">// 8.2.1 (g) -- check for sc==sn==0x01</span>
<a id="line-2925" name="line-2925"></a><span class="w">    </span><span class="c1">// select device</span>
<a id="line-2926" name="line-2926"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="o">?</span><span class="n">ATA_CB_DH_DEV1</span><span class="o">:</span><span class="n">ATA_CB_DH_DEV0</span><span class="p">);</span>
<a id="line-2927" name="line-2927"></a><span class="w">    </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SC</span><span class="p">);</span>
<a id="line-2928" name="line-2928"></a><span class="w">    </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="o">+</span><span class="n">ATA_CB_SN</span><span class="p">);</span>
<a id="line-2929" name="line-2929"></a>
<a id="line-2930" name="line-2930"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">sc</span><span class="o">==</span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sn</span><span class="o">==</span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2931" name="line-2931"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_TYPE_ATA</span><span class="p">)</span><span class="w"> </span><span class="c1">//ATA</span>
<a id="line-2932" name="line-2932"></a><span class="w">        </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY_RDY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-2933" name="line-2933"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="c1">//ATAPI</span>
<a id="line-2934" name="line-2934"></a><span class="w">        </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-2935" name="line-2935"></a><span class="w">    </span><span class="p">}</span>
<a id="line-2936" name="line-2936"></a>
<a id="line-2937" name="line-2937"></a><span class="c1">// 8.2.1 (h) -- wait for not BSY</span>
<a id="line-2938" name="line-2938"></a><span class="w">    </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-2939" name="line-2939"></a><span class="w">  </span><span class="p">}</span>
<a id="line-2940" name="line-2940"></a>
<a id="line-2941" name="line-2941"></a><span class="w">  </span><span class="c1">// Enable interrupts</span>
<a id="line-2942" name="line-2942"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="p">);</span>
<a id="line-2943" name="line-2943"></a><span class="p">}</span>
<a id="line-2944" name="line-2944"></a>
<a id="line-2945" name="line-2945"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2946" name="line-2946"></a><span class="c1">// ATA/ATAPI driver : execute a non data command</span>
<a id="line-2947" name="line-2947"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2948" name="line-2948"></a>
<a id="line-2949" name="line-2949"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">ata_cmd_non_data</span><span class="p">()</span>
<a id="line-2950" name="line-2950"></a><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;}</span>
<a id="line-2951" name="line-2951"></a>
<a id="line-2952" name="line-2952"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2953" name="line-2953"></a><span class="c1">// ATA/ATAPI driver : execute a data-in command</span>
<a id="line-2954" name="line-2954"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-2955" name="line-2955"></a><span class="w">      </span><span class="c1">// returns</span>
<a id="line-2956" name="line-2956"></a><span class="w">      </span><span class="c1">// 0 : no error</span>
<a id="line-2957" name="line-2957"></a><span class="w">      </span><span class="c1">// 1 : BUSY bit set</span>
<a id="line-2958" name="line-2958"></a><span class="w">      </span><span class="c1">// 2 : read error</span>
<a id="line-2959" name="line-2959"></a><span class="w">      </span><span class="c1">// 3 : expected DRQ=1</span>
<a id="line-2960" name="line-2960"></a><span class="w">      </span><span class="c1">// 4 : no sectors left to read/verify</span>
<a id="line-2961" name="line-2961"></a><span class="w">      </span><span class="c1">// 5 : more sectors to read/verify</span>
<a id="line-2962" name="line-2962"></a><span class="w">      </span><span class="c1">// 6 : no sectors left to write</span>
<a id="line-2963" name="line-2963"></a><span class="w">      </span><span class="c1">// 7 : more sectors to write</span>
<a id="line-2964" name="line-2964"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">ata_cmd_data_in</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-2965" name="line-2965"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-2966" name="line-2966"></a><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">;</span>
<a id="line-2967" name="line-2967"></a><span class="p">{</span>
<a id="line-2968" name="line-2968"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-2969" name="line-2969"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-2970" name="line-2970"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
<a id="line-2971" name="line-2971"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="line-2972" name="line-2972"></a>
<a id="line-2973" name="line-2973"></a><span class="w">  </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2974" name="line-2974"></a><span class="w">  </span><span class="n">slave</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-2975" name="line-2975"></a>
<a id="line-2976" name="line-2976"></a><span class="w">  </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-2977" name="line-2977"></a><span class="w">  </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-2978" name="line-2978"></a><span class="w">  </span><span class="n">mode</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">);</span>
<a id="line-2979" name="line-2979"></a><span class="w">  </span><span class="n">blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x200</span><span class="p">;</span><span class="w"> </span><span class="c1">// was = read_word(ebda_seg, &amp;EbdaData-&gt;ata.devices[device].blksize);</span>
<a id="line-2980" name="line-2980"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_MODE_PIO32</span><span class="p">)</span><span class="w"> </span><span class="n">blksize</span><span class="o">&gt;&gt;=</span><span class="mi">2</span><span class="p">;</span>
<a id="line-2981" name="line-2981"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="n">blksize</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-2982" name="line-2982"></a>
<a id="line-2983" name="line-2983"></a><span class="w">  </span><span class="c1">// Reset count of transferred data</span>
<a id="line-2984" name="line-2984"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-2985" name="line-2985"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfbytes</span><span class="p">,</span><span class="mf">0L</span><span class="p">);</span>
<a id="line-2986" name="line-2986"></a><span class="w">  </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-2987" name="line-2987"></a>
<a id="line-2988" name="line-2988"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-2989" name="line-2989"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-2990" name="line-2990"></a>
<a id="line-2991" name="line-2991"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="p">);</span>
<a id="line-2992" name="line-2992"></a>
<a id="line-2993" name="line-2993"></a><span class="w">  </span><span class="c1">// sector will be 0 only on lba access. Convert to lba-chs</span>
<a id="line-2994" name="line-2994"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-2995" name="line-2995"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">lba_low</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">28</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-2996" name="line-2996"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_FR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-2997" name="line-2997"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-2998" name="line-2998"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span>
<a id="line-2999" name="line-2999"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-3000" name="line-3000"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3001" name="line-3001"></a><span class="w">      </span><span class="n">command</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-3002" name="line-3002"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3003" name="line-3003"></a><span class="w">      </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3004" name="line-3004"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3005" name="line-3005"></a><span class="w">    </span><span class="n">sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">lba_low</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ffL</span><span class="p">);</span>
<a id="line-3006" name="line-3006"></a><span class="w">    </span><span class="n">cylinder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">lba_low</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ffffL</span><span class="p">);</span>
<a id="line-3007" name="line-3007"></a><span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">lba_low</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000000fL</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DH_LBA</span><span class="p">;</span>
<a id="line-3008" name="line-3008"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3009" name="line-3009"></a>
<a id="line-3010" name="line-3010"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_FR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3011" name="line-3011"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="line-3012" name="line-3012"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-3013" name="line-3013"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span>
<a id="line-3014" name="line-3014"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3015" name="line-3015"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">slave</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit8u</span><span class="p">)</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="p">);</span>
<a id="line-3016" name="line-3016"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CMD</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">);</span>
<a id="line-3017" name="line-3017"></a>
<a id="line-3018" name="line-3018"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY_DRQ</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3019" name="line-3019"></a>
<a id="line-3020" name="line-3020"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3021" name="line-3021"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_in : read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3022" name="line-3022"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3023" name="line-3023"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3024" name="line-3024"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_in : DRQ not set (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3025" name="line-3025"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3026" name="line-3026"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3027" name="line-3027"></a>
<a id="line-3028" name="line-3028"></a><span class="w">  </span><span class="c1">// FIXME : move seg/off translation here</span>
<a id="line-3029" name="line-3029"></a>
<a id="line-3030" name="line-3030"></a><span class="n">ASM_START</span>
<a id="line-3031" name="line-3031"></a><span class="w">        </span><span class="n">sti</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-3032" name="line-3032"></a><span class="n">ASM_END</span>
<a id="line-3033" name="line-3033"></a>
<a id="line-3034" name="line-3034"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3035" name="line-3035"></a>
<a id="line-3036" name="line-3036"></a><span class="n">ASM_START</span>
<a id="line-3037" name="line-3037"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-3038" name="line-3038"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-3039" name="line-3039"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3040" name="line-3040"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">segment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3041" name="line-3041"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">blksize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3042" name="line-3042"></a>
<a id="line-3043" name="line-3043"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">overrun</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="n">K</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="n">size</span>
<a id="line-3044" name="line-3044"></a><span class="w">        </span><span class="n">cmp</span><span class="w">   </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf800</span><span class="w"> </span><span class="p">;;</span>
<a id="line-3045" name="line-3045"></a><span class="w">        </span><span class="n">jbe</span><span class="w">   </span><span class="n">ata_in_no_adjust</span>
<a id="line-3046" name="line-3046"></a>
<a id="line-3047" name="line-3047"></a><span class="nl">ata_in_adjust</span><span class="p">:</span>
<a id="line-3048" name="line-3048"></a><span class="w">        </span><span class="n">sub</span><span class="w">   </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0800</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">kbytes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">offset</span>
<a id="line-3049" name="line-3049"></a><span class="w">        </span><span class="n">add</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0080</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Kbytes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">segment</span>
<a id="line-3050" name="line-3050"></a>
<a id="line-3051" name="line-3051"></a><span class="nl">ata_in_no_adjust</span><span class="p">:</span>
<a id="line-3052" name="line-3052"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">es</span>
<a id="line-3053" name="line-3053"></a>
<a id="line-3054" name="line-3054"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ATA</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">port</span>
<a id="line-3055" name="line-3055"></a>
<a id="line-3056" name="line-3056"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3057" name="line-3057"></a><span class="w">        </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">ATA_MODE_PIO32</span>
<a id="line-3058" name="line-3058"></a><span class="w">        </span><span class="n">je</span><span class="w">   </span><span class="n">ata_in_32</span>
<a id="line-3059" name="line-3059"></a>
<a id="line-3060" name="line-3060"></a><span class="nl">ata_in_16</span><span class="p">:</span>
<a id="line-3061" name="line-3061"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3062" name="line-3062"></a><span class="w">          </span><span class="n">insw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">DI</span><span class="p">]</span>
<a id="line-3063" name="line-3063"></a><span class="w">        </span><span class="n">jmp</span><span class="w"> </span><span class="n">ata_in_done</span>
<a id="line-3064" name="line-3064"></a>
<a id="line-3065" name="line-3065"></a><span class="nl">ata_in_32</span><span class="p">:</span>
<a id="line-3066" name="line-3066"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3067" name="line-3067"></a><span class="w">          </span><span class="n">insd</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">dwords</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">DI</span><span class="p">]</span>
<a id="line-3068" name="line-3068"></a>
<a id="line-3069" name="line-3069"></a><span class="nl">ata_in_done</span><span class="p">:</span>
<a id="line-3070" name="line-3070"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">di</span>
<a id="line-3071" name="line-3071"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_ata_cmd_data_in</span><span class="p">.</span><span class="n">segment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">es</span>
<a id="line-3072" name="line-3072"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-3073" name="line-3073"></a><span class="n">ASM_END</span>
<a id="line-3074" name="line-3074"></a>
<a id="line-3075" name="line-3075"></a><span class="w">    </span><span class="n">current</span><span class="o">++</span><span class="p">;</span>
<a id="line-3076" name="line-3076"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">,</span><span class="n">current</span><span class="p">);</span>
<a id="line-3077" name="line-3077"></a><span class="w">    </span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a id="line-3078" name="line-3078"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3079" name="line-3079"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3080" name="line-3080"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-3081" name="line-3081"></a><span class="w">          </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3082" name="line-3082"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_in : no sectors left (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3083" name="line-3083"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-3084" name="line-3084"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3085" name="line-3085"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3086" name="line-3086"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3087" name="line-3087"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3088" name="line-3088"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-3089" name="line-3089"></a><span class="w">          </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3090" name="line-3090"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_in : more sectors left (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3091" name="line-3091"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="line-3092" name="line-3092"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3093" name="line-3093"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<a id="line-3094" name="line-3094"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3095" name="line-3095"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3096" name="line-3096"></a><span class="w">  </span><span class="c1">// Enable interrupts</span>
<a id="line-3097" name="line-3097"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="p">);</span>
<a id="line-3098" name="line-3098"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3099" name="line-3099"></a><span class="p">}</span>
<a id="line-3100" name="line-3100"></a>
<a id="line-3101" name="line-3101"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3102" name="line-3102"></a><span class="c1">// ATA/ATAPI driver : execute a data-out command</span>
<a id="line-3103" name="line-3103"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3104" name="line-3104"></a><span class="w">      </span><span class="c1">// returns</span>
<a id="line-3105" name="line-3105"></a><span class="w">      </span><span class="c1">// 0 : no error</span>
<a id="line-3106" name="line-3106"></a><span class="w">      </span><span class="c1">// 1 : BUSY bit set</span>
<a id="line-3107" name="line-3107"></a><span class="w">      </span><span class="c1">// 2 : read error</span>
<a id="line-3108" name="line-3108"></a><span class="w">      </span><span class="c1">// 3 : expected DRQ=1</span>
<a id="line-3109" name="line-3109"></a><span class="w">      </span><span class="c1">// 4 : no sectors left to read/verify</span>
<a id="line-3110" name="line-3110"></a><span class="w">      </span><span class="c1">// 5 : more sectors to read/verify</span>
<a id="line-3111" name="line-3111"></a><span class="w">      </span><span class="c1">// 6 : no sectors left to write</span>
<a id="line-3112" name="line-3112"></a><span class="w">      </span><span class="c1">// 7 : more sectors to write</span>
<a id="line-3113" name="line-3113"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">ata_cmd_data_out</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
<a id="line-3114" name="line-3114"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-3115" name="line-3115"></a><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">;</span>
<a id="line-3116" name="line-3116"></a><span class="p">{</span>
<a id="line-3117" name="line-3117"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3118" name="line-3118"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-3119" name="line-3119"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
<a id="line-3120" name="line-3120"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="line-3121" name="line-3121"></a>
<a id="line-3122" name="line-3122"></a><span class="w">  </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3123" name="line-3123"></a><span class="w">  </span><span class="n">slave</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3124" name="line-3124"></a>
<a id="line-3125" name="line-3125"></a><span class="w">  </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-3126" name="line-3126"></a><span class="w">  </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-3127" name="line-3127"></a><span class="w">  </span><span class="n">mode</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">);</span>
<a id="line-3128" name="line-3128"></a><span class="w">  </span><span class="n">blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x200</span><span class="p">;</span><span class="w"> </span><span class="c1">// was = read_word(ebda_seg, &amp;EbdaData-&gt;ata.devices[device].blksize);</span>
<a id="line-3129" name="line-3129"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_MODE_PIO32</span><span class="p">)</span><span class="w"> </span><span class="n">blksize</span><span class="o">&gt;&gt;=</span><span class="mi">2</span><span class="p">;</span>
<a id="line-3130" name="line-3130"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="n">blksize</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-3131" name="line-3131"></a>
<a id="line-3132" name="line-3132"></a><span class="w">  </span><span class="c1">// Reset count of transferred data</span>
<a id="line-3133" name="line-3133"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-3134" name="line-3134"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfbytes</span><span class="p">,</span><span class="mf">0L</span><span class="p">);</span>
<a id="line-3135" name="line-3135"></a><span class="w">  </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3136" name="line-3136"></a>
<a id="line-3137" name="line-3137"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-3138" name="line-3138"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3139" name="line-3139"></a>
<a id="line-3140" name="line-3140"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="p">);</span>
<a id="line-3141" name="line-3141"></a>
<a id="line-3142" name="line-3142"></a><span class="w">  </span><span class="c1">// sector will be 0 only on lba access. Convert to lba-chs</span>
<a id="line-3143" name="line-3143"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3144" name="line-3144"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">lba_low</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">28</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3145" name="line-3145"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_FR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3146" name="line-3146"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-3147" name="line-3147"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">);</span>
<a id="line-3148" name="line-3148"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-3149" name="line-3149"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3150" name="line-3150"></a><span class="w">      </span><span class="n">command</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-3151" name="line-3151"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3152" name="line-3152"></a><span class="w">      </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3153" name="line-3153"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3154" name="line-3154"></a><span class="w">    </span><span class="n">sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">lba_low</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ffL</span><span class="p">);</span>
<a id="line-3155" name="line-3155"></a><span class="w">    </span><span class="n">cylinder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">lba_low</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ffffL</span><span class="p">);</span>
<a id="line-3156" name="line-3156"></a><span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">lba_low</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000000fL</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DH_LBA</span><span class="p">;</span>
<a id="line-3157" name="line-3157"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3158" name="line-3158"></a>
<a id="line-3159" name="line-3159"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_FR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3160" name="line-3160"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="line-3161" name="line-3161"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-3162" name="line-3162"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span>
<a id="line-3163" name="line-3163"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3164" name="line-3164"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">slave</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit8u</span><span class="p">)</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="p">);</span>
<a id="line-3165" name="line-3165"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CMD</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">);</span>
<a id="line-3166" name="line-3166"></a>
<a id="line-3167" name="line-3167"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY_DRQ</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3168" name="line-3168"></a>
<a id="line-3169" name="line-3169"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3170" name="line-3170"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_out : read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3171" name="line-3171"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3172" name="line-3172"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3173" name="line-3173"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_out : DRQ not set (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3174" name="line-3174"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3175" name="line-3175"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3176" name="line-3176"></a>
<a id="line-3177" name="line-3177"></a><span class="w">  </span><span class="c1">// FIXME : move seg/off translation here</span>
<a id="line-3178" name="line-3178"></a>
<a id="line-3179" name="line-3179"></a><span class="n">ASM_START</span>
<a id="line-3180" name="line-3180"></a><span class="w">        </span><span class="n">sti</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-3181" name="line-3181"></a><span class="n">ASM_END</span>
<a id="line-3182" name="line-3182"></a>
<a id="line-3183" name="line-3183"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3184" name="line-3184"></a>
<a id="line-3185" name="line-3185"></a><span class="n">ASM_START</span>
<a id="line-3186" name="line-3186"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-3187" name="line-3187"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-3188" name="line-3188"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3189" name="line-3189"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">segment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3190" name="line-3190"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">blksize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3191" name="line-3191"></a>
<a id="line-3192" name="line-3192"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">overrun</span><span class="p">.</span><span class="w"> </span><span class="mi">2</span><span class="n">K</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="n">size</span>
<a id="line-3193" name="line-3193"></a><span class="w">        </span><span class="n">cmp</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf800</span><span class="w"> </span><span class="p">;;</span>
<a id="line-3194" name="line-3194"></a><span class="w">        </span><span class="n">jbe</span><span class="w">   </span><span class="n">ata_out_no_adjust</span>
<a id="line-3195" name="line-3195"></a>
<a id="line-3196" name="line-3196"></a><span class="nl">ata_out_adjust</span><span class="p">:</span>
<a id="line-3197" name="line-3197"></a><span class="w">        </span><span class="n">sub</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0800</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">kbytes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">offset</span>
<a id="line-3198" name="line-3198"></a><span class="w">        </span><span class="n">add</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0080</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Kbytes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">segment</span>
<a id="line-3199" name="line-3199"></a>
<a id="line-3200" name="line-3200"></a><span class="nl">ata_out_no_adjust</span><span class="p">:</span>
<a id="line-3201" name="line-3201"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">es</span>
<a id="line-3202" name="line-3202"></a>
<a id="line-3203" name="line-3203"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ATA</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">port</span>
<a id="line-3204" name="line-3204"></a>
<a id="line-3205" name="line-3205"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3206" name="line-3206"></a><span class="w">        </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">ATA_MODE_PIO32</span>
<a id="line-3207" name="line-3207"></a><span class="w">        </span><span class="n">je</span><span class="w">   </span><span class="n">ata_out_32</span>
<a id="line-3208" name="line-3208"></a>
<a id="line-3209" name="line-3209"></a><span class="nl">ata_out_16</span><span class="p">:</span>
<a id="line-3210" name="line-3210"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="n">ES</span>
<a id="line-3211" name="line-3211"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3212" name="line-3212"></a><span class="w">          </span><span class="n">outsw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">SI</span><span class="p">]</span>
<a id="line-3213" name="line-3213"></a><span class="w">        </span><span class="n">jmp</span><span class="w"> </span><span class="n">ata_out_done</span>
<a id="line-3214" name="line-3214"></a>
<a id="line-3215" name="line-3215"></a><span class="nl">ata_out_32</span><span class="p">:</span>
<a id="line-3216" name="line-3216"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="n">ES</span>
<a id="line-3217" name="line-3217"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3218" name="line-3218"></a><span class="w">          </span><span class="n">outsd</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">dwords</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">SI</span><span class="p">]</span>
<a id="line-3219" name="line-3219"></a>
<a id="line-3220" name="line-3220"></a><span class="nl">ata_out_done</span><span class="p">:</span>
<a id="line-3221" name="line-3221"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">si</span>
<a id="line-3222" name="line-3222"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_ata_cmd_data_out</span><span class="p">.</span><span class="n">segment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">es</span>
<a id="line-3223" name="line-3223"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-3224" name="line-3224"></a><span class="n">ASM_END</span>
<a id="line-3225" name="line-3225"></a>
<a id="line-3226" name="line-3226"></a><span class="w">    </span><span class="n">current</span><span class="o">++</span><span class="p">;</span>
<a id="line-3227" name="line-3227"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">,</span><span class="n">current</span><span class="p">);</span>
<a id="line-3228" name="line-3228"></a><span class="w">    </span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a id="line-3229" name="line-3229"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3230" name="line-3230"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3231" name="line-3231"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DF</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-3232" name="line-3232"></a><span class="w">          </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3233" name="line-3233"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_out : no sectors left (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3234" name="line-3234"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<a id="line-3235" name="line-3235"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3236" name="line-3236"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3237" name="line-3237"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3238" name="line-3238"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3239" name="line-3239"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-3240" name="line-3240"></a><span class="w">          </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3241" name="line-3241"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_data_out : more sectors left (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3242" name="line-3242"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<a id="line-3243" name="line-3243"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3244" name="line-3244"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<a id="line-3245" name="line-3245"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3246" name="line-3246"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3247" name="line-3247"></a><span class="w">  </span><span class="c1">// Enable interrupts</span>
<a id="line-3248" name="line-3248"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="p">);</span>
<a id="line-3249" name="line-3249"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3250" name="line-3250"></a><span class="p">}</span>
<a id="line-3251" name="line-3251"></a>
<a id="line-3252" name="line-3252"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3253" name="line-3253"></a><span class="c1">// ATA/ATAPI driver : execute a packet command</span>
<a id="line-3254" name="line-3254"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3255" name="line-3255"></a><span class="w">      </span><span class="c1">// returns</span>
<a id="line-3256" name="line-3256"></a><span class="w">      </span><span class="c1">// 0 : no error</span>
<a id="line-3257" name="line-3257"></a><span class="w">      </span><span class="c1">// 1 : error in parameters</span>
<a id="line-3258" name="line-3258"></a><span class="w">      </span><span class="c1">// 2 : BUSY bit set</span>
<a id="line-3259" name="line-3259"></a><span class="w">      </span><span class="c1">// 3 : error</span>
<a id="line-3260" name="line-3260"></a><span class="w">      </span><span class="c1">// 4 : not ready</span>
<a id="line-3261" name="line-3261"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">cmdlen</span><span class="p">,</span><span class="w"> </span><span class="n">cmdseg</span><span class="p">,</span><span class="w"> </span><span class="n">cmdoff</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">inout</span><span class="p">,</span><span class="w"> </span><span class="n">bufseg</span><span class="p">,</span><span class="w"> </span><span class="n">bufoff</span><span class="p">)</span>
<a id="line-3262" name="line-3262"></a><span class="n">Bit8u</span><span class="w">  </span><span class="n">cmdlen</span><span class="p">,</span><span class="n">inout</span><span class="p">;</span>
<a id="line-3263" name="line-3263"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="n">cmdseg</span><span class="p">,</span><span class="w"> </span><span class="n">cmdoff</span><span class="p">,</span><span class="w"> </span><span class="n">bufseg</span><span class="p">,</span><span class="w"> </span><span class="n">bufoff</span><span class="p">;</span>
<a id="line-3264" name="line-3264"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">header</span><span class="p">;</span>
<a id="line-3265" name="line-3265"></a><span class="n">Bit32u</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<a id="line-3266" name="line-3266"></a><span class="p">{</span>
<a id="line-3267" name="line-3267"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3268" name="line-3268"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">;</span>
<a id="line-3269" name="line-3269"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">lcount</span><span class="p">,</span><span class="w"> </span><span class="n">lbefore</span><span class="p">,</span><span class="w"> </span><span class="n">lafter</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-3270" name="line-3270"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="p">;</span>
<a id="line-3271" name="line-3271"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">lmode</span><span class="p">;</span>
<a id="line-3272" name="line-3272"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">transfer</span><span class="p">;</span>
<a id="line-3273" name="line-3273"></a>
<a id="line-3274" name="line-3274"></a><span class="w">  </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3275" name="line-3275"></a><span class="w">  </span><span class="n">slave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3276" name="line-3276"></a>
<a id="line-3277" name="line-3277"></a><span class="w">  </span><span class="c1">// Data out is not supported yet</span>
<a id="line-3278" name="line-3278"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_DATA_OUT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3279" name="line-3279"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet: DATA_OUT not supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3280" name="line-3280"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3281" name="line-3281"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3282" name="line-3282"></a>
<a id="line-3283" name="line-3283"></a><span class="w">  </span><span class="c1">// The header length must be even</span>
<a id="line-3284" name="line-3284"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3285" name="line-3285"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet : header must be even (%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">header</span><span class="p">);</span>
<a id="line-3286" name="line-3286"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3287" name="line-3287"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3288" name="line-3288"></a>
<a id="line-3289" name="line-3289"></a><span class="w">  </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-3290" name="line-3290"></a><span class="w">  </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-3291" name="line-3291"></a><span class="w">  </span><span class="n">mode</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">);</span>
<a id="line-3292" name="line-3292"></a><span class="w">  </span><span class="n">transfer</span><span class="o">=</span><span class="w"> </span><span class="mf">0L</span><span class="p">;</span>
<a id="line-3293" name="line-3293"></a>
<a id="line-3294" name="line-3294"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmdlen</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="n">cmdlen</span><span class="o">=</span><span class="mi">12</span><span class="p">;</span>
<a id="line-3295" name="line-3295"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmdlen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="n">cmdlen</span><span class="o">=</span><span class="mi">16</span><span class="p">;</span>
<a id="line-3296" name="line-3296"></a><span class="w">  </span><span class="n">cmdlen</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-3297" name="line-3297"></a>
<a id="line-3298" name="line-3298"></a><span class="w">  </span><span class="c1">// Reset count of transferred data</span>
<a id="line-3299" name="line-3299"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-3300" name="line-3300"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfbytes</span><span class="p">,</span><span class="mf">0L</span><span class="p">);</span>
<a id="line-3301" name="line-3301"></a>
<a id="line-3302" name="line-3302"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-3303" name="line-3303"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3304" name="line-3304"></a>
<a id="line-3305" name="line-3305"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_DC_NIEN</span><span class="p">);</span>
<a id="line-3306" name="line-3306"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_FR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3307" name="line-3307"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3308" name="line-3308"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SN</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3309" name="line-3309"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfff0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span>
<a id="line-3310" name="line-3310"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfff0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3311" name="line-3311"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DH</span><span class="p">,</span><span class="w"> </span><span class="n">slave</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ATA_CB_DH_DEV0</span><span class="p">);</span>
<a id="line-3312" name="line-3312"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CMD</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CMD_PACKET</span><span class="p">);</span>
<a id="line-3313" name="line-3313"></a>
<a id="line-3314" name="line-3314"></a><span class="w">  </span><span class="c1">// Device should ok to receive command</span>
<a id="line-3315" name="line-3315"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY_DRQ</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3316" name="line-3316"></a>
<a id="line-3317" name="line-3317"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3318" name="line-3318"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet : error, status is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<a id="line-3319" name="line-3319"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3320" name="line-3320"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3321" name="line-3321"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet : DRQ not set (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3322" name="line-3322"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-3323" name="line-3323"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3324" name="line-3324"></a>
<a id="line-3325" name="line-3325"></a><span class="w">  </span><span class="c1">// Normalize address</span>
<a id="line-3326" name="line-3326"></a><span class="w">  </span><span class="n">cmdseg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">cmdoff</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-3327" name="line-3327"></a><span class="w">  </span><span class="n">cmdoff</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-3328" name="line-3328"></a>
<a id="line-3329" name="line-3329"></a><span class="w">  </span><span class="c1">// Send command to device</span>
<a id="line-3330" name="line-3330"></a><span class="n">ASM_START</span>
<a id="line-3331" name="line-3331"></a><span class="w">      </span><span class="n">sti</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-3332" name="line-3332"></a>
<a id="line-3333" name="line-3333"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-3334" name="line-3334"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-3335" name="line-3335"></a>
<a id="line-3336" name="line-3336"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">cmdoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3337" name="line-3337"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">cmdseg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3338" name="line-3338"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">cmdlen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3339" name="line-3339"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">es</span>
<a id="line-3340" name="line-3340"></a>
<a id="line-3341" name="line-3341"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ATA</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">port</span>
<a id="line-3342" name="line-3342"></a>
<a id="line-3343" name="line-3343"></a><span class="w">      </span><span class="n">seg</span><span class="w"> </span><span class="n">ES</span>
<a id="line-3344" name="line-3344"></a><span class="w">      </span><span class="n">rep</span>
<a id="line-3345" name="line-3345"></a><span class="w">        </span><span class="n">outsw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">SI</span><span class="p">]</span>
<a id="line-3346" name="line-3346"></a>
<a id="line-3347" name="line-3347"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-3348" name="line-3348"></a><span class="n">ASM_END</span>
<a id="line-3349" name="line-3349"></a>
<a id="line-3350" name="line-3350"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inout</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_DATA_NO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3351" name="line-3351"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3352" name="line-3352"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3353" name="line-3353"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3354" name="line-3354"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">loops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3355" name="line-3355"></a><span class="w">        </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">sc</span><span class="p">;</span>
<a id="line-3356" name="line-3356"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3357" name="line-3357"></a>
<a id="line-3358" name="line-3358"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loops</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="c1">//first time through</span>
<a id="line-3359" name="line-3359"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_ASTAT</span><span class="p">);</span>
<a id="line-3360" name="line-3360"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY_DRQ</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3361" name="line-3361"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3362" name="line-3362"></a><span class="w">      </span><span class="k">else</span>
<a id="line-3363" name="line-3363"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await_ide</span><span class="p">(</span><span class="n">NOT_BSY</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">IDE_TIMEOUT</span><span class="p">);</span>
<a id="line-3364" name="line-3364"></a><span class="w">      </span><span class="n">loops</span><span class="o">++</span><span class="p">;</span>
<a id="line-3365" name="line-3365"></a>
<a id="line-3366" name="line-3366"></a><span class="w">      </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">);</span>
<a id="line-3367" name="line-3367"></a>
<a id="line-3368" name="line-3368"></a><span class="w">      </span><span class="c1">// Check if command completed</span>
<a id="line-3369" name="line-3369"></a><span class="w">      </span><span class="k">if</span><span class="p">(((</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_SC</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x7</span><span class="p">)</span><span class="o">==</span><span class="mh">0x3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="line-3370" name="line-3370"></a><span class="w">         </span><span class="p">((</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-3371" name="line-3371"></a>
<a id="line-3372" name="line-3372"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3373" name="line-3373"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet : error (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
<a id="line-3374" name="line-3374"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3375" name="line-3375"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3376" name="line-3376"></a>
<a id="line-3377" name="line-3377"></a><span class="w">      </span><span class="c1">// Normalize address</span>
<a id="line-3378" name="line-3378"></a><span class="w">      </span><span class="n">bufseg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">bufoff</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-3379" name="line-3379"></a><span class="w">      </span><span class="n">bufoff</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-3380" name="line-3380"></a>
<a id="line-3381" name="line-3381"></a><span class="w">      </span><span class="c1">// Get the byte count</span>
<a id="line-3382" name="line-3382"></a><span class="w">      </span><span class="n">lcount</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CH</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_CL</span><span class="p">);</span>
<a id="line-3383" name="line-3383"></a>
<a id="line-3384" name="line-3384"></a><span class="w">      </span><span class="c1">// adjust to read what we want</span>
<a id="line-3385" name="line-3385"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">header</span><span class="o">&gt;</span><span class="n">lcount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3386" name="line-3386"></a><span class="w">         </span><span class="n">lbefore</span><span class="o">=</span><span class="n">lcount</span><span class="p">;</span>
<a id="line-3387" name="line-3387"></a><span class="w">         </span><span class="n">header</span><span class="o">-=</span><span class="n">lcount</span><span class="p">;</span>
<a id="line-3388" name="line-3388"></a><span class="w">         </span><span class="n">lcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-3389" name="line-3389"></a><span class="w">         </span><span class="p">}</span>
<a id="line-3390" name="line-3390"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3391" name="line-3391"></a><span class="w">        </span><span class="n">lbefore</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
<a id="line-3392" name="line-3392"></a><span class="w">        </span><span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-3393" name="line-3393"></a><span class="w">        </span><span class="n">lcount</span><span class="o">-=</span><span class="n">lbefore</span><span class="p">;</span>
<a id="line-3394" name="line-3394"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3395" name="line-3395"></a>
<a id="line-3396" name="line-3396"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">lcount</span><span class="o">&gt;</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3397" name="line-3397"></a><span class="w">        </span><span class="n">lafter</span><span class="o">=</span><span class="n">lcount</span><span class="o">-</span><span class="n">length</span><span class="p">;</span>
<a id="line-3398" name="line-3398"></a><span class="w">        </span><span class="n">lcount</span><span class="o">=</span><span class="n">length</span><span class="p">;</span>
<a id="line-3399" name="line-3399"></a><span class="w">        </span><span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-3400" name="line-3400"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3401" name="line-3401"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3402" name="line-3402"></a><span class="w">        </span><span class="n">lafter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-3403" name="line-3403"></a><span class="w">        </span><span class="n">length</span><span class="o">-=</span><span class="n">lcount</span><span class="p">;</span>
<a id="line-3404" name="line-3404"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3405" name="line-3405"></a>
<a id="line-3406" name="line-3406"></a><span class="w">      </span><span class="c1">// Save byte count</span>
<a id="line-3407" name="line-3407"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lcount</span><span class="p">;</span>
<a id="line-3408" name="line-3408"></a>
<a id="line-3409" name="line-3409"></a><span class="w">      </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;Trying to read %04x bytes (%04x %04x %04x) &quot;</span><span class="p">,</span><span class="n">lbefore</span><span class="o">+</span><span class="n">lcount</span><span class="o">+</span><span class="n">lafter</span><span class="p">,</span><span class="n">lbefore</span><span class="p">,</span><span class="n">lcount</span><span class="p">,</span><span class="n">lafter</span><span class="p">);</span>
<a id="line-3410" name="line-3410"></a><span class="w">      </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;to 0x%04x:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bufseg</span><span class="p">,</span><span class="n">bufoff</span><span class="p">);</span>
<a id="line-3411" name="line-3411"></a>
<a id="line-3412" name="line-3412"></a><span class="w">      </span><span class="c1">// If counts not dividable by 4, use 16bits mode</span>
<a id="line-3413" name="line-3413"></a><span class="w">      </span><span class="n">lmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="line-3414" name="line-3414"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lbefore</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="n">lmode</span><span class="o">=</span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-3415" name="line-3415"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lcount</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="n">lmode</span><span class="o">=</span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-3416" name="line-3416"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lafter</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="n">lmode</span><span class="o">=</span><span class="n">ATA_MODE_PIO16</span><span class="p">;</span>
<a id="line-3417" name="line-3417"></a>
<a id="line-3418" name="line-3418"></a><span class="w">      </span><span class="c1">// adds an extra byte if count are odd. before is always even</span>
<a id="line-3419" name="line-3419"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lcount</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3420" name="line-3420"></a><span class="w">        </span><span class="n">lcount</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-3421" name="line-3421"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">lafter</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">lafter</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3422" name="line-3422"></a><span class="w">          </span><span class="n">lafter</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-3423" name="line-3423"></a><span class="w">          </span><span class="p">}</span>
<a id="line-3424" name="line-3424"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3425" name="line-3425"></a>
<a id="line-3426" name="line-3426"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_MODE_PIO32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3427" name="line-3427"></a><span class="w">        </span><span class="n">lcount</span><span class="o">&gt;&gt;=</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">lbefore</span><span class="o">&gt;&gt;=</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">lafter</span><span class="o">&gt;&gt;=</span><span class="mi">2</span><span class="p">;</span>
<a id="line-3428" name="line-3428"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3429" name="line-3429"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3430" name="line-3430"></a><span class="w">        </span><span class="n">lcount</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">lbefore</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">lafter</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
<a id="line-3431" name="line-3431"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3432" name="line-3432"></a>
<a id="line-3433" name="line-3433"></a><span class="w">       </span><span class="p">;</span><span class="w">  </span><span class="c1">// FIXME bcc bug</span>
<a id="line-3434" name="line-3434"></a>
<a id="line-3435" name="line-3435"></a><span class="n">ASM_START</span>
<a id="line-3436" name="line-3436"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-3437" name="line-3437"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-3438" name="line-3438"></a>
<a id="line-3439" name="line-3439"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">iobase1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ATA</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">port</span>
<a id="line-3440" name="line-3440"></a>
<a id="line-3441" name="line-3441"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lbefore</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3442" name="line-3442"></a><span class="w">        </span><span class="n">jcxz</span><span class="w"> </span><span class="n">ata_packet_no_before</span>
<a id="line-3443" name="line-3443"></a>
<a id="line-3444" name="line-3444"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lmode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3445" name="line-3445"></a><span class="w">        </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">ATA_MODE_PIO32</span>
<a id="line-3446" name="line-3446"></a><span class="w">        </span><span class="n">je</span><span class="w">   </span><span class="n">ata_packet_in_before_32</span>
<a id="line-3447" name="line-3447"></a>
<a id="line-3448" name="line-3448"></a><span class="nl">ata_packet_in_before_16</span><span class="p">:</span>
<a id="line-3449" name="line-3449"></a><span class="w">        </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-3450" name="line-3450"></a><span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="n">ata_packet_in_before_16</span>
<a id="line-3451" name="line-3451"></a><span class="w">        </span><span class="n">jmp</span><span class="w">  </span><span class="n">ata_packet_no_before</span>
<a id="line-3452" name="line-3452"></a>
<a id="line-3453" name="line-3453"></a><span class="nl">ata_packet_in_before_32</span><span class="p">:</span>
<a id="line-3454" name="line-3454"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-3455" name="line-3455"></a><span class="nl">ata_packet_in_before_32_loop</span><span class="p">:</span>
<a id="line-3456" name="line-3456"></a><span class="w">        </span><span class="n">in</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-3457" name="line-3457"></a><span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="n">ata_packet_in_before_32_loop</span>
<a id="line-3458" name="line-3458"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">eax</span>
<a id="line-3459" name="line-3459"></a>
<a id="line-3460" name="line-3460"></a><span class="nl">ata_packet_no_before</span><span class="p">:</span>
<a id="line-3461" name="line-3461"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lcount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3462" name="line-3462"></a><span class="w">        </span><span class="n">jcxz</span><span class="w"> </span><span class="n">ata_packet_after</span>
<a id="line-3463" name="line-3463"></a>
<a id="line-3464" name="line-3464"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">bufoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3465" name="line-3465"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">bufseg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3466" name="line-3466"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-3467" name="line-3467"></a>
<a id="line-3468" name="line-3468"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lmode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3469" name="line-3469"></a><span class="w">        </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">ATA_MODE_PIO32</span>
<a id="line-3470" name="line-3470"></a><span class="w">        </span><span class="n">je</span><span class="w">   </span><span class="n">ata_packet_in_32</span>
<a id="line-3471" name="line-3471"></a>
<a id="line-3472" name="line-3472"></a><span class="nl">ata_packet_in_16</span><span class="p">:</span>
<a id="line-3473" name="line-3473"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3474" name="line-3474"></a><span class="w">          </span><span class="n">insw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">tp</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">DI</span><span class="p">]</span>
<a id="line-3475" name="line-3475"></a><span class="w">        </span><span class="n">jmp</span><span class="w"> </span><span class="n">ata_packet_after</span>
<a id="line-3476" name="line-3476"></a>
<a id="line-3477" name="line-3477"></a><span class="nl">ata_packet_in_32</span><span class="p">:</span>
<a id="line-3478" name="line-3478"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-3479" name="line-3479"></a><span class="w">          </span><span class="n">insd</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">dwords</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">DI</span><span class="p">]</span>
<a id="line-3480" name="line-3480"></a>
<a id="line-3481" name="line-3481"></a><span class="nl">ata_packet_after</span><span class="p">:</span>
<a id="line-3482" name="line-3482"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lafter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3483" name="line-3483"></a><span class="w">        </span><span class="n">jcxz</span><span class="w"> </span><span class="n">ata_packet_done</span>
<a id="line-3484" name="line-3484"></a>
<a id="line-3485" name="line-3485"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_ata_cmd_packet</span><span class="p">.</span><span class="n">lmode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-3486" name="line-3486"></a><span class="w">        </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">ATA_MODE_PIO32</span>
<a id="line-3487" name="line-3487"></a><span class="w">        </span><span class="n">je</span><span class="w">   </span><span class="n">ata_packet_in_after_32</span>
<a id="line-3488" name="line-3488"></a>
<a id="line-3489" name="line-3489"></a><span class="nl">ata_packet_in_after_16</span><span class="p">:</span>
<a id="line-3490" name="line-3490"></a><span class="w">        </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-3491" name="line-3491"></a><span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="n">ata_packet_in_after_16</span>
<a id="line-3492" name="line-3492"></a><span class="w">        </span><span class="n">jmp</span><span class="w">  </span><span class="n">ata_packet_done</span>
<a id="line-3493" name="line-3493"></a>
<a id="line-3494" name="line-3494"></a><span class="nl">ata_packet_in_after_32</span><span class="p">:</span>
<a id="line-3495" name="line-3495"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-3496" name="line-3496"></a><span class="nl">ata_packet_in_after_32_loop</span><span class="p">:</span>
<a id="line-3497" name="line-3497"></a><span class="w">        </span><span class="n">in</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-3498" name="line-3498"></a><span class="w">        </span><span class="n">loop</span><span class="w"> </span><span class="n">ata_packet_in_after_32_loop</span>
<a id="line-3499" name="line-3499"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">eax</span>
<a id="line-3500" name="line-3500"></a>
<a id="line-3501" name="line-3501"></a><span class="nl">ata_packet_done</span><span class="p">:</span>
<a id="line-3502" name="line-3502"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-3503" name="line-3503"></a><span class="n">ASM_END</span>
<a id="line-3504" name="line-3504"></a>
<a id="line-3505" name="line-3505"></a><span class="w">      </span><span class="c1">// Compute new buffer address</span>
<a id="line-3506" name="line-3506"></a><span class="w">      </span><span class="n">bufoff</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-3507" name="line-3507"></a>
<a id="line-3508" name="line-3508"></a><span class="w">      </span><span class="c1">// Save transferred bytes count</span>
<a id="line-3509" name="line-3509"></a><span class="w">      </span><span class="n">transfer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-3510" name="line-3510"></a><span class="w">      </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfbytes</span><span class="p">,</span><span class="n">transfer</span><span class="p">);</span>
<a id="line-3511" name="line-3511"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3512" name="line-3512"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3513" name="line-3513"></a>
<a id="line-3514" name="line-3514"></a><span class="w">  </span><span class="c1">// Final check, device must be ready</span>
<a id="line-3515" name="line-3515"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DF</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_DRQ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_ERR</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-3516" name="line-3516"></a><span class="w">         </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3517" name="line-3517"></a><span class="w">    </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_cmd_packet : not ready (status %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-3518" name="line-3518"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-3519" name="line-3519"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3520" name="line-3520"></a>
<a id="line-3521" name="line-3521"></a><span class="w">  </span><span class="c1">// Enable interrupts</span>
<a id="line-3522" name="line-3522"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="n">iobase2</span><span class="o">+</span><span class="n">ATA_CB_DC</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CB_DC_HD15</span><span class="p">);</span>
<a id="line-3523" name="line-3523"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3524" name="line-3524"></a><span class="p">}</span>
<a id="line-3525" name="line-3525"></a>
<a id="line-3526" name="line-3526"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3527" name="line-3527"></a><span class="c1">// End of ATA/ATAPI Driver</span>
<a id="line-3528" name="line-3528"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3529" name="line-3529"></a>
<a id="line-3530" name="line-3530"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3531" name="line-3531"></a><span class="c1">// Start of ATA/ATAPI generic functions</span>
<a id="line-3532" name="line-3532"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3533" name="line-3533"></a>
<a id="line-3534" name="line-3534"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-3535" name="line-3535"></a><span class="n">atapi_get_sense</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">asc</span><span class="p">,</span><span class="w"> </span><span class="n">ascq</span><span class="p">)</span>
<a id="line-3536" name="line-3536"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<a id="line-3537" name="line-3537"></a><span class="p">{</span>
<a id="line-3538" name="line-3538"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<a id="line-3539" name="line-3539"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">buffer</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
<a id="line-3540" name="line-3540"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-3541" name="line-3541"></a>
<a id="line-3542" name="line-3542"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-3543" name="line-3543"></a>
<a id="line-3544" name="line-3544"></a><span class="w">  </span><span class="c1">// Request SENSE</span>
<a id="line-3545" name="line-3545"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ATA_CMD_REQUEST_SENSE</span><span class="p">;</span>
<a id="line-3546" name="line-3546"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<a id="line-3547" name="line-3547"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">18L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3548" name="line-3548"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mh">0x0002</span><span class="p">;</span>
<a id="line-3549" name="line-3549"></a>
<a id="line-3550" name="line-3550"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="n">asc</span><span class="p">,</span><span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
<a id="line-3551" name="line-3551"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="n">ascq</span><span class="p">,</span><span class="n">buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<a id="line-3552" name="line-3552"></a>
<a id="line-3553" name="line-3553"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3554" name="line-3554"></a><span class="p">}</span>
<a id="line-3555" name="line-3555"></a>
<a id="line-3556" name="line-3556"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-3557" name="line-3557"></a><span class="n">atapi_is_ready</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="line-3558" name="line-3558"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<a id="line-3559" name="line-3559"></a><span class="p">{</span>
<a id="line-3560" name="line-3560"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">packet</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<a id="line-3561" name="line-3561"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<a id="line-3562" name="line-3562"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">block_len</span><span class="p">;</span>
<a id="line-3563" name="line-3563"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">sectors</span><span class="p">;</span>
<a id="line-3564" name="line-3564"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span><span class="w"> </span><span class="c1">//measured in ms</span>
<a id="line-3565" name="line-3565"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<a id="line-3566" name="line-3566"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">asc</span><span class="p">,</span><span class="w"> </span><span class="n">ascq</span><span class="p">;</span>
<a id="line-3567" name="line-3567"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">in_progress</span><span class="p">;</span>
<a id="line-3568" name="line-3568"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3569" name="line-3569"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_TYPE_ATAPI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3570" name="line-3570"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;not implemented for non-ATAPI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3571" name="line-3571"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="line-3572" name="line-3572"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3573" name="line-3573"></a>
<a id="line-3574" name="line-3574"></a><span class="w">  </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;ata_detect_medium: begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3575" name="line-3575"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">packet</span><span class="p">);</span>
<a id="line-3576" name="line-3576"></a><span class="w">  </span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x25</span><span class="p">;</span><span class="w"> </span><span class="cm">/* READ CAPACITY */</span>
<a id="line-3577" name="line-3577"></a>
<a id="line-3578" name="line-3578"></a><span class="w">  </span><span class="cm">/* Retry READ CAPACITY 50 times unless MEDIUM NOT PRESENT</span>
<a id="line-3579" name="line-3579"></a><span class="cm">   * is reported by the device. If the device reports &quot;IN PROGRESS&quot;,</span>
<a id="line-3580" name="line-3580"></a><span class="cm">   * 30 seconds is added. */</span>
<a id="line-3581" name="line-3581"></a><span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span>
<a id="line-3582" name="line-3582"></a><span class="w">  </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3583" name="line-3583"></a><span class="w">  </span><span class="n">in_progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3584" name="line-3584"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3585" name="line-3585"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">packet</span><span class="p">),</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3586" name="line-3586"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span>
<a id="line-3587" name="line-3587"></a>
<a id="line-3588" name="line-3588"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atapi_get_sense</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">asc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ascq</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3589" name="line-3589"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">asc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x3a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* MEDIUM NOT PRESENT */</span>
<a id="line-3590" name="line-3590"></a><span class="w">        </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;Device reports MEDIUM NOT PRESENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3591" name="line-3591"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="line-3592" name="line-3592"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3593" name="line-3593"></a>
<a id="line-3594" name="line-3594"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">asc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x04</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ascq</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">in_progress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3595" name="line-3595"></a><span class="w">        </span><span class="cm">/* IN PROGRESS OF BECOMING READY */</span>
<a id="line-3596" name="line-3596"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Waiting for device to detect medium... &quot;</span><span class="p">);</span>
<a id="line-3597" name="line-3597"></a><span class="w">        </span><span class="cm">/* Allow 30 seconds more */</span>
<a id="line-3598" name="line-3598"></a><span class="w">        </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30000</span><span class="p">;</span>
<a id="line-3599" name="line-3599"></a><span class="w">        </span><span class="n">in_progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3600" name="line-3600"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3601" name="line-3601"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3602" name="line-3602"></a><span class="w">    </span><span class="n">time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<a id="line-3603" name="line-3603"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3604" name="line-3604"></a><span class="w">  </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;read capacity failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-3605" name="line-3605"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="line-3606" name="line-3606"></a><span class="nl">ok</span><span class="p">:</span>
<a id="line-3607" name="line-3607"></a>
<a id="line-3608" name="line-3608"></a><span class="w">  </span><span class="n">block_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span>
<a id="line-3609" name="line-3609"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span>
<a id="line-3610" name="line-3610"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span>
<a id="line-3611" name="line-3611"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3612" name="line-3612"></a><span class="w">  </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;block_len=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">block_len</span><span class="p">);</span>
<a id="line-3613" name="line-3613"></a>
<a id="line-3614" name="line-3614"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_len</span><span class="o">!=</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">block_len</span><span class="o">!=</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span>
<a id="line-3615" name="line-3615"></a><span class="w">  </span><span class="p">{</span>
<a id="line-3616" name="line-3616"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unsupported sector size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">block_len</span><span class="p">);</span>
<a id="line-3617" name="line-3617"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="line-3618" name="line-3618"></a><span class="w">  </span><span class="p">}</span>
<a id="line-3619" name="line-3619"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">block_len</span><span class="p">);</span>
<a id="line-3620" name="line-3620"></a>
<a id="line-3621" name="line-3621"></a><span class="w">  </span><span class="n">sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span>
<a id="line-3622" name="line-3622"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span>
<a id="line-3623" name="line-3623"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span>
<a id="line-3624" name="line-3624"></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3625" name="line-3625"></a>
<a id="line-3626" name="line-3626"></a><span class="w">  </span><span class="n">BX_DEBUG_ATA</span><span class="p">(</span><span class="s">&quot;sectors=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sectors</span><span class="p">);</span>
<a id="line-3627" name="line-3627"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block_len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span>
<a id="line-3628" name="line-3628"></a><span class="w">    </span><span class="n">sectors</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* # of sectors in 512-byte &quot;soft&quot; sector */</span>
<a id="line-3629" name="line-3629"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sectors</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">))</span>
<a id="line-3630" name="line-3630"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%dMB medium detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sectors</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">20-9</span><span class="p">));</span>
<a id="line-3631" name="line-3631"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">,</span><span class="w"> </span><span class="n">sectors</span><span class="p">);</span>
<a id="line-3632" name="line-3632"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3633" name="line-3633"></a><span class="p">}</span>
<a id="line-3634" name="line-3634"></a>
<a id="line-3635" name="line-3635"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-3636" name="line-3636"></a><span class="n">atapi_is_cdrom</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="line-3637" name="line-3637"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">device</span><span class="p">;</span>
<a id="line-3638" name="line-3638"></a><span class="p">{</span>
<a id="line-3639" name="line-3639"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3640" name="line-3640"></a>
<a id="line-3641" name="line-3641"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span>
<a id="line-3642" name="line-3642"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3643" name="line-3643"></a>
<a id="line-3644" name="line-3644"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_TYPE_ATAPI</span><span class="p">)</span>
<a id="line-3645" name="line-3645"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3646" name="line-3646"></a>
<a id="line-3647" name="line-3647"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">device</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ATA_DEVICE_CDROM</span><span class="p">)</span>
<a id="line-3648" name="line-3648"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3649" name="line-3649"></a>
<a id="line-3650" name="line-3650"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-3651" name="line-3651"></a><span class="p">}</span>
<a id="line-3652" name="line-3652"></a>
<a id="line-3653" name="line-3653"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3654" name="line-3654"></a><span class="c1">// End of ATA/ATAPI generic functions</span>
<a id="line-3655" name="line-3655"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3656" name="line-3656"></a>
<a id="line-3657" name="line-3657"></a><span class="cp">#endif </span><span class="c1">// BX_USE_ATADRV</span>
<a id="line-3658" name="line-3658"></a>
<a id="line-3659" name="line-3659"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-3660" name="line-3660"></a>
<a id="line-3661" name="line-3661"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3662" name="line-3662"></a><span class="c1">// Start of El-Torito boot functions</span>
<a id="line-3663" name="line-3663"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3664" name="line-3664"></a>
<a id="line-3665" name="line-3665"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-3666" name="line-3666"></a><span class="n">cdemu_init</span><span class="p">()</span>
<a id="line-3667" name="line-3667"></a><span class="p">{</span>
<a id="line-3668" name="line-3668"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3669" name="line-3669"></a>
<a id="line-3670" name="line-3670"></a><span class="w">  </span><span class="c1">// the only important data is this one for now</span>
<a id="line-3671" name="line-3671"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">active</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3672" name="line-3672"></a><span class="p">}</span>
<a id="line-3673" name="line-3673"></a>
<a id="line-3674" name="line-3674"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-3675" name="line-3675"></a><span class="n">cdemu_isactive</span><span class="p">()</span>
<a id="line-3676" name="line-3676"></a><span class="p">{</span>
<a id="line-3677" name="line-3677"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3678" name="line-3678"></a>
<a id="line-3679" name="line-3679"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">active</span><span class="p">));</span>
<a id="line-3680" name="line-3680"></a><span class="p">}</span>
<a id="line-3681" name="line-3681"></a>
<a id="line-3682" name="line-3682"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-3683" name="line-3683"></a><span class="n">cdemu_emulated_drive</span><span class="p">()</span>
<a id="line-3684" name="line-3684"></a><span class="p">{</span>
<a id="line-3685" name="line-3685"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3686" name="line-3686"></a>
<a id="line-3687" name="line-3687"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">));</span>
<a id="line-3688" name="line-3688"></a><span class="p">}</span>
<a id="line-3689" name="line-3689"></a>
<a id="line-3690" name="line-3690"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">isotag</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;CD001&quot;</span><span class="p">;</span>
<a id="line-3691" name="line-3691"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">eltorito</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;EL TORITO SPECIFICATION&quot;</span><span class="p">;</span>
<a id="line-3692" name="line-3692"></a><span class="c1">//</span>
<a id="line-3693" name="line-3693"></a><span class="c1">// Returns ah: emulated drive, al: error code</span>
<a id="line-3694" name="line-3694"></a><span class="c1">//</span>
<a id="line-3695" name="line-3695"></a><span class="w">  </span><span class="n">Bit16u</span>
<a id="line-3696" name="line-3696"></a><span class="nf">cdrom_boot</span><span class="p">()</span>
<a id="line-3697" name="line-3697"></a><span class="p">{</span>
<a id="line-3698" name="line-3698"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3699" name="line-3699"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<a id="line-3700" name="line-3700"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba</span><span class="p">;</span>
<a id="line-3701" name="line-3701"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">boot_segment</span><span class="p">,</span><span class="w"> </span><span class="n">nbsectors</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<a id="line-3702" name="line-3702"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">device</span><span class="p">;</span>
<a id="line-3703" name="line-3703"></a>
<a id="line-3704" name="line-3704"></a><span class="w">  </span><span class="c1">// Find out the first cdrom</span>
<a id="line-3705" name="line-3705"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">device</span><span class="o">&lt;</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">;</span><span class="n">device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3706" name="line-3706"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atapi_is_cdrom</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-3707" name="line-3707"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3708" name="line-3708"></a>
<a id="line-3709" name="line-3709"></a><span class="w">  </span><span class="c1">// if not found</span>
<a id="line-3710" name="line-3710"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-3711" name="line-3711"></a>
<a id="line-3712" name="line-3712"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atapi_is_ready</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3713" name="line-3713"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;ata_is_ready returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
<a id="line-3714" name="line-3714"></a>
<a id="line-3715" name="line-3715"></a><span class="w">  </span><span class="c1">// Read the Boot Record Volume Descriptor</span>
<a id="line-3716" name="line-3716"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-3717" name="line-3717"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x28</span><span class="p">;</span><span class="w">                      </span><span class="c1">// READ command</span>
<a id="line-3718" name="line-3718"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">      </span><span class="c1">// Sectors</span>
<a id="line-3719" name="line-3719"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w">           </span><span class="c1">// Sectors</span>
<a id="line-3720" name="line-3720"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x11</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w"> </span><span class="c1">// LBA</span>
<a id="line-3721" name="line-3721"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x11</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff0000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-3722" name="line-3722"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x11</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-3723" name="line-3723"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x11</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ff</span><span class="p">);</span>
<a id="line-3724" name="line-3724"></a><span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2048L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3725" name="line-3725"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3726" name="line-3726"></a>
<a id="line-3727" name="line-3727"></a><span class="w">  </span><span class="c1">// Validity checks</span>
<a id="line-3728" name="line-3728"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-3729" name="line-3729"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<a id="line-3730" name="line-3730"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0xf000</span><span class="p">,</span><span class="o">&amp;</span><span class="n">isotag</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="line-3731" name="line-3731"></a><span class="w">   </span><span class="p">}</span>
<a id="line-3732" name="line-3732"></a><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">23</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="line-3733" name="line-3733"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="o">+</span><span class="n">i</span><span class="p">])</span><span class="o">!=</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0xf000</span><span class="p">,</span><span class="o">&amp;</span><span class="n">eltorito</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="k">return</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
<a id="line-3734" name="line-3734"></a>
<a id="line-3735" name="line-3735"></a><span class="w">  </span><span class="c1">// ok, now we calculate the Boot catalog address</span>
<a id="line-3736" name="line-3736"></a><span class="w">  </span><span class="n">lba</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x4A</span><span class="p">]</span><span class="o">*</span><span class="mh">0x1000000</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x49</span><span class="p">]</span><span class="o">*</span><span class="mh">0x10000</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x48</span><span class="p">]</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x47</span><span class="p">];</span>
<a id="line-3737" name="line-3737"></a>
<a id="line-3738" name="line-3738"></a><span class="w">  </span><span class="c1">// And we read the Boot Catalog</span>
<a id="line-3739" name="line-3739"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-3740" name="line-3740"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x28</span><span class="p">;</span><span class="w">                      </span><span class="c1">// READ command</span>
<a id="line-3741" name="line-3741"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">      </span><span class="c1">// Sectors</span>
<a id="line-3742" name="line-3742"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w">           </span><span class="c1">// Sectors</span>
<a id="line-3743" name="line-3743"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w">  </span><span class="c1">// LBA</span>
<a id="line-3744" name="line-3744"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff0000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-3745" name="line-3745"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-3746" name="line-3746"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ff</span><span class="p">);</span>
<a id="line-3747" name="line-3747"></a><span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2048L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3748" name="line-3748"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<a id="line-3749" name="line-3749"></a>
<a id="line-3750" name="line-3750"></a><span class="w">  </span><span class="c1">// Validation entry</span>
<a id="line-3751" name="line-3751"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x01</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">   </span><span class="c1">// Header</span>
<a id="line-3752" name="line-3752"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x00</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w">   </span><span class="c1">// Platform</span>
<a id="line-3753" name="line-3753"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x1E</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x55</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span><span class="c1">// key 1</span>
<a id="line-3754" name="line-3754"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x1F</span><span class="p">]</span><span class="o">!=</span><span class="mh">0xAA</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span><span class="c1">// key 2</span>
<a id="line-3755" name="line-3755"></a>
<a id="line-3756" name="line-3756"></a><span class="w">  </span><span class="c1">// Initial/Default Entry</span>
<a id="line-3757" name="line-3757"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span><span class="o">!=</span><span class="mh">0x88</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"> </span><span class="c1">// Bootable</span>
<a id="line-3758" name="line-3758"></a>
<a id="line-3759" name="line-3759"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-3760" name="line-3760"></a><span class="w">  </span><span class="cm">/* specs: 8.2.3 step 5 and 8.2.5.6, measure El Torito boot catalog */</span>
<a id="line-3761" name="line-3761"></a><span class="w">  </span><span class="cm">/* measure 2048 bytes (one sector) */</span>
<a id="line-3762" name="line-3762"></a><span class="w">  </span><span class="n">tcpa_add_bootdevice</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">1L</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">0L</span><span class="p">);</span><span class="w"> </span><span class="cm">/* bootcd = 1 */</span>
<a id="line-3763" name="line-3763"></a><span class="w">  </span><span class="n">tcpa_ipl</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">2L</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">get_SS</span><span class="p">(),(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">buffer</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">2048L</span><span class="p">);</span>
<a id="line-3764" name="line-3764"></a><span class="cp">#endif</span>
<a id="line-3765" name="line-3765"></a>
<a id="line-3766" name="line-3766"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">,</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]);</span>
<a id="line-3767" name="line-3767"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a id="line-3768" name="line-3768"></a><span class="w">    </span><span class="c1">// FIXME ElTorito Hardcoded. cdrom is hardcoded as device 0xE0.</span>
<a id="line-3769" name="line-3769"></a><span class="w">    </span><span class="c1">// Win2000 cd boot needs to know it booted from cd</span>
<a id="line-3770" name="line-3770"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">,</span><span class="mh">0xE0</span><span class="p">);</span>
<a id="line-3771" name="line-3771"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3772" name="line-3772"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x21</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">)</span>
<a id="line-3773" name="line-3773"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-3774" name="line-3774"></a><span class="w">  </span><span class="k">else</span>
<a id="line-3775" name="line-3775"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-3776" name="line-3776"></a>
<a id="line-3777" name="line-3777"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">controller_index</span><span class="p">,</span><span class="n">device</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<a id="line-3778" name="line-3778"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">device_spec</span><span class="p">,</span><span class="n">device</span><span class="o">%</span><span class="mi">2</span><span class="p">);</span>
<a id="line-3779" name="line-3779"></a>
<a id="line-3780" name="line-3780"></a><span class="w">  </span><span class="n">boot_segment</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x23</span><span class="p">]</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x22</span><span class="p">];</span>
<a id="line-3781" name="line-3781"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">boot_segment</span><span class="o">==</span><span class="mh">0x0000</span><span class="p">)</span><span class="n">boot_segment</span><span class="o">=</span><span class="mh">0x07C0</span><span class="p">;</span>
<a id="line-3782" name="line-3782"></a>
<a id="line-3783" name="line-3783"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">load_segment</span><span class="p">,</span><span class="n">boot_segment</span><span class="p">);</span>
<a id="line-3784" name="line-3784"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">buffer_segment</span><span class="p">,</span><span class="mh">0x0000</span><span class="p">);</span>
<a id="line-3785" name="line-3785"></a>
<a id="line-3786" name="line-3786"></a><span class="w">  </span><span class="n">nbsectors</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x27</span><span class="p">]</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x26</span><span class="p">];</span>
<a id="line-3787" name="line-3787"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">sector_count</span><span class="p">,</span><span class="n">nbsectors</span><span class="p">);</span>
<a id="line-3788" name="line-3788"></a>
<a id="line-3789" name="line-3789"></a><span class="w">  </span><span class="n">lba</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x2B</span><span class="p">]</span><span class="o">*</span><span class="mh">0x1000000</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x2A</span><span class="p">]</span><span class="o">*</span><span class="mh">0x10000</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x29</span><span class="p">]</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x28</span><span class="p">];</span>
<a id="line-3790" name="line-3790"></a><span class="w">  </span><span class="n">write_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">ilba</span><span class="p">,</span><span class="n">lba</span><span class="p">);</span>
<a id="line-3791" name="line-3791"></a>
<a id="line-3792" name="line-3792"></a><span class="w">  </span><span class="c1">// And we read the image in memory</span>
<a id="line-3793" name="line-3793"></a><span class="w">  </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-3794" name="line-3794"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x28</span><span class="p">;</span><span class="w">                      </span><span class="c1">// READ command</span>
<a id="line-3795" name="line-3795"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">nbsectors</span><span class="mi">-1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">      </span><span class="c1">// Sectors</span>
<a id="line-3796" name="line-3796"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">nbsectors</span><span class="mi">-1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w">           </span><span class="c1">// Sectors</span>
<a id="line-3797" name="line-3797"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w">  </span><span class="c1">// LBA</span>
<a id="line-3798" name="line-3798"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff0000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-3799" name="line-3799"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-3800" name="line-3800"></a><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ff</span><span class="p">);</span>
<a id="line-3801" name="line-3801"></a><span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">nbsectors</span><span class="o">*</span><span class="mf">512L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">boot_segment</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-3802" name="line-3802"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<a id="line-3803" name="line-3803"></a>
<a id="line-3804" name="line-3804"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-3805" name="line-3805"></a><span class="w">  </span><span class="cm">/* specs: 8.2.3 step 4 and 8.2.5.6, measure El Torito boot image */</span>
<a id="line-3806" name="line-3806"></a><span class="w">  </span><span class="cm">/* measure 1st 512 bytes  */</span>
<a id="line-3807" name="line-3807"></a><span class="w">  </span><span class="n">tcpa_ipl</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">1L</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">boot_segment</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">0L</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">512L</span><span class="p">);</span>
<a id="line-3808" name="line-3808"></a><span class="cp">#endif</span>
<a id="line-3809" name="line-3809"></a>
<a id="line-3810" name="line-3810"></a><span class="w">  </span><span class="c1">// Remember the media type</span>
<a id="line-3811" name="line-3811"></a><span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3812" name="line-3812"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w">  </span><span class="c1">// 1.2M floppy</span>
<a id="line-3813" name="line-3813"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<a id="line-3814" name="line-3814"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="mi">80</span><span class="p">);</span>
<a id="line-3815" name="line-3815"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="line-3816" name="line-3816"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3817" name="line-3817"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w">  </span><span class="c1">// 1.44M floppy</span>
<a id="line-3818" name="line-3818"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="mi">18</span><span class="p">);</span>
<a id="line-3819" name="line-3819"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="mi">80</span><span class="p">);</span>
<a id="line-3820" name="line-3820"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="line-3821" name="line-3821"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3822" name="line-3822"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w">  </span><span class="c1">// 2.88M floppy</span>
<a id="line-3823" name="line-3823"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="mi">36</span><span class="p">);</span>
<a id="line-3824" name="line-3824"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span><span class="mi">80</span><span class="p">);</span>
<a id="line-3825" name="line-3825"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<a id="line-3826" name="line-3826"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3827" name="line-3827"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w">  </span><span class="c1">// Harddrive</span>
<a id="line-3828" name="line-3828"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">boot_segment</span><span class="p">,</span><span class="mi">446</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">);</span>
<a id="line-3829" name="line-3829"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">,</span>
<a id="line-3830" name="line-3830"></a><span class="w">              </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">boot_segment</span><span class="p">,</span><span class="mi">446</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">boot_segment</span><span class="p">,</span><span class="mi">446</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-3831" name="line-3831"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">boot_segment</span><span class="p">,</span><span class="mi">446</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-3832" name="line-3832"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3833" name="line-3833"></a><span class="w">   </span><span class="p">}</span>
<a id="line-3834" name="line-3834"></a>
<a id="line-3835" name="line-3835"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3836" name="line-3836"></a><span class="w">    </span><span class="c1">// Increase bios installed hardware number of devices</span>
<a id="line-3837" name="line-3837"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">)</span><span class="o">==</span><span class="mh">0x00</span><span class="p">)</span>
<a id="line-3838" name="line-3838"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x10</span><span class="p">)</span><span class="o">|</span><span class="mh">0x41</span><span class="p">);</span>
<a id="line-3839" name="line-3839"></a><span class="w">    </span><span class="k">else</span>
<a id="line-3840" name="line-3840"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdcount</span><span class="p">,</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdcount</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-3841" name="line-3841"></a><span class="w">   </span><span class="p">}</span>
<a id="line-3842" name="line-3842"></a>
<a id="line-3843" name="line-3843"></a>
<a id="line-3844" name="line-3844"></a><span class="w">  </span><span class="c1">// everything is ok, so from now on, the emulation is active</span>
<a id="line-3845" name="line-3845"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="line-3846" name="line-3846"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">active</span><span class="p">,</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-3847" name="line-3847"></a>
<a id="line-3848" name="line-3848"></a><span class="w">  </span><span class="c1">// return the boot drive + no error</span>
<a id="line-3849" name="line-3849"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">)</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">;</span>
<a id="line-3850" name="line-3850"></a><span class="p">}</span>
<a id="line-3851" name="line-3851"></a>
<a id="line-3852" name="line-3852"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3853" name="line-3853"></a><span class="c1">// End of El-Torito boot functions</span>
<a id="line-3854" name="line-3854"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-3855" name="line-3855"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-3856" name="line-3856"></a>
<a id="line-3857" name="line-3857"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-3858" name="line-3858"></a><span class="nf">int14_function</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">iret_addr</span><span class="p">)</span>
<a id="line-3859" name="line-3859"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// regs pushed from PUSHA instruction</span>
<a id="line-3860" name="line-3860"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="c1">// previous DS:, DS set to 0x0000 by asm wrapper</span>
<a id="line-3861" name="line-3861"></a><span class="w">  </span><span class="n">iret_addr_t</span><span class="w">  </span><span class="n">iret_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// CS,IP,Flags pushed from original INT call</span>
<a id="line-3862" name="line-3862"></a><span class="p">{</span>
<a id="line-3863" name="line-3863"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">timer</span><span class="p">,</span><span class="n">val16</span><span class="p">;</span>
<a id="line-3864" name="line-3864"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
<a id="line-3865" name="line-3865"></a>
<a id="line-3866" name="line-3866"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-3867" name="line-3867"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-3868" name="line-3868"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-3869" name="line-3869"></a>
<a id="line-3870" name="line-3870"></a><span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<a id="line-3871" name="line-3871"></a><span class="w">  </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x007C</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">);</span>
<a id="line-3872" name="line-3872"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3873" name="line-3873"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3874" name="line-3874"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<a id="line-3875" name="line-3875"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-3876" name="line-3876"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xE0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3877" name="line-3877"></a><span class="w">          </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">);</span>
<a id="line-3878" name="line-3878"></a><span class="w">          </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">);</span>
<a id="line-3879" name="line-3879"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3880" name="line-3880"></a><span class="w">          </span><span class="n">val16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x600</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xE0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<a id="line-3881" name="line-3881"></a><span class="w">          </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">val16</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">);</span>
<a id="line-3882" name="line-3882"></a><span class="w">          </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">val16</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-3883" name="line-3883"></a><span class="w">        </span><span class="p">}</span>
<a id="line-3884" name="line-3884"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1F</span><span class="p">);</span>
<a id="line-3885" name="line-3885"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
<a id="line-3886" name="line-3886"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span>
<a id="line-3887" name="line-3887"></a><span class="w">        </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-3888" name="line-3888"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-3889" name="line-3889"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<a id="line-3890" name="line-3890"></a><span class="w">        </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x006C</span><span class="p">);</span>
<a id="line-3891" name="line-3891"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3892" name="line-3892"></a><span class="w">          </span><span class="n">val16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x006C</span><span class="p">);</span>
<a id="line-3893" name="line-3893"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val16</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3894" name="line-3894"></a><span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val16</span><span class="p">;</span>
<a id="line-3895" name="line-3895"></a><span class="w">            </span><span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
<a id="line-3896" name="line-3896"></a><span class="w">            </span><span class="p">}</span>
<a id="line-3897" name="line-3897"></a><span class="w">          </span><span class="p">}</span>
<a id="line-3898" name="line-3898"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">);</span>
<a id="line-3899" name="line-3899"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
<a id="line-3900" name="line-3900"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">;</span>
<a id="line-3901" name="line-3901"></a><span class="w">        </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-3902" name="line-3902"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-3903" name="line-3903"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<a id="line-3904" name="line-3904"></a><span class="w">        </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x006C</span><span class="p">);</span>
<a id="line-3905" name="line-3905"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-3906" name="line-3906"></a><span class="w">          </span><span class="n">val16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x006C</span><span class="p">);</span>
<a id="line-3907" name="line-3907"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val16</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3908" name="line-3908"></a><span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val16</span><span class="p">;</span>
<a id="line-3909" name="line-3909"></a><span class="w">            </span><span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
<a id="line-3910" name="line-3910"></a><span class="w">            </span><span class="p">}</span>
<a id="line-3911" name="line-3911"></a><span class="w">          </span><span class="p">}</span>
<a id="line-3912" name="line-3912"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3913" name="line-3913"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3914" name="line-3914"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<a id="line-3915" name="line-3915"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3916" name="line-3916"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
<a id="line-3917" name="line-3917"></a><span class="w">          </span><span class="p">}</span>
<a id="line-3918" name="line-3918"></a><span class="w">        </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-3919" name="line-3919"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-3920" name="line-3920"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="line-3921" name="line-3921"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
<a id="line-3922" name="line-3922"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span>
<a id="line-3923" name="line-3923"></a><span class="w">        </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-3924" name="line-3924"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-3925" name="line-3925"></a><span class="w">      </span><span class="k">default</span><span class="o">:</span>
<a id="line-3926" name="line-3926"></a><span class="w">        </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// Unsupported</span>
<a id="line-3927" name="line-3927"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3928" name="line-3928"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-3929" name="line-3929"></a><span class="w">    </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// Unsupported</span>
<a id="line-3930" name="line-3930"></a><span class="w">    </span><span class="p">}</span>
<a id="line-3931" name="line-3931"></a><span class="p">}</span>
<a id="line-3932" name="line-3932"></a>
<a id="line-3933" name="line-3933"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-3934" name="line-3934"></a><span class="n">int15_function</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-3935" name="line-3935"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// REGS pushed via pusha</span>
<a id="line-3936" name="line-3936"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-3937" name="line-3937"></a><span class="p">{</span>
<a id="line-3938" name="line-3938"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-3939" name="line-3939"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">prev_a20_enable</span><span class="p">;</span>
<a id="line-3940" name="line-3940"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">base15_00</span><span class="p">;</span>
<a id="line-3941" name="line-3941"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">base23_16</span><span class="p">;</span>
<a id="line-3942" name="line-3942"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">ss</span><span class="p">;</span>
<a id="line-3943" name="line-3943"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">CX</span><span class="p">,</span><span class="n">DX</span><span class="p">;</span>
<a id="line-3944" name="line-3944"></a>
<a id="line-3945" name="line-3945"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bRegister</span><span class="p">;</span>
<a id="line-3946" name="line-3946"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">irqDisable</span><span class="p">;</span>
<a id="line-3947" name="line-3947"></a>
<a id="line-3948" name="line-3948"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;int15 AX=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">);</span>
<a id="line-3949" name="line-3949"></a>
<a id="line-3950" name="line-3950"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3951" name="line-3951"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x24</span><span class="p">:</span><span class="w"> </span><span class="cm">/* A20 Control */</span>
<a id="line-3952" name="line-3952"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-3953" name="line-3953"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span>
<a id="line-3954" name="line-3954"></a><span class="w">          </span><span class="n">set_enable_a20</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-3955" name="line-3955"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-3956" name="line-3956"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3957" name="line-3957"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-3958" name="line-3958"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span>
<a id="line-3959" name="line-3959"></a><span class="w">          </span><span class="n">set_enable_a20</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-3960" name="line-3960"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-3961" name="line-3961"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3962" name="line-3962"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-3963" name="line-3963"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span>
<a id="line-3964" name="line-3964"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x92</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-3965" name="line-3965"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-3966" name="line-3966"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3967" name="line-3967"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-3968" name="line-3968"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span>
<a id="line-3969" name="line-3969"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-3970" name="line-3970"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-3971" name="line-3971"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-3972" name="line-3972"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-3973" name="line-3973"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<a id="line-3974" name="line-3974"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int15: Func 24h, subfunc %02xh, A20 gate control not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">);</span>
<a id="line-3975" name="line-3975"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-3976" name="line-3976"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-3977" name="line-3977"></a><span class="w">      </span><span class="p">}</span>
<a id="line-3978" name="line-3978"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3979" name="line-3979"></a>
<a id="line-3980" name="line-3980"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x41</span><span class="p">:</span>
<a id="line-3981" name="line-3981"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-3982" name="line-3982"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-3983" name="line-3983"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3984" name="line-3984"></a>
<a id="line-3985" name="line-3985"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4f</span><span class="p">:</span>
<a id="line-3986" name="line-3986"></a><span class="w">      </span><span class="cm">/* keyboard intercept */</span>
<a id="line-3987" name="line-3987"></a><span class="cp">#if BX_CPU &lt; 2</span>
<a id="line-3988" name="line-3988"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-3989" name="line-3989"></a><span class="cp">#else</span>
<a id="line-3990" name="line-3990"></a><span class="w">      </span><span class="c1">// nop</span>
<a id="line-3991" name="line-3991"></a><span class="cp">#endif</span>
<a id="line-3992" name="line-3992"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-3993" name="line-3993"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3994" name="line-3994"></a>
<a id="line-3995" name="line-3995"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x52</span><span class="p">:</span><span class="w">    </span><span class="c1">// removable media eject</span>
<a id="line-3996" name="line-3996"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-3997" name="line-3997"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// &quot;ok ejection may proceed&quot;</span>
<a id="line-3998" name="line-3998"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-3999" name="line-3999"></a>
<a id="line-4000" name="line-4000"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x83</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="line-4001" name="line-4001"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4002" name="line-4002"></a><span class="w">        </span><span class="c1">// Set Interval requested.</span>
<a id="line-4003" name="line-4003"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4004" name="line-4004"></a><span class="w">          </span><span class="c1">// Interval not already set.</span>
<a id="line-4005" name="line-4005"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Set status byte.</span>
<a id="line-4006" name="line-4006"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Byte location, segment</span>
<a id="line-4007" name="line-4007"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9A</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Byte location, offset</span>
<a id="line-4008" name="line-4008"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9C</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Low word, delay</span>
<a id="line-4009" name="line-4009"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9E</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// High word, delay.</span>
<a id="line-4010" name="line-4010"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">(</span><span class="w"> </span><span class="p">);</span>
<a id="line-4011" name="line-4011"></a><span class="w">          </span><span class="n">irqDisable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="w"> </span><span class="mh">0xA1</span><span class="w"> </span><span class="p">);</span>
<a id="line-4012" name="line-4012"></a><span class="w">          </span><span class="n">outb</span><span class="p">(</span><span class="w"> </span><span class="mh">0xA1</span><span class="p">,</span><span class="w"> </span><span class="n">irqDisable</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFE</span><span class="w"> </span><span class="p">);</span>
<a id="line-4013" name="line-4013"></a><span class="w">          </span><span class="n">bRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Unmask IRQ8 so INT70 will get through.</span>
<a id="line-4014" name="line-4014"></a><span class="w">          </span><span class="n">outb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="p">,</span><span class="w"> </span><span class="n">bRegister</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Turn on the Periodic Interrupt timer</span>
<a id="line-4015" name="line-4015"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4016" name="line-4016"></a><span class="w">          </span><span class="c1">// Interval already set.</span>
<a id="line-4017" name="line-4017"></a><span class="w">          </span><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;int15: Func 83h, failed, already waiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
<a id="line-4018" name="line-4018"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4019" name="line-4019"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4020" name="line-4020"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4021" name="line-4021"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4022" name="line-4022"></a><span class="w">        </span><span class="c1">// Clear Interval requested</span>
<a id="line-4023" name="line-4023"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Clear status byte</span>
<a id="line-4024" name="line-4024"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">(</span><span class="w"> </span><span class="p">);</span>
<a id="line-4025" name="line-4025"></a><span class="w">        </span><span class="n">bRegister</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="w"> </span><span class="p">);</span>
<a id="line-4026" name="line-4026"></a><span class="w">        </span><span class="n">outb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="p">,</span><span class="w"> </span><span class="n">bRegister</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x40</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Turn off the Periodic Interrupt timer</span>
<a id="line-4027" name="line-4027"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4028" name="line-4028"></a><span class="w">        </span><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;int15: Func 83h, failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
<a id="line-4029" name="line-4029"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4030" name="line-4030"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4031" name="line-4031"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="o">--</span><span class="p">;</span>
<a id="line-4032" name="line-4032"></a><span class="w">      </span><span class="p">}</span>
<a id="line-4033" name="line-4033"></a>
<a id="line-4034" name="line-4034"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4035" name="line-4035"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4036" name="line-4036"></a>
<a id="line-4037" name="line-4037"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x87</span><span class="p">:</span>
<a id="line-4038" name="line-4038"></a><span class="cp">#if BX_CPU &lt; 3</span>
<a id="line-4039" name="line-4039"></a><span class="cp">#  error &quot;Int15 function 87h not supported on &lt; 80386&quot;</span>
<a id="line-4040" name="line-4040"></a><span class="cp">#endif</span>
<a id="line-4041" name="line-4041"></a><span class="w">      </span><span class="c1">// +++ should probably have descriptor checks</span>
<a id="line-4042" name="line-4042"></a><span class="w">      </span><span class="c1">// +++ should have exception handlers</span>
<a id="line-4043" name="line-4043"></a>
<a id="line-4044" name="line-4044"></a><span class="w"> </span><span class="c1">// turn off interrupts</span>
<a id="line-4045" name="line-4045"></a><span class="n">ASM_START</span>
<a id="line-4046" name="line-4046"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-4047" name="line-4047"></a><span class="n">ASM_END</span>
<a id="line-4048" name="line-4048"></a>
<a id="line-4049" name="line-4049"></a><span class="w">      </span><span class="n">prev_a20_enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">set_enable_a20</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// enable A20 line</span>
<a id="line-4050" name="line-4050"></a>
<a id="line-4051" name="line-4051"></a><span class="w">      </span><span class="c1">// 128K max of transfer on 386+ ???</span>
<a id="line-4052" name="line-4052"></a><span class="w">      </span><span class="c1">// source == destination ???</span>
<a id="line-4053" name="line-4053"></a>
<a id="line-4054" name="line-4054"></a><span class="w">      </span><span class="c1">// ES:SI points to descriptor table</span>
<a id="line-4055" name="line-4055"></a><span class="w">      </span><span class="c1">// offset   use     initially  comments</span>
<a id="line-4056" name="line-4056"></a><span class="w">      </span><span class="c1">// ==============================================</span>
<a id="line-4057" name="line-4057"></a><span class="w">      </span><span class="c1">// 00..07   Unused  zeros      Null descriptor</span>
<a id="line-4058" name="line-4058"></a><span class="w">      </span><span class="c1">// 08..0f   GDT     zeros      filled in by BIOS</span>
<a id="line-4059" name="line-4059"></a><span class="w">      </span><span class="c1">// 10..17   source  ssssssss   source of data</span>
<a id="line-4060" name="line-4060"></a><span class="w">      </span><span class="c1">// 18..1f   dest    dddddddd   destination of data</span>
<a id="line-4061" name="line-4061"></a><span class="w">      </span><span class="c1">// 20..27   CS      zeros      filled in by BIOS</span>
<a id="line-4062" name="line-4062"></a><span class="w">      </span><span class="c1">// 28..2f   SS      zeros      filled in by BIOS</span>
<a id="line-4063" name="line-4063"></a>
<a id="line-4064" name="line-4064"></a><span class="w">      </span><span class="c1">//es:si</span>
<a id="line-4065" name="line-4065"></a><span class="w">      </span><span class="c1">//eeee0</span>
<a id="line-4066" name="line-4066"></a><span class="w">      </span><span class="c1">//0ssss</span>
<a id="line-4067" name="line-4067"></a><span class="w">      </span><span class="c1">//-----</span>
<a id="line-4068" name="line-4068"></a>
<a id="line-4069" name="line-4069"></a><span class="c1">// check for access rights of source &amp; dest here</span>
<a id="line-4070" name="line-4070"></a>
<a id="line-4071" name="line-4071"></a><span class="w">      </span><span class="c1">// Initialize GDT descriptor</span>
<a id="line-4072" name="line-4072"></a><span class="w">      </span><span class="n">base15_00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="p">;</span>
<a id="line-4073" name="line-4073"></a><span class="w">      </span><span class="n">base23_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ES</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<a id="line-4074" name="line-4074"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">base15_00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">))</span>
<a id="line-4075" name="line-4075"></a><span class="w">        </span><span class="n">base23_16</span><span class="o">++</span><span class="p">;</span>
<a id="line-4076" name="line-4076"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x08</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">);</span><span class="w">       </span><span class="c1">// limit 15:00 = 6 * 8bytes/descriptor</span>
<a id="line-4077" name="line-4077"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x08</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">base15_00</span><span class="p">);</span><span class="c1">// base 15:00</span>
<a id="line-4078" name="line-4078"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x08</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">base23_16</span><span class="p">);</span><span class="c1">// base 23:16</span>
<a id="line-4079" name="line-4079"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x08</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x93</span><span class="p">);</span><span class="w">     </span><span class="c1">// access</span>
<a id="line-4080" name="line-4080"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x08</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span><span class="w">   </span><span class="c1">// base 31:24/reserved/limit 19:16</span>
<a id="line-4081" name="line-4081"></a>
<a id="line-4082" name="line-4082"></a><span class="w">      </span><span class="c1">// Initialize CS descriptor</span>
<a id="line-4083" name="line-4083"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x20</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">);</span><span class="c1">// limit 15:00 = normal 64K limit</span>
<a id="line-4084" name="line-4084"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x20</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span><span class="c1">// base 15:00</span>
<a id="line-4085" name="line-4085"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x20</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000f</span><span class="p">);</span><span class="c1">// base 23:16</span>
<a id="line-4086" name="line-4086"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x20</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9b</span><span class="p">);</span><span class="w">  </span><span class="c1">// access</span>
<a id="line-4087" name="line-4087"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x20</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span><span class="c1">// base 31:24/reserved/limit 19:16</span>
<a id="line-4088" name="line-4088"></a>
<a id="line-4089" name="line-4089"></a><span class="w">      </span><span class="c1">// Initialize SS descriptor</span>
<a id="line-4090" name="line-4090"></a><span class="w">      </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-4091" name="line-4091"></a><span class="w">      </span><span class="n">base15_00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-4092" name="line-4092"></a><span class="w">      </span><span class="n">base23_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
<a id="line-4093" name="line-4093"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">);</span><span class="w">   </span><span class="c1">// limit 15:00 = normal 64K limit</span>
<a id="line-4094" name="line-4094"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">base15_00</span><span class="p">);</span><span class="c1">// base 15:00</span>
<a id="line-4095" name="line-4095"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">base23_16</span><span class="p">);</span><span class="c1">// base 23:16</span>
<a id="line-4096" name="line-4096"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x93</span><span class="p">);</span><span class="w">     </span><span class="c1">// access</span>
<a id="line-4097" name="line-4097"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="o">+</span><span class="mh">0x28</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span><span class="w">   </span><span class="c1">// base 31:24/reserved/limit 19:16</span>
<a id="line-4098" name="line-4098"></a>
<a id="line-4099" name="line-4099"></a><span class="w">      </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="line-4100" name="line-4100"></a><span class="n">ASM_START</span>
<a id="line-4101" name="line-4101"></a><span class="w">      </span><span class="c1">// Compile generates locals offset info relative to SP.</span>
<a id="line-4102" name="line-4102"></a><span class="w">      </span><span class="c1">// Get CX (word count) from stack.</span>
<a id="line-4103" name="line-4103"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-4104" name="line-4104"></a><span class="w">      </span><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-4105" name="line-4105"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">_int15_function</span><span class="p">.</span><span class="n">CX</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-4106" name="line-4106"></a>
<a id="line-4107" name="line-4107"></a><span class="w">      </span><span class="c1">// since we need to set SS:SP, save them to the BDA</span>
<a id="line-4108" name="line-4108"></a><span class="w">      </span><span class="c1">// for future restore</span>
<a id="line-4109" name="line-4109"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4110" name="line-4110"></a><span class="w">      </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4111" name="line-4111"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4112" name="line-4112"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x0469</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span>
<a id="line-4113" name="line-4113"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x0467</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-4114" name="line-4114"></a>
<a id="line-4115" name="line-4115"></a><span class="w">      </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-4116" name="line-4116"></a><span class="w">        </span><span class="n">lgdt</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span>
<a id="line-4117" name="line-4117"></a><span class="w">      </span><span class="n">SEG</span><span class="w"> </span><span class="n">CS</span>
<a id="line-4118" name="line-4118"></a><span class="w">        </span><span class="n">lidt</span><span class="w"> </span><span class="p">[</span><span class="n">pmode_IDT_info</span><span class="p">]</span>
<a id="line-4119" name="line-4119"></a><span class="w">      </span><span class="p">;;</span><span class="w">  </span><span class="n">perhaps</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">IDT</span><span class="w"> </span><span class="n">here</span>
<a id="line-4120" name="line-4120"></a>
<a id="line-4121" name="line-4121"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">PE</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CR0</span>
<a id="line-4122" name="line-4122"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">cr0</span>
<a id="line-4123" name="line-4123"></a><span class="w">      </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-4124" name="line-4124"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4125" name="line-4125"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">transition</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">mode</span>
<a id="line-4126" name="line-4126"></a><span class="w">      </span><span class="n">JMP_AP</span><span class="p">(</span><span class="mh">0x0020</span><span class="p">,</span><span class="w"> </span><span class="n">protected_mode</span><span class="p">)</span>
<a id="line-4127" name="line-4127"></a>
<a id="line-4128" name="line-4128"></a><span class="nl">protected_mode</span><span class="p">:</span>
<a id="line-4129" name="line-4129"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">GDT</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">SS</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span>
<a id="line-4130" name="line-4130"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x28</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="mo">000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="n">th</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">=</span><span class="n">GDT</span><span class="p">,</span><span class="w"> </span><span class="n">RPL</span><span class="o">=</span><span class="mo">00</span>
<a id="line-4131" name="line-4131"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4132" name="line-4132"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mo">010</span><span class="w"> </span><span class="mo">000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="n">nd</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">=</span><span class="n">GDT</span><span class="p">,</span><span class="w"> </span><span class="n">RPL</span><span class="o">=</span><span class="mo">00</span>
<a id="line-4133" name="line-4133"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4134" name="line-4134"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x18</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mo">011</span><span class="w"> </span><span class="mo">000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="n">rd</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">TI</span><span class="o">=</span><span class="n">GDT</span><span class="p">,</span><span class="w"> </span><span class="n">RPL</span><span class="o">=</span><span class="mo">00</span>
<a id="line-4135" name="line-4135"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4136" name="line-4136"></a><span class="w">      </span><span class="n">xor</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">si</span>
<a id="line-4137" name="line-4137"></a><span class="w">      </span><span class="n">xor</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-4138" name="line-4138"></a><span class="w">      </span><span class="n">cld</span>
<a id="line-4139" name="line-4139"></a><span class="w">      </span><span class="n">rep</span>
<a id="line-4140" name="line-4140"></a><span class="w">        </span><span class="n">movsw</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">DS</span><span class="o">:</span><span class="n">SI</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="n">DI</span>
<a id="line-4141" name="line-4141"></a>
<a id="line-4142" name="line-4142"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">ES</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">64</span><span class="n">KB</span>
<a id="line-4143" name="line-4143"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x28</span>
<a id="line-4144" name="line-4144"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4145" name="line-4145"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4146" name="line-4146"></a>
<a id="line-4147" name="line-4147"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">PG</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CR0</span><span class="w"> </span><span class="o">???</span>
<a id="line-4148" name="line-4148"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">cr0</span>
<a id="line-4149" name="line-4149"></a><span class="w">      </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xFE</span>
<a id="line-4150" name="line-4150"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4151" name="line-4151"></a>
<a id="line-4152" name="line-4152"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">transition</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">mode</span>
<a id="line-4153" name="line-4153"></a><span class="w">      </span><span class="n">JMP_AP</span><span class="p">(</span><span class="mh">0xf000</span><span class="p">,</span><span class="w"> </span><span class="n">real_mode</span><span class="p">)</span>
<a id="line-4154" name="line-4154"></a>
<a id="line-4155" name="line-4155"></a><span class="nl">real_mode</span><span class="p">:</span>
<a id="line-4156" name="line-4156"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">IDT</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">real</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">defaults</span>
<a id="line-4157" name="line-4157"></a><span class="w">      </span><span class="n">SEG</span><span class="w"> </span><span class="n">CS</span>
<a id="line-4158" name="line-4158"></a><span class="w">        </span><span class="n">lidt</span><span class="w"> </span><span class="p">[</span><span class="n">rmode_IDT_info</span><span class="p">]</span>
<a id="line-4159" name="line-4159"></a>
<a id="line-4160" name="line-4160"></a><span class="w">      </span><span class="c1">// restore SS:SP from the BDA</span>
<a id="line-4161" name="line-4161"></a><span class="w">      </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4162" name="line-4162"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-4163" name="line-4163"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0469</span>
<a id="line-4164" name="line-4164"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0467</span>
<a id="line-4165" name="line-4165"></a><span class="w">      </span><span class="n">pop</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4166" name="line-4166"></a><span class="n">ASM_END</span>
<a id="line-4167" name="line-4167"></a>
<a id="line-4168" name="line-4168"></a><span class="w">      </span><span class="n">set_enable_a20</span><span class="p">(</span><span class="n">prev_a20_enable</span><span class="p">);</span>
<a id="line-4169" name="line-4169"></a>
<a id="line-4170" name="line-4170"></a><span class="w"> </span><span class="c1">// turn back on interrupts</span>
<a id="line-4171" name="line-4171"></a><span class="n">ASM_START</span>
<a id="line-4172" name="line-4172"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-4173" name="line-4173"></a><span class="n">ASM_END</span>
<a id="line-4174" name="line-4174"></a>
<a id="line-4175" name="line-4175"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4176" name="line-4176"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4177" name="line-4177"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4178" name="line-4178"></a>
<a id="line-4179" name="line-4179"></a>
<a id="line-4180" name="line-4180"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x88</span><span class="p">:</span>
<a id="line-4181" name="line-4181"></a><span class="w">      </span><span class="c1">// Get the amount of extended memory (above 1M)</span>
<a id="line-4182" name="line-4182"></a><span class="cp">#if BX_CPU &lt; 2</span>
<a id="line-4183" name="line-4183"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4184" name="line-4184"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4185" name="line-4185"></a><span class="cp">#else</span>
<a id="line-4186" name="line-4186"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-4187" name="line-4187"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x31</span><span class="p">);</span>
<a id="line-4188" name="line-4188"></a>
<a id="line-4189" name="line-4189"></a><span class="w">      </span><span class="c1">// According to Ralf Brown&#39;s interrupt the limit should be 15M,</span>
<a id="line-4190" name="line-4190"></a><span class="w">      </span><span class="c1">// but real machines mostly return max. 63M.</span>
<a id="line-4191" name="line-4191"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0xffc0</span><span class="p">)</span>
<a id="line-4192" name="line-4192"></a><span class="w">        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffc0</span><span class="p">;</span>
<a id="line-4193" name="line-4193"></a>
<a id="line-4194" name="line-4194"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4195" name="line-4195"></a><span class="cp">#endif</span>
<a id="line-4196" name="line-4196"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4197" name="line-4197"></a>
<a id="line-4198" name="line-4198"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x90</span><span class="p">:</span>
<a id="line-4199" name="line-4199"></a><span class="w">      </span><span class="cm">/* Device busy interrupt.  Called by Int 16h when no key available */</span>
<a id="line-4200" name="line-4200"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4201" name="line-4201"></a>
<a id="line-4202" name="line-4202"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x91</span><span class="p">:</span>
<a id="line-4203" name="line-4203"></a><span class="w">      </span><span class="cm">/* Interrupt complete.  Called by Int 16h when key becomes available */</span>
<a id="line-4204" name="line-4204"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4205" name="line-4205"></a>
<a id="line-4206" name="line-4206"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xbf</span><span class="p">:</span>
<a id="line-4207" name="line-4207"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;*** int 15h function AH=bf not yet supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4208" name="line-4208"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4209" name="line-4209"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4210" name="line-4210"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4211" name="line-4211"></a>
<a id="line-4212" name="line-4212"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xC0</span><span class="p">:</span>
<a id="line-4213" name="line-4213"></a><span class="cp">#if 0</span>
<a id="line-4214" name="line-4214"></a><span class="c">      SET_CF();</span>
<a id="line-4215" name="line-4215"></a><span class="c">      regs.u.r8.ah = UNSUPPORTED_FUNCTION;</span>
<a id="line-4216" name="line-4216"></a><span class="c">      break;</span>
<a id="line-4217" name="line-4217"></a><span class="cp">#endif</span>
<a id="line-4218" name="line-4218"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4219" name="line-4219"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4220" name="line-4220"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">BIOS_CONFIG_TABLE</span><span class="p">;</span>
<a id="line-4221" name="line-4221"></a><span class="w">      </span><span class="n">ES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xF000</span><span class="p">;</span>
<a id="line-4222" name="line-4222"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4223" name="line-4223"></a>
<a id="line-4224" name="line-4224"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xc1</span><span class="p">:</span>
<a id="line-4225" name="line-4225"></a><span class="w">      </span><span class="n">ES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ebda_seg</span><span class="p">;</span>
<a id="line-4226" name="line-4226"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4227" name="line-4227"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4228" name="line-4228"></a>
<a id="line-4229" name="line-4229"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xd8</span><span class="p">:</span>
<a id="line-4230" name="line-4230"></a><span class="w">      </span><span class="n">bios_printf</span><span class="p">(</span><span class="n">BIOS_PRINTF_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;EISA BIOS not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4231" name="line-4231"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4232" name="line-4232"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4233" name="line-4233"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4234" name="line-4234"></a>
<a id="line-4235" name="line-4235"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-4236" name="line-4236"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;*** int 15h function AX=%04x, BX=%04x not yet supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="line-4237" name="line-4237"></a><span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">);</span>
<a id="line-4238" name="line-4238"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4239" name="line-4239"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4240" name="line-4240"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4241" name="line-4241"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4242" name="line-4242"></a><span class="p">}</span>
<a id="line-4243" name="line-4243"></a>
<a id="line-4244" name="line-4244"></a><span class="cp">#if BX_USE_PS2_MOUSE</span>
<a id="line-4245" name="line-4245"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-4246" name="line-4246"></a><span class="n">int15_function_mouse</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-4247" name="line-4247"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// REGS pushed via pusha</span>
<a id="line-4248" name="line-4248"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-4249" name="line-4249"></a><span class="p">{</span>
<a id="line-4250" name="line-4250"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-4251" name="line-4251"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">mouse_flags_1</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_2</span><span class="p">;</span>
<a id="line-4252" name="line-4252"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">mouse_driver_seg</span><span class="p">;</span>
<a id="line-4253" name="line-4253"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">mouse_driver_offset</span><span class="p">;</span>
<a id="line-4254" name="line-4254"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">comm_byte</span><span class="p">,</span><span class="w"> </span><span class="n">prev_command_byte</span><span class="p">;</span>
<a id="line-4255" name="line-4255"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_data1</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_data2</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_data3</span><span class="p">;</span>
<a id="line-4256" name="line-4256"></a>
<a id="line-4257" name="line-4257"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;int15 AX=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">);</span>
<a id="line-4258" name="line-4258"></a>
<a id="line-4259" name="line-4259"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4260" name="line-4260"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xC2</span><span class="p">:</span>
<a id="line-4261" name="line-4261"></a><span class="w">      </span><span class="c1">// Return Codes status in AH</span>
<a id="line-4262" name="line-4262"></a><span class="w">      </span><span class="c1">// =========================</span>
<a id="line-4263" name="line-4263"></a><span class="w">      </span><span class="c1">// 00: success</span>
<a id="line-4264" name="line-4264"></a><span class="w">      </span><span class="c1">// 01: invalid subfunction (AL &gt; 7)</span>
<a id="line-4265" name="line-4265"></a><span class="w">      </span><span class="c1">// 02: invalid input value (out of allowable range)</span>
<a id="line-4266" name="line-4266"></a><span class="w">      </span><span class="c1">// 03: interface error</span>
<a id="line-4267" name="line-4267"></a><span class="w">      </span><span class="c1">// 04: resend command received from mouse controller,</span>
<a id="line-4268" name="line-4268"></a><span class="w">      </span><span class="c1">//     device driver should attempt command again</span>
<a id="line-4269" name="line-4269"></a><span class="w">      </span><span class="c1">// 05: cannot enable mouse, since no far call has been installed</span>
<a id="line-4270" name="line-4270"></a><span class="w">      </span><span class="c1">// 80/86: mouse service not implemented</span>
<a id="line-4271" name="line-4271"></a>
<a id="line-4272" name="line-4272"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4273" name="line-4273"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// Disable/Enable Mouse</span>
<a id="line-4274" name="line-4274"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 0:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4275" name="line-4275"></a><span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4276" name="line-4276"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// Disable Mouse</span>
<a id="line-4277" name="line-4277"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 0: disable mouse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4278" name="line-4278"></a><span class="w">              </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4279" name="line-4279"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xF5</span><span class="p">);</span><span class="w"> </span><span class="c1">// disable mouse command</span>
<a id="line-4280" name="line-4280"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4281" name="line-4281"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4282" name="line-4282"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFA</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4283" name="line-4283"></a><span class="w">                  </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4284" name="line-4284"></a><span class="w">                  </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4285" name="line-4285"></a><span class="w">                  </span><span class="k">return</span><span class="p">;</span>
<a id="line-4286" name="line-4286"></a><span class="w">                  </span><span class="p">}</span>
<a id="line-4287" name="line-4287"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4288" name="line-4288"></a>
<a id="line-4289" name="line-4289"></a><span class="w">              </span><span class="c1">// error</span>
<a id="line-4290" name="line-4290"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4291" name="line-4291"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="line-4292" name="line-4292"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4293" name="line-4293"></a><span class="w">              </span><span class="k">break</span><span class="p">;</span>
<a id="line-4294" name="line-4294"></a>
<a id="line-4295" name="line-4295"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// Enable Mouse</span>
<a id="line-4296" name="line-4296"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 1: enable mouse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4297" name="line-4297"></a><span class="w">              </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">);</span>
<a id="line-4298" name="line-4298"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4299" name="line-4299"></a><span class="w">                </span><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;INT 15h C2 Enable Mouse, no far call handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4300" name="line-4300"></a><span class="w">                </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">  </span><span class="c1">// error</span>
<a id="line-4301" name="line-4301"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// no far call installed</span>
<a id="line-4302" name="line-4302"></a><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<a id="line-4303" name="line-4303"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4304" name="line-4304"></a><span class="w">              </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4305" name="line-4305"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xF4</span><span class="p">);</span><span class="w"> </span><span class="c1">// enable mouse command</span>
<a id="line-4306" name="line-4306"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4307" name="line-4307"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4308" name="line-4308"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFA</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4309" name="line-4309"></a><span class="w">                  </span><span class="n">enable_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// turn IRQ12 and packet generation on</span>
<a id="line-4310" name="line-4310"></a><span class="w">                  </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4311" name="line-4311"></a><span class="w">                  </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4312" name="line-4312"></a><span class="w">                  </span><span class="k">return</span><span class="p">;</span>
<a id="line-4313" name="line-4313"></a><span class="w">                  </span><span class="p">}</span>
<a id="line-4314" name="line-4314"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4315" name="line-4315"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4316" name="line-4316"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="line-4317" name="line-4317"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4318" name="line-4318"></a>
<a id="line-4319" name="line-4319"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="c1">// invalid subfunction</span>
<a id="line-4320" name="line-4320"></a><span class="w">              </span><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;INT 15h C2 AL=0, BH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">);</span>
<a id="line-4321" name="line-4321"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">  </span><span class="c1">// error</span>
<a id="line-4322" name="line-4322"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// invalid subfunction</span>
<a id="line-4323" name="line-4323"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4324" name="line-4324"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4325" name="line-4325"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4326" name="line-4326"></a>
<a id="line-4327" name="line-4327"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// Reset Mouse</span>
<a id="line-4328" name="line-4328"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="c1">// Initialize Mouse</span>
<a id="line-4329" name="line-4329"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 1 or 5:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4330" name="line-4330"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4331" name="line-4331"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4332" name="line-4332"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4333" name="line-4333"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span><span class="w"> </span><span class="c1">// invalid input</span>
<a id="line-4334" name="line-4334"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4335" name="line-4335"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4336" name="line-4336"></a><span class="w">            </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">);</span>
<a id="line-4337" name="line-4337"></a><span class="w">            </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">;</span>
<a id="line-4338" name="line-4338"></a><span class="w">            </span><span class="n">mouse_flags_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span>
<a id="line-4339" name="line-4339"></a><span class="w">            </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0026</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_1</span><span class="p">);</span>
<a id="line-4340" name="line-4340"></a><span class="w">            </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_2</span><span class="p">);</span>
<a id="line-4341" name="line-4341"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4342" name="line-4342"></a>
<a id="line-4343" name="line-4343"></a><span class="w">          </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4344" name="line-4344"></a><span class="w">          </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span><span class="w"> </span><span class="c1">// reset mouse command</span>
<a id="line-4345" name="line-4345"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4346" name="line-4346"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data3</span><span class="p">);</span>
<a id="line-4347" name="line-4347"></a><span class="w">            </span><span class="c1">// if no mouse attached, it will return RESEND</span>
<a id="line-4348" name="line-4348"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4349" name="line-4349"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4350" name="line-4350"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4351" name="line-4351"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4352" name="line-4352"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">)</span>
<a id="line-4353" name="line-4353"></a><span class="w">              </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Mouse reset returned %02x (should be ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mouse_data3</span><span class="p">);</span>
<a id="line-4354" name="line-4354"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4355" name="line-4355"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4356" name="line-4356"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4357" name="line-4357"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data2</span><span class="p">);</span>
<a id="line-4358" name="line-4358"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4359" name="line-4359"></a><span class="w">                  </span><span class="c1">// turn IRQ12 and packet generation on</span>
<a id="line-4360" name="line-4360"></a><span class="w">                  </span><span class="n">enable_mouse_int_and_events</span><span class="p">();</span>
<a id="line-4361" name="line-4361"></a><span class="w">                  </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4362" name="line-4362"></a><span class="w">                  </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4363" name="line-4363"></a><span class="w">                  </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data1</span><span class="p">;</span>
<a id="line-4364" name="line-4364"></a><span class="w">                  </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data2</span><span class="p">;</span>
<a id="line-4365" name="line-4365"></a><span class="w">                  </span><span class="k">return</span><span class="p">;</span>
<a id="line-4366" name="line-4366"></a><span class="w">                  </span><span class="p">}</span>
<a id="line-4367" name="line-4367"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4368" name="line-4368"></a><span class="w">              </span><span class="p">}</span>
<a id="line-4369" name="line-4369"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4370" name="line-4370"></a>
<a id="line-4371" name="line-4371"></a><span class="w">          </span><span class="c1">// error</span>
<a id="line-4372" name="line-4372"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4373" name="line-4373"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="line-4374" name="line-4374"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-4375" name="line-4375"></a>
<a id="line-4376" name="line-4376"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Sample Rate</span>
<a id="line-4377" name="line-4377"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 2:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4378" name="line-4378"></a><span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4379" name="line-4379"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//  10 reports/sec</span>
<a id="line-4380" name="line-4380"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//  20 reports/sec</span>
<a id="line-4381" name="line-4381"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//  40 reports/sec</span>
<a id="line-4382" name="line-4382"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//  60 reports/sec</span>
<a id="line-4383" name="line-4383"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">//  80 reports/sec</span>
<a id="line-4384" name="line-4384"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// 100 reports/sec (default)</span>
<a id="line-4385" name="line-4385"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// 200 reports/sec</span>
<a id="line-4386" name="line-4386"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4387" name="line-4387"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4388" name="line-4388"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4389" name="line-4389"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xF3</span><span class="p">);</span><span class="w"> </span><span class="c1">// set sample rate command</span>
<a id="line-4390" name="line-4390"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4391" name="line-4391"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data2</span><span class="p">);</span>
<a id="line-4392" name="line-4392"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4393" name="line-4393"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data2</span><span class="p">);</span>
<a id="line-4394" name="line-4394"></a><span class="w">              </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4395" name="line-4395"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4396" name="line-4396"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4397" name="line-4397"></a><span class="w">              </span><span class="c1">// error</span>
<a id="line-4398" name="line-4398"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4399" name="line-4399"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4400" name="line-4400"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4401" name="line-4401"></a><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4402" name="line-4402"></a><span class="w">            </span><span class="c1">// error</span>
<a id="line-4403" name="line-4403"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4404" name="line-4404"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4405" name="line-4405"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4406" name="line-4406"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4407" name="line-4407"></a>
<a id="line-4408" name="line-4408"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Resolution</span>
<a id="line-4409" name="line-4409"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 3:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4410" name="line-4410"></a><span class="w">          </span><span class="c1">// BH:</span>
<a id="line-4411" name="line-4411"></a><span class="w">          </span><span class="c1">//      0 =  25 dpi, 1 count  per millimeter</span>
<a id="line-4412" name="line-4412"></a><span class="w">          </span><span class="c1">//      1 =  50 dpi, 2 counts per millimeter</span>
<a id="line-4413" name="line-4413"></a><span class="w">          </span><span class="c1">//      2 = 100 dpi, 4 counts per millimeter</span>
<a id="line-4414" name="line-4414"></a><span class="w">          </span><span class="c1">//      3 = 200 dpi, 8 counts per millimeter</span>
<a id="line-4415" name="line-4415"></a><span class="w">          </span><span class="n">comm_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4416" name="line-4416"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4417" name="line-4417"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xE8</span><span class="p">);</span><span class="w"> </span><span class="c1">// set resolution command</span>
<a id="line-4418" name="line-4418"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4419" name="line-4419"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4420" name="line-4420"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">)</span>
<a id="line-4421" name="line-4421"></a><span class="w">                </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Mouse status returned %02x (should be ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4422" name="line-4422"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">);</span>
<a id="line-4423" name="line-4423"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4424" name="line-4424"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">)</span>
<a id="line-4425" name="line-4425"></a><span class="w">                </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Mouse status returned %02x (should be ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4426" name="line-4426"></a><span class="w">              </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4427" name="line-4427"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4428" name="line-4428"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4429" name="line-4429"></a><span class="w">              </span><span class="c1">// error</span>
<a id="line-4430" name="line-4430"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4431" name="line-4431"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4432" name="line-4432"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4433" name="line-4433"></a><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4434" name="line-4434"></a><span class="w">            </span><span class="c1">// error</span>
<a id="line-4435" name="line-4435"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4436" name="line-4436"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4437" name="line-4437"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4438" name="line-4438"></a><span class="w">          </span><span class="n">set_kbd_command_byte</span><span class="p">(</span><span class="n">comm_byte</span><span class="p">);</span><span class="w"> </span><span class="c1">// restore IRQ12 and serial enable</span>
<a id="line-4439" name="line-4439"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4440" name="line-4440"></a>
<a id="line-4441" name="line-4441"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="c1">// Get Device ID</span>
<a id="line-4442" name="line-4442"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 4:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4443" name="line-4443"></a><span class="w">          </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4444" name="line-4444"></a><span class="w">          </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xF2</span><span class="p">);</span><span class="w"> </span><span class="c1">// get mouse ID command</span>
<a id="line-4445" name="line-4445"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4446" name="line-4446"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4447" name="line-4447"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data2</span><span class="p">);</span>
<a id="line-4448" name="line-4448"></a><span class="w">            </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4449" name="line-4449"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4450" name="line-4450"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data2</span><span class="p">;</span>
<a id="line-4451" name="line-4451"></a><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4452" name="line-4452"></a><span class="w">            </span><span class="c1">// error</span>
<a id="line-4453" name="line-4453"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4454" name="line-4454"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4455" name="line-4455"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4456" name="line-4456"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4457" name="line-4457"></a>
<a id="line-4458" name="line-4458"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="c1">// Return Status &amp; Set Scaling Factor...</span>
<a id="line-4459" name="line-4459"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 6:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4460" name="line-4460"></a><span class="w">          </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4461" name="line-4461"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// Return Status</span>
<a id="line-4462" name="line-4462"></a><span class="w">              </span><span class="n">comm_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4463" name="line-4463"></a><span class="w">              </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xE9</span><span class="p">);</span><span class="w"> </span><span class="c1">// get mouse info command</span>
<a id="line-4464" name="line-4464"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4465" name="line-4465"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4466" name="line-4466"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">)</span>
<a id="line-4467" name="line-4467"></a><span class="w">                  </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Mouse status returned %02x (should be ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4468" name="line-4468"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4469" name="line-4469"></a><span class="w">                  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4470" name="line-4470"></a><span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4471" name="line-4471"></a><span class="w">                    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data2</span><span class="p">);</span>
<a id="line-4472" name="line-4472"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4473" name="line-4473"></a><span class="w">                      </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data3</span><span class="p">);</span>
<a id="line-4474" name="line-4474"></a><span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4475" name="line-4475"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4476" name="line-4476"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4477" name="line-4477"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data1</span><span class="p">;</span>
<a id="line-4478" name="line-4478"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data2</span><span class="p">;</span>
<a id="line-4479" name="line-4479"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_data3</span><span class="p">;</span>
<a id="line-4480" name="line-4480"></a><span class="w">                        </span><span class="n">set_kbd_command_byte</span><span class="p">(</span><span class="n">comm_byte</span><span class="p">);</span><span class="w"> </span><span class="c1">// restore IRQ12 and serial enable</span>
<a id="line-4481" name="line-4481"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4482" name="line-4482"></a><span class="w">                        </span><span class="p">}</span>
<a id="line-4483" name="line-4483"></a><span class="w">                      </span><span class="p">}</span>
<a id="line-4484" name="line-4484"></a><span class="w">                    </span><span class="p">}</span>
<a id="line-4485" name="line-4485"></a><span class="w">                  </span><span class="p">}</span>
<a id="line-4486" name="line-4486"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4487" name="line-4487"></a>
<a id="line-4488" name="line-4488"></a><span class="w">              </span><span class="c1">// error</span>
<a id="line-4489" name="line-4489"></a><span class="w">              </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4490" name="line-4490"></a><span class="w">              </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="line-4491" name="line-4491"></a><span class="w">              </span><span class="n">set_kbd_command_byte</span><span class="p">(</span><span class="n">comm_byte</span><span class="p">);</span><span class="w"> </span><span class="c1">// restore IRQ12 and serial enable</span>
<a id="line-4492" name="line-4492"></a><span class="w">              </span><span class="k">return</span><span class="p">;</span>
<a id="line-4493" name="line-4493"></a>
<a id="line-4494" name="line-4494"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Scaling Factor to 1:1</span>
<a id="line-4495" name="line-4495"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Scaling Factor to 2:1</span>
<a id="line-4496" name="line-4496"></a><span class="w">              </span><span class="n">comm_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4497" name="line-4497"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4498" name="line-4498"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xE6</span><span class="p">);</span>
<a id="line-4499" name="line-4499"></a><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4500" name="line-4500"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send_to_mouse_ctrl</span><span class="p">(</span><span class="mh">0xE7</span><span class="p">);</span>
<a id="line-4501" name="line-4501"></a><span class="w">              </span><span class="p">}</span>
<a id="line-4502" name="line-4502"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4503" name="line-4503"></a><span class="w">                </span><span class="n">get_mouse_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mouse_data1</span><span class="p">);</span>
<a id="line-4504" name="line-4504"></a><span class="w">                </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_data1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xFA</span><span class="p">);</span>
<a id="line-4505" name="line-4505"></a><span class="w">              </span><span class="p">}</span>
<a id="line-4506" name="line-4506"></a><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4507" name="line-4507"></a><span class="w">                </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4508" name="line-4508"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4509" name="line-4509"></a><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4510" name="line-4510"></a><span class="w">                </span><span class="c1">// error</span>
<a id="line-4511" name="line-4511"></a><span class="w">                </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4512" name="line-4512"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4513" name="line-4513"></a><span class="w">              </span><span class="p">}</span>
<a id="line-4514" name="line-4514"></a><span class="w">              </span><span class="n">set_kbd_command_byte</span><span class="p">(</span><span class="n">comm_byte</span><span class="p">);</span><span class="w"> </span><span class="c1">// restore IRQ12 and serial enable</span>
<a id="line-4515" name="line-4515"></a><span class="w">              </span><span class="k">break</span><span class="p">;</span>
<a id="line-4516" name="line-4516"></a>
<a id="line-4517" name="line-4517"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span>
<a id="line-4518" name="line-4518"></a><span class="w">              </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;INT 15h C2 AL=6, BH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bh</span><span class="p">);</span>
<a id="line-4519" name="line-4519"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4520" name="line-4520"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4521" name="line-4521"></a>
<a id="line-4522" name="line-4522"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Mouse Handler Address</span>
<a id="line-4523" name="line-4523"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case 7:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4524" name="line-4524"></a><span class="w">          </span><span class="n">mouse_driver_seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ES</span><span class="p">;</span>
<a id="line-4525" name="line-4525"></a><span class="w">          </span><span class="n">mouse_driver_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">;</span>
<a id="line-4526" name="line-4526"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0022</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_driver_offset</span><span class="p">);</span>
<a id="line-4527" name="line-4527"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0024</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_driver_seg</span><span class="p">);</span>
<a id="line-4528" name="line-4528"></a><span class="w">          </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">);</span>
<a id="line-4529" name="line-4529"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_driver_offset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mouse_driver_seg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4530" name="line-4530"></a><span class="w">            </span><span class="cm">/* remove handler */</span>
<a id="line-4531" name="line-4531"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4532" name="line-4532"></a><span class="w">              </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
<a id="line-4533" name="line-4533"></a><span class="w">              </span><span class="n">inhibit_mouse_int_and_events</span><span class="p">();</span><span class="w"> </span><span class="c1">// disable IRQ12 and packets</span>
<a id="line-4534" name="line-4534"></a><span class="w">              </span><span class="p">}</span>
<a id="line-4535" name="line-4535"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4536" name="line-4536"></a><span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4537" name="line-4537"></a><span class="w">            </span><span class="cm">/* install handler */</span>
<a id="line-4538" name="line-4538"></a><span class="w">            </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x80</span><span class="p">;</span>
<a id="line-4539" name="line-4539"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4540" name="line-4540"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_2</span><span class="p">);</span>
<a id="line-4541" name="line-4541"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4542" name="line-4542"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4543" name="line-4543"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4544" name="line-4544"></a>
<a id="line-4545" name="line-4545"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<a id="line-4546" name="line-4546"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;case default:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4547" name="line-4547"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// invalid function</span>
<a id="line-4548" name="line-4548"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4549" name="line-4549"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4550" name="line-4550"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4551" name="line-4551"></a>
<a id="line-4552" name="line-4552"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-4553" name="line-4553"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;*** int 15h function AX=%04x, BX=%04x not yet supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="line-4554" name="line-4554"></a><span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">);</span>
<a id="line-4555" name="line-4555"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4556" name="line-4556"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4557" name="line-4557"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4558" name="line-4558"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4559" name="line-4559"></a><span class="p">}</span>
<a id="line-4560" name="line-4560"></a><span class="cp">#endif </span><span class="c1">// BX_USE_PS2_MOUSE</span>
<a id="line-4561" name="line-4561"></a>
<a id="line-4562" name="line-4562"></a>
<a id="line-4563" name="line-4563"></a><span class="kt">void</span><span class="w"> </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<a id="line-4564" name="line-4564"></a><span class="w">     </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ES</span><span class="p">;</span>
<a id="line-4565" name="line-4565"></a><span class="w">     </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DI</span><span class="p">;</span>
<a id="line-4566" name="line-4566"></a><span class="w">     </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<a id="line-4567" name="line-4567"></a><span class="w">     </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<a id="line-4568" name="line-4568"></a><span class="w">     </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<a id="line-4569" name="line-4569"></a><span class="p">{</span>
<a id="line-4570" name="line-4570"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<a id="line-4571" name="line-4571"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-4572" name="line-4572"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-4573" name="line-4573"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-4574" name="line-4574"></a>
<a id="line-4575" name="line-4575"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<a id="line-4576" name="line-4576"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<a id="line-4577" name="line-4577"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-4578" name="line-4578"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span>
<a id="line-4579" name="line-4579"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span>
<a id="line-4580" name="line-4580"></a>
<a id="line-4581" name="line-4581"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<a id="line-4582" name="line-4582"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="o">+</span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">);</span>
<a id="line-4583" name="line-4583"></a><span class="p">}</span>
<a id="line-4584" name="line-4584"></a>
<a id="line-4585" name="line-4585"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-4586" name="line-4586"></a><span class="n">int15_function32</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-4587" name="line-4587"></a><span class="w">  </span><span class="n">pushad_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// REGS pushed via pushad</span>
<a id="line-4588" name="line-4588"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-4589" name="line-4589"></a><span class="p">{</span>
<a id="line-4590" name="line-4590"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w">  </span><span class="n">extended_memory_size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 64bits long</span>
<a id="line-4591" name="line-4591"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">CX</span><span class="p">,</span><span class="n">DX</span><span class="p">;</span>
<a id="line-4592" name="line-4592"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-4593" name="line-4593"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">;</span>
<a id="line-4594" name="line-4594"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="line-4595" name="line-4595"></a><span class="cp">#endif</span>
<a id="line-4596" name="line-4596"></a>
<a id="line-4597" name="line-4597"></a><span class="n">BX_DEBUG_INT15</span><span class="p">(</span><span class="s">&quot;int15 AX=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">);</span>
<a id="line-4598" name="line-4598"></a>
<a id="line-4599" name="line-4599"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4600" name="line-4600"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x86</span><span class="p">:</span>
<a id="line-4601" name="line-4601"></a><span class="w">      </span><span class="c1">// Wait for CX:DX microseconds. currently using the</span>
<a id="line-4602" name="line-4602"></a><span class="w">      </span><span class="c1">// refresh request port 0x61 bit4, toggling every 15usec</span>
<a id="line-4603" name="line-4603"></a>
<a id="line-4604" name="line-4604"></a><span class="w">      </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="line-4605" name="line-4605"></a><span class="w">      </span><span class="n">DX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
<a id="line-4606" name="line-4606"></a>
<a id="line-4607" name="line-4607"></a><span class="n">ASM_START</span>
<a id="line-4608" name="line-4608"></a><span class="w">      </span><span class="n">sti</span>
<a id="line-4609" name="line-4609"></a>
<a id="line-4610" name="line-4610"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4611" name="line-4611"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-4612" name="line-4612"></a><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-4613" name="line-4613"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_int15_function32</span><span class="p">.</span><span class="n">CX</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-4614" name="line-4614"></a><span class="w">      </span><span class="n">shl</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-4615" name="line-4615"></a><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-4616" name="line-4616"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_int15_function32</span><span class="p">.</span><span class="n">DX</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-4617" name="line-4617"></a>
<a id="line-4618" name="line-4618"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">15u</span><span class="n">sec</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-4619" name="line-4619"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">15</span>
<a id="line-4620" name="line-4620"></a><span class="w">      </span><span class="n">xor</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-4621" name="line-4621"></a><span class="w">      </span><span class="n">div</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-4622" name="line-4622"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-4623" name="line-4623"></a>
<a id="line-4624" name="line-4624"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ecx</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="n">requests</span>
<a id="line-4625" name="line-4625"></a><span class="w">      </span><span class="n">in</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x61</span>
<a id="line-4626" name="line-4626"></a><span class="w">      </span><span class="n">and</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-4627" name="line-4627"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-4628" name="line-4628"></a>
<a id="line-4629" name="line-4629"></a><span class="w">      </span><span class="n">or</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-4630" name="line-4630"></a><span class="w">      </span><span class="n">je</span><span class="w"> </span><span class="n">int1586_tick_end</span>
<a id="line-4631" name="line-4631"></a><span class="nl">int1586_tick</span><span class="p">:</span>
<a id="line-4632" name="line-4632"></a><span class="w">      </span><span class="n">in</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x61</span>
<a id="line-4633" name="line-4633"></a><span class="w">      </span><span class="n">and</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-4634" name="line-4634"></a><span class="w">      </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span>
<a id="line-4635" name="line-4635"></a><span class="w">      </span><span class="n">je</span><span class="w">  </span><span class="n">int1586_tick</span>
<a id="line-4636" name="line-4636"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-4637" name="line-4637"></a><span class="w">      </span><span class="n">dec</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-4638" name="line-4638"></a><span class="w">      </span><span class="n">jnz</span><span class="w"> </span><span class="n">int1586_tick</span>
<a id="line-4639" name="line-4639"></a><span class="nl">int1586_tick_end</span><span class="p">:</span>
<a id="line-4640" name="line-4640"></a><span class="n">ASM_END</span>
<a id="line-4641" name="line-4641"></a>
<a id="line-4642" name="line-4642"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4643" name="line-4643"></a>
<a id="line-4644" name="line-4644"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xe8</span><span class="p">:</span>
<a id="line-4645" name="line-4645"></a><span class="w">        </span><span class="k">switch</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">)</span>
<a id="line-4646" name="line-4646"></a><span class="w">        </span><span class="p">{</span>
<a id="line-4647" name="line-4647"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-4648" name="line-4648"></a><span class="w">       </span><span class="k">case</span><span class="w"> </span><span class="mh">0x20</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="line-4649" name="line-4649"></a><span class="w">            </span><span class="n">e820_table_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_NR_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4650" name="line-4650"></a>
<a id="line-4651" name="line-4651"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">edx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">)</span><span class="w"> </span><span class="cm">/* SMAP */</span>
<a id="line-4652" name="line-4652"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4653" name="line-4653"></a>
<a id="line-4654" name="line-4654"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">0x14</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x14</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4655" name="line-4655"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x14</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">)</span>
<a id="line-4656" name="line-4656"></a><span class="w">                    </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4657" name="line-4657"></a><span class="w">                            </span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x14</span><span class="p">);</span>
<a id="line-4658" name="line-4658"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4659" name="line-4659"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">)</span>
<a id="line-4660" name="line-4660"></a><span class="w">                    </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4661" name="line-4661"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4662" name="line-4662"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4663" name="line-4663"></a><span class="w">                    </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
<a id="line-4664" name="line-4664"></a><span class="w">                    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
<a id="line-4665" name="line-4665"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">base</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x100000</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="line-4666" name="line-4666"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4667" name="line-4667"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4668" name="line-4668"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4669" name="line-4669"></a><span class="w">                    </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4670" name="line-4670"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="line-4671" name="line-4671"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4672" name="line-4672"></a><span class="w">                </span><span class="n">memcpyb</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mh">0x14</span><span class="p">);</span>
<a id="line-4673" name="line-4673"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4674" name="line-4674"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* AX=E820, DX=534D4150, BX unrecognized */</span>
<a id="line-4675" name="line-4675"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4676" name="line-4676"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4677" name="line-4677"></a>
<a id="line-4678" name="line-4678"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4679" name="line-4679"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4680" name="line-4680"></a><span class="w">            </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4681" name="line-4681"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="line-4682" name="line-4682"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4683" name="line-4683"></a>
<a id="line-4684" name="line-4684"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="line-4685" name="line-4685"></a><span class="w">            </span><span class="n">e820_table_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_NR_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4686" name="line-4686"></a>
<a id="line-4687" name="line-4687"></a><span class="w">            </span><span class="c1">// do we have any reason to fail here ?</span>
<a id="line-4688" name="line-4688"></a><span class="w">            </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4689" name="line-4689"></a>
<a id="line-4690" name="line-4690"></a><span class="w">            </span><span class="c1">// Get the amount of extended memory (above 1M)</span>
<a id="line-4691" name="line-4691"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-4692" name="line-4692"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x31</span><span class="p">);</span>
<a id="line-4693" name="line-4693"></a>
<a id="line-4694" name="line-4694"></a><span class="w">            </span><span class="c1">// limit to 15M</span>
<a id="line-4695" name="line-4695"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>
<a id="line-4696" name="line-4696"></a><span class="w">                </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<a id="line-4697" name="line-4697"></a>
<a id="line-4698" name="line-4698"></a><span class="w">            </span><span class="c1">// Find first RAM E820 entry &gt;= 1MB.</span>
<a id="line-4699" name="line-4699"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4700" name="line-4700"></a><span class="w">                </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
<a id="line-4701" name="line-4701"></a><span class="w">                </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
<a id="line-4702" name="line-4702"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">base</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x100000</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="line-4703" name="line-4703"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="line-4704" name="line-4704"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4705" name="line-4705"></a>
<a id="line-4706" name="line-4706"></a><span class="w">            </span><span class="c1">// If there is RAM above 16MB, return amount in 64kB chunks.</span>
<a id="line-4707" name="line-4707"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4708" name="line-4708"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">e820_table_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4709" name="line-4709"></a><span class="w">                </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">E820_SEG</span><span class="p">,</span><span class="w"> </span><span class="n">E820_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
<a id="line-4710" name="line-4710"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x1000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4711" name="line-4711"></a><span class="w">                    </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x1000000</span><span class="p">;</span>
<a id="line-4712" name="line-4712"></a><span class="w">                    </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-4713" name="line-4713"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4714" name="line-4714"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4715" name="line-4715"></a>
<a id="line-4716" name="line-4716"></a><span class="w">            </span><span class="c1">// Set configured memory equal to extended memory</span>
<a id="line-4717" name="line-4717"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="line-4718" name="line-4718"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
<a id="line-4719" name="line-4719"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="line-4720" name="line-4720"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4721" name="line-4721"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w">  </span><span class="cm">/* AH=0xE8?? but not implemented */</span>
<a id="line-4722" name="line-4722"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4723" name="line-4723"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4724" name="line-4724"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4725" name="line-4725"></a><span class="w">    </span><span class="nl">int15_unimplemented</span><span class="p">:</span>
<a id="line-4726" name="line-4726"></a><span class="w">       </span><span class="c1">// fall into the default</span>
<a id="line-4727" name="line-4727"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-4728" name="line-4728"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;*** int 15h function AX=%04x, BX=%04x not yet supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="line-4729" name="line-4729"></a><span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">);</span>
<a id="line-4730" name="line-4730"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4731" name="line-4731"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4732" name="line-4732"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4733" name="line-4733"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4734" name="line-4734"></a><span class="cp">#else</span>
<a id="line-4735" name="line-4735"></a><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="mh">0x20</span><span class="p">:</span><span class="w"> </span><span class="c1">// coded by osmaker aka K.J.</span>
<a id="line-4736" name="line-4736"></a><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">edx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">)</span>
<a id="line-4737" name="line-4737"></a><span class="w">            </span><span class="p">{</span>
<a id="line-4738" name="line-4738"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x35</span><span class="p">);</span>
<a id="line-4739" name="line-4739"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-4740" name="line-4740"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x34</span><span class="p">);</span>
<a id="line-4741" name="line-4741"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<a id="line-4742" name="line-4742"></a><span class="w">                </span><span class="c1">// greater than EFF00000???</span>
<a id="line-4743" name="line-4743"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x3bc000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4744" name="line-4744"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3bc000</span><span class="p">;</span><span class="w"> </span><span class="c1">// everything after this is reserved memory until we get to 0x100000000</span>
<a id="line-4745" name="line-4745"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4746" name="line-4746"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<a id="line-4747" name="line-4747"></a><span class="w">                </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="mf">16L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="line-4748" name="line-4748"></a>
<a id="line-4749" name="line-4749"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="mf">16L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-4750" name="line-4750"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x31</span><span class="p">);</span>
<a id="line-4751" name="line-4751"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-4752" name="line-4752"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-4753" name="line-4753"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<a id="line-4754" name="line-4754"></a><span class="w">                    </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="mf">1L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="line-4755" name="line-4755"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4756" name="line-4756"></a>
<a id="line-4757" name="line-4757"></a><span class="w">                </span><span class="k">switch</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">)</span>
<a id="line-4758" name="line-4758"></a><span class="w">                </span><span class="p">{</span>
<a id="line-4759" name="line-4759"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<a id="line-4760" name="line-4760"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4761" name="line-4761"></a><span class="w">                                       </span><span class="mh">0x0000000L</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0009f000L</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-4762" name="line-4762"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-4763" name="line-4763"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4764" name="line-4764"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4765" name="line-4765"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4766" name="line-4766"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4767" name="line-4767"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4768" name="line-4768"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<a id="line-4769" name="line-4769"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4770" name="line-4770"></a><span class="w">                                       </span><span class="mh">0x0009f000L</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000a0000L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="line-4771" name="line-4771"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-4772" name="line-4772"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4773" name="line-4773"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4774" name="line-4774"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4775" name="line-4775"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4776" name="line-4776"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4777" name="line-4777"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<a id="line-4778" name="line-4778"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4779" name="line-4779"></a><span class="w">                                       </span><span class="mh">0x000e8000L</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100000L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="line-4780" name="line-4780"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-4781" name="line-4781"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4782" name="line-4782"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4783" name="line-4783"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4784" name="line-4784"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4785" name="line-4785"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4786" name="line-4786"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="line-4787" name="line-4787"></a><span class="cp">#if BX_ROMBIOS32</span>
<a id="line-4788" name="line-4788"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4789" name="line-4789"></a><span class="w">                                       </span><span class="mh">0x00100000L</span><span class="p">,</span>
<a id="line-4790" name="line-4790"></a><span class="w">                                       </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ACPI_DATA_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-4791" name="line-4791"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-4792" name="line-4792"></a><span class="cp">#else</span>
<a id="line-4793" name="line-4793"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4794" name="line-4794"></a><span class="w">                                       </span><span class="mh">0x00100000L</span><span class="p">,</span>
<a id="line-4795" name="line-4795"></a><span class="w">                                       </span><span class="n">extended_memory_size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-4796" name="line-4796"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="line-4797" name="line-4797"></a><span class="cp">#endif</span>
<a id="line-4798" name="line-4798"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4799" name="line-4799"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4800" name="line-4800"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4801" name="line-4801"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4802" name="line-4802"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4803" name="line-4803"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<a id="line-4804" name="line-4804"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4805" name="line-4805"></a><span class="w">                                       </span><span class="n">extended_memory_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ACPI_DATA_SIZE</span><span class="p">,</span>
<a id="line-4806" name="line-4806"></a><span class="w">                                       </span><span class="n">extended_memory_size</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// ACPI RAM</span>
<a id="line-4807" name="line-4807"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="line-4808" name="line-4808"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4809" name="line-4809"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4810" name="line-4810"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4811" name="line-4811"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4812" name="line-4812"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4813" name="line-4813"></a><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<a id="line-4814" name="line-4814"></a><span class="w">                        </span><span class="cm">/* 256KB BIOS area at the end of 4 GB */</span>
<a id="line-4815" name="line-4815"></a><span class="w">                        </span><span class="n">set_e820_range</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">di</span><span class="p">,</span>
<a id="line-4816" name="line-4816"></a><span class="w">                                       </span><span class="mh">0xfffc0000L</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00000000L</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="line-4817" name="line-4817"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ebx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4818" name="line-4818"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">eax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x534D4150</span><span class="p">;</span>
<a id="line-4819" name="line-4819"></a><span class="w">                        </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r32</span><span class="p">.</span><span class="n">ecx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x14</span><span class="p">;</span>
<a id="line-4820" name="line-4820"></a><span class="w">                        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4821" name="line-4821"></a><span class="w">                        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4822" name="line-4822"></a><span class="w">                    </span><span class="k">default</span><span class="o">:</span><span class="w">  </span><span class="cm">/* AX=E820, DX=534D4150, BX unrecognized */</span>
<a id="line-4823" name="line-4823"></a><span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4824" name="line-4824"></a><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<a id="line-4825" name="line-4825"></a><span class="w">                </span><span class="p">}</span>
<a id="line-4826" name="line-4826"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4827" name="line-4827"></a><span class="w">              </span><span class="c1">// if DX != 0x534D4150)</span>
<a id="line-4828" name="line-4828"></a><span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4829" name="line-4829"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4830" name="line-4830"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="line-4831" name="line-4831"></a>
<a id="line-4832" name="line-4832"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span>
<a id="line-4833" name="line-4833"></a><span class="w">          </span><span class="c1">// do we have any reason to fail here ?</span>
<a id="line-4834" name="line-4834"></a><span class="w">          </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-4835" name="line-4835"></a>
<a id="line-4836" name="line-4836"></a><span class="w">          </span><span class="c1">// my real system sets ax and bx to 0</span>
<a id="line-4837" name="line-4837"></a><span class="w">          </span><span class="c1">// this is confirmed by Ralph Brown list</span>
<a id="line-4838" name="line-4838"></a><span class="w">          </span><span class="c1">// but syslinux v1.48 is known to behave</span>
<a id="line-4839" name="line-4839"></a><span class="w">          </span><span class="c1">// strangely if ax is set to 0</span>
<a id="line-4840" name="line-4840"></a><span class="w">          </span><span class="c1">// regs.u.r16.ax = 0;</span>
<a id="line-4841" name="line-4841"></a><span class="w">          </span><span class="c1">// regs.u.r16.bx = 0;</span>
<a id="line-4842" name="line-4842"></a>
<a id="line-4843" name="line-4843"></a><span class="w">          </span><span class="c1">// Get the amount of extended memory (above 1M)</span>
<a id="line-4844" name="line-4844"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-4845" name="line-4845"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x31</span><span class="p">);</span>
<a id="line-4846" name="line-4846"></a>
<a id="line-4847" name="line-4847"></a><span class="w">          </span><span class="c1">// limit to 15M</span>
<a id="line-4848" name="line-4848"></a><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x3c00</span><span class="p">)</span>
<a id="line-4849" name="line-4849"></a><span class="w">          </span><span class="p">{</span>
<a id="line-4850" name="line-4850"></a><span class="w">            </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3c00</span><span class="p">;</span>
<a id="line-4851" name="line-4851"></a><span class="w">          </span><span class="p">}</span>
<a id="line-4852" name="line-4852"></a>
<a id="line-4853" name="line-4853"></a><span class="w">          </span><span class="c1">// Get the amount of extended memory above 16M in 64k blocs</span>
<a id="line-4854" name="line-4854"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x34</span><span class="p">);</span>
<a id="line-4855" name="line-4855"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x35</span><span class="p">);</span>
<a id="line-4856" name="line-4856"></a>
<a id="line-4857" name="line-4857"></a><span class="w">          </span><span class="c1">// Set configured memory equal to extended memory</span>
<a id="line-4858" name="line-4858"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="line-4859" name="line-4859"></a><span class="w">          </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
<a id="line-4860" name="line-4860"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-4861" name="line-4861"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w">  </span><span class="cm">/* AH=0xE8?? but not implemented */</span>
<a id="line-4862" name="line-4862"></a><span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">int15_unimplemented</span><span class="p">;</span>
<a id="line-4863" name="line-4863"></a><span class="w">       </span><span class="p">}</span>
<a id="line-4864" name="line-4864"></a><span class="w">       </span><span class="k">break</span><span class="p">;</span>
<a id="line-4865" name="line-4865"></a><span class="w">    </span><span class="nl">int15_unimplemented</span><span class="p">:</span>
<a id="line-4866" name="line-4866"></a><span class="w">       </span><span class="c1">// fall into the default</span>
<a id="line-4867" name="line-4867"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-4868" name="line-4868"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;*** int 15h function AX=%04x, BX=%04x not yet supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="line-4869" name="line-4869"></a><span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">);</span>
<a id="line-4870" name="line-4870"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-4871" name="line-4871"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNSUPPORTED_FUNCTION</span><span class="p">;</span>
<a id="line-4872" name="line-4872"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4873" name="line-4873"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4874" name="line-4874"></a><span class="cp">#endif </span><span class="cm">/* HVMASSIST */</span>
<a id="line-4875" name="line-4875"></a><span class="p">}</span>
<a id="line-4876" name="line-4876"></a>
<a id="line-4877" name="line-4877"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-4878" name="line-4878"></a><span class="n">int16_function</span><span class="p">(</span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-4879" name="line-4879"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-4880" name="line-4880"></a><span class="p">{</span>
<a id="line-4881" name="line-4881"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">,</span><span class="w"> </span><span class="n">led_flags</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-4882" name="line-4882"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">kbd_code</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<a id="line-4883" name="line-4883"></a>
<a id="line-4884" name="line-4884"></a><span class="w">  </span><span class="n">BX_DEBUG_INT16</span><span class="p">(</span><span class="s">&quot;int16: AX=%04x BX=%04x CX=%04x DX=%04x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">);</span>
<a id="line-4885" name="line-4885"></a>
<a id="line-4886" name="line-4886"></a><span class="w">  </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">);</span>
<a id="line-4887" name="line-4887"></a><span class="w">  </span><span class="n">led_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x97</span><span class="p">);</span>
<a id="line-4888" name="line-4888"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="n">led_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4889" name="line-4889"></a><span class="n">ASM_START</span>
<a id="line-4890" name="line-4890"></a><span class="w">    </span><span class="n">cli</span>
<a id="line-4891" name="line-4891"></a><span class="n">ASM_END</span>
<a id="line-4892" name="line-4892"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xed</span><span class="p">);</span>
<a id="line-4893" name="line-4893"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">);</span>
<a id="line-4894" name="line-4894"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-4895" name="line-4895"></a><span class="w">      </span><span class="n">led_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">;</span>
<a id="line-4896" name="line-4896"></a><span class="w">      </span><span class="n">led_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">((</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">);</span>
<a id="line-4897" name="line-4897"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="n">led_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">);</span>
<a id="line-4898" name="line-4898"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x21</span><span class="p">);</span>
<a id="line-4899" name="line-4899"></a><span class="w">      </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-4900" name="line-4900"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x97</span><span class="p">,</span><span class="w"> </span><span class="n">led_flags</span><span class="p">);</span>
<a id="line-4901" name="line-4901"></a><span class="w">    </span><span class="p">}</span>
<a id="line-4902" name="line-4902"></a><span class="n">ASM_START</span>
<a id="line-4903" name="line-4903"></a><span class="w">    </span><span class="n">sti</span>
<a id="line-4904" name="line-4904"></a><span class="n">ASM_END</span>
<a id="line-4905" name="line-4905"></a><span class="w">  </span><span class="p">}</span>
<a id="line-4906" name="line-4906"></a>
<a id="line-4907" name="line-4907"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-4908" name="line-4908"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read keyboard input */</span>
<a id="line-4909" name="line-4909"></a>
<a id="line-4910" name="line-4910"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">dequeue_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4911" name="line-4911"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;KBD: int16h: out of keyboard input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4912" name="line-4912"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4913" name="line-4913"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4914" name="line-4914"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xE0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4915" name="line-4915"></a><span class="w">      </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-4916" name="line-4916"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4917" name="line-4917"></a>
<a id="line-4918" name="line-4918"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check keyboard status */</span>
<a id="line-4919" name="line-4919"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">dequeue_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4920" name="line-4920"></a><span class="w">        </span><span class="n">SET_ZF</span><span class="p">();</span>
<a id="line-4921" name="line-4921"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4922" name="line-4922"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4923" name="line-4923"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4924" name="line-4924"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xE0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4925" name="line-4925"></a><span class="w">      </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-4926" name="line-4926"></a><span class="w">      </span><span class="n">CLEAR_ZF</span><span class="p">();</span>
<a id="line-4927" name="line-4927"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4928" name="line-4928"></a>
<a id="line-4929" name="line-4929"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="cm">/* get shift flag status */</span>
<a id="line-4930" name="line-4930"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">);</span>
<a id="line-4931" name="line-4931"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-4932" name="line-4932"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4933" name="line-4933"></a>
<a id="line-4934" name="line-4934"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="cm">/* store key-stroke into buffer */</span>
<a id="line-4935" name="line-4935"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">enqueue_key</span><span class="p">(</span><span class="n">GET_CH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_CL</span><span class="p">())</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4936" name="line-4936"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-4937" name="line-4937"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4938" name="line-4938"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-4939" name="line-4939"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-4940" name="line-4940"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4941" name="line-4941"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4942" name="line-4942"></a>
<a id="line-4943" name="line-4943"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x09</span><span class="p">:</span><span class="w"> </span><span class="cm">/* GET KEYBOARD FUNCTIONALITY */</span>
<a id="line-4944" name="line-4944"></a><span class="w">      </span><span class="c1">// bit Bochs Description</span>
<a id="line-4945" name="line-4945"></a><span class="w">      </span><span class="c1">//  7    0   reserved</span>
<a id="line-4946" name="line-4946"></a><span class="w">      </span><span class="c1">//  6    0   INT 16/AH=20h-22h supported (122-key keyboard support)</span>
<a id="line-4947" name="line-4947"></a><span class="w">      </span><span class="c1">//  5    1   INT 16/AH=10h-12h supported (enhanced keyboard support)</span>
<a id="line-4948" name="line-4948"></a><span class="w">      </span><span class="c1">//  4    1   INT 16/AH=0Ah supported</span>
<a id="line-4949" name="line-4949"></a><span class="w">      </span><span class="c1">//  3    0   INT 16/AX=0306h supported</span>
<a id="line-4950" name="line-4950"></a><span class="w">      </span><span class="c1">//  2    0   INT 16/AX=0305h supported</span>
<a id="line-4951" name="line-4951"></a><span class="w">      </span><span class="c1">//  1    0   INT 16/AX=0304h supported</span>
<a id="line-4952" name="line-4952"></a><span class="w">      </span><span class="c1">//  0    0   INT 16/AX=0300h supported</span>
<a id="line-4953" name="line-4953"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-4954" name="line-4954"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-4955" name="line-4955"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4956" name="line-4956"></a>
<a id="line-4957" name="line-4957"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0A</span><span class="p">:</span><span class="w"> </span><span class="cm">/* GET KEYBOARD ID */</span>
<a id="line-4958" name="line-4958"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-4959" name="line-4959"></a><span class="w">      </span><span class="n">kbd_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<a id="line-4960" name="line-4960"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf2</span><span class="p">);</span>
<a id="line-4961" name="line-4961"></a><span class="w">      </span><span class="cm">/* Wait for data */</span>
<a id="line-4962" name="line-4962"></a><span class="w">      </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-4963" name="line-4963"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-4964" name="line-4964"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">&gt;</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4965" name="line-4965"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xfa</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-4966" name="line-4966"></a><span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-4967" name="line-4967"></a><span class="w">            </span><span class="n">max</span><span class="o">=</span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-4968" name="line-4968"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">max</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-4969" name="line-4969"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="o">&gt;</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4970" name="line-4970"></a><span class="w">              </span><span class="n">kbd_code</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-4971" name="line-4971"></a><span class="w">              </span><span class="n">kbd_code</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-4972" name="line-4972"></a><span class="w">            </span><span class="p">}</span>
<a id="line-4973" name="line-4973"></a><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
<a id="line-4974" name="line-4974"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4975" name="line-4975"></a><span class="w">      </span><span class="p">}</span>
<a id="line-4976" name="line-4976"></a><span class="w">      </span><span class="n">BX</span><span class="o">=</span><span class="n">kbd_code</span><span class="p">;</span>
<a id="line-4977" name="line-4977"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4978" name="line-4978"></a>
<a id="line-4979" name="line-4979"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x10</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read MF-II keyboard input */</span>
<a id="line-4980" name="line-4980"></a>
<a id="line-4981" name="line-4981"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">dequeue_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4982" name="line-4982"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;KBD: int16h: out of keyboard input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-4983" name="line-4983"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4984" name="line-4984"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4985" name="line-4985"></a><span class="w">      </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-4986" name="line-4986"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4987" name="line-4987"></a>
<a id="line-4988" name="line-4988"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x11</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check MF-II keyboard status */</span>
<a id="line-4989" name="line-4989"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">dequeue_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-4990" name="line-4990"></a><span class="w">        </span><span class="n">SET_ZF</span><span class="p">();</span>
<a id="line-4991" name="line-4991"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-4992" name="line-4992"></a><span class="w">        </span><span class="p">}</span>
<a id="line-4993" name="line-4993"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">)</span><span class="w"> </span><span class="n">ascii_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-4994" name="line-4994"></a><span class="w">      </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">scan_code</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-4995" name="line-4995"></a><span class="w">      </span><span class="n">CLEAR_ZF</span><span class="p">();</span>
<a id="line-4996" name="line-4996"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-4997" name="line-4997"></a>
<a id="line-4998" name="line-4998"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x12</span><span class="p">:</span><span class="w"> </span><span class="cm">/* get extended keyboard status */</span>
<a id="line-4999" name="line-4999"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">);</span>
<a id="line-5000" name="line-5000"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5001" name="line-5001"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x73</span><span class="p">;</span>
<a id="line-5002" name="line-5002"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">;</span>
<a id="line-5003" name="line-5003"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5004" name="line-5004"></a><span class="w">      </span><span class="n">BX_DEBUG_INT16</span><span class="p">(</span><span class="s">&quot;int16: func 12 sending %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">AX</span><span class="p">);</span>
<a id="line-5005" name="line-5005"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5006" name="line-5006"></a>
<a id="line-5007" name="line-5007"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x92</span><span class="p">:</span><span class="w"> </span><span class="cm">/* keyboard capability check called by DOS 5.0+ keyb */</span>
<a id="line-5008" name="line-5008"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// function int16 ah=0x10-0x12 supported</span>
<a id="line-5009" name="line-5009"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5010" name="line-5010"></a>
<a id="line-5011" name="line-5011"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xA2</span><span class="p">:</span><span class="w"> </span><span class="cm">/* 122 keys capability check called by DOS 5.0+ keyb */</span>
<a id="line-5012" name="line-5012"></a><span class="w">      </span><span class="c1">// don&#39;t change AH : function int16 ah=0x20-0x22 NOT supported</span>
<a id="line-5013" name="line-5013"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5014" name="line-5014"></a>
<a id="line-5015" name="line-5015"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x6F</span><span class="p">:</span>
<a id="line-5016" name="line-5016"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AL</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span>
<a id="line-5017" name="line-5017"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span><span class="w"> </span><span class="c1">// unsupported, aka normal keyboard</span>
<a id="line-5018" name="line-5018"></a>
<a id="line-5019" name="line-5019"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-5020" name="line-5020"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;KBD: unsupported int 16h function %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5021" name="line-5021"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5022" name="line-5022"></a><span class="p">}</span>
<a id="line-5023" name="line-5023"></a>
<a id="line-5024" name="line-5024"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span>
<a id="line-5025" name="line-5025"></a><span class="n">dequeue_key</span><span class="p">(</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="n">incr</span><span class="p">)</span>
<a id="line-5026" name="line-5026"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="o">*</span><span class="n">scan_code</span><span class="p">;</span>
<a id="line-5027" name="line-5027"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="o">*</span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-5028" name="line-5028"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">incr</span><span class="p">;</span>
<a id="line-5029" name="line-5029"></a><span class="p">{</span>
<a id="line-5030" name="line-5030"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">buffer_start</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_end</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_head</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_tail</span><span class="p">;</span>
<a id="line-5031" name="line-5031"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<a id="line-5032" name="line-5032"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">acode</span><span class="p">,</span><span class="w"> </span><span class="n">scode</span><span class="p">;</span>
<a id="line-5033" name="line-5033"></a>
<a id="line-5034" name="line-5034"></a><span class="cp">#if BX_CPU &lt; 2</span>
<a id="line-5035" name="line-5035"></a><span class="w">  </span><span class="n">buffer_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x001E</span><span class="p">;</span>
<a id="line-5036" name="line-5036"></a><span class="w">  </span><span class="n">buffer_end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x003E</span><span class="p">;</span>
<a id="line-5037" name="line-5037"></a><span class="cp">#else</span>
<a id="line-5038" name="line-5038"></a><span class="w">  </span><span class="n">buffer_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0080</span><span class="p">);</span>
<a id="line-5039" name="line-5039"></a><span class="w">  </span><span class="n">buffer_end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0082</span><span class="p">);</span>
<a id="line-5040" name="line-5040"></a><span class="cp">#endif</span>
<a id="line-5041" name="line-5041"></a>
<a id="line-5042" name="line-5042"></a><span class="w">  </span><span class="n">buffer_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001a</span><span class="p">);</span>
<a id="line-5043" name="line-5043"></a><span class="w">  </span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001c</span><span class="p">);</span>
<a id="line-5044" name="line-5044"></a>
<a id="line-5045" name="line-5045"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_head</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">buffer_tail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5046" name="line-5046"></a><span class="w">    </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-5047" name="line-5047"></a><span class="w">    </span><span class="n">acode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_head</span><span class="p">);</span>
<a id="line-5048" name="line-5048"></a><span class="w">    </span><span class="n">scode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_head</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5049" name="line-5049"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">,</span><span class="w"> </span><span class="n">acode</span><span class="p">);</span>
<a id="line-5050" name="line-5050"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="n">scode</span><span class="p">);</span>
<a id="line-5051" name="line-5051"></a>
<a id="line-5052" name="line-5052"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">incr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5053" name="line-5053"></a><span class="w">      </span><span class="n">buffer_head</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-5054" name="line-5054"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_head</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">buffer_end</span><span class="p">)</span>
<a id="line-5055" name="line-5055"></a><span class="w">        </span><span class="n">buffer_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_start</span><span class="p">;</span>
<a id="line-5056" name="line-5056"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001a</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_head</span><span class="p">);</span>
<a id="line-5057" name="line-5057"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5058" name="line-5058"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5059" name="line-5059"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5060" name="line-5060"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5061" name="line-5061"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5062" name="line-5062"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5063" name="line-5063"></a><span class="p">}</span>
<a id="line-5064" name="line-5064"></a>
<a id="line-5065" name="line-5065"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;%s: keyboard input buffer full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<a id="line-5066" name="line-5066"></a>
<a id="line-5067" name="line-5067"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-5068" name="line-5068"></a><span class="nf">inhibit_mouse_int_and_events</span><span class="p">()</span>
<a id="line-5069" name="line-5069"></a><span class="p">{</span>
<a id="line-5070" name="line-5070"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">command_byte</span><span class="p">,</span><span class="w"> </span><span class="n">prev_command_byte</span><span class="p">;</span>
<a id="line-5071" name="line-5071"></a>
<a id="line-5072" name="line-5072"></a><span class="w">  </span><span class="c1">// Turn off IRQ generation and aux data line</span>
<a id="line-5073" name="line-5073"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5074" name="line-5074"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;inhibmouse&quot;</span><span class="p">);</span>
<a id="line-5075" name="line-5075"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span><span class="w"> </span><span class="c1">// get command byte</span>
<a id="line-5076" name="line-5076"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="p">);</span>
<a id="line-5077" name="line-5077"></a><span class="w">  </span><span class="n">prev_command_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-5078" name="line-5078"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev_command_byte</span><span class="p">;</span>
<a id="line-5079" name="line-5079"></a><span class="w">  </span><span class="c1">//while ( (inb(0x64) &amp; 0x02) );</span>
<a id="line-5080" name="line-5080"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5081" name="line-5081"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;inhibmouse&quot;</span><span class="p">);</span>
<a id="line-5082" name="line-5082"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xfd</span><span class="p">;</span><span class="w"> </span><span class="c1">// turn off IRQ 12 generation</span>
<a id="line-5083" name="line-5083"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span><span class="w"> </span><span class="c1">// disable mouse serial clock line</span>
<a id="line-5084" name="line-5084"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span><span class="w"> </span><span class="c1">// write command byte</span>
<a id="line-5085" name="line-5085"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="n">command_byte</span><span class="p">);</span>
<a id="line-5086" name="line-5086"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">prev_command_byte</span><span class="p">);</span>
<a id="line-5087" name="line-5087"></a><span class="p">}</span>
<a id="line-5088" name="line-5088"></a>
<a id="line-5089" name="line-5089"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5090" name="line-5090"></a><span class="nf">enable_mouse_int_and_events</span><span class="p">()</span>
<a id="line-5091" name="line-5091"></a><span class="p">{</span>
<a id="line-5092" name="line-5092"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">command_byte</span><span class="p">;</span>
<a id="line-5093" name="line-5093"></a>
<a id="line-5094" name="line-5094"></a><span class="w">  </span><span class="c1">// Turn on IRQ generation and aux data line</span>
<a id="line-5095" name="line-5095"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5096" name="line-5096"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;enabmouse&quot;</span><span class="p">);</span>
<a id="line-5097" name="line-5097"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span><span class="w"> </span><span class="c1">// get command byte</span>
<a id="line-5098" name="line-5098"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="p">);</span>
<a id="line-5099" name="line-5099"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-5100" name="line-5100"></a><span class="w">  </span><span class="c1">//while ( (inb(0x64) &amp; 0x02) );</span>
<a id="line-5101" name="line-5101"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5102" name="line-5102"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;enabmouse&quot;</span><span class="p">);</span>
<a id="line-5103" name="line-5103"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span><span class="w"> </span><span class="c1">// turn on IRQ 12 generation</span>
<a id="line-5104" name="line-5104"></a><span class="w">  </span><span class="n">command_byte</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xdf</span><span class="p">;</span><span class="w"> </span><span class="c1">// enable mouse serial clock line</span>
<a id="line-5105" name="line-5105"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span><span class="w"> </span><span class="c1">// write command byte</span>
<a id="line-5106" name="line-5106"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="n">command_byte</span><span class="p">);</span>
<a id="line-5107" name="line-5107"></a><span class="p">}</span>
<a id="line-5108" name="line-5108"></a>
<a id="line-5109" name="line-5109"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-5110" name="line-5110"></a><span class="nf">send_to_mouse_ctrl</span><span class="p">(</span><span class="n">sendbyte</span><span class="p">)</span>
<a id="line-5111" name="line-5111"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">sendbyte</span><span class="p">;</span>
<a id="line-5112" name="line-5112"></a><span class="p">{</span>
<a id="line-5113" name="line-5113"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<a id="line-5114" name="line-5114"></a>
<a id="line-5115" name="line-5115"></a><span class="w">  </span><span class="c1">// wait for chance to write to ctrl</span>
<a id="line-5116" name="line-5116"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5117" name="line-5117"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;sendmouse&quot;</span><span class="p">);</span>
<a id="line-5118" name="line-5118"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0xD4</span><span class="p">);</span>
<a id="line-5119" name="line-5119"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="n">sendbyte</span><span class="p">);</span>
<a id="line-5120" name="line-5120"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5121" name="line-5121"></a><span class="p">}</span>
<a id="line-5122" name="line-5122"></a>
<a id="line-5123" name="line-5123"></a>
<a id="line-5124" name="line-5124"></a><span class="w">  </span><span class="n">Bit8u</span>
<a id="line-5125" name="line-5125"></a><span class="n">get_mouse_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="line-5126" name="line-5126"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a id="line-5127" name="line-5127"></a><span class="p">{</span>
<a id="line-5128" name="line-5128"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
<a id="line-5129" name="line-5129"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<a id="line-5130" name="line-5130"></a>
<a id="line-5131" name="line-5131"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x21</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x21</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5132" name="line-5132"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5133" name="line-5133"></a>
<a id="line-5134" name="line-5134"></a><span class="w">  </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-5135" name="line-5135"></a>
<a id="line-5136" name="line-5136"></a><span class="w">  </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-5137" name="line-5137"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>
<a id="line-5138" name="line-5138"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5139" name="line-5139"></a><span class="p">}</span>
<a id="line-5140" name="line-5140"></a>
<a id="line-5141" name="line-5141"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5142" name="line-5142"></a><span class="n">set_kbd_command_byte</span><span class="p">(</span><span class="n">command_byte</span><span class="p">)</span>
<a id="line-5143" name="line-5143"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">command_byte</span><span class="p">;</span>
<a id="line-5144" name="line-5144"></a><span class="p">{</span>
<a id="line-5145" name="line-5145"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5146" name="line-5146"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="n">panic_msg_keyb_buffer_full</span><span class="p">,</span><span class="s">&quot;setkbdcomm&quot;</span><span class="p">);</span>
<a id="line-5147" name="line-5147"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0xD4</span><span class="p">);</span>
<a id="line-5148" name="line-5148"></a>
<a id="line-5149" name="line-5149"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">);</span><span class="w"> </span><span class="c1">// write command byte</span>
<a id="line-5150" name="line-5150"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="n">command_byte</span><span class="p">);</span>
<a id="line-5151" name="line-5151"></a><span class="p">}</span>
<a id="line-5152" name="line-5152"></a>
<a id="line-5153" name="line-5153"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5154" name="line-5154"></a><span class="n">int09_function</span><span class="p">(</span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">)</span>
<a id="line-5155" name="line-5155"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">;</span>
<a id="line-5156" name="line-5156"></a><span class="p">{</span>
<a id="line-5157" name="line-5157"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">scancode</span><span class="p">,</span><span class="w"> </span><span class="n">asciicode</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">;</span>
<a id="line-5158" name="line-5158"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">;</span>
<a id="line-5159" name="line-5159"></a>
<a id="line-5160" name="line-5160"></a><span class="w">  </span><span class="c1">//</span>
<a id="line-5161" name="line-5161"></a><span class="w">  </span><span class="c1">// DS has been set to F000 before call</span>
<a id="line-5162" name="line-5162"></a><span class="w">  </span><span class="c1">//</span>
<a id="line-5163" name="line-5163"></a>
<a id="line-5164" name="line-5164"></a>
<a id="line-5165" name="line-5165"></a><span class="w">  </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-5166" name="line-5166"></a>
<a id="line-5167" name="line-5167"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5168" name="line-5168"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;KBD: int09 handler: AL=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-5169" name="line-5169"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-5170" name="line-5170"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5171" name="line-5171"></a>
<a id="line-5172" name="line-5172"></a>
<a id="line-5173" name="line-5173"></a><span class="w">  </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">);</span>
<a id="line-5174" name="line-5174"></a><span class="w">  </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">);</span>
<a id="line-5175" name="line-5175"></a><span class="w">  </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">);</span>
<a id="line-5176" name="line-5176"></a><span class="w">  </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-5177" name="line-5177"></a>
<a id="line-5178" name="line-5178"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5179" name="line-5179"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x3a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Caps Lock press */</span>
<a id="line-5180" name="line-5180"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x40</span><span class="p">;</span>
<a id="line-5181" name="line-5181"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5182" name="line-5182"></a><span class="w">      </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x40</span><span class="p">;</span>
<a id="line-5183" name="line-5183"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5184" name="line-5184"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5185" name="line-5185"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xba</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Caps Lock release */</span>
<a id="line-5186" name="line-5186"></a><span class="w">      </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
<a id="line-5187" name="line-5187"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5188" name="line-5188"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5189" name="line-5189"></a>
<a id="line-5190" name="line-5190"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x2a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* L Shift press */</span>
<a id="line-5191" name="line-5191"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span>
<a id="line-5192" name="line-5192"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5193" name="line-5193"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5194" name="line-5194"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">:</span><span class="w"> </span><span class="cm">/* L Shift release */</span>
<a id="line-5195" name="line-5195"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
<a id="line-5196" name="line-5196"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5197" name="line-5197"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5198" name="line-5198"></a>
<a id="line-5199" name="line-5199"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x36</span><span class="p">:</span><span class="w"> </span><span class="cm">/* R Shift press */</span>
<a id="line-5200" name="line-5200"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-5201" name="line-5201"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5202" name="line-5202"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5203" name="line-5203"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xb6</span><span class="p">:</span><span class="w"> </span><span class="cm">/* R Shift release */</span>
<a id="line-5204" name="line-5204"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-5205" name="line-5205"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5206" name="line-5206"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5207" name="line-5207"></a>
<a id="line-5208" name="line-5208"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x1d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Ctrl press */</span>
<a id="line-5209" name="line-5209"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5210" name="line-5210"></a><span class="w">        </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-5211" name="line-5211"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5212" name="line-5212"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5213" name="line-5213"></a><span class="w">          </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-5214" name="line-5214"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">);</span>
<a id="line-5215" name="line-5215"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5216" name="line-5216"></a><span class="w">          </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-5217" name="line-5217"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5218" name="line-5218"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5219" name="line-5219"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5220" name="line-5220"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5221" name="line-5221"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x9d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Ctrl release */</span>
<a id="line-5222" name="line-5222"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5223" name="line-5223"></a><span class="w">        </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-5224" name="line-5224"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5225" name="line-5225"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5226" name="line-5226"></a><span class="w">          </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-5227" name="line-5227"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">);</span>
<a id="line-5228" name="line-5228"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5229" name="line-5229"></a><span class="w">          </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-5230" name="line-5230"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5231" name="line-5231"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5232" name="line-5232"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5233" name="line-5233"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5234" name="line-5234"></a>
<a id="line-5235" name="line-5235"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x38</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Alt press */</span>
<a id="line-5236" name="line-5236"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x08</span><span class="p">;</span>
<a id="line-5237" name="line-5237"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5238" name="line-5238"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5239" name="line-5239"></a><span class="w">        </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x08</span><span class="p">;</span>
<a id="line-5240" name="line-5240"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">);</span>
<a id="line-5241" name="line-5241"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5242" name="line-5242"></a><span class="w">        </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span>
<a id="line-5243" name="line-5243"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5244" name="line-5244"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5245" name="line-5245"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5246" name="line-5246"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xb8</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Alt release */</span>
<a id="line-5247" name="line-5247"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
<a id="line-5248" name="line-5248"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5249" name="line-5249"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5250" name="line-5250"></a><span class="w">        </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
<a id="line-5251" name="line-5251"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">);</span>
<a id="line-5252" name="line-5252"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5253" name="line-5253"></a><span class="w">        </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
<a id="line-5254" name="line-5254"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5255" name="line-5255"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5256" name="line-5256"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5257" name="line-5257"></a>
<a id="line-5258" name="line-5258"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x45</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Num Lock press */</span>
<a id="line-5259" name="line-5259"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5260" name="line-5260"></a><span class="w">        </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<a id="line-5261" name="line-5261"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5262" name="line-5262"></a><span class="w">        </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<a id="line-5263" name="line-5263"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5264" name="line-5264"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5265" name="line-5265"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5266" name="line-5266"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xc5</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Num Lock release */</span>
<a id="line-5267" name="line-5267"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5268" name="line-5268"></a><span class="w">        </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
<a id="line-5269" name="line-5269"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5270" name="line-5270"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5271" name="line-5271"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5272" name="line-5272"></a>
<a id="line-5273" name="line-5273"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x46</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Scroll Lock press */</span>
<a id="line-5274" name="line-5274"></a><span class="w">      </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span>
<a id="line-5275" name="line-5275"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5276" name="line-5276"></a><span class="w">      </span><span class="n">shift_flags</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span>
<a id="line-5277" name="line-5277"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="n">shift_flags</span><span class="p">);</span>
<a id="line-5278" name="line-5278"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5279" name="line-5279"></a>
<a id="line-5280" name="line-5280"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Scroll Lock release */</span>
<a id="line-5281" name="line-5281"></a><span class="w">      </span><span class="n">mf2_flags</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
<a id="line-5282" name="line-5282"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_flags</span><span class="p">);</span>
<a id="line-5283" name="line-5283"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5284" name="line-5284"></a>
<a id="line-5285" name="line-5285"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x53</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Del */</span>
<a id="line-5286" name="line-5286"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">)</span><span class="w"> </span><span class="cm">/* Ctrl + Alt */</span>
<a id="line-5287" name="line-5287"></a><span class="w">            </span><span class="n">machine_reset</span><span class="p">();</span>
<a id="line-5288" name="line-5288"></a><span class="w">        </span><span class="cm">/* Fall through */</span>
<a id="line-5289" name="line-5289"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-5290" name="line-5290"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5291" name="line-5291"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* toss key releases ... */</span>
<a id="line-5292" name="line-5292"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5293" name="line-5293"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_SCAN_CODE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5294" name="line-5294"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;KBD: int09h_handler(): unknown scancode read: 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scancode</span><span class="p">);</span>
<a id="line-5295" name="line-5295"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-5296" name="line-5296"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5297" name="line-5297"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ALT */</span>
<a id="line-5298" name="line-5298"></a><span class="w">        </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">alt</span><span class="p">;</span>
<a id="line-5299" name="line-5299"></a><span class="w">        </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">alt</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5300" name="line-5300"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* CONTROL */</span>
<a id="line-5301" name="line-5301"></a><span class="w">        </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">control</span><span class="p">;</span>
<a id="line-5302" name="line-5302"></a><span class="w">        </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">control</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5303" name="line-5303"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">scancode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x47</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0x53</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<a id="line-5304" name="line-5304"></a><span class="w">        </span><span class="cm">/* extended keys handling */</span>
<a id="line-5305" name="line-5305"></a><span class="w">        </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">;</span>
<a id="line-5306" name="line-5306"></a><span class="w">        </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">normal</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5307" name="line-5307"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* LSHIFT + RSHIFT */</span>
<a id="line-5308" name="line-5308"></a><span class="w">        </span><span class="cm">/* check if lock state should be ignored</span>
<a id="line-5309" name="line-5309"></a><span class="cm">         * because a SHIFT key are pressed */</span>
<a id="line-5310" name="line-5310"></a>
<a id="line-5311" name="line-5311"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">lock_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5312" name="line-5312"></a><span class="w">          </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">normal</span><span class="p">;</span>
<a id="line-5313" name="line-5313"></a><span class="w">          </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">normal</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5314" name="line-5314"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5315" name="line-5315"></a><span class="w">          </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">shift</span><span class="p">;</span>
<a id="line-5316" name="line-5316"></a><span class="w">          </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">shift</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5317" name="line-5317"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5318" name="line-5318"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5319" name="line-5319"></a><span class="w">        </span><span class="cm">/* check if lock is on */</span>
<a id="line-5320" name="line-5320"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">lock_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5321" name="line-5321"></a><span class="w">          </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">shift</span><span class="p">;</span>
<a id="line-5322" name="line-5322"></a><span class="w">          </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">shift</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5323" name="line-5323"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5324" name="line-5324"></a><span class="w">          </span><span class="n">asciicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">normal</span><span class="p">;</span>
<a id="line-5325" name="line-5325"></a><span class="w">          </span><span class="n">scancode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_to_scanascii</span><span class="p">[</span><span class="n">scancode</span><span class="p">].</span><span class="n">normal</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5326" name="line-5326"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5327" name="line-5327"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5328" name="line-5328"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scancode</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">asciicode</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5329" name="line-5329"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;KBD: int09h_handler(): scancode &amp; asciicode are zero?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-5330" name="line-5330"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5331" name="line-5331"></a><span class="w">      </span><span class="n">enqueue_key</span><span class="p">(</span><span class="n">scancode</span><span class="p">,</span><span class="w"> </span><span class="n">asciicode</span><span class="p">);</span>
<a id="line-5332" name="line-5332"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5333" name="line-5333"></a><span class="w">  </span><span class="p">}</span>
<a id="line-5334" name="line-5334"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">scancode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x1d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5335" name="line-5335"></a><span class="w">    </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-5336" name="line-5336"></a><span class="w">  </span><span class="p">}</span>
<a id="line-5337" name="line-5337"></a><span class="w">  </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
<a id="line-5338" name="line-5338"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">,</span><span class="w"> </span><span class="n">mf2_state</span><span class="p">);</span>
<a id="line-5339" name="line-5339"></a><span class="p">}</span>
<a id="line-5340" name="line-5340"></a>
<a id="line-5341" name="line-5341"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span>
<a id="line-5342" name="line-5342"></a><span class="n">enqueue_key</span><span class="p">(</span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">)</span>
<a id="line-5343" name="line-5343"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">scan_code</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">;</span>
<a id="line-5344" name="line-5344"></a><span class="p">{</span>
<a id="line-5345" name="line-5345"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">buffer_start</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_end</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_head</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_tail</span><span class="p">,</span><span class="w"> </span><span class="n">temp_tail</span><span class="p">;</span>
<a id="line-5346" name="line-5346"></a>
<a id="line-5347" name="line-5347"></a><span class="cp">#if BX_CPU &lt; 2</span>
<a id="line-5348" name="line-5348"></a><span class="w">  </span><span class="n">buffer_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x001E</span><span class="p">;</span>
<a id="line-5349" name="line-5349"></a><span class="w">  </span><span class="n">buffer_end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">0x003E</span><span class="p">;</span>
<a id="line-5350" name="line-5350"></a><span class="cp">#else</span>
<a id="line-5351" name="line-5351"></a><span class="w">  </span><span class="n">buffer_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0080</span><span class="p">);</span>
<a id="line-5352" name="line-5352"></a><span class="w">  </span><span class="n">buffer_end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0082</span><span class="p">);</span>
<a id="line-5353" name="line-5353"></a><span class="cp">#endif</span>
<a id="line-5354" name="line-5354"></a>
<a id="line-5355" name="line-5355"></a><span class="w">  </span><span class="n">buffer_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001A</span><span class="p">);</span>
<a id="line-5356" name="line-5356"></a><span class="w">  </span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001C</span><span class="p">);</span>
<a id="line-5357" name="line-5357"></a>
<a id="line-5358" name="line-5358"></a><span class="w">  </span><span class="n">temp_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_tail</span><span class="p">;</span>
<a id="line-5359" name="line-5359"></a><span class="w">  </span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-5360" name="line-5360"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">buffer_end</span><span class="p">)</span>
<a id="line-5361" name="line-5361"></a><span class="w">    </span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer_start</span><span class="p">;</span>
<a id="line-5362" name="line-5362"></a>
<a id="line-5363" name="line-5363"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_tail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buffer_head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5364" name="line-5364"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5365" name="line-5365"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5366" name="line-5366"></a>
<a id="line-5367" name="line-5367"></a><span class="w">   </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">temp_tail</span><span class="p">,</span><span class="w"> </span><span class="n">ascii_code</span><span class="p">);</span>
<a id="line-5368" name="line-5368"></a><span class="w">   </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">temp_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">scan_code</span><span class="p">);</span>
<a id="line-5369" name="line-5369"></a><span class="w">   </span><span class="n">write_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001C</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_tail</span><span class="p">);</span>
<a id="line-5370" name="line-5370"></a><span class="w">   </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5371" name="line-5371"></a><span class="p">}</span>
<a id="line-5372" name="line-5372"></a>
<a id="line-5373" name="line-5373"></a>
<a id="line-5374" name="line-5374"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5375" name="line-5375"></a><span class="n">int74_function</span><span class="p">(</span><span class="n">make_farcall</span><span class="p">,</span><span class="w"> </span><span class="n">Z</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<a id="line-5376" name="line-5376"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">make_farcall</span><span class="p">,</span><span class="w"> </span><span class="n">Z</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-5377" name="line-5377"></a><span class="p">{</span>
<a id="line-5378" name="line-5378"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-5379" name="line-5379"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">in_byte</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">package_count</span><span class="p">;</span>
<a id="line-5380" name="line-5380"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">mouse_flags_1</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_2</span><span class="p">;</span>
<a id="line-5381" name="line-5381"></a>
<a id="line-5382" name="line-5382"></a><span class="n">BX_DEBUG_INT74</span><span class="p">(</span><span class="s">&quot;entering int74_function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-5383" name="line-5383"></a><span class="w">  </span><span class="n">make_farcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-5384" name="line-5384"></a>
<a id="line-5385" name="line-5385"></a><span class="w">  </span><span class="n">in_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x64</span><span class="p">);</span>
<a id="line-5386" name="line-5386"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">in_byte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x21</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x21</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5387" name="line-5387"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-5388" name="line-5388"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5389" name="line-5389"></a><span class="w">  </span><span class="n">in_byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>
<a id="line-5390" name="line-5390"></a><span class="n">BX_DEBUG_INT74</span><span class="p">(</span><span class="s">&quot;int74: read byte %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">in_byte</span><span class="p">);</span>
<a id="line-5391" name="line-5391"></a>
<a id="line-5392" name="line-5392"></a><span class="w">  </span><span class="n">mouse_flags_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0026</span><span class="p">);</span>
<a id="line-5393" name="line-5393"></a><span class="w">  </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0027</span><span class="p">);</span>
<a id="line-5394" name="line-5394"></a>
<a id="line-5395" name="line-5395"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5396" name="line-5396"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-5397" name="line-5397"></a><span class="w">  </span><span class="p">}</span>
<a id="line-5398" name="line-5398"></a>
<a id="line-5399" name="line-5399"></a><span class="w">  </span><span class="n">package_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">;</span>
<a id="line-5400" name="line-5400"></a><span class="w">  </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_flags_1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">;</span>
<a id="line-5401" name="line-5401"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">in_byte</span><span class="p">);</span>
<a id="line-5402" name="line-5402"></a>
<a id="line-5403" name="line-5403"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">package_count</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5404" name="line-5404"></a><span class="n">BX_DEBUG_INT74</span><span class="p">(</span><span class="s">&quot;int74_function: make_farcall=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-5405" name="line-5405"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0028</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5406" name="line-5406"></a><span class="w">    </span><span class="n">X</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0028</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-5407" name="line-5407"></a><span class="w">    </span><span class="n">Y</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0028</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="line-5408" name="line-5408"></a><span class="w">    </span><span class="n">Z</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-5409" name="line-5409"></a><span class="w">    </span><span class="n">mouse_flags_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-5410" name="line-5410"></a><span class="w">    </span><span class="c1">// check if far call handler installed</span>
<a id="line-5411" name="line-5411"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_flags_2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span>
<a id="line-5412" name="line-5412"></a><span class="w">      </span><span class="n">make_farcall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-5413" name="line-5413"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5414" name="line-5414"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5415" name="line-5415"></a><span class="w">    </span><span class="n">mouse_flags_1</span><span class="o">++</span><span class="p">;</span>
<a id="line-5416" name="line-5416"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5417" name="line-5417"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0026</span><span class="p">,</span><span class="w"> </span><span class="n">mouse_flags_1</span><span class="p">);</span>
<a id="line-5418" name="line-5418"></a><span class="p">}</span>
<a id="line-5419" name="line-5419"></a>
<a id="line-5420" name="line-5420"></a><span class="cp">#define SET_DISK_RET_STATUS(status) write_byte(0x0040, 0x0074, status)</span>
<a id="line-5421" name="line-5421"></a>
<a id="line-5422" name="line-5422"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-5423" name="line-5423"></a>
<a id="line-5424" name="line-5424"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5425" name="line-5425"></a><span class="n">int13_harddisk</span><span class="p">(</span><span class="n">EHAX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-5426" name="line-5426"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">EHAX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-5427" name="line-5427"></a><span class="p">{</span>
<a id="line-5428" name="line-5428"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">;</span>
<a id="line-5429" name="line-5429"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-5430" name="line-5430"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">;</span>
<a id="line-5431" name="line-5431"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-5432" name="line-5432"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">npc</span><span class="p">,</span><span class="w"> </span><span class="n">nph</span><span class="p">,</span><span class="w"> </span><span class="n">npspt</span><span class="p">,</span><span class="w"> </span><span class="n">nlc</span><span class="p">,</span><span class="w"> </span><span class="n">nlh</span><span class="p">,</span><span class="w"> </span><span class="n">nlspt</span><span class="p">;</span>
<a id="line-5433" name="line-5433"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="line-5434" name="line-5434"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-5435" name="line-5435"></a>
<a id="line-5436" name="line-5436"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_harddisk: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-5437" name="line-5437"></a>
<a id="line-5438" name="line-5438"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x008e</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// clear completion flag</span>
<a id="line-5439" name="line-5439"></a>
<a id="line-5440" name="line-5440"></a><span class="w">  </span><span class="c1">// basic check : device has to be defined</span>
<a id="line-5441" name="line-5441"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5442" name="line-5442"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, ELDL out of range %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">());</span>
<a id="line-5443" name="line-5443"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5444" name="line-5444"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5445" name="line-5445"></a>
<a id="line-5446" name="line-5446"></a><span class="w">  </span><span class="c1">// Get the ata channel</span>
<a id="line-5447" name="line-5447"></a><span class="w">  </span><span class="n">device</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdidmap</span><span class="p">[</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="mh">-0x80</span><span class="p">]);</span>
<a id="line-5448" name="line-5448"></a>
<a id="line-5449" name="line-5449"></a><span class="w">  </span><span class="c1">// basic check : device has to be valid</span>
<a id="line-5450" name="line-5450"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5451" name="line-5451"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, unmapped device for ELDL=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">());</span>
<a id="line-5452" name="line-5452"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5453" name="line-5453"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5454" name="line-5454"></a>
<a id="line-5455" name="line-5455"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-5456" name="line-5456"></a>
<a id="line-5457" name="line-5457"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="cm">/* disk controller reset */</span>
<a id="line-5458" name="line-5458"></a><span class="w">      </span><span class="n">ata_reset</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
<a id="line-5459" name="line-5459"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5460" name="line-5460"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5461" name="line-5461"></a>
<a id="line-5462" name="line-5462"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk status */</span>
<a id="line-5463" name="line-5463"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0074</span><span class="p">);</span>
<a id="line-5464" name="line-5464"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<a id="line-5465" name="line-5465"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5466" name="line-5466"></a><span class="w">      </span><span class="cm">/* set CF if error status read */</span>
<a id="line-5467" name="line-5467"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_nostatus</span><span class="p">;</span>
<a id="line-5468" name="line-5468"></a><span class="w">      </span><span class="k">else</span><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-5469" name="line-5469"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5470" name="line-5470"></a>
<a id="line-5471" name="line-5471"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="c1">// read disk sectors</span>
<a id="line-5472" name="line-5472"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="c1">// write disk sectors</span>
<a id="line-5473" name="line-5473"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w"> </span><span class="c1">// verify disk sectors</span>
<a id="line-5474" name="line-5474"></a>
<a id="line-5475" name="line-5475"></a><span class="w">      </span><span class="n">count</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-5476" name="line-5476"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-5477" name="line-5477"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">   </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="n">GET_CL</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x300</span><span class="p">;</span>
<a id="line-5478" name="line-5478"></a><span class="w">      </span><span class="n">sector</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">);</span>
<a id="line-5479" name="line-5479"></a><span class="w">      </span><span class="n">head</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-5480" name="line-5480"></a>
<a id="line-5481" name="line-5481"></a><span class="w">      </span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ES</span><span class="p">;</span>
<a id="line-5482" name="line-5482"></a><span class="w">      </span><span class="n">offset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span>
<a id="line-5483" name="line-5483"></a>
<a id="line-5484" name="line-5484"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-5485" name="line-5485"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, parameter out of range!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5486" name="line-5486"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5487" name="line-5487"></a><span class="w">      </span><span class="p">}</span>
<a id="line-5488" name="line-5488"></a>
<a id="line-5489" name="line-5489"></a><span class="w">      </span><span class="n">nlc</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-5490" name="line-5490"></a><span class="w">      </span><span class="n">nlh</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-5491" name="line-5491"></a><span class="w">      </span><span class="n">nlspt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-5492" name="line-5492"></a>
<a id="line-5493" name="line-5493"></a><span class="w">      </span><span class="c1">// sanity check on cyl heads, sec</span>
<a id="line-5494" name="line-5494"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nlc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nlh</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nlspt</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-5495" name="line-5495"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, parameters out of range %04x/%04x/%04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-5496" name="line-5496"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5497" name="line-5497"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5498" name="line-5498"></a>
<a id="line-5499" name="line-5499"></a><span class="w">      </span><span class="c1">// FIXME verify</span>
<a id="line-5500" name="line-5500"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x04</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5501" name="line-5501"></a>
<a id="line-5502" name="line-5502"></a><span class="w">      </span><span class="n">nph</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-5503" name="line-5503"></a><span class="w">      </span><span class="n">npspt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-5504" name="line-5504"></a>
<a id="line-5505" name="line-5505"></a><span class="w">      </span><span class="c1">// if needed, translate lchs to lba, and execute command</span>
<a id="line-5506" name="line-5506"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">nph</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nlh</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">npspt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nlspt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-5507" name="line-5507"></a><span class="w">        </span><span class="n">lba_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((((</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">cylinder</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">nlh</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">nlspt</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">sector</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-5508" name="line-5508"></a><span class="w">        </span><span class="n">lba_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-5509" name="line-5509"></a><span class="w">        </span><span class="n">sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// this forces the command to be lba</span>
<a id="line-5510" name="line-5510"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5511" name="line-5511"></a>
<a id="line-5512" name="line-5512"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">)</span>
<a id="line-5513" name="line-5513"></a><span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="n">ata_cmd_data_in</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CMD_READ_SECTORS</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="line-5514" name="line-5514"></a><span class="w">      </span><span class="k">else</span>
<a id="line-5515" name="line-5515"></a><span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="n">ata_cmd_data_out</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CMD_WRITE_SECTORS</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="line-5516" name="line-5516"></a>
<a id="line-5517" name="line-5517"></a><span class="w">      </span><span class="c1">// Set nb of sector transferred</span>
<a id="line-5518" name="line-5518"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">));</span>
<a id="line-5519" name="line-5519"></a>
<a id="line-5520" name="line-5520"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5521" name="line-5521"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, error %02x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">(),</span><span class="n">status</span><span class="p">);</span>
<a id="line-5522" name="line-5522"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">);</span>
<a id="line-5523" name="line-5523"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5524" name="line-5524"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5525" name="line-5525"></a>
<a id="line-5526" name="line-5526"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5527" name="line-5527"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5528" name="line-5528"></a>
<a id="line-5529" name="line-5529"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="cm">/* format disk track */</span>
<a id="line-5530" name="line-5530"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;format disk track called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-5531" name="line-5531"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5532" name="line-5532"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-5533" name="line-5533"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5534" name="line-5534"></a>
<a id="line-5535" name="line-5535"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x08</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive parameters */</span>
<a id="line-5536" name="line-5536"></a>
<a id="line-5537" name="line-5537"></a><span class="w">      </span><span class="c1">// Get logical geometry from table</span>
<a id="line-5538" name="line-5538"></a><span class="w">      </span><span class="n">nlc</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-5539" name="line-5539"></a><span class="w">      </span><span class="n">nlh</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-5540" name="line-5540"></a><span class="w">      </span><span class="n">nlspt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-5541" name="line-5541"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">hdcount</span><span class="p">);</span>
<a id="line-5542" name="line-5542"></a>
<a id="line-5543" name="line-5543"></a><span class="w">      </span><span class="n">nlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 0 based , last sector not used */</span>
<a id="line-5544" name="line-5544"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5545" name="line-5545"></a><span class="w">      </span><span class="n">SET_CH</span><span class="p">(</span><span class="n">nlc</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-5546" name="line-5546"></a><span class="w">      </span><span class="n">SET_CL</span><span class="p">(((</span><span class="n">nlc</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">nlspt</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">));</span>
<a id="line-5547" name="line-5547"></a><span class="w">      </span><span class="n">SET_DH</span><span class="p">(</span><span class="n">nlh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-5548" name="line-5548"></a><span class="w">      </span><span class="n">SET_DL</span><span class="p">(</span><span class="n">count</span><span class="p">);</span><span class="w"> </span><span class="cm">/* FIXME returns 0, 1, or n hard drives */</span>
<a id="line-5549" name="line-5549"></a>
<a id="line-5550" name="line-5550"></a><span class="w">      </span><span class="c1">// FIXME should set ES &amp; DI</span>
<a id="line-5551" name="line-5551"></a>
<a id="line-5552" name="line-5552"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5553" name="line-5553"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5554" name="line-5554"></a>
<a id="line-5555" name="line-5555"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x10</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check drive ready */</span>
<a id="line-5556" name="line-5556"></a><span class="w">      </span><span class="c1">// should look at 40:8E also???</span>
<a id="line-5557" name="line-5557"></a>
<a id="line-5558" name="line-5558"></a><span class="w">      </span><span class="c1">// Read the status from controller</span>
<a id="line-5559" name="line-5559"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">device</span><span class="o">/</span><span class="mi">2</span><span class="p">].</span><span class="n">iobase1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_STAT</span><span class="p">);</span>
<a id="line-5560" name="line-5560"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ATA_CB_STAT_BSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ATA_CB_STAT_RDY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5561" name="line-5561"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5562" name="line-5562"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5563" name="line-5563"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5564" name="line-5564"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xAA</span><span class="p">);</span>
<a id="line-5565" name="line-5565"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5566" name="line-5566"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5567" name="line-5567"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5568" name="line-5568"></a>
<a id="line-5569" name="line-5569"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x15</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive size */</span>
<a id="line-5570" name="line-5570"></a>
<a id="line-5571" name="line-5571"></a><span class="w">      </span><span class="c1">// Get logical geometry from table</span>
<a id="line-5572" name="line-5572"></a><span class="w">      </span><span class="n">nlc</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-5573" name="line-5573"></a><span class="w">      </span><span class="n">nlh</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-5574" name="line-5574"></a><span class="w">      </span><span class="n">nlspt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lchs</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-5575" name="line-5575"></a>
<a id="line-5576" name="line-5576"></a><span class="w">      </span><span class="c1">// Compute sector count seen by int13</span>
<a id="line-5577" name="line-5577"></a><span class="w">      </span><span class="n">lba_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)(</span><span class="n">nlc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">nlh</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">nlspt</span><span class="p">;</span>
<a id="line-5578" name="line-5578"></a><span class="w">      </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-5579" name="line-5579"></a><span class="w">      </span><span class="n">DX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-5580" name="line-5580"></a>
<a id="line-5581" name="line-5581"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w">  </span><span class="c1">// hard disk accessible</span>
<a id="line-5582" name="line-5582"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-5583" name="line-5583"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5584" name="line-5584"></a>
<a id="line-5585" name="line-5585"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x41</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS installation check</span>
<a id="line-5586" name="line-5586"></a><span class="w">      </span><span class="n">BX</span><span class="o">=</span><span class="mh">0xaa55</span><span class="p">;</span><span class="w">     </span><span class="c1">// install check</span>
<a id="line-5587" name="line-5587"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span><span class="w">  </span><span class="c1">// EDD 3.0</span>
<a id="line-5588" name="line-5588"></a><span class="w">      </span><span class="n">CX</span><span class="o">=</span><span class="mh">0x0007</span><span class="p">;</span><span class="w">     </span><span class="c1">// ext disk access and edd, removable supported</span>
<a id="line-5589" name="line-5589"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-5590" name="line-5590"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5591" name="line-5591"></a>
<a id="line-5592" name="line-5592"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x42</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended read</span>
<a id="line-5593" name="line-5593"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x43</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended write</span>
<a id="line-5594" name="line-5594"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x44</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS verify</span>
<a id="line-5595" name="line-5595"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x47</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended seek</span>
<a id="line-5596" name="line-5596"></a>
<a id="line-5597" name="line-5597"></a><span class="w">      </span><span class="n">count</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<a id="line-5598" name="line-5598"></a><span class="w">      </span><span class="n">segment</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">);</span>
<a id="line-5599" name="line-5599"></a><span class="w">      </span><span class="n">offset</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<a id="line-5600" name="line-5600"></a>
<a id="line-5601" name="line-5601"></a><span class="w">      </span><span class="c1">// Get 32 msb lba and check</span>
<a id="line-5602" name="line-5602"></a><span class="w">      </span><span class="n">lba_high</span><span class="o">=</span><span class="n">read_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">lba2</span><span class="p">);</span>
<a id="line-5603" name="line-5603"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lba_high</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5604" name="line-5604"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x. LBA out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5605" name="line-5605"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5606" name="line-5606"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5607" name="line-5607"></a>
<a id="line-5608" name="line-5608"></a><span class="w">      </span><span class="c1">// Get 32 lsb lba and check</span>
<a id="line-5609" name="line-5609"></a><span class="w">      </span><span class="n">lba_low</span><span class="o">=</span><span class="n">read_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">lba1</span><span class="p">);</span>
<a id="line-5610" name="line-5610"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lba_high</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">)</span>
<a id="line-5611" name="line-5611"></a><span class="w">          </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lba_low</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5612" name="line-5612"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x. LBA out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5613" name="line-5613"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5614" name="line-5614"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5615" name="line-5615"></a>
<a id="line-5616" name="line-5616"></a><span class="w">      </span><span class="c1">// If verify or seek</span>
<a id="line-5617" name="line-5617"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x44</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x47</span><span class="w"> </span><span class="p">))</span>
<a id="line-5618" name="line-5618"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5619" name="line-5619"></a>
<a id="line-5620" name="line-5620"></a><span class="w">      </span><span class="c1">// Execute the command</span>
<a id="line-5621" name="line-5621"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x42</span><span class="w"> </span><span class="p">)</span>
<a id="line-5622" name="line-5622"></a><span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="n">ata_cmd_data_in</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CMD_READ_SECTORS</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="line-5623" name="line-5623"></a><span class="w">      </span><span class="k">else</span>
<a id="line-5624" name="line-5624"></a><span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="n">ata_cmd_data_out</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_CMD_WRITE_SECTORS</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="line-5625" name="line-5625"></a>
<a id="line-5626" name="line-5626"></a><span class="w">      </span><span class="n">count</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfsectors</span><span class="p">);</span>
<a id="line-5627" name="line-5627"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="line-5628" name="line-5628"></a>
<a id="line-5629" name="line-5629"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5630" name="line-5630"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02x, error %02x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">(),</span><span class="n">status</span><span class="p">);</span>
<a id="line-5631" name="line-5631"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">);</span>
<a id="line-5632" name="line-5632"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5633" name="line-5633"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5634" name="line-5634"></a>
<a id="line-5635" name="line-5635"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5636" name="line-5636"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5637" name="line-5637"></a>
<a id="line-5638" name="line-5638"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x45</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS lock/unlock drive</span>
<a id="line-5639" name="line-5639"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x49</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended media change</span>
<a id="line-5640" name="line-5640"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span><span class="w">    </span><span class="c1">// Always success for HD</span>
<a id="line-5641" name="line-5641"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5642" name="line-5642"></a>
<a id="line-5643" name="line-5643"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x46</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS eject media</span>
<a id="line-5644" name="line-5644"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xb2</span><span class="p">);</span><span class="w">          </span><span class="c1">// Volume Not Removable</span>
<a id="line-5645" name="line-5645"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span><span class="w">  </span><span class="c1">// Always fail for HD</span>
<a id="line-5646" name="line-5646"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5647" name="line-5647"></a>
<a id="line-5648" name="line-5648"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x48</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS get drive parameters</span>
<a id="line-5649" name="line-5649"></a><span class="w">      </span><span class="n">size</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a id="line-5650" name="line-5650"></a>
<a id="line-5651" name="line-5651"></a><span class="w">      </span><span class="c1">// Buffer is too small</span>
<a id="line-5652" name="line-5652"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">)</span>
<a id="line-5653" name="line-5653"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5654" name="line-5654"></a>
<a id="line-5655" name="line-5655"></a><span class="w">      </span><span class="c1">// EDD 1.x</span>
<a id="line-5656" name="line-5656"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5657" name="line-5657"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-5658" name="line-5658"></a>
<a id="line-5659" name="line-5659"></a><span class="w">        </span><span class="n">npc</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-5660" name="line-5660"></a><span class="w">        </span><span class="n">nph</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-5661" name="line-5661"></a><span class="w">        </span><span class="n">npspt</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">pchs</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-5662" name="line-5662"></a><span class="w">        </span><span class="n">lba_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_low</span><span class="p">);</span>
<a id="line-5663" name="line-5663"></a><span class="w">        </span><span class="n">lba_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">sectors_high</span><span class="p">);</span>
<a id="line-5664" name="line-5664"></a><span class="w">        </span><span class="n">blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">);</span>
<a id="line-5665" name="line-5665"></a>
<a id="line-5666" name="line-5666"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">);</span>
<a id="line-5667" name="line-5667"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lba_high</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">lba_low</span><span class="o">/</span><span class="n">npspt</span><span class="p">)</span><span class="o">/</span><span class="n">nph</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0x3fff</span><span class="p">)</span>
<a id="line-5668" name="line-5668"></a><span class="w">        </span><span class="p">{</span>
<a id="line-5669" name="line-5669"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">infos</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// geometry is invalid</span>
<a id="line-5670" name="line-5670"></a><span class="w">          </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3fff</span><span class="p">);</span>
<a id="line-5671" name="line-5671"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5672" name="line-5672"></a><span class="w">        </span><span class="k">else</span>
<a id="line-5673" name="line-5673"></a><span class="w">        </span><span class="p">{</span>
<a id="line-5674" name="line-5674"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">infos</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span><span class="w"> </span><span class="c1">// geometry is valid</span>
<a id="line-5675" name="line-5675"></a><span class="w">          </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">npc</span><span class="p">);</span>
<a id="line-5676" name="line-5676"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5677" name="line-5677"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">nph</span><span class="p">);</span>
<a id="line-5678" name="line-5678"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">npspt</span><span class="p">);</span>
<a id="line-5679" name="line-5679"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">sector_count1</span><span class="p">,</span><span class="w"> </span><span class="n">lba_low</span><span class="p">);</span>
<a id="line-5680" name="line-5680"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">sector_count2</span><span class="p">,</span><span class="w"> </span><span class="n">lba_high</span><span class="p">);</span>
<a id="line-5681" name="line-5681"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">);</span>
<a id="line-5682" name="line-5682"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5683" name="line-5683"></a>
<a id="line-5684" name="line-5684"></a><span class="w">      </span><span class="c1">// EDD 2.x</span>
<a id="line-5685" name="line-5685"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5686" name="line-5686"></a><span class="w">        </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">translation</span><span class="p">;</span>
<a id="line-5687" name="line-5687"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>
<a id="line-5688" name="line-5688"></a>
<a id="line-5689" name="line-5689"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">);</span>
<a id="line-5690" name="line-5690"></a>
<a id="line-5691" name="line-5691"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpte_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ebda_seg</span><span class="p">);</span>
<a id="line-5692" name="line-5692"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpte_offset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">);</span>
<a id="line-5693" name="line-5693"></a>
<a id="line-5694" name="line-5694"></a><span class="w">        </span><span class="c1">// Fill in dpte</span>
<a id="line-5695" name="line-5695"></a><span class="w">        </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-5696" name="line-5696"></a><span class="w">        </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-5697" name="line-5697"></a><span class="w">        </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-5698" name="line-5698"></a><span class="w">        </span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
<a id="line-5699" name="line-5699"></a><span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">);</span>
<a id="line-5700" name="line-5700"></a><span class="w">        </span><span class="n">translation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">translation</span><span class="p">);</span>
<a id="line-5701" name="line-5701"></a>
<a id="line-5702" name="line-5702"></a><span class="w">        </span><span class="n">options</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">translation</span><span class="o">==</span><span class="n">ATA_TRANSLATION_NONE</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="c1">// chs translation</span>
<a id="line-5703" name="line-5703"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// lba translation</span>
<a id="line-5704" name="line-5704"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">ATA_MODE_PIO32</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">;</span>
<a id="line-5705" name="line-5705"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">translation</span><span class="o">==</span><span class="n">ATA_TRANSLATION_LBA</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">;</span>
<a id="line-5706" name="line-5706"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">translation</span><span class="o">==</span><span class="n">ATA_TRANSLATION_RECHS</span><span class="o">?</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">;</span>
<a id="line-5707" name="line-5707"></a>
<a id="line-5708" name="line-5708"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-5709" name="line-5709"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DC</span><span class="p">);</span>
<a id="line-5710" name="line-5710"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mh">0xe</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="w"> </span><span class="p">);</span>
<a id="line-5711" name="line-5711"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">unused</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcb</span><span class="w"> </span><span class="p">);</span>
<a id="line-5712" name="line-5712"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="p">);</span>
<a id="line-5713" name="line-5713"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">blkcount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<a id="line-5714" name="line-5714"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-5715" name="line-5715"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">pio</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-5716" name="line-5716"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<a id="line-5717" name="line-5717"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">reserved</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5718" name="line-5718"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="mh">0x42</span><span class="p">)</span>
<a id="line-5719" name="line-5719"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">);</span>
<a id="line-5720" name="line-5720"></a><span class="w">        </span><span class="k">else</span>
<a id="line-5721" name="line-5721"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-5722" name="line-5722"></a>
<a id="line-5723" name="line-5723"></a><span class="w">        </span><span class="n">checksum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-5724" name="line-5724"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">checksum</span><span class="o">+=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">Bit8u</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="line-5725" name="line-5725"></a><span class="w">        </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">checksum</span><span class="p">;</span>
<a id="line-5726" name="line-5726"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<a id="line-5727" name="line-5727"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5728" name="line-5728"></a>
<a id="line-5729" name="line-5729"></a><span class="w">      </span><span class="c1">// EDD 3.x</span>
<a id="line-5730" name="line-5730"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5731" name="line-5731"></a><span class="w">        </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">iface</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-5732" name="line-5732"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">;</span>
<a id="line-5733" name="line-5733"></a>
<a id="line-5734" name="line-5734"></a><span class="w">        </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-5735" name="line-5735"></a><span class="w">        </span><span class="n">iface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iface</span><span class="p">);</span>
<a id="line-5736" name="line-5736"></a><span class="w">        </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-5737" name="line-5737"></a>
<a id="line-5738" name="line-5738"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">);</span>
<a id="line-5739" name="line-5739"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbedd</span><span class="p">);</span>
<a id="line-5740" name="line-5740"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpi_length</span><span class="p">,</span><span class="w"> </span><span class="mh">0x24</span><span class="p">);</span>
<a id="line-5741" name="line-5741"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5742" name="line-5742"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5743" name="line-5743"></a>
<a id="line-5744" name="line-5744"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iface</span><span class="o">==</span><span class="n">ATA_IFACE_ISA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5745" name="line-5745"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;I&#39;</span><span class="p">);</span>
<a id="line-5746" name="line-5746"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="p">);</span>
<a id="line-5747" name="line-5747"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-5748" name="line-5748"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5749" name="line-5749"></a><span class="w">          </span><span class="p">}</span>
<a id="line-5750" name="line-5750"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5751" name="line-5751"></a><span class="w">          </span><span class="c1">// FIXME PCI</span>
<a id="line-5752" name="line-5752"></a><span class="w">          </span><span class="p">}</span>
<a id="line-5753" name="line-5753"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-5754" name="line-5754"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;T&#39;</span><span class="p">);</span>
<a id="line-5755" name="line-5755"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-5756" name="line-5756"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5757" name="line-5757"></a>
<a id="line-5758" name="line-5758"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iface</span><span class="o">==</span><span class="n">ATA_IFACE_ISA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5759" name="line-5759"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-5760" name="line-5760"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5761" name="line-5761"></a><span class="w">          </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<a id="line-5762" name="line-5762"></a><span class="w">          </span><span class="p">}</span>
<a id="line-5763" name="line-5763"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-5764" name="line-5764"></a><span class="w">          </span><span class="c1">// FIXME PCI</span>
<a id="line-5765" name="line-5765"></a><span class="w">          </span><span class="p">}</span>
<a id="line-5766" name="line-5766"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">device</span><span class="o">%</span><span class="mi">2</span><span class="p">);</span>
<a id="line-5767" name="line-5767"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5768" name="line-5768"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-5769" name="line-5769"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<a id="line-5770" name="line-5770"></a>
<a id="line-5771" name="line-5771"></a><span class="w">        </span><span class="n">checksum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-5772" name="line-5772"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">checksum</span><span class="o">+=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="line-5773" name="line-5773"></a><span class="w">        </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">checksum</span><span class="p">;</span>
<a id="line-5774" name="line-5774"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<a id="line-5775" name="line-5775"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5776" name="line-5776"></a>
<a id="line-5777" name="line-5777"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5778" name="line-5778"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5779" name="line-5779"></a>
<a id="line-5780" name="line-5780"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4e</span><span class="p">:</span><span class="w"> </span><span class="c1">// // IBM/MS set hardware configuration</span>
<a id="line-5781" name="line-5781"></a><span class="w">      </span><span class="c1">// DMA, prefetch, PIO maximum not supported</span>
<a id="line-5782" name="line-5782"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AL</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-5783" name="line-5783"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span>
<a id="line-5784" name="line-5784"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span>
<a id="line-5785" name="line-5785"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span>
<a id="line-5786" name="line-5786"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x06</span><span class="p">:</span>
<a id="line-5787" name="line-5787"></a><span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5788" name="line-5788"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-5789" name="line-5789"></a><span class="w">        </span><span class="k">default</span><span class="w"> </span><span class="o">:</span>
<a id="line-5790" name="line-5790"></a><span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5791" name="line-5791"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5792" name="line-5792"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5793" name="line-5793"></a>
<a id="line-5794" name="line-5794"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x09</span><span class="p">:</span><span class="w"> </span><span class="cm">/* initialize drive parameters */</span>
<a id="line-5795" name="line-5795"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">:</span><span class="w"> </span><span class="cm">/* seek to specified cylinder */</span>
<a id="line-5796" name="line-5796"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* alternate disk reset */</span>
<a id="line-5797" name="line-5797"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x11</span><span class="p">:</span><span class="w"> </span><span class="cm">/* recalibrate */</span>
<a id="line-5798" name="line-5798"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x14</span><span class="p">:</span><span class="w"> </span><span class="cm">/* controller internal diagnostic */</span>
<a id="line-5799" name="line-5799"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02xh unimplemented, returns success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5800" name="line-5800"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5801" name="line-5801"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5802" name="line-5802"></a>
<a id="line-5803" name="line-5803"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk sectors with ECC */</span>
<a id="line-5804" name="line-5804"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors with ECC */</span>
<a id="line-5805" name="line-5805"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x18</span><span class="p">:</span><span class="w"> </span><span class="c1">// set media type for format</span>
<a id="line-5806" name="line-5806"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x50</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS send packet command</span>
<a id="line-5807" name="line-5807"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-5808" name="line-5808"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: function %02xh unsupported, returns fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5809" name="line-5809"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5810" name="line-5810"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5811" name="line-5811"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5812" name="line-5812"></a>
<a id="line-5813" name="line-5813"></a><span class="nl">int13_fail</span><span class="p">:</span>
<a id="line-5814" name="line-5814"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// defaults to invalid function in AH or invalid parameter</span>
<a id="line-5815" name="line-5815"></a><span class="nl">int13_fail_noah</span><span class="p">:</span>
<a id="line-5816" name="line-5816"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5817" name="line-5817"></a><span class="nl">int13_fail_nostatus</span><span class="p">:</span>
<a id="line-5818" name="line-5818"></a><span class="w">    </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">     </span><span class="c1">// error occurred</span>
<a id="line-5819" name="line-5819"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-5820" name="line-5820"></a>
<a id="line-5821" name="line-5821"></a><span class="nl">int13_success</span><span class="p">:</span>
<a id="line-5822" name="line-5822"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// no error</span>
<a id="line-5823" name="line-5823"></a><span class="nl">int13_success_noah</span><span class="p">:</span>
<a id="line-5824" name="line-5824"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-5825" name="line-5825"></a><span class="w">    </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// no error</span>
<a id="line-5826" name="line-5826"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-5827" name="line-5827"></a><span class="p">}</span>
<a id="line-5828" name="line-5828"></a>
<a id="line-5829" name="line-5829"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-5830" name="line-5830"></a><span class="c1">// Start of int13 for cdrom</span>
<a id="line-5831" name="line-5831"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-5832" name="line-5832"></a>
<a id="line-5833" name="line-5833"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-5834" name="line-5834"></a><span class="n">int13_cdrom</span><span class="p">(</span><span class="n">EHBX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-5835" name="line-5835"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">EHBX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-5836" name="line-5836"></a><span class="p">{</span>
<a id="line-5837" name="line-5837"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-5838" name="line-5838"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">locks</span><span class="p">;</span>
<a id="line-5839" name="line-5839"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<a id="line-5840" name="line-5840"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">lba</span><span class="p">;</span>
<a id="line-5841" name="line-5841"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="line-5842" name="line-5842"></a>
<a id="line-5843" name="line-5843"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_CD</span><span class="p">(</span><span class="s">&quot;int13_cdrom: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-5844" name="line-5844"></a>
<a id="line-5845" name="line-5845"></a><span class="w">  </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-5846" name="line-5846"></a>
<a id="line-5847" name="line-5847"></a><span class="w">  </span><span class="cm">/* basic check : device should be 0xE0+ */</span>
<a id="line-5848" name="line-5848"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0xE0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0xE0</span><span class="o">+</span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5849" name="line-5849"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdrom: function %02x, ELDL out of range %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">());</span>
<a id="line-5850" name="line-5850"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5851" name="line-5851"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5852" name="line-5852"></a>
<a id="line-5853" name="line-5853"></a><span class="w">  </span><span class="c1">// Get the ata channel</span>
<a id="line-5854" name="line-5854"></a><span class="w">  </span><span class="n">device</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">cdidmap</span><span class="p">[</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="mh">-0xE0</span><span class="p">]);</span>
<a id="line-5855" name="line-5855"></a>
<a id="line-5856" name="line-5856"></a><span class="w">  </span><span class="cm">/* basic check : device has to be valid  */</span>
<a id="line-5857" name="line-5857"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BX_MAX_ATA_DEVICES</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5858" name="line-5858"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdrom: function %02x, unmapped device for ELDL=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">());</span>
<a id="line-5859" name="line-5859"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5860" name="line-5860"></a><span class="w">    </span><span class="p">}</span>
<a id="line-5861" name="line-5861"></a>
<a id="line-5862" name="line-5862"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-5863" name="line-5863"></a>
<a id="line-5864" name="line-5864"></a><span class="w">    </span><span class="c1">// all those functions return SUCCESS</span>
<a id="line-5865" name="line-5865"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="cm">/* disk controller reset */</span>
<a id="line-5866" name="line-5866"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x09</span><span class="p">:</span><span class="w"> </span><span class="cm">/* initialize drive parameters */</span>
<a id="line-5867" name="line-5867"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">:</span><span class="w"> </span><span class="cm">/* seek to specified cylinder */</span>
<a id="line-5868" name="line-5868"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* alternate disk reset */</span>
<a id="line-5869" name="line-5869"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x10</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check drive ready */</span>
<a id="line-5870" name="line-5870"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x11</span><span class="p">:</span><span class="w"> </span><span class="cm">/* recalibrate */</span>
<a id="line-5871" name="line-5871"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x14</span><span class="p">:</span><span class="w"> </span><span class="cm">/* controller internal diagnostic */</span>
<a id="line-5872" name="line-5872"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x16</span><span class="p">:</span><span class="w"> </span><span class="cm">/* detect disk change */</span>
<a id="line-5873" name="line-5873"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5874" name="line-5874"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5875" name="line-5875"></a>
<a id="line-5876" name="line-5876"></a><span class="w">    </span><span class="c1">// all those functions return disk write-protected</span>
<a id="line-5877" name="line-5877"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors */</span>
<a id="line-5878" name="line-5878"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="cm">/* format disk track */</span>
<a id="line-5879" name="line-5879"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x43</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended write</span>
<a id="line-5880" name="line-5880"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span>
<a id="line-5881" name="line-5881"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5882" name="line-5882"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5883" name="line-5883"></a>
<a id="line-5884" name="line-5884"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk status */</span>
<a id="line-5885" name="line-5885"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0074</span><span class="p">);</span>
<a id="line-5886" name="line-5886"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<a id="line-5887" name="line-5887"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5888" name="line-5888"></a>
<a id="line-5889" name="line-5889"></a><span class="w">      </span><span class="cm">/* set CF if error status read */</span>
<a id="line-5890" name="line-5890"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_nostatus</span><span class="p">;</span>
<a id="line-5891" name="line-5891"></a><span class="w">      </span><span class="k">else</span><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-5892" name="line-5892"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5893" name="line-5893"></a>
<a id="line-5894" name="line-5894"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x15</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive size */</span>
<a id="line-5895" name="line-5895"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-5896" name="line-5896"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5897" name="line-5897"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5898" name="line-5898"></a>
<a id="line-5899" name="line-5899"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x41</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS installation check</span>
<a id="line-5900" name="line-5900"></a><span class="w">      </span><span class="n">BX</span><span class="o">=</span><span class="mh">0xaa55</span><span class="p">;</span><span class="w">     </span><span class="c1">// install check</span>
<a id="line-5901" name="line-5901"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span><span class="w">  </span><span class="c1">// EDD 2.1</span>
<a id="line-5902" name="line-5902"></a><span class="w">      </span><span class="n">CX</span><span class="o">=</span><span class="mh">0x0007</span><span class="p">;</span><span class="w">     </span><span class="c1">// ext disk access, removable and edd</span>
<a id="line-5903" name="line-5903"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-5904" name="line-5904"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5905" name="line-5905"></a>
<a id="line-5906" name="line-5906"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x42</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended read</span>
<a id="line-5907" name="line-5907"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x44</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS verify sectors</span>
<a id="line-5908" name="line-5908"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x47</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended seek</span>
<a id="line-5909" name="line-5909"></a>
<a id="line-5910" name="line-5910"></a><span class="w">      </span><span class="n">count</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<a id="line-5911" name="line-5911"></a><span class="w">      </span><span class="n">segment</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">);</span>
<a id="line-5912" name="line-5912"></a><span class="w">      </span><span class="n">offset</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<a id="line-5913" name="line-5913"></a>
<a id="line-5914" name="line-5914"></a><span class="w">      </span><span class="c1">// Can&#39;t use 64 bits lba</span>
<a id="line-5915" name="line-5915"></a><span class="w">      </span><span class="n">lba</span><span class="o">=</span><span class="n">read_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">lba2</span><span class="p">);</span>
<a id="line-5916" name="line-5916"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0L</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5917" name="line-5917"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_cdrom: function %02x. Can&#39;t use 64bits lba</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-5918" name="line-5918"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5919" name="line-5919"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5920" name="line-5920"></a>
<a id="line-5921" name="line-5921"></a><span class="w">      </span><span class="c1">// Get 32 bits lba</span>
<a id="line-5922" name="line-5922"></a><span class="w">      </span><span class="n">lba</span><span class="o">=</span><span class="n">read_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">lba1</span><span class="p">);</span>
<a id="line-5923" name="line-5923"></a>
<a id="line-5924" name="line-5924"></a><span class="w">      </span><span class="c1">// If verify or seek</span>
<a id="line-5925" name="line-5925"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x44</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x47</span><span class="w"> </span><span class="p">))</span>
<a id="line-5926" name="line-5926"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5927" name="line-5927"></a>
<a id="line-5928" name="line-5928"></a><span class="w">      </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-5929" name="line-5929"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x28</span><span class="p">;</span><span class="w">                      </span><span class="c1">// READ command</span>
<a id="line-5930" name="line-5930"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">     </span><span class="c1">// Sectors</span>
<a id="line-5931" name="line-5931"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w">          </span><span class="c1">// Sectors</span>
<a id="line-5932" name="line-5932"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w">  </span><span class="c1">// LBA</span>
<a id="line-5933" name="line-5933"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff0000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-5934" name="line-5934"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-5935" name="line-5935"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">lba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ff</span><span class="p">);</span>
<a id="line-5936" name="line-5936"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="o">*</span><span class="mf">2048L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="n">offset</span><span class="p">);</span>
<a id="line-5937" name="line-5937"></a>
<a id="line-5938" name="line-5938"></a><span class="w">      </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">trsfbytes</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span>
<a id="line-5939" name="line-5939"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<a id="line-5940" name="line-5940"></a>
<a id="line-5941" name="line-5941"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5942" name="line-5942"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdrom: function %02x, status %02x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">(),</span><span class="n">status</span><span class="p">);</span>
<a id="line-5943" name="line-5943"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">);</span>
<a id="line-5944" name="line-5944"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5945" name="line-5945"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5946" name="line-5946"></a>
<a id="line-5947" name="line-5947"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5948" name="line-5948"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5949" name="line-5949"></a>
<a id="line-5950" name="line-5950"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x45</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS lock/unlock drive</span>
<a id="line-5951" name="line-5951"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AL</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-5952" name="line-5952"></a>
<a id="line-5953" name="line-5953"></a><span class="w">      </span><span class="n">locks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
<a id="line-5954" name="line-5954"></a>
<a id="line-5955" name="line-5955"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AL</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-5956" name="line-5956"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="c1">// lock</span>
<a id="line-5957" name="line-5957"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5958" name="line-5958"></a><span class="w">            </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xb4</span><span class="p">);</span>
<a id="line-5959" name="line-5959"></a><span class="w">            </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5960" name="line-5960"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5961" name="line-5961"></a><span class="w">            </span><span class="p">}</span>
<a id="line-5962" name="line-5962"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="o">++</span><span class="n">locks</span><span class="p">);</span>
<a id="line-5963" name="line-5963"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5964" name="line-5964"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-5965" name="line-5965"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="c1">// unlock</span>
<a id="line-5966" name="line-5966"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5967" name="line-5967"></a><span class="w">            </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">);</span>
<a id="line-5968" name="line-5968"></a><span class="w">            </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-5969" name="line-5969"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5970" name="line-5970"></a><span class="w">            </span><span class="p">}</span>
<a id="line-5971" name="line-5971"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="o">--</span><span class="n">locks</span><span class="p">);</span>
<a id="line-5972" name="line-5972"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">locks</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5973" name="line-5973"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-5974" name="line-5974"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="c1">// status</span>
<a id="line-5975" name="line-5975"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">locks</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<a id="line-5976" name="line-5976"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-5977" name="line-5977"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5978" name="line-5978"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-5979" name="line-5979"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-5980" name="line-5980"></a>
<a id="line-5981" name="line-5981"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x46</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS eject media</span>
<a id="line-5982" name="line-5982"></a><span class="w">      </span><span class="n">locks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
<a id="line-5983" name="line-5983"></a>
<a id="line-5984" name="line-5984"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">locks</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-5985" name="line-5985"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xb1</span><span class="p">);</span><span class="w"> </span><span class="c1">// media locked</span>
<a id="line-5986" name="line-5986"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-5987" name="line-5987"></a><span class="w">        </span><span class="p">}</span>
<a id="line-5988" name="line-5988"></a><span class="w">      </span><span class="c1">// FIXME should handle 0x31 no media in device</span>
<a id="line-5989" name="line-5989"></a><span class="w">      </span><span class="c1">// FIXME should handle 0xb5 valid request failed</span>
<a id="line-5990" name="line-5990"></a>
<a id="line-5991" name="line-5991"></a><span class="w">      </span><span class="c1">// Call removable media eject</span>
<a id="line-5992" name="line-5992"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-5993" name="line-5993"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-5994" name="line-5994"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-5995" name="line-5995"></a>
<a id="line-5996" name="line-5996"></a><span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x52</span>
<a id="line-5997" name="line-5997"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="err">#</span><span class="mh">0x15</span>
<a id="line-5998" name="line-5998"></a><span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_cdrom</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">ah</span>
<a id="line-5999" name="line-5999"></a><span class="w">        </span><span class="n">jnc</span><span class="w"> </span><span class="n">int13_cdrom_rme_end</span>
<a id="line-6000" name="line-6000"></a><span class="w">        </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_cdrom</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-6001" name="line-6001"></a><span class="nl">int13_cdrom_rme_end</span><span class="p">:</span>
<a id="line-6002" name="line-6002"></a><span class="w">        </span><span class="n">pop</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6003" name="line-6003"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-6004" name="line-6004"></a>
<a id="line-6005" name="line-6005"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6006" name="line-6006"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xb1</span><span class="p">);</span><span class="w"> </span><span class="c1">// media locked</span>
<a id="line-6007" name="line-6007"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-6008" name="line-6008"></a><span class="w">      </span><span class="p">}</span>
<a id="line-6009" name="line-6009"></a>
<a id="line-6010" name="line-6010"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6011" name="line-6011"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6012" name="line-6012"></a>
<a id="line-6013" name="line-6013"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x48</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS get drive parameters</span>
<a id="line-6014" name="line-6014"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13Ext</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a id="line-6015" name="line-6015"></a>
<a id="line-6016" name="line-6016"></a><span class="w">      </span><span class="c1">// Buffer is too small</span>
<a id="line-6017" name="line-6017"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">)</span>
<a id="line-6018" name="line-6018"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6019" name="line-6019"></a>
<a id="line-6020" name="line-6020"></a><span class="w">      </span><span class="c1">// EDD 1.x</span>
<a id="line-6021" name="line-6021"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6022" name="line-6022"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">;</span>
<a id="line-6023" name="line-6023"></a>
<a id="line-6024" name="line-6024"></a><span class="w">        </span><span class="n">blksize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">blksize</span><span class="p">);</span>
<a id="line-6025" name="line-6025"></a>
<a id="line-6026" name="line-6026"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">);</span>
<a id="line-6027" name="line-6027"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">infos</span><span class="p">,</span><span class="w"> </span><span class="mh">0x74</span><span class="p">);</span><span class="w"> </span><span class="c1">// removable, media change, lockable, max values</span>
<a id="line-6028" name="line-6028"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<a id="line-6029" name="line-6029"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<a id="line-6030" name="line-6030"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<a id="line-6031" name="line-6031"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">sector_count1</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span><span class="w">  </span><span class="c1">// FIXME should be Bit64</span>
<a id="line-6032" name="line-6032"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">sector_count2</span><span class="p">,</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span>
<a id="line-6033" name="line-6033"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">,</span><span class="w"> </span><span class="n">blksize</span><span class="p">);</span>
<a id="line-6034" name="line-6034"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6035" name="line-6035"></a>
<a id="line-6036" name="line-6036"></a><span class="w">      </span><span class="c1">// EDD 2.x</span>
<a id="line-6037" name="line-6037"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6038" name="line-6038"></a><span class="w">        </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-6039" name="line-6039"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>
<a id="line-6040" name="line-6040"></a>
<a id="line-6041" name="line-6041"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">);</span>
<a id="line-6042" name="line-6042"></a>
<a id="line-6043" name="line-6043"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpte_segment</span><span class="p">,</span><span class="w"> </span><span class="n">ebda_seg</span><span class="p">);</span>
<a id="line-6044" name="line-6044"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpte_offset</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">);</span>
<a id="line-6045" name="line-6045"></a>
<a id="line-6046" name="line-6046"></a><span class="w">        </span><span class="c1">// Fill in dpte</span>
<a id="line-6047" name="line-6047"></a><span class="w">        </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6048" name="line-6048"></a><span class="w">        </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-6049" name="line-6049"></a><span class="w">        </span><span class="n">iobase2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase2</span><span class="p">);</span>
<a id="line-6050" name="line-6050"></a><span class="w">        </span><span class="n">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
<a id="line-6051" name="line-6051"></a><span class="w">        </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">].</span><span class="n">mode</span><span class="p">);</span>
<a id="line-6052" name="line-6052"></a>
<a id="line-6053" name="line-6053"></a><span class="w">        </span><span class="c1">// FIXME atapi device</span>
<a id="line-6054" name="line-6054"></a><span class="w">        </span><span class="n">options</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// lba translation</span>
<a id="line-6055" name="line-6055"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// removable device</span>
<a id="line-6056" name="line-6056"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span><span class="w"> </span><span class="c1">// atapi device</span>
<a id="line-6057" name="line-6057"></a><span class="w">        </span><span class="n">options</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">ATA_MODE_PIO32</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
<a id="line-6058" name="line-6058"></a>
<a id="line-6059" name="line-6059"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">iobase1</span><span class="p">,</span><span class="w"> </span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-6060" name="line-6060"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">iobase2</span><span class="p">,</span><span class="w"> </span><span class="n">iobase2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ATA_CB_DC</span><span class="p">);</span>
<a id="line-6061" name="line-6061"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mh">0xe</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="w"> </span><span class="p">);</span>
<a id="line-6062" name="line-6062"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">unused</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcb</span><span class="w"> </span><span class="p">);</span>
<a id="line-6063" name="line-6063"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="p">);</span>
<a id="line-6064" name="line-6064"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">blkcount</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>
<a id="line-6065" name="line-6065"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-6066" name="line-6066"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">pio</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-6067" name="line-6067"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<a id="line-6068" name="line-6068"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">reserved</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6069" name="line-6069"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">);</span>
<a id="line-6070" name="line-6070"></a>
<a id="line-6071" name="line-6071"></a><span class="w">        </span><span class="n">checksum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-6072" name="line-6072"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">checksum</span><span class="o">+=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">Bit8u</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="line-6073" name="line-6073"></a><span class="w">        </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">checksum</span><span class="p">;</span>
<a id="line-6074" name="line-6074"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">dpte</span><span class="p">.</span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<a id="line-6075" name="line-6075"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6076" name="line-6076"></a>
<a id="line-6077" name="line-6077"></a><span class="w">      </span><span class="c1">// EDD 3.x</span>
<a id="line-6078" name="line-6078"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">0x42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6079" name="line-6079"></a><span class="w">        </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">iface</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-6080" name="line-6080"></a><span class="w">        </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">iobase1</span><span class="p">;</span>
<a id="line-6081" name="line-6081"></a>
<a id="line-6082" name="line-6082"></a><span class="w">        </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6083" name="line-6083"></a><span class="w">        </span><span class="n">iface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iface</span><span class="p">);</span>
<a id="line-6084" name="line-6084"></a><span class="w">        </span><span class="n">iobase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">ata</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-6085" name="line-6085"></a>
<a id="line-6086" name="line-6086"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">);</span>
<a id="line-6087" name="line-6087"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbedd</span><span class="p">);</span>
<a id="line-6088" name="line-6088"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">dpi_length</span><span class="p">,</span><span class="w"> </span><span class="mh">0x24</span><span class="p">);</span>
<a id="line-6089" name="line-6089"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6090" name="line-6090"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6091" name="line-6091"></a>
<a id="line-6092" name="line-6092"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iface</span><span class="o">==</span><span class="n">ATA_IFACE_ISA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6093" name="line-6093"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;I&#39;</span><span class="p">);</span>
<a id="line-6094" name="line-6094"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="p">);</span>
<a id="line-6095" name="line-6095"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-6096" name="line-6096"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">host_bus</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6097" name="line-6097"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6098" name="line-6098"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6099" name="line-6099"></a><span class="w">          </span><span class="c1">// FIXME PCI</span>
<a id="line-6100" name="line-6100"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6101" name="line-6101"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-6102" name="line-6102"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;T&#39;</span><span class="p">);</span>
<a id="line-6103" name="line-6103"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">);</span>
<a id="line-6104" name="line-6104"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6105" name="line-6105"></a>
<a id="line-6106" name="line-6106"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iface</span><span class="o">==</span><span class="n">ATA_IFACE_ISA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6107" name="line-6107"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">iobase1</span><span class="p">);</span>
<a id="line-6108" name="line-6108"></a><span class="w">          </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6109" name="line-6109"></a><span class="w">          </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">iface_path</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<a id="line-6110" name="line-6110"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6111" name="line-6111"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6112" name="line-6112"></a><span class="w">          </span><span class="c1">// FIXME PCI</span>
<a id="line-6113" name="line-6113"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6114" name="line-6114"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">device</span><span class="o">%</span><span class="mi">2</span><span class="p">);</span>
<a id="line-6115" name="line-6115"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6116" name="line-6116"></a><span class="w">        </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-6117" name="line-6117"></a><span class="w">        </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">device_path</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="mf">0L</span><span class="p">);</span>
<a id="line-6118" name="line-6118"></a>
<a id="line-6119" name="line-6119"></a><span class="w">        </span><span class="n">checksum</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a id="line-6120" name="line-6120"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">checksum</span><span class="o">+=</span><span class="n">read_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="line-6121" name="line-6121"></a><span class="w">        </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">checksum</span><span class="p">;</span>
<a id="line-6122" name="line-6122"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="o">+</span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Int13DPT</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">);</span>
<a id="line-6123" name="line-6123"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6124" name="line-6124"></a>
<a id="line-6125" name="line-6125"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6126" name="line-6126"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6127" name="line-6127"></a>
<a id="line-6128" name="line-6128"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x49</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended media change</span>
<a id="line-6129" name="line-6129"></a><span class="w">      </span><span class="c1">// always send changed ??</span>
<a id="line-6130" name="line-6130"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mo">06</span><span class="p">);</span>
<a id="line-6131" name="line-6131"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_nostatus</span><span class="p">;</span>
<a id="line-6132" name="line-6132"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6133" name="line-6133"></a>
<a id="line-6134" name="line-6134"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4e</span><span class="p">:</span><span class="w"> </span><span class="c1">// // IBM/MS set hardware configuration</span>
<a id="line-6135" name="line-6135"></a><span class="w">      </span><span class="c1">// DMA, prefetch, PIO maximum not supported</span>
<a id="line-6136" name="line-6136"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AL</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-6137" name="line-6137"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span>
<a id="line-6138" name="line-6138"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span>
<a id="line-6139" name="line-6139"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span>
<a id="line-6140" name="line-6140"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x06</span><span class="p">:</span>
<a id="line-6141" name="line-6141"></a><span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6142" name="line-6142"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-6143" name="line-6143"></a><span class="w">        </span><span class="k">default</span><span class="w"> </span><span class="o">:</span>
<a id="line-6144" name="line-6144"></a><span class="w">          </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6145" name="line-6145"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6146" name="line-6146"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6147" name="line-6147"></a>
<a id="line-6148" name="line-6148"></a><span class="w">    </span><span class="c1">// all those functions return unimplemented</span>
<a id="line-6149" name="line-6149"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read sectors */</span>
<a id="line-6150" name="line-6150"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w"> </span><span class="cm">/* verify sectors */</span>
<a id="line-6151" name="line-6151"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x08</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive parameters */</span>
<a id="line-6152" name="line-6152"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk sectors with ECC */</span>
<a id="line-6153" name="line-6153"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors with ECC */</span>
<a id="line-6154" name="line-6154"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x18</span><span class="p">:</span><span class="w"> </span><span class="cm">/* set media type for format */</span>
<a id="line-6155" name="line-6155"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x50</span><span class="p">:</span><span class="w"> </span><span class="c1">// ? - send packet command</span>
<a id="line-6156" name="line-6156"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-6157" name="line-6157"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdrom: unsupported AH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6158" name="line-6158"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6159" name="line-6159"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6160" name="line-6160"></a><span class="w">    </span><span class="p">}</span>
<a id="line-6161" name="line-6161"></a>
<a id="line-6162" name="line-6162"></a><span class="nl">int13_fail</span><span class="p">:</span>
<a id="line-6163" name="line-6163"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// defaults to invalid function in AH or invalid parameter</span>
<a id="line-6164" name="line-6164"></a><span class="nl">int13_fail_noah</span><span class="p">:</span>
<a id="line-6165" name="line-6165"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6166" name="line-6166"></a><span class="nl">int13_fail_nostatus</span><span class="p">:</span>
<a id="line-6167" name="line-6167"></a><span class="w">    </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">     </span><span class="c1">// error occurred</span>
<a id="line-6168" name="line-6168"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6169" name="line-6169"></a>
<a id="line-6170" name="line-6170"></a><span class="nl">int13_success</span><span class="p">:</span>
<a id="line-6171" name="line-6171"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// no error</span>
<a id="line-6172" name="line-6172"></a><span class="nl">int13_success_noah</span><span class="p">:</span>
<a id="line-6173" name="line-6173"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-6174" name="line-6174"></a><span class="w">    </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// no error</span>
<a id="line-6175" name="line-6175"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6176" name="line-6176"></a><span class="p">}</span>
<a id="line-6177" name="line-6177"></a>
<a id="line-6178" name="line-6178"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6179" name="line-6179"></a><span class="c1">// End of int13 for cdrom</span>
<a id="line-6180" name="line-6180"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6181" name="line-6181"></a>
<a id="line-6182" name="line-6182"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-6183" name="line-6183"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6184" name="line-6184"></a><span class="c1">// Start of int13 for eltorito functions</span>
<a id="line-6185" name="line-6185"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6186" name="line-6186"></a>
<a id="line-6187" name="line-6187"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-6188" name="line-6188"></a><span class="n">int13_eltorito</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-6189" name="line-6189"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-6190" name="line-6190"></a><span class="p">{</span>
<a id="line-6191" name="line-6191"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-6192" name="line-6192"></a>
<a id="line-6193" name="line-6193"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_ET</span><span class="p">(</span><span class="s">&quot;int13_eltorito: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-6194" name="line-6194"></a><span class="w">  </span><span class="c1">// BX_DEBUG_INT13_ET(&quot;int13_eltorito: SS=%04x DS=%04x ES=%04x DI=%04x SI=%04x\n&quot;,get_SS(), DS, ES, DI, SI);</span>
<a id="line-6195" name="line-6195"></a>
<a id="line-6196" name="line-6196"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-6197" name="line-6197"></a>
<a id="line-6198" name="line-6198"></a><span class="w">    </span><span class="c1">// FIXME ElTorito Various. Should be implemented</span>
<a id="line-6199" name="line-6199"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4a</span><span class="p">:</span><span class="w"> </span><span class="c1">// ElTorito - Initiate disk emu</span>
<a id="line-6200" name="line-6200"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">:</span><span class="w"> </span><span class="c1">// ElTorito - Initiate disk emu and boot</span>
<a id="line-6201" name="line-6201"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">:</span><span class="w"> </span><span class="c1">// ElTorito - Return Boot catalog</span>
<a id="line-6202" name="line-6202"></a><span class="w">      </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;Int13 eltorito call with AX=%04x. Please report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">AX</span><span class="p">);</span>
<a id="line-6203" name="line-6203"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6204" name="line-6204"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6205" name="line-6205"></a>
<a id="line-6206" name="line-6206"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4b</span><span class="p">:</span><span class="w"> </span><span class="c1">// ElTorito - Terminate disk emu</span>
<a id="line-6207" name="line-6207"></a><span class="w">      </span><span class="c1">// FIXME ElTorito Hardcoded</span>
<a id="line-6208" name="line-6208"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x13</span><span class="p">);</span>
<a id="line-6209" name="line-6209"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x01</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">));</span>
<a id="line-6210" name="line-6210"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x02</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="p">));</span>
<a id="line-6211" name="line-6211"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x03</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">controller_index</span><span class="p">));</span>
<a id="line-6212" name="line-6212"></a><span class="w">      </span><span class="n">write_dword</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x04</span><span class="p">,</span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">ilba</span><span class="p">));</span>
<a id="line-6213" name="line-6213"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x08</span><span class="p">,</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">device_spec</span><span class="p">));</span>
<a id="line-6214" name="line-6214"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x0a</span><span class="p">,</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">buffer_segment</span><span class="p">));</span>
<a id="line-6215" name="line-6215"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x0c</span><span class="p">,</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">load_segment</span><span class="p">));</span>
<a id="line-6216" name="line-6216"></a><span class="w">      </span><span class="n">write_word</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x0e</span><span class="p">,</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">sector_count</span><span class="p">));</span>
<a id="line-6217" name="line-6217"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">));</span>
<a id="line-6218" name="line-6218"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x11</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">));</span>
<a id="line-6219" name="line-6219"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="n">SI</span><span class="o">+</span><span class="mh">0x12</span><span class="p">,</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">));</span>
<a id="line-6220" name="line-6220"></a>
<a id="line-6221" name="line-6221"></a><span class="w">      </span><span class="c1">// If we have to terminate emulation</span>
<a id="line-6222" name="line-6222"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">GET_AL</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6223" name="line-6223"></a><span class="w">        </span><span class="c1">// FIXME ElTorito Various. Should be handled accordingly to spec</span>
<a id="line-6224" name="line-6224"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// bye bye</span>
<a id="line-6225" name="line-6225"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6226" name="line-6226"></a>
<a id="line-6227" name="line-6227"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6228" name="line-6228"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6229" name="line-6229"></a>
<a id="line-6230" name="line-6230"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-6231" name="line-6231"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_eltorito: unsupported AH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6232" name="line-6232"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6233" name="line-6233"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6234" name="line-6234"></a><span class="w">    </span><span class="p">}</span>
<a id="line-6235" name="line-6235"></a>
<a id="line-6236" name="line-6236"></a><span class="nl">int13_fail</span><span class="p">:</span>
<a id="line-6237" name="line-6237"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// defaults to invalid function in AH or invalid parameter</span>
<a id="line-6238" name="line-6238"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6239" name="line-6239"></a><span class="w">    </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">     </span><span class="c1">// error occurred</span>
<a id="line-6240" name="line-6240"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6241" name="line-6241"></a>
<a id="line-6242" name="line-6242"></a><span class="nl">int13_success</span><span class="p">:</span>
<a id="line-6243" name="line-6243"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// no error</span>
<a id="line-6244" name="line-6244"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-6245" name="line-6245"></a><span class="w">    </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// no error</span>
<a id="line-6246" name="line-6246"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6247" name="line-6247"></a><span class="p">}</span>
<a id="line-6248" name="line-6248"></a>
<a id="line-6249" name="line-6249"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6250" name="line-6250"></a><span class="c1">// End of int13 for eltorito functions</span>
<a id="line-6251" name="line-6251"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6252" name="line-6252"></a>
<a id="line-6253" name="line-6253"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6254" name="line-6254"></a><span class="c1">// Start of int13 when emulating a device from the cd</span>
<a id="line-6255" name="line-6255"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6256" name="line-6256"></a>
<a id="line-6257" name="line-6257"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-6258" name="line-6258"></a><span class="n">int13_cdemu</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-6259" name="line-6259"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">SP</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-6260" name="line-6260"></a><span class="p">{</span>
<a id="line-6261" name="line-6261"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-6262" name="line-6262"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-6263" name="line-6263"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">vheads</span><span class="p">,</span><span class="w"> </span><span class="n">vspt</span><span class="p">,</span><span class="w"> </span><span class="n">vcylinders</span><span class="p">;</span>
<a id="line-6264" name="line-6264"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">nbsectors</span><span class="p">;</span>
<a id="line-6265" name="line-6265"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">vlba</span><span class="p">,</span><span class="w"> </span><span class="n">ilba</span><span class="p">,</span><span class="w"> </span><span class="n">slba</span><span class="p">,</span><span class="w"> </span><span class="n">elba</span><span class="p">;</span>
<a id="line-6266" name="line-6266"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">before</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-6267" name="line-6267"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<a id="line-6268" name="line-6268"></a>
<a id="line-6269" name="line-6269"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_ET</span><span class="p">(</span><span class="s">&quot;int13_cdemu: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-6270" name="line-6270"></a>
<a id="line-6271" name="line-6271"></a><span class="w">  </span><span class="cm">/* at this point, we are emulating a floppy/harddisk */</span>
<a id="line-6272" name="line-6272"></a>
<a id="line-6273" name="line-6273"></a><span class="w">  </span><span class="c1">// Recompute the device number</span>
<a id="line-6274" name="line-6274"></a><span class="w">  </span><span class="n">device</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">controller_index</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6275" name="line-6275"></a><span class="w">  </span><span class="n">device</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">device_spec</span><span class="p">);</span>
<a id="line-6276" name="line-6276"></a>
<a id="line-6277" name="line-6277"></a><span class="w">  </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-6278" name="line-6278"></a>
<a id="line-6279" name="line-6279"></a><span class="w">  </span><span class="cm">/* basic checks : emulation should be active, dl should equal the emulated drive */</span>
<a id="line-6280" name="line-6280"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">active</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="line-6281" name="line-6281"></a><span class="w">   </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">emulated_drive</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">GET_DL</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="line-6282" name="line-6282"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdemu: function %02x, emulation not active for DL= %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">(),</span><span class="w"> </span><span class="n">GET_DL</span><span class="p">());</span>
<a id="line-6283" name="line-6283"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6284" name="line-6284"></a><span class="w">    </span><span class="p">}</span>
<a id="line-6285" name="line-6285"></a>
<a id="line-6286" name="line-6286"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-6287" name="line-6287"></a>
<a id="line-6288" name="line-6288"></a><span class="w">    </span><span class="c1">// all those functions return SUCCESS</span>
<a id="line-6289" name="line-6289"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="cm">/* disk controller reset */</span>
<a id="line-6290" name="line-6290"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x09</span><span class="p">:</span><span class="w"> </span><span class="cm">/* initialize drive parameters */</span>
<a id="line-6291" name="line-6291"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">:</span><span class="w"> </span><span class="cm">/* seek to specified cylinder */</span>
<a id="line-6292" name="line-6292"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* alternate disk reset */</span><span class="w">  </span><span class="c1">// FIXME ElTorito Various. should really reset ?</span>
<a id="line-6293" name="line-6293"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x10</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check drive ready */</span><span class="w">     </span><span class="c1">// FIXME ElTorito Various. should check if ready ?</span>
<a id="line-6294" name="line-6294"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x11</span><span class="p">:</span><span class="w"> </span><span class="cm">/* recalibrate */</span>
<a id="line-6295" name="line-6295"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x14</span><span class="p">:</span><span class="w"> </span><span class="cm">/* controller internal diagnostic */</span>
<a id="line-6296" name="line-6296"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x16</span><span class="p">:</span><span class="w"> </span><span class="cm">/* detect disk change */</span>
<a id="line-6297" name="line-6297"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6298" name="line-6298"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6299" name="line-6299"></a>
<a id="line-6300" name="line-6300"></a><span class="w">    </span><span class="c1">// all those functions return disk write-protected</span>
<a id="line-6301" name="line-6301"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors */</span>
<a id="line-6302" name="line-6302"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="cm">/* format disk track */</span>
<a id="line-6303" name="line-6303"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span>
<a id="line-6304" name="line-6304"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-6305" name="line-6305"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6306" name="line-6306"></a>
<a id="line-6307" name="line-6307"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk status */</span>
<a id="line-6308" name="line-6308"></a><span class="w">      </span><span class="n">status</span><span class="o">=</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0074</span><span class="p">);</span>
<a id="line-6309" name="line-6309"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<a id="line-6310" name="line-6310"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6311" name="line-6311"></a>
<a id="line-6312" name="line-6312"></a><span class="w">      </span><span class="cm">/* set CF if error status read */</span>
<a id="line-6313" name="line-6313"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_nostatus</span><span class="p">;</span>
<a id="line-6314" name="line-6314"></a><span class="w">      </span><span class="k">else</span><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-6315" name="line-6315"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6316" name="line-6316"></a>
<a id="line-6317" name="line-6317"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="c1">// read disk sectors</span>
<a id="line-6318" name="line-6318"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w"> </span><span class="c1">// verify disk sectors</span>
<a id="line-6319" name="line-6319"></a><span class="w">      </span><span class="n">vspt</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-6320" name="line-6320"></a><span class="w">      </span><span class="n">vcylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-6321" name="line-6321"></a><span class="w">      </span><span class="n">vheads</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">);</span>
<a id="line-6322" name="line-6322"></a>
<a id="line-6323" name="line-6323"></a><span class="w">      </span><span class="n">ilba</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">ilba</span><span class="p">);</span>
<a id="line-6324" name="line-6324"></a>
<a id="line-6325" name="line-6325"></a><span class="w">      </span><span class="n">sector</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x003f</span><span class="p">;</span>
<a id="line-6326" name="line-6326"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00c0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-6327" name="line-6327"></a><span class="w">      </span><span class="n">head</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-6328" name="line-6328"></a><span class="w">      </span><span class="n">nbsectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-6329" name="line-6329"></a><span class="w">      </span><span class="n">segment</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ES</span><span class="p">;</span>
<a id="line-6330" name="line-6330"></a><span class="w">      </span><span class="n">offset</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span>
<a id="line-6331" name="line-6331"></a>
<a id="line-6332" name="line-6332"></a><span class="w">      </span><span class="c1">// no sector to read ?</span>
<a id="line-6333" name="line-6333"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">nbsectors</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6334" name="line-6334"></a>
<a id="line-6335" name="line-6335"></a><span class="w">      </span><span class="c1">// sanity checks sco openserver needs this!</span>
<a id="line-6336" name="line-6336"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sector</span><span class="w">   </span><span class="o">&gt;</span><span class="w">  </span><span class="n">vspt</span><span class="p">)</span>
<a id="line-6337" name="line-6337"></a><span class="w">       </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">vcylinders</span><span class="p">)</span>
<a id="line-6338" name="line-6338"></a><span class="w">       </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w">     </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">vheads</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-6339" name="line-6339"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6340" name="line-6340"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6341" name="line-6341"></a>
<a id="line-6342" name="line-6342"></a><span class="w">      </span><span class="c1">// After controls, verify do nothing</span>
<a id="line-6343" name="line-6343"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6344" name="line-6344"></a>
<a id="line-6345" name="line-6345"></a><span class="w">      </span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ES</span><span class="o">+</span><span class="p">(</span><span class="n">BX</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="line-6346" name="line-6346"></a><span class="w">      </span><span class="n">offset</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">BX</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-6347" name="line-6347"></a>
<a id="line-6348" name="line-6348"></a><span class="w">      </span><span class="c1">// calculate the virtual lba inside the image</span>
<a id="line-6349" name="line-6349"></a><span class="w">      </span><span class="n">vlba</span><span class="o">=</span><span class="p">((((</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">cylinder</span><span class="o">*</span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">vheads</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">head</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">vspt</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)(</span><span class="n">sector</span><span class="mi">-1</span><span class="p">));</span>
<a id="line-6350" name="line-6350"></a>
<a id="line-6351" name="line-6351"></a><span class="w">      </span><span class="c1">// In advance so we don&#39;t loose the count</span>
<a id="line-6352" name="line-6352"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">nbsectors</span><span class="p">);</span>
<a id="line-6353" name="line-6353"></a>
<a id="line-6354" name="line-6354"></a><span class="w">      </span><span class="c1">// start lba on cd</span>
<a id="line-6355" name="line-6355"></a><span class="w">      </span><span class="n">slba</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">vlba</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<a id="line-6356" name="line-6356"></a><span class="w">      </span><span class="n">before</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit16u</span><span class="p">)</span><span class="n">vlba</span><span class="o">%</span><span class="mi">4</span><span class="p">;</span>
<a id="line-6357" name="line-6357"></a>
<a id="line-6358" name="line-6358"></a><span class="w">      </span><span class="c1">// end lba on cd</span>
<a id="line-6359" name="line-6359"></a><span class="w">      </span><span class="n">elba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)(</span><span class="n">vlba</span><span class="o">+</span><span class="n">nbsectors</span><span class="mi">-1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<a id="line-6360" name="line-6360"></a>
<a id="line-6361" name="line-6361"></a><span class="w">      </span><span class="n">memsetb</span><span class="p">(</span><span class="n">get_SS</span><span class="p">(),</span><span class="n">atacmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
<a id="line-6362" name="line-6362"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mh">0x28</span><span class="p">;</span><span class="w">                      </span><span class="c1">// READ command</span>
<a id="line-6363" name="line-6363"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">elba</span><span class="o">-</span><span class="n">slba</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="c1">// Sectors</span>
<a id="line-6364" name="line-6364"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)(</span><span class="n">elba</span><span class="o">-</span><span class="n">slba</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span><span class="w">      </span><span class="c1">// Sectors</span>
<a id="line-6365" name="line-6365"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ilba</span><span class="o">+</span><span class="n">slba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span><span class="w">  </span><span class="c1">// LBA</span>
<a id="line-6366" name="line-6366"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ilba</span><span class="o">+</span><span class="n">slba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff0000</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-6367" name="line-6367"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ilba</span><span class="o">+</span><span class="n">slba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0000ff00</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-6368" name="line-6368"></a><span class="w">      </span><span class="n">atacmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ilba</span><span class="o">+</span><span class="n">slba</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x000000ff</span><span class="p">);</span>
<a id="line-6369" name="line-6369"></a><span class="w">      </span><span class="k">if</span><span class="p">((</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_cmd_packet</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">get_SS</span><span class="p">(),</span><span class="w"> </span><span class="n">atacmd</span><span class="p">,</span><span class="w"> </span><span class="n">before</span><span class="o">*</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="n">nbsectors</span><span class="o">*</span><span class="mf">512L</span><span class="p">,</span><span class="w"> </span><span class="n">ATA_DATA_IN</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="n">offset</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6370" name="line-6370"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdemu: function %02x, error %02x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">GET_AH</span><span class="p">(),</span><span class="n">status</span><span class="p">);</span>
<a id="line-6371" name="line-6371"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-6372" name="line-6372"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6373" name="line-6373"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail_noah</span><span class="p">;</span>
<a id="line-6374" name="line-6374"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6375" name="line-6375"></a>
<a id="line-6376" name="line-6376"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6377" name="line-6377"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6378" name="line-6378"></a>
<a id="line-6379" name="line-6379"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x08</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive parameters */</span>
<a id="line-6380" name="line-6380"></a><span class="w">      </span><span class="n">vspt</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">spt</span><span class="p">);</span>
<a id="line-6381" name="line-6381"></a><span class="w">      </span><span class="n">vcylinders</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">cylinders</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6382" name="line-6382"></a><span class="w">      </span><span class="n">vheads</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">vdevice</span><span class="p">.</span><span class="n">heads</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6383" name="line-6383"></a>
<a id="line-6384" name="line-6384"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="p">);</span>
<a id="line-6385" name="line-6385"></a><span class="w">      </span><span class="n">SET_BL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="p">);</span>
<a id="line-6386" name="line-6386"></a><span class="w">      </span><span class="n">SET_CH</span><span class="p">(</span><span class="w"> </span><span class="n">vcylinders</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="w"> </span><span class="p">);</span>
<a id="line-6387" name="line-6387"></a><span class="w">      </span><span class="n">SET_CL</span><span class="p">(((</span><span class="w"> </span><span class="n">vcylinders</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">vspt</span><span class="w">  </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="w"> </span><span class="p">));</span>
<a id="line-6388" name="line-6388"></a><span class="w">      </span><span class="n">SET_DH</span><span class="p">(</span><span class="w"> </span><span class="n">vheads</span><span class="w"> </span><span class="p">);</span>
<a id="line-6389" name="line-6389"></a><span class="w">      </span><span class="n">SET_DL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">);</span><span class="w">   </span><span class="c1">// FIXME ElTorito Various. should send the real count of drives 1 or 2</span>
<a id="line-6390" name="line-6390"></a><span class="w">                        </span><span class="c1">// FIXME ElTorito Harddisk. should send the HD count</span>
<a id="line-6391" name="line-6391"></a>
<a id="line-6392" name="line-6392"></a><span class="w">      </span><span class="k">switch</span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">media</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-6393" name="line-6393"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="n">SET_BL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-6394" name="line-6394"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="n">SET_BL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x04</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-6395" name="line-6395"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="n">SET_BL</span><span class="p">(</span><span class="w"> </span><span class="mh">0x06</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-6396" name="line-6396"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6397" name="line-6397"></a>
<a id="line-6398" name="line-6398"></a><span class="n">ASM_START</span>
<a id="line-6399" name="line-6399"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6400" name="line-6400"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6401" name="line-6401"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">diskette_param_table2</span>
<a id="line-6402" name="line-6402"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_cdemu</span><span class="p">.</span><span class="n">DI</span><span class="o">+</span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-6403" name="line-6403"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_cdemu</span><span class="p">.</span><span class="n">ES</span><span class="o">+</span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">cs</span>
<a id="line-6404" name="line-6404"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-6405" name="line-6405"></a><span class="n">ASM_END</span>
<a id="line-6406" name="line-6406"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success</span><span class="p">;</span>
<a id="line-6407" name="line-6407"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6408" name="line-6408"></a>
<a id="line-6409" name="line-6409"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x15</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive size */</span>
<a id="line-6410" name="line-6410"></a><span class="w">      </span><span class="c1">// FIXME ElTorito Harddisk. What geometry to send ?</span>
<a id="line-6411" name="line-6411"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span>
<a id="line-6412" name="line-6412"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_success_noah</span><span class="p">;</span>
<a id="line-6413" name="line-6413"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6414" name="line-6414"></a>
<a id="line-6415" name="line-6415"></a><span class="w">    </span><span class="c1">// all those functions return unimplemented</span>
<a id="line-6416" name="line-6416"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk sectors with ECC */</span>
<a id="line-6417" name="line-6417"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors with ECC */</span>
<a id="line-6418" name="line-6418"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x18</span><span class="p">:</span><span class="w"> </span><span class="cm">/* set media type for format */</span>
<a id="line-6419" name="line-6419"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x41</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS installation check</span>
<a id="line-6420" name="line-6420"></a><span class="w">      </span><span class="c1">// FIXME ElTorito Harddisk. Darwin would like to use EDD</span>
<a id="line-6421" name="line-6421"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x42</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended read</span>
<a id="line-6422" name="line-6422"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x43</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended write</span>
<a id="line-6423" name="line-6423"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x44</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS verify sectors</span>
<a id="line-6424" name="line-6424"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x45</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS lock/unlock drive</span>
<a id="line-6425" name="line-6425"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x46</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS eject media</span>
<a id="line-6426" name="line-6426"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x47</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended seek</span>
<a id="line-6427" name="line-6427"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x48</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS get drive parameters</span>
<a id="line-6428" name="line-6428"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x49</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended media change</span>
<a id="line-6429" name="line-6429"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x4e</span><span class="p">:</span><span class="w"> </span><span class="c1">// ? - set hardware configuration</span>
<a id="line-6430" name="line-6430"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x50</span><span class="p">:</span><span class="w"> </span><span class="c1">// ? - send packet command</span>
<a id="line-6431" name="line-6431"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-6432" name="line-6432"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_cdemu function AH=%02x unsupported, returns fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6433" name="line-6433"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">int13_fail</span><span class="p">;</span>
<a id="line-6434" name="line-6434"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6435" name="line-6435"></a><span class="w">    </span><span class="p">}</span>
<a id="line-6436" name="line-6436"></a>
<a id="line-6437" name="line-6437"></a><span class="nl">int13_fail</span><span class="p">:</span>
<a id="line-6438" name="line-6438"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// defaults to invalid function in AH or invalid parameter</span>
<a id="line-6439" name="line-6439"></a><span class="nl">int13_fail_noah</span><span class="p">:</span>
<a id="line-6440" name="line-6440"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-6441" name="line-6441"></a><span class="nl">int13_fail_nostatus</span><span class="p">:</span>
<a id="line-6442" name="line-6442"></a><span class="w">    </span><span class="n">SET_CF</span><span class="p">();</span><span class="w">     </span><span class="c1">// error occurred</span>
<a id="line-6443" name="line-6443"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6444" name="line-6444"></a>
<a id="line-6445" name="line-6445"></a><span class="nl">int13_success</span><span class="p">:</span>
<a id="line-6446" name="line-6446"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// no error</span>
<a id="line-6447" name="line-6447"></a><span class="nl">int13_success_noah</span><span class="p">:</span>
<a id="line-6448" name="line-6448"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
<a id="line-6449" name="line-6449"></a><span class="w">    </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// no error</span>
<a id="line-6450" name="line-6450"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6451" name="line-6451"></a><span class="p">}</span>
<a id="line-6452" name="line-6452"></a>
<a id="line-6453" name="line-6453"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6454" name="line-6454"></a><span class="c1">// End of int13 when emulating a device from the cd</span>
<a id="line-6455" name="line-6455"></a><span class="c1">// ---------------------------------------------------------------------------</span>
<a id="line-6456" name="line-6456"></a>
<a id="line-6457" name="line-6457"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-6458" name="line-6458"></a>
<a id="line-6459" name="line-6459"></a><span class="cp">#else </span><span class="c1">//BX_USE_ATADRV</span>
<a id="line-6460" name="line-6460"></a>
<a id="line-6461" name="line-6461"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-6462" name="line-6462"></a><span class="n">outLBA</span><span class="p">(</span><span class="n">cylinder</span><span class="p">,</span><span class="n">hd_heads</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">hd_sectors</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">dl</span><span class="p">)</span>
<a id="line-6463" name="line-6463"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cylinder</span><span class="p">;</span>
<a id="line-6464" name="line-6464"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">;</span>
<a id="line-6465" name="line-6465"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">head</span><span class="p">;</span>
<a id="line-6466" name="line-6466"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">;</span>
<a id="line-6467" name="line-6467"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">sector</span><span class="p">;</span>
<a id="line-6468" name="line-6468"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">dl</span><span class="p">;</span>
<a id="line-6469" name="line-6469"></a><span class="p">{</span>
<a id="line-6470" name="line-6470"></a><span class="n">ASM_START</span>
<a id="line-6471" name="line-6471"></a><span class="w">        </span><span class="n">push</span><span class="w">   </span><span class="n">bp</span>
<a id="line-6472" name="line-6472"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6473" name="line-6473"></a><span class="w">        </span><span class="n">push</span><span class="w">   </span><span class="n">eax</span>
<a id="line-6474" name="line-6474"></a><span class="w">        </span><span class="n">push</span><span class="w">   </span><span class="n">ebx</span>
<a id="line-6475" name="line-6475"></a><span class="w">        </span><span class="n">push</span><span class="w">   </span><span class="n">edx</span>
<a id="line-6476" name="line-6476"></a><span class="w">        </span><span class="n">xor</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<a id="line-6477" name="line-6477"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">ax</span><span class="p">,</span><span class="mi">4</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w">  </span><span class="c1">// cylinder</span>
<a id="line-6478" name="line-6478"></a><span class="w">        </span><span class="n">xor</span><span class="w">    </span><span class="n">ebx</span><span class="p">,</span><span class="n">ebx</span>
<a id="line-6479" name="line-6479"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="mi">6</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w">  </span><span class="c1">// hd_heads</span>
<a id="line-6480" name="line-6480"></a><span class="w">        </span><span class="n">imul</span><span class="w">   </span><span class="n">ebx</span>
<a id="line-6481" name="line-6481"></a>
<a id="line-6482" name="line-6482"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="mi">8</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w">  </span><span class="c1">// head</span>
<a id="line-6483" name="line-6483"></a><span class="w">        </span><span class="n">add</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span>
<a id="line-6484" name="line-6484"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="mi">10</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="c1">// hd_sectors</span>
<a id="line-6485" name="line-6485"></a><span class="w">        </span><span class="n">imul</span><span class="w">   </span><span class="n">ebx</span>
<a id="line-6486" name="line-6486"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="mi">12</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="c1">// sector</span>
<a id="line-6487" name="line-6487"></a><span class="w">        </span><span class="n">add</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="n">ebx</span>
<a id="line-6488" name="line-6488"></a>
<a id="line-6489" name="line-6489"></a><span class="w">        </span><span class="n">dec</span><span class="w">    </span><span class="n">eax</span>
<a id="line-6490" name="line-6490"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x1f3</span>
<a id="line-6491" name="line-6491"></a><span class="w">        </span><span class="n">out</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-6492" name="line-6492"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x1f4</span>
<a id="line-6493" name="line-6493"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">al</span><span class="p">,</span><span class="n">ah</span>
<a id="line-6494" name="line-6494"></a><span class="w">        </span><span class="n">out</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-6495" name="line-6495"></a><span class="w">        </span><span class="n">shr</span><span class="w">    </span><span class="n">eax</span><span class="p">,</span><span class="err">#</span><span class="mi">16</span>
<a id="line-6496" name="line-6496"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x1f5</span>
<a id="line-6497" name="line-6497"></a><span class="w">        </span><span class="n">out</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-6498" name="line-6498"></a><span class="w">        </span><span class="n">and</span><span class="w">    </span><span class="n">ah</span><span class="p">,</span><span class="err">#</span><span class="mh">0xf</span>
<a id="line-6499" name="line-6499"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="mi">14</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span><span class="w"> </span><span class="c1">// dl</span>
<a id="line-6500" name="line-6500"></a><span class="w">        </span><span class="n">and</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="err">#</span><span class="mi">1</span>
<a id="line-6501" name="line-6501"></a><span class="w">        </span><span class="n">shl</span><span class="w">    </span><span class="n">bl</span><span class="p">,</span><span class="err">#</span><span class="mi">4</span>
<a id="line-6502" name="line-6502"></a><span class="w">        </span><span class="n">or</span><span class="w">     </span><span class="n">ah</span><span class="p">,</span><span class="n">bl</span>
<a id="line-6503" name="line-6503"></a><span class="w">        </span><span class="n">or</span><span class="w">     </span><span class="n">ah</span><span class="p">,</span><span class="err">#</span><span class="mh">0xe0</span>
<a id="line-6504" name="line-6504"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">al</span><span class="p">,</span><span class="n">ah</span>
<a id="line-6505" name="line-6505"></a><span class="w">        </span><span class="n">mov</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x01f6</span>
<a id="line-6506" name="line-6506"></a><span class="w">        </span><span class="n">out</span><span class="w">    </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-6507" name="line-6507"></a><span class="w">        </span><span class="n">pop</span><span class="w">    </span><span class="n">edx</span>
<a id="line-6508" name="line-6508"></a><span class="w">        </span><span class="n">pop</span><span class="w">    </span><span class="n">ebx</span>
<a id="line-6509" name="line-6509"></a><span class="w">        </span><span class="n">pop</span><span class="w">    </span><span class="n">eax</span>
<a id="line-6510" name="line-6510"></a><span class="w">        </span><span class="n">pop</span><span class="w">    </span><span class="n">bp</span>
<a id="line-6511" name="line-6511"></a><span class="n">ASM_END</span>
<a id="line-6512" name="line-6512"></a><span class="p">}</span>
<a id="line-6513" name="line-6513"></a>
<a id="line-6514" name="line-6514"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-6515" name="line-6515"></a><span class="n">int13_harddisk</span><span class="p">(</span><span class="n">EHAX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-6516" name="line-6516"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">EHAX</span><span class="p">,</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-6517" name="line-6517"></a><span class="p">{</span>
<a id="line-6518" name="line-6518"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">    </span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">num_sectors</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">mod</span><span class="p">;</span>
<a id="line-6519" name="line-6519"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">    </span><span class="n">drive_map</span><span class="p">;</span>
<a id="line-6520" name="line-6520"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">    </span><span class="n">n_drives</span><span class="p">;</span>
<a id="line-6521" name="line-6521"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">cyl_mod</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">;</span>
<a id="line-6522" name="line-6522"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">max_cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">total_sectors</span><span class="p">;</span>
<a id="line-6523" name="line-6523"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">hd_cylinders</span><span class="p">;</span>
<a id="line-6524" name="line-6524"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">    </span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">;</span>
<a id="line-6525" name="line-6525"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">val16</span><span class="p">;</span>
<a id="line-6526" name="line-6526"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">    </span><span class="n">sector_count</span><span class="p">;</span>
<a id="line-6527" name="line-6527"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="line-6528" name="line-6528"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">tempbx</span><span class="p">;</span>
<a id="line-6529" name="line-6529"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">dpsize</span><span class="p">;</span>
<a id="line-6530" name="line-6530"></a>
<a id="line-6531" name="line-6531"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-6532" name="line-6532"></a><span class="w">  </span><span class="n">Bit32u</span><span class="w">   </span><span class="n">lba</span><span class="p">;</span>
<a id="line-6533" name="line-6533"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">   </span><span class="n">error</span><span class="p">;</span>
<a id="line-6534" name="line-6534"></a>
<a id="line-6535" name="line-6535"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13 harddisk: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-6536" name="line-6536"></a>
<a id="line-6537" name="line-6537"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x008e</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// clear completion flag</span>
<a id="line-6538" name="line-6538"></a>
<a id="line-6539" name="line-6539"></a><span class="w">  </span><span class="cm">/* at this point, DL is &gt;= 0x80 to be passed from the floppy int13h</span>
<a id="line-6540" name="line-6540"></a><span class="cm">     handler code */</span>
<a id="line-6541" name="line-6541"></a><span class="w">  </span><span class="cm">/* check how many disks first (cmos reg 0x12), return an error if</span>
<a id="line-6542" name="line-6542"></a><span class="cm">     drive not present */</span>
<a id="line-6543" name="line-6543"></a><span class="w">  </span><span class="n">drive_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x12</span><span class="p">);</span>
<a id="line-6544" name="line-6544"></a><span class="w">  </span><span class="n">drive_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">drive_map</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<a id="line-6545" name="line-6545"></a><span class="w">              </span><span class="p">(((</span><span class="n">drive_map</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="line-6546" name="line-6546"></a><span class="w">  </span><span class="n">n_drives</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">drive_map</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span>
<a id="line-6547" name="line-6547"></a><span class="w">    </span><span class="p">((</span><span class="n">drive_map</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-6548" name="line-6548"></a>
<a id="line-6549" name="line-6549"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">drive_map</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* allow 0, 1, or 2 disks */</span>
<a id="line-6550" name="line-6550"></a><span class="w">    </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-6551" name="line-6551"></a><span class="w">    </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-6552" name="line-6552"></a><span class="w">    </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* error occurred */</span>
<a id="line-6553" name="line-6553"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-6554" name="line-6554"></a><span class="w">    </span><span class="p">}</span>
<a id="line-6555" name="line-6555"></a>
<a id="line-6556" name="line-6556"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GET_AH</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-6557" name="line-6557"></a>
<a id="line-6558" name="line-6558"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="cm">/* disk controller reset */</span>
<a id="line-6559" name="line-6559"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6560" name="line-6560"></a>
<a id="line-6561" name="line-6561"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6562" name="line-6562"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6563" name="line-6563"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6564" name="line-6564"></a><span class="w">      </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="cm">/* current cylinder, diskette 1 */</span>
<a id="line-6565" name="line-6565"></a><span class="w">      </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="cm">/* current cylinder, diskette 2 */</span>
<a id="line-6566" name="line-6566"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6567" name="line-6567"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6568" name="line-6568"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6569" name="line-6569"></a>
<a id="line-6570" name="line-6570"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk status */</span>
<a id="line-6571" name="line-6571"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f01</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6572" name="line-6572"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0074</span><span class="p">);</span>
<a id="line-6573" name="line-6573"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<a id="line-6574" name="line-6574"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6575" name="line-6575"></a><span class="w">      </span><span class="cm">/* set CF if error status read */</span>
<a id="line-6576" name="line-6576"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-6577" name="line-6577"></a><span class="w">      </span><span class="k">else</span><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-6578" name="line-6578"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6579" name="line-6579"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6580" name="line-6580"></a>
<a id="line-6581" name="line-6581"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w"> </span><span class="c1">// verify disk sectors</span>
<a id="line-6582" name="line-6582"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="c1">// read disk sectors</span>
<a id="line-6583" name="line-6583"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-6584" name="line-6584"></a><span class="w">      </span><span class="n">get_hd_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_sectors</span><span class="p">);</span>
<a id="line-6585" name="line-6585"></a>
<a id="line-6586" name="line-6586"></a><span class="w">      </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-6587" name="line-6587"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00c0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-6588" name="line-6588"></a><span class="w">      </span><span class="n">sector</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">);</span>
<a id="line-6589" name="line-6589"></a><span class="w">      </span><span class="n">head</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-6590" name="line-6590"></a>
<a id="line-6591" name="line-6591"></a>
<a id="line-6592" name="line-6592"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6593" name="line-6593"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6594" name="line-6594"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6595" name="line-6595"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6596" name="line-6596"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6597" name="line-6597"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6598" name="line-6598"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6599" name="line-6599"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6600" name="line-6600"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-6601" name="line-6601"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6602" name="line-6602"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// hd_cylinders &lt;= 16384</span>
<a id="line-6603" name="line-6603"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-6604" name="line-6604"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6605" name="line-6605"></a>
<a id="line-6606" name="line-6606"></a><span class="w">        </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">;</span>
<a id="line-6607" name="line-6607"></a><span class="w">        </span><span class="n">cyl_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<a id="line-6608" name="line-6608"></a><span class="w">        </span><span class="n">head</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-6609" name="line-6609"></a><span class="w">        </span><span class="n">cylinder</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">cyl_mod</span><span class="p">;</span>
<a id="line-6610" name="line-6610"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6611" name="line-6611"></a>
<a id="line-6612" name="line-6612"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">hd_cylinders</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-6613" name="line-6613"></a><span class="w">           </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-6614" name="line-6614"></a><span class="w">           </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6615" name="line-6615"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-6616" name="line-6616"></a><span class="w">        </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-6617" name="line-6617"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* error occurred */</span>
<a id="line-6618" name="line-6618"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-6619" name="line-6619"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6620" name="line-6620"></a>
<a id="line-6621" name="line-6621"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-6622" name="line-6622"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_harddisk: num_sectors out of range!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6623" name="line-6623"></a>
<a id="line-6624" name="line-6624"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span>
<a id="line-6625" name="line-6625"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read/verify) head &gt; 15</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6626" name="line-6626"></a>
<a id="line-6627" name="line-6627"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x04</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6628" name="line-6628"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6629" name="line-6629"></a><span class="w">        </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6630" name="line-6630"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-6631" name="line-6631"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-6632" name="line-6632"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6633" name="line-6633"></a>
<a id="line-6634" name="line-6634"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6635" name="line-6635"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6636" name="line-6636"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read/verify) BUSY bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6637" name="line-6637"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6638" name="line-6638"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f2</span><span class="p">,</span><span class="w"> </span><span class="n">num_sectors</span><span class="p">);</span>
<a id="line-6639" name="line-6639"></a><span class="w">      </span><span class="cm">/* activate LBA? (tomv) */</span>
<a id="line-6640" name="line-6640"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6641" name="line-6641"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;CHS: %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-6642" name="line-6642"></a><span class="w">        </span><span class="n">outLBA</span><span class="p">(</span><span class="n">cylinder</span><span class="p">,</span><span class="n">hd_heads</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">hd_sectors</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">drive</span><span class="p">);</span>
<a id="line-6643" name="line-6643"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6644" name="line-6644"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6645" name="line-6645"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f3</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-6646" name="line-6646"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f4</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span>
<a id="line-6647" name="line-6647"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f5</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-6648" name="line-6648"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">drive</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">));</span>
<a id="line-6649" name="line-6649"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6650" name="line-6650"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span>
<a id="line-6651" name="line-6651"></a>
<a id="line-6652" name="line-6652"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6653" name="line-6653"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6654" name="line-6654"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-6655" name="line-6655"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6656" name="line-6656"></a>
<a id="line-6657" name="line-6657"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6658" name="line-6658"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read/verify) read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6659" name="line-6659"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6660" name="line-6660"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;status was %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6661" name="line-6661"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read/verify) expected DRQ=1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6662" name="line-6662"></a><span class="w">      </span><span class="p">}</span>
<a id="line-6663" name="line-6663"></a>
<a id="line-6664" name="line-6664"></a><span class="w">      </span><span class="n">sector_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-6665" name="line-6665"></a><span class="w">      </span><span class="n">tempbx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span>
<a id="line-6666" name="line-6666"></a>
<a id="line-6667" name="line-6667"></a><span class="n">ASM_START</span>
<a id="line-6668" name="line-6668"></a><span class="w">  </span><span class="n">sti</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-6669" name="line-6669"></a><span class="n">ASM_END</span>
<a id="line-6670" name="line-6670"></a>
<a id="line-6671" name="line-6671"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6672" name="line-6672"></a><span class="n">ASM_START</span>
<a id="line-6673" name="line-6673"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">DI</span><span class="w"> </span><span class="k">register</span>
<a id="line-6674" name="line-6674"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6675" name="line-6675"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6676" name="line-6676"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">tempbx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-6677" name="line-6677"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-6678" name="line-6678"></a>
<a id="line-6679" name="line-6679"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">overrun</span>
<a id="line-6680" name="line-6680"></a><span class="w">        </span><span class="n">cmp</span><span class="w">   </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfe00</span>
<a id="line-6681" name="line-6681"></a><span class="w">        </span><span class="n">jbe</span><span class="w">   </span><span class="n">i13_f02_no_adjust</span>
<a id="line-6682" name="line-6682"></a><span class="nl">i13_f02_adjust</span><span class="p">:</span>
<a id="line-6683" name="line-6683"></a><span class="w">        </span><span class="n">sub</span><span class="w">   </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0200</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">offset</span>
<a id="line-6684" name="line-6684"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">es</span>
<a id="line-6685" name="line-6685"></a><span class="w">        </span><span class="n">add</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0020</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">segment</span>
<a id="line-6686" name="line-6686"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-6687" name="line-6687"></a>
<a id="line-6688" name="line-6688"></a><span class="nl">i13_f02_no_adjust</span><span class="p">:</span>
<a id="line-6689" name="line-6689"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="n">b</span><span class="p">)</span>
<a id="line-6690" name="line-6690"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01f0</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">AT</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">port</span>
<a id="line-6691" name="line-6691"></a>
<a id="line-6692" name="line-6692"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-6693" name="line-6693"></a><span class="w">          </span><span class="n">insw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">transfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">DI</span><span class="p">]</span>
<a id="line-6694" name="line-6694"></a>
<a id="line-6695" name="line-6695"></a><span class="nl">i13_f02_done</span><span class="p">:</span>
<a id="line-6696" name="line-6696"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">DI</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">bx</span>
<a id="line-6697" name="line-6697"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6698" name="line-6698"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6699" name="line-6699"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">tempbx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">di</span>
<a id="line-6700" name="line-6700"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-6701" name="line-6701"></a><span class="n">ASM_END</span>
<a id="line-6702" name="line-6702"></a>
<a id="line-6703" name="line-6703"></a><span class="w">        </span><span class="n">sector_count</span><span class="o">++</span><span class="p">;</span>
<a id="line-6704" name="line-6704"></a><span class="w">        </span><span class="n">num_sectors</span><span class="o">--</span><span class="p">;</span>
<a id="line-6705" name="line-6705"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6706" name="line-6706"></a><span class="w">          </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6707" name="line-6707"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">)</span>
<a id="line-6708" name="line-6708"></a><span class="w">            </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;no sectors left to read/verify, status is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6709" name="line-6709"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-6710" name="line-6710"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6711" name="line-6711"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6712" name="line-6712"></a><span class="w">          </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6713" name="line-6713"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x48</span><span class="w"> </span><span class="p">)</span>
<a id="line-6714" name="line-6714"></a><span class="w">            </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;more sectors left to read/verify, status is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6715" name="line-6715"></a><span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<a id="line-6716" name="line-6716"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6717" name="line-6717"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6718" name="line-6718"></a>
<a id="line-6719" name="line-6719"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6720" name="line-6720"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6721" name="line-6721"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">sector_count</span><span class="p">);</span>
<a id="line-6722" name="line-6722"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6723" name="line-6723"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6724" name="line-6724"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6725" name="line-6725"></a>
<a id="line-6726" name="line-6726"></a>
<a id="line-6727" name="line-6727"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors */</span>
<a id="line-6728" name="line-6728"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f03</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6729" name="line-6729"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="w"> </span><span class="p">();</span>
<a id="line-6730" name="line-6730"></a><span class="w">      </span><span class="n">get_hd_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_sectors</span><span class="p">);</span>
<a id="line-6731" name="line-6731"></a>
<a id="line-6732" name="line-6732"></a><span class="w">      </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-6733" name="line-6733"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-6734" name="line-6734"></a><span class="w">      </span><span class="n">cylinder</span><span class="w">    </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="n">Bit16u</span><span class="p">)</span><span class="w"> </span><span class="n">GET_CL</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x300</span><span class="p">;</span>
<a id="line-6735" name="line-6735"></a><span class="w">      </span><span class="n">sector</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GET_CL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">);</span>
<a id="line-6736" name="line-6736"></a><span class="w">      </span><span class="n">head</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-6737" name="line-6737"></a>
<a id="line-6738" name="line-6738"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6739" name="line-6739"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6740" name="line-6740"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6741" name="line-6741"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6742" name="line-6742"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6743" name="line-6743"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6744" name="line-6744"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6745" name="line-6745"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6746" name="line-6746"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-6747" name="line-6747"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6748" name="line-6748"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// hd_cylinders &lt;= 16384</span>
<a id="line-6749" name="line-6749"></a><span class="w">          </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-6750" name="line-6750"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6751" name="line-6751"></a>
<a id="line-6752" name="line-6752"></a><span class="w">        </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">;</span>
<a id="line-6753" name="line-6753"></a><span class="w">        </span><span class="n">cyl_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<a id="line-6754" name="line-6754"></a><span class="w">        </span><span class="n">head</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-6755" name="line-6755"></a><span class="w">        </span><span class="n">cylinder</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">cyl_mod</span><span class="p">;</span>
<a id="line-6756" name="line-6756"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6757" name="line-6757"></a>
<a id="line-6758" name="line-6758"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">hd_cylinders</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-6759" name="line-6759"></a><span class="w">           </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-6760" name="line-6760"></a><span class="w">           </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6761" name="line-6761"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-6762" name="line-6762"></a><span class="w">        </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-6763" name="line-6763"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* error occurred */</span>
<a id="line-6764" name="line-6764"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-6765" name="line-6765"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6766" name="line-6766"></a>
<a id="line-6767" name="line-6767"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<a id="line-6768" name="line-6768"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_harddisk: num_sectors out of range!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6769" name="line-6769"></a>
<a id="line-6770" name="line-6770"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span>
<a id="line-6771" name="line-6771"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read) head &gt; 15</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6772" name="line-6772"></a>
<a id="line-6773" name="line-6773"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6774" name="line-6774"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6775" name="line-6775"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(read) BUSY bit set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6776" name="line-6776"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6777" name="line-6777"></a><span class="c1">// should check for Drive Ready Bit also in status reg</span>
<a id="line-6778" name="line-6778"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f2</span><span class="p">,</span><span class="w"> </span><span class="n">num_sectors</span><span class="p">);</span>
<a id="line-6779" name="line-6779"></a>
<a id="line-6780" name="line-6780"></a><span class="w">      </span><span class="cm">/* activate LBA? (tomv) */</span>
<a id="line-6781" name="line-6781"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6782" name="line-6782"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;CHS (write): %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-6783" name="line-6783"></a><span class="w">        </span><span class="n">outLBA</span><span class="p">(</span><span class="n">cylinder</span><span class="p">,</span><span class="n">hd_heads</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">hd_sectors</span><span class="p">,</span><span class="n">sector</span><span class="p">,</span><span class="n">GET_ELDL</span><span class="p">());</span>
<a id="line-6784" name="line-6784"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6785" name="line-6785"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6786" name="line-6786"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f3</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-6787" name="line-6787"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f4</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">);</span>
<a id="line-6788" name="line-6788"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f5</span><span class="p">,</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-6789" name="line-6789"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">GET_ELDL</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">));</span>
<a id="line-6790" name="line-6790"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6791" name="line-6791"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x01f7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">);</span>
<a id="line-6792" name="line-6792"></a>
<a id="line-6793" name="line-6793"></a><span class="w">      </span><span class="c1">// wait for busy bit to turn off after seeking</span>
<a id="line-6794" name="line-6794"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6795" name="line-6795"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6796" name="line-6796"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="line-6797" name="line-6797"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6798" name="line-6798"></a>
<a id="line-6799" name="line-6799"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6800" name="line-6800"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;status was %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6801" name="line-6801"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;hard drive BIOS:(write) data-request bit not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6802" name="line-6802"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6803" name="line-6803"></a>
<a id="line-6804" name="line-6804"></a><span class="w">      </span><span class="n">sector_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-6805" name="line-6805"></a><span class="w">      </span><span class="n">tempbx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span>
<a id="line-6806" name="line-6806"></a>
<a id="line-6807" name="line-6807"></a><span class="n">ASM_START</span>
<a id="line-6808" name="line-6808"></a><span class="w">  </span><span class="n">sti</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">higher</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-6809" name="line-6809"></a><span class="n">ASM_END</span>
<a id="line-6810" name="line-6810"></a>
<a id="line-6811" name="line-6811"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6812" name="line-6812"></a><span class="n">ASM_START</span>
<a id="line-6813" name="line-6813"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="k">register</span>
<a id="line-6814" name="line-6814"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6815" name="line-6815"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6816" name="line-6816"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">tempbx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-6817" name="line-6817"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-6818" name="line-6818"></a>
<a id="line-6819" name="line-6819"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">overrun</span>
<a id="line-6820" name="line-6820"></a><span class="w">        </span><span class="n">cmp</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfe00</span>
<a id="line-6821" name="line-6821"></a><span class="w">        </span><span class="n">jbe</span><span class="w">   </span><span class="n">i13_f03_no_adjust</span>
<a id="line-6822" name="line-6822"></a><span class="nl">i13_f03_adjust</span><span class="p">:</span>
<a id="line-6823" name="line-6823"></a><span class="w">        </span><span class="n">sub</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0200</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">offset</span>
<a id="line-6824" name="line-6824"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">es</span>
<a id="line-6825" name="line-6825"></a><span class="w">        </span><span class="n">add</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0020</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">segment</span>
<a id="line-6826" name="line-6826"></a><span class="w">        </span><span class="n">mov</span><span class="w">   </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-6827" name="line-6827"></a>
<a id="line-6828" name="line-6828"></a><span class="nl">i13_f03_no_adjust</span><span class="p">:</span>
<a id="line-6829" name="line-6829"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="n">b</span><span class="p">)</span>
<a id="line-6830" name="line-6830"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01f0</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">AT</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">port</span>
<a id="line-6831" name="line-6831"></a>
<a id="line-6832" name="line-6832"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="n">ES</span>
<a id="line-6833" name="line-6833"></a><span class="w">        </span><span class="n">rep</span>
<a id="line-6834" name="line-6834"></a><span class="w">          </span><span class="n">outsw</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">CX</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">tranfered</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="p">[</span><span class="n">SI</span><span class="p">]</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">port</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span>
<a id="line-6835" name="line-6835"></a>
<a id="line-6836" name="line-6836"></a><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">SI</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">bx</span>
<a id="line-6837" name="line-6837"></a><span class="w">        </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6838" name="line-6838"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6839" name="line-6839"></a><span class="w">        </span><span class="n">mov</span><span class="w">  </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">tempbx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">si</span>
<a id="line-6840" name="line-6840"></a><span class="w">        </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-6841" name="line-6841"></a><span class="n">ASM_END</span>
<a id="line-6842" name="line-6842"></a>
<a id="line-6843" name="line-6843"></a><span class="w">        </span><span class="n">sector_count</span><span class="o">++</span><span class="p">;</span>
<a id="line-6844" name="line-6844"></a><span class="w">        </span><span class="n">num_sectors</span><span class="o">--</span><span class="p">;</span>
<a id="line-6845" name="line-6845"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6846" name="line-6846"></a><span class="w">          </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6847" name="line-6847"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xe9</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">)</span>
<a id="line-6848" name="line-6848"></a><span class="w">            </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;no sectors left to write, status is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6849" name="line-6849"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-6850" name="line-6850"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6851" name="line-6851"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6852" name="line-6852"></a><span class="w">          </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x1f7</span><span class="p">);</span>
<a id="line-6853" name="line-6853"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc9</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x48</span><span class="w"> </span><span class="p">)</span>
<a id="line-6854" name="line-6854"></a><span class="w">            </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;more sectors left to write, status is %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="line-6855" name="line-6855"></a><span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<a id="line-6856" name="line-6856"></a><span class="w">          </span><span class="p">}</span>
<a id="line-6857" name="line-6857"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6858" name="line-6858"></a>
<a id="line-6859" name="line-6859"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6860" name="line-6860"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6861" name="line-6861"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="n">sector_count</span><span class="p">);</span>
<a id="line-6862" name="line-6862"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6863" name="line-6863"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6864" name="line-6864"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6865" name="line-6865"></a>
<a id="line-6866" name="line-6866"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="cm">/* format disk track */</span>
<a id="line-6867" name="line-6867"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f05</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6868" name="line-6868"></a><span class="w">      </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;format disk track called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6869" name="line-6869"></a><span class="w">      </span><span class="cm">/* nop */</span>
<a id="line-6870" name="line-6870"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6871" name="line-6871"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6872" name="line-6872"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6873" name="line-6873"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6874" name="line-6874"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6875" name="line-6875"></a>
<a id="line-6876" name="line-6876"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x08</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive parameters */</span>
<a id="line-6877" name="line-6877"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f08</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6878" name="line-6878"></a>
<a id="line-6879" name="line-6879"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="w"> </span><span class="p">();</span>
<a id="line-6880" name="line-6880"></a><span class="w">      </span><span class="n">get_hd_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_sectors</span><span class="p">);</span>
<a id="line-6881" name="line-6881"></a>
<a id="line-6882" name="line-6882"></a><span class="w">      </span><span class="c1">// translate CHS</span>
<a id="line-6883" name="line-6883"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-6884" name="line-6884"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6885" name="line-6885"></a><span class="w">        </span><span class="c1">// hd_cylinders &gt;&gt;= 0;</span>
<a id="line-6886" name="line-6886"></a><span class="w">        </span><span class="c1">// hd_heads &lt;&lt;= 0;</span>
<a id="line-6887" name="line-6887"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6888" name="line-6888"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6889" name="line-6889"></a><span class="w">        </span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6890" name="line-6890"></a><span class="w">        </span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-6891" name="line-6891"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6892" name="line-6892"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6893" name="line-6893"></a><span class="w">        </span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6894" name="line-6894"></a><span class="w">        </span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="line-6895" name="line-6895"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6896" name="line-6896"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6897" name="line-6897"></a><span class="w">        </span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-6898" name="line-6898"></a><span class="w">        </span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="line-6899" name="line-6899"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6900" name="line-6900"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// hd_cylinders &lt;= 16384</span>
<a id="line-6901" name="line-6901"></a><span class="w">        </span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-6902" name="line-6902"></a><span class="w">        </span><span class="n">hd_heads</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-6903" name="line-6903"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6904" name="line-6904"></a>
<a id="line-6905" name="line-6905"></a><span class="w">      </span><span class="n">max_cylinder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* 0 based */</span>
<a id="line-6906" name="line-6906"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6907" name="line-6907"></a><span class="w">      </span><span class="n">SET_CH</span><span class="p">(</span><span class="n">max_cylinder</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span>
<a id="line-6908" name="line-6908"></a><span class="w">      </span><span class="n">SET_CL</span><span class="p">(((</span><span class="n">max_cylinder</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">hd_sectors</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">));</span>
<a id="line-6909" name="line-6909"></a><span class="w">      </span><span class="n">SET_DH</span><span class="p">(</span><span class="n">hd_heads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-6910" name="line-6910"></a><span class="w">      </span><span class="n">SET_DL</span><span class="p">(</span><span class="n">n_drives</span><span class="p">);</span><span class="w"> </span><span class="cm">/* returns 0, 1, or 2 hard drives */</span>
<a id="line-6911" name="line-6911"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6912" name="line-6912"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6913" name="line-6913"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6914" name="line-6914"></a>
<a id="line-6915" name="line-6915"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6916" name="line-6916"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6917" name="line-6917"></a>
<a id="line-6918" name="line-6918"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x09</span><span class="p">:</span><span class="w"> </span><span class="cm">/* initialize drive parameters */</span>
<a id="line-6919" name="line-6919"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f09</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6920" name="line-6920"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6921" name="line-6921"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6922" name="line-6922"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6923" name="line-6923"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6924" name="line-6924"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6925" name="line-6925"></a>
<a id="line-6926" name="line-6926"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0a</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk sectors with ECC */</span>
<a id="line-6927" name="line-6927"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f0a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6928" name="line-6928"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write disk sectors with ECC */</span>
<a id="line-6929" name="line-6929"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f0b</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6930" name="line-6930"></a><span class="w">      </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13h Functions 0Ah &amp; 0Bh not implemented!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6931" name="line-6931"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6932" name="line-6932"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6933" name="line-6933"></a>
<a id="line-6934" name="line-6934"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">:</span><span class="w"> </span><span class="cm">/* seek to specified cylinder */</span>
<a id="line-6935" name="line-6935"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f0c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6936" name="line-6936"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13h function 0ch (seek) not implemented!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6937" name="line-6937"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6938" name="line-6938"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6939" name="line-6939"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6940" name="line-6940"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6941" name="line-6941"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6942" name="line-6942"></a>
<a id="line-6943" name="line-6943"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">:</span><span class="w"> </span><span class="cm">/* alternate disk reset */</span>
<a id="line-6944" name="line-6944"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f0d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6945" name="line-6945"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6946" name="line-6946"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6947" name="line-6947"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6948" name="line-6948"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6949" name="line-6949"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6950" name="line-6950"></a>
<a id="line-6951" name="line-6951"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x10</span><span class="p">:</span><span class="w"> </span><span class="cm">/* check drive ready */</span>
<a id="line-6952" name="line-6952"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6953" name="line-6953"></a><span class="w">      </span><span class="c1">//SET_AH(0);</span>
<a id="line-6954" name="line-6954"></a><span class="w">      </span><span class="c1">//SET_DISK_RET_STATUS(0);</span>
<a id="line-6955" name="line-6955"></a><span class="w">      </span><span class="c1">//CLEAR_CF(); /* successful */</span>
<a id="line-6956" name="line-6956"></a><span class="w">      </span><span class="c1">//return;</span>
<a id="line-6957" name="line-6957"></a><span class="w">      </span><span class="c1">//break;</span>
<a id="line-6958" name="line-6958"></a>
<a id="line-6959" name="line-6959"></a><span class="w">      </span><span class="c1">// should look at 40:8E also???</span>
<a id="line-6960" name="line-6960"></a><span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x01f7</span><span class="p">);</span>
<a id="line-6961" name="line-6961"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-6962" name="line-6962"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6963" name="line-6963"></a><span class="w">        </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6964" name="line-6964"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// drive ready</span>
<a id="line-6965" name="line-6965"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-6966" name="line-6966"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6967" name="line-6967"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-6968" name="line-6968"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0xAA</span><span class="p">);</span>
<a id="line-6969" name="line-6969"></a><span class="w">        </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mh">0xAA</span><span class="p">);</span>
<a id="line-6970" name="line-6970"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// not ready</span>
<a id="line-6971" name="line-6971"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-6972" name="line-6972"></a><span class="w">        </span><span class="p">}</span>
<a id="line-6973" name="line-6973"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6974" name="line-6974"></a>
<a id="line-6975" name="line-6975"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x11</span><span class="p">:</span><span class="w"> </span><span class="cm">/* recalibrate */</span>
<a id="line-6976" name="line-6976"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f11</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6977" name="line-6977"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6978" name="line-6978"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6979" name="line-6979"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6980" name="line-6980"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6981" name="line-6981"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6982" name="line-6982"></a>
<a id="line-6983" name="line-6983"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x14</span><span class="p">:</span><span class="w"> </span><span class="cm">/* controller internal diagnostic */</span>
<a id="line-6984" name="line-6984"></a><span class="n">BX_DEBUG_INT13_HD</span><span class="p">(</span><span class="s">&quot;int13_f14</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-6985" name="line-6985"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6986" name="line-6986"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6987" name="line-6987"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* successful */</span>
<a id="line-6988" name="line-6988"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-6989" name="line-6989"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-6990" name="line-6990"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-6991" name="line-6991"></a>
<a id="line-6992" name="line-6992"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x15</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read disk drive size */</span>
<a id="line-6993" name="line-6993"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-6994" name="line-6994"></a><span class="w">      </span><span class="n">get_hd_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hd_sectors</span><span class="p">);</span>
<a id="line-6995" name="line-6995"></a><span class="n">ASM_START</span>
<a id="line-6996" name="line-6996"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-6997" name="line-6997"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-6998" name="line-6998"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">hd_heads</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-6999" name="line-6999"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">hd_sectors</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-7000" name="line-7000"></a><span class="w">      </span><span class="n">mul</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heads</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-7001" name="line-7001"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">hd_cylinders</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-7002" name="line-7002"></a><span class="w">      </span><span class="n">dec</span><span class="w">  </span><span class="n">bx</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="p">(</span><span class="n">cylinders</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">???</span>
<a id="line-7003" name="line-7003"></a><span class="w">      </span><span class="n">mul</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">dx</span><span class="o">:</span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cylinders</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">heads</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sectors</span><span class="p">)</span>
<a id="line-7004" name="line-7004"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">32</span><span class="n">bit</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">dx</span><span class="o">:</span><span class="n">ax</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">the</span>
<a id="line-7005" name="line-7005"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">wants</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">cx</span><span class="o">:</span><span class="n">dx</span><span class="p">.</span>
<a id="line-7006" name="line-7006"></a><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">CX</span><span class="o">:</span><span class="n">DX</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span>
<a id="line-7007" name="line-7007"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">CX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">dx</span>
<a id="line-7008" name="line-7008"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">_int13_harddisk</span><span class="p">.</span><span class="n">DX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-7009" name="line-7009"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-7010" name="line-7010"></a><span class="n">ASM_END</span>
<a id="line-7011" name="line-7011"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w">  </span><span class="c1">// hard disk accessible</span>
<a id="line-7012" name="line-7012"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// ??? should this be 0</span>
<a id="line-7013" name="line-7013"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// successful</span>
<a id="line-7014" name="line-7014"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7015" name="line-7015"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-7016" name="line-7016"></a>
<a id="line-7017" name="line-7017"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x18</span><span class="p">:</span><span class="w"> </span><span class="c1">// set media type for format</span>
<a id="line-7018" name="line-7018"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x41</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS</span>
<a id="line-7019" name="line-7019"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x42</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS</span>
<a id="line-7020" name="line-7020"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x43</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS</span>
<a id="line-7021" name="line-7021"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x44</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS</span>
<a id="line-7022" name="line-7022"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x45</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS lock/unlock drive</span>
<a id="line-7023" name="line-7023"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x46</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS eject media</span>
<a id="line-7024" name="line-7024"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x47</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended seek</span>
<a id="line-7025" name="line-7025"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x49</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS extended media change</span>
<a id="line-7026" name="line-7026"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x50</span><span class="p">:</span><span class="w"> </span><span class="c1">// IBM/MS send packet command</span>
<a id="line-7027" name="line-7027"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-7028" name="line-7028"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_harddisk: unsupported AH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-7029" name="line-7029"></a>
<a id="line-7030" name="line-7030"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// code=invalid function in AH or invalid parameter</span>
<a id="line-7031" name="line-7031"></a><span class="w">      </span><span class="n">SET_DISK_RET_STATUS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7032" name="line-7032"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="cm">/* unsuccessful */</span>
<a id="line-7033" name="line-7033"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7034" name="line-7034"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-7035" name="line-7035"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7036" name="line-7036"></a><span class="p">}</span>
<a id="line-7037" name="line-7037"></a>
<a id="line-7038" name="line-7038"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">panic_msg_reg12h</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;HD%d cmos reg 12h not type F</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<a id="line-7039" name="line-7039"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">panic_msg_reg19h</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;HD%d cmos reg %02xh not user definable type 47</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<a id="line-7040" name="line-7040"></a>
<a id="line-7041" name="line-7041"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-7042" name="line-7042"></a><span class="nf">get_hd_geometry</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">)</span>
<a id="line-7043" name="line-7043"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7044" name="line-7044"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="o">*</span><span class="n">hd_cylinders</span><span class="p">;</span>
<a id="line-7045" name="line-7045"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="o">*</span><span class="n">hd_heads</span><span class="p">;</span>
<a id="line-7046" name="line-7046"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="o">*</span><span class="n">hd_sectors</span><span class="p">;</span>
<a id="line-7047" name="line-7047"></a><span class="p">{</span>
<a id="line-7048" name="line-7048"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">hd_type</span><span class="p">;</span>
<a id="line-7049" name="line-7049"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<a id="line-7050" name="line-7050"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">cylinders</span><span class="p">;</span>
<a id="line-7051" name="line-7051"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">iobase</span><span class="p">;</span>
<a id="line-7052" name="line-7052"></a>
<a id="line-7053" name="line-7053"></a><span class="w">  </span><span class="n">ss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_SS</span><span class="p">();</span>
<a id="line-7054" name="line-7054"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7055" name="line-7055"></a><span class="w">    </span><span class="n">hd_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">;</span>
<a id="line-7056" name="line-7056"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">)</span>
<a id="line-7057" name="line-7057"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="n">panic_msg_reg12h</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7058" name="line-7058"></a><span class="w">    </span><span class="n">hd_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x19</span><span class="p">);</span><span class="w"> </span><span class="c1">// HD0: extended type</span>
<a id="line-7059" name="line-7059"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">47</span><span class="p">)</span>
<a id="line-7060" name="line-7060"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="n">panic_msg_reg19h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x19</span><span class="p">);</span>
<a id="line-7061" name="line-7061"></a><span class="w">    </span><span class="n">iobase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">;</span>
<a id="line-7062" name="line-7062"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-7063" name="line-7063"></a><span class="w">    </span><span class="n">hd_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x12</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-7064" name="line-7064"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">)</span>
<a id="line-7065" name="line-7065"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="n">panic_msg_reg12h</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7066" name="line-7066"></a><span class="w">    </span><span class="n">hd_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x1a</span><span class="p">);</span><span class="w"> </span><span class="c1">// HD1: extended type</span>
<a id="line-7067" name="line-7067"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hd_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">47</span><span class="p">)</span>
<a id="line-7068" name="line-7068"></a><span class="w">      </span><span class="n">BX_INFO</span><span class="p">(</span><span class="n">panic_msg_reg19h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">);</span>
<a id="line-7069" name="line-7069"></a><span class="w">    </span><span class="n">iobase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x24</span><span class="p">;</span>
<a id="line-7070" name="line-7070"></a><span class="w">  </span><span class="p">}</span>
<a id="line-7071" name="line-7071"></a>
<a id="line-7072" name="line-7072"></a><span class="w">  </span><span class="c1">// cylinders</span>
<a id="line-7073" name="line-7073"></a><span class="w">  </span><span class="n">cylinders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="n">iobase</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">inb_cmos</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-7074" name="line-7074"></a><span class="w">  </span><span class="n">write_word</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">hd_cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">cylinders</span><span class="p">);</span>
<a id="line-7075" name="line-7075"></a>
<a id="line-7076" name="line-7076"></a><span class="w">  </span><span class="c1">// heads</span>
<a id="line-7077" name="line-7077"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">hd_heads</span><span class="p">,</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
<a id="line-7078" name="line-7078"></a>
<a id="line-7079" name="line-7079"></a><span class="w">  </span><span class="c1">// sectors per track</span>
<a id="line-7080" name="line-7080"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">hd_sectors</span><span class="p">,</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="mi">8</span><span class="p">));</span>
<a id="line-7081" name="line-7081"></a><span class="p">}</span>
<a id="line-7082" name="line-7082"></a>
<a id="line-7083" name="line-7083"></a><span class="cp">#endif </span><span class="c1">//else BX_USE_ATADRV</span>
<a id="line-7084" name="line-7084"></a>
<a id="line-7085" name="line-7085"></a><span class="cp">#if BX_SUPPORT_FLOPPY</span>
<a id="line-7086" name="line-7086"></a>
<a id="line-7087" name="line-7087"></a><span class="c1">//////////////////////</span>
<a id="line-7088" name="line-7088"></a><span class="c1">// FLOPPY functions //</span>
<a id="line-7089" name="line-7089"></a><span class="c1">//////////////////////</span>
<a id="line-7090" name="line-7090"></a>
<a id="line-7091" name="line-7091"></a><span class="kt">void</span><span class="w"> </span><span class="n">floppy_reset_controller</span><span class="p">()</span>
<a id="line-7092" name="line-7092"></a><span class="p">{</span>
<a id="line-7093" name="line-7093"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span>
<a id="line-7094" name="line-7094"></a>
<a id="line-7095" name="line-7095"></a><span class="w">  </span><span class="c1">// Reset controller</span>
<a id="line-7096" name="line-7096"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x03f2</span><span class="p">);</span>
<a id="line-7097" name="line-7097"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>
<a id="line-7098" name="line-7098"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x04</span><span class="p">);</span>
<a id="line-7099" name="line-7099"></a>
<a id="line-7100" name="line-7100"></a><span class="w">  </span><span class="c1">// Wait for controller to come out of reset</span>
<a id="line-7101" name="line-7101"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7102" name="line-7102"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f4</span><span class="p">);</span>
<a id="line-7103" name="line-7103"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="p">);</span>
<a id="line-7104" name="line-7104"></a><span class="p">}</span>
<a id="line-7105" name="line-7105"></a>
<a id="line-7106" name="line-7106"></a><span class="kt">void</span><span class="w"> </span><span class="n">floppy_prepare_controller</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7107" name="line-7107"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7108" name="line-7108"></a><span class="p">{</span>
<a id="line-7109" name="line-7109"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">val8</span><span class="p">,</span><span class="w"> </span><span class="n">dor</span><span class="p">,</span><span class="w"> </span><span class="n">prev_reset</span><span class="p">;</span>
<a id="line-7110" name="line-7110"></a>
<a id="line-7111" name="line-7111"></a><span class="w">  </span><span class="c1">// set 40:3e bit 7 to 0</span>
<a id="line-7112" name="line-7112"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7113" name="line-7113"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7114" name="line-7114"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7115" name="line-7115"></a>
<a id="line-7116" name="line-7116"></a><span class="w">  </span><span class="c1">// turn on motor of selected drive, DMA &amp; int enabled, normal operation</span>
<a id="line-7117" name="line-7117"></a><span class="w">  </span><span class="n">prev_reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x03f2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x04</span><span class="p">;</span>
<a id="line-7118" name="line-7118"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7119" name="line-7119"></a><span class="w">    </span><span class="n">dor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20</span><span class="p">;</span>
<a id="line-7120" name="line-7120"></a><span class="w">  </span><span class="k">else</span>
<a id="line-7121" name="line-7121"></a><span class="w">    </span><span class="n">dor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span>
<a id="line-7122" name="line-7122"></a><span class="w">  </span><span class="n">dor</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">;</span>
<a id="line-7123" name="line-7123"></a><span class="w">  </span><span class="n">dor</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7124" name="line-7124"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f2</span><span class="p">,</span><span class="w"> </span><span class="n">dor</span><span class="p">);</span>
<a id="line-7125" name="line-7125"></a>
<a id="line-7126" name="line-7126"></a><span class="w">  </span><span class="c1">// reset the disk motor timeout value of INT 08</span>
<a id="line-7127" name="line-7127"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">BX_FLOPPY_ON_CNT</span><span class="p">);</span>
<a id="line-7128" name="line-7128"></a>
<a id="line-7129" name="line-7129"></a><span class="w">  </span><span class="c1">// wait for drive readiness</span>
<a id="line-7130" name="line-7130"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7131" name="line-7131"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f4</span><span class="p">);</span>
<a id="line-7132" name="line-7132"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="p">);</span>
<a id="line-7133" name="line-7133"></a>
<a id="line-7134" name="line-7134"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev_reset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7135" name="line-7135"></a><span class="w">    </span><span class="c1">// turn on interrupts</span>
<a id="line-7136" name="line-7136"></a><span class="n">ASM_START</span>
<a id="line-7137" name="line-7137"></a><span class="w">    </span><span class="n">sti</span>
<a id="line-7138" name="line-7138"></a><span class="n">ASM_END</span>
<a id="line-7139" name="line-7139"></a><span class="w">    </span><span class="c1">// wait on 40:3e bit 7 to become 1</span>
<a id="line-7140" name="line-7140"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7141" name="line-7141"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7142" name="line-7142"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-7143" name="line-7143"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7144" name="line-7144"></a><span class="n">ASM_START</span>
<a id="line-7145" name="line-7145"></a><span class="w">    </span><span class="n">cli</span>
<a id="line-7146" name="line-7146"></a><span class="n">ASM_END</span>
<a id="line-7147" name="line-7147"></a><span class="w">    </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7148" name="line-7148"></a><span class="w">  </span><span class="p">}</span>
<a id="line-7149" name="line-7149"></a><span class="p">}</span>
<a id="line-7150" name="line-7150"></a>
<a id="line-7151" name="line-7151"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-7152" name="line-7152"></a><span class="n">floppy_media_known</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7153" name="line-7153"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7154" name="line-7154"></a><span class="p">{</span>
<a id="line-7155" name="line-7155"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">val8</span><span class="p">;</span>
<a id="line-7156" name="line-7156"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">media_state_offset</span><span class="p">;</span>
<a id="line-7157" name="line-7157"></a>
<a id="line-7158" name="line-7158"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span><span class="w"> </span><span class="c1">// diskette recal status</span>
<a id="line-7159" name="line-7159"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7160" name="line-7160"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7161" name="line-7161"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-7162" name="line-7162"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7163" name="line-7163"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7164" name="line-7164"></a>
<a id="line-7165" name="line-7165"></a><span class="w">  </span><span class="n">media_state_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0090</span><span class="p">;</span>
<a id="line-7166" name="line-7166"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7167" name="line-7167"></a><span class="w">    </span><span class="n">media_state_offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7168" name="line-7168"></a>
<a id="line-7169" name="line-7169"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">media_state_offset</span><span class="p">);</span>
<a id="line-7170" name="line-7170"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-7171" name="line-7171"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7172" name="line-7172"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7173" name="line-7173"></a>
<a id="line-7174" name="line-7174"></a><span class="w">  </span><span class="c1">// check pass, return KNOWN</span>
<a id="line-7175" name="line-7175"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7176" name="line-7176"></a><span class="p">}</span>
<a id="line-7177" name="line-7177"></a>
<a id="line-7178" name="line-7178"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-7179" name="line-7179"></a><span class="n">floppy_media_sense</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7180" name="line-7180"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7181" name="line-7181"></a><span class="p">{</span>
<a id="line-7182" name="line-7182"></a><span class="w">  </span><span class="n">bx_bool</span><span class="w"> </span><span class="n">retval</span><span class="p">;</span>
<a id="line-7183" name="line-7183"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w">  </span><span class="n">media_state_offset</span><span class="p">;</span>
<a id="line-7184" name="line-7184"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">   </span><span class="n">drive_type</span><span class="p">,</span><span class="w"> </span><span class="n">config_data</span><span class="p">,</span><span class="w"> </span><span class="n">media_state</span><span class="p">;</span>
<a id="line-7185" name="line-7185"></a>
<a id="line-7186" name="line-7186"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_drive_recal</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7187" name="line-7187"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7188" name="line-7188"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7189" name="line-7189"></a>
<a id="line-7190" name="line-7190"></a><span class="w">  </span><span class="c1">// for now cheat and get drive type from CMOS,</span>
<a id="line-7191" name="line-7191"></a><span class="w">  </span><span class="c1">// assume media is same as drive type</span>
<a id="line-7192" name="line-7192"></a>
<a id="line-7193" name="line-7193"></a><span class="w">  </span><span class="c1">// ** config_data **</span>
<a id="line-7194" name="line-7194"></a><span class="w">  </span><span class="c1">// Bitfields for diskette media control:</span>
<a id="line-7195" name="line-7195"></a><span class="w">  </span><span class="c1">// Bit(s)  Description (Table M0028)</span>
<a id="line-7196" name="line-7196"></a><span class="w">  </span><span class="c1">//  7-6  last data rate set by controller</span>
<a id="line-7197" name="line-7197"></a><span class="w">  </span><span class="c1">//        00=500kbps, 01=300kbps, 10=250kbps, 11=1Mbps</span>
<a id="line-7198" name="line-7198"></a><span class="w">  </span><span class="c1">//  5-4  last diskette drive step rate selected</span>
<a id="line-7199" name="line-7199"></a><span class="w">  </span><span class="c1">//        00=0Ch, 01=0Dh, 10=0Eh, 11=0Ah</span>
<a id="line-7200" name="line-7200"></a><span class="w">  </span><span class="c1">//  3-2  {data rate at start of operation}</span>
<a id="line-7201" name="line-7201"></a><span class="w">  </span><span class="c1">//  1-0  reserved</span>
<a id="line-7202" name="line-7202"></a>
<a id="line-7203" name="line-7203"></a><span class="w">  </span><span class="c1">// ** media_state **</span>
<a id="line-7204" name="line-7204"></a><span class="w">  </span><span class="c1">// Bitfields for diskette drive media state:</span>
<a id="line-7205" name="line-7205"></a><span class="w">  </span><span class="c1">// Bit(s)  Description (Table M0030)</span>
<a id="line-7206" name="line-7206"></a><span class="w">  </span><span class="c1">//  7-6  data rate</span>
<a id="line-7207" name="line-7207"></a><span class="w">  </span><span class="c1">//    00=500kbps, 01=300kbps, 10=250kbps, 11=1Mbps</span>
<a id="line-7208" name="line-7208"></a><span class="w">  </span><span class="c1">//  5  double stepping required (e.g. 360kB in 1.2MB)</span>
<a id="line-7209" name="line-7209"></a><span class="w">  </span><span class="c1">//  4  media type established</span>
<a id="line-7210" name="line-7210"></a><span class="w">  </span><span class="c1">//  3  drive capable of supporting 4MB media</span>
<a id="line-7211" name="line-7211"></a><span class="w">  </span><span class="c1">//  2-0  on exit from BIOS, contains</span>
<a id="line-7212" name="line-7212"></a><span class="w">  </span><span class="c1">//    000 trying 360kB in 360kB</span>
<a id="line-7213" name="line-7213"></a><span class="w">  </span><span class="c1">//    001 trying 360kB in 1.2MB</span>
<a id="line-7214" name="line-7214"></a><span class="w">  </span><span class="c1">//    010 trying 1.2MB in 1.2MB</span>
<a id="line-7215" name="line-7215"></a><span class="w">  </span><span class="c1">//    011 360kB in 360kB established</span>
<a id="line-7216" name="line-7216"></a><span class="w">  </span><span class="c1">//    100 360kB in 1.2MB established</span>
<a id="line-7217" name="line-7217"></a><span class="w">  </span><span class="c1">//    101 1.2MB in 1.2MB established</span>
<a id="line-7218" name="line-7218"></a><span class="w">  </span><span class="c1">//    110 reserved</span>
<a id="line-7219" name="line-7219"></a><span class="w">  </span><span class="c1">//    111 all other formats/drives</span>
<a id="line-7220" name="line-7220"></a>
<a id="line-7221" name="line-7221"></a><span class="w">  </span><span class="n">drive_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-7222" name="line-7222"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7223" name="line-7223"></a><span class="w">    </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-7224" name="line-7224"></a><span class="w">  </span><span class="k">else</span>
<a id="line-7225" name="line-7225"></a><span class="w">    </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-7226" name="line-7226"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7227" name="line-7227"></a><span class="w">    </span><span class="c1">// 360K 5.25&quot; drive</span>
<a id="line-7228" name="line-7228"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7229" name="line-7229"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x25</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0010 0101</span>
<a id="line-7230" name="line-7230"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7231" name="line-7231"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7232" name="line-7232"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7233" name="line-7233"></a><span class="w">    </span><span class="c1">// 1.2 MB 5.25&quot; drive</span>
<a id="line-7234" name="line-7234"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7235" name="line-7235"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x25</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0010 0101   // need double stepping??? (bit 5)</span>
<a id="line-7236" name="line-7236"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7237" name="line-7237"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7238" name="line-7238"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7239" name="line-7239"></a><span class="w">    </span><span class="c1">// 720K 3.5&quot; drive</span>
<a id="line-7240" name="line-7240"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000 ???</span>
<a id="line-7241" name="line-7241"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x17</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0001 0111</span>
<a id="line-7242" name="line-7242"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7243" name="line-7243"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7244" name="line-7244"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7245" name="line-7245"></a><span class="w">    </span><span class="c1">// 1.44 MB 3.5&quot; drive</span>
<a id="line-7246" name="line-7246"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7247" name="line-7247"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x17</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0001 0111</span>
<a id="line-7248" name="line-7248"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7249" name="line-7249"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7250" name="line-7250"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7251" name="line-7251"></a><span class="w">    </span><span class="c1">// 2.88 MB 3.5&quot; drive</span>
<a id="line-7252" name="line-7252"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xCC</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1100 1100</span>
<a id="line-7253" name="line-7253"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xD7</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1101 0111</span>
<a id="line-7254" name="line-7254"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7255" name="line-7255"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7256" name="line-7256"></a><span class="w">  </span><span class="c1">//</span>
<a id="line-7257" name="line-7257"></a><span class="w">  </span><span class="c1">// Extended floppy size uses special cmos setting</span>
<a id="line-7258" name="line-7258"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7259" name="line-7259"></a><span class="w">    </span><span class="c1">// 160k 5.25&quot; drive</span>
<a id="line-7260" name="line-7260"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7261" name="line-7261"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x27</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0010 0111</span>
<a id="line-7262" name="line-7262"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7263" name="line-7263"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7264" name="line-7264"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7265" name="line-7265"></a><span class="w">    </span><span class="c1">// 180k 5.25&quot; drive</span>
<a id="line-7266" name="line-7266"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7267" name="line-7267"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x27</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0010 0111</span>
<a id="line-7268" name="line-7268"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7269" name="line-7269"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7270" name="line-7270"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7271" name="line-7271"></a><span class="w">    </span><span class="c1">// 320k 5.25&quot; drive</span>
<a id="line-7272" name="line-7272"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7273" name="line-7273"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x27</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0010 0111</span>
<a id="line-7274" name="line-7274"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7275" name="line-7275"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7276" name="line-7276"></a>
<a id="line-7277" name="line-7277"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-7278" name="line-7278"></a><span class="w">    </span><span class="c1">// not recognized</span>
<a id="line-7279" name="line-7279"></a><span class="w">    </span><span class="n">config_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7280" name="line-7280"></a><span class="w">    </span><span class="n">media_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0000 0000</span>
<a id="line-7281" name="line-7281"></a><span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7282" name="line-7282"></a><span class="w">    </span><span class="p">}</span>
<a id="line-7283" name="line-7283"></a>
<a id="line-7284" name="line-7284"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7285" name="line-7285"></a><span class="w">    </span><span class="n">media_state_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x90</span><span class="p">;</span>
<a id="line-7286" name="line-7286"></a><span class="w">  </span><span class="k">else</span>
<a id="line-7287" name="line-7287"></a><span class="w">    </span><span class="n">media_state_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x91</span><span class="p">;</span>
<a id="line-7288" name="line-7288"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x008B</span><span class="p">,</span><span class="w"> </span><span class="n">config_data</span><span class="p">);</span>
<a id="line-7289" name="line-7289"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">media_state_offset</span><span class="p">,</span><span class="w"> </span><span class="n">media_state</span><span class="p">);</span>
<a id="line-7290" name="line-7290"></a>
<a id="line-7291" name="line-7291"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a id="line-7292" name="line-7292"></a><span class="p">}</span>
<a id="line-7293" name="line-7293"></a>
<a id="line-7294" name="line-7294"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-7295" name="line-7295"></a><span class="n">floppy_drive_recal</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7296" name="line-7296"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7297" name="line-7297"></a><span class="p">{</span>
<a id="line-7298" name="line-7298"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">val8</span><span class="p">;</span>
<a id="line-7299" name="line-7299"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">curr_cyl_offset</span><span class="p">;</span>
<a id="line-7300" name="line-7300"></a>
<a id="line-7301" name="line-7301"></a><span class="w">  </span><span class="n">floppy_prepare_controller</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<a id="line-7302" name="line-7302"></a>
<a id="line-7303" name="line-7303"></a><span class="w">  </span><span class="c1">// send Recalibrate command (2 bytes) to controller</span>
<a id="line-7304" name="line-7304"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">);</span><span class="w">  </span><span class="c1">// 07: Recalibrate</span>
<a id="line-7305" name="line-7305"></a><span class="w">  </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0=drive0, 1=drive1</span>
<a id="line-7306" name="line-7306"></a>
<a id="line-7307" name="line-7307"></a><span class="w">  </span><span class="c1">// turn on interrupts</span>
<a id="line-7308" name="line-7308"></a><span class="n">ASM_START</span>
<a id="line-7309" name="line-7309"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-7310" name="line-7310"></a><span class="n">ASM_END</span>
<a id="line-7311" name="line-7311"></a>
<a id="line-7312" name="line-7312"></a><span class="w">  </span><span class="c1">// wait on 40:3e bit 7 to become 1</span>
<a id="line-7313" name="line-7313"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7314" name="line-7314"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7315" name="line-7315"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-7316" name="line-7316"></a>
<a id="line-7317" name="line-7317"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// separate asm from while() loop</span>
<a id="line-7318" name="line-7318"></a><span class="w">  </span><span class="c1">// turn off interrupts</span>
<a id="line-7319" name="line-7319"></a><span class="n">ASM_START</span>
<a id="line-7320" name="line-7320"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-7321" name="line-7321"></a><span class="n">ASM_END</span>
<a id="line-7322" name="line-7322"></a>
<a id="line-7323" name="line-7323"></a><span class="w">  </span><span class="c1">// set 40:3e bit 7 to 0, and calibrated bit</span>
<a id="line-7324" name="line-7324"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7325" name="line-7325"></a><span class="w">  </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7326" name="line-7326"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7327" name="line-7327"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span><span class="w"> </span><span class="c1">// Drive 1 calibrated</span>
<a id="line-7328" name="line-7328"></a><span class="w">    </span><span class="n">curr_cyl_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0095</span><span class="p">;</span>
<a id="line-7329" name="line-7329"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-7330" name="line-7330"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span><span class="w"> </span><span class="c1">// Drive 0 calibrated</span>
<a id="line-7331" name="line-7331"></a><span class="w">    </span><span class="n">curr_cyl_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0094</span><span class="p">;</span>
<a id="line-7332" name="line-7332"></a><span class="w">  </span><span class="p">}</span>
<a id="line-7333" name="line-7333"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7334" name="line-7334"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="n">curr_cyl_offset</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// current cylinder is 0</span>
<a id="line-7335" name="line-7335"></a>
<a id="line-7336" name="line-7336"></a><span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7337" name="line-7337"></a><span class="p">}</span>
<a id="line-7338" name="line-7338"></a>
<a id="line-7339" name="line-7339"></a>
<a id="line-7340" name="line-7340"></a>
<a id="line-7341" name="line-7341"></a><span class="w">  </span><span class="n">bx_bool</span>
<a id="line-7342" name="line-7342"></a><span class="n">floppy_drive_exists</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-7343" name="line-7343"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-7344" name="line-7344"></a><span class="p">{</span>
<a id="line-7345" name="line-7345"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">drive_type</span><span class="p">;</span>
<a id="line-7346" name="line-7346"></a>
<a id="line-7347" name="line-7347"></a><span class="w">  </span><span class="c1">// check CMOS to see if drive exists</span>
<a id="line-7348" name="line-7348"></a><span class="w">  </span><span class="n">drive_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-7349" name="line-7349"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7350" name="line-7350"></a><span class="w">    </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-7351" name="line-7351"></a><span class="w">  </span><span class="k">else</span>
<a id="line-7352" name="line-7352"></a><span class="w">    </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-7353" name="line-7353"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<a id="line-7354" name="line-7354"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7355" name="line-7355"></a><span class="w">  </span><span class="k">else</span>
<a id="line-7356" name="line-7356"></a><span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7357" name="line-7357"></a><span class="p">}</span>
<a id="line-7358" name="line-7358"></a>
<a id="line-7359" name="line-7359"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-7360" name="line-7360"></a><span class="n">int13_diskette_function</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-7361" name="line-7361"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-7362" name="line-7362"></a><span class="p">{</span>
<a id="line-7363" name="line-7363"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">num_sectors</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-7364" name="line-7364"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">base_address</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="p">,</span><span class="w"> </span><span class="n">base_es</span><span class="p">;</span>
<a id="line-7365" name="line-7365"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">mode_register</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">,</span><span class="w"> </span><span class="n">dor</span><span class="p">;</span>
<a id="line-7366" name="line-7366"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">return_status</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<a id="line-7367" name="line-7367"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">drive_type</span><span class="p">,</span><span class="w"> </span><span class="n">num_floppies</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span><span class="p">;</span>
<a id="line-7368" name="line-7368"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">last_addr</span><span class="p">;</span>
<a id="line-7369" name="line-7369"></a>
<a id="line-7370" name="line-7370"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;int13_diskette: AX=%04x BX=%04x CX=%04x DX=%04x ES=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">);</span>
<a id="line-7371" name="line-7371"></a>
<a id="line-7372" name="line-7372"></a><span class="w">  </span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">();</span>
<a id="line-7373" name="line-7373"></a>
<a id="line-7374" name="line-7374"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ah</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7375" name="line-7375"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x00</span><span class="p">:</span><span class="w"> </span><span class="c1">// diskette controller reset</span>
<a id="line-7376" name="line-7376"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f00</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7377" name="line-7377"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-7378" name="line-7378"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7379" name="line-7379"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// invalid param</span>
<a id="line-7380" name="line-7380"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7381" name="line-7381"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7382" name="line-7382"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7383" name="line-7383"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7384" name="line-7384"></a><span class="w">      </span><span class="n">drive_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-7385" name="line-7385"></a>
<a id="line-7386" name="line-7386"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7387" name="line-7387"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-7388" name="line-7388"></a><span class="w">      </span><span class="k">else</span>
<a id="line-7389" name="line-7389"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-7390" name="line-7390"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7391" name="line-7391"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not responding</span>
<a id="line-7392" name="line-7392"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7393" name="line-7393"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7394" name="line-7394"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7395" name="line-7395"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7396" name="line-7396"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7397" name="line-7397"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7398" name="line-7398"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// successful</span>
<a id="line-7399" name="line-7399"></a><span class="w">      </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// current cylinder</span>
<a id="line-7400" name="line-7400"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7401" name="line-7401"></a>
<a id="line-7402" name="line-7402"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="c1">// Read Diskette Status</span>
<a id="line-7403" name="line-7403"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-7404" name="line-7404"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0441</span><span class="p">);</span>
<a id="line-7405" name="line-7405"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">val8</span><span class="p">);</span>
<a id="line-7406" name="line-7406"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7407" name="line-7407"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7408" name="line-7408"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7409" name="line-7409"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7410" name="line-7410"></a>
<a id="line-7411" name="line-7411"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x02</span><span class="p">:</span><span class="w"> </span><span class="c1">// Read Diskette Sectors</span>
<a id="line-7412" name="line-7412"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x03</span><span class="p">:</span><span class="w"> </span><span class="c1">// Write Diskette Sectors</span>
<a id="line-7413" name="line-7413"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x04</span><span class="p">:</span><span class="w"> </span><span class="c1">// Verify Diskette Sectors</span>
<a id="line-7414" name="line-7414"></a><span class="w">      </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-7415" name="line-7415"></a><span class="w">      </span><span class="n">track</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-7416" name="line-7416"></a><span class="w">      </span><span class="n">sector</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CL</span><span class="p">();</span>
<a id="line-7417" name="line-7417"></a><span class="w">      </span><span class="n">head</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-7418" name="line-7418"></a><span class="w">      </span><span class="n">drive</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-7419" name="line-7419"></a>
<a id="line-7420" name="line-7420"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">sector</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-7421" name="line-7421"></a><span class="w">          </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">72</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-7422" name="line-7422"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_diskette: read/write/verify: parameter out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7423" name="line-7423"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7424" name="line-7424"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7425" name="line-7425"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7426" name="line-7426"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7427" name="line-7427"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7428" name="line-7428"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7429" name="line-7429"></a>
<a id="line-7430" name="line-7430"></a><span class="w">      </span><span class="c1">// see if drive exists</span>
<a id="line-7431" name="line-7431"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_drive_exists</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7432" name="line-7432"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// not responding</span>
<a id="line-7433" name="line-7433"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7434" name="line-7434"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7435" name="line-7435"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7436" name="line-7436"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7437" name="line-7437"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7438" name="line-7438"></a>
<a id="line-7439" name="line-7439"></a><span class="w">      </span><span class="c1">// see if media in drive, and type is known</span>
<a id="line-7440" name="line-7440"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_media_known</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7441" name="line-7441"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_media_sense</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7442" name="line-7442"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">);</span><span class="w"> </span><span class="c1">// Media type not found</span>
<a id="line-7443" name="line-7443"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">);</span>
<a id="line-7444" name="line-7444"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7445" name="line-7445"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7446" name="line-7446"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7447" name="line-7447"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7448" name="line-7448"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7449" name="line-7449"></a>
<a id="line-7450" name="line-7450"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ah</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7451" name="line-7451"></a><span class="w">        </span><span class="c1">// Read Diskette Sectors</span>
<a id="line-7452" name="line-7452"></a>
<a id="line-7453" name="line-7453"></a><span class="w">        </span><span class="c1">//-----------------------------------</span>
<a id="line-7454" name="line-7454"></a><span class="w">        </span><span class="c1">// set up DMA controller for transfer</span>
<a id="line-7455" name="line-7455"></a><span class="w">        </span><span class="c1">//-----------------------------------</span>
<a id="line-7456" name="line-7456"></a>
<a id="line-7457" name="line-7457"></a><span class="w">        </span><span class="c1">// es:bx = pointer to where to place information from diskette</span>
<a id="line-7458" name="line-7458"></a><span class="w">        </span><span class="c1">// port 04: DMA-1 base and current address, channel 2</span>
<a id="line-7459" name="line-7459"></a><span class="w">        </span><span class="c1">// port 05: DMA-1 base and current count, channel 2</span>
<a id="line-7460" name="line-7460"></a><span class="w">        </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w">   </span><span class="c1">// upper 4 bits</span>
<a id="line-7461" name="line-7461"></a><span class="w">        </span><span class="n">base_es</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// lower 16bits contributed by ES</span>
<a id="line-7462" name="line-7462"></a><span class="w">        </span><span class="n">base_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span><span class="w"> </span><span class="c1">// lower 16 bits of address</span>
<a id="line-7463" name="line-7463"></a><span class="w">                                     </span><span class="c1">// contributed by ES:BX</span>
<a id="line-7464" name="line-7464"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7465" name="line-7465"></a><span class="w">          </span><span class="c1">// in case of carry, adjust page by 1</span>
<a id="line-7466" name="line-7466"></a><span class="w">          </span><span class="n">page</span><span class="o">++</span><span class="p">;</span>
<a id="line-7467" name="line-7467"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7468" name="line-7468"></a><span class="w">        </span><span class="n">base_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7469" name="line-7469"></a>
<a id="line-7470" name="line-7470"></a><span class="w">        </span><span class="c1">// check for 64K boundary overrun</span>
<a id="line-7471" name="line-7471"></a><span class="w">        </span><span class="n">last_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base_count</span><span class="p">;</span>
<a id="line-7472" name="line-7472"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last_addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7473" name="line-7473"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7474" name="line-7474"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7475" name="line-7475"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7476" name="line-7476"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7477" name="line-7477"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7478" name="line-7478"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7479" name="line-7479"></a>
<a id="line-7480" name="line-7480"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;masking DMA-1 c2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7481" name="line-7481"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">);</span>
<a id="line-7482" name="line-7482"></a>
<a id="line-7483" name="line-7483"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;clear flip-flop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7484" name="line-7484"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7485" name="line-7485"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="p">);</span>
<a id="line-7486" name="line-7486"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7487" name="line-7487"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;clear flip-flop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7488" name="line-7488"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7489" name="line-7489"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="p">);</span>
<a id="line-7490" name="line-7490"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7491" name="line-7491"></a>
<a id="line-7492" name="line-7492"></a><span class="w">        </span><span class="c1">// port 0b: DMA-1 Mode Register</span>
<a id="line-7493" name="line-7493"></a><span class="w">        </span><span class="n">mode_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x46</span><span class="p">;</span><span class="w"> </span><span class="c1">// single mode, increment, autoinit disable,</span>
<a id="line-7494" name="line-7494"></a><span class="w">                              </span><span class="c1">// transfer type=write, channel 2</span>
<a id="line-7495" name="line-7495"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;setting mode register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7496" name="line-7496"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000b</span><span class="p">,</span><span class="w"> </span><span class="n">mode_register</span><span class="p">);</span>
<a id="line-7497" name="line-7497"></a>
<a id="line-7498" name="line-7498"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;setting page register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7499" name="line-7499"></a><span class="w">        </span><span class="c1">// port 81: DMA-1 Page Register, channel 2</span>
<a id="line-7500" name="line-7500"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0081</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<a id="line-7501" name="line-7501"></a>
<a id="line-7502" name="line-7502"></a><span class="w">  </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;unmask chan 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7503" name="line-7503"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span><span class="w"> </span><span class="c1">// unmask channel 2</span>
<a id="line-7504" name="line-7504"></a>
<a id="line-7505" name="line-7505"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;unmasking DMA-1 c2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7506" name="line-7506"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-7507" name="line-7507"></a>
<a id="line-7508" name="line-7508"></a><span class="w">        </span><span class="c1">//--------------------------------------</span>
<a id="line-7509" name="line-7509"></a><span class="w">        </span><span class="c1">// set up floppy controller for transfer</span>
<a id="line-7510" name="line-7510"></a><span class="w">        </span><span class="c1">//--------------------------------------</span>
<a id="line-7511" name="line-7511"></a><span class="w">        </span><span class="n">floppy_prepare_controller</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<a id="line-7512" name="line-7512"></a>
<a id="line-7513" name="line-7513"></a><span class="w">        </span><span class="c1">// send read-normal-data command (9 bytes) to controller</span>
<a id="line-7514" name="line-7514"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">);</span><span class="w"> </span><span class="c1">// e6: read normal data</span>
<a id="line-7515" name="line-7515"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span><span class="w"> </span><span class="c1">// HD DR1 DR2</span>
<a id="line-7516" name="line-7516"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">);</span>
<a id="line-7517" name="line-7517"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">);</span>
<a id="line-7518" name="line-7518"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-7519" name="line-7519"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 512 byte sector size</span>
<a id="line-7520" name="line-7520"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// last sector to read on track</span>
<a id="line-7521" name="line-7521"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gap length</span>
<a id="line-7522" name="line-7522"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gap length</span>
<a id="line-7523" name="line-7523"></a>
<a id="line-7524" name="line-7524"></a><span class="w">        </span><span class="c1">// turn on interrupts</span>
<a id="line-7525" name="line-7525"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7526" name="line-7526"></a><span class="w">        </span><span class="n">sti</span>
<a id="line-7527" name="line-7527"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7528" name="line-7528"></a>
<a id="line-7529" name="line-7529"></a><span class="w">        </span><span class="c1">// wait on 40:3e bit 7 to become 1</span>
<a id="line-7530" name="line-7530"></a><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7531" name="line-7531"></a><span class="w">          </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0040</span><span class="p">);</span>
<a id="line-7532" name="line-7532"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7533" name="line-7533"></a><span class="w">            </span><span class="n">floppy_reset_controller</span><span class="p">();</span>
<a id="line-7534" name="line-7534"></a><span class="w">            </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not ready (timeout)</span>
<a id="line-7535" name="line-7535"></a><span class="w">            </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7536" name="line-7536"></a><span class="w">            </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7537" name="line-7537"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7538" name="line-7538"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="line-7539" name="line-7539"></a><span class="w">          </span><span class="p">}</span>
<a id="line-7540" name="line-7540"></a><span class="w">          </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7541" name="line-7541"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-7542" name="line-7542"></a>
<a id="line-7543" name="line-7543"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// separate asm from while() loop</span>
<a id="line-7544" name="line-7544"></a><span class="w">        </span><span class="c1">// turn off interrupts</span>
<a id="line-7545" name="line-7545"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7546" name="line-7546"></a><span class="w">        </span><span class="n">cli</span>
<a id="line-7547" name="line-7547"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7548" name="line-7548"></a>
<a id="line-7549" name="line-7549"></a><span class="w">        </span><span class="c1">// set 40:3e bit 7 to 0</span>
<a id="line-7550" name="line-7550"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7551" name="line-7551"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7552" name="line-7552"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7553" name="line-7553"></a>
<a id="line-7554" name="line-7554"></a><span class="w">        </span><span class="c1">// check port 3f4 for accessibility to status bytes</span>
<a id="line-7555" name="line-7555"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f4</span><span class="p">);</span>
<a id="line-7556" name="line-7556"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"> </span><span class="p">)</span>
<a id="line-7557" name="line-7557"></a><span class="w">          </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_diskette: ctrl not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7558" name="line-7558"></a>
<a id="line-7559" name="line-7559"></a><span class="w">        </span><span class="c1">// read 7 return status bytes from controller</span>
<a id="line-7560" name="line-7560"></a><span class="w">        </span><span class="c1">// using loop index broken, have to unroll...</span>
<a id="line-7561" name="line-7561"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7562" name="line-7562"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7563" name="line-7563"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7564" name="line-7564"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7565" name="line-7565"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7566" name="line-7566"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7567" name="line-7567"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7568" name="line-7568"></a><span class="w">        </span><span class="c1">// record in BIOS Data Area</span>
<a id="line-7569" name="line-7569"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0042</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="line-7570" name="line-7570"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0043</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="line-7571" name="line-7571"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0044</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="line-7572" name="line-7572"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0045</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<a id="line-7573" name="line-7573"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0046</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<a id="line-7574" name="line-7574"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0047</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<a id="line-7575" name="line-7575"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0048</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
<a id="line-7576" name="line-7576"></a>
<a id="line-7577" name="line-7577"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7578" name="line-7578"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
<a id="line-7579" name="line-7579"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
<a id="line-7580" name="line-7580"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7581" name="line-7581"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7582" name="line-7582"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7583" name="line-7583"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7584" name="line-7584"></a>
<a id="line-7585" name="line-7585"></a><span class="w">        </span><span class="c1">// ??? should track be new val from return_status[3] ?</span>
<a id="line-7586" name="line-7586"></a><span class="w">        </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">);</span>
<a id="line-7587" name="line-7587"></a><span class="w">        </span><span class="c1">// AL = number of sectors read (same value as passed)</span>
<a id="line-7588" name="line-7588"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// success</span>
<a id="line-7589" name="line-7589"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// success</span>
<a id="line-7590" name="line-7590"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7591" name="line-7591"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ah</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7592" name="line-7592"></a><span class="w">        </span><span class="c1">// Write Diskette Sectors</span>
<a id="line-7593" name="line-7593"></a>
<a id="line-7594" name="line-7594"></a><span class="w">        </span><span class="c1">//-----------------------------------</span>
<a id="line-7595" name="line-7595"></a><span class="w">        </span><span class="c1">// set up DMA controller for transfer</span>
<a id="line-7596" name="line-7596"></a><span class="w">        </span><span class="c1">//-----------------------------------</span>
<a id="line-7597" name="line-7597"></a>
<a id="line-7598" name="line-7598"></a><span class="w">        </span><span class="c1">// es:bx = pointer to where to place information from diskette</span>
<a id="line-7599" name="line-7599"></a><span class="w">        </span><span class="c1">// port 04: DMA-1 base and current address, channel 2</span>
<a id="line-7600" name="line-7600"></a><span class="w">        </span><span class="c1">// port 05: DMA-1 base and current count, channel 2</span>
<a id="line-7601" name="line-7601"></a><span class="w">        </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w">   </span><span class="c1">// upper 4 bits</span>
<a id="line-7602" name="line-7602"></a><span class="w">        </span><span class="n">base_es</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// lower 16bits contributed by ES</span>
<a id="line-7603" name="line-7603"></a><span class="w">        </span><span class="n">base_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span><span class="w"> </span><span class="c1">// lower 16 bits of address</span>
<a id="line-7604" name="line-7604"></a><span class="w">                                     </span><span class="c1">// contributed by ES:BX</span>
<a id="line-7605" name="line-7605"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7606" name="line-7606"></a><span class="w">          </span><span class="c1">// in case of carry, adjust page by 1</span>
<a id="line-7607" name="line-7607"></a><span class="w">          </span><span class="n">page</span><span class="o">++</span><span class="p">;</span>
<a id="line-7608" name="line-7608"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7609" name="line-7609"></a><span class="w">        </span><span class="n">base_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7610" name="line-7610"></a>
<a id="line-7611" name="line-7611"></a><span class="w">        </span><span class="c1">// check for 64K boundary overrun</span>
<a id="line-7612" name="line-7612"></a><span class="w">        </span><span class="n">last_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base_count</span><span class="p">;</span>
<a id="line-7613" name="line-7613"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last_addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7614" name="line-7614"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7615" name="line-7615"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7616" name="line-7616"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7617" name="line-7617"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7618" name="line-7618"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7619" name="line-7619"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7620" name="line-7620"></a>
<a id="line-7621" name="line-7621"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;masking DMA-1 c2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7622" name="line-7622"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">);</span>
<a id="line-7623" name="line-7623"></a>
<a id="line-7624" name="line-7624"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7625" name="line-7625"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="p">);</span>
<a id="line-7626" name="line-7626"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7627" name="line-7627"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7628" name="line-7628"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="p">);</span>
<a id="line-7629" name="line-7629"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7630" name="line-7630"></a>
<a id="line-7631" name="line-7631"></a><span class="w">        </span><span class="c1">// port 0b: DMA-1 Mode Register</span>
<a id="line-7632" name="line-7632"></a><span class="w">        </span><span class="n">mode_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4a</span><span class="p">;</span><span class="w"> </span><span class="c1">// single mode, increment, autoinit disable,</span>
<a id="line-7633" name="line-7633"></a><span class="w">                              </span><span class="c1">// transfer type=read, channel 2</span>
<a id="line-7634" name="line-7634"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000b</span><span class="p">,</span><span class="w"> </span><span class="n">mode_register</span><span class="p">);</span>
<a id="line-7635" name="line-7635"></a>
<a id="line-7636" name="line-7636"></a><span class="w">        </span><span class="c1">// port 81: DMA-1 Page Register, channel 2</span>
<a id="line-7637" name="line-7637"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0081</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<a id="line-7638" name="line-7638"></a>
<a id="line-7639" name="line-7639"></a><span class="w">        </span><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;unmasking DMA-1 c2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7640" name="line-7640"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-7641" name="line-7641"></a>
<a id="line-7642" name="line-7642"></a><span class="w">        </span><span class="c1">//--------------------------------------</span>
<a id="line-7643" name="line-7643"></a><span class="w">        </span><span class="c1">// set up floppy controller for transfer</span>
<a id="line-7644" name="line-7644"></a><span class="w">        </span><span class="c1">//--------------------------------------</span>
<a id="line-7645" name="line-7645"></a><span class="w">        </span><span class="n">floppy_prepare_controller</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<a id="line-7646" name="line-7646"></a>
<a id="line-7647" name="line-7647"></a><span class="w">        </span><span class="c1">// send write-normal-data command (9 bytes) to controller</span>
<a id="line-7648" name="line-7648"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc5</span><span class="p">);</span><span class="w"> </span><span class="c1">// c5: write normal data</span>
<a id="line-7649" name="line-7649"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span><span class="w"> </span><span class="c1">// HD DR1 DR2</span>
<a id="line-7650" name="line-7650"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">);</span>
<a id="line-7651" name="line-7651"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">head</span><span class="p">);</span>
<a id="line-7652" name="line-7652"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">);</span>
<a id="line-7653" name="line-7653"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 512 byte sector size</span>
<a id="line-7654" name="line-7654"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// last sector to write on track</span>
<a id="line-7655" name="line-7655"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gap length</span>
<a id="line-7656" name="line-7656"></a><span class="w">        </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gap length</span>
<a id="line-7657" name="line-7657"></a>
<a id="line-7658" name="line-7658"></a><span class="w">        </span><span class="c1">// turn on interrupts</span>
<a id="line-7659" name="line-7659"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7660" name="line-7660"></a><span class="w">        </span><span class="n">sti</span>
<a id="line-7661" name="line-7661"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7662" name="line-7662"></a>
<a id="line-7663" name="line-7663"></a><span class="w">        </span><span class="c1">// wait on 40:3e bit 7 to become 1</span>
<a id="line-7664" name="line-7664"></a><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7665" name="line-7665"></a><span class="w">          </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0040</span><span class="p">);</span>
<a id="line-7666" name="line-7666"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7667" name="line-7667"></a><span class="w">            </span><span class="n">floppy_reset_controller</span><span class="p">();</span>
<a id="line-7668" name="line-7668"></a><span class="w">            </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not ready (timeout)</span>
<a id="line-7669" name="line-7669"></a><span class="w">            </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7670" name="line-7670"></a><span class="w">            </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors written</span>
<a id="line-7671" name="line-7671"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7672" name="line-7672"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="line-7673" name="line-7673"></a><span class="w">          </span><span class="p">}</span>
<a id="line-7674" name="line-7674"></a><span class="w">          </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7675" name="line-7675"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-7676" name="line-7676"></a>
<a id="line-7677" name="line-7677"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// separate asm from while() loop</span>
<a id="line-7678" name="line-7678"></a><span class="w">        </span><span class="c1">// turn off interrupts</span>
<a id="line-7679" name="line-7679"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7680" name="line-7680"></a><span class="w">        </span><span class="n">cli</span>
<a id="line-7681" name="line-7681"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7682" name="line-7682"></a>
<a id="line-7683" name="line-7683"></a><span class="w">        </span><span class="c1">// set 40:3e bit 7 to 0</span>
<a id="line-7684" name="line-7684"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7685" name="line-7685"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7686" name="line-7686"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7687" name="line-7687"></a>
<a id="line-7688" name="line-7688"></a><span class="w">        </span><span class="c1">// check port 3f4 for accessibility to status bytes</span>
<a id="line-7689" name="line-7689"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f4</span><span class="p">);</span>
<a id="line-7690" name="line-7690"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"> </span><span class="p">)</span>
<a id="line-7691" name="line-7691"></a><span class="w">          </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_diskette: ctrl not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7692" name="line-7692"></a>
<a id="line-7693" name="line-7693"></a><span class="w">        </span><span class="c1">// read 7 return status bytes from controller</span>
<a id="line-7694" name="line-7694"></a><span class="w">        </span><span class="c1">// using loop index broken, have to unroll...</span>
<a id="line-7695" name="line-7695"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7696" name="line-7696"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7697" name="line-7697"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7698" name="line-7698"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7699" name="line-7699"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7700" name="line-7700"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7701" name="line-7701"></a><span class="w">        </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7702" name="line-7702"></a><span class="w">        </span><span class="c1">// record in BIOS Data Area</span>
<a id="line-7703" name="line-7703"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0042</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="line-7704" name="line-7704"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0043</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="line-7705" name="line-7705"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0044</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="line-7706" name="line-7706"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0045</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<a id="line-7707" name="line-7707"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0046</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<a id="line-7708" name="line-7708"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0047</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<a id="line-7709" name="line-7709"></a><span class="w">        </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0048</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
<a id="line-7710" name="line-7710"></a>
<a id="line-7711" name="line-7711"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7712" name="line-7712"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7713" name="line-7713"></a><span class="w">            </span><span class="c1">// diskette not writable.</span>
<a id="line-7714" name="line-7714"></a><span class="w">            </span><span class="c1">// AH=status code=0x03 (tried to write on write-protected disk)</span>
<a id="line-7715" name="line-7715"></a><span class="w">            </span><span class="c1">// AL=number of sectors written=0</span>
<a id="line-7716" name="line-7716"></a><span class="w">            </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0300</span><span class="p">;</span>
<a id="line-7717" name="line-7717"></a><span class="w">            </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7718" name="line-7718"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="line-7719" name="line-7719"></a><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-7720" name="line-7720"></a><span class="w">            </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_diskette_function: read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7721" name="line-7721"></a><span class="w">          </span><span class="p">}</span>
<a id="line-7722" name="line-7722"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7723" name="line-7723"></a>
<a id="line-7724" name="line-7724"></a><span class="w">        </span><span class="c1">// ??? should track be new val from return_status[3] ?</span>
<a id="line-7725" name="line-7725"></a><span class="w">        </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">);</span>
<a id="line-7726" name="line-7726"></a><span class="w">        </span><span class="c1">// AL = number of sectors read (same value as passed)</span>
<a id="line-7727" name="line-7727"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// success</span>
<a id="line-7728" name="line-7728"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// success</span>
<a id="line-7729" name="line-7729"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7730" name="line-7730"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// if (ah == 0x04)</span>
<a id="line-7731" name="line-7731"></a><span class="w">        </span><span class="c1">// Verify Diskette Sectors</span>
<a id="line-7732" name="line-7732"></a>
<a id="line-7733" name="line-7733"></a><span class="w">        </span><span class="c1">// ??? should track be new val from return_status[3] ?</span>
<a id="line-7734" name="line-7734"></a><span class="w">        </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="p">);</span>
<a id="line-7735" name="line-7735"></a><span class="w">        </span><span class="c1">// AL = number of sectors verified (same value as passed)</span>
<a id="line-7736" name="line-7736"></a><span class="w">        </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w">   </span><span class="c1">// success</span>
<a id="line-7737" name="line-7737"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// success</span>
<a id="line-7738" name="line-7738"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7739" name="line-7739"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7740" name="line-7740"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-7741" name="line-7741"></a>
<a id="line-7742" name="line-7742"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x05</span><span class="p">:</span><span class="w"> </span><span class="c1">// format diskette track</span>
<a id="line-7743" name="line-7743"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f05</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7744" name="line-7744"></a>
<a id="line-7745" name="line-7745"></a><span class="w">      </span><span class="n">num_sectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_AL</span><span class="p">();</span>
<a id="line-7746" name="line-7746"></a><span class="w">      </span><span class="n">track</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GET_CH</span><span class="p">();</span>
<a id="line-7747" name="line-7747"></a><span class="w">      </span><span class="n">head</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">GET_DH</span><span class="p">();</span>
<a id="line-7748" name="line-7748"></a><span class="w">      </span><span class="n">drive</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-7749" name="line-7749"></a>
<a id="line-7750" name="line-7750"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">track</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">79</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="line-7751" name="line-7751"></a><span class="w">          </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">18</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-7752" name="line-7752"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7753" name="line-7753"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-7754" name="line-7754"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7755" name="line-7755"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7756" name="line-7756"></a>
<a id="line-7757" name="line-7757"></a><span class="w">      </span><span class="c1">// see if drive exists</span>
<a id="line-7758" name="line-7758"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_drive_exists</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7759" name="line-7759"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not responding</span>
<a id="line-7760" name="line-7760"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7761" name="line-7761"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7762" name="line-7762"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7763" name="line-7763"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7764" name="line-7764"></a>
<a id="line-7765" name="line-7765"></a><span class="w">      </span><span class="c1">// see if media in drive, and type is known</span>
<a id="line-7766" name="line-7766"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_media_known</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7767" name="line-7767"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">floppy_media_sense</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7768" name="line-7768"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">);</span><span class="w"> </span><span class="c1">// Media type not found</span>
<a id="line-7769" name="line-7769"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">);</span>
<a id="line-7770" name="line-7770"></a><span class="w">          </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7771" name="line-7771"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7772" name="line-7772"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7773" name="line-7773"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7774" name="line-7774"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7775" name="line-7775"></a>
<a id="line-7776" name="line-7776"></a><span class="w">      </span><span class="c1">// set up DMA controller for transfer</span>
<a id="line-7777" name="line-7777"></a><span class="w">      </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">);</span><span class="w">   </span><span class="c1">// upper 4 bits</span>
<a id="line-7778" name="line-7778"></a><span class="w">      </span><span class="n">base_es</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ES</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// lower 16bits contributed by ES</span>
<a id="line-7779" name="line-7779"></a><span class="w">      </span><span class="n">base_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BX</span><span class="p">;</span><span class="w"> </span><span class="c1">// lower 16 bits of address</span>
<a id="line-7780" name="line-7780"></a><span class="w">                                   </span><span class="c1">// contributed by ES:BX</span>
<a id="line-7781" name="line-7781"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_es</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7782" name="line-7782"></a><span class="w">        </span><span class="c1">// in case of carry, adjust page by 1</span>
<a id="line-7783" name="line-7783"></a><span class="w">        </span><span class="n">page</span><span class="o">++</span><span class="p">;</span>
<a id="line-7784" name="line-7784"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7785" name="line-7785"></a><span class="w">      </span><span class="n">base_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">num_sectors</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-7786" name="line-7786"></a>
<a id="line-7787" name="line-7787"></a><span class="w">      </span><span class="c1">// check for 64K boundary overrun</span>
<a id="line-7788" name="line-7788"></a><span class="w">      </span><span class="n">last_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base_count</span><span class="p">;</span>
<a id="line-7789" name="line-7789"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last_addr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">base_address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7790" name="line-7790"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7791" name="line-7791"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span>
<a id="line-7792" name="line-7792"></a><span class="w">        </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// no sectors read</span>
<a id="line-7793" name="line-7793"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7794" name="line-7794"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7795" name="line-7795"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7796" name="line-7796"></a>
<a id="line-7797" name="line-7797"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">);</span>
<a id="line-7798" name="line-7798"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7799" name="line-7799"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="p">);</span>
<a id="line-7800" name="line-7800"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span><span class="w"> </span><span class="n">base_address</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7801" name="line-7801"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// clear flip-flop</span>
<a id="line-7802" name="line-7802"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="p">);</span>
<a id="line-7803" name="line-7803"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0005</span><span class="p">,</span><span class="w"> </span><span class="n">base_count</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-7804" name="line-7804"></a><span class="w">      </span><span class="n">mode_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4a</span><span class="p">;</span><span class="w"> </span><span class="c1">// single mode, increment, autoinit disable,</span>
<a id="line-7805" name="line-7805"></a><span class="w">                            </span><span class="c1">// transfer type=read, channel 2</span>
<a id="line-7806" name="line-7806"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000b</span><span class="p">,</span><span class="w"> </span><span class="n">mode_register</span><span class="p">);</span>
<a id="line-7807" name="line-7807"></a><span class="w">      </span><span class="c1">// port 81: DMA-1 Page Register, channel 2</span>
<a id="line-7808" name="line-7808"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x0081</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<a id="line-7809" name="line-7809"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x000a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">);</span>
<a id="line-7810" name="line-7810"></a>
<a id="line-7811" name="line-7811"></a><span class="w">      </span><span class="c1">// set up floppy controller for transfer</span>
<a id="line-7812" name="line-7812"></a><span class="w">      </span><span class="n">floppy_prepare_controller</span><span class="p">(</span><span class="n">drive</span><span class="p">);</span>
<a id="line-7813" name="line-7813"></a>
<a id="line-7814" name="line-7814"></a><span class="w">      </span><span class="c1">// send format-track command (6 bytes) to controller</span>
<a id="line-7815" name="line-7815"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4d</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4d: format track</span>
<a id="line-7816" name="line-7816"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span><span class="w"> </span><span class="c1">// HD DR1 DR2</span>
<a id="line-7817" name="line-7817"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 512 byte sector size</span>
<a id="line-7818" name="line-7818"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="n">num_sectors</span><span class="p">);</span><span class="w"> </span><span class="c1">// number of sectors per track</span>
<a id="line-7819" name="line-7819"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gap length</span>
<a id="line-7820" name="line-7820"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0x03f5</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">);</span><span class="w"> </span><span class="c1">// Fill byte</span>
<a id="line-7821" name="line-7821"></a><span class="w">      </span><span class="c1">// turn on interrupts</span>
<a id="line-7822" name="line-7822"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7823" name="line-7823"></a><span class="w">      </span><span class="n">sti</span>
<a id="line-7824" name="line-7824"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7825" name="line-7825"></a>
<a id="line-7826" name="line-7826"></a><span class="w">      </span><span class="c1">// wait on 40:3e bit 7 to become 1</span>
<a id="line-7827" name="line-7827"></a><span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="line-7828" name="line-7828"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0040</span><span class="p">);</span>
<a id="line-7829" name="line-7829"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7830" name="line-7830"></a><span class="w">          </span><span class="n">floppy_reset_controller</span><span class="p">();</span>
<a id="line-7831" name="line-7831"></a><span class="w">          </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not ready (timeout)</span>
<a id="line-7832" name="line-7832"></a><span class="w">          </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7833" name="line-7833"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// error occurred</span>
<a id="line-7834" name="line-7834"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7835" name="line-7835"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7836" name="line-7836"></a><span class="w">        </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<a id="line-7837" name="line-7837"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<a id="line-7838" name="line-7838"></a>
<a id="line-7839" name="line-7839"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// separate asm from while() loop</span>
<a id="line-7840" name="line-7840"></a><span class="w">      </span><span class="c1">// turn off interrupts</span>
<a id="line-7841" name="line-7841"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-7842" name="line-7842"></a><span class="w">      </span><span class="n">cli</span>
<a id="line-7843" name="line-7843"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-7844" name="line-7844"></a><span class="w">      </span><span class="c1">// set 40:3e bit 7 to 0</span>
<a id="line-7845" name="line-7845"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">);</span>
<a id="line-7846" name="line-7846"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span>
<a id="line-7847" name="line-7847"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x003e</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-7848" name="line-7848"></a><span class="w">      </span><span class="c1">// check port 3f4 for accessibility to status bytes</span>
<a id="line-7849" name="line-7849"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f4</span><span class="p">);</span>
<a id="line-7850" name="line-7850"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xc0</span><span class="w"> </span><span class="p">)</span>
<a id="line-7851" name="line-7851"></a><span class="w">        </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_diskette: ctrl not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7852" name="line-7852"></a>
<a id="line-7853" name="line-7853"></a><span class="w">      </span><span class="c1">// read 7 return status bytes from controller</span>
<a id="line-7854" name="line-7854"></a><span class="w">      </span><span class="c1">// using loop index broken, have to unroll...</span>
<a id="line-7855" name="line-7855"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7856" name="line-7856"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7857" name="line-7857"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7858" name="line-7858"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7859" name="line-7859"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7860" name="line-7860"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7861" name="line-7861"></a><span class="w">      </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0x3f5</span><span class="p">);</span>
<a id="line-7862" name="line-7862"></a><span class="w">      </span><span class="c1">// record in BIOS Data Area</span>
<a id="line-7863" name="line-7863"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0042</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="line-7864" name="line-7864"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0043</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="line-7865" name="line-7865"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0044</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="line-7866" name="line-7866"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0045</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<a id="line-7867" name="line-7867"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0046</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<a id="line-7868" name="line-7868"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0047</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<a id="line-7869" name="line-7869"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0048</span><span class="p">,</span><span class="w"> </span><span class="n">return_status</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
<a id="line-7870" name="line-7870"></a>
<a id="line-7871" name="line-7871"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">return_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7872" name="line-7872"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">return_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7873" name="line-7873"></a><span class="w">          </span><span class="c1">// diskette not writable.</span>
<a id="line-7874" name="line-7874"></a><span class="w">          </span><span class="c1">// AH=status code=0x03 (tried to write on write-protected disk)</span>
<a id="line-7875" name="line-7875"></a><span class="w">          </span><span class="c1">// AL=number of sectors written=0</span>
<a id="line-7876" name="line-7876"></a><span class="w">          </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0300</span><span class="p">;</span>
<a id="line-7877" name="line-7877"></a><span class="w">          </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7878" name="line-7878"></a><span class="w">          </span><span class="k">return</span><span class="p">;</span>
<a id="line-7879" name="line-7879"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-7880" name="line-7880"></a><span class="w">          </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;int13_diskette_function: write error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7881" name="line-7881"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7882" name="line-7882"></a><span class="w">      </span><span class="p">}</span>
<a id="line-7883" name="line-7883"></a>
<a id="line-7884" name="line-7884"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7885" name="line-7885"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7886" name="line-7886"></a><span class="w">      </span><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-7887" name="line-7887"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// successful</span>
<a id="line-7888" name="line-7888"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7889" name="line-7889"></a>
<a id="line-7890" name="line-7890"></a>
<a id="line-7891" name="line-7891"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x08</span><span class="p">:</span><span class="w"> </span><span class="c1">// read diskette drive parameters</span>
<a id="line-7892" name="line-7892"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f08</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7893" name="line-7893"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-7894" name="line-7894"></a>
<a id="line-7895" name="line-7895"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7896" name="line-7896"></a><span class="w">        </span><span class="n">AX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7897" name="line-7897"></a><span class="w">        </span><span class="n">BX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7898" name="line-7898"></a><span class="w">        </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7899" name="line-7899"></a><span class="w">        </span><span class="n">DX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7900" name="line-7900"></a><span class="w">        </span><span class="n">ES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7901" name="line-7901"></a><span class="w">        </span><span class="n">DI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7902" name="line-7902"></a><span class="w">        </span><span class="n">SET_DL</span><span class="p">(</span><span class="n">num_floppies</span><span class="p">);</span>
<a id="line-7903" name="line-7903"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7904" name="line-7904"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7905" name="line-7905"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7906" name="line-7906"></a>
<a id="line-7907" name="line-7907"></a><span class="w">      </span><span class="n">drive_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-7908" name="line-7908"></a><span class="w">      </span><span class="n">num_floppies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7909" name="line-7909"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">)</span>
<a id="line-7910" name="line-7910"></a><span class="w">        </span><span class="n">num_floppies</span><span class="o">++</span><span class="p">;</span>
<a id="line-7911" name="line-7911"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">)</span>
<a id="line-7912" name="line-7912"></a><span class="w">        </span><span class="n">num_floppies</span><span class="o">++</span><span class="p">;</span>
<a id="line-7913" name="line-7913"></a>
<a id="line-7914" name="line-7914"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-7915" name="line-7915"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-7916" name="line-7916"></a><span class="w">      </span><span class="k">else</span>
<a id="line-7917" name="line-7917"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-7918" name="line-7918"></a>
<a id="line-7919" name="line-7919"></a><span class="w">      </span><span class="n">SET_BH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7920" name="line-7920"></a><span class="w">      </span><span class="n">SET_BL</span><span class="p">(</span><span class="n">drive_type</span><span class="p">);</span>
<a id="line-7921" name="line-7921"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7922" name="line-7922"></a><span class="w">      </span><span class="n">SET_AL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-7923" name="line-7923"></a><span class="w">      </span><span class="n">SET_DL</span><span class="p">(</span><span class="n">num_floppies</span><span class="p">);</span>
<a id="line-7924" name="line-7924"></a>
<a id="line-7925" name="line-7925"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">drive_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7926" name="line-7926"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// none</span>
<a id="line-7927" name="line-7927"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-7928" name="line-7928"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7929" name="line-7929"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7930" name="line-7930"></a>
<a id="line-7931" name="line-7931"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// 360KB, 5.25&quot;</span>
<a id="line-7932" name="line-7932"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2709</span><span class="p">;</span><span class="w"> </span><span class="c1">// 40 tracks, 9 sectors</span>
<a id="line-7933" name="line-7933"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7934" name="line-7934"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7935" name="line-7935"></a>
<a id="line-7936" name="line-7936"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// 1.2MB, 5.25&quot;</span>
<a id="line-7937" name="line-7937"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4f0f</span><span class="p">;</span><span class="w"> </span><span class="c1">// 80 tracks, 15 sectors</span>
<a id="line-7938" name="line-7938"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7939" name="line-7939"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7940" name="line-7940"></a>
<a id="line-7941" name="line-7941"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="c1">// 720KB, 3.5&quot;</span>
<a id="line-7942" name="line-7942"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4f09</span><span class="p">;</span><span class="w"> </span><span class="c1">// 80 tracks, 9 sectors</span>
<a id="line-7943" name="line-7943"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7944" name="line-7944"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7945" name="line-7945"></a>
<a id="line-7946" name="line-7946"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="c1">// 1.44MB, 3.5&quot;</span>
<a id="line-7947" name="line-7947"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4f12</span><span class="p">;</span><span class="w"> </span><span class="c1">// 80 tracks, 18 sectors</span>
<a id="line-7948" name="line-7948"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7949" name="line-7949"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7950" name="line-7950"></a>
<a id="line-7951" name="line-7951"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="c1">// 2.88MB, 3.5&quot;</span>
<a id="line-7952" name="line-7952"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4f24</span><span class="p">;</span><span class="w"> </span><span class="c1">// 80 tracks, 36 sectors</span>
<a id="line-7953" name="line-7953"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7954" name="line-7954"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7955" name="line-7955"></a>
<a id="line-7956" name="line-7956"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="c1">// 160k, 5.25&quot;</span>
<a id="line-7957" name="line-7957"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2708</span><span class="p">;</span><span class="w"> </span><span class="c1">// 40 tracks, 8 sectors</span>
<a id="line-7958" name="line-7958"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7959" name="line-7959"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7960" name="line-7960"></a>
<a id="line-7961" name="line-7961"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="c1">// 180k, 5.25&quot;</span>
<a id="line-7962" name="line-7962"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2709</span><span class="p">;</span><span class="w"> </span><span class="c1">// 40 tracks, 9 sectors</span>
<a id="line-7963" name="line-7963"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7964" name="line-7964"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7965" name="line-7965"></a>
<a id="line-7966" name="line-7966"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="c1">// 320k, 5.25&quot;</span>
<a id="line-7967" name="line-7967"></a><span class="w">          </span><span class="n">CX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2708</span><span class="p">;</span><span class="w"> </span><span class="c1">// 40 tracks, 8 sectors</span>
<a id="line-7968" name="line-7968"></a><span class="w">          </span><span class="n">SET_DH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// max head #</span>
<a id="line-7969" name="line-7969"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="line-7970" name="line-7970"></a>
<a id="line-7971" name="line-7971"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="c1">// ?</span>
<a id="line-7972" name="line-7972"></a><span class="w">          </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;floppy: int13: bad floppy type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7973" name="line-7973"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7974" name="line-7974"></a>
<a id="line-7975" name="line-7975"></a><span class="w">      </span><span class="cm">/* set es &amp; di to point to 11 byte diskette param table in ROM */</span>
<a id="line-7976" name="line-7976"></a><span class="n">ASM_START</span>
<a id="line-7977" name="line-7977"></a><span class="w">      </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-7978" name="line-7978"></a><span class="w">      </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-7979" name="line-7979"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">diskette_param_table2</span>
<a id="line-7980" name="line-7980"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_diskette_function</span><span class="p">.</span><span class="n">DI</span><span class="o">+</span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-7981" name="line-7981"></a><span class="w">      </span><span class="n">mov</span><span class="w"> </span><span class="n">_int13_diskette_function</span><span class="p">.</span><span class="n">ES</span><span class="o">+</span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">cs</span>
<a id="line-7982" name="line-7982"></a><span class="w">      </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-7983" name="line-7983"></a><span class="n">ASM_END</span>
<a id="line-7984" name="line-7984"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// success</span>
<a id="line-7985" name="line-7985"></a><span class="w">      </span><span class="cm">/* disk status not changed upon success */</span>
<a id="line-7986" name="line-7986"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-7987" name="line-7987"></a>
<a id="line-7988" name="line-7988"></a>
<a id="line-7989" name="line-7989"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x15</span><span class="p">:</span><span class="w"> </span><span class="c1">// read diskette drive type</span>
<a id="line-7990" name="line-7990"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f15</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-7991" name="line-7991"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-7992" name="line-7992"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-7993" name="line-7993"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// only 2 drives supported</span>
<a id="line-7994" name="line-7994"></a><span class="w">        </span><span class="c1">// set_diskette_ret_status here ???</span>
<a id="line-7995" name="line-7995"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-7996" name="line-7996"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-7997" name="line-7997"></a><span class="w">        </span><span class="p">}</span>
<a id="line-7998" name="line-7998"></a><span class="w">      </span><span class="n">drive_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<a id="line-7999" name="line-7999"></a>
<a id="line-8000" name="line-8000"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-8001" name="line-8001"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-8002" name="line-8002"></a><span class="w">      </span><span class="k">else</span>
<a id="line-8003" name="line-8003"></a><span class="w">        </span><span class="n">drive_type</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="line-8004" name="line-8004"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span><span class="w"> </span><span class="c1">// successful, not present</span>
<a id="line-8005" name="line-8005"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive_type</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8006" name="line-8006"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive not present</span>
<a id="line-8007" name="line-8007"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8008" name="line-8008"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-8009" name="line-8009"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// drive present, does not support change line</span>
<a id="line-8010" name="line-8010"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8011" name="line-8011"></a>
<a id="line-8012" name="line-8012"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8013" name="line-8013"></a>
<a id="line-8014" name="line-8014"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x16</span><span class="p">:</span><span class="w"> </span><span class="c1">// get diskette change line status</span>
<a id="line-8015" name="line-8015"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f16</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8016" name="line-8016"></a><span class="w">      </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GET_ELDL</span><span class="p">();</span>
<a id="line-8017" name="line-8017"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8018" name="line-8018"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// invalid drive</span>
<a id="line-8019" name="line-8019"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-8020" name="line-8020"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8021" name="line-8021"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-8022" name="line-8022"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8023" name="line-8023"></a>
<a id="line-8024" name="line-8024"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x06</span><span class="p">);</span><span class="w"> </span><span class="c1">// change line not supported</span>
<a id="line-8025" name="line-8025"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mh">0x06</span><span class="p">);</span>
<a id="line-8026" name="line-8026"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8027" name="line-8027"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8028" name="line-8028"></a>
<a id="line-8029" name="line-8029"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x17</span><span class="p">:</span><span class="w"> </span><span class="c1">// set diskette type for format(old)</span>
<a id="line-8030" name="line-8030"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f17</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8031" name="line-8031"></a><span class="w">      </span><span class="cm">/* not used for 1.44M floppies */</span>
<a id="line-8032" name="line-8032"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// not supported</span>
<a id="line-8033" name="line-8033"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="cm">/* not supported */</span>
<a id="line-8034" name="line-8034"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8035" name="line-8035"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8036" name="line-8036"></a>
<a id="line-8037" name="line-8037"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x18</span><span class="p">:</span><span class="w"> </span><span class="c1">// set diskette type for format(new)</span>
<a id="line-8038" name="line-8038"></a><span class="n">BX_DEBUG_INT13_FL</span><span class="p">(</span><span class="s">&quot;floppy f18</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8039" name="line-8039"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// do later</span>
<a id="line-8040" name="line-8040"></a><span class="w">      </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-8041" name="line-8041"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8042" name="line-8042"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8043" name="line-8043"></a>
<a id="line-8044" name="line-8044"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-8045" name="line-8045"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;int13_diskette: unsupported AH=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">());</span>
<a id="line-8046" name="line-8046"></a>
<a id="line-8047" name="line-8047"></a><span class="w">      </span><span class="c1">// if ( (ah==0x20) || ((ah&gt;=0x41) &amp;&amp; (ah&lt;=0x49)) || (ah==0x4e) ) {</span>
<a id="line-8048" name="line-8048"></a><span class="w">        </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// ???</span>
<a id="line-8049" name="line-8049"></a><span class="w">        </span><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="line-8050" name="line-8050"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8051" name="line-8051"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-8052" name="line-8052"></a><span class="w">      </span><span class="c1">//   }</span>
<a id="line-8053" name="line-8053"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8054" name="line-8054"></a><span class="p">}</span>
<a id="line-8055" name="line-8055"></a><span class="cp">#else  </span><span class="c1">// #if BX_SUPPORT_FLOPPY</span>
<a id="line-8056" name="line-8056"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8057" name="line-8057"></a><span class="n">int13_diskette_function</span><span class="p">(</span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">)</span>
<a id="line-8058" name="line-8058"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span><span class="p">;</span>
<a id="line-8059" name="line-8059"></a><span class="p">{</span>
<a id="line-8060" name="line-8060"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">val8</span><span class="p">;</span>
<a id="line-8061" name="line-8061"></a>
<a id="line-8062" name="line-8062"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GET_AH</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8063" name="line-8063"></a>
<a id="line-8064" name="line-8064"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0x01</span><span class="p">:</span><span class="w"> </span><span class="c1">// Read Diskette Status</span>
<a id="line-8065" name="line-8065"></a><span class="w">      </span><span class="n">CLEAR_CF</span><span class="p">();</span>
<a id="line-8066" name="line-8066"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0441</span><span class="p">);</span>
<a id="line-8067" name="line-8067"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="n">val8</span><span class="p">);</span>
<a id="line-8068" name="line-8068"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8069" name="line-8069"></a><span class="w">        </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8070" name="line-8070"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8071" name="line-8071"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8072" name="line-8072"></a>
<a id="line-8073" name="line-8073"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-8074" name="line-8074"></a><span class="w">      </span><span class="n">SET_CF</span><span class="p">();</span>
<a id="line-8075" name="line-8075"></a><span class="w">      </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0441</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-8076" name="line-8076"></a><span class="w">      </span><span class="n">SET_AH</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-8077" name="line-8077"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8078" name="line-8078"></a><span class="p">}</span>
<a id="line-8079" name="line-8079"></a><span class="cp">#endif  </span><span class="c1">// #if BX_SUPPORT_FLOPPY</span>
<a id="line-8080" name="line-8080"></a>
<a id="line-8081" name="line-8081"></a><span class="w"> </span><span class="kt">void</span>
<a id="line-8082" name="line-8082"></a><span class="n">set_diskette_ret_status</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="line-8083" name="line-8083"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<a id="line-8084" name="line-8084"></a><span class="p">{</span>
<a id="line-8085" name="line-8085"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0041</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="line-8086" name="line-8086"></a><span class="p">}</span>
<a id="line-8087" name="line-8087"></a>
<a id="line-8088" name="line-8088"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8089" name="line-8089"></a><span class="n">set_diskette_current_cyl</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">cyl</span><span class="p">)</span>
<a id="line-8090" name="line-8090"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-8091" name="line-8091"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">cyl</span><span class="p">;</span>
<a id="line-8092" name="line-8092"></a><span class="p">{</span>
<a id="line-8093" name="line-8093"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<a id="line-8094" name="line-8094"></a><span class="w">    </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;set_diskette_current_cyl(): drive &gt; 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8095" name="line-8095"></a><span class="w">  </span><span class="n">write_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0094</span><span class="o">+</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">cyl</span><span class="p">);</span>
<a id="line-8096" name="line-8096"></a><span class="p">}</span>
<a id="line-8097" name="line-8097"></a>
<a id="line-8098" name="line-8098"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8099" name="line-8099"></a><span class="n">determine_floppy_media</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="line-8100" name="line-8100"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">drive</span><span class="p">;</span>
<a id="line-8101" name="line-8101"></a><span class="p">{</span>
<a id="line-8102" name="line-8102"></a><span class="cp">#if 0</span>
<a id="line-8103" name="line-8103"></a><span class="c">  Bit8u  val8, DOR, ctrl_info;</span>
<a id="line-8104" name="line-8104"></a>
<a id="line-8105" name="line-8105"></a><span class="c">  ctrl_info = read_byte(0x0040, 0x008F);</span>
<a id="line-8106" name="line-8106"></a><span class="c">  if (drive==1)</span>
<a id="line-8107" name="line-8107"></a><span class="c">    ctrl_info &gt;&gt;= 4;</span>
<a id="line-8108" name="line-8108"></a><span class="c">  else</span>
<a id="line-8109" name="line-8109"></a><span class="c">    ctrl_info &amp;= 0x0f;</span>
<a id="line-8110" name="line-8110"></a>
<a id="line-8111" name="line-8111"></a><span class="cp">#if 0</span>
<a id="line-8112" name="line-8112"></a><span class="c">  if (drive == 0) {</span>
<a id="line-8113" name="line-8113"></a><span class="c">    DOR = 0x1c; // DOR: drive0 motor on, DMA&amp;int enabled, normal op, drive select 0</span>
<a id="line-8114" name="line-8114"></a><span class="c">    }</span>
<a id="line-8115" name="line-8115"></a><span class="c">  else {</span>
<a id="line-8116" name="line-8116"></a><span class="c">    DOR = 0x2d; // DOR: drive1 motor on, DMA&amp;int enabled, normal op, drive select 1</span>
<a id="line-8117" name="line-8117"></a><span class="c">    }</span>
<a id="line-8118" name="line-8118"></a><span class="cp">#endif</span>
<a id="line-8119" name="line-8119"></a>
<a id="line-8120" name="line-8120"></a><span class="c">  if ( (ctrl_info &amp; 0x04) != 0x04 ) {</span>
<a id="line-8121" name="line-8121"></a><span class="c">    // Drive not determined means no drive exists, done.</span>
<a id="line-8122" name="line-8122"></a><span class="c">    return;</span>
<a id="line-8123" name="line-8123"></a><span class="c">    }</span>
<a id="line-8124" name="line-8124"></a>
<a id="line-8125" name="line-8125"></a><span class="cp">#if 0</span>
<a id="line-8126" name="line-8126"></a><span class="c">  // check Main Status Register for readiness</span>
<a id="line-8127" name="line-8127"></a><span class="c">  val8 = inb(0x03f4) &amp; 0x80; // Main Status Register</span>
<a id="line-8128" name="line-8128"></a><span class="c">  if (val8 != 0x80)</span>
<a id="line-8129" name="line-8129"></a><span class="c">    BX_PANIC(&quot;d_f_m: MRQ bit not set\n&quot;);</span>
<a id="line-8130" name="line-8130"></a>
<a id="line-8131" name="line-8131"></a><span class="c">  // change line</span>
<a id="line-8132" name="line-8132"></a>
<a id="line-8133" name="line-8133"></a><span class="c">  // existing BDA values</span>
<a id="line-8134" name="line-8134"></a>
<a id="line-8135" name="line-8135"></a><span class="c">  // turn on drive motor</span>
<a id="line-8136" name="line-8136"></a><span class="c">  outb(0x03f2, DOR); // Digital Output Register</span>
<a id="line-8137" name="line-8137"></a><span class="c">  //</span>
<a id="line-8138" name="line-8138"></a><span class="cp">#endif</span>
<a id="line-8139" name="line-8139"></a><span class="c">  BX_PANIC(&quot;d_f_m: OK so far\n&quot;);</span>
<a id="line-8140" name="line-8140"></a><span class="cp">#endif</span>
<a id="line-8141" name="line-8141"></a><span class="p">}</span>
<a id="line-8142" name="line-8142"></a>
<a id="line-8143" name="line-8143"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8144" name="line-8144"></a><span class="n">int17_function</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">iret_addr</span><span class="p">)</span>
<a id="line-8145" name="line-8145"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// regs pushed from PUSHA instruction</span>
<a id="line-8146" name="line-8146"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="c1">// previous DS:, DS set to 0x0000 by asm wrapper</span>
<a id="line-8147" name="line-8147"></a><span class="w">  </span><span class="n">iret_addr_t</span><span class="w">  </span><span class="n">iret_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// CS,IP,Flags pushed from original INT call</span>
<a id="line-8148" name="line-8148"></a><span class="p">{</span>
<a id="line-8149" name="line-8149"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="n">timeout</span><span class="p">;</span>
<a id="line-8150" name="line-8150"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span>
<a id="line-8151" name="line-8151"></a>
<a id="line-8152" name="line-8152"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-8153" name="line-8153"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-8154" name="line-8154"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-8155" name="line-8155"></a>
<a id="line-8156" name="line-8156"></a><span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<a id="line-8157" name="line-8157"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-8158" name="line-8158"></a><span class="w">    </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0078</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="line-8159" name="line-8159"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8160" name="line-8160"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">);</span>
<a id="line-8161" name="line-8161"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<a id="line-8162" name="line-8162"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// send strobe</span>
<a id="line-8163" name="line-8163"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8164" name="line-8164"></a><span class="w">      </span><span class="n">nop</span>
<a id="line-8165" name="line-8165"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8166" name="line-8166"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-8167" name="line-8167"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x40</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x40</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-8168" name="line-8168"></a><span class="w">        </span><span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
<a id="line-8169" name="line-8169"></a><span class="w">      </span><span class="p">}</span>
<a id="line-8170" name="line-8170"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8171" name="line-8171"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8172" name="line-8172"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
<a id="line-8173" name="line-8173"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0x04</span><span class="p">);</span><span class="w"> </span><span class="c1">// send init</span>
<a id="line-8174" name="line-8174"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8175" name="line-8175"></a><span class="w">      </span><span class="n">nop</span>
<a id="line-8176" name="line-8176"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8177" name="line-8177"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x04</span><span class="p">);</span>
<a id="line-8178" name="line-8178"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8179" name="line-8179"></a><span class="w">    </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a id="line-8180" name="line-8180"></a><span class="w">    </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x48</span><span class="p">);</span>
<a id="line-8181" name="line-8181"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-8182" name="line-8182"></a><span class="w">    </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-8183" name="line-8183"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-8184" name="line-8184"></a><span class="w">    </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// Unsupported</span>
<a id="line-8185" name="line-8185"></a><span class="w">  </span><span class="p">}</span>
<a id="line-8186" name="line-8186"></a><span class="p">}</span>
<a id="line-8187" name="line-8187"></a>
<a id="line-8188" name="line-8188"></a><span class="kt">void</span>
<a id="line-8189" name="line-8189"></a><span class="n">int18_function</span><span class="p">(</span><span class="n">seq_nr</span><span class="p">)</span>
<a id="line-8190" name="line-8190"></a><span class="n">Bit16u</span><span class="w"> </span><span class="n">seq_nr</span><span class="p">;</span>
<a id="line-8191" name="line-8191"></a><span class="p">{</span>
<a id="line-8192" name="line-8192"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ebda_seg</span><span class="o">=</span><span class="n">read_word</span><span class="p">(</span><span class="mh">0x0040</span><span class="p">,</span><span class="mh">0x000E</span><span class="p">);</span>
<a id="line-8193" name="line-8193"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bootdev</span><span class="p">;</span>
<a id="line-8194" name="line-8194"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">bootdrv</span><span class="p">;</span>
<a id="line-8195" name="line-8195"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w">  </span><span class="n">bootchk</span><span class="p">;</span>
<a id="line-8196" name="line-8196"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bootseg</span><span class="p">;</span>
<a id="line-8197" name="line-8197"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bootip</span><span class="p">;</span>
<a id="line-8198" name="line-8198"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="line-8199" name="line-8199"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">bootfirst</span><span class="p">;</span>
<a id="line-8200" name="line-8200"></a>
<a id="line-8201" name="line-8201"></a><span class="w">  </span><span class="n">ipl_entry_t</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="line-8202" name="line-8202"></a>
<a id="line-8203" name="line-8203"></a><span class="w">  </span><span class="c1">// if BX_ELTORITO_BOOT is not defined, old behavior</span>
<a id="line-8204" name="line-8204"></a><span class="w">  </span><span class="c1">//   check bit 5 in CMOS reg 0x2d.  load either 0x00 or 0x80 into DL</span>
<a id="line-8205" name="line-8205"></a><span class="w">  </span><span class="c1">//   in preparation for the intial INT 13h (0=floppy A:, 0x80=C:)</span>
<a id="line-8206" name="line-8206"></a><span class="w">  </span><span class="c1">//     0: system boot sequence, first drive C: then A:</span>
<a id="line-8207" name="line-8207"></a><span class="w">  </span><span class="c1">//     1: system boot sequence, first drive A: then C:</span>
<a id="line-8208" name="line-8208"></a><span class="w">  </span><span class="c1">// else BX_ELTORITO_BOOT is defined</span>
<a id="line-8209" name="line-8209"></a><span class="w">  </span><span class="c1">//   CMOS regs 0x3D and 0x38 contain the boot sequence:</span>
<a id="line-8210" name="line-8210"></a><span class="w">  </span><span class="c1">//     CMOS reg 0x3D &amp; 0x0f : 1st boot device</span>
<a id="line-8211" name="line-8211"></a><span class="w">  </span><span class="c1">//     CMOS reg 0x3D &amp; 0xf0 : 2nd boot device</span>
<a id="line-8212" name="line-8212"></a><span class="w">  </span><span class="c1">//     CMOS reg 0x38 &amp; 0xf0 : 3rd boot device</span>
<a id="line-8213" name="line-8213"></a><span class="w">  </span><span class="c1">//   boot device codes:</span>
<a id="line-8214" name="line-8214"></a><span class="w">  </span><span class="c1">//     0x00 : not defined</span>
<a id="line-8215" name="line-8215"></a><span class="w">  </span><span class="c1">//     0x01 : first floppy</span>
<a id="line-8216" name="line-8216"></a><span class="w">  </span><span class="c1">//     0x02 : first harddrive</span>
<a id="line-8217" name="line-8217"></a><span class="w">  </span><span class="c1">//     0x03 : first cdrom</span>
<a id="line-8218" name="line-8218"></a><span class="w">  </span><span class="c1">//     0x04 - 0x0f : PnP expansion ROMs (e.g. Etherboot)</span>
<a id="line-8219" name="line-8219"></a><span class="w">  </span><span class="c1">//     else : boot failure</span>
<a id="line-8220" name="line-8220"></a>
<a id="line-8221" name="line-8221"></a><span class="w">  </span><span class="c1">// Get the boot sequence</span>
<a id="line-8222" name="line-8222"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-8223" name="line-8223"></a><span class="w">  </span><span class="n">bootdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x3d</span><span class="p">);</span>
<a id="line-8224" name="line-8224"></a><span class="w">  </span><span class="n">bootdev</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">((</span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x38</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="line-8225" name="line-8225"></a><span class="w">  </span><span class="n">bootdev</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seq_nr</span><span class="p">;</span>
<a id="line-8226" name="line-8226"></a><span class="w">  </span><span class="n">bootdev</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xf</span><span class="p">;</span>
<a id="line-8227" name="line-8227"></a>
<a id="line-8228" name="line-8228"></a><span class="w">  </span><span class="cm">/* Read user selected device */</span>
<a id="line-8229" name="line-8229"></a><span class="w">  </span><span class="n">bootfirst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_BOOTFIRST_OFFSET</span><span class="p">);</span>
<a id="line-8230" name="line-8230"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bootfirst</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8231" name="line-8231"></a><span class="w">    </span><span class="n">bootdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bootfirst</span><span class="p">;</span>
<a id="line-8232" name="line-8232"></a><span class="w">    </span><span class="cm">/* User selected device not set */</span>
<a id="line-8233" name="line-8233"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_BOOTFIRST_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">);</span>
<a id="line-8234" name="line-8234"></a><span class="w">    </span><span class="cm">/* Reset boot sequence */</span>
<a id="line-8235" name="line-8235"></a><span class="w">    </span><span class="n">write_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_SEQUENCE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">);</span>
<a id="line-8236" name="line-8236"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bootdev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8237" name="line-8237"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">No bootable device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8238" name="line-8238"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Powering off in 30 seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8239" name="line-8239"></a><span class="n">ASM_START</span>
<a id="line-8240" name="line-8240"></a><span class="w">    </span><span class="n">sti</span>
<a id="line-8241" name="line-8241"></a><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01c9</span>
<a id="line-8242" name="line-8242"></a><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc380</span>
<a id="line-8243" name="line-8243"></a><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x86</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">15</span><span class="o">/</span><span class="mi">86</span><span class="o">:</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="n">CX</span><span class="o">:</span><span class="n">DX</span><span class="w"> </span><span class="n">usec</span><span class="p">.</span>
<a id="line-8244" name="line-8244"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="err">#</span><span class="mh">0x15</span>
<a id="line-8245" name="line-8245"></a><span class="n">ASM_END</span>
<a id="line-8246" name="line-8246"></a><span class="w">    </span><span class="n">bios_printf</span><span class="p">(</span><span class="n">BIOS_PRINTF_HALT</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
<a id="line-8247" name="line-8247"></a><span class="w">  </span><span class="p">}</span>
<a id="line-8248" name="line-8248"></a>
<a id="line-8249" name="line-8249"></a><span class="w">  </span><span class="cm">/* Translate from CMOS runes to an IPL table offset by subtracting 1 */</span>
<a id="line-8250" name="line-8250"></a><span class="w">  </span><span class="n">bootdev</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-8251" name="line-8251"></a><span class="cp">#else</span>
<a id="line-8252" name="line-8252"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seq_nr</span><span class="w"> </span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">BX_PANIC</span><span class="p">(</span><span class="s">&quot;No more boot devices.&quot;</span><span class="p">);</span>
<a id="line-8253" name="line-8253"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x2d</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="n">seq_nr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="line-8254" name="line-8254"></a><span class="w">      </span><span class="cm">/* Boot from floppy if the bit is set or it&#39;s the second boot */</span>
<a id="line-8255" name="line-8255"></a><span class="w">    </span><span class="n">bootdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span>
<a id="line-8256" name="line-8256"></a><span class="w">  </span><span class="k">else</span>
<a id="line-8257" name="line-8257"></a><span class="w">    </span><span class="n">bootdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
<a id="line-8258" name="line-8258"></a><span class="cp">#endif</span>
<a id="line-8259" name="line-8259"></a>
<a id="line-8260" name="line-8260"></a><span class="w">  </span><span class="cm">/* Read the boot device from the IPL table */</span>
<a id="line-8261" name="line-8261"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_boot_vector</span><span class="p">(</span><span class="n">bootdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8262" name="line-8262"></a><span class="w">    </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;Invalid boot device (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bootdev</span><span class="p">);</span>
<a id="line-8263" name="line-8263"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="line-8264" name="line-8264"></a><span class="w">  </span><span class="p">}</span>
<a id="line-8265" name="line-8265"></a>
<a id="line-8266" name="line-8266"></a><span class="w">  </span><span class="cm">/* Do the loading, and set up vector as a far pointer to the boot</span>
<a id="line-8267" name="line-8267"></a><span class="cm">   * address, and bootdrv as the boot drive */</span>
<a id="line-8268" name="line-8268"></a><span class="w">  </span><span class="n">print_boot_device</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">description</span><span class="p">);</span>
<a id="line-8269" name="line-8269"></a>
<a id="line-8270" name="line-8270"></a><span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8271" name="line-8271"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_FLOPPY</span><span class="p">:</span><span class="w"> </span><span class="cm">/* FDD */</span>
<a id="line-8272" name="line-8272"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_HARDDISK</span><span class="p">:</span><span class="w"> </span><span class="cm">/* HDD */</span>
<a id="line-8273" name="line-8273"></a>
<a id="line-8274" name="line-8274"></a><span class="w">    </span><span class="n">bootdrv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IPL_TYPE_HARDDISK</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span>
<a id="line-8275" name="line-8275"></a><span class="w">    </span><span class="n">bootseg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x07c0</span><span class="p">;</span>
<a id="line-8276" name="line-8276"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8277" name="line-8277"></a>
<a id="line-8278" name="line-8278"></a><span class="n">ASM_START</span>
<a id="line-8279" name="line-8279"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-8280" name="line-8280"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-8281" name="line-8281"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8282" name="line-8282"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8283" name="line-8283"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-8284" name="line-8284"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-8285" name="line-8285"></a>
<a id="line-8286" name="line-8286"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">bootdrv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-8287" name="line-8287"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">bootseg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-8288" name="line-8288"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">         </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span>
<a id="line-8289" name="line-8289"></a><span class="w">    </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">         </span><span class="p">;;</span><span class="w"> </span><span class="n">offset</span>
<a id="line-8290" name="line-8290"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">sector</span>
<a id="line-8291" name="line-8291"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">sector</span>
<a id="line-8292" name="line-8292"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="mi">0</span>
<a id="line-8293" name="line-8293"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="mi">1</span>
<a id="line-8294" name="line-8294"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dh</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="mi">0</span>
<a id="line-8295" name="line-8295"></a><span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x13</span><span class="w">          </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">sector</span>
<a id="line-8296" name="line-8296"></a><span class="w">    </span><span class="n">jnc</span><span class="w">  </span><span class="n">int19_load_done</span>
<a id="line-8297" name="line-8297"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0001</span>
<a id="line-8298" name="line-8298"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="n">bp</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8299" name="line-8299"></a>
<a id="line-8300" name="line-8300"></a><span class="nl">int19_load_done</span><span class="p">:</span>
<a id="line-8301" name="line-8301"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-8302" name="line-8302"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">cx</span>
<a id="line-8303" name="line-8303"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-8304" name="line-8304"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-8305" name="line-8305"></a><span class="w">    </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-8306" name="line-8306"></a><span class="n">ASM_END</span>
<a id="line-8307" name="line-8307"></a>
<a id="line-8308" name="line-8308"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8309" name="line-8309"></a><span class="w">      </span><span class="n">print_boot_failure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-8310" name="line-8310"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8311" name="line-8311"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8312" name="line-8312"></a>
<a id="line-8313" name="line-8313"></a><span class="w">    </span><span class="cm">/* Always check the signature on a HDD boot sector; on FDD, only do</span>
<a id="line-8314" name="line-8314"></a><span class="cm">     * the check if the CMOS doesn&#39;t tell us to skip it */</span>
<a id="line-8315" name="line-8315"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IPL_TYPE_FLOPPY</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">((</span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x38</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<a id="line-8316" name="line-8316"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_word</span><span class="p">(</span><span class="n">bootseg</span><span class="p">,</span><span class="mh">0x1fe</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0xaa55</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8317" name="line-8317"></a><span class="w">        </span><span class="n">print_boot_failure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-8318" name="line-8318"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="line-8319" name="line-8319"></a><span class="w">      </span><span class="p">}</span>
<a id="line-8320" name="line-8320"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8321" name="line-8321"></a>
<a id="line-8322" name="line-8322"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-8323" name="line-8323"></a><span class="w">    </span><span class="n">tcpa_add_bootdevice</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">0L</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">bootdrv</span><span class="p">);</span>
<a id="line-8324" name="line-8324"></a><span class="w">    </span><span class="n">tcpa_ipl</span><span class="p">((</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">0L</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="n">bootseg</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">0L</span><span class="p">,(</span><span class="n">Bit32u</span><span class="p">)</span><span class="mf">512L</span><span class="p">);</span><span class="w"> </span><span class="cm">/* specs: 8.2.3 steps 4 and 5 */</span>
<a id="line-8325" name="line-8325"></a><span class="cp">#endif</span>
<a id="line-8326" name="line-8326"></a>
<a id="line-8327" name="line-8327"></a><span class="w">    </span><span class="cm">/* Canonicalize bootseg:bootip */</span>
<a id="line-8328" name="line-8328"></a><span class="w">    </span><span class="n">bootip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bootseg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0fff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-8329" name="line-8329"></a><span class="w">    </span><span class="n">bootseg</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xf000</span><span class="p">;</span>
<a id="line-8330" name="line-8330"></a><span class="w">  </span><span class="k">break</span><span class="p">;</span>
<a id="line-8331" name="line-8331"></a>
<a id="line-8332" name="line-8332"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-8333" name="line-8333"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_CDROM</span><span class="p">:</span><span class="w"> </span><span class="cm">/* CD-ROM */</span>
<a id="line-8334" name="line-8334"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdrom_boot</span><span class="p">();</span>
<a id="line-8335" name="line-8335"></a>
<a id="line-8336" name="line-8336"></a><span class="w">    </span><span class="c1">// If failure</span>
<a id="line-8337" name="line-8337"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00ff</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8338" name="line-8338"></a><span class="w">      </span><span class="n">print_cdromboot_failure</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<a id="line-8339" name="line-8339"></a><span class="w">      </span><span class="n">print_boot_failure</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="line-8340" name="line-8340"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="line-8341" name="line-8341"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8342" name="line-8342"></a>
<a id="line-8343" name="line-8343"></a><span class="w">    </span><span class="n">bootdrv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Bit8u</span><span class="p">)(</span><span class="n">status</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
<a id="line-8344" name="line-8344"></a><span class="w">    </span><span class="n">bootseg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="n">ebda_seg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EbdaData</span><span class="o">-&gt;</span><span class="n">cdemu</span><span class="p">.</span><span class="n">load_segment</span><span class="p">);</span>
<a id="line-8345" name="line-8345"></a>
<a id="line-8346" name="line-8346"></a><span class="w">    </span><span class="cm">/* Canonicalize bootseg:bootip */</span>
<a id="line-8347" name="line-8347"></a><span class="w">    </span><span class="n">bootip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bootseg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0fff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="line-8348" name="line-8348"></a><span class="w">    </span><span class="n">bootseg</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xf000</span><span class="p">;</span>
<a id="line-8349" name="line-8349"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<a id="line-8350" name="line-8350"></a><span class="cp">#endif</span>
<a id="line-8351" name="line-8351"></a>
<a id="line-8352" name="line-8352"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">IPL_TYPE_BEV</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Expansion ROM with a Bootstrap Entry Vector (a far pointer) */</span>
<a id="line-8353" name="line-8353"></a><span class="w">    </span><span class="n">bootseg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">vector</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="line-8354" name="line-8354"></a><span class="w">    </span><span class="n">bootip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">;</span>
<a id="line-8355" name="line-8355"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<a id="line-8356" name="line-8356"></a>
<a id="line-8357" name="line-8357"></a><span class="w">  </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<a id="line-8358" name="line-8358"></a><span class="w">  </span><span class="p">}</span>
<a id="line-8359" name="line-8359"></a>
<a id="line-8360" name="line-8360"></a><span class="w">  </span><span class="cm">/* Debugging info */</span>
<a id="line-8361" name="line-8361"></a><span class="w">  </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;Booting from %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bootseg</span><span class="p">,</span><span class="w"> </span><span class="n">bootip</span><span class="p">);</span>
<a id="line-8362" name="line-8362"></a>
<a id="line-8363" name="line-8363"></a><span class="w">  </span><span class="cm">/* Jump to the boot vector */</span>
<a id="line-8364" name="line-8364"></a><span class="n">ASM_START</span>
<a id="line-8365" name="line-8365"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-8366" name="line-8366"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">cs</span>
<a id="line-8367" name="line-8367"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="n">int18_handler</span>
<a id="line-8368" name="line-8368"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">iret</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">vector</span><span class="p">.</span>
<a id="line-8369" name="line-8369"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">iret</span><span class="w"> </span><span class="n">pops</span><span class="w"> </span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">opposite</span><span class="w"> </span><span class="n">order</span><span class="p">.</span>
<a id="line-8370" name="line-8370"></a><span class="w">    </span><span class="n">pushf</span>
<a id="line-8371" name="line-8371"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">bootseg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-8372" name="line-8372"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8373" name="line-8373"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">bootip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-8374" name="line-8374"></a><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8375" name="line-8375"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">magic</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">dl</span><span class="p">.</span>
<a id="line-8376" name="line-8376"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xaa55</span>
<a id="line-8377" name="line-8377"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">_int18_function</span><span class="p">.</span><span class="n">bootdrv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-8378" name="line-8378"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">registers</span><span class="p">.</span>
<a id="line-8379" name="line-8379"></a><span class="w">    </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8380" name="line-8380"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8381" name="line-8381"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8382" name="line-8382"></a><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8383" name="line-8383"></a><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Go</span><span class="o">!</span>
<a id="line-8384" name="line-8384"></a><span class="w">    </span><span class="n">iret</span>
<a id="line-8385" name="line-8385"></a><span class="n">ASM_END</span>
<a id="line-8386" name="line-8386"></a><span class="p">}</span>
<a id="line-8387" name="line-8387"></a>
<a id="line-8388" name="line-8388"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8389" name="line-8389"></a><span class="n">int1a_function</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">iret_addr</span><span class="p">)</span>
<a id="line-8390" name="line-8390"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// regs pushed from PUSHA instruction</span>
<a id="line-8391" name="line-8391"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="c1">// previous DS:, DS set to 0x0000 by asm wrapper</span>
<a id="line-8392" name="line-8392"></a><span class="w">  </span><span class="n">iret_addr_t</span><span class="w">  </span><span class="n">iret_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// CS,IP,Flags pushed from original INT call</span>
<a id="line-8393" name="line-8393"></a><span class="p">{</span>
<a id="line-8394" name="line-8394"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span>
<a id="line-8395" name="line-8395"></a>
<a id="line-8396" name="line-8396"></a><span class="w">  </span><span class="n">BX_DEBUG_INT1A</span><span class="p">(</span><span class="s">&quot;int1a: AX=%04x BX=%04x CX=%04x DX=%04x DS=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">);</span>
<a id="line-8397" name="line-8397"></a>
<a id="line-8398" name="line-8398"></a><span class="w">  </span><span class="n">ASM_START</span>
<a id="line-8399" name="line-8399"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-8400" name="line-8400"></a><span class="w">  </span><span class="n">ASM_END</span>
<a id="line-8401" name="line-8401"></a>
<a id="line-8402" name="line-8402"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8403" name="line-8403"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// get current clock count</span>
<a id="line-8404" name="line-8404"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8405" name="line-8405"></a><span class="w">      </span><span class="n">cli</span>
<a id="line-8406" name="line-8406"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8407" name="line-8407"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">ticks_high</span><span class="p">;</span>
<a id="line-8408" name="line-8408"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">ticks_low</span><span class="p">;</span>
<a id="line-8409" name="line-8409"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">midnight_flag</span><span class="p">;</span>
<a id="line-8410" name="line-8410"></a><span class="w">      </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">midnight_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// reset flag</span>
<a id="line-8411" name="line-8411"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8412" name="line-8412"></a><span class="w">      </span><span class="n">sti</span>
<a id="line-8413" name="line-8413"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8414" name="line-8414"></a><span class="w">      </span><span class="c1">// AH already 0</span>
<a id="line-8415" name="line-8415"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8416" name="line-8416"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8417" name="line-8417"></a>
<a id="line-8418" name="line-8418"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Current Clock Count</span>
<a id="line-8419" name="line-8419"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8420" name="line-8420"></a><span class="w">      </span><span class="n">cli</span>
<a id="line-8421" name="line-8421"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8422" name="line-8422"></a><span class="w">      </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">ticks_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
<a id="line-8423" name="line-8423"></a><span class="w">      </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">ticks_low</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">;</span>
<a id="line-8424" name="line-8424"></a><span class="w">      </span><span class="n">BiosData</span><span class="o">-&gt;</span><span class="n">midnight_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// reset flag</span>
<a id="line-8425" name="line-8425"></a><span class="w">      </span><span class="n">ASM_START</span>
<a id="line-8426" name="line-8426"></a><span class="w">      </span><span class="n">sti</span>
<a id="line-8427" name="line-8427"></a><span class="w">      </span><span class="n">ASM_END</span>
<a id="line-8428" name="line-8428"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8429" name="line-8429"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8430" name="line-8430"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8431" name="line-8431"></a>
<a id="line-8432" name="line-8432"></a>
<a id="line-8433" name="line-8433"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// Read CMOS Time</span>
<a id="line-8434" name="line-8434"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtc_updating</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-8435" name="line-8435"></a><span class="w">        </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-8436" name="line-8436"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-8437" name="line-8437"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8438" name="line-8438"></a>
<a id="line-8439" name="line-8439"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="c1">// Seconds</span>
<a id="line-8440" name="line-8440"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span><span class="w"> </span><span class="c1">// Minutes</span>
<a id="line-8441" name="line-8441"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span><span class="w"> </span><span class="c1">// Hours</span>
<a id="line-8442" name="line-8442"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span><span class="w"> </span><span class="c1">// Stat Reg B</span>
<a id="line-8443" name="line-8443"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8444" name="line-8444"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="p">;</span>
<a id="line-8445" name="line-8445"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8446" name="line-8446"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8447" name="line-8447"></a>
<a id="line-8448" name="line-8448"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set CMOS Time</span>
<a id="line-8449" name="line-8449"></a><span class="w">      </span><span class="c1">// Using a debugger, I notice the following masking/setting</span>
<a id="line-8450" name="line-8450"></a><span class="w">      </span><span class="c1">// of bits in Status Register B, by setting Reg B to</span>
<a id="line-8451" name="line-8451"></a><span class="w">      </span><span class="c1">// a few values and getting its value after INT 1A was called.</span>
<a id="line-8452" name="line-8452"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8453" name="line-8453"></a><span class="w">      </span><span class="c1">//        try#1       try#2       try#3</span>
<a id="line-8454" name="line-8454"></a><span class="w">      </span><span class="c1">// before 1111 1101   0111 1101   0000 0000</span>
<a id="line-8455" name="line-8455"></a><span class="w">      </span><span class="c1">// after  0110 0010   0110 0010   0000 0010</span>
<a id="line-8456" name="line-8456"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8457" name="line-8457"></a><span class="w">      </span><span class="c1">// Bit4 in try#1 flipped in hardware (forced low) due to bit7=1</span>
<a id="line-8458" name="line-8458"></a><span class="w">      </span><span class="c1">// My assumption: RegB = ((RegB &amp; 01100000b) | 00000010b)</span>
<a id="line-8459" name="line-8459"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtc_updating</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-8460" name="line-8460"></a><span class="w">        </span><span class="n">init_rtc</span><span class="p">();</span>
<a id="line-8461" name="line-8461"></a><span class="w">        </span><span class="c1">// fall through as if an update were not in progress</span>
<a id="line-8462" name="line-8462"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8463" name="line-8463"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="p">);</span><span class="w"> </span><span class="c1">// Seconds</span>
<a id="line-8464" name="line-8464"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="p">);</span><span class="w"> </span><span class="c1">// Minutes</span>
<a id="line-8465" name="line-8465"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="p">);</span><span class="w"> </span><span class="c1">// Hours</span>
<a id="line-8466" name="line-8466"></a><span class="w">      </span><span class="c1">// Set Daylight Savings time enabled bit to requested value</span>
<a id="line-8467" name="line-8467"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x60</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">);</span>
<a id="line-8468" name="line-8468"></a><span class="w">      </span><span class="c1">// (reg B already selected)</span>
<a id="line-8469" name="line-8469"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-8470" name="line-8470"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8471" name="line-8471"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span><span class="w"> </span><span class="c1">// val last written to Reg B</span>
<a id="line-8472" name="line-8472"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8473" name="line-8473"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8474" name="line-8474"></a>
<a id="line-8475" name="line-8475"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="c1">// Read CMOS Date</span>
<a id="line-8476" name="line-8476"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8477" name="line-8477"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtc_updating</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-8478" name="line-8478"></a><span class="w">        </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-8479" name="line-8479"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-8480" name="line-8480"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8481" name="line-8481"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x09</span><span class="p">);</span><span class="w"> </span><span class="c1">// Year</span>
<a id="line-8482" name="line-8482"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x08</span><span class="p">);</span><span class="w"> </span><span class="c1">// Month</span>
<a id="line-8483" name="line-8483"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x07</span><span class="p">);</span><span class="w"> </span><span class="c1">// Day of Month</span>
<a id="line-8484" name="line-8484"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x32</span><span class="p">);</span><span class="w"> </span><span class="c1">// Century</span>
<a id="line-8485" name="line-8485"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="p">;</span>
<a id="line-8486" name="line-8486"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8487" name="line-8487"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8488" name="line-8488"></a>
<a id="line-8489" name="line-8489"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set CMOS Date</span>
<a id="line-8490" name="line-8490"></a><span class="w">      </span><span class="c1">// Using a debugger, I notice the following masking/setting</span>
<a id="line-8491" name="line-8491"></a><span class="w">      </span><span class="c1">// of bits in Status Register B, by setting Reg B to</span>
<a id="line-8492" name="line-8492"></a><span class="w">      </span><span class="c1">// a few values and getting its value after INT 1A was called.</span>
<a id="line-8493" name="line-8493"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8494" name="line-8494"></a><span class="w">      </span><span class="c1">//        try#1       try#2       try#3       try#4</span>
<a id="line-8495" name="line-8495"></a><span class="w">      </span><span class="c1">// before 1111 1101   0111 1101   0000 0010   0000 0000</span>
<a id="line-8496" name="line-8496"></a><span class="w">      </span><span class="c1">// after  0110 1101   0111 1101   0000 0010   0000 0000</span>
<a id="line-8497" name="line-8497"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8498" name="line-8498"></a><span class="w">      </span><span class="c1">// Bit4 in try#1 flipped in hardware (forced low) due to bit7=1</span>
<a id="line-8499" name="line-8499"></a><span class="w">      </span><span class="c1">// My assumption: RegB = (RegB &amp; 01111111b)</span>
<a id="line-8500" name="line-8500"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtc_updating</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-8501" name="line-8501"></a><span class="w">        </span><span class="n">init_rtc</span><span class="p">();</span>
<a id="line-8502" name="line-8502"></a><span class="w">        </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-8503" name="line-8503"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-8504" name="line-8504"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8505" name="line-8505"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="p">);</span><span class="w"> </span><span class="c1">// Year</span>
<a id="line-8506" name="line-8506"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="p">);</span><span class="w"> </span><span class="c1">// Month</span>
<a id="line-8507" name="line-8507"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dl</span><span class="p">);</span><span class="w"> </span><span class="c1">// Day of Month</span>
<a id="line-8508" name="line-8508"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x32</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="p">);</span><span class="w"> </span><span class="c1">// Century</span>
<a id="line-8509" name="line-8509"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">;</span><span class="w"> </span><span class="c1">// clear halt-clock bit</span>
<a id="line-8510" name="line-8510"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="p">);</span>
<a id="line-8511" name="line-8511"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8512" name="line-8512"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span><span class="w"> </span><span class="c1">// AL = val last written to Reg B</span>
<a id="line-8513" name="line-8513"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8514" name="line-8514"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8515" name="line-8515"></a>
<a id="line-8516" name="line-8516"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="c1">// Set Alarm Time in CMOS</span>
<a id="line-8517" name="line-8517"></a><span class="w">      </span><span class="c1">// Using a debugger, I notice the following masking/setting</span>
<a id="line-8518" name="line-8518"></a><span class="w">      </span><span class="c1">// of bits in Status Register B, by setting Reg B to</span>
<a id="line-8519" name="line-8519"></a><span class="w">      </span><span class="c1">// a few values and getting its value after INT 1A was called.</span>
<a id="line-8520" name="line-8520"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8521" name="line-8521"></a><span class="w">      </span><span class="c1">//        try#1       try#2       try#3</span>
<a id="line-8522" name="line-8522"></a><span class="w">      </span><span class="c1">// before 1101 1111   0101 1111   0000 0000</span>
<a id="line-8523" name="line-8523"></a><span class="w">      </span><span class="c1">// after  0110 1111   0111 1111   0010 0000</span>
<a id="line-8524" name="line-8524"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8525" name="line-8525"></a><span class="w">      </span><span class="c1">// Bit4 in try#1 flipped in hardware (forced low) due to bit7=1</span>
<a id="line-8526" name="line-8526"></a><span class="w">      </span><span class="c1">// My assumption: RegB = ((RegB &amp; 01111111b) | 00100000b)</span>
<a id="line-8527" name="line-8527"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">);</span><span class="w"> </span><span class="c1">// Get Status Reg B</span>
<a id="line-8528" name="line-8528"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8529" name="line-8529"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8530" name="line-8530"></a><span class="w">        </span><span class="c1">// Alarm interrupt enabled already</span>
<a id="line-8531" name="line-8531"></a><span class="w">        </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// Error: alarm in use</span>
<a id="line-8532" name="line-8532"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="line-8533" name="line-8533"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8534" name="line-8534"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtc_updating</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="line-8535" name="line-8535"></a><span class="w">        </span><span class="n">init_rtc</span><span class="p">();</span>
<a id="line-8536" name="line-8536"></a><span class="w">        </span><span class="c1">// fall through as if an update were not in progress</span>
<a id="line-8537" name="line-8537"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8538" name="line-8538"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">dh</span><span class="p">);</span><span class="w"> </span><span class="c1">// Seconds alarm</span>
<a id="line-8539" name="line-8539"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="p">);</span><span class="w"> </span><span class="c1">// Minutes alarm</span>
<a id="line-8540" name="line-8540"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ch</span><span class="p">);</span><span class="w"> </span><span class="c1">// Hours alarm</span>
<a id="line-8541" name="line-8541"></a><span class="w">      </span><span class="n">outb</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="n">inb</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">);</span><span class="w"> </span><span class="c1">// enable IRQ 8</span>
<a id="line-8542" name="line-8542"></a><span class="w">      </span><span class="c1">// enable Status Reg B alarm bit, clear halt clock bit</span>
<a id="line-8543" name="line-8543"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x20</span><span class="p">);</span>
<a id="line-8544" name="line-8544"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8545" name="line-8545"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8546" name="line-8546"></a>
<a id="line-8547" name="line-8547"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="c1">// Turn off Alarm</span>
<a id="line-8548" name="line-8548"></a><span class="w">      </span><span class="c1">// Using a debugger, I notice the following masking/setting</span>
<a id="line-8549" name="line-8549"></a><span class="w">      </span><span class="c1">// of bits in Status Register B, by setting Reg B to</span>
<a id="line-8550" name="line-8550"></a><span class="w">      </span><span class="c1">// a few values and getting its value after INT 1A was called.</span>
<a id="line-8551" name="line-8551"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8552" name="line-8552"></a><span class="w">      </span><span class="c1">//        try#1       try#2       try#3       try#4</span>
<a id="line-8553" name="line-8553"></a><span class="w">      </span><span class="c1">// before 1111 1101   0111 1101   0010 0000   0010 0010</span>
<a id="line-8554" name="line-8554"></a><span class="w">      </span><span class="c1">// after  0100 0101   0101 0101   0000 0000   0000 0010</span>
<a id="line-8555" name="line-8555"></a><span class="w">      </span><span class="c1">//</span>
<a id="line-8556" name="line-8556"></a><span class="w">      </span><span class="c1">// Bit4 in try#1 flipped in hardware (forced low) due to bit7=1</span>
<a id="line-8557" name="line-8557"></a><span class="w">      </span><span class="c1">// My assumption: RegB = (RegB &amp; 01010111b)</span>
<a id="line-8558" name="line-8558"></a><span class="w">      </span><span class="n">val8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">);</span><span class="w"> </span><span class="c1">// Get Status Reg B</span>
<a id="line-8559" name="line-8559"></a><span class="w">      </span><span class="c1">// clear clock-halt bit, disable alarm bit</span>
<a id="line-8560" name="line-8560"></a><span class="w">      </span><span class="n">outb_cmos</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="n">val8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x57</span><span class="p">);</span><span class="w"> </span><span class="c1">// disable alarm bit</span>
<a id="line-8561" name="line-8561"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8562" name="line-8562"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val8</span><span class="p">;</span><span class="w"> </span><span class="c1">// val last written to Reg B</span>
<a id="line-8563" name="line-8563"></a><span class="w">      </span><span class="n">ClearCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// OK</span>
<a id="line-8564" name="line-8564"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8565" name="line-8565"></a><span class="cp">#if BX_PCIBIOS</span>
<a id="line-8566" name="line-8566"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mh">0xb1</span><span class="p">:</span>
<a id="line-8567" name="line-8567"></a><span class="w">      </span><span class="c1">// real mode PCI BIOS functions now handled in assembler code</span>
<a id="line-8568" name="line-8568"></a><span class="w">      </span><span class="c1">// this C code handles the error code for information only</span>
<a id="line-8569" name="line-8569"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8570" name="line-8570"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;PCI BIOS: PCI not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="line-8571" name="line-8571"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x81</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8572" name="line-8572"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;unsupported PCI BIOS function 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="p">);</span>
<a id="line-8573" name="line-8573"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x83</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8574" name="line-8574"></a><span class="w">        </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;bad PCI vendor ID %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">);</span>
<a id="line-8575" name="line-8575"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x86</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8576" name="line-8576"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">al</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8577" name="line-8577"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;PCI device %04x:%04x not found at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="p">);</span>
<a id="line-8578" name="line-8578"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-8579" name="line-8579"></a><span class="w">          </span><span class="n">BX_INFO</span><span class="p">(</span><span class="s">&quot;no PCI device with class code 0x%02x%04x found at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r16</span><span class="p">.</span><span class="n">si</span><span class="p">);</span>
<a id="line-8580" name="line-8580"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8581" name="line-8581"></a><span class="w">      </span><span class="p">}</span>
<a id="line-8582" name="line-8582"></a><span class="w">      </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">ah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">r8</span><span class="p">.</span><span class="n">bl</span><span class="p">;</span>
<a id="line-8583" name="line-8583"></a><span class="w">      </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<a id="line-8584" name="line-8584"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="line-8585" name="line-8585"></a><span class="cp">#endif</span>
<a id="line-8586" name="line-8586"></a>
<a id="line-8587" name="line-8587"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="line-8588" name="line-8588"></a><span class="w">      </span><span class="n">SetCF</span><span class="p">(</span><span class="n">iret_addr</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span><span class="w"> </span><span class="c1">// Unsupported</span>
<a id="line-8589" name="line-8589"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8590" name="line-8590"></a><span class="p">}</span>
<a id="line-8591" name="line-8591"></a>
<a id="line-8592" name="line-8592"></a><span class="w">  </span><span class="kt">void</span>
<a id="line-8593" name="line-8593"></a><span class="n">int70_function</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">iret_addr</span><span class="p">)</span>
<a id="line-8594" name="line-8594"></a><span class="w">  </span><span class="n">pusha_regs_t</span><span class="w"> </span><span class="n">regs</span><span class="p">;</span><span class="w"> </span><span class="c1">// regs pushed from PUSHA instruction</span>
<a id="line-8595" name="line-8595"></a><span class="w">  </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="c1">// previous DS:, DS set to 0x0000 by asm wrapper</span>
<a id="line-8596" name="line-8596"></a><span class="w">  </span><span class="n">iret_addr_t</span><span class="w">  </span><span class="n">iret_addr</span><span class="p">;</span><span class="w"> </span><span class="c1">// CS,IP,Flags pushed from original INT call</span>
<a id="line-8597" name="line-8597"></a><span class="p">{</span>
<a id="line-8598" name="line-8598"></a><span class="w">  </span><span class="c1">// INT 70h: IRQ 8 - CMOS RTC interrupt from periodic or alarm modes</span>
<a id="line-8599" name="line-8599"></a><span class="w">  </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">registerB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">registerC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-8600" name="line-8600"></a>
<a id="line-8601" name="line-8601"></a><span class="w">  </span><span class="c1">// Check which modes are enabled and have occurred.</span>
<a id="line-8602" name="line-8602"></a><span class="w">  </span><span class="n">registerB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="w"> </span><span class="p">);</span>
<a id="line-8603" name="line-8603"></a><span class="w">  </span><span class="n">registerC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xC</span><span class="w"> </span><span class="p">);</span>
<a id="line-8604" name="line-8604"></a>
<a id="line-8605" name="line-8605"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">registerB</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8606" name="line-8606"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">registerC</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8607" name="line-8607"></a><span class="w">      </span><span class="c1">// Handle Alarm Interrupt.</span>
<a id="line-8608" name="line-8608"></a><span class="n">ASM_START</span>
<a id="line-8609" name="line-8609"></a><span class="w">      </span><span class="n">sti</span>
<a id="line-8610" name="line-8610"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="err">#</span><span class="mh">0x4a</span>
<a id="line-8611" name="line-8611"></a><span class="w">      </span><span class="n">cli</span>
<a id="line-8612" name="line-8612"></a><span class="n">ASM_END</span>
<a id="line-8613" name="line-8613"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8614" name="line-8614"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">registerC</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x40</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8615" name="line-8615"></a><span class="w">      </span><span class="c1">// Handle Periodic Interrupt.</span>
<a id="line-8616" name="line-8616"></a>
<a id="line-8617" name="line-8617"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8618" name="line-8618"></a><span class="w">        </span><span class="c1">// Wait Interval (Int 15, AH=83) active.</span>
<a id="line-8619" name="line-8619"></a><span class="w">        </span><span class="n">Bit32u</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">toggle</span><span class="p">;</span>
<a id="line-8620" name="line-8620"></a>
<a id="line-8621" name="line-8621"></a><span class="w">        </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_dword</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9C</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Time left in microseconds.</span>
<a id="line-8622" name="line-8622"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x3D1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-8623" name="line-8623"></a><span class="w">          </span><span class="c1">// Done waiting.</span>
<a id="line-8624" name="line-8624"></a><span class="w">          </span><span class="n">Bit16u</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="line-8625" name="line-8625"></a>
<a id="line-8626" name="line-8626"></a><span class="w">          </span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="w"> </span><span class="p">);</span>
<a id="line-8627" name="line-8627"></a><span class="w">          </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_word</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9A</span><span class="w"> </span><span class="p">);</span>
<a id="line-8628" name="line-8628"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Turn of status byte.</span>
<a id="line-8629" name="line-8629"></a><span class="w">          </span><span class="n">outb_cmos</span><span class="p">(</span><span class="w"> </span><span class="mh">0xB</span><span class="p">,</span><span class="w"> </span><span class="n">registerB</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x37</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// Clear the Periodic Interrupt.</span>
<a id="line-8630" name="line-8630"></a><span class="w">          </span><span class="n">write_byte</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">read_byte</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="p">);</span><span class="w">  </span><span class="c1">// Write to specified flag byte.</span>
<a id="line-8631" name="line-8631"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-8632" name="line-8632"></a><span class="w">          </span><span class="c1">// Continue waiting.</span>
<a id="line-8633" name="line-8633"></a><span class="w">          </span><span class="n">time</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x3D1</span><span class="p">;</span>
<a id="line-8634" name="line-8634"></a><span class="w">          </span><span class="n">write_dword</span><span class="p">(</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9C</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="p">);</span>
<a id="line-8635" name="line-8635"></a><span class="w">        </span><span class="p">}</span>
<a id="line-8636" name="line-8636"></a><span class="w">      </span><span class="p">}</span>
<a id="line-8637" name="line-8637"></a><span class="w">    </span><span class="p">}</span>
<a id="line-8638" name="line-8638"></a><span class="w">  </span><span class="p">}</span>
<a id="line-8639" name="line-8639"></a>
<a id="line-8640" name="line-8640"></a><span class="n">ASM_START</span>
<a id="line-8641" name="line-8641"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_both_pics</span>
<a id="line-8642" name="line-8642"></a><span class="n">ASM_END</span>
<a id="line-8643" name="line-8643"></a><span class="p">}</span>
<a id="line-8644" name="line-8644"></a>
<a id="line-8645" name="line-8645"></a>
<a id="line-8646" name="line-8646"></a><span class="n">ASM_START</span>
<a id="line-8647" name="line-8647"></a><span class="p">;</span><span class="o">------------------------------------------</span>
<a id="line-8648" name="line-8648"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT74h</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PS</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="n">mouse</span><span class="w"> </span><span class="n">hardware</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="o">-</span>
<a id="line-8649" name="line-8649"></a><span class="p">;</span><span class="o">------------------------------------------</span>
<a id="line-8650" name="line-8650"></a><span class="nl">int74_handler</span><span class="p">:</span>
<a id="line-8651" name="line-8651"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-8652" name="line-8652"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-8653" name="line-8653"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span><span class="w">         </span><span class="p">;;</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">DS</span>
<a id="line-8654" name="line-8654"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">status</span>
<a id="line-8655" name="line-8655"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">X</span>
<a id="line-8656" name="line-8656"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Y</span>
<a id="line-8657" name="line-8657"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Z</span>
<a id="line-8658" name="line-8658"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">make_far_call</span><span class="w"> </span><span class="n">boolean</span>
<a id="line-8659" name="line-8659"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int74_function</span>
<a id="line-8660" name="line-8660"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">cx</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">make_far_call</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stack</span>
<a id="line-8661" name="line-8661"></a><span class="w">  </span><span class="n">jcxz</span><span class="w"> </span><span class="n">int74_done</span>
<a id="line-8662" name="line-8662"></a>
<a id="line-8663" name="line-8663"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">EBDA</span><span class="o">:</span><span class="mo">0022</span>
<a id="line-8664" name="line-8664"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-8665" name="line-8665"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-8666" name="line-8666"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="mh">0x040E</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="mo">0000</span><span class="o">:</span><span class="mo">040</span><span class="n">E</span><span class="w"> </span><span class="p">(</span><span class="n">opcodes</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x36</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0E</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span>
<a id="line-8667" name="line-8667"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-8668" name="line-8668"></a><span class="w">  </span><span class="c1">//CALL_EP(0x0022) ;; call far routine (call_Ep DS:0022 :opcodes 0xff, 0x1e, 0x22, 0x00)</span>
<a id="line-8669" name="line-8669"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="mh">0x22</span><span class="p">]</span>
<a id="line-8670" name="line-8670"></a><span class="nl">int74_done</span><span class="p">:</span>
<a id="line-8671" name="line-8671"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-8672" name="line-8672"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_both_pics</span>
<a id="line-8673" name="line-8673"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>
<a id="line-8674" name="line-8674"></a>
<a id="line-8675" name="line-8675"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span><span class="w">          </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">DS</span>
<a id="line-8676" name="line-8676"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-8677" name="line-8677"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-8678" name="line-8678"></a>
<a id="line-8679" name="line-8679"></a>
<a id="line-8680" name="line-8680"></a><span class="p">;;</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">perform</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">IRET</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">retain</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">CF</span>
<a id="line-8681" name="line-8681"></a><span class="p">;;</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">altering</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stack</span><span class="p">.</span><span class="w">  </span><span class="n">Better</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">RETF</span><span class="w"> </span><span class="err">#</span><span class="mf">02.</span>
<a id="line-8682" name="line-8682"></a><span class="nl">iret_modify_cf</span><span class="p">:</span>
<a id="line-8683" name="line-8683"></a><span class="w">  </span><span class="n">jc</span><span class="w">   </span><span class="n">carry_set</span>
<a id="line-8684" name="line-8684"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-8685" name="line-8685"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-8686" name="line-8686"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x06</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfe</span>
<a id="line-8687" name="line-8687"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-8688" name="line-8688"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-8689" name="line-8689"></a><span class="nl">carry_set</span><span class="p">:</span>
<a id="line-8690" name="line-8690"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-8691" name="line-8691"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-8692" name="line-8692"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x06</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-8693" name="line-8693"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-8694" name="line-8694"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-8695" name="line-8695"></a>
<a id="line-8696" name="line-8696"></a>
<a id="line-8697" name="line-8697"></a><span class="p">;</span><span class="o">----------------------</span>
<a id="line-8698" name="line-8698"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT13h</span><span class="w"> </span><span class="p">(</span><span class="n">relocated</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<a id="line-8699" name="line-8699"></a><span class="p">;</span><span class="o">----------------------</span>
<a id="line-8700" name="line-8700"></a><span class="p">;</span>
<a id="line-8701" name="line-8701"></a><span class="p">;</span><span class="w"> </span><span class="n">int13_relocated</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">messed</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">played</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">it</span>
<a id="line-8702" name="line-8702"></a><span class="p">;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rewrite</span><span class="w"> </span><span class="n">it</span><span class="o">:</span>
<a id="line-8703" name="line-8703"></a><span class="p">;</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">detect</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">call</span>
<a id="line-8704" name="line-8704"></a><span class="p">;</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">list</span>
<a id="line-8705" name="line-8705"></a><span class="p">;</span>
<a id="line-8706" name="line-8706"></a><span class="nl">int13_relocated</span><span class="p">:</span>
<a id="line-8707" name="line-8707"></a>
<a id="line-8708" name="line-8708"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-8709" name="line-8709"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">eltorito</span><span class="w"> </span><span class="n">function</span>
<a id="line-8710" name="line-8710"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">ah</span><span class="p">,</span><span class="err">#</span><span class="mh">0x4a</span>
<a id="line-8711" name="line-8711"></a><span class="w">  </span><span class="n">jb</span><span class="w">    </span><span class="n">int13_not_eltorito</span>
<a id="line-8712" name="line-8712"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">ah</span><span class="p">,</span><span class="err">#</span><span class="mh">0x4d</span>
<a id="line-8713" name="line-8713"></a><span class="w">  </span><span class="n">ja</span><span class="w">    </span><span class="n">int13_not_eltorito</span>
<a id="line-8714" name="line-8714"></a>
<a id="line-8715" name="line-8715"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-8716" name="line-8716"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">es</span>
<a id="line-8717" name="line-8717"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-8718" name="line-8718"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ss</span>
<a id="line-8719" name="line-8719"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-8720" name="line-8720"></a>
<a id="line-8721" name="line-8721"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="err">#</span><span class="n">int13_out</span>
<a id="line-8722" name="line-8722"></a><span class="w">  </span><span class="n">jmp</span><span class="w">   </span><span class="n">_int13_eltorito</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">ELDX</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">used</span>
<a id="line-8723" name="line-8723"></a>
<a id="line-8724" name="line-8724"></a><span class="nl">int13_not_eltorito</span><span class="p">:</span>
<a id="line-8725" name="line-8725"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ax</span>
<a id="line-8726" name="line-8726"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">bx</span>
<a id="line-8727" name="line-8727"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">cx</span>
<a id="line-8728" name="line-8728"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">dx</span>
<a id="line-8729" name="line-8729"></a>
<a id="line-8730" name="line-8730"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">emulation</span><span class="w"> </span><span class="n">active</span>
<a id="line-8731" name="line-8731"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">_cdemu_isactive</span>
<a id="line-8732" name="line-8732"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-8733" name="line-8733"></a><span class="w">  </span><span class="n">je</span><span class="w">    </span><span class="n">int13_cdemu_inactive</span>
<a id="line-8734" name="line-8734"></a>
<a id="line-8735" name="line-8735"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">emulated</span><span class="w"> </span><span class="n">drive</span>
<a id="line-8736" name="line-8736"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">_cdemu_emulated_drive</span>
<a id="line-8737" name="line-8737"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">dx</span>
<a id="line-8738" name="line-8738"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">dx</span>
<a id="line-8739" name="line-8739"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="n">dl</span><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">int13</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">emulated</span><span class="w"> </span><span class="n">drive</span>
<a id="line-8740" name="line-8740"></a><span class="w">  </span><span class="n">jne</span><span class="w">   </span><span class="n">int13_nocdemu</span>
<a id="line-8741" name="line-8741"></a>
<a id="line-8742" name="line-8742"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">dx</span>
<a id="line-8743" name="line-8743"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">cx</span>
<a id="line-8744" name="line-8744"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">bx</span>
<a id="line-8745" name="line-8745"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ax</span>
<a id="line-8746" name="line-8746"></a>
<a id="line-8747" name="line-8747"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-8748" name="line-8748"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">es</span>
<a id="line-8749" name="line-8749"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-8750" name="line-8750"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ss</span>
<a id="line-8751" name="line-8751"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-8752" name="line-8752"></a>
<a id="line-8753" name="line-8753"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="err">#</span><span class="n">int13_out</span>
<a id="line-8754" name="line-8754"></a><span class="w">  </span><span class="n">jmp</span><span class="w">   </span><span class="n">_int13_cdemu</span><span class="w">         </span><span class="p">;;</span><span class="w"> </span><span class="n">ELDX</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">used</span>
<a id="line-8755" name="line-8755"></a>
<a id="line-8756" name="line-8756"></a><span class="nl">int13_nocdemu</span><span class="p">:</span>
<a id="line-8757" name="line-8757"></a><span class="w">  </span><span class="n">and</span><span class="w">   </span><span class="n">dl</span><span class="p">,</span><span class="err">#</span><span class="mh">0xE0</span><span class="w">             </span><span class="p">;;</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">cdroms</span>
<a id="line-8758" name="line-8758"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="n">dl</span><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mh">0x80</span>
<a id="line-8759" name="line-8759"></a><span class="w">  </span><span class="n">jne</span><span class="w">   </span><span class="n">int13_cdemu_inactive</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">inactive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">class</span>
<a id="line-8760" name="line-8760"></a>
<a id="line-8761" name="line-8761"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">dx</span>
<a id="line-8762" name="line-8762"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">cx</span>
<a id="line-8763" name="line-8763"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">bx</span>
<a id="line-8764" name="line-8764"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ax</span>
<a id="line-8765" name="line-8765"></a>
<a id="line-8766" name="line-8766"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ax</span>
<a id="line-8767" name="line-8767"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">cx</span>
<a id="line-8768" name="line-8768"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">dx</span>
<a id="line-8769" name="line-8769"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">bx</span>
<a id="line-8770" name="line-8770"></a>
<a id="line-8771" name="line-8771"></a><span class="w">  </span><span class="n">dec</span><span class="w">   </span><span class="n">dl</span><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<a id="line-8772" name="line-8772"></a><span class="w">  </span><span class="n">jmp</span><span class="w">   </span><span class="n">int13_legacy</span>
<a id="line-8773" name="line-8773"></a>
<a id="line-8774" name="line-8774"></a><span class="nl">int13_cdemu_inactive</span><span class="p">:</span>
<a id="line-8775" name="line-8775"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">dx</span>
<a id="line-8776" name="line-8776"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">cx</span>
<a id="line-8777" name="line-8777"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">bx</span>
<a id="line-8778" name="line-8778"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ax</span>
<a id="line-8779" name="line-8779"></a>
<a id="line-8780" name="line-8780"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-8781" name="line-8781"></a>
<a id="line-8782" name="line-8782"></a><span class="nl">int13_noeltorito</span><span class="p">:</span>
<a id="line-8783" name="line-8783"></a>
<a id="line-8784" name="line-8784"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ax</span>
<a id="line-8785" name="line-8785"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">cx</span>
<a id="line-8786" name="line-8786"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">dx</span>
<a id="line-8787" name="line-8787"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">bx</span>
<a id="line-8788" name="line-8788"></a>
<a id="line-8789" name="line-8789"></a><span class="nl">int13_legacy</span><span class="p">:</span>
<a id="line-8790" name="line-8790"></a>
<a id="line-8791" name="line-8791"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">dx</span><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">eltorito</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">sp</span>
<a id="line-8792" name="line-8792"></a>
<a id="line-8793" name="line-8793"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">bp</span>
<a id="line-8794" name="line-8794"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">si</span>
<a id="line-8795" name="line-8795"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">di</span>
<a id="line-8796" name="line-8796"></a>
<a id="line-8797" name="line-8797"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">es</span>
<a id="line-8798" name="line-8798"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-8799" name="line-8799"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ss</span>
<a id="line-8800" name="line-8800"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-8801" name="line-8801"></a>
<a id="line-8802" name="line-8802"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">16</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">registers</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">restored</span><span class="w"> </span><span class="n">with</span><span class="o">:</span>
<a id="line-8803" name="line-8803"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span><span class="p">;</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span><span class="p">;</span><span class="w"> </span><span class="n">popa</span><span class="p">;</span><span class="w"> </span><span class="n">iret</span>
<a id="line-8804" name="line-8804"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span>
<a id="line-8805" name="line-8805"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">DS</span><span class="p">,</span><span class="w"> </span><span class="n">ES</span><span class="p">,</span><span class="w"> </span><span class="n">DI</span><span class="p">,</span><span class="w"> </span><span class="n">SI</span><span class="p">,</span><span class="w"> </span><span class="n">BP</span><span class="p">,</span><span class="w"> </span><span class="n">ELDX</span><span class="p">,</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">CX</span><span class="p">,</span><span class="w"> </span><span class="n">AX</span><span class="p">,</span><span class="w"> </span><span class="n">IP</span><span class="p">,</span><span class="w"> </span><span class="n">CS</span><span class="p">,</span><span class="w"> </span><span class="n">FLAGS</span>
<a id="line-8806" name="line-8806"></a>
<a id="line-8807" name="line-8807"></a><span class="w">  </span><span class="n">test</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80</span>
<a id="line-8808" name="line-8808"></a><span class="w">  </span><span class="n">jnz</span><span class="w">   </span><span class="n">int13_notfloppy</span>
<a id="line-8809" name="line-8809"></a>
<a id="line-8810" name="line-8810"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="n">int13_out</span>
<a id="line-8811" name="line-8811"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">_int13_diskette_function</span>
<a id="line-8812" name="line-8812"></a>
<a id="line-8813" name="line-8813"></a><span class="nl">int13_notfloppy</span><span class="p">:</span>
<a id="line-8814" name="line-8814"></a>
<a id="line-8815" name="line-8815"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-8816" name="line-8816"></a>
<a id="line-8817" name="line-8817"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xE0</span>
<a id="line-8818" name="line-8818"></a><span class="w">  </span><span class="n">jb</span><span class="w">    </span><span class="n">int13_notcdrom</span>
<a id="line-8819" name="line-8819"></a>
<a id="line-8820" name="line-8820"></a><span class="w">  </span><span class="c1">// ebx is modified: BSD 5.2.1 boot loader problem</span>
<a id="line-8821" name="line-8821"></a><span class="w">  </span><span class="c1">// someone should figure out which 32 bit register that actually are used</span>
<a id="line-8822" name="line-8822"></a>
<a id="line-8823" name="line-8823"></a><span class="w">  </span><span class="n">shr</span><span class="w">   </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-8824" name="line-8824"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">bx</span>
<a id="line-8825" name="line-8825"></a>
<a id="line-8826" name="line-8826"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">_int13_cdrom</span>
<a id="line-8827" name="line-8827"></a>
<a id="line-8828" name="line-8828"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">bx</span>
<a id="line-8829" name="line-8829"></a><span class="w">  </span><span class="n">shl</span><span class="w">   </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-8830" name="line-8830"></a>
<a id="line-8831" name="line-8831"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int13_out</span>
<a id="line-8832" name="line-8832"></a>
<a id="line-8833" name="line-8833"></a><span class="nl">int13_notcdrom</span><span class="p">:</span>
<a id="line-8834" name="line-8834"></a>
<a id="line-8835" name="line-8835"></a><span class="cp">#endif</span>
<a id="line-8836" name="line-8836"></a>
<a id="line-8837" name="line-8837"></a><span class="nl">int13_disk</span><span class="p">:</span>
<a id="line-8838" name="line-8838"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">int13_harddisk</span><span class="w"> </span><span class="n">modifies</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">EAX</span>
<a id="line-8839" name="line-8839"></a><span class="w">  </span><span class="n">shr</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-8840" name="line-8840"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ax</span>
<a id="line-8841" name="line-8841"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">_int13_harddisk</span>
<a id="line-8842" name="line-8842"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ax</span>
<a id="line-8843" name="line-8843"></a><span class="w">  </span><span class="n">shl</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-8844" name="line-8844"></a>
<a id="line-8845" name="line-8845"></a><span class="nl">int13_out</span><span class="p">:</span>
<a id="line-8846" name="line-8846"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-8847" name="line-8847"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-8848" name="line-8848"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-8849" name="line-8849"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-8850" name="line-8850"></a>
<a id="line-8851" name="line-8851"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8852" name="line-8852"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT18h</span><span class="w"> </span><span class="o">-</span>
<a id="line-8853" name="line-8853"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8854" name="line-8854"></a><span class="nl">int18_handler</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Boot</span><span class="w"> </span><span class="n">Failure</span><span class="w"> </span><span class="n">recovery</span><span class="o">:</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">device</span><span class="p">.</span>
<a id="line-8855" name="line-8855"></a>
<a id="line-8856" name="line-8856"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Reset</span><span class="w"> </span><span class="n">SP</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">SS</span>
<a id="line-8857" name="line-8857"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0ffe</span>
<a id="line-8858" name="line-8858"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8859" name="line-8859"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x9e00</span>
<a id="line-8860" name="line-8860"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8861" name="line-8861"></a>
<a id="line-8862" name="line-8862"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="n">so</span><span class="w"> </span>
<a id="line-8863" name="line-8863"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="mf">0.</span>
<a id="line-8864" name="line-8864"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8865" name="line-8865"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8866" name="line-8866"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">]</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">segment</span>
<a id="line-8867" name="line-8867"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">                     </span><span class="p">;;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">segment</span>
<a id="line-8868" name="line-8868"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_SEQUENCE_OFFSET</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">BX</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">number</span>
<a id="line-8869" name="line-8869"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span><span class="w">                         </span><span class="p">;;</span><span class="w"> </span><span class="o">++</span>
<a id="line-8870" name="line-8870"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">IPL_SEQUENCE_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Write</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">back</span>
<a id="line-8871" name="line-8871"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">                     </span><span class="p">;;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">zero</span><span class="p">.</span>
<a id="line-8872" name="line-8872"></a>
<a id="line-8873" name="line-8873"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">device</span>
<a id="line-8874" name="line-8874"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-8875" name="line-8875"></a>
<a id="line-8876" name="line-8876"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int18_function</span>
<a id="line-8877" name="line-8877"></a>
<a id="line-8878" name="line-8878"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Boot</span><span class="w"> </span><span class="n">failed</span><span class="o">:</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">function</span><span class="p">...</span>
<a id="line-8879" name="line-8879"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x18</span>
<a id="line-8880" name="line-8880"></a>
<a id="line-8881" name="line-8881"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8882" name="line-8882"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT19h</span><span class="w"> </span><span class="o">-</span>
<a id="line-8883" name="line-8883"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8884" name="line-8884"></a><span class="nl">int19_relocated</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Boot</span><span class="w"> </span><span class="n">function</span><span class="p">,</span><span class="w"> </span><span class="n">relocated</span>
<a id="line-8885" name="line-8885"></a>
<a id="line-8886" name="line-8886"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-8887" name="line-8887"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="n">Warning</span><span class="o">:</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">19</span><span class="n">h</span><span class="w"> </span><span class="n">resets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">whole</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="o">***</span><span class="w"> </span>
<a id="line-8888" name="line-8888"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-8889" name="line-8889"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Because</span><span class="w"> </span><span class="n">PV</span><span class="w"> </span><span class="n">drivers</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">HVM</span><span class="w"> </span><span class="n">guests</span><span class="w"> </span><span class="n">detach</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">emulated</span><span class="w"> </span><span class="n">devices</span><span class="p">,</span><span class="w"> </span>
<a id="line-8890" name="line-8890"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">soft</span><span class="w"> </span><span class="n">reboot</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">dropping</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">and</span>
<a id="line-8891" name="line-8891"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">invoking</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">19</span><span class="n">h</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">drives</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">disappeared</span><span class="o">!</span>
<a id="line-8892" name="line-8892"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">asks</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">soft</span><span class="w"> </span><span class="n">reboot</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">thing</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">is</span><span class="w"> </span>
<a id="line-8893" name="line-8893"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">whole</span><span class="w"> </span><span class="n">machine</span><span class="p">.</span><span class="w">  </span><span class="n">When</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">comes</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">up</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span>
<a id="line-8894" name="line-8894"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">behaviour</span><span class="p">.</span>
<a id="line-8895" name="line-8895"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span>
<a id="line-8896" name="line-8896"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Reset</span><span class="w"> </span><span class="n">SP</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">SS</span>
<a id="line-8897" name="line-8897"></a>
<a id="line-8898" name="line-8898"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0ffe</span>
<a id="line-8899" name="line-8899"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8900" name="line-8900"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x9e00</span>
<a id="line-8901" name="line-8901"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8902" name="line-8902"></a>
<a id="line-8903" name="line-8903"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_machine_reset</span>
<a id="line-8904" name="line-8904"></a>
<a id="line-8905" name="line-8905"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8906" name="line-8906"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT1Ch</span><span class="w"> </span><span class="o">-</span>
<a id="line-8907" name="line-8907"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-8908" name="line-8908"></a><span class="nl">int1c_handler</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Tick</span>
<a id="line-8909" name="line-8909"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-8910" name="line-8910"></a>
<a id="line-8911" name="line-8911"></a>
<a id="line-8912" name="line-8912"></a><span class="p">;</span><span class="o">----------------------</span>
<a id="line-8913" name="line-8913"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">POST</span><span class="o">:</span><span class="w"> </span><span class="n">Floppy</span><span class="w"> </span><span class="n">Drive</span><span class="w"> </span><span class="o">-</span>
<a id="line-8914" name="line-8914"></a><span class="p">;</span><span class="o">----------------------</span>
<a id="line-8915" name="line-8915"></a><span class="nl">floppy_drive_post</span><span class="p">:</span>
<a id="line-8916" name="line-8916"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8917" name="line-8917"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8918" name="line-8918"></a>
<a id="line-8919" name="line-8919"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-8920" name="line-8920"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x043e</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">uncalibrated</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">occurred</span>
<a id="line-8921" name="line-8921"></a>
<a id="line-8922" name="line-8922"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x043f</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="n">status</span><span class="o">:</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">drive0</span><span class="p">,</span><span class="w"> </span><span class="n">motors</span><span class="w"> </span><span class="n">off</span>
<a id="line-8923" name="line-8923"></a>
<a id="line-8924" name="line-8924"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0440</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="n">counter</span><span class="o">:</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">active</span>
<a id="line-8925" name="line-8925"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0441</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">code</span>
<a id="line-8926" name="line-8926"></a>
<a id="line-8927" name="line-8927"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0442</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="mi">0</span>
<a id="line-8928" name="line-8928"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0443</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="mi">1</span>
<a id="line-8929" name="line-8929"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0444</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="mi">2</span>
<a id="line-8930" name="line-8930"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0445</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">cylinder</span><span class="w"> </span><span class="n">number</span>
<a id="line-8931" name="line-8931"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0446</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="n">number</span>
<a id="line-8932" name="line-8932"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0447</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="n">number</span>
<a id="line-8933" name="line-8933"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0448</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">written</span>
<a id="line-8934" name="line-8934"></a>
<a id="line-8935" name="line-8935"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x048b</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">data</span>
<a id="line-8936" name="line-8936"></a>
<a id="line-8937" name="line-8937"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="o">-----------------------------------------------------------------</span>
<a id="line-8938" name="line-8938"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="mf">048F</span><span class="p">)</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">information</span>
<a id="line-8939" name="line-8939"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-8940" name="line-8940"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">type</span>
<a id="line-8941" name="line-8941"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span>
<a id="line-8942" name="line-8942"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span>
<a id="line-8943" name="line-8943"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">AH</span>
<a id="line-8944" name="line-8944"></a>
<a id="line-8945" name="line-8945"></a><span class="nl">look_drive0</span><span class="p">:</span>
<a id="line-8946" name="line-8946"></a><span class="w">  </span><span class="n">shr</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="mi">0</span>
<a id="line-8947" name="line-8947"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">f0_missing</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">drive0</span>
<a id="line-8948" name="line-8948"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">drive0</span><span class="w"> </span><span class="n">determined</span><span class="p">,</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">line</span>
<a id="line-8949" name="line-8949"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">look_drive1</span>
<a id="line-8950" name="line-8950"></a><span class="nl">f0_missing</span><span class="p">:</span>
<a id="line-8951" name="line-8951"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">drive0</span>
<a id="line-8952" name="line-8952"></a>
<a id="line-8953" name="line-8953"></a><span class="nl">look_drive1</span><span class="p">:</span>
<a id="line-8954" name="line-8954"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">AH</span>
<a id="line-8955" name="line-8955"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">bottom</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="mi">1</span>
<a id="line-8956" name="line-8956"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">f1_missing</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">drive1</span>
<a id="line-8957" name="line-8957"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x70</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">drive1</span><span class="w"> </span><span class="n">determined</span><span class="p">,</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">line</span>
<a id="line-8958" name="line-8958"></a><span class="nl">f1_missing</span><span class="p">:</span>
<a id="line-8959" name="line-8959"></a><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">leave</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BL</span><span class="w"> </span><span class="n">zerod</span>
<a id="line-8960" name="line-8960"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x048f</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BDA</span><span class="w"> </span><span class="p">(</span><span class="n">diskette</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">information</span><span class="p">)</span>
<a id="line-8961" name="line-8961"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="o">-----------------------------------------------------------------</span>
<a id="line-8962" name="line-8962"></a>
<a id="line-8963" name="line-8963"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-8964" name="line-8964"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0490</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">media</span><span class="w"> </span><span class="n">state</span>
<a id="line-8965" name="line-8965"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0491</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">media</span><span class="w"> </span><span class="n">state</span>
<a id="line-8966" name="line-8966"></a>
<a id="line-8967" name="line-8967"></a><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="n">operational</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">state</span>
<a id="line-8968" name="line-8968"></a><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">determined</span><span class="p">,</span>
<a id="line-8969" name="line-8969"></a><span class="w">                   </span><span class="p">;;</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">detection</span><span class="w"> </span><span class="n">line</span>
<a id="line-8970" name="line-8970"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0492</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-8971" name="line-8971"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0493</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-8972" name="line-8972"></a>
<a id="line-8973" name="line-8973"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0494</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cylinder</span>
<a id="line-8974" name="line-8974"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0495</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">cylinder</span>
<a id="line-8975" name="line-8975"></a>
<a id="line-8976" name="line-8976"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-8977" name="line-8977"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x0a</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">DMA</span><span class="mi">-1</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="n">bit</span>
<a id="line-8978" name="line-8978"></a>
<a id="line-8979" name="line-8979"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x1E</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">diskette_param_table2</span><span class="p">)</span>
<a id="line-8980" name="line-8980"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int13_diskette</span><span class="p">)</span>
<a id="line-8981" name="line-8981"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x0E</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int0e_handler</span><span class="p">)</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="mi">6</span>
<a id="line-8982" name="line-8982"></a>
<a id="line-8983" name="line-8983"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-8984" name="line-8984"></a>
<a id="line-8985" name="line-8985"></a>
<a id="line-8986" name="line-8986"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-8987" name="line-8987"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">POST</span><span class="o">:</span><span class="w"> </span><span class="n">HARD</span><span class="w"> </span><span class="n">DRIVE</span><span class="w"> </span><span class="o">-</span>
<a id="line-8988" name="line-8988"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-8989" name="line-8989"></a><span class="p">;</span><span class="w"> </span><span class="n">relocated</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">isnt</span><span class="w"> </span><span class="n">big</span><span class="w"> </span><span class="n">enough</span><span class="p">.</span>
<a id="line-8990" name="line-8990"></a><span class="nl">hard_drive_post</span><span class="p">:</span>
<a id="line-8991" name="line-8991"></a><span class="w">  </span><span class="c1">// IRQ 14 = INT 76h</span>
<a id="line-8992" name="line-8992"></a><span class="w">  </span><span class="c1">// INT 76h calls INT 15h function ax=9100</span>
<a id="line-8993" name="line-8993"></a>
<a id="line-8994" name="line-8994"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0a</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="mo">0000</span><span class="w"> </span><span class="mi">1010</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserved</span><span class="p">,</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="mi">14</span>
<a id="line-8995" name="line-8995"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f6</span>
<a id="line-8996" name="line-8996"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-8997" name="line-8997"></a>
<a id="line-8998" name="line-8998"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-8999" name="line-8999"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9000" name="line-9000"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0474</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk status of last operation */</span>
<a id="line-9001" name="line-9001"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0477</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk port offset (XT only ???) */</span>
<a id="line-9002" name="line-9002"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x048c</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk status register */</span>
<a id="line-9003" name="line-9003"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x048d</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk error register */</span>
<a id="line-9004" name="line-9004"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x048e</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk task complete flag */</span>
<a id="line-9005" name="line-9005"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9006" name="line-9006"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0475</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk number attached */</span>
<a id="line-9007" name="line-9007"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-9008" name="line-9008"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0476</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* hard disk control byte */</span>
<a id="line-9009" name="line-9009"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int13_handler</span><span class="p">)</span>
<a id="line-9010" name="line-9010"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int76_handler</span><span class="p">)</span>
<a id="line-9011" name="line-9011"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">41</span><span class="n">h</span><span class="o">:</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">pointer</span>
<a id="line-9012" name="line-9012"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">46</span><span class="n">h</span><span class="o">:</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">pointer</span>
<a id="line-9013" name="line-9013"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x41</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x003D</span><span class="p">)</span><span class="w"> </span><span class="cm">/* EBDA:003D */</span>
<a id="line-9014" name="line-9014"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x46</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x004D</span><span class="p">)</span><span class="w"> </span><span class="cm">/* EBDA:004D */</span>
<a id="line-9015" name="line-9015"></a>
<a id="line-9016" name="line-9016"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="n">geometry</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="line-9017" name="line-9017"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x12</span>
<a id="line-9018" name="line-9018"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9019" name="line-9019"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9020" name="line-9020"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf0</span>
<a id="line-9021" name="line-9021"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf0</span>
<a id="line-9022" name="line-9022"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">post_d0_extended</span>
<a id="line-9023" name="line-9023"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">check_for_hd1</span>
<a id="line-9024" name="line-9024"></a><span class="nl">post_d0_extended</span><span class="p">:</span>
<a id="line-9025" name="line-9025"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x19</span>
<a id="line-9026" name="line-9026"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9027" name="line-9027"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9028" name="line-9028"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">47</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">decimal</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">definable</span>
<a id="line-9029" name="line-9029"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">post_d0_type47</span>
<a id="line-9030" name="line-9030"></a><span class="w">  </span><span class="n">HALT</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span>
<a id="line-9031" name="line-9031"></a><span class="nl">post_d0_type47</span><span class="p">:</span>
<a id="line-9032" name="line-9032"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">CMOS</span><span class="w">  </span><span class="n">purpose</span><span class="w">                  </span><span class="n">param</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">offset</span>
<a id="line-9033" name="line-9033"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="n">b</span><span class="w">    </span><span class="n">cylinders</span><span class="w"> </span><span class="n">low</span><span class="w">            </span><span class="mi">0</span>
<a id="line-9034" name="line-9034"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">    </span><span class="n">cylinders</span><span class="w"> </span><span class="n">high</span><span class="w">           </span><span class="mi">1</span>
<a id="line-9035" name="line-9035"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="n">d</span><span class="w">    </span><span class="n">heads</span><span class="w">                    </span><span class="mi">2</span>
<a id="line-9036" name="line-9036"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="n">e</span><span class="w">    </span><span class="n">write</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">comp</span><span class="w"> </span><span class="n">low</span><span class="w">       </span><span class="mi">5</span>
<a id="line-9037" name="line-9037"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mf">1f</span><span class="w">    </span><span class="n">write</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">comp</span><span class="w"> </span><span class="n">high</span><span class="w">      </span><span class="mi">6</span>
<a id="line-9038" name="line-9038"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">20</span><span class="w">    </span><span class="n">retries</span><span class="o">/</span><span class="n">bad</span><span class="w"> </span><span class="n">map</span><span class="o">/</span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">8</span><span class="w">  </span><span class="mi">8</span>
<a id="line-9039" name="line-9039"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">21</span><span class="w">    </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">low</span><span class="w">         </span><span class="n">C</span>
<a id="line-9040" name="line-9040"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">22</span><span class="w">    </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">high</span><span class="w">        </span><span class="n">D</span>
<a id="line-9041" name="line-9041"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">23</span><span class="w">    </span><span class="n">sectors</span><span class="o">/</span><span class="n">track</span><span class="w">            </span><span class="n">E</span>
<a id="line-9042" name="line-9042"></a>
<a id="line-9043" name="line-9043"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9044" name="line-9044"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9045" name="line-9045"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">segment</span>
<a id="line-9046" name="line-9046"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9047" name="line-9047"></a>
<a id="line-9048" name="line-9048"></a><span class="w">  </span><span class="p">;;;</span><span class="w"> </span><span class="n">Filling</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mf">0.</span>
<a id="line-9049" name="line-9049"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1f</span>
<a id="line-9050" name="line-9050"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9051" name="line-9051"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9052" name="line-9052"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9053" name="line-9053"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1e</span>
<a id="line-9054" name="line-9054"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9055" name="line-9055"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9056" name="line-9056"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x05</span><span class="p">),</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">precomp</span><span class="w"> </span><span class="n">word</span>
<a id="line-9057" name="line-9057"></a>
<a id="line-9058" name="line-9058"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-9059" name="line-9059"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9060" name="line-9060"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9061" name="line-9061"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">),</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9062" name="line-9062"></a>
<a id="line-9063" name="line-9063"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x22</span>
<a id="line-9064" name="line-9064"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9065" name="line-9065"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9066" name="line-9066"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9067" name="line-9067"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x21</span>
<a id="line-9068" name="line-9068"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9069" name="line-9069"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9070" name="line-9070"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0C</span><span class="p">),</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">word</span>
<a id="line-9071" name="line-9071"></a>
<a id="line-9072" name="line-9072"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1c</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">cylinders</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">AX</span>
<a id="line-9073" name="line-9073"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9074" name="line-9074"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9075" name="line-9075"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9076" name="line-9076"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1b</span>
<a id="line-9077" name="line-9077"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9078" name="line-9078"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9079" name="line-9079"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">BX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9080" name="line-9080"></a>
<a id="line-9081" name="line-9081"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1d</span>
<a id="line-9082" name="line-9082"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9083" name="line-9083"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9084" name="line-9084"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">CL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9085" name="line-9085"></a>
<a id="line-9086" name="line-9086"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x23</span>
<a id="line-9087" name="line-9087"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9088" name="line-9088"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9089" name="line-9089"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9090" name="line-9090"></a>
<a id="line-9091" name="line-9091"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1024</span>
<a id="line-9092" name="line-9092"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd0_post_logical_chs</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="n">CHS</span>
<a id="line-9093" name="line-9093"></a>
<a id="line-9094" name="line-9094"></a><span class="nl">hd0_post_physical_chs</span><span class="p">:</span>
<a id="line-9095" name="line-9095"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">logical</span><span class="w"> </span><span class="n">CHS</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">CHS</span>
<a id="line-9096" name="line-9096"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="p">(</span><span class="n">FDPT</span><span class="p">)</span>
<a id="line-9097" name="line-9097"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x00</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9098" name="line-9098"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9099" name="line-9099"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0E</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9100" name="line-9100"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">check_for_hd1</span>
<a id="line-9101" name="line-9101"></a>
<a id="line-9102" name="line-9102"></a><span class="nl">hd0_post_logical_chs</span><span class="p">:</span>
<a id="line-9103" name="line-9103"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">complies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Phoenix</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="n">Translated</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="p">(</span><span class="n">FDPT</span><span class="p">)</span>
<a id="line-9104" name="line-9104"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x09</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9105" name="line-9105"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9106" name="line-9106"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9107" name="line-9107"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0e</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">logical</span><span class="w"> </span><span class="n">sectors</span><span class="w"> </span><span class="p">(</span><span class="n">same</span><span class="p">)</span>
<a id="line-9108" name="line-9108"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xa0</span>
<a id="line-9109" name="line-9109"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x03</span><span class="p">),</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">A0h</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">indicates</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="n">table</span>
<a id="line-9110" name="line-9110"></a>
<a id="line-9111" name="line-9111"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2048</span>
<a id="line-9112" name="line-9112"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd0_post_above_2048</span>
<a id="line-9113" name="line-9113"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9114" name="line-9114"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9115" name="line-9115"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9116" name="line-9116"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd0_post_store_logical</span>
<a id="line-9117" name="line-9117"></a>
<a id="line-9118" name="line-9118"></a><span class="nl">hd0_post_above_2048</span><span class="p">:</span>
<a id="line-9119" name="line-9119"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4096</span>
<a id="line-9120" name="line-9120"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd0_post_above_4096</span>
<a id="line-9121" name="line-9121"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9122" name="line-9122"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9123" name="line-9123"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9124" name="line-9124"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd0_post_store_logical</span>
<a id="line-9125" name="line-9125"></a>
<a id="line-9126" name="line-9126"></a><span class="nl">hd0_post_above_4096</span><span class="p">:</span>
<a id="line-9127" name="line-9127"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8192</span>
<a id="line-9128" name="line-9128"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd0_post_above_8192</span>
<a id="line-9129" name="line-9129"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9130" name="line-9130"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9131" name="line-9131"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9132" name="line-9132"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd0_post_store_logical</span>
<a id="line-9133" name="line-9133"></a>
<a id="line-9134" name="line-9134"></a><span class="nl">hd0_post_above_8192</span><span class="p">:</span>
<a id="line-9135" name="line-9135"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9136" name="line-9136"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-9137" name="line-9137"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-9138" name="line-9138"></a>
<a id="line-9139" name="line-9139"></a><span class="nl">hd0_post_store_logical</span><span class="p">:</span>
<a id="line-9140" name="line-9140"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x00</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9141" name="line-9141"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x003d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9142" name="line-9142"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">checksum</span>
<a id="line-9143" name="line-9143"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">repeat</span><span class="w"> </span><span class="n">count</span>
<a id="line-9144" name="line-9144"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x003d</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">disk0</span><span class="w"> </span><span class="n">FDPT</span>
<a id="line-9145" name="line-9145"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">sum</span>
<a id="line-9146" name="line-9146"></a><span class="nl">hd0_post_checksum_loop</span><span class="p">:</span>
<a id="line-9147" name="line-9147"></a><span class="w">  </span><span class="n">add</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
<a id="line-9148" name="line-9148"></a><span class="w">  </span><span class="n">inc</span><span class="w">   </span><span class="n">si</span>
<a id="line-9149" name="line-9149"></a><span class="w">  </span><span class="n">dec</span><span class="w">   </span><span class="n">cl</span>
<a id="line-9150" name="line-9150"></a><span class="w">  </span><span class="n">jnz</span><span class="w"> </span><span class="n">hd0_post_checksum_loop</span>
<a id="line-9151" name="line-9151"></a><span class="w">  </span><span class="n">not</span><span class="w">   </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="mi">2</span><span class="n">s</span><span class="w"> </span><span class="n">complement</span>
<a id="line-9152" name="line-9152"></a><span class="w">  </span><span class="n">inc</span><span class="w">   </span><span class="n">al</span>
<a id="line-9153" name="line-9153"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">[</span><span class="n">si</span><span class="p">],</span><span class="w"> </span><span class="n">al</span>
<a id="line-9154" name="line-9154"></a><span class="p">;;;</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="n">filling</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mf">0.</span>
<a id="line-9155" name="line-9155"></a>
<a id="line-9156" name="line-9156"></a>
<a id="line-9157" name="line-9157"></a><span class="nl">check_for_hd1</span><span class="p">:</span>
<a id="line-9158" name="line-9158"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">really</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="o">?</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">not</span><span class="p">,</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">now</span>
<a id="line-9159" name="line-9159"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x12</span>
<a id="line-9160" name="line-9160"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9161" name="line-9161"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9162" name="line-9162"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span>
<a id="line-9163" name="line-9163"></a><span class="w">  </span><span class="n">jnz</span><span class="w">   </span><span class="n">post_d1_exists</span>
<a id="line-9164" name="line-9164"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9165" name="line-9165"></a><span class="nl">post_d1_exists</span><span class="p">:</span>
<a id="line-9166" name="line-9166"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">hd</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">really</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">.</span>
<a id="line-9167" name="line-9167"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span>
<a id="line-9168" name="line-9168"></a><span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">post_d1_extended</span>
<a id="line-9169" name="line-9169"></a><span class="w">  </span><span class="n">HALT</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span>
<a id="line-9170" name="line-9170"></a><span class="nl">post_d1_extended</span><span class="p">:</span>
<a id="line-9171" name="line-9171"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">extended</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">definable</span>
<a id="line-9172" name="line-9172"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1a</span>
<a id="line-9173" name="line-9173"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9174" name="line-9174"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9175" name="line-9175"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">47</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">decimal</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">definable</span>
<a id="line-9176" name="line-9176"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">post_d1_type47</span>
<a id="line-9177" name="line-9177"></a><span class="w">  </span><span class="n">HALT</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span>
<a id="line-9178" name="line-9178"></a><span class="nl">post_d1_type47</span><span class="p">:</span>
<a id="line-9179" name="line-9179"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">disk1</span><span class="p">.</span>
<a id="line-9180" name="line-9180"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">CMOS</span><span class="w">  </span><span class="n">purpose</span><span class="w">                  </span><span class="n">param</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">offset</span>
<a id="line-9181" name="line-9181"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x24</span><span class="w">    </span><span class="n">cylinders</span><span class="w"> </span><span class="n">low</span><span class="w">            </span><span class="mi">0</span>
<a id="line-9182" name="line-9182"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x25</span><span class="w">    </span><span class="n">cylinders</span><span class="w"> </span><span class="n">high</span><span class="w">           </span><span class="mi">1</span>
<a id="line-9183" name="line-9183"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x26</span><span class="w">    </span><span class="n">heads</span><span class="w">                    </span><span class="mi">2</span>
<a id="line-9184" name="line-9184"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x27</span><span class="w">    </span><span class="n">write</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">comp</span><span class="w"> </span><span class="n">low</span><span class="w">       </span><span class="mi">5</span>
<a id="line-9185" name="line-9185"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x28</span><span class="w">    </span><span class="n">write</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">comp</span><span class="w"> </span><span class="n">high</span><span class="w">      </span><span class="mi">6</span>
<a id="line-9186" name="line-9186"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x29</span><span class="w">    </span><span class="n">heads</span><span class="o">&gt;</span><span class="mi">8</span><span class="w">                  </span><span class="mi">8</span>
<a id="line-9187" name="line-9187"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x2a</span><span class="w">    </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">low</span><span class="w">         </span><span class="n">C</span>
<a id="line-9188" name="line-9188"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x2b</span><span class="w">    </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">high</span><span class="w">        </span><span class="n">D</span>
<a id="line-9189" name="line-9189"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x2c</span><span class="w">    </span><span class="n">sectors</span><span class="o">/</span><span class="n">track</span><span class="w">            </span><span class="n">E</span>
<a id="line-9190" name="line-9190"></a><span class="p">;;;</span><span class="w"> </span><span class="n">Fill</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mf">1.</span>
<a id="line-9191" name="line-9191"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9192" name="line-9192"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9193" name="line-9193"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">segment</span>
<a id="line-9194" name="line-9194"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9195" name="line-9195"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x28</span>
<a id="line-9196" name="line-9196"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9197" name="line-9197"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9198" name="line-9198"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9199" name="line-9199"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x27</span>
<a id="line-9200" name="line-9200"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9201" name="line-9201"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9202" name="line-9202"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x05</span><span class="p">),</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">precomp</span><span class="w"> </span><span class="n">word</span>
<a id="line-9203" name="line-9203"></a>
<a id="line-9204" name="line-9204"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x29</span>
<a id="line-9205" name="line-9205"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9206" name="line-9206"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9207" name="line-9207"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">),</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9208" name="line-9208"></a>
<a id="line-9209" name="line-9209"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x2b</span>
<a id="line-9210" name="line-9210"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9211" name="line-9211"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9212" name="line-9212"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9213" name="line-9213"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x2a</span>
<a id="line-9214" name="line-9214"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9215" name="line-9215"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9216" name="line-9216"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0C</span><span class="p">),</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">landing</span><span class="w"> </span><span class="n">zone</span><span class="w"> </span><span class="n">word</span>
<a id="line-9217" name="line-9217"></a>
<a id="line-9218" name="line-9218"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x25</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">cylinders</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">AX</span>
<a id="line-9219" name="line-9219"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9220" name="line-9220"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9221" name="line-9221"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9222" name="line-9222"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x24</span>
<a id="line-9223" name="line-9223"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9224" name="line-9224"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9225" name="line-9225"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">BX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9226" name="line-9226"></a>
<a id="line-9227" name="line-9227"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x26</span>
<a id="line-9228" name="line-9228"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9229" name="line-9229"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9230" name="line-9230"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">CL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9231" name="line-9231"></a>
<a id="line-9232" name="line-9232"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x2c</span>
<a id="line-9233" name="line-9233"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9234" name="line-9234"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span>
<a id="line-9235" name="line-9235"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">DL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9236" name="line-9236"></a>
<a id="line-9237" name="line-9237"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1024</span>
<a id="line-9238" name="line-9238"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd1_post_logical_chs</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cylinders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="n">CHS</span>
<a id="line-9239" name="line-9239"></a>
<a id="line-9240" name="line-9240"></a><span class="nl">hd1_post_physical_chs</span><span class="p">:</span>
<a id="line-9241" name="line-9241"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">logical</span><span class="w"> </span><span class="n">CHS</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">CHS</span>
<a id="line-9242" name="line-9242"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="p">(</span><span class="n">FDPT</span><span class="p">)</span>
<a id="line-9243" name="line-9243"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x00</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9244" name="line-9244"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9245" name="line-9245"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0E</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9246" name="line-9246"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9247" name="line-9247"></a>
<a id="line-9248" name="line-9248"></a><span class="nl">hd1_post_logical_chs</span><span class="p">:</span>
<a id="line-9249" name="line-9249"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">complies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Phoenix</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="n">Translated</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="p">(</span><span class="n">FDPT</span><span class="p">)</span>
<a id="line-9250" name="line-9250"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x09</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9251" name="line-9251"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9252" name="line-9252"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">sectors</span>
<a id="line-9253" name="line-9253"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x0e</span><span class="p">),</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">logical</span><span class="w"> </span><span class="n">sectors</span><span class="w"> </span><span class="p">(</span><span class="n">same</span><span class="p">)</span>
<a id="line-9254" name="line-9254"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xa0</span>
<a id="line-9255" name="line-9255"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x03</span><span class="p">),</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">A0h</span><span class="w"> </span><span class="n">signature</span><span class="p">,</span><span class="w"> </span><span class="n">indicates</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="n">table</span>
<a id="line-9256" name="line-9256"></a>
<a id="line-9257" name="line-9257"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2048</span>
<a id="line-9258" name="line-9258"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd1_post_above_2048</span>
<a id="line-9259" name="line-9259"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9260" name="line-9260"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9261" name="line-9261"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9262" name="line-9262"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd1_post_store_logical</span>
<a id="line-9263" name="line-9263"></a>
<a id="line-9264" name="line-9264"></a><span class="nl">hd1_post_above_2048</span><span class="p">:</span>
<a id="line-9265" name="line-9265"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4096</span>
<a id="line-9266" name="line-9266"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd1_post_above_4096</span>
<a id="line-9267" name="line-9267"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9268" name="line-9268"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9269" name="line-9269"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9270" name="line-9270"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd1_post_store_logical</span>
<a id="line-9271" name="line-9271"></a>
<a id="line-9272" name="line-9272"></a><span class="nl">hd1_post_above_4096</span><span class="p">:</span>
<a id="line-9273" name="line-9273"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8192</span>
<a id="line-9274" name="line-9274"></a><span class="w">  </span><span class="n">jnbe</span><span class="w"> </span><span class="n">hd1_post_above_8192</span>
<a id="line-9275" name="line-9275"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9276" name="line-9276"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9277" name="line-9277"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9278" name="line-9278"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">hd1_post_store_logical</span>
<a id="line-9279" name="line-9279"></a>
<a id="line-9280" name="line-9280"></a><span class="nl">hd1_post_above_8192</span><span class="p">:</span>
<a id="line-9281" name="line-9281"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">8192</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9282" name="line-9282"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-9283" name="line-9283"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-9284" name="line-9284"></a>
<a id="line-9285" name="line-9285"></a><span class="nl">hd1_post_store_logical</span><span class="p">:</span>
<a id="line-9286" name="line-9286"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x00</span><span class="p">),</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">cylinders</span>
<a id="line-9287" name="line-9287"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">(</span><span class="mh">0x004d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x02</span><span class="p">),</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">heads</span>
<a id="line-9288" name="line-9288"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">checksum</span>
<a id="line-9289" name="line-9289"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">repeat</span><span class="w"> </span><span class="n">count</span>
<a id="line-9290" name="line-9290"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x004d</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">disk0</span><span class="w"> </span><span class="n">FDPT</span>
<a id="line-9291" name="line-9291"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">sum</span>
<a id="line-9292" name="line-9292"></a><span class="nl">hd1_post_checksum_loop</span><span class="p">:</span>
<a id="line-9293" name="line-9293"></a><span class="w">  </span><span class="n">add</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
<a id="line-9294" name="line-9294"></a><span class="w">  </span><span class="n">inc</span><span class="w">   </span><span class="n">si</span>
<a id="line-9295" name="line-9295"></a><span class="w">  </span><span class="n">dec</span><span class="w">   </span><span class="n">cl</span>
<a id="line-9296" name="line-9296"></a><span class="w">  </span><span class="n">jnz</span><span class="w"> </span><span class="n">hd1_post_checksum_loop</span>
<a id="line-9297" name="line-9297"></a><span class="w">  </span><span class="n">not</span><span class="w">   </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="mi">2</span><span class="n">s</span><span class="w"> </span><span class="n">complement</span>
<a id="line-9298" name="line-9298"></a><span class="w">  </span><span class="n">inc</span><span class="w">   </span><span class="n">al</span>
<a id="line-9299" name="line-9299"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="p">[</span><span class="n">si</span><span class="p">],</span><span class="w"> </span><span class="n">al</span>
<a id="line-9300" name="line-9300"></a><span class="p">;;;</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="n">filling</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="mf">1.</span>
<a id="line-9301" name="line-9301"></a>
<a id="line-9302" name="line-9302"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9303" name="line-9303"></a>
<a id="line-9304" name="line-9304"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9305" name="line-9305"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">POST</span><span class="o">:</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">segment</span>
<a id="line-9306" name="line-9306"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9307" name="line-9307"></a><span class="p">;</span><span class="w"> </span><span class="n">relocated</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">isnt</span><span class="w"> </span><span class="n">big</span><span class="w"> </span><span class="n">enough</span><span class="p">.</span>
<a id="line-9308" name="line-9308"></a><span class="nl">ebda_post</span><span class="p">:</span>
<a id="line-9309" name="line-9309"></a><span class="cp">#if BX_USE_EBDA</span>
<a id="line-9310" name="line-9310"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">EBDA_SEG</span>
<a id="line-9311" name="line-9311"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9312" name="line-9312"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x0</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">EBDA_SIZE</span>
<a id="line-9313" name="line-9313"></a><span class="cp">#endif</span>
<a id="line-9314" name="line-9314"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="mi">40</span><span class="n">E</span>
<a id="line-9315" name="line-9315"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9316" name="line-9316"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">EBDA_SEG</span>
<a id="line-9317" name="line-9317"></a><span class="w">  </span><span class="n">ret</span><span class="p">;;</span>
<a id="line-9318" name="line-9318"></a>
<a id="line-9319" name="line-9319"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9320" name="line-9320"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">POST</span><span class="o">:</span><span class="w"> </span><span class="n">EOI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40</span><span class="o">:</span><span class="mi">67</span><span class="p">)</span>
<a id="line-9321" name="line-9321"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9322" name="line-9322"></a><span class="p">;</span><span class="w"> </span><span class="n">relocated</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">isnt</span><span class="w"> </span><span class="n">big</span><span class="w"> </span><span class="n">enough</span><span class="p">.</span>
<a id="line-9323" name="line-9323"></a><span class="nl">eoi_jmp_post</span><span class="p">:</span>
<a id="line-9324" name="line-9324"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-9325" name="line-9325"></a><span class="w">  </span><span class="n">out</span><span class="w">   </span><span class="err">#</span><span class="mh">0xA0</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">slave</span><span class="w">  </span><span class="n">PIC</span><span class="w"> </span><span class="n">EOI</span>
<a id="line-9326" name="line-9326"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-9327" name="line-9327"></a><span class="w">  </span><span class="n">out</span><span class="w">   </span><span class="err">#</span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">PIC</span><span class="w"> </span><span class="n">EOI</span>
<a id="line-9328" name="line-9328"></a>
<a id="line-9329" name="line-9329"></a><span class="nl">jmp_post_0x467</span><span class="p">:</span>
<a id="line-9330" name="line-9330"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9331" name="line-9331"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9332" name="line-9332"></a>
<a id="line-9333" name="line-9333"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x467</span><span class="p">]</span>
<a id="line-9334" name="line-9334"></a>
<a id="line-9335" name="line-9335"></a><span class="nl">iret_post_0x467</span><span class="p">:</span>
<a id="line-9336" name="line-9336"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9337" name="line-9337"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9338" name="line-9338"></a>
<a id="line-9339" name="line-9339"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x467</span><span class="p">]</span>
<a id="line-9340" name="line-9340"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x469</span><span class="p">]</span>
<a id="line-9341" name="line-9341"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-9342" name="line-9342"></a>
<a id="line-9343" name="line-9343"></a><span class="nl">retf_post_0x467</span><span class="p">:</span>
<a id="line-9344" name="line-9344"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9345" name="line-9345"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9346" name="line-9346"></a>
<a id="line-9347" name="line-9347"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x467</span><span class="p">]</span>
<a id="line-9348" name="line-9348"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x469</span><span class="p">]</span>
<a id="line-9349" name="line-9349"></a><span class="w">  </span><span class="n">retf</span>
<a id="line-9350" name="line-9350"></a>
<a id="line-9351" name="line-9351"></a><span class="nl">s3_post</span><span class="p">:</span>
<a id="line-9352" name="line-9352"></a><span class="cp">#if BX_ROMBIOS32</span>
<a id="line-9353" name="line-9353"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">rombios32_init</span>
<a id="line-9354" name="line-9354"></a><span class="cp">#endif</span>
<a id="line-9355" name="line-9355"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_s3_resume</span>
<a id="line-9356" name="line-9356"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-9357" name="line-9357"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9358" name="line-9358"></a><span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">normal_post</span>
<a id="line-9359" name="line-9359"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_s3_resume_panic</span>
<a id="line-9360" name="line-9360"></a>
<a id="line-9361" name="line-9361"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9362" name="line-9362"></a><span class="nl">eoi_both_pics</span><span class="p">:</span>
<a id="line-9363" name="line-9363"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-9364" name="line-9364"></a><span class="w">  </span><span class="n">out</span><span class="w">   </span><span class="err">#</span><span class="mh">0xA0</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">slave</span><span class="w">  </span><span class="n">PIC</span><span class="w"> </span><span class="n">EOI</span>
<a id="line-9365" name="line-9365"></a><span class="nl">eoi_master_pic</span><span class="p">:</span>
<a id="line-9366" name="line-9366"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-9367" name="line-9367"></a><span class="w">  </span><span class="n">out</span><span class="w">   </span><span class="err">#</span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="n">PIC</span><span class="w"> </span><span class="n">EOI</span>
<a id="line-9368" name="line-9368"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9369" name="line-9369"></a>
<a id="line-9370" name="line-9370"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9371" name="line-9371"></a><span class="nl">BcdToBin</span><span class="p">:</span>
<a id="line-9372" name="line-9372"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">in</span><span class="o">:</span><span class="w">  </span><span class="n">AL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BCD</span><span class="w"> </span><span class="n">format</span>
<a id="line-9373" name="line-9373"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">out</span><span class="o">:</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">AH</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="mi">0</span>
<a id="line-9374" name="line-9374"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">trashes</span><span class="w"> </span><span class="n">BX</span>
<a id="line-9375" name="line-9375"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9376" name="line-9376"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">bl</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">digit</span>
<a id="line-9377" name="line-9377"></a><span class="w">  </span><span class="n">shr</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">digit</span>
<a id="line-9378" name="line-9378"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">10</span>
<a id="line-9379" name="line-9379"></a><span class="w">  </span><span class="n">mul</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">bh</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">multiply</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">digit</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">AX</span><span class="p">)</span>
<a id="line-9380" name="line-9380"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span><span class="w">    </span><span class="p">;;</span><span class="w">   </span><span class="n">then</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">digit</span>
<a id="line-9381" name="line-9381"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9382" name="line-9382"></a>
<a id="line-9383" name="line-9383"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9384" name="line-9384"></a><span class="nl">timer_tick_post</span><span class="p">:</span>
<a id="line-9385" name="line-9385"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Ticks</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="p">(</span><span class="mh">0x46C</span><span class="o">:</span><span class="n">dword</span><span class="p">)</span><span class="w"> </span><span class="n">and</span>
<a id="line-9386" name="line-9386"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">Timer</span><span class="w"> </span><span class="n">Ticks</span><span class="w"> </span><span class="n">Roller</span><span class="w"> </span><span class="n">Flag</span><span class="w"> </span><span class="p">(</span><span class="mh">0x470</span><span class="o">:</span><span class="n">byte</span><span class="p">)</span>
<a id="line-9387" name="line-9387"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Ticks</span><span class="w"> </span><span class="n">Count</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">according</span><span class="w"> </span><span class="n">to</span>
<a id="line-9388" name="line-9388"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">occurring</span>
<a id="line-9389" name="line-9389"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mf">18.2</span><span class="n">hz</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">midnight</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="w">  </span><span class="n">Calculating</span>
<a id="line-9390" name="line-9390"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">complicated</span><span class="p">.</span><span class="w">  </span><span class="n">Here</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">factors</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">gather</span>
<a id="line-9391" name="line-9391"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">regarding</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="w">  </span><span class="mi">14</span><span class="p">,</span><span class="mi">318</span><span class="p">,</span><span class="mi">180</span><span class="w"> </span><span class="n">hz</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">clock</span><span class="w"> </span><span class="n">speed</span><span class="p">,</span>
<a id="line-9392" name="line-9392"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">chosen</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">divided</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">5</span><span class="n">Mhz</span><span class="w"> </span><span class="n">CPU</span>
<a id="line-9393" name="line-9393"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">CGA</span><span class="w"> </span><span class="n">video</span><span class="w"> </span><span class="n">adapter</span><span class="p">.</span><span class="w">  </span><span class="n">The</span><span class="w"> </span><span class="n">div3</span>
<a id="line-9394" name="line-9394"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">divided</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">feed</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mf">1.193</span><span class="n">Mhz</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">to</span>
<a id="line-9395" name="line-9395"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="w">  </span><span class="n">With</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="mi">16</span><span class="n">bit</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">again</span>
<a id="line-9396" name="line-9396"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">divided</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">18.2</span><span class="n">hz</span><span class="p">.</span>
<a id="line-9397" name="line-9397"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-9398" name="line-9398"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="mi">318</span><span class="p">,</span><span class="mi">180</span><span class="w"> </span><span class="n">Hz</span><span class="w"> </span><span class="n">clock</span>
<a id="line-9399" name="line-9399"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="mi">772</span><span class="p">,</span><span class="mi">726</span><span class="w"> </span><span class="n">Hz</span><span class="w"> </span><span class="n">fed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">orginal</span><span class="w"> </span><span class="mi">5</span><span class="n">Mhz</span><span class="w"> </span><span class="n">CPU</span>
<a id="line-9400" name="line-9400"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">181</span><span class="w"> </span><span class="n">Hz</span><span class="w"> </span><span class="n">fed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">timer</span>
<a id="line-9401" name="line-9401"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="o">/</span><span class="mi">65536</span><span class="w"> </span><span class="p">(</span><span class="n">maximum</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">18.20650736</span><span class="w"> </span><span class="n">ticks</span><span class="o">/</span><span class="n">second</span>
<a id="line-9402" name="line-9402"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">18.20650736</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9403" name="line-9403"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">minute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1092.390442</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9404" name="line-9404"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hour</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">65543.42651</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9405" name="line-9405"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-9406" name="line-9406"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Given</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">clock</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="n">calculate</span>
<a id="line-9407" name="line-9407"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="o">:</span>
<a id="line-9408" name="line-9408"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">18.206507</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<a id="line-9409" name="line-9409"></a><span class="w">  </span><span class="p">;;</span><span class="w">           </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1092.3904</span><span class="p">)</span>
<a id="line-9410" name="line-9410"></a><span class="w">  </span><span class="p">;;</span><span class="w">           </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="mf">65543.427</span><span class="p">)</span>
<a id="line-9411" name="line-9411"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">To</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">accuracy</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">Im</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">integer</span>
<a id="line-9412" name="line-9412"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">arithmatic</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">use</span><span class="o">:</span>
<a id="line-9413" name="line-9413"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">18206507</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000000</span><span class="w"> </span><span class="o">+</span>
<a id="line-9414" name="line-9414"></a><span class="w">  </span><span class="p">;;</span><span class="w">           </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10923904</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">+</span>
<a id="line-9415" name="line-9415"></a><span class="w">  </span><span class="p">;;</span><span class="w">           </span><span class="p">(</span><span class="n">BcdToBin</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span><span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="mi">65543427</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span>
<a id="line-9416" name="line-9416"></a>
<a id="line-9417" name="line-9417"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">assuming</span><span class="w"> </span><span class="n">DS</span><span class="o">=</span><span class="mo">0000</span>
<a id="line-9418" name="line-9418"></a>
<a id="line-9419" name="line-9419"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">seconds</span>
<a id="line-9420" name="line-9420"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">EAX</span>
<a id="line-9421" name="line-9421"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-9422" name="line-9422"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9423" name="line-9423"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BCD</span>
<a id="line-9424" name="line-9424"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">BcdToBin</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">EAX</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">binary</span>
<a id="line-9425" name="line-9425"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">18206507</span>
<a id="line-9426" name="line-9426"></a><span class="w">  </span><span class="n">mul</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9427" name="line-9427"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1000000</span>
<a id="line-9428" name="line-9428"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9429" name="line-9429"></a><span class="w">  </span><span class="n">div</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-9430" name="line-9430"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">ECX</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">accumulate</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9431" name="line-9431"></a>
<a id="line-9432" name="line-9432"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">minutes</span>
<a id="line-9433" name="line-9433"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">EAX</span>
<a id="line-9434" name="line-9434"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9435" name="line-9435"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9436" name="line-9436"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BCD</span>
<a id="line-9437" name="line-9437"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">BcdToBin</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">EAX</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">binary</span>
<a id="line-9438" name="line-9438"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">10923904</span>
<a id="line-9439" name="line-9439"></a><span class="w">  </span><span class="n">mul</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9440" name="line-9440"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">10000</span>
<a id="line-9441" name="line-9441"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9442" name="line-9442"></a><span class="w">  </span><span class="n">div</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-9443" name="line-9443"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9444" name="line-9444"></a>
<a id="line-9445" name="line-9445"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">hours</span>
<a id="line-9446" name="line-9446"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">EAX</span>
<a id="line-9447" name="line-9447"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-9448" name="line-9448"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="err">#</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9449" name="line-9449"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x71</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BCD</span>
<a id="line-9450" name="line-9450"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">BcdToBin</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">EAX</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">binary</span>
<a id="line-9451" name="line-9451"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">65543427</span>
<a id="line-9452" name="line-9452"></a><span class="w">  </span><span class="n">mul</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9453" name="line-9453"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1000</span>
<a id="line-9454" name="line-9454"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9455" name="line-9455"></a><span class="w">  </span><span class="n">div</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-9456" name="line-9456"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">ticks</span>
<a id="line-9457" name="line-9457"></a>
<a id="line-9458" name="line-9458"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x46C</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Ticks</span><span class="w"> </span><span class="n">Count</span>
<a id="line-9459" name="line-9459"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9460" name="line-9460"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x470</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Ticks</span><span class="w"> </span><span class="n">Rollover</span><span class="w"> </span><span class="n">Flag</span>
<a id="line-9461" name="line-9461"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9462" name="line-9462"></a>
<a id="line-9463" name="line-9463"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9464" name="line-9464"></a><span class="nl">int76_handler</span><span class="p">:</span>
<a id="line-9465" name="line-9465"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">completion</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="n">flag</span>
<a id="line-9466" name="line-9466"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ax</span>
<a id="line-9467" name="line-9467"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-9468" name="line-9468"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0040</span>
<a id="line-9469" name="line-9469"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9470" name="line-9470"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="mh">0x008E</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff</span>
<a id="line-9471" name="line-9471"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">eoi_both_pics</span>
<a id="line-9472" name="line-9472"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-9473" name="line-9473"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ax</span>
<a id="line-9474" name="line-9474"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-9475" name="line-9475"></a>
<a id="line-9476" name="line-9476"></a>
<a id="line-9477" name="line-9477"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9478" name="line-9478"></a><span class="cp">#if BX_APM</span>
<a id="line-9479" name="line-9479"></a>
<a id="line-9480" name="line-9480"></a><span class="n">use32</span><span class="w"> </span><span class="mi">386</span>
<a id="line-9481" name="line-9481"></a><span class="cp">#define APM_PROT32</span>
<a id="line-9482" name="line-9482"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;apmbios.S&quot;</span>
<a id="line-9483" name="line-9483"></a>
<a id="line-9484" name="line-9484"></a><span class="n">use16</span><span class="w"> </span><span class="mi">386</span>
<a id="line-9485" name="line-9485"></a><span class="cp">#define APM_PROT16</span>
<a id="line-9486" name="line-9486"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;apmbios.S&quot;</span>
<a id="line-9487" name="line-9487"></a>
<a id="line-9488" name="line-9488"></a><span class="cp">#define APM_REAL</span>
<a id="line-9489" name="line-9489"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;apmbios.S&quot;</span>
<a id="line-9490" name="line-9490"></a>
<a id="line-9491" name="line-9491"></a><span class="cp">#endif</span>
<a id="line-9492" name="line-9492"></a>
<a id="line-9493" name="line-9493"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;32bitgateway.c&quot;</span>
<a id="line-9494" name="line-9494"></a><span class="n">ASM_END</span>
<a id="line-9495" name="line-9495"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tcgbios.c&quot;</span>
<a id="line-9496" name="line-9496"></a><span class="n">ASM_START</span>
<a id="line-9497" name="line-9497"></a>
<a id="line-9498" name="line-9498"></a><span class="p">;</span><span class="o">--------------------</span>
<a id="line-9499" name="line-9499"></a><span class="cp">#if BX_PCIBIOS</span>
<a id="line-9500" name="line-9500"></a><span class="n">use32</span><span class="w"> </span><span class="mi">386</span>
<a id="line-9501" name="line-9501"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-9502" name="line-9502"></a><span class="nl">bios32_structure</span><span class="p">:</span>
<a id="line-9503" name="line-9503"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x5f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x33</span><span class="p">,</span><span class="w"> </span><span class="mh">0x32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5f</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;_32_&quot;</span><span class="w"> </span><span class="n">signature</span>
<a id="line-9504" name="line-9504"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="n">bios32_entry_point</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="n">address</span>
<a id="line-9505" name="line-9505"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="p">;;</span><span class="w"> </span><span class="n">revision</span><span class="w"> </span><span class="n">level</span>
<a id="line-9506" name="line-9506"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">paragraphs</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">errors</span>
<a id="line-9507" name="line-9507"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="p">(((</span><span class="n">bios32_entry_point</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bios32_entry_point</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x32</span><span class="p">)</span><span class="w"> </span>\
<a id="line-9508" name="line-9508"></a><span class="w">        </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x01</span>
<a id="line-9509" name="line-9509"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9510" name="line-9510"></a>
<a id="line-9511" name="line-9511"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-9512" name="line-9512"></a><span class="nl">bios32_entry_point</span><span class="p">:</span>
<a id="line-9513" name="line-9513"></a><span class="w">  </span><span class="n">pushfd</span>
<a id="line-9514" name="line-9514"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x49435024</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;$PCI&quot;</span>
<a id="line-9515" name="line-9515"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">unknown_service</span>
<a id="line-9516" name="line-9516"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80000000</span>
<a id="line-9517" name="line-9517"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cf8</span>
<a id="line-9518" name="line-9518"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9519" name="line-9519"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9520" name="line-9520"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9521" name="line-9521"></a><span class="cp">#ifdef PCI_FIXED_HOST_BRIDGE</span>
<a id="line-9522" name="line-9522"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">PCI_FIXED_HOST_BRIDGE</span>
<a id="line-9523" name="line-9523"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">unknown_service</span>
<a id="line-9524" name="line-9524"></a><span class="cp">#else</span>
<a id="line-9525" name="line-9525"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">say</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">present</span>
<a id="line-9526" name="line-9526"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffffffff</span>
<a id="line-9527" name="line-9527"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">unknown_service</span>
<a id="line-9528" name="line-9528"></a><span class="cp">#endif</span>
<a id="line-9529" name="line-9529"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x000f0000</span>
<a id="line-9530" name="line-9530"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9531" name="line-9531"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pcibios_protected</span>
<a id="line-9532" name="line-9532"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9533" name="line-9533"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">bios32_end</span>
<a id="line-9534" name="line-9534"></a><span class="nl">unknown_service</span><span class="p">:</span>
<a id="line-9535" name="line-9535"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80</span>
<a id="line-9536" name="line-9536"></a><span class="nl">bios32_end</span><span class="p">:</span>
<a id="line-9537" name="line-9537"></a><span class="cp">#ifdef BX_QEMU</span>
<a id="line-9538" name="line-9538"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="mh">0xfffffffc</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">CS</span><span class="p">.</span><span class="n">RPL</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kqemu</span>
<a id="line-9539" name="line-9539"></a><span class="cp">#endif</span>
<a id="line-9540" name="line-9540"></a><span class="w">  </span><span class="n">popfd</span>
<a id="line-9541" name="line-9541"></a><span class="w">  </span><span class="n">retf</span>
<a id="line-9542" name="line-9542"></a>
<a id="line-9543" name="line-9543"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-9544" name="line-9544"></a><span class="nl">pcibios_protected</span><span class="p">:</span>
<a id="line-9545" name="line-9545"></a><span class="w">  </span><span class="n">pushfd</span>
<a id="line-9546" name="line-9546"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-9547" name="line-9547"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9548" name="line-9548"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9549" name="line-9549"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">installation</span><span class="w"> </span><span class="n">check</span>
<a id="line-9550" name="line-9550"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f02</span>
<a id="line-9551" name="line-9551"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0210</span>
<a id="line-9552" name="line-9552"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9553" name="line-9553"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20494350</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;PCI &quot;</span>
<a id="line-9554" name="line-9554"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-9555" name="line-9555"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9556" name="line-9556"></a><span class="nl">pci_pro_f02</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span>
<a id="line-9557" name="line-9557"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9558" name="line-9558"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f03</span>
<a id="line-9559" name="line-9559"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-9560" name="line-9560"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9561" name="line-9561"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9562" name="line-9562"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-9563" name="line-9563"></a><span class="nl">pci_pro_devloop</span><span class="p">:</span>
<a id="line-9564" name="line-9564"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9565" name="line-9565"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9566" name="line-9566"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9567" name="line-9567"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9568" name="line-9568"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_nextdev</span>
<a id="line-9569" name="line-9569"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9570" name="line-9570"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">pci_pro_ok</span>
<a id="line-9571" name="line-9571"></a><span class="w">  </span><span class="n">dec</span><span class="w"> </span><span class="n">si</span>
<a id="line-9572" name="line-9572"></a><span class="nl">pci_pro_nextdev</span><span class="p">:</span>
<a id="line-9573" name="line-9573"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9574" name="line-9574"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-9575" name="line-9575"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_devloop</span>
<a id="line-9576" name="line-9576"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x86</span>
<a id="line-9577" name="line-9577"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_fail</span>
<a id="line-9578" name="line-9578"></a><span class="nl">pci_pro_f03</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="n">code</span>
<a id="line-9579" name="line-9579"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9580" name="line-9580"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f08</span>
<a id="line-9581" name="line-9581"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9582" name="line-9582"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-9583" name="line-9583"></a><span class="nl">pci_pro_devloop2</span><span class="p">:</span>
<a id="line-9584" name="line-9584"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9585" name="line-9585"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9586" name="line-9586"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9587" name="line-9587"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span>
<a id="line-9588" name="line-9588"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9589" name="line-9589"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_nextdev2</span>
<a id="line-9590" name="line-9590"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9591" name="line-9591"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">pci_pro_ok</span>
<a id="line-9592" name="line-9592"></a><span class="w">  </span><span class="n">dec</span><span class="w"> </span><span class="n">si</span>
<a id="line-9593" name="line-9593"></a><span class="nl">pci_pro_nextdev2</span><span class="p">:</span>
<a id="line-9594" name="line-9594"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9595" name="line-9595"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-9596" name="line-9596"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_devloop2</span>
<a id="line-9597" name="line-9597"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x86</span>
<a id="line-9598" name="line-9598"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_fail</span>
<a id="line-9599" name="line-9599"></a><span class="nl">pci_pro_f08</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9600" name="line-9600"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-9601" name="line-9601"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f09</span>
<a id="line-9602" name="line-9602"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9603" name="line-9603"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9604" name="line-9604"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9605" name="line-9605"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9606" name="line-9606"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9607" name="line-9607"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9608" name="line-9608"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9609" name="line-9609"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9610" name="line-9610"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9611" name="line-9611"></a><span class="nl">pci_pro_f09</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">word</span>
<a id="line-9612" name="line-9612"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x09</span>
<a id="line-9613" name="line-9613"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f0a</span>
<a id="line-9614" name="line-9614"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9615" name="line-9615"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9616" name="line-9616"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9617" name="line-9617"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9618" name="line-9618"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9619" name="line-9619"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9620" name="line-9620"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9621" name="line-9621"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9622" name="line-9622"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9623" name="line-9623"></a><span class="nl">pci_pro_f0a</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">dword</span>
<a id="line-9624" name="line-9624"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0a</span>
<a id="line-9625" name="line-9625"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f0b</span>
<a id="line-9626" name="line-9626"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9627" name="line-9627"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9628" name="line-9628"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9629" name="line-9629"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9630" name="line-9630"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9631" name="line-9631"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9632" name="line-9632"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9633" name="line-9633"></a><span class="nl">pci_pro_f0b</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9634" name="line-9634"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0b</span>
<a id="line-9635" name="line-9635"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f0c</span>
<a id="line-9636" name="line-9636"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9637" name="line-9637"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9638" name="line-9638"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9639" name="line-9639"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9640" name="line-9640"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9641" name="line-9641"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span>
<a id="line-9642" name="line-9642"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9643" name="line-9643"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9644" name="line-9644"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9645" name="line-9645"></a><span class="nl">pci_pro_f0c</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">word</span>
<a id="line-9646" name="line-9646"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0c</span>
<a id="line-9647" name="line-9647"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_f0d</span>
<a id="line-9648" name="line-9648"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9649" name="line-9649"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9650" name="line-9650"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9651" name="line-9651"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9652" name="line-9652"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9653" name="line-9653"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9654" name="line-9654"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9655" name="line-9655"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9656" name="line-9656"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9657" name="line-9657"></a><span class="nl">pci_pro_f0d</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">dword</span>
<a id="line-9658" name="line-9658"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0d</span>
<a id="line-9659" name="line-9659"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_pro_unknown</span>
<a id="line-9660" name="line-9660"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_pro_select_reg</span>
<a id="line-9661" name="line-9661"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9662" name="line-9662"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9663" name="line-9663"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9664" name="line-9664"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9665" name="line-9665"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9666" name="line-9666"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_pro_ok</span>
<a id="line-9667" name="line-9667"></a><span class="nl">pci_pro_unknown</span><span class="p">:</span>
<a id="line-9668" name="line-9668"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x81</span>
<a id="line-9669" name="line-9669"></a><span class="nl">pci_pro_fail</span><span class="p">:</span>
<a id="line-9670" name="line-9670"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9671" name="line-9671"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9672" name="line-9672"></a><span class="cp">#ifdef BX_QEMU</span>
<a id="line-9673" name="line-9673"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="mh">0xfffffffc</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">CS</span><span class="p">.</span><span class="n">RPL</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kqemu</span>
<a id="line-9674" name="line-9674"></a><span class="cp">#endif</span>
<a id="line-9675" name="line-9675"></a><span class="w">  </span><span class="n">popfd</span>
<a id="line-9676" name="line-9676"></a><span class="w">  </span><span class="n">stc</span>
<a id="line-9677" name="line-9677"></a><span class="w">  </span><span class="n">retf</span>
<a id="line-9678" name="line-9678"></a><span class="nl">pci_pro_ok</span><span class="p">:</span>
<a id="line-9679" name="line-9679"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span>
<a id="line-9680" name="line-9680"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9681" name="line-9681"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9682" name="line-9682"></a><span class="cp">#ifdef BX_QEMU</span>
<a id="line-9683" name="line-9683"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="mh">0xfffffffc</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">CS</span><span class="p">.</span><span class="n">RPL</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kqemu</span>
<a id="line-9684" name="line-9684"></a><span class="cp">#endif</span>
<a id="line-9685" name="line-9685"></a><span class="w">  </span><span class="n">popfd</span>
<a id="line-9686" name="line-9686"></a><span class="w">  </span><span class="n">clc</span>
<a id="line-9687" name="line-9687"></a><span class="w">  </span><span class="n">retf</span>
<a id="line-9688" name="line-9688"></a>
<a id="line-9689" name="line-9689"></a><span class="nl">pci_pro_select_reg</span><span class="p">:</span>
<a id="line-9690" name="line-9690"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9691" name="line-9691"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x800000</span>
<a id="line-9692" name="line-9692"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w">  </span><span class="n">bx</span>
<a id="line-9693" name="line-9693"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span>
<a id="line-9694" name="line-9694"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0xff</span>
<a id="line-9695" name="line-9695"></a><span class="w">  </span><span class="n">or</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w">  </span><span class="n">di</span>
<a id="line-9696" name="line-9696"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0xfc</span>
<a id="line-9697" name="line-9697"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cf8</span>
<a id="line-9698" name="line-9698"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w">  </span><span class="n">eax</span>
<a id="line-9699" name="line-9699"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edx</span>
<a id="line-9700" name="line-9700"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9701" name="line-9701"></a>
<a id="line-9702" name="line-9702"></a><span class="n">use16</span><span class="w"> </span><span class="mi">386</span>
<a id="line-9703" name="line-9703"></a>
<a id="line-9704" name="line-9704"></a><span class="nl">pcibios_real</span><span class="p">:</span>
<a id="line-9705" name="line-9705"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9706" name="line-9706"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9707" name="line-9707"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80000000</span>
<a id="line-9708" name="line-9708"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cf8</span>
<a id="line-9709" name="line-9709"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9710" name="line-9710"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9711" name="line-9711"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9712" name="line-9712"></a><span class="cp">#ifdef PCI_FIXED_HOST_BRIDGE</span>
<a id="line-9713" name="line-9713"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">PCI_FIXED_HOST_BRIDGE</span>
<a id="line-9714" name="line-9714"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">pci_present</span>
<a id="line-9715" name="line-9715"></a><span class="cp">#else</span>
<a id="line-9716" name="line-9716"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">say</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">present</span>
<a id="line-9717" name="line-9717"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffffffff</span>
<a id="line-9718" name="line-9718"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">pci_present</span>
<a id="line-9719" name="line-9719"></a><span class="cp">#endif</span>
<a id="line-9720" name="line-9720"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9721" name="line-9721"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9722" name="line-9722"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff</span>
<a id="line-9723" name="line-9723"></a><span class="w">  </span><span class="n">stc</span>
<a id="line-9724" name="line-9724"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9725" name="line-9725"></a><span class="nl">pci_present</span><span class="p">:</span>
<a id="line-9726" name="line-9726"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9727" name="line-9727"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9728" name="line-9728"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">installation</span><span class="w"> </span><span class="n">check</span>
<a id="line-9729" name="line-9729"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f02</span>
<a id="line-9730" name="line-9730"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0001</span>
<a id="line-9731" name="line-9731"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0210</span>
<a id="line-9732" name="line-9732"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9733" name="line-9733"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20494350</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;PCI &quot;</span>
<a id="line-9734" name="line-9734"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf0000</span>
<a id="line-9735" name="line-9735"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pcibios_protected</span>
<a id="line-9736" name="line-9736"></a><span class="w">  </span><span class="n">clc</span>
<a id="line-9737" name="line-9737"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9738" name="line-9738"></a><span class="nl">pci_real_f02</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span>
<a id="line-9739" name="line-9739"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9740" name="line-9740"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9741" name="line-9741"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9742" name="line-9742"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f03</span>
<a id="line-9743" name="line-9743"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-9744" name="line-9744"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9745" name="line-9745"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9746" name="line-9746"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-9747" name="line-9747"></a><span class="nl">pci_real_devloop</span><span class="p">:</span>
<a id="line-9748" name="line-9748"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9749" name="line-9749"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9750" name="line-9750"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9751" name="line-9751"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9752" name="line-9752"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_nextdev</span>
<a id="line-9753" name="line-9753"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9754" name="line-9754"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">pci_real_ok</span>
<a id="line-9755" name="line-9755"></a><span class="w">  </span><span class="n">dec</span><span class="w"> </span><span class="n">si</span>
<a id="line-9756" name="line-9756"></a><span class="nl">pci_real_nextdev</span><span class="p">:</span>
<a id="line-9757" name="line-9757"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9758" name="line-9758"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-9759" name="line-9759"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_devloop</span>
<a id="line-9760" name="line-9760"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9761" name="line-9761"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-9762" name="line-9762"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x8602</span>
<a id="line-9763" name="line-9763"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_fail</span>
<a id="line-9764" name="line-9764"></a><span class="nl">pci_real_f03</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="n">code</span>
<a id="line-9765" name="line-9765"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9766" name="line-9766"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f08</span>
<a id="line-9767" name="line-9767"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9768" name="line-9768"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-9769" name="line-9769"></a><span class="nl">pci_real_devloop2</span><span class="p">:</span>
<a id="line-9770" name="line-9770"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9771" name="line-9771"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9772" name="line-9772"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9773" name="line-9773"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span>
<a id="line-9774" name="line-9774"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9775" name="line-9775"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_nextdev2</span>
<a id="line-9776" name="line-9776"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-9777" name="line-9777"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">pci_real_ok</span>
<a id="line-9778" name="line-9778"></a><span class="w">  </span><span class="n">dec</span><span class="w"> </span><span class="n">si</span>
<a id="line-9779" name="line-9779"></a><span class="nl">pci_real_nextdev2</span><span class="p">:</span>
<a id="line-9780" name="line-9780"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">bx</span>
<a id="line-9781" name="line-9781"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-9782" name="line-9782"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_devloop2</span>
<a id="line-9783" name="line-9783"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9784" name="line-9784"></a><span class="w">  </span><span class="n">shr</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">16</span>
<a id="line-9785" name="line-9785"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x8603</span>
<a id="line-9786" name="line-9786"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_fail</span>
<a id="line-9787" name="line-9787"></a><span class="nl">pci_real_f08</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9788" name="line-9788"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-9789" name="line-9789"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f09</span>
<a id="line-9790" name="line-9790"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9791" name="line-9791"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9792" name="line-9792"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9793" name="line-9793"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9794" name="line-9794"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9795" name="line-9795"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9796" name="line-9796"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9797" name="line-9797"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9798" name="line-9798"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9799" name="line-9799"></a><span class="nl">pci_real_f09</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">word</span>
<a id="line-9800" name="line-9800"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x09</span>
<a id="line-9801" name="line-9801"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f0a</span>
<a id="line-9802" name="line-9802"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9803" name="line-9803"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9804" name="line-9804"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9805" name="line-9805"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9806" name="line-9806"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9807" name="line-9807"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9808" name="line-9808"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9809" name="line-9809"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9810" name="line-9810"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9811" name="line-9811"></a><span class="nl">pci_real_f0a</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">dword</span>
<a id="line-9812" name="line-9812"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0a</span>
<a id="line-9813" name="line-9813"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f0b</span>
<a id="line-9814" name="line-9814"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9815" name="line-9815"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9816" name="line-9816"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9817" name="line-9817"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9818" name="line-9818"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9819" name="line-9819"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9820" name="line-9820"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9821" name="line-9821"></a><span class="nl">pci_real_f0b</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">byte</span>
<a id="line-9822" name="line-9822"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0b</span>
<a id="line-9823" name="line-9823"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f0c</span>
<a id="line-9824" name="line-9824"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9825" name="line-9825"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9826" name="line-9826"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9827" name="line-9827"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-9828" name="line-9828"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9829" name="line-9829"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span>
<a id="line-9830" name="line-9830"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-9831" name="line-9831"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9832" name="line-9832"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9833" name="line-9833"></a><span class="nl">pci_real_f0c</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">word</span>
<a id="line-9834" name="line-9834"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0c</span>
<a id="line-9835" name="line-9835"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f0d</span>
<a id="line-9836" name="line-9836"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9837" name="line-9837"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9838" name="line-9838"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">di</span>
<a id="line-9839" name="line-9839"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-9840" name="line-9840"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9841" name="line-9841"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9842" name="line-9842"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-9843" name="line-9843"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9844" name="line-9844"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9845" name="line-9845"></a><span class="nl">pci_real_f0d</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">dword</span>
<a id="line-9846" name="line-9846"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0d</span>
<a id="line-9847" name="line-9847"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_f0e</span>
<a id="line-9848" name="line-9848"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pci_real_select_reg</span>
<a id="line-9849" name="line-9849"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9850" name="line-9850"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-9851" name="line-9851"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-9852" name="line-9852"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-9853" name="line-9853"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9854" name="line-9854"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9855" name="line-9855"></a><span class="nl">pci_real_f0e</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="n">routing</span><span class="w"> </span><span class="n">options</span>
<a id="line-9856" name="line-9856"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0e</span>
<a id="line-9857" name="line-9857"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">pci_real_unknown</span>
<a id="line-9858" name="line-9858"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-9859" name="line-9859"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pci_routing_table_structure_start</span>
<a id="line-9860" name="line-9860"></a><span class="w">  </span><span class="n">jb</span><span class="w"> </span><span class="n">pci_real_too_small</span>
<a id="line-9861" name="line-9861"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-9862" name="line-9862"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pci_routing_table_structure_start</span>
<a id="line-9863" name="line-9863"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-9864" name="line-9864"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-9865" name="line-9865"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-9866" name="line-9866"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9867" name="line-9867"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">si</span>
<a id="line-9868" name="line-9868"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">di</span>
<a id="line-9869" name="line-9869"></a><span class="w">  </span><span class="n">cld</span>
<a id="line-9870" name="line-9870"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure_start</span>
<a id="line-9871" name="line-9871"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">cs</span>
<a id="line-9872" name="line-9872"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-9873" name="line-9873"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-9874" name="line-9874"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
<a id="line-9875" name="line-9875"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-9876" name="line-9876"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
<a id="line-9877" name="line-9877"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9878" name="line-9878"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pci_routing_table_structure_start</span>
<a id="line-9879" name="line-9879"></a><span class="w">  </span><span class="n">rep</span>
<a id="line-9880" name="line-9880"></a><span class="w">      </span><span class="n">movsb</span>
<a id="line-9881" name="line-9881"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">di</span>
<a id="line-9882" name="line-9882"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">si</span>
<a id="line-9883" name="line-9883"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">cx</span>
<a id="line-9884" name="line-9884"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-9885" name="line-9885"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-9886" name="line-9886"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-9887" name="line-9887"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">used</span>
<a id="line-9888" name="line-9888"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_ok</span>
<a id="line-9889" name="line-9889"></a><span class="nl">pci_real_too_small</span><span class="p">:</span>
<a id="line-9890" name="line-9890"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">ES</span>
<a id="line-9891" name="line-9891"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">di</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pci_routing_table_structure_start</span>
<a id="line-9892" name="line-9892"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x89</span>
<a id="line-9893" name="line-9893"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">pci_real_fail</span>
<a id="line-9894" name="line-9894"></a>
<a id="line-9895" name="line-9895"></a><span class="nl">pci_real_unknown</span><span class="p">:</span>
<a id="line-9896" name="line-9896"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x81</span>
<a id="line-9897" name="line-9897"></a><span class="nl">pci_real_fail</span><span class="p">:</span>
<a id="line-9898" name="line-9898"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9899" name="line-9899"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9900" name="line-9900"></a><span class="w">  </span><span class="n">stc</span>
<a id="line-9901" name="line-9901"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9902" name="line-9902"></a><span class="nl">pci_real_ok</span><span class="p">:</span>
<a id="line-9903" name="line-9903"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span>
<a id="line-9904" name="line-9904"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span>
<a id="line-9905" name="line-9905"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span>
<a id="line-9906" name="line-9906"></a><span class="w">  </span><span class="n">clc</span>
<a id="line-9907" name="line-9907"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9908" name="line-9908"></a>
<a id="line-9909" name="line-9909"></a><span class="nl">pci_real_select_reg</span><span class="p">:</span>
<a id="line-9910" name="line-9910"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9911" name="line-9911"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x800000</span>
<a id="line-9912" name="line-9912"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w">  </span><span class="n">bx</span>
<a id="line-9913" name="line-9913"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span>
<a id="line-9914" name="line-9914"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0xff</span>
<a id="line-9915" name="line-9915"></a><span class="w">  </span><span class="n">or</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w">  </span><span class="n">di</span>
<a id="line-9916" name="line-9916"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0xfc</span>
<a id="line-9917" name="line-9917"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0x0cf8</span>
<a id="line-9918" name="line-9918"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w">  </span><span class="n">eax</span>
<a id="line-9919" name="line-9919"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">dx</span>
<a id="line-9920" name="line-9920"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-9921" name="line-9921"></a>
<a id="line-9922" name="line-9922"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-9923" name="line-9923"></a><span class="nl">pci_routing_table_structure</span><span class="p">:</span>
<a id="line-9924" name="line-9924"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x24</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span><span class="p">,</span><span class="w"> </span><span class="mh">0x49</span><span class="p">,</span><span class="w"> </span><span class="mh">0x52</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;$PIR&quot;</span><span class="w"> </span><span class="n">signature</span>
<a id="line-9925" name="line-9925"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">version</span>
<a id="line-9926" name="line-9926"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">size</span>
<a id="line-9927" name="line-9927"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">router</span><span class="w"> </span><span class="n">bus</span>
<a id="line-9928" name="line-9928"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x08</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">router</span><span class="w"> </span><span class="n">DevFunc</span>
<a id="line-9929" name="line-9929"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0000</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">exclusive</span><span class="w"> </span><span class="n">IRQs</span>
<a id="line-9930" name="line-9930"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x8086</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">compatible</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">router</span><span class="w"> </span><span class="n">vendor</span><span class="w"> </span><span class="n">ID</span>
<a id="line-9931" name="line-9931"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x122e</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">compatible</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">router</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">ID</span>
<a id="line-9932" name="line-9932"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Miniport</span><span class="w"> </span><span class="n">data</span>
<a id="line-9933" name="line-9933"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9934" name="line-9934"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x37</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">checksum</span>
<a id="line-9935" name="line-9935"></a><span class="nl">pci_routing_table_structure_start</span><span class="p">:</span>
<a id="line-9936" name="line-9936"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">PCI</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">ISA</span><span class="w"> </span><span class="p">(</span><span class="n">embedded</span><span class="p">)</span>
<a id="line-9937" name="line-9937"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-9938" name="line-9938"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x08</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-9939" name="line-9939"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span><span class="o">:</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">PCI2ISA</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="n">space</span>
<a id="line-9940" name="line-9940"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9941" name="line-9941"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9942" name="line-9942"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9943" name="line-9943"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9944" name="line-9944"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9945" name="line-9945"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9946" name="line-9946"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9947" name="line-9947"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-9948" name="line-9948"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9949" name="line-9949"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">second</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="n">st</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">slot</span>
<a id="line-9950" name="line-9950"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-9951" name="line-9951"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-9952" name="line-9952"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9953" name="line-9953"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9954" name="line-9954"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9955" name="line-9955"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9956" name="line-9956"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9957" name="line-9957"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9958" name="line-9958"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9959" name="line-9959"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9960" name="line-9960"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-9961" name="line-9961"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9962" name="line-9962"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">third</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="n">nd</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">slot</span>
<a id="line-9963" name="line-9963"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-9964" name="line-9964"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x18</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-9965" name="line-9965"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9966" name="line-9966"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9967" name="line-9967"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9968" name="line-9968"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9969" name="line-9969"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9970" name="line-9970"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9971" name="line-9971"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9972" name="line-9972"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9973" name="line-9973"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-9974" name="line-9974"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9975" name="line-9975"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">4</span><span class="n">th</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="n">rd</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">slot</span>
<a id="line-9976" name="line-9976"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-9977" name="line-9977"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-9978" name="line-9978"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9979" name="line-9979"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9980" name="line-9980"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9981" name="line-9981"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9982" name="line-9982"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9983" name="line-9983"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9984" name="line-9984"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9985" name="line-9985"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9986" name="line-9986"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-9987" name="line-9987"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-9988" name="line-9988"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">5</span><span class="n">th</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="n">rd</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">slot</span>
<a id="line-9989" name="line-9989"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-9990" name="line-9990"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x28</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-9991" name="line-9991"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9992" name="line-9992"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-9993" name="line-9993"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9994" name="line-9994"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-9995" name="line-9995"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9996" name="line-9996"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-9997" name="line-9997"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9998" name="line-9998"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-9999" name="line-9999"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-10000" name="line-10000"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-10001" name="line-10001"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mi">6</span><span class="n">th</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">entry</span><span class="o">:</span><span class="w"> </span><span class="mi">5</span><span class="n">rd</span><span class="w"> </span><span class="n">PCI</span><span class="w"> </span><span class="n">slot</span>
<a id="line-10002" name="line-10002"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">number</span>
<a id="line-10003" name="line-10003"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x30</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="mi">7-3</span><span class="p">)</span>
<a id="line-10004" name="line-10004"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x62</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-10005" name="line-10005"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTA</span><span class="err">#</span>
<a id="line-10006" name="line-10006"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x63</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-10007" name="line-10007"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTB</span><span class="err">#</span>
<a id="line-10008" name="line-10008"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x60</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-10009" name="line-10009"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTC</span><span class="err">#</span>
<a id="line-10010" name="line-10010"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-10011" name="line-10011"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0c20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="n">bitmap</span><span class="w"> </span><span class="n">INTD</span><span class="err">#</span>
<a id="line-10012" name="line-10012"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="nf">slot</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">embedded</span><span class="p">)</span>
<a id="line-10013" name="line-10013"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-10014" name="line-10014"></a><span class="nl">pci_routing_table_structure_end</span><span class="p">:</span>
<a id="line-10015" name="line-10015"></a>
<a id="line-10016" name="line-10016"></a><span class="cp">#if !BX_ROMBIOS32 &amp;&amp; !defined(HVMASSIST)</span>
<a id="line-10017" name="line-10017"></a><span class="nl">pci_irq_list</span><span class="p">:</span>
<a id="line-10018" name="line-10018"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="line-10019" name="line-10019"></a>
<a id="line-10020" name="line-10020"></a><span class="nl">pcibios_init_sel_reg</span><span class="p">:</span>
<a id="line-10021" name="line-10021"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10022" name="line-10022"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x800000</span>
<a id="line-10023" name="line-10023"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10024" name="line-10024"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">8</span>
<a id="line-10025" name="line-10025"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">dl</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0xfc</span>
<a id="line-10026" name="line-10026"></a><span class="w">  </span><span class="n">or</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w">  </span><span class="n">dl</span>
<a id="line-10027" name="line-10027"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="mh">0x0cf8</span>
<a id="line-10028" name="line-10028"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w">  </span><span class="n">eax</span>
<a id="line-10029" name="line-10029"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10030" name="line-10030"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10031" name="line-10031"></a>
<a id="line-10032" name="line-10032"></a><span class="nl">pcibios_init_iomem_bases</span><span class="p">:</span>
<a id="line-10033" name="line-10033"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-10034" name="line-10034"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-10035" name="line-10035"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xe0000000</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">init</span>
<a id="line-10036" name="line-10036"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10037" name="line-10037"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc000</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="w"> </span><span class="n">init</span>
<a id="line-10038" name="line-10038"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10039" name="line-10039"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0010</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-10040" name="line-10040"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10041" name="line-10041"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0008</span>
<a id="line-10042" name="line-10042"></a><span class="nl">pci_init_io_loop1</span><span class="p">:</span>
<a id="line-10043" name="line-10043"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10044" name="line-10044"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10045" name="line-10045"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10046" name="line-10046"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10047" name="line-10047"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffff</span>
<a id="line-10048" name="line-10048"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">next_pci_dev</span>
<a id="line-10049" name="line-10049"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">access</span>
<a id="line-10050" name="line-10050"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10051" name="line-10051"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10052" name="line-10052"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10053" name="line-10053"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfc</span>
<a id="line-10054" name="line-10054"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10055" name="line-10055"></a><span class="nl">pci_init_io_loop2</span><span class="p">:</span>
<a id="line-10056" name="line-10056"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-8</span><span class="p">]</span>
<a id="line-10057" name="line-10057"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10058" name="line-10058"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10059" name="line-10059"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10060" name="line-10060"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-10061" name="line-10061"></a><span class="w">  </span><span class="n">jnz</span><span class="w">  </span><span class="n">init_io_base</span>
<a id="line-10062" name="line-10062"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10063" name="line-10063"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffffffff</span>
<a id="line-10064" name="line-10064"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10065" name="line-10065"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10066" name="line-10066"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-10067" name="line-10067"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">next_pci_base</span>
<a id="line-10068" name="line-10068"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffffffff</span>
<a id="line-10069" name="line-10069"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10070" name="line-10070"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-4</span><span class="p">]</span>
<a id="line-10071" name="line-10071"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10072" name="line-10072"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">ecx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="n">base</span>
<a id="line-10073" name="line-10073"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01000000</span>
<a id="line-10074" name="line-10074"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff000000</span>
<a id="line-10075" name="line-10075"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bp</span><span class="mi">-4</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10076" name="line-10076"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">next_pci_base</span>
<a id="line-10077" name="line-10077"></a><span class="nl">init_io_base</span><span class="p">:</span>
<a id="line-10078" name="line-10078"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10079" name="line-10079"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffff</span>
<a id="line-10080" name="line-10080"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10081" name="line-10081"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10082" name="line-10082"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10083" name="line-10083"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">next_pci_base</span>
<a id="line-10084" name="line-10084"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfffe</span>
<a id="line-10085" name="line-10085"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10086" name="line-10086"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-6</span><span class="p">]</span>
<a id="line-10087" name="line-10087"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10088" name="line-10088"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">calculate</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="w"> </span><span class="n">base</span>
<a id="line-10089" name="line-10089"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-10090" name="line-10090"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff00</span>
<a id="line-10091" name="line-10091"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bp</span><span class="mi">-6</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10092" name="line-10092"></a><span class="nl">next_pci_base</span><span class="p">:</span>
<a id="line-10093" name="line-10093"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-8</span><span class="p">]</span>
<a id="line-10094" name="line-10094"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-10095" name="line-10095"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x28</span>
<a id="line-10096" name="line-10096"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">enable_iomem_space</span>
<a id="line-10097" name="line-10097"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">bp</span><span class="mi">-8</span><span class="p">],</span><span class="w"> </span><span class="n">al</span>
<a id="line-10098" name="line-10098"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">pci_init_io_loop2</span>
<a id="line-10099" name="line-10099"></a><span class="nl">enable_iomem_space</span><span class="p">:</span>
<a id="line-10100" name="line-10100"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">space</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">available</span>
<a id="line-10101" name="line-10101"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10102" name="line-10102"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10103" name="line-10103"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10104" name="line-10104"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span>
<a id="line-10105" name="line-10105"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10106" name="line-10106"></a><span class="nl">next_pci_dev</span><span class="p">:</span>
<a id="line-10107" name="line-10107"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">bp</span><span class="mi">-8</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-10108" name="line-10108"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10109" name="line-10109"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span>
<a id="line-10110" name="line-10110"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">pci_init_io_loop1</span>
<a id="line-10111" name="line-10111"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span>
<a id="line-10112" name="line-10112"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-10113" name="line-10113"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10114" name="line-10114"></a>
<a id="line-10115" name="line-10115"></a><span class="nl">pcibios_init_set_elcr</span><span class="p">:</span>
<a id="line-10116" name="line-10116"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10117" name="line-10117"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10118" name="line-10118"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04d0</span>
<a id="line-10119" name="line-10119"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-10120" name="line-10120"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">is_master_pic</span>
<a id="line-10121" name="line-10121"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10122" name="line-10122"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span>
<a id="line-10123" name="line-10123"></a><span class="nl">is_master_pic</span><span class="p">:</span>
<a id="line-10124" name="line-10124"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10125" name="line-10125"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-10126" name="line-10126"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span>
<a id="line-10127" name="line-10127"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10128" name="line-10128"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span>
<a id="line-10129" name="line-10129"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10130" name="line-10130"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">cx</span>
<a id="line-10131" name="line-10131"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-10132" name="line-10132"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10133" name="line-10133"></a>
<a id="line-10134" name="line-10134"></a><span class="nl">pcibios_init_irqs</span><span class="p">:</span>
<a id="line-10135" name="line-10135"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10136" name="line-10136"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-10137" name="line-10137"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-10138" name="line-10138"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10139" name="line-10139"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04d0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">ELCR1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ELCR2</span>
<a id="line-10140" name="line-10140"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10141" name="line-10141"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10142" name="line-10142"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10143" name="line-10143"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10144" name="line-10144"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pci_routing_table_structure</span>
<a id="line-10145" name="line-10145"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
<a id="line-10146" name="line-10146"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">9</span><span class="p">]</span>
<a id="line-10147" name="line-10147"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10148" name="line-10148"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10149" name="line-10149"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10150" name="line-10150"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10151" name="line-10151"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="n">router</span>
<a id="line-10152" name="line-10152"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">pci_init_end</span>
<a id="line-10153" name="line-10153"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">34</span><span class="p">]</span>
<a id="line-10154" name="line-10154"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10155" name="line-10155"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="n">router</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">devfunc</span>
<a id="line-10156" name="line-10156"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10157" name="line-10157"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x8080</span>
<a id="line-10158" name="line-10158"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">PIRQ</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="n">control</span>
<a id="line-10159" name="line-10159"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-10160" name="line-10160"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10161" name="line-10161"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
<a id="line-10162" name="line-10162"></a><span class="w">  </span><span class="n">sub</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-10163" name="line-10163"></a><span class="w">  </span><span class="n">shr</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span>
<a id="line-10164" name="line-10164"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10165" name="line-10165"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">1</span><span class="n">st</span><span class="w"> </span><span class="n">entry</span>
<a id="line-10166" name="line-10166"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-10167" name="line-10167"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">pci_irq_list</span>
<a id="line-10168" name="line-10168"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10169" name="line-10169"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10170" name="line-10170"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10171" name="line-10171"></a><span class="nl">pci_init_irq_loop1</span><span class="p">:</span>
<a id="line-10172" name="line-10172"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
<a id="line-10173" name="line-10173"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<a id="line-10174" name="line-10174"></a><span class="nl">pci_init_irq_loop2</span><span class="p">:</span>
<a id="line-10175" name="line-10175"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10176" name="line-10176"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10177" name="line-10177"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10178" name="line-10178"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10179" name="line-10179"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffff</span>
<a id="line-10180" name="line-10180"></a><span class="w">  </span><span class="n">jnz</span><span class="w">  </span><span class="n">pci_test_int_pin</span>
<a id="line-10181" name="line-10181"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span>
<a id="line-10182" name="line-10182"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">next_pir_entry</span>
<a id="line-10183" name="line-10183"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">next_pci_func</span>
<a id="line-10184" name="line-10184"></a><span class="nl">pci_test_int_pin</span><span class="p">:</span>
<a id="line-10185" name="line-10185"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3c</span>
<a id="line-10186" name="line-10186"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10187" name="line-10187"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfd</span>
<a id="line-10188" name="line-10188"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10189" name="line-10189"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span>
<a id="line-10190" name="line-10190"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">next_pci_func</span>
<a id="line-10191" name="line-10191"></a><span class="w">  </span><span class="n">dec</span><span class="w">  </span><span class="n">al</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">determine</span><span class="w"> </span><span class="n">pirq</span><span class="w"> </span><span class="n">reg</span>
<a id="line-10192" name="line-10192"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-10193" name="line-10193"></a><span class="w">  </span><span class="n">mul</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dl</span>
<a id="line-10194" name="line-10194"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10195" name="line-10195"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span>
<a id="line-10196" name="line-10196"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10197" name="line-10197"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="n">bx</span><span class="p">]</span>
<a id="line-10198" name="line-10198"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10199" name="line-10199"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="p">]</span>
<a id="line-10200" name="line-10200"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10201" name="line-10201"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10202" name="line-10202"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-10203" name="line-10203"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10204" name="line-10204"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10205" name="line-10205"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80</span>
<a id="line-10206" name="line-10206"></a><span class="w">  </span><span class="n">jb</span><span class="w">   </span><span class="n">pirq_found</span>
<a id="line-10207" name="line-10207"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-2</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">irq</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">pointer</span>
<a id="line-10208" name="line-10208"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-10209" name="line-10209"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10210" name="line-10210"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10211" name="line-10211"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bp</span><span class="mi">-2</span><span class="p">],</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10212" name="line-10212"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_set_elcr</span>
<a id="line-10213" name="line-10213"></a><span class="nl">pirq_found</span><span class="p">:</span>
<a id="line-10214" name="line-10214"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bh</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
<a id="line-10215" name="line-10215"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<a id="line-10216" name="line-10216"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="mi">-3</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">pci</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">number</span>
<a id="line-10217" name="line-10217"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3c</span>
<a id="line-10218" name="line-10218"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_sel_reg</span>
<a id="line-10219" name="line-10219"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0cfc</span>
<a id="line-10220" name="line-10220"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10221" name="line-10221"></a><span class="nl">next_pci_func</span><span class="p">:</span>
<a id="line-10222" name="line-10222"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">bp</span><span class="mi">-3</span><span class="p">]</span>
<a id="line-10223" name="line-10223"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bl</span>
<a id="line-10224" name="line-10224"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x07</span>
<a id="line-10225" name="line-10225"></a><span class="w">  </span><span class="n">jnz</span><span class="w">  </span><span class="n">pci_init_irq_loop2</span>
<a id="line-10226" name="line-10226"></a><span class="nl">next_pir_entry</span><span class="p">:</span>
<a id="line-10227" name="line-10227"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-10228" name="line-10228"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">byte</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">bp</span><span class="mi">-3</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10229" name="line-10229"></a><span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="n">pci_init_irq_loop1</span>
<a id="line-10230" name="line-10230"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span>
<a id="line-10231" name="line-10231"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10232" name="line-10232"></a><span class="nl">pci_init_end</span><span class="p">:</span>
<a id="line-10233" name="line-10233"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-10234" name="line-10234"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-10235" name="line-10235"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10236" name="line-10236"></a><span class="cp">#endif </span><span class="c1">// !BX_ROMBIOS32</span>
<a id="line-10237" name="line-10237"></a><span class="cp">#endif </span><span class="c1">// BX_PCIBIOS</span>
<a id="line-10238" name="line-10238"></a>
<a id="line-10239" name="line-10239"></a><span class="cp">#if BX_ROMBIOS32</span>
<a id="line-10240" name="line-10240"></a><span class="nl">rombios32_init</span><span class="p">:</span>
<a id="line-10241" name="line-10241"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">a20</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">it</span>
<a id="line-10242" name="line-10242"></a><span class="w">  </span><span class="n">in</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x92</span>
<a id="line-10243" name="line-10243"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10244" name="line-10244"></a><span class="w">  </span><span class="n">or</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10245" name="line-10245"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x92</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10246" name="line-10246"></a>
<a id="line-10247" name="line-10247"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="n">SS</span><span class="o">:</span><span class="n">SP</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BDA</span>
<a id="line-10248" name="line-10248"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10249" name="line-10249"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10250" name="line-10250"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x0469</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span>
<a id="line-10251" name="line-10251"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x0467</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-10252" name="line-10252"></a>
<a id="line-10253" name="line-10253"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">CS</span>
<a id="line-10254" name="line-10254"></a><span class="w">    </span><span class="n">lidt</span><span class="w"> </span><span class="p">[</span><span class="n">pmode_IDT_info</span><span class="p">]</span>
<a id="line-10255" name="line-10255"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">CS</span>
<a id="line-10256" name="line-10256"></a><span class="w">    </span><span class="n">lgdt</span><span class="w"> </span><span class="p">[</span><span class="n">rombios32_gdt_48</span><span class="p">]</span>
<a id="line-10257" name="line-10257"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">PE</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CR0</span>
<a id="line-10258" name="line-10258"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">cr0</span>
<a id="line-10259" name="line-10259"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-10260" name="line-10260"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10261" name="line-10261"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">code</span><span class="o">:</span><span class="w"> </span><span class="n">ljmpl</span><span class="w"> </span><span class="mh">0x10</span><span class="o">:</span><span class="n">rombios32_init1</span>
<a id="line-10262" name="line-10262"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xea</span>
<a id="line-10263" name="line-10263"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="n">rombios32_05</span>
<a id="line-10264" name="line-10264"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x000f</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">address</span>
<a id="line-10265" name="line-10265"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x0010</span>
<a id="line-10266" name="line-10266"></a>
<a id="line-10267" name="line-10267"></a><span class="n">use32</span><span class="w"> </span><span class="mi">386</span>
<a id="line-10268" name="line-10268"></a><span class="nl">rombios32_05</span><span class="p">:</span>
<a id="line-10269" name="line-10269"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">segments</span>
<a id="line-10270" name="line-10270"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x18</span>
<a id="line-10271" name="line-10271"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10272" name="line-10272"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10273" name="line-10273"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10274" name="line-10274"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10275" name="line-10275"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10276" name="line-10276"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">gs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10277" name="line-10277"></a><span class="w">  </span><span class="n">cld</span>
<a id="line-10278" name="line-10278"></a>
<a id="line-10279" name="line-10279"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="n">EBDA</span>
<a id="line-10280" name="line-10280"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mh">0x040e</span><span class="p">]</span>
<a id="line-10281" name="line-10281"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span>
<a id="line-10282" name="line-10282"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">-0x10</span>
<a id="line-10283" name="line-10283"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10284" name="line-10284"></a>
<a id="line-10285" name="line-10285"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">s3_resume_flag</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">s3_resume_vector</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rombios32</span>
<a id="line-10286" name="line-10286"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04b0</span>
<a id="line-10287" name="line-10287"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04b2</span>
<a id="line-10288" name="line-10288"></a>
<a id="line-10289" name="line-10289"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">rombios32</span><span class="w"> </span><span class="n">code</span>
<a id="line-10290" name="line-10290"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x000e0000</span>
<a id="line-10291" name="line-10291"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10292" name="line-10292"></a>
<a id="line-10293" name="line-10293"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">first</span>
<a id="line-10294" name="line-10294"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0xea</span>
<a id="line-10295" name="line-10295"></a><span class="w">  </span><span class="n">dd</span><span class="w"> </span><span class="n">rombios32_10</span>
<a id="line-10296" name="line-10296"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x20</span>
<a id="line-10297" name="line-10297"></a>
<a id="line-10298" name="line-10298"></a><span class="n">use16</span><span class="w"> </span><span class="mi">386</span>
<a id="line-10299" name="line-10299"></a><span class="nl">rombios32_10</span><span class="p">:</span>
<a id="line-10300" name="line-10300"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mh">0xffff</span>
<a id="line-10301" name="line-10301"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x28</span>
<a id="line-10302" name="line-10302"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10303" name="line-10303"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10304" name="line-10304"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10305" name="line-10305"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10306" name="line-10306"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">gs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10307" name="line-10307"></a>
<a id="line-10308" name="line-10308"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">PE</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CR0</span>
<a id="line-10309" name="line-10309"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">cr0</span>
<a id="line-10310" name="line-10310"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xFE</span>
<a id="line-10311" name="line-10311"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cr0</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10312" name="line-10312"></a>
<a id="line-10313" name="line-10313"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">jump</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="n">CPU</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">transition</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">mode</span>
<a id="line-10314" name="line-10314"></a><span class="w">  </span><span class="n">JMP_AP</span><span class="p">(</span><span class="mh">0xf000</span><span class="p">,</span><span class="w"> </span><span class="n">rombios32_real_mode</span><span class="p">)</span>
<a id="line-10315" name="line-10315"></a>
<a id="line-10316" name="line-10316"></a><span class="nl">rombios32_real_mode</span><span class="p">:</span>
<a id="line-10317" name="line-10317"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">IDT</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">real</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">defaults</span>
<a id="line-10318" name="line-10318"></a><span class="w">  </span><span class="n">SEG</span><span class="w"> </span><span class="n">CS</span>
<a id="line-10319" name="line-10319"></a><span class="w">    </span><span class="n">lidt</span><span class="w"> </span><span class="p">[</span><span class="n">rmode_IDT_info</span><span class="p">]</span>
<a id="line-10320" name="line-10320"></a>
<a id="line-10321" name="line-10321"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10322" name="line-10322"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10323" name="line-10323"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10324" name="line-10324"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10325" name="line-10325"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">gs</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10326" name="line-10326"></a>
<a id="line-10327" name="line-10327"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">SS</span><span class="o">:</span><span class="n">SP</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BDA</span>
<a id="line-10328" name="line-10328"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0469</span>
<a id="line-10329" name="line-10329"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="n">esp</span>
<a id="line-10330" name="line-10330"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0467</span>
<a id="line-10331" name="line-10331"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">a20</span>
<a id="line-10332" name="line-10332"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10333" name="line-10333"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x92</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10334" name="line-10334"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10335" name="line-10335"></a>
<a id="line-10336" name="line-10336"></a><span class="nl">rombios32_gdt_48</span><span class="p">:</span>
<a id="line-10337" name="line-10337"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x30</span>
<a id="line-10338" name="line-10338"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="n">rombios32_gdt</span>
<a id="line-10339" name="line-10339"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0x000f</span>
<a id="line-10340" name="line-10340"></a>
<a id="line-10341" name="line-10341"></a><span class="nl">rombios32_gdt</span><span class="p">:</span>
<a id="line-10342" name="line-10342"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<a id="line-10343" name="line-10343"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<a id="line-10344" name="line-10344"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9b00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00cf</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">flat</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
<a id="line-10345" name="line-10345"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00cf</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">flat</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="p">(</span><span class="mh">0x18</span><span class="p">)</span>
<a id="line-10346" name="line-10346"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9b0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">base</span><span class="o">=</span><span class="mh">0xf0000</span><span class="w"> </span><span class="n">limit</span><span class="o">=</span><span class="mh">0xffff</span>
<a id="line-10347" name="line-10347"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x9300</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">base</span><span class="o">=</span><span class="mh">0x0</span><span class="w"> </span><span class="n">limit</span><span class="o">=</span><span class="mh">0xffff</span>
<a id="line-10348" name="line-10348"></a><span class="cp">#endif </span><span class="c1">// BX_ROMBIOS32</span>
<a id="line-10349" name="line-10349"></a>
<a id="line-10350" name="line-10350"></a><span class="cp">#if BX_PMM</span>
<a id="line-10351" name="line-10351"></a><span class="p">;</span><span class="w"> </span><span class="n">according</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="n">Manager</span><span class="w"> </span><span class="n">Specification</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="mf">1.01</span>
<a id="line-10352" name="line-10352"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-10353" name="line-10353"></a><span class="nl">pmm_structure</span><span class="p">:</span>
<a id="line-10354" name="line-10354"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x24</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x4d</span><span class="p">,</span><span class="mh">0x4d</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="s">&quot;$PMM&quot;</span><span class="w"> </span><span class="n">signature</span>
<a id="line-10355" name="line-10355"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">revision</span>
<a id="line-10356" name="line-10356"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">length</span>
<a id="line-10357" name="line-10357"></a><span class="w">  </span><span class="nf">db</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">pmm_entry_point</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">pmm_entry_point</span><span class="o">+</span><span class="mh">0x20f</span><span class="p">))</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;;</span><span class="w"> </span><span class="n">checksum</span>
<a id="line-10358" name="line-10358"></a><span class="w">  </span><span class="n">dw</span><span class="w"> </span><span class="n">pmm_entry_point</span><span class="p">,</span><span class="mh">0xf000</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">entrypoint</span>
<a id="line-10359" name="line-10359"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-10360" name="line-10360"></a>
<a id="line-10361" name="line-10361"></a><span class="nl">pmm_entry_point</span><span class="p">:</span>
<a id="line-10362" name="line-10362"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-10363" name="line-10363"></a><span class="w">  </span><span class="n">pushad</span>
<a id="line-10364" name="line-10364"></a><span class="p">;</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">protected</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">PMM</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">args</span>
<a id="line-10365" name="line-10365"></a><span class="w">  </span><span class="n">xor</span><span class="w">	</span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span>
<a id="line-10366" name="line-10366"></a><span class="w">  </span><span class="n">mov</span><span class="w">	</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-10367" name="line-10367"></a><span class="w">  </span><span class="n">xor</span><span class="w">	</span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="n">ebx</span>
<a id="line-10368" name="line-10368"></a><span class="w">  </span><span class="n">mov</span><span class="w">	</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span>
<a id="line-10369" name="line-10369"></a><span class="w">  </span><span class="n">shl</span><span class="w">	</span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<a id="line-10370" name="line-10370"></a><span class="w">  </span><span class="n">lea</span><span class="w">	</span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="n">ebx</span><span class="o">+</span><span class="mi">38</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">ebx</span><span class="o">=</span><span class="p">(</span><span class="n">ss</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">sp</span><span class="o">+</span><span class="mi">4</span><span class="p">(</span><span class="n">far</span><span class="w"> </span><span class="n">call</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">(</span><span class="n">pushf</span><span class="p">)</span><span class="o">+</span><span class="mi">32</span><span class="p">(</span><span class="n">pushad</span><span class="p">)</span>
<a id="line-10371" name="line-10371"></a><span class="w">  </span><span class="n">push</span><span class="w">	</span><span class="n">ebx</span>
<a id="line-10372" name="line-10372"></a><span class="p">;</span>
<a id="line-10373" name="line-10373"></a><span class="p">;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">point</span><span class="o">:</span>
<a id="line-10374" name="line-10374"></a><span class="p">;</span>
<a id="line-10375" name="line-10375"></a><span class="p">;</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="o">+</span><span class="mh">0x0</span><span class="w">    </span><span class="o">+</span><span class="mh">0x2</span><span class="w">    </span><span class="o">+</span><span class="mh">0x4</span><span class="w">    </span><span class="o">+</span><span class="mh">0x6</span><span class="w">    </span><span class="o">+</span><span class="mh">0x8</span><span class="w">    </span><span class="o">+</span><span class="mh">0xa</span><span class="w">    </span><span class="o">+</span><span class="mh">0xc</span><span class="w">    </span><span class="o">+</span><span class="mh">0xe</span>
<a id="line-10376" name="line-10376"></a><span class="p">;</span><span class="w"> </span><span class="o">-----------------------------------------------------------------------</span>
<a id="line-10377" name="line-10377"></a><span class="p">;</span><span class="w"> </span><span class="n">sp</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">arg1</span><span class="w">         </span><span class="p">][</span><span class="n">edi</span><span class="w">           </span><span class="p">][</span><span class="n">esi</span><span class="w">           </span><span class="p">][</span><span class="n">ebp</span><span class="w">           </span><span class="p">]</span>
<a id="line-10378" name="line-10378"></a><span class="p">;</span><span class="w"> </span><span class="n">sp</span><span class="o">+</span><span class="mh">0x10</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">esp</span><span class="w">           </span><span class="p">][</span><span class="n">ebx</span><span class="w">           </span><span class="p">][</span><span class="n">edx</span><span class="w">           </span><span class="p">][</span><span class="n">ecx</span><span class="w">           </span><span class="p">]</span>
<a id="line-10379" name="line-10379"></a><span class="p">;</span><span class="w"> </span><span class="n">sp</span><span class="o">+</span><span class="mh">0x20</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">eax</span><span class="w">           </span><span class="p">][</span><span class="n">flags</span><span class="w"> </span><span class="p">][</span><span class="n">ip</span><span class="w">    </span><span class="p">][</span><span class="n">cs</span><span class="w">    </span><span class="p">][</span><span class="n">arg1</span><span class="w">  </span><span class="p">][</span><span class="n">arg2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>
<a id="line-10380" name="line-10380"></a><span class="p">;</span>
<a id="line-10381" name="line-10381"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_pmm</span>
<a id="line-10382" name="line-10382"></a><span class="w">  </span><span class="n">mov</span><span class="w">	</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-10383" name="line-10383"></a><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-10384" name="line-10384"></a><span class="w">  </span><span class="n">mov</span><span class="w">	</span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x20</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10385" name="line-10385"></a><span class="n">SEG</span><span class="w"> </span><span class="n">SS</span>
<a id="line-10386" name="line-10386"></a><span class="w">  </span><span class="n">mov</span><span class="w">	</span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10387" name="line-10387"></a><span class="w">  </span><span class="n">pop</span><span class="w">	</span><span class="n">ebx</span>
<a id="line-10388" name="line-10388"></a><span class="w">  </span><span class="n">popad</span>
<a id="line-10389" name="line-10389"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-10390" name="line-10390"></a><span class="w">  </span><span class="n">retf</span>
<a id="line-10391" name="line-10391"></a><span class="cp">#endif </span><span class="c1">// BX_PMM</span>
<a id="line-10392" name="line-10392"></a>
<a id="line-10393" name="line-10393"></a><span class="p">;</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">detection</span><span class="o">:</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CL</span>
<a id="line-10394" name="line-10394"></a><span class="nl">detect_parport</span><span class="p">:</span>
<a id="line-10395" name="line-10395"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10396" name="line-10396"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-10397" name="line-10397"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10398" name="line-10398"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xdf</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">mode</span>
<a id="line-10399" name="line-10399"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10400" name="line-10400"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10401" name="line-10401"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xaa</span>
<a id="line-10402" name="line-10402"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10403" name="line-10403"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10404" name="line-10404"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xaa</span>
<a id="line-10405" name="line-10405"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">no_parport</span>
<a id="line-10406" name="line-10406"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10407" name="line-10407"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-10408" name="line-10408"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x408</span><span class="p">],</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span>
<a id="line-10409" name="line-10409"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10410" name="line-10410"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x478</span><span class="p">],</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">printer</span><span class="w"> </span><span class="n">timeout</span>
<a id="line-10411" name="line-10411"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10412" name="line-10412"></a><span class="nl">no_parport</span><span class="p">:</span>
<a id="line-10413" name="line-10413"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10414" name="line-10414"></a>
<a id="line-10415" name="line-10415"></a><span class="p">;</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">detection</span><span class="o">:</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">DX</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BX</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">CL</span>
<a id="line-10416" name="line-10416"></a><span class="nl">detect_serial</span><span class="p">:</span>
<a id="line-10417" name="line-10417"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10418" name="line-10418"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10419" name="line-10419"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10420" name="line-10420"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10421" name="line-10421"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10422" name="line-10422"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10423" name="line-10423"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">no_serial</span>
<a id="line-10424" name="line-10424"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10425" name="line-10425"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10426" name="line-10426"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10427" name="line-10427"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">no_serial</span>
<a id="line-10428" name="line-10428"></a><span class="w">  </span><span class="n">dec</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10429" name="line-10429"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10430" name="line-10430"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10431" name="line-10431"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10432" name="line-10432"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10433" name="line-10433"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-10434" name="line-10434"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x400</span><span class="p">],</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span>
<a id="line-10435" name="line-10435"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10436" name="line-10436"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="o">+</span><span class="mh">0x47c</span><span class="p">],</span><span class="w"> </span><span class="n">cl</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">timeout</span>
<a id="line-10437" name="line-10437"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10438" name="line-10438"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10439" name="line-10439"></a><span class="nl">no_serial</span><span class="p">:</span>
<a id="line-10440" name="line-10440"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-10441" name="line-10441"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10442" name="line-10442"></a>
<a id="line-10443" name="line-10443"></a><span class="nl">rom_checksum</span><span class="p">:</span>
<a id="line-10444" name="line-10444"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-10445" name="line-10445"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10446" name="line-10446"></a>
<a id="line-10447" name="line-10447"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10448" name="line-10448"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10449" name="line-10449"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10450" name="line-10450"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10451" name="line-10451"></a>
<a id="line-10452" name="line-10452"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="line-10453" name="line-10453"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-10454" name="line-10454"></a>
<a id="line-10455" name="line-10455"></a><span class="w">  </span><span class="n">jnc</span><span class="w"> </span><span class="n">checksum_loop</span>
<a id="line-10456" name="line-10456"></a><span class="w">  </span><span class="n">jz</span><span class="w">  </span><span class="n">checksum_loop</span>
<a id="line-10457" name="line-10457"></a><span class="w">  </span><span class="n">xchg</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10458" name="line-10458"></a><span class="w">  </span><span class="n">dec</span><span class="w">  </span><span class="n">cx</span>
<a id="line-10459" name="line-10459"></a>
<a id="line-10460" name="line-10460"></a><span class="nl">checksum_loop</span><span class="p">:</span>
<a id="line-10461" name="line-10461"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-10462" name="line-10462"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span>
<a id="line-10463" name="line-10463"></a><span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="n">checksum_loop</span>
<a id="line-10464" name="line-10464"></a>
<a id="line-10465" name="line-10465"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10466" name="line-10466"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">checksum_out</span>
<a id="line-10467" name="line-10467"></a>
<a id="line-10468" name="line-10468"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-10469" name="line-10469"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10470" name="line-10470"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10471" name="line-10471"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">dh</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-10472" name="line-10472"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10473" name="line-10473"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10474" name="line-10474"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10475" name="line-10475"></a>
<a id="line-10476" name="line-10476"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">checksum_loop</span>
<a id="line-10477" name="line-10477"></a>
<a id="line-10478" name="line-10478"></a><span class="nl">checksum_out</span><span class="p">:</span>
<a id="line-10479" name="line-10479"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xff</span>
<a id="line-10480" name="line-10480"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-10481" name="line-10481"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-10482" name="line-10482"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10483" name="line-10483"></a>
<a id="line-10484" name="line-10484"></a>
<a id="line-10485" name="line-10485"></a><span class="p">;;</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">PnP</span><span class="w"> </span><span class="n">BIOS</span><span class="p">,</span>
<a id="line-10486" name="line-10486"></a><span class="p">;;</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="o">*</span><span class="n">not</span><span class="o">*</span><span class="w"> </span><span class="n">aligned</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">OSes</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">scan</span><span class="p">.</span>
<a id="line-10487" name="line-10487"></a><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-10488" name="line-10488"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span>
<a id="line-10489" name="line-10489"></a><span class="nl">pnp_string</span><span class="p">:</span>
<a id="line-10490" name="line-10490"></a><span class="w">  </span><span class="p">.</span><span class="n">ascii</span><span class="w"> </span><span class="s">&quot;$PnP&quot;</span>
<a id="line-10491" name="line-10491"></a>
<a id="line-10492" name="line-10492"></a><span class="nl">rom_scan</span><span class="p">:</span>
<a id="line-10493" name="line-10493"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">existence</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">ROMS</span><span class="p">.</span>
<a id="line-10494" name="line-10494"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">Video</span><span class="w"> </span><span class="n">ROM</span><span class="o">:</span><span class="w">   </span><span class="n">from</span><span class="w"> </span><span class="mh">0xC0000</span><span class="p">.</span><span class="mf">.0</span><span class="n">xC7FFF</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">2</span><span class="n">k</span><span class="w"> </span><span class="n">increments</span>
<a id="line-10495" name="line-10495"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">General</span><span class="w"> </span><span class="n">ROM</span><span class="o">:</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mh">0xC8000</span><span class="p">.</span><span class="mf">.0</span><span class="n">xE9FFF</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">2</span><span class="n">k</span><span class="w"> </span><span class="n">increments</span>
<a id="line-10496" name="line-10496"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">System</span><span class="w">  </span><span class="n">ROM</span><span class="o">:</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="mh">0xF0000</span>
<a id="line-10497" name="line-10497"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-10498" name="line-10498"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Header</span><span class="o">:</span>
<a id="line-10499" name="line-10499"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">Offset</span><span class="w">    </span><span class="n">Value</span>
<a id="line-10500" name="line-10500"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="mi">0</span><span class="w">         </span><span class="mh">0x55</span>
<a id="line-10501" name="line-10501"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="mi">1</span><span class="w">         </span><span class="mh">0xAA</span>
<a id="line-10502" name="line-10502"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="mi">2</span><span class="w">         </span><span class="n">ROM</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">512</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">blocks</span>
<a id="line-10503" name="line-10503"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="mi">3</span><span class="w">         </span><span class="n">ROM</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="n">CALL</span><span class="p">)</span>
<a id="line-10504" name="line-10504"></a>
<a id="line-10505" name="line-10505"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-10506" name="line-10506"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10507" name="line-10507"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_start_option_rom_scan</span><span class="w">    </span><span class="cm">/* specs: 3.2.3.3 + 10.4.3 */</span>
<a id="line-10508" name="line-10508"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10509" name="line-10509"></a><span class="cp">#endif</span>
<a id="line-10510" name="line-10510"></a>
<a id="line-10511" name="line-10511"></a><span class="nl">rom_scan_loop</span><span class="p">:</span>
<a id="line-10512" name="line-10512"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Save</span><span class="w"> </span><span class="n">AX</span>
<a id="line-10513" name="line-10513"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10514" name="line-10514"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0004</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">increment</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mi">512</span><span class="o">-</span><span class="n">byte</span><span class="p">)</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="n">k</span>
<a id="line-10515" name="line-10515"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0xAA55</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">signature</span>
<a id="line-10516" name="line-10516"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">rom_scan_increment</span>
<a id="line-10517" name="line-10517"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">rom_checksum</span>
<a id="line-10518" name="line-10518"></a><span class="w">  </span><span class="n">jnz</span><span class="w">  </span><span class="n">rom_scan_increment</span>
<a id="line-10519" name="line-10519"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">increment</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">512</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">blocks</span>
<a id="line-10520" name="line-10520"></a>
<a id="line-10521" name="line-10521"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">increment</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mi">512</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">quantities</span><span class="p">,</span><span class="w"> </span><span class="n">rounded</span><span class="w"> </span><span class="n">to</span>
<a id="line-10522" name="line-10522"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">nearest</span><span class="w"> </span><span class="mi">2</span><span class="n">k</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">2</span><span class="n">k</span><span class="w"> </span><span class="n">intervals</span><span class="p">.</span>
<a id="line-10523" name="line-10523"></a><span class="w">  </span><span class="n">test</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03</span>
<a id="line-10524" name="line-10524"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">block_count_rounded</span>
<a id="line-10525" name="line-10525"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfc</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">rounding</span><span class="w"> </span><span class="n">up</span>
<a id="line-10526" name="line-10526"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-10527" name="line-10527"></a><span class="nl">block_count_rounded</span><span class="p">:</span>
<a id="line-10528" name="line-10528"></a>
<a id="line-10529" name="line-10529"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-10530" name="line-10530"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10531" name="line-10531"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10532" name="line-10532"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-10533" name="line-10533"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10534" name="line-10534"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10535" name="line-10535"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xffff</span>
<a id="line-10536" name="line-10536"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ecx</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">located</span><span class="w"> </span><span class="n">at</span>
<a id="line-10537" name="line-10537"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_option_rom</span><span class="w">                   </span><span class="cm">/* specs: 3.2.3.3 */</span>
<a id="line-10538" name="line-10538"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">segment</span>
<a id="line-10539" name="line-10539"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ecx</span><span class="w">      </span><span class="p">;;</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">ecx</span>
<a id="line-10540" name="line-10540"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10541" name="line-10541"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10542" name="line-10542"></a><span class="cp">#endif</span>
<a id="line-10543" name="line-10543"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Save</span><span class="w"> </span><span class="n">AX</span>
<a id="line-10544" name="line-10544"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">di</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Save</span><span class="w"> </span><span class="n">DI</span>
<a id="line-10545" name="line-10545"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span>
<a id="line-10546" name="line-10546"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">seg</span>
<a id="line-10547" name="line-10547"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0003</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">offset</span>
<a id="line-10548" name="line-10548"></a>
<a id="line-10549" name="line-10549"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BDF</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">invoking</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">ROM</span>
<a id="line-10550" name="line-10550"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="line-10551" name="line-10551"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span>
<a id="line-10552" name="line-10552"></a><span class="w">  </span><span class="n">shr</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">7</span>
<a id="line-10553" name="line-10553"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span>
<a id="line-10554" name="line-10554"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">fetch_bdf</span>
<a id="line-10555" name="line-10555"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Increment</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">larger</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">segment</span>
<a id="line-10556" name="line-10556"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1000</span>
<a id="line-10557" name="line-10557"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10558" name="line-10558"></a><span class="nl">fetch_bdf</span><span class="p">:</span>
<a id="line-10559" name="line-10559"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">9</span>
<a id="line-10560" name="line-10560"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10561" name="line-10561"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">bx</span><span class="p">]</span>
<a id="line-10562" name="line-10562"></a>
<a id="line-10563" name="line-10563"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="n">ES</span><span class="o">:</span><span class="n">DI</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="s">&quot;$PnP&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">tells</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">PnP</span><span class="w"> </span><span class="n">BIOS</span><span class="p">.</span>
<a id="line-10564" name="line-10564"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">That</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">grabbing</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">19</span><span class="n">h</span><span class="p">;</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">BEV</span><span class="w"> </span><span class="n">instead</span><span class="p">.</span>
<a id="line-10565" name="line-10565"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-10566" name="line-10566"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10567" name="line-10567"></a><span class="w">  </span><span class="n">lea</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">pnp_string</span>
<a id="line-10568" name="line-10568"></a>
<a id="line-10569" name="line-10569"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mo">0000</span><span class="o">:</span>
<a id="line-10570" name="line-10570"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10571" name="line-10571"></a>
<a id="line-10572" name="line-10572"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">routine</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">seg</span><span class="o">:</span><span class="n">off</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stack</span>
<a id="line-10573" name="line-10573"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mh">0xff</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">call_far</span><span class="w"> </span><span class="n">ss</span><span class="o">:</span><span class="p">[</span><span class="n">bp</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
<a id="line-10574" name="line-10574"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mh">0x5e</span>
<a id="line-10575" name="line-10575"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mi">0</span>
<a id="line-10576" name="line-10576"></a><span class="w">  </span><span class="n">cli</span><span class="w">           </span><span class="p">;;</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">expansion</span><span class="w"> </span><span class="no">ROM</span><span class="w"> </span><span class="no">BIOS</span><span class="w"> </span><span class="no">turns</span><span class="w"> </span><span class="no">IF</span><span class="w"> </span><span class="no">on</span>
<a id="line-10577" name="line-10577"></a><span class="w">  </span><span class="no">add</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w">   </span><span class="err">;;</span><span class="w"> </span><span class="no">Pop</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">value</span>
<a id="line-10578" name="line-10578"></a><span class="w">  </span><span class="no">pop</span><span class="w">  </span><span class="no">cx</span><span class="w">       </span><span class="err">;;</span><span class="w"> </span><span class="no">Pop</span><span class="w"> </span><span class="no">seg</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="p">(</span><span class="no">restore</span><span class="w"> </span><span class="no">CX</span><span class="p">)</span>
<a id="line-10579" name="line-10579"></a>
<a id="line-10580" name="line-10580"></a><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">Look</span><span class="w"> </span><span class="no">at</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">ROM</span><span class="err">&#39;</span><span class="no">s</span><span class="w"> </span><span class="no">PnP</span><span class="w"> </span><span class="no">Expansion</span><span class="w"> </span><span class="no">header</span><span class="p">.</span><span class="w">  </span><span class="no">Properly</span><span class="p">,</span><span class="w"> </span><span class="no">we</span><span class="err">&#39;</span><span class="no">re</span><span class="w"> </span><span class="no">supposed</span>
<a id="line-10581" name="line-10581"></a><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="no">init</span><span class="w"> </span><span class="no">all</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">ROMs</span><span class="w"> </span><span class="no">and</span><span class="w"> </span><span class="no">then</span><span class="w"> </span><span class="no">go</span><span class="w"> </span><span class="no">back</span><span class="w"> </span><span class="no">and</span><span class="w"> </span><span class="no">build</span><span class="w"> </span><span class="no">an</span><span class="w"> </span><span class="no">IPL</span><span class="w"> </span><span class="no">table</span><span class="w"> </span><span class="no">of</span>
<a id="line-10582" name="line-10582"></a><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">all</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">bootable</span><span class="w"> </span><span class="no">devices</span><span class="p">,</span><span class="w"> </span><span class="no">but</span><span class="w"> </span><span class="no">we</span><span class="w"> </span><span class="no">can</span><span class="w"> </span><span class="no">get</span><span class="w"> </span><span class="no">away</span><span class="w"> </span><span class="no">with</span><span class="w"> </span><span class="no">one</span><span class="w"> </span><span class="no">pass</span><span class="p">.</span>
<a id="line-10583" name="line-10583"></a><span class="w">  </span><span class="no">mov</span><span class="w">  </span><span class="no">ds</span><span class="p">,</span><span class="w"> </span><span class="no">cx</span><span class="w">       </span><span class="err">;;</span><span class="w"> </span><span class="no">ROM</span><span class="w"> </span><span class="no">base</span>
<a id="line-10584" name="line-10584"></a><span class="w">  </span><span class="no">mov</span><span class="w">  </span><span class="no">bx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001a</span><span class="w">   </span><span class="err">;;</span><span class="w"> </span><span class="mh">0x1A</span><span class="w"> </span><span class="no">is</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">into</span><span class="w"> </span><span class="no">ROM</span><span class="w"> </span><span class="no">header</span><span class="w"> </span><span class="no">that</span><span class="w"> </span><span class="no">contains</span><span class="p">...</span>
<a id="line-10585" name="line-10585"></a><span class="w">  </span><span class="no">mov</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">bx</span><span class="p">]</span><span class="w">     </span><span class="err">;;</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">PnP</span><span class="w"> </span><span class="no">expansion</span><span class="w"> </span><span class="no">header</span><span class="p">,</span><span class="w"> </span><span class="no">where</span><span class="p">...</span>
<a id="line-10586" name="line-10586"></a><span class="w">  </span><span class="no">cmp</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x5024</span><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">we</span><span class="w"> </span><span class="no">look</span><span class="w"> </span><span class="no">for</span><span class="w"> </span><span class="no">signature</span><span class="w"> </span><span class="s">&quot;$PnP&quot;</span>
<a id="line-10587" name="line-10587"></a><span class="w">  </span><span class="no">jne</span><span class="w">  </span><span class="no">no_bev</span>
<a id="line-10588" name="line-10588"></a><span class="w">  </span><span class="no">mov</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">[</span><span class="no">bx</span><span class="p">]</span>
<a id="line-10589" name="line-10589"></a><span class="w">  </span><span class="no">cmp</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x506e</span>
<a id="line-10590" name="line-10590"></a><span class="w">  </span><span class="no">jne</span><span class="w">  </span><span class="no">no_bev</span>
<a id="line-10591" name="line-10591"></a>
<a id="line-10592" name="line-10592"></a><span class="w">  </span><span class="no">mov</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x16</span><span class="p">[</span><span class="no">bx</span><span class="p">]</span><span class="w"> </span><span class="err">;;</span><span class="w"> </span><span class="mh">0x16</span><span class="w"> </span><span class="no">is</span><span class="w"> </span><span class="no">the</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">Boot</span><span class="w"> </span><span class="no">Connection</span><span class="w"> </span><span class="no">Vector</span>
<a id="line-10593" name="line-10593"></a><span class="w">  </span><span class="no">cmp</span><span class="w">  </span><span class="no">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000</span>
<a id="line-10594" name="line-10594"></a><span class="w">  </span><span class="no">je</span><span class="w">   </span><span class="no">no_bcv</span>
<a id="line-10595" name="line-10595"></a>
<a id="line-10596" name="line-10596"></a><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">Option</span><span class="w"> </span><span class="no">ROM</span><span class="w"> </span><span class="no">has</span><span class="w"> </span><span class="no">BCV</span><span class="p">.</span><span class="w"> </span><span class="no">Run</span><span class="w"> </span><span class="no">it</span><span class="w"> </span><span class="no">now</span><span class="p">.</span>
<a id="line-10597" name="line-10597"></a><span class="w">  </span><span class="no">push</span><span class="w"> </span><span class="no">cx</span><span class="w">       </span><span class="err">;;</span><span class="w"> </span><span class="no">Push</span><span class="w"> </span><span class="no">seg</span>
<a id="line-10598" name="line-10598"></a><span class="w">  </span><span class="no">push</span><span class="w"> </span><span class="no">ax</span><span class="w">       </span><span class="err">;;</span><span class="w"> </span><span class="no">Push</span><span class="w"> </span><span class="no">offset</span>
<a id="line-10599" name="line-10599"></a>
<a id="line-10600" name="line-10600"></a><span class="w">  </span><span class="err">;;</span><span class="w"> </span><span class="no">Point</span><span class="w"> </span><span class="no">ES</span><span class="p">:</span><span class="n">DI</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="s">&quot;$PnP&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">tells</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">PnP</span><span class="w"> </span><span class="n">BIOS</span><span class="p">.</span>
<a id="line-10601" name="line-10601"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-10602" name="line-10602"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10603" name="line-10603"></a><span class="w">  </span><span class="n">lea</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="n">pnp_string</span>
<a id="line-10604" name="line-10604"></a><span class="w">  </span><span class="cm">/* jump to BCV function entry pointer */</span>
<a id="line-10605" name="line-10605"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">BCV</span><span class="w"> </span><span class="n">routine</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">seg</span><span class="o">:</span><span class="n">off</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stack</span>
<a id="line-10606" name="line-10606"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mh">0xff</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">call_far</span><span class="w"> </span><span class="n">ss</span><span class="o">:</span><span class="p">[</span><span class="n">bp</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
<a id="line-10607" name="line-10607"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mh">0x5e</span>
<a id="line-10608" name="line-10608"></a><span class="w">  </span><span class="n">db</span><span class="w">   </span><span class="mi">0</span>
<a id="line-10609" name="line-10609"></a><span class="w">  </span><span class="n">cli</span><span class="w">           </span><span class="p">;;</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">expansion</span><span class="w"> </span><span class="no">ROM</span><span class="w"> </span><span class="no">BIOS</span><span class="w"> </span><span class="no">turns</span><span class="w"> </span><span class="no">IF</span><span class="w"> </span><span class="no">on</span>
<a id="line-10610" name="line-10610"></a><span class="w">  </span><span class="no">add</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span><span class="w">   </span><span class="err">;;</span><span class="w"> </span><span class="no">Pop</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="no">value</span>
<a id="line-10611" name="line-10611"></a><span class="w">  </span><span class="no">pop</span><span class="w">  </span><span class="no">cx</span><span class="w">       </span><span class="err">;;</span><span class="w"> </span><span class="no">Pop</span><span class="w"> </span><span class="no">seg</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="p">(</span><span class="no">restore</span><span class="w"> </span><span class="no">CX</span><span class="p">)</span>
<a id="line-10612" name="line-10612"></a><span class="w">  </span><span class="no">jmp</span><span class="w">   </span><span class="no">no_bev</span>
<a id="line-10613" name="line-10613"></a>
<a id="line-10614" name="line-10614"></a><span class="no">no_bcv</span><span class="p">:</span>
<a id="line-10615" name="line-10615"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">[</span><span class="n">bx</span><span class="p">]</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x1A</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">of</span><span class="p">...</span>
<a id="line-10616" name="line-10616"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Vector</span><span class="p">,</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">none</span><span class="p">.</span>
<a id="line-10617" name="line-10617"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">no_bev</span>
<a id="line-10618" name="line-10618"></a>
<a id="line-10619" name="line-10619"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Found</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">thinks</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">system</span><span class="p">.</span><span class="w">  </span><span class="n">Record</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">BEV</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">string</span><span class="p">.</span>
<a id="line-10620" name="line-10620"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">[</span><span class="n">bx</span><span class="p">]</span><span class="w">            </span><span class="p">;;</span><span class="w"> </span><span class="n">Pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">none</span>
<a id="line-10621" name="line-10621"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10622" name="line-10622"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10623" name="line-10623"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40E</span><span class="p">]</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">segment</span>
<a id="line-10624" name="line-10624"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">                  </span><span class="p">;;</span><span class="w"> </span><span class="n">Go</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">IPL</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">lives</span>
<a id="line-10625" name="line-10625"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">IPL_COUNT_OFFSET</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">far</span>
<a id="line-10626" name="line-10626"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">IPL_TABLE_ENTRIES</span>
<a id="line-10627" name="line-10627"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">no_bev</span><span class="w">                  </span><span class="p">;;</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">full</span>
<a id="line-10628" name="line-10628"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x4</span><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">Turn</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="p">(</span><span class="n">entries</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
<a id="line-10629" name="line-10629"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">IPL_TABLE_OFFSET</span><span class="o">+</span><span class="mi">0</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="n">IPL_TYPE_BEV</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">BEV</span><span class="w"> </span><span class="n">device</span>
<a id="line-10630" name="line-10630"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">IPL_TABLE_OFFSET</span><span class="o">+</span><span class="mi">6</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">cx</span><span class="w">            </span><span class="p">;;</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">segment</span><span class="p">...</span>
<a id="line-10631" name="line-10631"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">IPL_TABLE_OFFSET</span><span class="o">+</span><span class="mi">4</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span><span class="w">            </span><span class="p">;;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">offset</span>
<a id="line-10632" name="line-10632"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0000</span>
<a id="line-10633" name="line-10633"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">no_prod_str</span>
<a id="line-10634" name="line-10634"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0xA</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">cx</span><span class="w">             </span><span class="p">;;</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">far</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">segment</span><span class="p">...</span>
<a id="line-10635" name="line-10635"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mi">8</span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">di</span><span class="w">               </span><span class="p">;;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">offset</span>
<a id="line-10636" name="line-10636"></a><span class="nl">no_prod_str</span><span class="p">:</span>
<a id="line-10637" name="line-10637"></a><span class="w">  </span><span class="n">shr</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x4</span><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">Turn</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">count</span>
<a id="line-10638" name="line-10638"></a><span class="w">  </span><span class="n">inc</span><span class="w">  </span><span class="n">bx</span><span class="w">                      </span><span class="p">;;</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">now</span>
<a id="line-10639" name="line-10639"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">IPL_COUNT_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Remember</span><span class="w"> </span><span class="n">that</span><span class="p">.</span>
<a id="line-10640" name="line-10640"></a>
<a id="line-10641" name="line-10641"></a><span class="nl">no_bev</span><span class="p">:</span>
<a id="line-10642" name="line-10642"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">di</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">DI</span>
<a id="line-10643" name="line-10643"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">AX</span>
<a id="line-10644" name="line-10644"></a><span class="nl">rom_scan_increment</span><span class="p">:</span>
<a id="line-10645" name="line-10645"></a><span class="w">  </span><span class="n">shl</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">5</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="mi">512</span><span class="o">-</span><span class="n">bytes</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mi">16</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">increments</span>
<a id="line-10646" name="line-10646"></a><span class="w">                </span><span class="p">;;</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">shifted</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">.</span>
<a id="line-10647" name="line-10647"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10648" name="line-10648"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span><span class="w">       </span><span class="p">;;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">AX</span>
<a id="line-10649" name="line-10649"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10650" name="line-10650"></a><span class="w">  </span><span class="n">jbe</span><span class="w">  </span><span class="n">rom_scan_loop</span>
<a id="line-10651" name="line-10651"></a>
<a id="line-10652" name="line-10652"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">   </span><span class="p">;;</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">DS</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mo">0000</span><span class="o">:</span>
<a id="line-10653" name="line-10653"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10654" name="line-10654"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10655" name="line-10655"></a>
<a id="line-10656" name="line-10656"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-10657" name="line-10657"></a>
<a id="line-10658" name="line-10658"></a><span class="p">;</span><span class="w"> </span><span class="n">Copy</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">SMBIOS</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">hvmloader</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">it</span><span class="p">.</span>
<a id="line-10659" name="line-10659"></a><span class="p">;</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">somewhere</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="mh">0xf0000-0xfffff</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">16</span><span class="o">-</span><span class="n">byte</span><span class="w"> </span><span class="n">boundary</span><span class="p">,</span>
<a id="line-10660" name="line-10660"></a><span class="p">;</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="n">themselves</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">elsewhere</span><span class="p">.</span>
<a id="line-10661" name="line-10661"></a><span class="nl">smbios_init</span><span class="p">:</span>
<a id="line-10662" name="line-10662"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10663" name="line-10663"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10664" name="line-10664"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-10665" name="line-10665"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10666" name="line-10666"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">di</span>
<a id="line-10667" name="line-10667"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">si</span>
<a id="line-10668" name="line-10668"></a>
<a id="line-10669" name="line-10669"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x001f</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mh">0x1f</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">copy</span>
<a id="line-10670" name="line-10670"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-10671" name="line-10671"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mh">0xf0000</span>
<a id="line-10672" name="line-10672"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">smbios_entry_point</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="n">offset</span>
<a id="line-10673" name="line-10673"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="p">(</span><span class="n">SMBIOS_PHYSICAL_ADDRESS</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span>
<a id="line-10674" name="line-10674"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10675" name="line-10675"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="p">(</span><span class="n">SMBIOS_PHYSICAL_ADDRESS</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span>
<a id="line-10676" name="line-10676"></a><span class="w">  </span><span class="n">cld</span>
<a id="line-10677" name="line-10677"></a><span class="w">  </span><span class="n">rep</span>
<a id="line-10678" name="line-10678"></a><span class="w">    </span><span class="n">movsb</span>
<a id="line-10679" name="line-10679"></a>
<a id="line-10680" name="line-10680"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">si</span>
<a id="line-10681" name="line-10681"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">di</span>
<a id="line-10682" name="line-10682"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-10683" name="line-10683"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-10684" name="line-10684"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">cx</span>
<a id="line-10685" name="line-10685"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10686" name="line-10686"></a>
<a id="line-10687" name="line-10687"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10688" name="line-10688"></a>
<a id="line-10689" name="line-10689"></a><span class="cp">#endif</span>
<a id="line-10690" name="line-10690"></a>
<a id="line-10691" name="line-10691"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-10692" name="line-10692"></a><span class="p">;</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">between</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">NMI</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">filling</span><span class="w"> </span><span class="n">up</span>
<a id="line-10693" name="line-10693"></a><span class="p">;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">causes</span><span class="w"> </span><span class="n">crashes</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">there</span>
<a id="line-10694" name="line-10694"></a><span class="nl">tcpa_post_part1</span><span class="p">:</span>
<a id="line-10695" name="line-10695"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_acpi_init</span>
<a id="line-10696" name="line-10696"></a>
<a id="line-10697" name="line-10697"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dword</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span>
<a id="line-10698" name="line-10698"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_initialize_tpm</span>
<a id="line-10699" name="line-10699"></a><span class="w">  </span><span class="n">add</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">4</span>
<a id="line-10700" name="line-10700"></a>
<a id="line-10701" name="line-10701"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_do_measure_POSTs</span>
<a id="line-10702" name="line-10702"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_wake_event</span><span class="w">     </span><span class="cm">/* specs: 3.2.3.7 */</span>
<a id="line-10703" name="line-10703"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10704" name="line-10704"></a>
<a id="line-10705" name="line-10705"></a><span class="nl">tcpa_post_part2</span><span class="p">:</span>
<a id="line-10706" name="line-10706"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_calling_int19h</span><span class="w">          </span><span class="cm">/* specs: 8.2.3 step 1 */</span>
<a id="line-10707" name="line-10707"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_add_event_separators</span><span class="w">    </span><span class="cm">/* specs: 8.2.3 step 2 */</span>
<a id="line-10708" name="line-10708"></a><span class="w">  </span><span class="cm">/* we do not call int 19h handler but keep following eventlog */</span>
<a id="line-10709" name="line-10709"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_tcpa_returned_int19h</span><span class="w">         </span><span class="cm">/* specs: 8.2.3 step 3/7 */</span>
<a id="line-10710" name="line-10710"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10711" name="line-10711"></a><span class="cp">#endif</span>
<a id="line-10712" name="line-10712"></a>
<a id="line-10713" name="line-10713"></a>
<a id="line-10714" name="line-10714"></a><span class="nl">post_init_pic</span><span class="p">:</span>
<a id="line-10715" name="line-10715"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x11</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">initialisation</span><span class="w"> </span><span class="n">commands</span>
<a id="line-10716" name="line-10716"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10717" name="line-10717"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xa0</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10718" name="line-10718"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span>
<a id="line-10719" name="line-10719"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10720" name="line-10720"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x70</span>
<a id="line-10721" name="line-10721"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10722" name="line-10722"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x04</span>
<a id="line-10723" name="line-10723"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10724" name="line-10724"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-10725" name="line-10725"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10726" name="line-10726"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-10727" name="line-10727"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10728" name="line-10728"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10729" name="line-10729"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xb8</span>
<a id="line-10730" name="line-10730"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="mh">0x21</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="p">;</span><span class="n">master</span><span class="w"> </span><span class="n">pic</span><span class="o">:</span><span class="w"> </span><span class="n">unmask</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<a id="line-10731" name="line-10731"></a><span class="cp">#if BX_USE_PS2_MOUSE</span>
<a id="line-10732" name="line-10732"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x8f</span>
<a id="line-10733" name="line-10733"></a><span class="cp">#else</span>
<a id="line-10734" name="line-10734"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x9f</span>
<a id="line-10735" name="line-10735"></a><span class="cp">#endif</span>
<a id="line-10736" name="line-10736"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="w"> </span><span class="p">;</span><span class="n">slave</span><span class="w">  </span><span class="n">pic</span><span class="o">:</span><span class="w"> </span><span class="n">unmask</span><span class="w"> </span><span class="n">IRQ</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span>
<a id="line-10737" name="line-10737"></a><span class="w">  </span><span class="n">ret</span>
<a id="line-10738" name="line-10738"></a>
<a id="line-10739" name="line-10739"></a>
<a id="line-10740" name="line-10740"></a><span class="w">  </span><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-10741" name="line-10741"></a><span class="nl">smbios_entry_point</span><span class="p">:</span>
<a id="line-10742" name="line-10742"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span>
<a id="line-10743" name="line-10743"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">bytes</span>
<a id="line-10744" name="line-10744"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">bytes</span>
<a id="line-10745" name="line-10745"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="n">bytes</span>
<a id="line-10746" name="line-10746"></a>
<a id="line-10747" name="line-10747"></a><span class="p">;;</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">tables</span>
<a id="line-10748" name="line-10748"></a><span class="w">  </span><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="mi">16</span>
<a id="line-10749" name="line-10749"></a><span class="nl">bios_table_area_start</span><span class="p">:</span>
<a id="line-10750" name="line-10750"></a><span class="w">  </span><span class="n">db</span><span class="w"> </span><span class="mh">0x5F</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5F</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5F</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="p">,</span><span class="w"> </span><span class="mh">0x56</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4D</span><span class="p">,</span><span class="w"> </span><span class="mh">0x50</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">___HVMMP</span>
<a id="line-10751" name="line-10751"></a><span class="w">  </span><span class="n">dd</span><span class="w"> </span><span class="n">bios_table_area_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bios_table_area_start</span>
<a id="line-10752" name="line-10752"></a>
<a id="line-10753" name="line-10753"></a><span class="p">;</span><span class="o">--------</span>
<a id="line-10754" name="line-10754"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">-</span>
<a id="line-10755" name="line-10755"></a><span class="p">;</span><span class="o">--------</span>
<a id="line-10756" name="line-10756"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe05b</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-10757" name="line-10757"></a><span class="nl">post</span><span class="p">:</span>
<a id="line-10758" name="line-10758"></a>
<a id="line-10759" name="line-10759"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10760" name="line-10760"></a>
<a id="line-10761" name="line-10761"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">controllers</span>
<a id="line-10762" name="line-10762"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">,</span><span class="n">al</span>
<a id="line-10763" name="line-10763"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xda</span><span class="p">,</span><span class="n">al</span>
<a id="line-10764" name="line-10764"></a>
<a id="line-10765" name="line-10765"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">controllers</span>
<a id="line-10766" name="line-10766"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xC0</span>
<a id="line-10767" name="line-10767"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xD6</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">cascade</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">enabled</span>
<a id="line-10768" name="line-10768"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10769" name="line-10769"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0xD4</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">unmask</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="mi">4</span>
<a id="line-10770" name="line-10770"></a>
<a id="line-10771" name="line-10771"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Examine</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span><span class="p">.</span>
<a id="line-10772" name="line-10772"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span>
<a id="line-10773" name="line-10773"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span>
<a id="line-10774" name="line-10774"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span>
<a id="line-10775" name="line-10775"></a>
<a id="line-10776" name="line-10776"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">status</span>
<a id="line-10777" name="line-10777"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10778" name="line-10778"></a>
<a id="line-10779" name="line-10779"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Reset</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span><span class="p">.</span>
<a id="line-10780" name="line-10780"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0f</span>
<a id="line-10781" name="line-10781"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="n">Fh</span>
<a id="line-10782" name="line-10782"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10783" name="line-10783"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x71</span><span class="p">,</span><span class="w"> </span><span class="n">AL</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">normal</span>
<a id="line-10784" name="line-10784"></a>
<a id="line-10785" name="line-10785"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Examine</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span><span class="p">.</span>
<a id="line-10786" name="line-10786"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span>
<a id="line-10787" name="line-10787"></a>
<a id="line-10788" name="line-10788"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0D</span><span class="o">+</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">startup</span>
<a id="line-10789" name="line-10789"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-10790" name="line-10790"></a><span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">normal_post</span>
<a id="line-10791" name="line-10791"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0d</span>
<a id="line-10792" name="line-10792"></a><span class="w">  </span><span class="n">jae</span><span class="w"> </span><span class="n">normal_post</span>
<a id="line-10793" name="line-10793"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">AL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x09</span>
<a id="line-10794" name="line-10794"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">normal_post</span>
<a id="line-10795" name="line-10795"></a>
<a id="line-10796" name="line-10796"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eoi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40</span><span class="o">:</span><span class="mh">0x67</span><span class="p">]</span><span class="w"> </span><span class="n">jump</span>
<a id="line-10797" name="line-10797"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x05</span>
<a id="line-10798" name="line-10798"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">eoi_jmp_post</span>
<a id="line-10799" name="line-10799"></a>
<a id="line-10800" name="line-10800"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x0A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40</span><span class="o">:</span><span class="mh">0x67</span><span class="p">]</span><span class="w"> </span><span class="n">jump</span>
<a id="line-10801" name="line-10801"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0a</span>
<a id="line-10802" name="line-10802"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">jmp_post_0x467</span>
<a id="line-10803" name="line-10803"></a>
<a id="line-10804" name="line-10804"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x0B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iret</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40</span><span class="o">:</span><span class="mh">0x67</span><span class="p">]</span>
<a id="line-10805" name="line-10805"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0b</span>
<a id="line-10806" name="line-10806"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">iret_post_0x467</span>
<a id="line-10807" name="line-10807"></a>
<a id="line-10808" name="line-10808"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="mh">0x0C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retf</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="p">[</span><span class="mh">0x40</span><span class="o">:</span><span class="mh">0x67</span><span class="p">]</span>
<a id="line-10809" name="line-10809"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0c</span>
<a id="line-10810" name="line-10810"></a><span class="w">  </span><span class="n">je</span><span class="w">  </span><span class="n">retf_post_0x467</span>
<a id="line-10811" name="line-10811"></a>
<a id="line-10812" name="line-10812"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Examine</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span><span class="p">.</span>
<a id="line-10813" name="line-10813"></a><span class="w">  </span><span class="p">;;</span><span class="w">  </span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0x08</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Unimplemented</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span><span class="p">.</span>
<a id="line-10814" name="line-10814"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10815" name="line-10815"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_shutdown_status_panic</span>
<a id="line-10816" name="line-10816"></a>
<a id="line-10817" name="line-10817"></a><span class="cp">#if 0</span>
<a id="line-10818" name="line-10818"></a><span class="c">  HALT(__LINE__)</span>
<a id="line-10819" name="line-10819"></a><span class="c">  ;</span>
<a id="line-10820" name="line-10820"></a><span class="c">  ;#if 0</span>
<a id="line-10821" name="line-10821"></a><span class="c">  ;  0xb0, 0x20,       /* mov al, #0x20 */</span>
<a id="line-10822" name="line-10822"></a><span class="c">  ;  0xe6, 0x20,       /* out 0x20, al    ;send EOI to PIC */</span>
<a id="line-10823" name="line-10823"></a><span class="c">  ;#endif</span>
<a id="line-10824" name="line-10824"></a><span class="c">  ;</span>
<a id="line-10825" name="line-10825"></a><span class="c">  pop es</span>
<a id="line-10826" name="line-10826"></a><span class="c">  pop ds</span>
<a id="line-10827" name="line-10827"></a><span class="c">  popa</span>
<a id="line-10828" name="line-10828"></a><span class="c">  iret</span>
<a id="line-10829" name="line-10829"></a><span class="cp">#endif</span>
<a id="line-10830" name="line-10830"></a>
<a id="line-10831" name="line-10831"></a><span class="nl">normal_post</span><span class="p">:</span>
<a id="line-10832" name="line-10832"></a><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">normal</span><span class="w"> </span><span class="n">startup</span>
<a id="line-10833" name="line-10833"></a>
<a id="line-10834" name="line-10834"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-10835" name="line-10835"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0ffe</span>
<a id="line-10836" name="line-10836"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10837" name="line-10837"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x9e00</span>
<a id="line-10838" name="line-10838"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10839" name="line-10839"></a>
<a id="line-10840" name="line-10840"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Save</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="n">status</span>
<a id="line-10841" name="line-10841"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x04b0</span><span class="p">,</span><span class="w"> </span><span class="n">bl</span>
<a id="line-10842" name="line-10842"></a>
<a id="line-10843" name="line-10843"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xfe</span>
<a id="line-10844" name="line-10844"></a><span class="w">  </span><span class="n">jz</span><span class="w"> </span><span class="n">s3_post</span>
<a id="line-10845" name="line-10845"></a>
<a id="line-10846" name="line-10846"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="p">(</span><span class="mi">40</span><span class="o">:</span><span class="mf">00..40</span><span class="o">:</span><span class="n">ff</span><span class="p">)</span>
<a id="line-10847" name="line-10847"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">es</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10848" name="line-10848"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0080</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="n">words</span>
<a id="line-10849" name="line-10849"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">di</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0400</span>
<a id="line-10850" name="line-10850"></a><span class="w">  </span><span class="n">cld</span>
<a id="line-10851" name="line-10851"></a><span class="w">  </span><span class="n">rep</span>
<a id="line-10852" name="line-10852"></a><span class="w">    </span><span class="n">stosw</span>
<a id="line-10853" name="line-10853"></a>
<a id="line-10854" name="line-10854"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_log_bios_start</span>
<a id="line-10855" name="line-10855"></a>
<a id="line-10856" name="line-10856"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">interrupts</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">handler</span>
<a id="line-10857" name="line-10857"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w">         </span><span class="p">;;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">index</span>
<a id="line-10858" name="line-10858"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0100</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="w"> </span><span class="n">interrupts</span><span class="p">)</span>
<a id="line-10859" name="line-10859"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">dummy_iret_handler</span>
<a id="line-10860" name="line-10860"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span>
<a id="line-10861" name="line-10861"></a>
<a id="line-10862" name="line-10862"></a><span class="nl">post_default_ints</span><span class="p">:</span>
<a id="line-10863" name="line-10863"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10864" name="line-10864"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-10865" name="line-10865"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="p">[</span><span class="n">bx</span><span class="p">],</span><span class="w"> </span><span class="n">dx</span>
<a id="line-10866" name="line-10866"></a><span class="w">  </span><span class="n">add</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">2</span>
<a id="line-10867" name="line-10867"></a><span class="w">  </span><span class="n">loop</span><span class="w"> </span><span class="n">post_default_ints</span>
<a id="line-10868" name="line-10868"></a>
<a id="line-10869" name="line-10869"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="mh">0x79</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">zero</span>
<a id="line-10870" name="line-10870"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="err">&#39;</span><span class="n">gardian</span><span class="w"> </span><span class="n">angel</span><span class="err">&#39;</span><span class="w"> </span><span class="n">protection</span><span class="w"> </span><span class="n">system</span>
<a id="line-10871" name="line-10871"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x79</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="p">)</span>
<a id="line-10872" name="line-10872"></a>
<a id="line-10873" name="line-10873"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="mi">40</span><span class="o">:</span><span class="mi">13</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="line-10874" name="line-10874"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">BASE_MEM_IN_K</span>
<a id="line-10875" name="line-10875"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0413</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10876" name="line-10876"></a>
<a id="line-10877" name="line-10877"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Manufacturing</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="mi">40</span><span class="o">:</span><span class="mi">12</span>
<a id="line-10878" name="line-10878"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">zerod</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">above</span>
<a id="line-10879" name="line-10879"></a>
<a id="line-10880" name="line-10880"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Warm</span><span class="w"> </span><span class="n">Boot</span><span class="w"> </span><span class="n">Flag</span><span class="w"> </span><span class="mo">0040</span><span class="o">:</span><span class="mo">0072</span>
<a id="line-10881" name="line-10881"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1234</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">checks</span>
<a id="line-10882" name="line-10882"></a><span class="w">  </span><span class="p">;;</span><span class="w">   </span><span class="n">zerod</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">above</span>
<a id="line-10883" name="line-10883"></a>
<a id="line-10884" name="line-10884"></a>
<a id="line-10885" name="line-10885"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Printer</span><span class="w"> </span><span class="n">Services</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10886" name="line-10886"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int17_handler</span><span class="p">)</span>
<a id="line-10887" name="line-10887"></a>
<a id="line-10888" name="line-10888"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w"> </span><span class="n">failure</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10889" name="line-10889"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int18_handler</span><span class="p">)</span>
<a id="line-10890" name="line-10890"></a>
<a id="line-10891" name="line-10891"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w"> </span><span class="n">Loader</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10892" name="line-10892"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x19</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int19_handler</span><span class="p">)</span>
<a id="line-10893" name="line-10893"></a>
<a id="line-10894" name="line-10894"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">Tick</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10895" name="line-10895"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int1c_handler</span><span class="p">)</span>
<a id="line-10896" name="line-10896"></a>
<a id="line-10897" name="line-10897"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10898" name="line-10898"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int12_handler</span><span class="p">)</span>
<a id="line-10899" name="line-10899"></a>
<a id="line-10900" name="line-10900"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">vector</span>
<a id="line-10901" name="line-10901"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int11_handler</span><span class="p">)</span>
<a id="line-10902" name="line-10902"></a>
<a id="line-10903" name="line-10903"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">Services</span>
<a id="line-10904" name="line-10904"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x15</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int15_handler</span><span class="p">)</span>
<a id="line-10905" name="line-10905"></a>
<a id="line-10906" name="line-10906"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">EBDA</span><span class="w"> </span><span class="n">setup</span>
<a id="line-10907" name="line-10907"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">ebda_post</span>
<a id="line-10908" name="line-10908"></a>
<a id="line-10909" name="line-10909"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">PIT</span><span class="w"> </span><span class="n">setup</span>
<a id="line-10910" name="line-10910"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int08_handler</span><span class="p">)</span>
<a id="line-10911" name="line-10911"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="mi">1</span><span class="n">C</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">dummy_iret_handler</span><span class="w"> </span><span class="p">(</span><span class="n">above</span><span class="p">)</span>
<a id="line-10912" name="line-10912"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x34</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">timer0</span><span class="o">:</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="n">bit</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="mi">2</span>
<a id="line-10913" name="line-10913"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x43</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10914" name="line-10914"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-10915" name="line-10915"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0b</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="err">#</span><span class="mh">0xe90b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">Hz</span><span class="w"> </span><span class="p">(</span><span class="n">temporary</span><span class="p">,</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">fix</span><span class="w"> </span><span class="n">xen</span><span class="o">/</span><span class="n">vmx</span><span class="w"> </span><span class="n">support</span><span class="p">)</span>
<a id="line-10916" name="line-10916"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">lsb</span>
<a id="line-10917" name="line-10917"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xe9</span>
<a id="line-10918" name="line-10918"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">msb</span>
<a id="line-10919" name="line-10919"></a><span class="cp">#else</span>
<a id="line-10920" name="line-10920"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mo">0000</span><span class="n">H</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">18.2</span><span class="n">Hz</span>
<a id="line-10921" name="line-10921"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10922" name="line-10922"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10923" name="line-10923"></a><span class="cp">#endif</span>
<a id="line-10924" name="line-10924"></a>
<a id="line-10925" name="line-10925"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Keyboard</span>
<a id="line-10926" name="line-10926"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int09_handler</span><span class="p">)</span>
<a id="line-10927" name="line-10927"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x16</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int16_handler</span><span class="p">)</span>
<a id="line-10928" name="line-10928"></a>
<a id="line-10929" name="line-10929"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10930" name="line-10930"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10931" name="line-10931"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0417</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard shift flags, set 1 */</span>
<a id="line-10932" name="line-10932"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0418</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard shift flags, set 2 */</span>
<a id="line-10933" name="line-10933"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0419</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard alt-numpad work area */</span>
<a id="line-10934" name="line-10934"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0471</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard ctrl-break flag */</span>
<a id="line-10935" name="line-10935"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0497</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard status flags 4 */</span>
<a id="line-10936" name="line-10936"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-10937" name="line-10937"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0496</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w"> </span><span class="cm">/* keyboard status flags 3 */</span>
<a id="line-10938" name="line-10938"></a>
<a id="line-10939" name="line-10939"></a>
<a id="line-10940" name="line-10940"></a><span class="w">  </span><span class="cm">/* keyboard head of buffer pointer */</span>
<a id="line-10941" name="line-10941"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x001E</span>
<a id="line-10942" name="line-10942"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x041A</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10943" name="line-10943"></a>
<a id="line-10944" name="line-10944"></a><span class="w">  </span><span class="cm">/* keyboard end of buffer pointer */</span>
<a id="line-10945" name="line-10945"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x041C</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10946" name="line-10946"></a>
<a id="line-10947" name="line-10947"></a><span class="w">  </span><span class="cm">/* keyboard pointer to start of buffer */</span>
<a id="line-10948" name="line-10948"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x001E</span>
<a id="line-10949" name="line-10949"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0480</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10950" name="line-10950"></a>
<a id="line-10951" name="line-10951"></a><span class="w">  </span><span class="cm">/* keyboard pointer to end of buffer */</span>
<a id="line-10952" name="line-10952"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x003E</span>
<a id="line-10953" name="line-10953"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0482</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10954" name="line-10954"></a>
<a id="line-10955" name="line-10955"></a><span class="w">  </span><span class="cm">/* init the keyboard */</span>
<a id="line-10956" name="line-10956"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_keyboard_init</span>
<a id="line-10957" name="line-10957"></a>
<a id="line-10958" name="line-10958"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">Byte</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">BDA</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">Word</span>
<a id="line-10959" name="line-10959"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0410</span>
<a id="line-10960" name="line-10960"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x14</span>
<a id="line-10961" name="line-10961"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-10962" name="line-10962"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x71</span>
<a id="line-10963" name="line-10963"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0410</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10964" name="line-10964"></a>
<a id="line-10965" name="line-10965"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-10966" name="line-10966"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">tcpa_post_part1</span>
<a id="line-10967" name="line-10967"></a><span class="cp">#endif</span>
<a id="line-10968" name="line-10968"></a>
<a id="line-10969" name="line-10969"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">setup</span>
<a id="line-10970" name="line-10970"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">dummy_iret_handler</span><span class="p">)</span>
<a id="line-10971" name="line-10971"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10972" name="line-10972"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10973" name="line-10973"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10974" name="line-10974"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x14</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="n">value</span>
<a id="line-10975" name="line-10975"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x378</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">1</span>
<a id="line-10976" name="line-10976"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_parport</span>
<a id="line-10977" name="line-10977"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x278</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">2</span>
<a id="line-10978" name="line-10978"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_parport</span>
<a id="line-10979" name="line-10979"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0e</span>
<a id="line-10980" name="line-10980"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x410</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="mf">14..15</span><span class="w"> </span><span class="n">determing</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">ports</span>
<a id="line-10981" name="line-10981"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x3fff</span>
<a id="line-10982" name="line-10982"></a><span class="w">  </span><span class="n">or</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="n">ports</span>
<a id="line-10983" name="line-10983"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x410</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-10984" name="line-10984"></a>
<a id="line-10985" name="line-10985"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">setup</span>
<a id="line-10986" name="line-10986"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">dummy_iret_handler</span><span class="p">)</span>
<a id="line-10987" name="line-10987"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int14_handler</span><span class="p">)</span>
<a id="line-10988" name="line-10988"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-10989" name="line-10989"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">cl</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0a</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="n">value</span>
<a id="line-10990" name="line-10990"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f8</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">1</span>
<a id="line-10991" name="line-10991"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_serial</span>
<a id="line-10992" name="line-10992"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02f8</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">2</span>
<a id="line-10993" name="line-10993"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_serial</span>
<a id="line-10994" name="line-10994"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03e8</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">3</span>
<a id="line-10995" name="line-10995"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_serial</span>
<a id="line-10996" name="line-10996"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02e8</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">4</span>
<a id="line-10997" name="line-10997"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">detect_serial</span>
<a id="line-10998" name="line-10998"></a><span class="w">  </span><span class="n">shl</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x09</span>
<a id="line-10999" name="line-10999"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x410</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="mf">9..11</span><span class="w"> </span><span class="n">determing</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="n">ports</span>
<a id="line-11000" name="line-11000"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf1ff</span>
<a id="line-11001" name="line-11001"></a><span class="w">  </span><span class="n">or</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="n">port</span>
<a id="line-11002" name="line-11002"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x410</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11003" name="line-11003"></a>
<a id="line-11004" name="line-11004"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">RTC</span>
<a id="line-11005" name="line-11005"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x1A</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int1a_handler</span><span class="p">)</span>
<a id="line-11006" name="line-11006"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x4A</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">dummy_iret_handler</span><span class="p">)</span>
<a id="line-11007" name="line-11007"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int70_handler</span><span class="p">)</span>
<a id="line-11008" name="line-11008"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">DATA</span><span class="w"> </span><span class="n">AREA</span><span class="w"> </span><span class="mh">0x4CE</span><span class="w"> </span><span class="o">???</span>
<a id="line-11009" name="line-11009"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">timer_tick_post</span>
<a id="line-11010" name="line-11010"></a>
<a id="line-11011" name="line-11011"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">PS</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="n">mouse</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11012" name="line-11012"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int74_handler</span><span class="p">)</span>
<a id="line-11013" name="line-11013"></a>
<a id="line-11014" name="line-11014"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">IRQ13</span><span class="w"> </span><span class="p">(</span><span class="n">FPU</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11015" name="line-11015"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x75</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int75_handler</span><span class="p">)</span>
<a id="line-11016" name="line-11016"></a>
<a id="line-11017" name="line-11017"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Video</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11018" name="line-11018"></a><span class="w">  </span><span class="n">SET_INT_VECTOR</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xF000</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="n">int10_handler</span><span class="p">)</span>
<a id="line-11019" name="line-11019"></a>
<a id="line-11020" name="line-11020"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">PIC</span>
<a id="line-11021" name="line-11021"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">post_init_pic</span>
<a id="line-11022" name="line-11022"></a>
<a id="line-11023" name="line-11023"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc000</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">vga</span><span class="w"> </span><span class="n">bios</span>
<a id="line-11024" name="line-11024"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc780</span>
<a id="line-11025" name="line-11025"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">rom_scan</span>
<a id="line-11026" name="line-11026"></a>
<a id="line-11027" name="line-11027"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_print_bios_banner</span>
<a id="line-11028" name="line-11028"></a>
<a id="line-11029" name="line-11029"></a><span class="cp">#if BX_ROMBIOS32</span>
<a id="line-11030" name="line-11030"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">rombios32_init</span>
<a id="line-11031" name="line-11031"></a><span class="cp">#else</span>
<a id="line-11032" name="line-11032"></a><span class="cp">#if BX_PCIBIOS &amp;&amp; !defined(HVMASSIST)</span>
<a id="line-11033" name="line-11033"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_iomem_bases</span>
<a id="line-11034" name="line-11034"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_init_irqs</span>
<a id="line-11035" name="line-11035"></a><span class="cp">#endif </span><span class="c1">//BX_PCIBIOS</span>
<a id="line-11036" name="line-11036"></a><span class="cp">#endif</span>
<a id="line-11037" name="line-11037"></a>
<a id="line-11038" name="line-11038"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11039" name="line-11039"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Floppy</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11040" name="line-11040"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11041" name="line-11041"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">floppy_drive_post</span>
<a id="line-11042" name="line-11042"></a>
<a id="line-11043" name="line-11043"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11044" name="line-11044"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Hard</span><span class="w"> </span><span class="n">Drive</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11045" name="line-11045"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11046" name="line-11046"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">hard_drive_post</span>
<a id="line-11047" name="line-11047"></a>
<a id="line-11048" name="line-11048"></a><span class="cp">#if BX_USE_ATADRV</span>
<a id="line-11049" name="line-11049"></a>
<a id="line-11050" name="line-11050"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11051" name="line-11051"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">ATA</span><span class="o">/</span><span class="n">ATAPI</span><span class="w"> </span><span class="n">driver</span><span class="w"> </span><span class="n">setup</span>
<a id="line-11052" name="line-11052"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11053" name="line-11053"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_ata_init</span>
<a id="line-11054" name="line-11054"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_ata_detect</span>
<a id="line-11055" name="line-11055"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11056" name="line-11056"></a>
<a id="line-11057" name="line-11057"></a><span class="cp">#endif </span><span class="c1">// BX_USE_ATADRV</span>
<a id="line-11058" name="line-11058"></a>
<a id="line-11059" name="line-11059"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-11060" name="line-11060"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11061" name="line-11061"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">eltorito</span><span class="w"> </span><span class="n">floppy</span><span class="o">/</span><span class="n">harddisk</span><span class="w"> </span><span class="n">emulation</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">cd</span>
<a id="line-11062" name="line-11062"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11063" name="line-11063"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_cdemu_init</span>
<a id="line-11064" name="line-11064"></a><span class="w">  </span><span class="p">;;</span>
<a id="line-11065" name="line-11065"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-11066" name="line-11066"></a>
<a id="line-11067" name="line-11067"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-11068" name="line-11068"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_enable_rom_write_access</span>
<a id="line-11069" name="line-11069"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_clobber_entry_point</span>
<a id="line-11070" name="line-11070"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_fixup_base_mem_in_k</span>
<a id="line-11071" name="line-11071"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">smbios_init</span>
<a id="line-11072" name="line-11072"></a><span class="cp">#endif</span>
<a id="line-11073" name="line-11073"></a>
<a id="line-11074" name="line-11074"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_init_boot_vectors</span>
<a id="line-11075" name="line-11075"></a>
<a id="line-11076" name="line-11076"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="p">(</span><span class="n">OPTIONROM_PHYSICAL_ADDRESS</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">roms</span>
<a id="line-11077" name="line-11077"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="p">(</span><span class="n">OPTIONROM_PHYSICAL_END</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<a id="line-11078" name="line-11078"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">rom_scan</span>
<a id="line-11079" name="line-11079"></a>
<a id="line-11080" name="line-11080"></a><span class="cp">#ifdef HVMASSIST</span>
<a id="line-11081" name="line-11081"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_disable_rom_write_access</span>
<a id="line-11082" name="line-11082"></a><span class="cp">#endif</span>
<a id="line-11083" name="line-11083"></a>
<a id="line-11084" name="line-11084"></a><span class="cp">#if BX_ELTORITO_BOOT</span>
<a id="line-11085" name="line-11085"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_interactive_bootkey</span>
<a id="line-11086" name="line-11086"></a><span class="cp">#endif </span><span class="c1">// BX_ELTORITO_BOOT</span>
<a id="line-11087" name="line-11087"></a>
<a id="line-11088" name="line-11088"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-11089" name="line-11089"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">tcpa_post_part2</span>
<a id="line-11090" name="line-11090"></a><span class="cp">#endif</span>
<a id="line-11091" name="line-11091"></a>
<a id="line-11092" name="line-11092"></a><span class="w">  </span><span class="n">sti</span><span class="w">        </span><span class="p">;;</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">interrupts</span>
<a id="line-11093" name="line-11093"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">Start</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">sequence</span><span class="p">.</span><span class="w">   </span><span class="n">See</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">comments</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">int19_relocated</span><span class="w"> </span>
<a id="line-11094" name="line-11094"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">why</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">18</span><span class="n">h</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">19</span><span class="n">h</span><span class="w"> </span><span class="n">here</span><span class="p">.</span>
<a id="line-11095" name="line-11095"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x18</span>
<a id="line-11096" name="line-11096"></a>
<a id="line-11097" name="line-11097"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe2c3</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">NMI</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11098" name="line-11098"></a><span class="nl">nmi</span><span class="p">:</span>
<a id="line-11099" name="line-11099"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">FIXME</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">NMI</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">panic</span>
<a id="line-11100" name="line-11100"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">iret</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">int75</span><span class="w"> </span><span class="p">(</span><span class="n">fpu</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span>
<a id="line-11101" name="line-11101"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_nmi_handler_msg</span>
<a id="line-11102" name="line-11102"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11103" name="line-11103"></a>
<a id="line-11104" name="line-11104"></a><span class="nl">int75_handler</span><span class="p">:</span>
<a id="line-11105" name="line-11105"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">         </span><span class="c1">// clear irq13</span>
<a id="line-11106" name="line-11106"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_both_pics</span><span class="w">    </span><span class="c1">// clear interrupt</span>
<a id="line-11107" name="line-11107"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="mi">2</span><span class="w">                </span><span class="c1">// legacy nmi call</span>
<a id="line-11108" name="line-11108"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11109" name="line-11109"></a>
<a id="line-11110" name="line-11110"></a><span class="p">;</span><span class="o">-------------------------------------------</span>
<a id="line-11111" name="line-11111"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">13</span><span class="n">h</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Services</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11112" name="line-11112"></a><span class="p">;</span><span class="o">-------------------------------------------</span>
<a id="line-11113" name="line-11113"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe3fe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">13</span><span class="n">h</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Services</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11114" name="line-11114"></a><span class="nl">int13_handler</span><span class="p">:</span>
<a id="line-11115" name="line-11115"></a><span class="w">  </span><span class="c1">//JMPL(int13_relocated)</span>
<a id="line-11116" name="line-11116"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int13_relocated</span>
<a id="line-11117" name="line-11117"></a>
<a id="line-11118" name="line-11118"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe401</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Disk</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span>
<a id="line-11119" name="line-11119"></a>
<a id="line-11120" name="line-11120"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11121" name="line-11121"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT19h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11122" name="line-11122"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11123" name="line-11123"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe6f2</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">19</span><span class="n">h</span><span class="w"> </span><span class="n">Boot</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11124" name="line-11124"></a><span class="nl">int19_handler</span><span class="p">:</span>
<a id="line-11125" name="line-11125"></a>
<a id="line-11126" name="line-11126"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int19_relocated</span>
<a id="line-11127" name="line-11127"></a><span class="p">;</span><span class="o">-------------------------------------------</span>
<a id="line-11128" name="line-11128"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">Configuration</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">Table</span>
<a id="line-11129" name="line-11129"></a><span class="p">;</span><span class="o">-------------------------------------------</span>
<a id="line-11130" name="line-11130"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="n">BIOS_CONFIG_TABLE</span>
<a id="line-11131" name="line-11131"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x08</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="nf">size</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="n">Lo</span>
<a id="line-11132" name="line-11132"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="nf">size</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="n">Hi</span>
<a id="line-11133" name="line-11133"></a><span class="n">db</span><span class="w"> </span><span class="n">SYS_MODEL_ID</span>
<a id="line-11134" name="line-11134"></a><span class="n">db</span><span class="w"> </span><span class="n">SYS_SUBMODEL_ID</span>
<a id="line-11135" name="line-11135"></a><span class="n">db</span><span class="w"> </span><span class="n">BIOS_REVISION</span>
<a id="line-11136" name="line-11136"></a><span class="p">;</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="mi">1</span>
<a id="line-11137" name="line-11137"></a><span class="p">;</span><span class="w"> </span><span class="n">b7</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">DMA</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">hard</span><span class="w"> </span><span class="n">disk</span>
<a id="line-11138" name="line-11138"></a><span class="p">;</span><span class="w"> </span><span class="n">b6</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">controllers</span><span class="w"> </span><span class="n">present</span>
<a id="line-11139" name="line-11139"></a><span class="p">;</span><span class="w"> </span><span class="n">b5</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">RTC</span><span class="w"> </span><span class="n">present</span>
<a id="line-11140" name="line-11140"></a><span class="p">;</span><span class="w"> </span><span class="n">b4</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">BIOS</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="mi">15</span><span class="n">h</span><span class="o">/</span><span class="mf">4F</span><span class="n">h</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">key</span>
<a id="line-11141" name="line-11141"></a><span class="p">;</span><span class="w"> </span><span class="n">b3</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="p">(</span><span class="n">Int</span><span class="w"> </span><span class="mi">15</span><span class="n">h</span><span class="o">/</span><span class="mi">41</span><span class="n">h</span><span class="p">)</span>
<a id="line-11142" name="line-11142"></a><span class="p">;</span><span class="w"> </span><span class="n">b2</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">extended</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">area</span><span class="w"> </span><span class="n">used</span>
<a id="line-11143" name="line-11143"></a><span class="p">;</span><span class="w"> </span><span class="n">b1</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="o">=</span><span class="n">AT</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">ESDI</span><span class="w"> </span><span class="n">bus</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">MicroChannel</span>
<a id="line-11144" name="line-11144"></a><span class="p">;</span><span class="w"> </span><span class="n">b0</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">Dual</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="p">(</span><span class="n">MicroChannel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ISA</span><span class="p">)</span>
<a id="line-11145" name="line-11145"></a><span class="n">db</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11146" name="line-11146"></a><span class="w">   </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11147" name="line-11147"></a><span class="w">   </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11148" name="line-11148"></a><span class="w">   </span><span class="p">(</span><span class="n">BX_CALL_INT15_4F</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11149" name="line-11149"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11150" name="line-11150"></a><span class="w">   </span><span class="p">(</span><span class="n">BX_USE_EBDA</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11151" name="line-11151"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11152" name="line-11152"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-11153" name="line-11153"></a><span class="p">;</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="mi">2</span>
<a id="line-11154" name="line-11154"></a><span class="p">;</span><span class="w"> </span><span class="n">b7</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11155" name="line-11155"></a><span class="p">;</span><span class="w"> </span><span class="n">b6</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">int16h</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11156" name="line-11156"></a><span class="p">;</span><span class="w"> </span><span class="n">b5</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">int15h</span><span class="o">/</span><span class="n">C6h</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">POS</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11157" name="line-11157"></a><span class="p">;</span><span class="w"> </span><span class="n">b4</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">int15h</span><span class="o">/</span><span class="n">C7h</span><span class="w"> </span><span class="p">(</span><span class="n">get</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11158" name="line-11158"></a><span class="p">;</span><span class="w"> </span><span class="n">b3</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">int15h</span><span class="o">/</span><span class="n">C8h</span><span class="w"> </span><span class="p">(</span><span class="n">en</span><span class="o">/</span><span class="n">dis</span><span class="w"> </span><span class="n">CPU</span><span class="p">)</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11159" name="line-11159"></a><span class="p">;</span><span class="w"> </span><span class="n">b2</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">non</span><span class="mi">-8042</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="n">controller</span>
<a id="line-11160" name="line-11160"></a><span class="p">;</span><span class="w"> </span><span class="n">b1</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="n">data</span><span class="w"> </span><span class="n">streaming</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11161" name="line-11161"></a><span class="p">;</span><span class="w"> </span><span class="n">b0</span><span class="o">:</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-11162" name="line-11162"></a><span class="n">db</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11163" name="line-11163"></a><span class="w">   </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11164" name="line-11164"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11165" name="line-11165"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11166" name="line-11166"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11167" name="line-11167"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11168" name="line-11168"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>\
<a id="line-11169" name="line-11169"></a><span class="w">   </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="line-11170" name="line-11170"></a><span class="p">;</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="mi">3</span>
<a id="line-11171" name="line-11171"></a><span class="p">;</span><span class="w"> </span><span class="n">b7</span><span class="o">:</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">used</span>
<a id="line-11172" name="line-11172"></a><span class="p">;</span><span class="w"> </span><span class="n">b6</span><span class="o">:</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-11173" name="line-11173"></a><span class="p">;</span><span class="w"> </span><span class="n">b5</span><span class="o">:</span><span class="w"> </span><span class="n">reserved</span>
<a id="line-11174" name="line-11174"></a><span class="p">;</span><span class="w"> </span><span class="n">b4</span><span class="o">:</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="n">supports</span><span class="w"> </span><span class="n">ROM</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">RAM</span><span class="w"> </span><span class="n">enable</span><span class="o">/</span><span class="n">disable</span>
<a id="line-11175" name="line-11175"></a><span class="p">;</span><span class="w"> </span><span class="n">b3</span><span class="o">:</span><span class="w"> </span><span class="n">SCSI</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">board</span>
<a id="line-11176" name="line-11176"></a><span class="p">;</span><span class="w"> </span><span class="n">b2</span><span class="o">:</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">panel</span><span class="w"> </span><span class="n">installed</span>
<a id="line-11177" name="line-11177"></a><span class="p">;</span><span class="w"> </span><span class="n">b1</span><span class="o">:</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="n">Machine</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="p">(</span><span class="n">IML</span><span class="p">)</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">disk</span>
<a id="line-11178" name="line-11178"></a><span class="p">;</span><span class="w"> </span><span class="n">b0</span><span class="o">:</span><span class="w"> </span><span class="n">SCSI</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">IML</span>
<a id="line-11179" name="line-11179"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span>
<a id="line-11180" name="line-11180"></a><span class="p">;</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="mi">4</span>
<a id="line-11181" name="line-11181"></a><span class="p">;</span><span class="w"> </span><span class="n">b7</span><span class="o">:</span><span class="w"> </span><span class="n">IBM</span><span class="w"> </span><span class="n">private</span>
<a id="line-11182" name="line-11182"></a><span class="p">;</span><span class="w"> </span><span class="n">b6</span><span class="o">:</span><span class="w"> </span><span class="n">EEPROM</span><span class="w"> </span><span class="n">present</span>
<a id="line-11183" name="line-11183"></a><span class="p">;</span><span class="w"> </span><span class="n">b5</span><span class="mi">-3</span><span class="o">:</span><span class="w"> </span><span class="n">ABIOS</span><span class="w"> </span><span class="n">presence</span><span class="w"> </span><span class="p">(</span><span class="mo">011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)</span>
<a id="line-11184" name="line-11184"></a><span class="p">;</span><span class="w"> </span><span class="n">b2</span><span class="o">:</span><span class="w"> </span><span class="n">private</span>
<a id="line-11185" name="line-11185"></a><span class="p">;</span><span class="w"> </span><span class="n">b1</span><span class="o">:</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="n">above</span><span class="w"> </span><span class="mi">16</span><span class="n">Mb</span><span class="w"> </span><span class="n">supported</span>
<a id="line-11186" name="line-11186"></a><span class="p">;</span><span class="w"> </span><span class="n">b0</span><span class="o">:</span><span class="w"> </span><span class="n">POSTEXT</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">POST</span>
<a id="line-11187" name="line-11187"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span>
<a id="line-11188" name="line-11188"></a><span class="p">;</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="n">IBM</span><span class="p">)</span>
<a id="line-11189" name="line-11189"></a><span class="p">;</span><span class="w"> </span><span class="n">b1</span><span class="o">:</span><span class="w"> </span><span class="n">enhanced</span><span class="w"> </span><span class="n">mouse</span>
<a id="line-11190" name="line-11190"></a><span class="p">;</span><span class="w"> </span><span class="n">b0</span><span class="o">:</span><span class="w"> </span><span class="n">flash</span><span class="w"> </span><span class="n">EPROM</span>
<a id="line-11191" name="line-11191"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span>
<a id="line-11192" name="line-11192"></a>
<a id="line-11193" name="line-11193"></a>
<a id="line-11194" name="line-11194"></a>
<a id="line-11195" name="line-11195"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe729</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Baud</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">Generator</span><span class="w"> </span><span class="n">Table</span>
<a id="line-11196" name="line-11196"></a>
<a id="line-11197" name="line-11197"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11198" name="line-11198"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT14h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11199" name="line-11199"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11200" name="line-11200"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe739</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">14</span><span class="n">h</span><span class="w"> </span><span class="n">Serial</span><span class="w"> </span><span class="n">Communications</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11201" name="line-11201"></a><span class="nl">int14_handler</span><span class="p">:</span>
<a id="line-11202" name="line-11202"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11203" name="line-11203"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11204" name="line-11204"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11205" name="line-11205"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11206" name="line-11206"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int14_function</span>
<a id="line-11207" name="line-11207"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11208" name="line-11208"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11209" name="line-11209"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11210" name="line-11210"></a>
<a id="line-11211" name="line-11211"></a>
<a id="line-11212" name="line-11212"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11213" name="line-11213"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">16</span><span class="n">h</span><span class="w"> </span><span class="n">Keyboard</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11214" name="line-11214"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11215" name="line-11215"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe82e</span>
<a id="line-11216" name="line-11216"></a><span class="nl">int16_handler</span><span class="p">:</span>
<a id="line-11217" name="line-11217"></a>
<a id="line-11218" name="line-11218"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-11219" name="line-11219"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11220" name="line-11220"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-11221" name="line-11221"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11222" name="line-11222"></a>
<a id="line-11223" name="line-11223"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x00</span>
<a id="line-11224" name="line-11224"></a><span class="w">  </span><span class="n">je</span><span class="w">    </span><span class="n">int16_F00</span>
<a id="line-11225" name="line-11225"></a><span class="w">  </span><span class="n">cmp</span><span class="w">   </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x10</span>
<a id="line-11226" name="line-11226"></a><span class="w">  </span><span class="n">je</span><span class="w">    </span><span class="n">int16_F00</span>
<a id="line-11227" name="line-11227"></a>
<a id="line-11228" name="line-11228"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-11229" name="line-11229"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-11230" name="line-11230"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int16_function</span>
<a id="line-11231" name="line-11231"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11232" name="line-11232"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-11233" name="line-11233"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11234" name="line-11234"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">int16_zero_set</span>
<a id="line-11235" name="line-11235"></a>
<a id="line-11236" name="line-11236"></a><span class="nl">int16_zero_clear</span><span class="p">:</span>
<a id="line-11237" name="line-11237"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-11238" name="line-11238"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-11239" name="line-11239"></a><span class="w">  </span><span class="c1">//SEG SS</span>
<a id="line-11240" name="line-11240"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x06</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0xbf</span>
<a id="line-11241" name="line-11241"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-11242" name="line-11242"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11243" name="line-11243"></a>
<a id="line-11244" name="line-11244"></a><span class="nl">int16_zero_set</span><span class="p">:</span>
<a id="line-11245" name="line-11245"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">bp</span>
<a id="line-11246" name="line-11246"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>
<a id="line-11247" name="line-11247"></a><span class="w">  </span><span class="c1">//SEG SS</span>
<a id="line-11248" name="line-11248"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="n">bp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x06</span><span class="p">],</span><span class="w"> </span><span class="err">#</span><span class="mh">0x40</span>
<a id="line-11249" name="line-11249"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">bp</span>
<a id="line-11250" name="line-11250"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11251" name="line-11251"></a>
<a id="line-11252" name="line-11252"></a><span class="nl">int16_F00</span><span class="p">:</span>
<a id="line-11253" name="line-11253"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0040</span>
<a id="line-11254" name="line-11254"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-11255" name="line-11255"></a>
<a id="line-11256" name="line-11256"></a><span class="nl">int16_wait_for_key</span><span class="p">:</span>
<a id="line-11257" name="line-11257"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-11258" name="line-11258"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001a</span>
<a id="line-11259" name="line-11259"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001c</span>
<a id="line-11260" name="line-11260"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">int16_key_found</span>
<a id="line-11261" name="line-11261"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-11262" name="line-11262"></a><span class="w">  </span><span class="n">hlt</span>
<a id="line-11263" name="line-11263"></a><span class="cp">#if 0</span>
<a id="line-11264" name="line-11264"></a><span class="c">                           /* no key yet, call int 15h, function AX=9002 */</span>
<a id="line-11265" name="line-11265"></a><span class="c">  0x50,                    /* push AX */</span>
<a id="line-11266" name="line-11266"></a><span class="c">  0xb8, 0x02, 0x90,        /* mov AX, #0x9002 */</span>
<a id="line-11267" name="line-11267"></a><span class="c">  0xcd, 0x15,              /* int 15h */</span>
<a id="line-11268" name="line-11268"></a><span class="c">  0x58,                    /* pop  AX */</span>
<a id="line-11269" name="line-11269"></a><span class="c">  0xeb, 0xea,              /* jmp   WAIT_FOR_KEY */</span>
<a id="line-11270" name="line-11270"></a><span class="cp">#endif</span>
<a id="line-11271" name="line-11271"></a><span class="w">  </span><span class="n">jmp</span><span class="w">  </span><span class="n">int16_wait_for_key</span>
<a id="line-11272" name="line-11272"></a>
<a id="line-11273" name="line-11273"></a><span class="nl">int16_key_found</span><span class="p">:</span>
<a id="line-11274" name="line-11274"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-11275" name="line-11275"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-11276" name="line-11276"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int16_function</span>
<a id="line-11277" name="line-11277"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11278" name="line-11278"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-11279" name="line-11279"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11280" name="line-11280"></a><span class="cp">#if 0</span>
<a id="line-11281" name="line-11281"></a><span class="c">                           /* notify int16 complete w/ int 15h, function AX=9102 */</span>
<a id="line-11282" name="line-11282"></a><span class="c">  0x50,                    /* push AX */</span>
<a id="line-11283" name="line-11283"></a><span class="c">  0xb8, 0x02, 0x91,        /* mov AX, #0x9102 */</span>
<a id="line-11284" name="line-11284"></a><span class="c">  0xcd, 0x15,              /* int 15h */</span>
<a id="line-11285" name="line-11285"></a><span class="c">  0x58,                    /* pop  AX */</span>
<a id="line-11286" name="line-11286"></a><span class="cp">#endif</span>
<a id="line-11287" name="line-11287"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11288" name="line-11288"></a>
<a id="line-11289" name="line-11289"></a>
<a id="line-11290" name="line-11290"></a>
<a id="line-11291" name="line-11291"></a><span class="p">;</span><span class="o">-------------------------------------------------</span>
<a id="line-11292" name="line-11292"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT09h</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Keyboard</span><span class="w"> </span><span class="n">Hardware</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11293" name="line-11293"></a><span class="p">;</span><span class="o">-------------------------------------------------</span>
<a id="line-11294" name="line-11294"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xe987</span>
<a id="line-11295" name="line-11295"></a><span class="nl">int09_handler</span><span class="p">:</span>
<a id="line-11296" name="line-11296"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-11297" name="line-11297"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11298" name="line-11298"></a>
<a id="line-11299" name="line-11299"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xAD</span><span class="w">      </span><span class="p">;;</span><span class="n">disable</span><span class="w"> </span><span class="n">keyboard</span>
<a id="line-11300" name="line-11300"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="err">#</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-11301" name="line-11301"></a>
<a id="line-11302" name="line-11302"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0B</span>
<a id="line-11303" name="line-11303"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-11304" name="line-11304"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x20</span>
<a id="line-11305" name="line-11305"></a><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-11306" name="line-11306"></a><span class="w">  </span><span class="n">jz</span><span class="w">  </span><span class="n">int09_finish</span>
<a id="line-11307" name="line-11307"></a>
<a id="line-11308" name="line-11308"></a><span class="w">  </span><span class="n">in</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x60</span><span class="w">             </span><span class="p">;;</span><span class="n">read</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">keyboard</span><span class="w"> </span><span class="n">controller</span>
<a id="line-11309" name="line-11309"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-11310" name="line-11310"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11311" name="line-11311"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11312" name="line-11312"></a><span class="cp">#ifdef BX_CALL_INT15_4F</span>
<a id="line-11313" name="line-11313"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x4f</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">keyboard</span><span class="w"> </span><span class="n">intercept</span>
<a id="line-11314" name="line-11314"></a><span class="w">  </span><span class="n">stc</span>
<a id="line-11315" name="line-11315"></a><span class="w">  </span><span class="kt">int</span><span class="w">  </span><span class="err">#</span><span class="mh">0x15</span>
<a id="line-11316" name="line-11316"></a><span class="w">  </span><span class="n">jnc</span><span class="w">  </span><span class="n">int09_done</span>
<a id="line-11317" name="line-11317"></a><span class="cp">#endif</span>
<a id="line-11318" name="line-11318"></a>
<a id="line-11319" name="line-11319"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">extended</span><span class="w"> </span><span class="n">key</span>
<a id="line-11320" name="line-11320"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xe0</span>
<a id="line-11321" name="line-11321"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">int09_check_pause</span>
<a id="line-11322" name="line-11322"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11323" name="line-11323"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11324" name="line-11324"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="mh">0x496</span><span class="p">]</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span>
<a id="line-11325" name="line-11325"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x02</span>
<a id="line-11326" name="line-11326"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="mh">0x496</span><span class="p">],</span><span class="w"> </span><span class="n">al</span>
<a id="line-11327" name="line-11327"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int09_done</span>
<a id="line-11328" name="line-11328"></a>
<a id="line-11329" name="line-11329"></a><span class="nl">int09_check_pause</span><span class="p">:</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pause</span><span class="w"> </span><span class="n">key</span>
<a id="line-11330" name="line-11330"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xe1</span>
<a id="line-11331" name="line-11331"></a><span class="w">  </span><span class="n">jne</span><span class="w"> </span><span class="n">int09_process_key</span>
<a id="line-11332" name="line-11332"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11333" name="line-11333"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11334" name="line-11334"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="mh">0x496</span><span class="p">]</span><span class="w">     </span><span class="p">;;</span><span class="w"> </span><span class="n">mf2_state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span>
<a id="line-11335" name="line-11335"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x01</span>
<a id="line-11336" name="line-11336"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">BYTE</span><span class="w"> </span><span class="p">[</span><span class="mh">0x496</span><span class="p">],</span><span class="w"> </span><span class="n">al</span>
<a id="line-11337" name="line-11337"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int09_done</span>
<a id="line-11338" name="line-11338"></a>
<a id="line-11339" name="line-11339"></a><span class="nl">int09_process_key</span><span class="p">:</span>
<a id="line-11340" name="line-11340"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xf000</span>
<a id="line-11341" name="line-11341"></a><span class="w">  </span><span class="n">mov</span><span class="w">   </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">bx</span>
<a id="line-11342" name="line-11342"></a><span class="w">  </span><span class="n">call</span><span class="w">  </span><span class="n">_int09_function</span>
<a id="line-11343" name="line-11343"></a>
<a id="line-11344" name="line-11344"></a><span class="nl">int09_done</span><span class="p">:</span>
<a id="line-11345" name="line-11345"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11346" name="line-11346"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-11347" name="line-11347"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-11348" name="line-11348"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_master_pic</span>
<a id="line-11349" name="line-11349"></a>
<a id="line-11350" name="line-11350"></a><span class="nl">int09_finish</span><span class="p">:</span>
<a id="line-11351" name="line-11351"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xAE</span><span class="w">      </span><span class="p">;;</span><span class="n">enable</span><span class="w"> </span><span class="n">keyboard</span>
<a id="line-11352" name="line-11352"></a><span class="w">  </span><span class="n">out</span><span class="w"> </span><span class="err">#</span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-11353" name="line-11353"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11354" name="line-11354"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11355" name="line-11355"></a>
<a id="line-11356" name="line-11356"></a>
<a id="line-11357" name="line-11357"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11358" name="line-11358"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">13</span><span class="n">h</span><span class="w"> </span><span class="n">Diskette</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11359" name="line-11359"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11360" name="line-11360"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xec59</span>
<a id="line-11361" name="line-11361"></a><span class="nl">int13_diskette</span><span class="p">:</span>
<a id="line-11362" name="line-11362"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int13_noeltorito</span>
<a id="line-11363" name="line-11363"></a>
<a id="line-11364" name="line-11364"></a><span class="p">;</span><span class="o">---------------------------------------------</span>
<a id="line-11365" name="line-11365"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">0</span><span class="n">Eh</span><span class="w"> </span><span class="n">Diskette</span><span class="w"> </span><span class="n">Hardware</span><span class="w"> </span><span class="n">ISR</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11366" name="line-11366"></a><span class="p">;</span><span class="o">---------------------------------------------</span>
<a id="line-11367" name="line-11367"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xef57</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">0</span><span class="n">Eh</span><span class="w"> </span><span class="n">Diskette</span><span class="w"> </span><span class="n">Hardware</span><span class="w"> </span><span class="n">ISR</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11368" name="line-11368"></a><span class="nl">int0e_handler</span><span class="p">:</span>
<a id="line-11369" name="line-11369"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11370" name="line-11370"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11371" name="line-11371"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f4</span>
<a id="line-11372" name="line-11372"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11373" name="line-11373"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11374" name="line-11374"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11375" name="line-11375"></a><span class="w">  </span><span class="n">je</span><span class="w">   </span><span class="n">int0e_normal</span>
<a id="line-11376" name="line-11376"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f5</span>
<a id="line-11377" name="line-11377"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x08</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">sense</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">status</span>
<a id="line-11378" name="line-11378"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-11379" name="line-11379"></a><span class="nl">int0e_loop1</span><span class="p">:</span>
<a id="line-11380" name="line-11380"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f4</span>
<a id="line-11381" name="line-11381"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11382" name="line-11382"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11383" name="line-11383"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11384" name="line-11384"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">int0e_loop1</span>
<a id="line-11385" name="line-11385"></a><span class="nl">int0e_loop2</span><span class="p">:</span>
<a id="line-11386" name="line-11386"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f5</span>
<a id="line-11387" name="line-11387"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11388" name="line-11388"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x03f4</span>
<a id="line-11389" name="line-11389"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11390" name="line-11390"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11391" name="line-11391"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xc0</span>
<a id="line-11392" name="line-11392"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">int0e_loop2</span>
<a id="line-11393" name="line-11393"></a><span class="nl">int0e_normal</span><span class="p">:</span>
<a id="line-11394" name="line-11394"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11395" name="line-11395"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="mo">0000</span>
<a id="line-11396" name="line-11396"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11397" name="line-11397"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_master_pic</span>
<a id="line-11398" name="line-11398"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mh">0x043e</span>
<a id="line-11399" name="line-11399"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x80</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">interrupt</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">occurred</span>
<a id="line-11400" name="line-11400"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x043e</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<a id="line-11401" name="line-11401"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11402" name="line-11402"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-11403" name="line-11403"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ax</span>
<a id="line-11404" name="line-11404"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11405" name="line-11405"></a>
<a id="line-11406" name="line-11406"></a>
<a id="line-11407" name="line-11407"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xefc7</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Diskette</span><span class="w"> </span><span class="n">Controller</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span>
<a id="line-11408" name="line-11408"></a><span class="nl">diskette_param_table</span><span class="p">:</span>
<a id="line-11409" name="line-11409"></a><span class="p">;;</span><span class="w">  </span><span class="n">Since</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">provisions</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">made</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">most</span>
<a id="line-11410" name="line-11410"></a><span class="p">;;</span><span class="w">  </span><span class="n">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">ignored</span><span class="p">.</span><span class="w">  </span><span class="n">I</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">1.44</span><span class="n">M</span>
<a id="line-11411" name="line-11411"></a><span class="p">;;</span><span class="w">  </span><span class="n">floppy</span><span class="w"> </span><span class="n">here</span>
<a id="line-11412" name="line-11412"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xAF</span>
<a id="line-11413" name="line-11413"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x02</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="mo">0000001</span><span class="p">,</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">used</span>
<a id="line-11414" name="line-11414"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x25</span>
<a id="line-11415" name="line-11415"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x02</span>
<a id="line-11416" name="line-11416"></a><span class="n">db</span><span class="w">    </span><span class="mi">18</span>
<a id="line-11417" name="line-11417"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x1B</span>
<a id="line-11418" name="line-11418"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xFF</span>
<a id="line-11419" name="line-11419"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x6C</span>
<a id="line-11420" name="line-11420"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xF6</span>
<a id="line-11421" name="line-11421"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x0F</span>
<a id="line-11422" name="line-11422"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x08</span>
<a id="line-11423" name="line-11423"></a>
<a id="line-11424" name="line-11424"></a>
<a id="line-11425" name="line-11425"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11426" name="line-11426"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT17h</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Printer</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span><span class="w"> </span><span class="o">-</span>
<a id="line-11427" name="line-11427"></a><span class="p">;</span><span class="o">----------------------------------------</span>
<a id="line-11428" name="line-11428"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xefd2</span>
<a id="line-11429" name="line-11429"></a><span class="nl">int17_handler</span><span class="p">:</span>
<a id="line-11430" name="line-11430"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11431" name="line-11431"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11432" name="line-11432"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11433" name="line-11433"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11434" name="line-11434"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int17_function</span>
<a id="line-11435" name="line-11435"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11436" name="line-11436"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11437" name="line-11437"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11438" name="line-11438"></a>
<a id="line-11439" name="line-11439"></a><span class="nl">diskette_param_table2</span><span class="p">:</span>
<a id="line-11440" name="line-11440"></a><span class="p">;;</span><span class="w">  </span><span class="n">New</span><span class="w"> </span><span class="n">diskette</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">adding</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">IBM</span>
<a id="line-11441" name="line-11441"></a><span class="p">;;</span><span class="w">  </span><span class="n">Since</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">provisions</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">made</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">most</span>
<a id="line-11442" name="line-11442"></a><span class="p">;;</span><span class="w">  </span><span class="n">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">ignored</span><span class="p">.</span><span class="w">  </span><span class="n">I</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">parameters</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">1.44</span><span class="n">M</span>
<a id="line-11443" name="line-11443"></a><span class="p">;;</span><span class="w">  </span><span class="n">floppy</span><span class="w"> </span><span class="n">here</span>
<a id="line-11444" name="line-11444"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xAF</span>
<a id="line-11445" name="line-11445"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x02</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="mo">0000001</span><span class="p">,</span><span class="w"> </span><span class="n">DMA</span><span class="w"> </span><span class="n">used</span>
<a id="line-11446" name="line-11446"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x25</span>
<a id="line-11447" name="line-11447"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x02</span>
<a id="line-11448" name="line-11448"></a><span class="n">db</span><span class="w">    </span><span class="mi">18</span>
<a id="line-11449" name="line-11449"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x1B</span>
<a id="line-11450" name="line-11450"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xFF</span>
<a id="line-11451" name="line-11451"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x6C</span>
<a id="line-11452" name="line-11452"></a><span class="n">db</span><span class="w">  </span><span class="mh">0xF6</span>
<a id="line-11453" name="line-11453"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x0F</span>
<a id="line-11454" name="line-11454"></a><span class="n">db</span><span class="w">  </span><span class="mh">0x08</span>
<a id="line-11455" name="line-11455"></a><span class="n">db</span><span class="w">    </span><span class="mi">79</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">track</span>
<a id="line-11456" name="line-11456"></a><span class="n">db</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">transfer</span><span class="w"> </span><span class="n">rate</span>
<a id="line-11457" name="line-11457"></a><span class="n">db</span><span class="w">     </span><span class="mi">4</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">cmos</span>
<a id="line-11458" name="line-11458"></a>
<a id="line-11459" name="line-11459"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf045</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">Functions</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">Fh</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11460" name="line-11460"></a><span class="w">  </span><span class="n">HALT</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span>
<a id="line-11461" name="line-11461"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11462" name="line-11462"></a>
<a id="line-11463" name="line-11463"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11464" name="line-11464"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT10h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11465" name="line-11465"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11466" name="line-11466"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf065</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">10</span><span class="n">h</span><span class="w"> </span><span class="n">Video</span><span class="w"> </span><span class="n">Support</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11467" name="line-11467"></a><span class="nl">int10_handler</span><span class="p">:</span>
<a id="line-11468" name="line-11468"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">dont</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">anything</span><span class="p">,</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">VGA</span><span class="w"> </span><span class="n">BIOS</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="n">int10h</span><span class="w"> </span><span class="n">requests</span>
<a id="line-11469" name="line-11469"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11470" name="line-11470"></a>
<a id="line-11471" name="line-11471"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf0a4</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">MDA</span><span class="o">/</span><span class="n">CGA</span><span class="w"> </span><span class="n">Video</span><span class="w"> </span><span class="n">Parameter</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="p">(</span><span class="n">INT</span><span class="w"> </span><span class="mi">1</span><span class="n">Dh</span><span class="p">)</span>
<a id="line-11472" name="line-11472"></a>
<a id="line-11473" name="line-11473"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11474" name="line-11474"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT12h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11475" name="line-11475"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11476" name="line-11476"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf841</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">12</span><span class="n">h</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11477" name="line-11477"></a><span class="p">;</span><span class="w"> </span><span class="o">???</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Pentium</span><span class="w"> </span><span class="p">(</span><span class="n">machine</span><span class="w"> </span><span class="n">check</span><span class="p">)</span><span class="o">?</span>
<a id="line-11478" name="line-11478"></a><span class="nl">int12_handler</span><span class="p">:</span>
<a id="line-11479" name="line-11479"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11480" name="line-11480"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0040</span>
<a id="line-11481" name="line-11481"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11482" name="line-11482"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0013</span>
<a id="line-11483" name="line-11483"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11484" name="line-11484"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11485" name="line-11485"></a>
<a id="line-11486" name="line-11486"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11487" name="line-11487"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT11h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11488" name="line-11488"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11489" name="line-11489"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf84d</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">11</span><span class="n">h</span><span class="w"> </span><span class="n">Equipment</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11490" name="line-11490"></a><span class="nl">int11_handler</span><span class="p">:</span>
<a id="line-11491" name="line-11491"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11492" name="line-11492"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x0040</span>
<a id="line-11493" name="line-11493"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11494" name="line-11494"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0010</span>
<a id="line-11495" name="line-11495"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11496" name="line-11496"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11497" name="line-11497"></a>
<a id="line-11498" name="line-11498"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11499" name="line-11499"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT15h</span><span class="w"> </span><span class="o">-</span>
<a id="line-11500" name="line-11500"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11501" name="line-11501"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xf859</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">15</span><span class="n">h</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">Services</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11502" name="line-11502"></a><span class="nl">int15_handler</span><span class="p">:</span>
<a id="line-11503" name="line-11503"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-11504" name="line-11504"></a><span class="cp">#if BX_APM</span>
<a id="line-11505" name="line-11505"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x53</span>
<a id="line-11506" name="line-11506"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">apm_call</span>
<a id="line-11507" name="line-11507"></a><span class="cp">#endif</span>
<a id="line-11508" name="line-11508"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11509" name="line-11509"></a><span class="w">  </span><span class="n">push</span><span class="w">  </span><span class="n">es</span>
<a id="line-11510" name="line-11510"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x86</span>
<a id="line-11511" name="line-11511"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">int15_handler32</span>
<a id="line-11512" name="line-11512"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xE8</span>
<a id="line-11513" name="line-11513"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">int15_handler32</span>
<a id="line-11514" name="line-11514"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11515" name="line-11515"></a><span class="cp">#if BX_USE_PS2_MOUSE</span>
<a id="line-11516" name="line-11516"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xC2</span>
<a id="line-11517" name="line-11517"></a><span class="w">  </span><span class="n">je</span><span class="w"> </span><span class="n">int15_handler_mouse</span>
<a id="line-11518" name="line-11518"></a><span class="cp">#endif</span>
<a id="line-11519" name="line-11519"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int15_function</span>
<a id="line-11520" name="line-11520"></a><span class="nl">int15_handler_mouse_ret</span><span class="p">:</span>
<a id="line-11521" name="line-11521"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11522" name="line-11522"></a><span class="nl">int15_handler32_ret</span><span class="p">:</span>
<a id="line-11523" name="line-11523"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">es</span>
<a id="line-11524" name="line-11524"></a><span class="w">  </span><span class="n">pop</span><span class="w">   </span><span class="n">ds</span>
<a id="line-11525" name="line-11525"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-11526" name="line-11526"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">iret_modify_cf</span>
<a id="line-11527" name="line-11527"></a><span class="cp">#if BX_APM</span>
<a id="line-11528" name="line-11528"></a><span class="nl">apm_call</span><span class="p">:</span>
<a id="line-11529" name="line-11529"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">_apmreal_entry</span>
<a id="line-11530" name="line-11530"></a><span class="cp">#endif</span>
<a id="line-11531" name="line-11531"></a>
<a id="line-11532" name="line-11532"></a><span class="cp">#if BX_USE_PS2_MOUSE</span>
<a id="line-11533" name="line-11533"></a><span class="nl">int15_handler_mouse</span><span class="p">:</span>
<a id="line-11534" name="line-11534"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int15_function_mouse</span>
<a id="line-11535" name="line-11535"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int15_handler_mouse_ret</span>
<a id="line-11536" name="line-11536"></a><span class="cp">#endif</span>
<a id="line-11537" name="line-11537"></a>
<a id="line-11538" name="line-11538"></a><span class="nl">int15_handler32</span><span class="p">:</span>
<a id="line-11539" name="line-11539"></a><span class="w">  </span><span class="n">pushad</span>
<a id="line-11540" name="line-11540"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int15_function32</span>
<a id="line-11541" name="line-11541"></a><span class="w">  </span><span class="n">popad</span>
<a id="line-11542" name="line-11542"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int15_handler32_ret</span>
<a id="line-11543" name="line-11543"></a>
<a id="line-11544" name="line-11544"></a><span class="p">;;</span><span class="w"> </span><span class="n">Protected</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">IDT</span><span class="w"> </span><span class="n">descriptor</span>
<a id="line-11545" name="line-11545"></a><span class="p">;;</span>
<a id="line-11546" name="line-11546"></a><span class="p">;;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">shutdown</span>
<a id="line-11547" name="line-11547"></a><span class="p">;;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">occurs</span><span class="w"> </span><span class="n">during</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">memory</span>
<a id="line-11548" name="line-11548"></a><span class="p">;;</span><span class="w"> </span><span class="n">transfers</span><span class="p">.</span>
<a id="line-11549" name="line-11549"></a><span class="p">;;</span>
<a id="line-11550" name="line-11550"></a><span class="p">;;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">f0000</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">correspond</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">beginning</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">BIOS</span><span class="p">,</span>
<a id="line-11551" name="line-11551"></a><span class="p">;;</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">I</span><span class="w"> </span><span class="no">actually</span><span class="w"> </span><span class="no">define</span><span class="w"> </span><span class="no">an</span><span class="w"> </span><span class="no">IDT</span><span class="w"> </span><span class="no">later</span>
<a id="line-11552" name="line-11552"></a><span class="err">;;</span><span class="w"> </span><span class="no">Set</span><span class="w"> </span><span class="no">limit</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="mi">0</span>
<a id="line-11553" name="line-11553"></a>
<a id="line-11554" name="line-11554"></a><span class="no">pmode_IDT_info</span><span class="p">:</span>
<a id="line-11555" name="line-11555"></a><span class="n">dw</span><span class="w"> </span><span class="mh">0x0000</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">15</span><span class="o">:</span><span class="mo">00</span>
<a id="line-11556" name="line-11556"></a><span class="n">dw</span><span class="w"> </span><span class="mh">0x0000</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w">  </span><span class="mi">15</span><span class="o">:</span><span class="mo">00</span>
<a id="line-11557" name="line-11557"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x0f</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w">  </span><span class="mi">23</span><span class="o">:</span><span class="mi">16</span>
<a id="line-11558" name="line-11558"></a>
<a id="line-11559" name="line-11559"></a><span class="p">;;</span><span class="w"> </span><span class="n">Real</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">IDT</span><span class="w"> </span><span class="n">descriptor</span>
<a id="line-11560" name="line-11560"></a><span class="p">;;</span>
<a id="line-11561" name="line-11561"></a><span class="p">;;</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">typical</span><span class="w"> </span><span class="n">real</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">values</span><span class="p">.</span>
<a id="line-11562" name="line-11562"></a><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mo">000000</span>
<a id="line-11563" name="line-11563"></a><span class="p">;;</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="mf">03f</span><span class="n">f</span>
<a id="line-11564" name="line-11564"></a>
<a id="line-11565" name="line-11565"></a><span class="nl">rmode_IDT_info</span><span class="p">:</span>
<a id="line-11566" name="line-11566"></a><span class="n">dw</span><span class="w"> </span><span class="mh">0x03ff</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="mi">15</span><span class="o">:</span><span class="mo">00</span>
<a id="line-11567" name="line-11567"></a><span class="n">dw</span><span class="w"> </span><span class="mh">0x0000</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w">  </span><span class="mi">15</span><span class="o">:</span><span class="mo">00</span>
<a id="line-11568" name="line-11568"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">base</span><span class="w">  </span><span class="mi">23</span><span class="o">:</span><span class="mi">16</span>
<a id="line-11569" name="line-11569"></a>
<a id="line-11570" name="line-11570"></a>
<a id="line-11571" name="line-11571"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11572" name="line-11572"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT1Ah</span><span class="w"> </span><span class="o">-</span>
<a id="line-11573" name="line-11573"></a><span class="p">;</span><span class="o">----------</span>
<a id="line-11574" name="line-11574"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfe6e</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">1</span><span class="n">Ah</span><span class="w"> </span><span class="n">Time</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">day</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11575" name="line-11575"></a><span class="nl">int1a_handler</span><span class="p">:</span>
<a id="line-11576" name="line-11576"></a><span class="cp">#if BX_TCGBIOS</span>
<a id="line-11577" name="line-11577"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xbb</span>
<a id="line-11578" name="line-11578"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">no_tcg</span>
<a id="line-11579" name="line-11579"></a><span class="w">  </span><span class="n">pushf</span>
<a id="line-11580" name="line-11580"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11581" name="line-11581"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">es</span>
<a id="line-11582" name="line-11582"></a><span class="w">  </span><span class="n">pushad</span>
<a id="line-11583" name="line-11583"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int1a_function32</span>
<a id="line-11584" name="line-11584"></a><span class="w">  </span><span class="n">popad</span>
<a id="line-11585" name="line-11585"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">es</span>
<a id="line-11586" name="line-11586"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11587" name="line-11587"></a><span class="w">  </span><span class="n">popf</span>
<a id="line-11588" name="line-11588"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11589" name="line-11589"></a><span class="nl">no_tcg</span><span class="p">:</span>
<a id="line-11590" name="line-11590"></a><span class="cp">#endif</span>
<a id="line-11591" name="line-11591"></a><span class="cp">#if BX_PCIBIOS</span>
<a id="line-11592" name="line-11592"></a><span class="w">  </span><span class="n">cmp</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xb1</span>
<a id="line-11593" name="line-11593"></a><span class="w">  </span><span class="n">jne</span><span class="w">  </span><span class="n">int1a_normal</span>
<a id="line-11594" name="line-11594"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">pcibios_real</span>
<a id="line-11595" name="line-11595"></a><span class="w">  </span><span class="n">jc</span><span class="w">   </span><span class="n">pcibios_error</span>
<a id="line-11596" name="line-11596"></a><span class="w">  </span><span class="n">retf</span><span class="w"> </span><span class="mi">2</span>
<a id="line-11597" name="line-11597"></a><span class="nl">pcibios_error</span><span class="p">:</span>
<a id="line-11598" name="line-11598"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">bl</span><span class="p">,</span><span class="w"> </span><span class="n">ah</span>
<a id="line-11599" name="line-11599"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ah</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0xb1</span>
<a id="line-11600" name="line-11600"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11601" name="line-11601"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11602" name="line-11602"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">readable</span><span class="w"> </span><span class="n">descriptor</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">pcibios</span>
<a id="line-11603" name="line-11603"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w">  </span><span class="p">;</span><span class="w">  </span><span class="n">on</span><span class="w"> </span><span class="mi">16</span><span class="n">bit</span><span class="w"> </span><span class="n">protected</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span>
<a id="line-11604" name="line-11604"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="n">int1a_callfunction</span>
<a id="line-11605" name="line-11605"></a><span class="nl">int1a_normal</span><span class="p">:</span>
<a id="line-11606" name="line-11606"></a><span class="cp">#endif</span>
<a id="line-11607" name="line-11607"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11608" name="line-11608"></a><span class="w">  </span><span class="n">pusha</span>
<a id="line-11609" name="line-11609"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11610" name="line-11610"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11611" name="line-11611"></a><span class="nl">int1a_callfunction</span><span class="p">:</span>
<a id="line-11612" name="line-11612"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int1a_function</span>
<a id="line-11613" name="line-11613"></a><span class="w">  </span><span class="n">popa</span>
<a id="line-11614" name="line-11614"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11615" name="line-11615"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11616" name="line-11616"></a>
<a id="line-11617" name="line-11617"></a><span class="p">;;</span>
<a id="line-11618" name="line-11618"></a><span class="p">;;</span><span class="w"> </span><span class="n">int70h</span><span class="o">:</span><span class="w"> </span><span class="n">IRQ8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">CMOS</span><span class="w"> </span><span class="n">RTC</span>
<a id="line-11619" name="line-11619"></a><span class="p">;;</span>
<a id="line-11620" name="line-11620"></a><span class="nl">int70_handler</span><span class="p">:</span>
<a id="line-11621" name="line-11621"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11622" name="line-11622"></a><span class="w">  </span><span class="n">pushad</span>
<a id="line-11623" name="line-11623"></a><span class="w">  </span><span class="n">xor</span><span class="w">  </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11624" name="line-11624"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11625" name="line-11625"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">_int70_function</span>
<a id="line-11626" name="line-11626"></a><span class="w">  </span><span class="n">popad</span>
<a id="line-11627" name="line-11627"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">ds</span>
<a id="line-11628" name="line-11628"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11629" name="line-11629"></a>
<a id="line-11630" name="line-11630"></a><span class="p">;</span><span class="o">---------</span>
<a id="line-11631" name="line-11631"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">INT08</span><span class="w"> </span><span class="o">-</span>
<a id="line-11632" name="line-11632"></a><span class="p">;</span><span class="o">---------</span>
<a id="line-11633" name="line-11633"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfea5</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mi">08</span><span class="n">h</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">Timer</span><span class="w"> </span><span class="n">ISR</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11634" name="line-11634"></a><span class="nl">int08_handler</span><span class="p">:</span>
<a id="line-11635" name="line-11635"></a><span class="w">  </span><span class="n">sti</span>
<a id="line-11636" name="line-11636"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">eax</span>
<a id="line-11637" name="line-11637"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11638" name="line-11638"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11639" name="line-11639"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span>
<a id="line-11640" name="line-11640"></a>
<a id="line-11641" name="line-11641"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="n">drive</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">?</span>
<a id="line-11642" name="line-11642"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="mh">0x0440</span>
<a id="line-11643" name="line-11643"></a><span class="w">  </span><span class="n">or</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="n">al</span>
<a id="line-11644" name="line-11644"></a><span class="w">  </span><span class="n">jz</span><span class="w">   </span><span class="n">int08_floppy_off</span>
<a id="line-11645" name="line-11645"></a><span class="w">  </span><span class="n">dec</span><span class="w">  </span><span class="n">al</span>
<a id="line-11646" name="line-11646"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="mh">0x0440</span><span class="p">,</span><span class="n">al</span>
<a id="line-11647" name="line-11647"></a><span class="w">  </span><span class="n">jnz</span><span class="w">  </span><span class="n">int08_floppy_off</span>
<a id="line-11648" name="line-11648"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">turn</span><span class="w"> </span><span class="nf">motor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="n">off</span>
<a id="line-11649" name="line-11649"></a><span class="w">  </span><span class="n">push</span><span class="w"> </span><span class="n">dx</span>
<a id="line-11650" name="line-11650"></a><span class="w">  </span><span class="n">mov</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="err">#</span><span class="mh">0x03f2</span>
<a id="line-11651" name="line-11651"></a><span class="w">  </span><span class="n">in</span><span class="w">   </span><span class="n">al</span><span class="p">,</span><span class="n">dx</span>
<a id="line-11652" name="line-11652"></a><span class="w">  </span><span class="n">and</span><span class="w">  </span><span class="n">al</span><span class="p">,</span><span class="err">#</span><span class="mh">0xcf</span>
<a id="line-11653" name="line-11653"></a><span class="w">  </span><span class="n">out</span><span class="w">  </span><span class="n">dx</span><span class="p">,</span><span class="n">al</span>
<a id="line-11654" name="line-11654"></a><span class="w">  </span><span class="n">pop</span><span class="w">  </span><span class="n">dx</span>
<a id="line-11655" name="line-11655"></a><span class="nl">int08_floppy_off</span><span class="p">:</span>
<a id="line-11656" name="line-11656"></a>
<a id="line-11657" name="line-11657"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x046c</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="n">dword</span>
<a id="line-11658" name="line-11658"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">eax</span>
<a id="line-11659" name="line-11659"></a>
<a id="line-11660" name="line-11660"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">compare</span><span class="w"> </span><span class="n">eax</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="n">worth</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mf">18.2</span><span class="w"> </span><span class="n">hz</span>
<a id="line-11661" name="line-11661"></a><span class="w">  </span><span class="n">cmp</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="mh">0x001800B0</span>
<a id="line-11662" name="line-11662"></a><span class="w">  </span><span class="n">jb</span><span class="w">  </span><span class="n">int08_store_ticks</span>
<a id="line-11663" name="line-11663"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">midnight</span><span class="w"> </span><span class="n">rollover</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">point</span>
<a id="line-11664" name="line-11664"></a><span class="w">  </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">counter</span>
<a id="line-11665" name="line-11665"></a><span class="w">  </span><span class="n">inc</span><span class="w"> </span><span class="n">BYTE</span><span class="w"> </span><span class="mh">0x0470</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">increment</span><span class="w"> </span><span class="n">rollover</span><span class="w"> </span><span class="n">flag</span>
<a id="line-11666" name="line-11666"></a>
<a id="line-11667" name="line-11667"></a><span class="nl">int08_store_ticks</span><span class="p">:</span>
<a id="line-11668" name="line-11668"></a><span class="w">  </span><span class="n">mov</span><span class="w"> </span><span class="mh">0x046c</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="n">dword</span>
<a id="line-11669" name="line-11669"></a><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">tick</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1c</span>
<a id="line-11670" name="line-11670"></a><span class="w">  </span><span class="c1">//pushf</span>
<a id="line-11671" name="line-11671"></a><span class="w">  </span><span class="c1">//;; call_ep [ds:loc]</span>
<a id="line-11672" name="line-11672"></a><span class="w">  </span><span class="c1">//CALL_EP( 0x1c &lt;&lt; 2 )</span>
<a id="line-11673" name="line-11673"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="err">#</span><span class="mh">0x1c</span>
<a id="line-11674" name="line-11674"></a><span class="w">  </span><span class="n">cli</span>
<a id="line-11675" name="line-11675"></a><span class="w">  </span><span class="n">call</span><span class="w"> </span><span class="n">eoi_master_pic</span>
<a id="line-11676" name="line-11676"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">ds</span>
<a id="line-11677" name="line-11677"></a><span class="w">  </span><span class="n">pop</span><span class="w"> </span><span class="n">eax</span>
<a id="line-11678" name="line-11678"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11679" name="line-11679"></a>
<a id="line-11680" name="line-11680"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfef3</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="n">Interrupt</span><span class="w"> </span><span class="n">Vector</span><span class="w"> </span><span class="n">Offsets</span><span class="w"> </span><span class="n">Loaded</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">POST</span>
<a id="line-11681" name="line-11681"></a>
<a id="line-11682" name="line-11682"></a>
<a id="line-11683" name="line-11683"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xff00</span>
<a id="line-11684" name="line-11684"></a><span class="p">.</span><span class="n">ascii</span><span class="w"> </span><span class="n">BIOS_COPYRIGHT_STRING</span>
<a id="line-11685" name="line-11685"></a>
<a id="line-11686" name="line-11686"></a><span class="p">;</span><span class="o">------------------------------------------------</span>
<a id="line-11687" name="line-11687"></a><span class="p">;</span><span class="o">-</span><span class="w"> </span><span class="n">IRET</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Dummy</span><span class="w"> </span><span class="n">Interrupt</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="o">-</span>
<a id="line-11688" name="line-11688"></a><span class="p">;</span><span class="o">------------------------------------------------</span>
<a id="line-11689" name="line-11689"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xff53</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">IRET</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Dummy</span><span class="w"> </span><span class="n">Interrupt</span><span class="w"> </span><span class="n">Handler</span>
<a id="line-11690" name="line-11690"></a><span class="nl">dummy_iret_handler</span><span class="p">:</span>
<a id="line-11691" name="line-11691"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11692" name="line-11692"></a>
<a id="line-11693" name="line-11693"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xff54</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">INT</span><span class="w"> </span><span class="mo">05</span><span class="n">h</span><span class="w"> </span><span class="n">Print</span><span class="w"> </span><span class="n">Screen</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11694" name="line-11694"></a><span class="w">  </span><span class="n">HALT</span><span class="p">(</span><span class="n">__LINE__</span><span class="p">)</span>
<a id="line-11695" name="line-11695"></a><span class="w">  </span><span class="n">iret</span>
<a id="line-11696" name="line-11696"></a>
<a id="line-11697" name="line-11697"></a><span class="cp">#ifdef HVMTEST</span>
<a id="line-11698" name="line-11698"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xffe0</span>
<a id="line-11699" name="line-11699"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0xf000</span><span class="o">:</span><span class="n">post</span><span class="p">;</span>
<a id="line-11700" name="line-11700"></a><span class="cp">#endif</span>
<a id="line-11701" name="line-11701"></a>
<a id="line-11702" name="line-11702"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfff0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">Power</span><span class="o">-</span><span class="n">up</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">Point</span>
<a id="line-11703" name="line-11703"></a><span class="cp">#ifdef HVMTEST</span>
<a id="line-11704" name="line-11704"></a><span class="w">  </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0xd000</span><span class="o">:</span><span class="mh">0x0003</span><span class="p">;</span>
<a id="line-11705" name="line-11705"></a><span class="cp">#else</span>
<a id="line-11706" name="line-11706"></a><span class="w">   </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0xf000</span><span class="o">:</span><span class="n">post</span>
<a id="line-11707" name="line-11707"></a><span class="cp">#endif</span>
<a id="line-11708" name="line-11708"></a>
<a id="line-11709" name="line-11709"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfff5</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">ASCII</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">ROM</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">built</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">characters</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">MM</span><span class="o">/</span><span class="n">DD</span><span class="o">/</span><span class="n">YY</span>
<a id="line-11710" name="line-11710"></a><span class="p">.</span><span class="n">ascii</span><span class="w"> </span><span class="n">BIOS_BUILD_DATE</span>
<a id="line-11711" name="line-11711"></a>
<a id="line-11712" name="line-11712"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfffe</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">ID</span>
<a id="line-11713" name="line-11713"></a><span class="n">db</span><span class="w"> </span><span class="n">SYS_MODEL_ID</span>
<a id="line-11714" name="line-11714"></a><span class="n">db</span><span class="w"> </span><span class="mh">0x00</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">filler</span>
<a id="line-11715" name="line-11715"></a>
<a id="line-11716" name="line-11716"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xfa6e</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="n">Character</span><span class="w"> </span><span class="n">Font</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">320</span><span class="n">x200</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">640</span><span class="n">x200</span><span class="w"> </span><span class="n">Graphics</span><span class="w"> </span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="n">characters</span><span class="p">)</span>
<a id="line-11717" name="line-11717"></a><span class="n">ASM_END</span>
<a id="line-11718" name="line-11718"></a><span class="cm">/*</span>
<a id="line-11719" name="line-11719"></a><span class="cm"> * This font comes from the fntcol16.zip package (c) by  Joseph Gil</span>
<a id="line-11720" name="line-11720"></a><span class="cm"> * found at ftp://ftp.simtel.net/pub/simtelnet/msdos/screen/fntcol16.zip</span>
<a id="line-11721" name="line-11721"></a><span class="cm"> * This font is public domain</span>
<a id="line-11722" name="line-11722"></a><span class="cm"> */</span>
<a id="line-11723" name="line-11723"></a><span class="k">static</span><span class="w"> </span><span class="n">Bit8u</span><span class="w"> </span><span class="n">vgafont8</span><span class="p">[</span><span class="mi">128</span><span class="o">*</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span>
<a id="line-11724" name="line-11724"></a><span class="p">{</span>
<a id="line-11725" name="line-11725"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11726" name="line-11726"></a><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x81</span><span class="p">,</span><span class="w"> </span><span class="mh">0xa5</span><span class="p">,</span><span class="w"> </span><span class="mh">0x81</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbd</span><span class="p">,</span><span class="w"> </span><span class="mh">0x99</span><span class="p">,</span><span class="w"> </span><span class="mh">0x81</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span>
<a id="line-11727" name="line-11727"></a><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdb</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span>
<a id="line-11728" name="line-11728"></a><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11729" name="line-11729"></a><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11730" name="line-11730"></a><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span>
<a id="line-11731" name="line-11731"></a><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span>
<a id="line-11732" name="line-11732"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11733" name="line-11733"></a><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span>
<a id="line-11734" name="line-11734"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11735" name="line-11735"></a><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc3</span><span class="p">,</span><span class="w"> </span><span class="mh">0x99</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbd</span><span class="p">,</span><span class="w"> </span><span class="mh">0xbd</span><span class="p">,</span><span class="w"> </span><span class="mh">0x99</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span>
<a id="line-11736" name="line-11736"></a><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7d</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span>
<a id="line-11737" name="line-11737"></a><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span>
<a id="line-11738" name="line-11738"></a><span class="w"> </span><span class="mh">0x3f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x33</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span>
<a id="line-11739" name="line-11739"></a><span class="w"> </span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x67</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span>
<a id="line-11740" name="line-11740"></a><span class="w"> </span><span class="mh">0x99</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe7</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5a</span><span class="p">,</span><span class="w"> </span><span class="mh">0x99</span><span class="p">,</span>
<a id="line-11741" name="line-11741"></a><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11742" name="line-11742"></a><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11743" name="line-11743"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span>
<a id="line-11744" name="line-11744"></a><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11745" name="line-11745"></a><span class="w"> </span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdb</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdb</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1b</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11746" name="line-11746"></a><span class="w"> </span><span class="mh">0x3e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x63</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span>
<a id="line-11747" name="line-11747"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11748" name="line-11748"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span>
<a id="line-11749" name="line-11749"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11750" name="line-11750"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11751" name="line-11751"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11752" name="line-11752"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11753" name="line-11753"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11754" name="line-11754"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x24</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x24</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11755" name="line-11755"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11756" name="line-11756"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11757" name="line-11757"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11758" name="line-11758"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11759" name="line-11759"></a><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11760" name="line-11760"></a><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11761" name="line-11761"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11762" name="line-11762"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11763" name="line-11763"></a><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11764" name="line-11764"></a><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11765" name="line-11765"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11766" name="line-11766"></a><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11767" name="line-11767"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11768" name="line-11768"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11769" name="line-11769"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span>
<a id="line-11770" name="line-11770"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11771" name="line-11771"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11772" name="line-11772"></a><span class="w"> </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11773" name="line-11773"></a><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xce</span><span class="p">,</span><span class="w"> </span><span class="mh">0xde</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11774" name="line-11774"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11775" name="line-11775"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11776" name="line-11776"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11777" name="line-11777"></a><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11778" name="line-11778"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11779" name="line-11779"></a><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11780" name="line-11780"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11781" name="line-11781"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11782" name="line-11782"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11783" name="line-11783"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11784" name="line-11784"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span>
<a id="line-11785" name="line-11785"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11786" name="line-11786"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11787" name="line-11787"></a><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11788" name="line-11788"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11789" name="line-11789"></a><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xde</span><span class="p">,</span><span class="w"> </span><span class="mh">0xde</span><span class="p">,</span><span class="w"> </span><span class="mh">0xde</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11790" name="line-11790"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11791" name="line-11791"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11792" name="line-11792"></a><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11793" name="line-11793"></a><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11794" name="line-11794"></a><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11795" name="line-11795"></a><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x68</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11796" name="line-11796"></a><span class="w"> </span><span class="mh">0x3c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xce</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11797" name="line-11797"></a><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11798" name="line-11798"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11799" name="line-11799"></a><span class="w"> </span><span class="mh">0x1e</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11800" name="line-11800"></a><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11801" name="line-11801"></a><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x62</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11802" name="line-11802"></a><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11803" name="line-11803"></a><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xde</span><span class="p">,</span><span class="w"> </span><span class="mh">0xce</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11804" name="line-11804"></a><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11805" name="line-11805"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11806" name="line-11806"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11807" name="line-11807"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11808" name="line-11808"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11809" name="line-11809"></a><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb4</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11810" name="line-11810"></a><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11811" name="line-11811"></a><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11812" name="line-11812"></a><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xee</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11813" name="line-11813"></a><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11814" name="line-11814"></a><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11815" name="line-11815"></a><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11816" name="line-11816"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11817" name="line-11817"></a><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11818" name="line-11818"></a><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11819" name="line-11819"></a><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11820" name="line-11820"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="p">,</span>
<a id="line-11821" name="line-11821"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11822" name="line-11822"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11823" name="line-11823"></a><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11824" name="line-11824"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11825" name="line-11825"></a><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11826" name="line-11826"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11827" name="line-11827"></a><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11828" name="line-11828"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span>
<a id="line-11829" name="line-11829"></a><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11830" name="line-11830"></a><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11831" name="line-11831"></a><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span>
<a id="line-11832" name="line-11832"></a><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11833" name="line-11833"></a><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11834" name="line-11834"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11835" name="line-11835"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11836" name="line-11836"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11837" name="line-11837"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span>
<a id="line-11838" name="line-11838"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1e</span><span class="p">,</span>
<a id="line-11839" name="line-11839"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x66</span><span class="p">,</span><span class="w"> </span><span class="mh">0x60</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11840" name="line-11840"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11841" name="line-11841"></a><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x34</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11842" name="line-11842"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11843" name="line-11843"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x78</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11844" name="line-11844"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xd6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11845" name="line-11845"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11846" name="line-11846"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0xcc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf8</span><span class="p">,</span>
<a id="line-11847" name="line-11847"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x64</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11848" name="line-11848"></a><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11849" name="line-11849"></a><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11850" name="line-11850"></a><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11851" name="line-11851"></a><span class="w"> </span><span class="mh">0x76</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdc</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11852" name="line-11852"></a><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x38</span><span class="p">,</span><span class="w"> </span><span class="mh">0x6c</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc6</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span>
<a id="line-11853" name="line-11853"></a><span class="p">};</span>
<a id="line-11854" name="line-11854"></a>
<a id="line-11855" name="line-11855"></a><span class="n">ASM_START</span>
<a id="line-11856" name="line-11856"></a><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="mh">0xcff0</span>
<a id="line-11857" name="line-11857"></a><span class="nl">bios_table_area_end</span><span class="p">:</span>
<a id="line-11858" name="line-11858"></a><span class="c1">// bcc-generated data will be placed here</span>
<a id="line-11859" name="line-11859"></a><span class="n">ASM_END</span>
<a id="line-11860" name="line-11860"></a>
</pre></div></td></tr></table></div>

    </div>
    <div id="footer" class="footer">
      <p>
        Created by Cppcheck 2.14.0 (<a href="https://cppcheck.sourceforge.io">Sourceforge</a>, <a href="irc://irc.freenode.net/cppcheck">IRC</a>)
      </p>
    </div>
    </div>
  </body>
</html>
