
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(cb) {
        var elements = document.querySelectorAll("." + cb.id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("id-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleSeverity(cb) {
        cb.parentElement.classList.toggle("unchecked", !cb.checked);
        var elements = document.querySelectorAll(".sev_" + cb.id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("severity-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleTool(cb) {
        cb.parentElement.classList.toggle("unchecked", !cb.checked);

        var elements;
        if (cb.id == "clang-tidy")
            elements = document.querySelectorAll("[class^=clang-tidy-]");
        else
            elements = document.querySelectorAll(".issue:not([class^=clang-tidy-])");

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("tool-filtered", !cb.checked);
        }

        updateFileRows();
      }

      function toggleAll() {
        var elements = document.querySelectorAll(".idToggle");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var changed = elements[i].checked != elements[0].checked;
          if (changed) {
            elements[i].checked = elements[0].checked;
            toggleDisplay(elements[i]);
          }
        }
      }

      function filterFile(filter) {
        var elements = document.querySelectorAll(".fileEntry");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = elements[i].querySelector("tr").querySelector("td").textContent.toLowerCase().includes(filter.toLowerCase());
          elements[i].classList.toggle("text-filtered", !visible);
        }
      }

      function filterText(text) {
        filter = text.toLowerCase();
        var elements = document.querySelectorAll(".issue");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = false;
          var fields = elements[i].querySelectorAll("td");
          for (var n = 0, num = fields.length; n < num; n++) {
            if (fields[n].textContent.toLowerCase().includes(filter)) {
              visible = true;
              break;
            }
          }
          elements[i].classList.toggle("text-filtered", !visible);
        }

        updateFileRows();
      }

      function updateFileRows(element) {
        var elements = document.querySelectorAll(".fileEntry");

        for (var i = 0, len = elements.length; i < len; i++) {
          var visible = elements[i].querySelector(".issue:not(.id-filtered):not(.severity-filtered):not(.tool-filtered):not(.text-filtered)");
          elements[i].classList.toggle("file-filtered", !visible);
        }
      }

      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="wrapper">
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: xen/tools/libs/light/libxl_save_helper.c</h1>

    </div>

    <div id="menu">
     <p><a href="index.html">Defects:</a> libxl_save_helper.c</p>
<a href="96.html#line-104"> va_end_missing 104</a><a href="96.html#line-248"> unknownEvaluationOrder 248</a><a href="96.html#line-249"> unknownEvaluationOrder 249</a><a href="96.html#line-254"> assignmentInAssert 254</a><a href="96.html#line-267"> unknownEvaluationOrder 267</a><a href="96.html#line-268"> unknownEvaluationOrder 268</a><a href="96.html#line-276"> assignmentInAssert 276</a>
    </div>
    <div id="content">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><a id="line-1" name="line-1"></a><span class="cm">/*</span>
<a id="line-2" name="line-2"></a><span class="cm"> * Copyright (C) 2012      Citrix Ltd.</span>
<a id="line-3" name="line-3"></a><span class="cm"> *</span>
<a id="line-4" name="line-4"></a><span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<a id="line-5" name="line-5"></a><span class="cm"> * it under the terms of the GNU Lesser General Public License as published</span>
<a id="line-6" name="line-6"></a><span class="cm"> * by the Free Software Foundation; version 2.1 only. with the special</span>
<a id="line-7" name="line-7"></a><span class="cm"> * exception on linking described in file LICENSE.</span>
<a id="line-8" name="line-8"></a><span class="cm"> *</span>
<a id="line-9" name="line-9"></a><span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<a id="line-10" name="line-10"></a><span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a id="line-11" name="line-11"></a><span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a id="line-12" name="line-12"></a><span class="cm"> * GNU Lesser General Public License for more details.</span>
<a id="line-13" name="line-13"></a><span class="cm"> */</span>
<a id="line-14" name="line-14"></a>
<a id="line-15" name="line-15"></a><span class="cm">/*</span>
<a id="line-16" name="line-16"></a><span class="cm"> * The libxl-save-helper utility speaks a protocol to its caller for</span>
<a id="line-17" name="line-17"></a><span class="cm"> * the callbacks.  The protocol is as follows.</span>
<a id="line-18" name="line-18"></a><span class="cm"> *</span>
<a id="line-19" name="line-19"></a><span class="cm"> * The helper talks on stdin and stdout, in binary in machine</span>
<a id="line-20" name="line-20"></a><span class="cm"> * endianness.  The helper speaks first, and only when it has a</span>
<a id="line-21" name="line-21"></a><span class="cm"> * callback to make.  It writes a 16-bit number being the message</span>
<a id="line-22" name="line-22"></a><span class="cm"> * length, and then the message body.</span>
<a id="line-23" name="line-23"></a><span class="cm"> *</span>
<a id="line-24" name="line-24"></a><span class="cm"> * Each message starts with a 16-bit number indicating which of the</span>
<a id="line-25" name="line-25"></a><span class="cm"> * messages it is, and then some arguments in a binary marshalled form.</span>
<a id="line-26" name="line-26"></a><span class="cm"> * If the callback does not need a reply (it returns void), the helper</span>
<a id="line-27" name="line-27"></a><span class="cm"> * just continues.  Otherwise the helper waits for its caller to send a</span>
<a id="line-28" name="line-28"></a><span class="cm"> * single int which is to be the return value from the callback.</span>
<a id="line-29" name="line-29"></a><span class="cm"> *</span>
<a id="line-30" name="line-30"></a><span class="cm"> * Where feasible the stubs and callbacks have prototypes identical to</span>
<a id="line-31" name="line-31"></a><span class="cm"> * those required by xc_domain_save and xc_domain_restore, so that the</span>
<a id="line-32" name="line-32"></a><span class="cm"> * autogenerated functions can be used/provided directly.</span>
<a id="line-33" name="line-33"></a><span class="cm"> *</span>
<a id="line-34" name="line-34"></a><span class="cm"> * The actual messages are in the array @msgs in libxl_save_msgs_gen.pl</span>
<a id="line-35" name="line-35"></a><span class="cm"> */</span>
<a id="line-36" name="line-36"></a>
<a id="line-37" name="line-37"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;libxl_osdeps.h&quot;</span>
<a id="line-38" name="line-38"></a>
<a id="line-39" name="line-39"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="line-40" name="line-40"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<a id="line-41" name="line-41"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span>
<a id="line-42" name="line-42"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span>
<a id="line-43" name="line-43"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<a id="line-44" name="line-44"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<a id="line-45" name="line-45"></a>
<a id="line-46" name="line-46"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;libxl.h&quot;</span>
<a id="line-47" name="line-47"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;libxl_utils.h&quot;</span>
<a id="line-48" name="line-48"></a>
<a id="line-49" name="line-49"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;xenctrl.h&quot;</span>
<a id="line-50" name="line-50"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;xenguest.h&quot;</span>
<a id="line-51" name="line-51"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;_libxl_save_msgs_helper.h&quot;</span>
<a id="line-52" name="line-52"></a>
<a id="line-53" name="line-53"></a><span class="cm">/*----- logger -----*/</span>
<a id="line-54" name="line-54"></a>
<a id="line-55" name="line-55"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">format</span><span class="p">(</span><span class="n">printf</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<a id="line-56" name="line-56"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">tellparent_vmessage</span><span class="p">(</span><span class="n">xentoollog_logger</span><span class="w"> </span><span class="o">*</span><span class="n">logger_in</span><span class="p">,</span>
<a id="line-57" name="line-57"></a><span class="w">                                </span><span class="n">xentoollog_level</span><span class="w"> </span><span class="n">level</span><span class="p">,</span>
<a id="line-58" name="line-58"></a><span class="w">                                </span><span class="kt">int</span><span class="w"> </span><span class="n">errnoval</span><span class="p">,</span>
<a id="line-59" name="line-59"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span>
<a id="line-60" name="line-60"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span>
<a id="line-61" name="line-61"></a><span class="w">                                </span><span class="kt">va_list</span><span class="w"> </span><span class="n">al</span><span class="p">)</span>
<a id="line-62" name="line-62"></a><span class="p">{</span>
<a id="line-63" name="line-63"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">formatted</span><span class="p">;</span>
<a id="line-64" name="line-64"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vasprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">formatted</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="p">);</span>
<a id="line-65" name="line-65"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;memory allocation failed during logging&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="line-66" name="line-66"></a><span class="w">    </span><span class="n">helper_stub_log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">errnoval</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">formatted</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-67" name="line-67"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">formatted</span><span class="p">);</span>
<a id="line-68" name="line-68"></a><span class="p">}</span>
<a id="line-69" name="line-69"></a>
<a id="line-70" name="line-70"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">tellparent_progress</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xentoollog_logger</span><span class="w"> </span><span class="o">*</span><span class="n">logger_in</span><span class="p">,</span>
<a id="line-71" name="line-71"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="p">,</span>
<a id="line-72" name="line-72"></a><span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">doing_what</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">percent</span><span class="p">,</span>
<a id="line-73" name="line-73"></a><span class="w">                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">total</span><span class="p">)</span>
<a id="line-74" name="line-74"></a><span class="p">{</span>
<a id="line-75" name="line-75"></a><span class="w">    </span><span class="n">helper_stub_progress</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">doing_what</span><span class="p">,</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-76" name="line-76"></a><span class="p">}</span>
<a id="line-77" name="line-77"></a>
<a id="line-78" name="line-78"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">tellparent_destroy</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">xentoollog_logger</span><span class="w"> </span><span class="o">*</span><span class="n">logger_in</span><span class="p">)</span>
<a id="line-79" name="line-79"></a><span class="p">{</span>
<a id="line-80" name="line-80"></a><span class="w">    </span><span class="n">abort</span><span class="p">();</span>
<a id="line-81" name="line-81"></a><span class="p">}</span>
<a id="line-82" name="line-82"></a>
<a id="line-83" name="line-83"></a><span class="cm">/*----- globals -----*/</span>
<a id="line-84" name="line-84"></a>
<a id="line-85" name="line-85"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">program</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;libxl-save-helper&quot;</span><span class="p">;</span>
<a id="line-86" name="line-86"></a><span class="k">static</span><span class="w"> </span><span class="n">xentoollog_logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="line-87" name="line-87"></a><span class="w">    </span><span class="n">tellparent_vmessage</span><span class="p">,</span>
<a id="line-88" name="line-88"></a><span class="w">    </span><span class="n">tellparent_progress</span><span class="p">,</span>
<a id="line-89" name="line-89"></a><span class="w">    </span><span class="n">tellparent_destroy</span><span class="p">,</span>
<a id="line-90" name="line-90"></a><span class="p">};</span>
<a id="line-91" name="line-91"></a><span class="k">static</span><span class="w"> </span><span class="n">xc_interface</span><span class="w"> </span><span class="o">*</span><span class="n">xch</span><span class="p">;</span>
<a id="line-92" name="line-92"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">io_fd</span><span class="p">;</span>
<a id="line-93" name="line-93"></a>
<a id="line-94" name="line-94"></a><span class="cm">/*----- error handling -----*/</span>
<a id="line-95" name="line-95"></a>
<a id="line-96" name="line-96"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fail</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">errnoval</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<a id="line-97" name="line-97"></a><span class="w">    </span><span class="n">__attribute__</span><span class="p">((</span><span class="k">noreturn</span><span class="p">,</span><span class="n">format</span><span class="p">(</span><span class="n">printf</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)));</span>
<a id="line-98" name="line-98"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fail</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">errnoval</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<a id="line-99" name="line-99"></a><span class="p">{</span>
<a id="line-100" name="line-100"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">al</span><span class="p">;</span>
<a id="line-101" name="line-101"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="n">fmt</span><span class="p">);</span>
<a id="line-102" name="line-102"></a><span class="w">    </span><span class="n">xtl_logv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logger</span><span class="p">,</span><span class="n">XTL_ERROR</span><span class="p">,</span><span class="n">errnoval</span><span class="p">,</span><span class="n">program</span><span class="p">,</span><span class="n">fmt</span><span class="p">,</span><span class="n">al</span><span class="p">);</span>
<a id="line-103" name="line-103"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<a id="line-104" name="line-104"></a><span class="hll"><span class="p">}</span><span class="error2">&lt;--- va_list 'al' was opened but not closed by va_end().</span>
</span><a id="line-105" name="line-105"></a>
<a id="line-106" name="line-106"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">read_exactly</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="line-107" name="line-107"></a><span class="cm">/* returns 0 if we get eof, even if we got it midway through; 1 if ok */</span>
<a id="line-108" name="line-108"></a><span class="p">{</span>
<a id="line-109" name="line-109"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-110" name="line-110"></a><span class="w">        </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="line-111" name="line-111"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-112" name="line-112"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="line-113" name="line-113"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-114" name="line-114"></a><span class="w">        </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-115" name="line-115"></a><span class="w">    </span><span class="p">}</span>
<a id="line-116" name="line-116"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="line-117" name="line-117"></a><span class="p">}</span>
<a id="line-118" name="line-118"></a>
<a id="line-119" name="line-119"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">xmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span>
<a id="line-120" name="line-120"></a><span class="p">{</span>
<a id="line-121" name="line-121"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-122" name="line-122"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
<a id="line-123" name="line-123"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;memory allocation failed&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="line-124" name="line-124"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-125" name="line-125"></a><span class="p">}</span>
<a id="line-126" name="line-126"></a>
<a id="line-127" name="line-127"></a><span class="cm">/*----- signal handling -----*/</span>
<a id="line-128" name="line-128"></a>
<a id="line-129" name="line-129"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">unwriteable_fd</span><span class="p">;</span>
<a id="line-130" name="line-130"></a>
<a id="line-131" name="line-131"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">save_signal_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">)</span>
<a id="line-132" name="line-132"></a><span class="p">{</span>
<a id="line-133" name="line-133"></a><span class="w">    </span><span class="cm">/*</span>
<a id="line-134" name="line-134"></a><span class="cm">     * We want to be able to interrupt save.  But the code in libxc</span>
<a id="line-135" name="line-135"></a><span class="cm">     * which does the actual saving is straight-through, and we need</span>
<a id="line-136" name="line-136"></a><span class="cm">     * to execute its error path to put the guest back to sanity.</span>
<a id="line-137" name="line-137"></a><span class="cm">     *</span>
<a id="line-138" name="line-138"></a><span class="cm">     * So what we do is this: when we get the signal, we dup2</span>
<a id="line-139" name="line-139"></a><span class="cm">     * the result of open(&quot;/dev/null&quot;,O_RDONLY) onto the output fd.</span>
<a id="line-140" name="line-140"></a><span class="cm">     *</span>
<a id="line-141" name="line-141"></a><span class="cm">     * This is guaranteed to 1. interrupt libxc&#39;s write (causing it to</span>
<a id="line-142" name="line-142"></a><span class="cm">     * return short, or maybe EINTR); 2. make the next write give</span>
<a id="line-143" name="line-143"></a><span class="cm">     * EBADF, so that: 3. at latest, libxc will notice when it next</span>
<a id="line-144" name="line-144"></a><span class="cm">     * tries to write data and will then go into its cleanup path.</span>
<a id="line-145" name="line-145"></a><span class="cm">     *</span>
<a id="line-146" name="line-146"></a><span class="cm">     * We make no effort here to sanitise the resulting errors.</span>
<a id="line-147" name="line-147"></a><span class="cm">     * That&#39;s libxl&#39;s job.</span>
<a id="line-148" name="line-148"></a><span class="cm">     */</span>
<a id="line-149" name="line-149"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">esave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">errno</span><span class="p">;</span>
<a id="line-150" name="line-150"></a>
<a id="line-151" name="line-151"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dup2</span><span class="p">(</span><span class="n">unwriteable_fd</span><span class="p">,</span><span class="w"> </span><span class="n">io_fd</span><span class="p">);</span>
<a id="line-152" name="line-152"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">io_fd</span><span class="p">)</span>
<a id="line-153" name="line-153"></a><span class="w">        </span><span class="cm">/* we can&#39;t write an xtl message because we might end up</span>
<a id="line-154" name="line-154"></a><span class="cm">         * interleaving on our control stream; we can&#39;t use stdio</span>
<a id="line-155" name="line-155"></a><span class="cm">         * because it&#39;s not async-signal-safe */</span>
<a id="line-156" name="line-156"></a><span class="w">        </span><span class="n">abort</span><span class="p">();</span>
<a id="line-157" name="line-157"></a>
<a id="line-158" name="line-158"></a><span class="w">    </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esave</span><span class="p">;</span>
<a id="line-159" name="line-159"></a><span class="p">}</span>
<a id="line-160" name="line-160"></a>
<a id="line-161" name="line-161"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_signals</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span>
<a id="line-162" name="line-162"></a><span class="p">{</span>
<a id="line-163" name="line-163"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigaction</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<a id="line-164" name="line-164"></a><span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">spmask</span><span class="p">;</span>
<a id="line-165" name="line-165"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-166" name="line-166"></a>
<a id="line-167" name="line-167"></a><span class="w">    </span><span class="n">unwriteable_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
<a id="line-168" name="line-168"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unwriteable_fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">fail</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span><span class="s">&quot;open /dev/null for reading&quot;</span><span class="p">);</span>
<a id="line-169" name="line-169"></a>
<a id="line-170" name="line-170"></a><span class="w">    </span><span class="n">LIBXL_FILLZERO</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
<a id="line-171" name="line-171"></a><span class="w">    </span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handler</span><span class="p">;</span>
<a id="line-172" name="line-172"></a><span class="w">    </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
<a id="line-173" name="line-173"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-174" name="line-174"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="n">fail</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span><span class="s">&quot;sigaction SIGTERM failed&quot;</span><span class="p">);</span>
<a id="line-175" name="line-175"></a>
<a id="line-176" name="line-176"></a><span class="w">    </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmask</span><span class="p">);</span>
<a id="line-177" name="line-177"></a><span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spmask</span><span class="p">,</span><span class="n">SIGTERM</span><span class="p">);</span>
<a id="line-178" name="line-178"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_UNBLOCK</span><span class="p">,</span><span class="o">&amp;</span><span class="n">spmask</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-179" name="line-179"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="n">fail</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span><span class="s">&quot;sigprocmask unblock SIGTERM failed&quot;</span><span class="p">);</span>
<a id="line-180" name="line-180"></a><span class="p">}</span>
<a id="line-181" name="line-181"></a>
<a id="line-182" name="line-182"></a><span class="cm">/*----- helper functions called by autogenerated stubs -----*/</span>
<a id="line-183" name="line-183"></a>
<a id="line-184" name="line-184"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">helper_allocbuf</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="line-185" name="line-185"></a><span class="p">{</span>
<a id="line-186" name="line-186"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">xmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<a id="line-187" name="line-187"></a><span class="p">}</span>
<a id="line-188" name="line-188"></a>
<a id="line-189" name="line-189"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transmit</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="line-190" name="line-190"></a><span class="p">{</span>
<a id="line-191" name="line-191"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-192" name="line-192"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="line-193" name="line-193"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="line-194" name="line-194"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="line-195" name="line-195"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="line-196" name="line-196"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-197" name="line-197"></a><span class="w">        </span><span class="n">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-198" name="line-198"></a><span class="w">    </span><span class="p">}</span>
<a id="line-199" name="line-199"></a><span class="p">}</span>
<a id="line-200" name="line-200"></a>
<a id="line-201" name="line-201"></a><span class="kt">void</span><span class="w"> </span><span class="nf">helper_transmitmsg</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg_freed</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len_in</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="line-202" name="line-202"></a><span class="p">{</span>
<a id="line-203" name="line-203"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">len_in</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
<a id="line-204" name="line-204"></a><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len_in</span><span class="p">;</span>
<a id="line-205" name="line-205"></a><span class="w">    </span><span class="n">transmit</span><span class="p">((</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">),</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="line-206" name="line-206"></a><span class="w">    </span><span class="n">transmit</span><span class="p">(</span><span class="n">msg_freed</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="line-207" name="line-207"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">msg_freed</span><span class="p">);</span>
<a id="line-208" name="line-208"></a><span class="p">}</span>
<a id="line-209" name="line-209"></a>
<a id="line-210" name="line-210"></a><span class="kt">int</span><span class="w"> </span><span class="nf">helper_getreply</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="line-211" name="line-211"></a><span class="p">{</span>
<a id="line-212" name="line-212"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="line-213" name="line-213"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_exactly</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
<a id="line-214" name="line-214"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">-2</span><span class="p">);</span>
<a id="line-215" name="line-215"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="line-216" name="line-216"></a><span class="p">}</span>
<a id="line-217" name="line-217"></a>
<a id="line-218" name="line-218"></a><span class="cm">/*----- other callbacks -----*/</span>
<a id="line-219" name="line-219"></a>
<a id="line-220" name="line-220"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-221" name="line-221"></a><span class="w">    </span><span class="n">xtl_log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logger</span><span class="p">,</span><span class="n">XTL_DEBUG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">program</span><span class="p">,</span><span class="s">&quot;starting %s&quot;</span><span class="p">,</span><span class="n">op</span><span class="p">);</span>
<a id="line-222" name="line-222"></a>
<a id="line-223" name="line-223"></a><span class="w">    </span><span class="n">xch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xc_interface_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logger</span><span class="p">,</span><span class="o">&amp;</span><span class="n">logger</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-224" name="line-224"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">xch</span><span class="p">)</span><span class="w"> </span><span class="n">fail</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span><span class="s">&quot;xc_interface_open failed&quot;</span><span class="p">);</span>
<a id="line-225" name="line-225"></a><span class="p">}</span>
<a id="line-226" name="line-226"></a>
<a id="line-227" name="line-227"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">retval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="line-228" name="line-228"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">errnoval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">errno</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="cm">/* suppress irrelevant errnos */</span>
<a id="line-229" name="line-229"></a><span class="w">    </span><span class="n">xtl_log</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logger</span><span class="p">,</span><span class="n">XTL_DEBUG</span><span class="p">,</span><span class="n">errnoval</span><span class="p">,</span><span class="n">program</span><span class="p">,</span><span class="s">&quot;complete r=%d&quot;</span><span class="p">,</span><span class="n">retval</span><span class="p">);</span>
<a id="line-230" name="line-230"></a><span class="w">    </span><span class="n">helper_stub_complete</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="n">errnoval</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-231" name="line-231"></a><span class="w">    </span><span class="n">xc_interface_close</span><span class="p">(</span><span class="n">xch</span><span class="p">);</span>
<a id="line-232" name="line-232"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="line-233" name="line-233"></a><span class="p">}</span>
<a id="line-234" name="line-234"></a>
<a id="line-235" name="line-235"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<a id="line-236" name="line-236"></a><span class="p">{</span>
<a id="line-237" name="line-237"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="line-238" name="line-238"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">send_back_fd</span><span class="p">,</span><span class="w"> </span><span class="n">recv_fd</span><span class="p">;</span>
<a id="line-239" name="line-239"></a>
<a id="line-240" name="line-240"></a><span class="cp">#define NEXTARG (++argv, assert(*argv), *argv)</span>
<a id="line-241" name="line-241"></a>
<a id="line-242" name="line-242"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*++</span><span class="n">argv</span><span class="p">;</span>
<a id="line-243" name="line-243"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
<a id="line-244" name="line-244"></a>
<a id="line-245" name="line-245"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="s">&quot;--save-domain&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-246" name="line-246"></a><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">save_callbacks</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<a id="line-247" name="line-247"></a>
<a id="line-248" name="line-248"></a><span class="hll"><span class="w">        </span><span class="n">io_fd</span><span class="w"> </span><span class="o">=</span><span class="w">                             </span><span class="n">atoi</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">);</span><span class="error2">&lt;--- Expression '++argv,assert(*argv)' depends on order of evaluation of side effects</span>
</span><a id="line-249" name="line-249"></a><span class="hll"><span class="w">        </span><span class="n">recv_fd</span><span class="w"> </span><span class="o">=</span><span class="w">                           </span><span class="n">atoi</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">);</span><span class="error2">&lt;--- Expression '++argv,assert(*argv)' depends on order of evaluation of side effects</span>
</span><a id="line-250" name="line-250"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">dom</span><span class="w"> </span><span class="o">=</span><span class="w">                      </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-251" name="line-251"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w">                    </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-252" name="line-252"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">cbflags</span><span class="w"> </span><span class="o">=</span><span class="w">                  </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-253" name="line-253"></a><span class="w">        </span><span class="n">xc_stream_type_t</span><span class="w"> </span><span class="n">stream_type</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-254" name="line-254"></a><span class="hll"><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!*++</span><span class="n">argv</span><span class="p">);</span><div class="verbose expandable"><span class="error2">&lt;--- Assert statement modifies 'argv'. <span class="marker">[+]</span></span><div class="content">Variable &apos;argv&apos; is modified inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div>
</span><a id="line-255" name="line-255"></a>
<a id="line-256" name="line-256"></a><span class="w">        </span><span class="n">helper_setcallbacks_save</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">cbflags</span><span class="p">);</span>
<a id="line-257" name="line-257"></a>
<a id="line-258" name="line-258"></a><span class="w">        </span><span class="n">startup</span><span class="p">(</span><span class="s">&quot;save&quot;</span><span class="p">);</span>
<a id="line-259" name="line-259"></a><span class="w">        </span><span class="n">setup_signals</span><span class="p">(</span><span class="n">save_signal_handler</span><span class="p">);</span>
<a id="line-260" name="line-260"></a>
<a id="line-261" name="line-261"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xc_domain_save</span><span class="p">(</span><span class="n">xch</span><span class="p">,</span><span class="w"> </span><span class="n">io_fd</span><span class="p">,</span><span class="w"> </span><span class="n">dom</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">stream_type</span><span class="p">,</span><span class="w"> </span><span class="n">recv_fd</span><span class="p">);</span>
<a id="line-262" name="line-262"></a><span class="w">        </span><span class="n">complete</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<a id="line-263" name="line-263"></a>
<a id="line-264" name="line-264"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="s">&quot;--restore-domain&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="line-265" name="line-265"></a><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">restore_callbacks</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<a id="line-266" name="line-266"></a>
<a id="line-267" name="line-267"></a><span class="hll"><span class="w">        </span><span class="n">io_fd</span><span class="w"> </span><span class="o">=</span><span class="w">                             </span><span class="n">atoi</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">);</span><span class="error2">&lt;--- Expression '++argv,assert(*argv)' depends on order of evaluation of side effects</span>
</span><a id="line-268" name="line-268"></a><span class="hll"><span class="w">        </span><span class="n">send_back_fd</span><span class="w"> </span><span class="o">=</span><span class="w">                      </span><span class="n">atoi</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">);</span><span class="error2">&lt;--- Expression '++argv,assert(*argv)' depends on order of evaluation of side effects</span>
</span><a id="line-269" name="line-269"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">dom</span><span class="w"> </span><span class="o">=</span><span class="w">                      </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-270" name="line-270"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">store_evtchn</span><span class="w"> </span><span class="o">=</span><span class="w">             </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-271" name="line-271"></a><span class="w">        </span><span class="n">domid_t</span><span class="w"> </span><span class="n">store_domid</span><span class="w"> </span><span class="o">=</span><span class="w">               </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-272" name="line-272"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">console_evtchn</span><span class="w"> </span><span class="o">=</span><span class="w">           </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-273" name="line-273"></a><span class="w">        </span><span class="n">domid_t</span><span class="w"> </span><span class="n">console_domid</span><span class="w"> </span><span class="o">=</span><span class="w">             </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-274" name="line-274"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">cbflags</span><span class="w"> </span><span class="o">=</span><span class="w">                  </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-275" name="line-275"></a><span class="w">        </span><span class="n">xc_stream_type_t</span><span class="w"> </span><span class="n">stream_type</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="n">strtoul</span><span class="p">(</span><span class="n">NEXTARG</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<a id="line-276" name="line-276"></a><span class="hll"><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!*++</span><span class="n">argv</span><span class="p">);</span><div class="verbose expandable"><span class="error2">&lt;--- Assert statement modifies 'argv'. <span class="marker">[+]</span></span><div class="content">Variable &apos;argv&apos; is modified inside assert statement. Assert statements are removed from release builds so the code inside assert statement is not executed. If the code is needed also in release builds, this is a bug.</div></div>
</span><a id="line-277" name="line-277"></a>
<a id="line-278" name="line-278"></a><span class="w">        </span><span class="n">helper_setcallbacks_restore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">cbflags</span><span class="p">);</span>
<a id="line-279" name="line-279"></a>
<a id="line-280" name="line-280"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">store_mfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-281" name="line-281"></a><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">console_mfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="line-282" name="line-282"></a>
<a id="line-283" name="line-283"></a><span class="w">        </span><span class="n">startup</span><span class="p">(</span><span class="s">&quot;restore&quot;</span><span class="p">);</span>
<a id="line-284" name="line-284"></a><span class="w">        </span><span class="n">setup_signals</span><span class="p">(</span><span class="n">SIG_DFL</span><span class="p">);</span>
<a id="line-285" name="line-285"></a>
<a id="line-286" name="line-286"></a><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xc_domain_restore</span><span class="p">(</span><span class="n">xch</span><span class="p">,</span><span class="w"> </span><span class="n">io_fd</span><span class="p">,</span><span class="w"> </span><span class="n">dom</span><span class="p">,</span><span class="w"> </span><span class="n">store_evtchn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">store_mfn</span><span class="p">,</span>
<a id="line-287" name="line-287"></a><span class="w">                              </span><span class="n">store_domid</span><span class="p">,</span><span class="w"> </span><span class="n">console_evtchn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">console_mfn</span><span class="p">,</span>
<a id="line-288" name="line-288"></a><span class="w">                              </span><span class="n">console_domid</span><span class="p">,</span><span class="w"> </span><span class="n">stream_type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">send_back_fd</span><span class="p">);</span>
<a id="line-289" name="line-289"></a><span class="w">        </span><span class="n">helper_stub_restore_results</span><span class="p">(</span><span class="n">store_mfn</span><span class="p">,</span><span class="n">console_mfn</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a id="line-290" name="line-290"></a><span class="w">        </span><span class="n">complete</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<a id="line-291" name="line-291"></a>
<a id="line-292" name="line-292"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="line-293" name="line-293"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;unexpected mode argument&quot;</span><span class="p">);</span>
<a id="line-294" name="line-294"></a><span class="w">    </span><span class="p">}</span>
<a id="line-295" name="line-295"></a><span class="p">}</span>
<a id="line-296" name="line-296"></a>
<a id="line-297" name="line-297"></a><span class="cm">/*</span>
<a id="line-298" name="line-298"></a><span class="cm"> * Local variables:</span>
<a id="line-299" name="line-299"></a><span class="cm"> * mode: C</span>
<a id="line-300" name="line-300"></a><span class="cm"> * c-basic-offset: 4</span>
<a id="line-301" name="line-301"></a><span class="cm"> * indent-tabs-mode: nil</span>
<a id="line-302" name="line-302"></a><span class="cm"> * End:</span>
<a id="line-303" name="line-303"></a><span class="cm"> */</span>
</pre></div></td></tr></table></div>

    </div>
    <div id="footer" class="footer">
      <p>
        Created by Cppcheck 2.14.0 (<a href="https://cppcheck.sourceforge.io">Sourceforge</a>, <a href="irc://irc.freenode.net/cppcheck">IRC</a>)
      </p>
    </div>
    </div>
  </body>
</html>
